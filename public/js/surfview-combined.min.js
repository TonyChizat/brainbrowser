Array.prototype.min=function(){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.min.apply(Math,this.slice(c,c+b-1)))}}else{return Math.min.apply(Math,this)}return a.min()};Array.prototype.max=function(d){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.max.apply(Math,this.slice(c,c+b-1)))}}else{return Math.max.apply(Math,this)}return a.max()};function MNIObject(c){var h;var f=this;this.parse=function(k){f.num_hemispheres=1;var j=k.replace(/\s+$/,"");var l=j.replace(/^\s+/,"");h=l.split(/\s+/).reverse();f.objectClass=h.pop();if(f.objectClass=="P"){d();f.numberVertices=parseInt(h.pop());e();i();f.nitems=parseInt(h.pop())}else{if(f.objectClass=="L"){d();f.numberVertices=parseInt(h.pop());e();f.nitems=parseInt(h.pop())}else{throw new Error("That object class is not supported currently")}}g();b();a();if(f.objectClass=="P"){if(f.positionArray.length==81924*3){f.brainSurface=true;f.split_hemispheres()}}};function d(){if(f.objectClass=="P"){f.surfaceProperties={ambient:parseFloat(h.pop()),diffuse:parseFloat(h.pop()),specular_reflectance:parseFloat(h.pop()),specular_scattering:parseFloat(h.pop()),transparency:parseFloat(h.pop())}}else{if(f.objectClass=="L"){f.surfaceProperties={width:h.pop()}}}}function e(){f.positionArray=new Array();for(var j=0;j<f.numberVertices;j++){for(var k=0;k<3;k++){f.positionArray.push(parseFloat(h.pop()))}}}function i(){f.normalArray=new Array();for(var k=0;k<f.numberVertices;k++){for(var j=0;j<3;j++){f.normalArray.push(parseFloat(h.pop()))}}}function g(){f.colorFlag=parseInt(h.pop());f.colorArray=new Array();if(f.colorFlag===0){for(var j=0;j<4;j++){f.colorArray.push(parseFloat(h.pop()))}}else{if(f.colorFlag===1){for(var k=0;k<f.numberPolygons;k++){for(var j=0;j<4;j++){f.colorArray.push(parseFloat(h.pop()))}}}else{if(f.colorFlag===2){for(var k=0;k<f.numberVertices;k++){for(var j=0;j<4;j++){f.colorArray.push(parseFloat(h.pop()))}}}else{throw new Error("colorFlag not valid in that file")}}}}function b(){f.endIndicesArray=new Array();for(var j=0;j<f.nitems;j++){f.endIndicesArray.push(parseInt(h.pop()))}}function a(){f.indexArray=new Array();var k=h.length;for(var j=0;j<k;j++){f.indexArray.push(parseInt(h.pop()))}}this.split_hemispheres=function(){this.left={};this.right={};var n=this.positionArray.length;this.left.positionArray=this.positionArray.slice(0,n/2);this.right.positionArray=this.positionArray.slice(n/2,n);var m=this.indexArray.length;this.left.indexArray=this.indexArray.slice(0,m/2);this.right.indexArray=this.indexArray.slice(m/2,m);for(var j=0;j<this.right.indexArray.length;j++){this.right.indexArray[j]=this.right.indexArray[j]-2-m/3/2/2}var k=this.normalArray.length;this.left.normalArray=this.normalArray.slice(0,k/2);this.right.normalArray=this.normalArray.slice(k/2,k);this.left.colorFlag=this.colorFlag;this.right.colorFlag=this.colorFlag;if(this.colorFlag==0||this.colorFlag==1){this.left.colorArray=this.colorArray;this.right.colorArray=this.colorArray}else{var l=this.colorArray.length;this.left.colorArray=this.colorArray.slice(0,l/2);this.right.colorArray=this.colorArray.slice(l/2+1,-1)}this.left.numberVertices=this.numberVertices/2;this.right.numberVertices=this.numberVertices/2;this.left.numberPolygons=this.numberPolygons/2;this.right.numberPolygons=this.numberPolygons/2;this.num_hemispheres=2};this.getVertexInfo=function(k){var j=[this.positionArray[k*3],this.positionArray[k*3+1],this.positionArray[k*3+2]];return{vertex:k,position_vector:j}};this.get_vertex=function(u,r,j){if(this.num_hemispheres>1){var q=this[j];var n=0;if(j=="right"){n=2+q.indexArray.length/3/2}}else{var q=this;var n=0}var p=new Array();var x=u*3;for(var o=0;o<3;o++){p.push(q.indexArray[x+o])}var v=new Array();for(var o=0;o<3;o++){var t=p[o]*3;v[o]=new Array();for(var m=0;m<3;m++){v[o][m]=q.positionArray[t+m]}}var w=new Array();for(var o=0;o<3;o++){w.push(o3djs.math.distance(r,v[o]))}var l=0;if(w[1]<w[0]){l=1}if(w[2]<w[l]){l=2}var s=p[l]+n;var y=v[l];return{vertex:s,position_vector:y}};if(c){this.parse(c)}}function Spectrum(d){var b=this;function a(e,f,k,m){var g=document.createElement("canvas");jQuery(g).attr("width",e.length);jQuery(g).attr("height",k);var j=g.getContext("2d");if(m){for(var h=0;h<e.length;h++){var l=e.length-1-h;j.fillStyle="rgb("+parseInt(parseFloat(e[l][0])*255)+","+parseInt(parseFloat(e[l][1])*255)+","+parseInt(parseFloat(e[l][2])*255)+")";j.fillRect(h,0,1,f)}}else{for(var h=0;h<e.length;h++){j.fillStyle="rgb("+parseInt(parseFloat(e[h][0])*255)+","+parseInt(parseFloat(e[h][1])*255)+","+parseInt(parseFloat(e[h][2])*255)+")";j.fillRect(h,0,1,f)}}return g}b.createSpectrumCanvas=function(e){if(e==null){e=b.colors}var f=a(e,20,20,false);return f};b.createSpectrumCanvasWithScale=function(i,e,f,j){if(f==null){f=b.colors}var g=a(f,20,40,j);var h=g.getContext("2d");h.fillStyle="#FFFFFF";h.fillRect(0.5,20,1,10);h.fillText(i.toPrecision(3),0.5,40);h.fillRect(g.width/4,20,1,10);h.fillText(((i+e)/4).toPrecision(3),g.width/4,40);h.fillRect(g.width/2,20,1,10);h.fillText(((i+e)/2).toPrecision(3),g.width/2,40);h.fillRect(3*(g.width/4),20,1,10);h.fillText((3*((i+e)/4)).toPrecision(3),3*(g.width/4),40);h.fillRect(g.width-0.5,20,1,10);h.fillText(e.toPrecision(3),g.width-20,40);return g};function c(l){l=l.replace(/\s+$/,"");l=l.replace(/^\s+/,"");var h=l.split(/\n/);var e=new Array();for(var g=0;g<h.length;g++){var j=h[g].split(/\s+/);for(var f=0;f<3;f++){j[f]=parseFloat(j[f])}j.push(1);e.push(j)}b.colors=e;return e}if(d!=undefined){c(d)}}function Data(b){var a=this;a.parse=function(c){c=c.replace(/\s+$/,"");c=c.replace(/^\s+/,"");a.values=c.split(/\s+/);for(var d=0;d<a.values.length;d++){a.values[d]=parseFloat(a.values[d])}a.min=a.values.min();a.max=a.values.max()};a.createColorArray=function(g,d,e,k){var e=e.colors;var h=new Array();var c=((d-g)+(d-g)/e.length)/e.length;for(var f=0;f<a.values.length;f++){if(a.values[f]<=g){var j=0}else{if(a.values[f]>d){var j=e.length-1}else{var j=parseInt((a.values[f]-g)/c)}}if(k){h.push.apply(h,e[e.length-1-j])}else{h.push.apply(h,e[j])}}return h};if(b){a.parse(b)}}o3djs.base.o3d=o3d;o3djs.require("o3djs.webgl");o3djs.require("o3djs.math");o3djs.require("o3djs.rendergraph");o3djs.require("o3djs.pack");o3djs.require("o3djs.picking");o3djs.require("o3djs.arcball");o3djs.require("o3djs.quaternions");o3djs.require("o3djs.scene");function BrainBrowser(e){var g=this;this.setup=function(h){g.preload_model(h)};this.init=function(){o3djs.webgl.makeClients(g.initStep2)};g.initStep2=function(i){var j=i[0];g.o3dElement=j;g.client=j.client;g.o3d=j.o3d;g.math=o3djs.math;g.dragging=false;g.o3dWidth=-1;g.o3dHeight=-1;g.quaternions=o3djs.quaternions;g.lastRot=g.math.matrix4.identity();g.thatRot=g.math.matrix4.identity();g.zoomFactor=1.1;g.keyPressDelta=0.1;g.clock=0;g.timeMult=1;g.camera={farPlane:5000,nearPlane:0.1};g.loading=jQuery("#o3d_loading");o3djs.base.init(j);g.pack=g.client.createPack();var h=o3djs.rendergraph.createBasicView(g.pack,g.client.root,g.client.renderGraphRoot,[0.5,0.5,0.5,1]);g.viewInfo=h;h.drawContext.projection=g.math.matrix4.perspective(g.math.degToRad(30),g.client.width/g.client.height,1,5000);g.eyeView=[0,0,500];h.drawContext.view=g.math.matrix4.lookAt(g.eyeView,[0,0,0],[0,1,0]);g.aball=o3djs.arcball.create(100,100);g.client.setRenderCallback(g.renderCallback);jQuery("body").keydown(g.keyPressedCallback);o3djs.event.addEventListener(j,"wheel",g.scrollMe);g.loadSpectrumFromUrl("/assets/spectral_spectrum.txt");if(g.afterInit){g.afterInit(g)}g.updateInfo();jQuery("#screenshot").click(function(k){jQuery(this).attr("href",bb.client.toDataURL())})};this.uninit=function(){if(this.client){this.client.cleanup()}};this.renderCallback=function(h){g.setClientSize()};this.createMaterial=function(h){var j=g.pack.createObject("Effect");var k=g.loadCombinedShaderFromUrl(h);j.loadFromFXString(k);var i=g.pack.createObject("Material");i.drawList=g.viewInfo.performanceDrawList;i.effect=j;j.createUniformParameters(i);return i};g.displayObjectFile=function(h){if(h.objectClass=="P"&&h.numberVertices==81924){g.createBrain(h)}else{if(h.objectClass=="P"){g.createPolygonObject(h)}else{if(h.objectClass=="L"){g.createLineObject(h)}else{alert("Object file not supported")}}}};function f(m){var n=m.getParam("transAlpha");n.value=1;var r=m.getParam("lightWorldPos");r.value=g.eyeView;var h=m.getParam("ambient");var l=m.getParam("ambientIntensity");var k=m.getParam("lightIntensity");var p=m.getParam("specular");var o=m.getParam("emissive");var i=m.getParam("colorMult");var q=m.getParam("wires");q.value=false;h.value=[0.04,0.04,0.04,1];l.value=[1,1,1,1];k.value=[0.8,0.8,0.8,1];p.value=[0.5,0.5,0.5,1];o.value=[0,0,0,1];i.value=[1,1,1,1];var j=m.getParam("shininess");j.value=30;return m}this.createBrain=function(i){g.model_data=i;var h=g.createMaterial("/shaders/blinnphong.txt");h=f(h);if(i.num_hemispheres==2){var j={left:g.createHemisphere(h,i.left,"left"),right:g.createHemisphere(h,i.right,"right"),num_hemisphere:2}}else{var j=g.createHemisphere(h,i);j.num_hemisphere=1}if(g.brainTransform==null){g.brainTransform=g.pack.createObject("Transform");if(i.num_hemispheres==2){g.brainHemisphereTransforms={};g.brainHemisphereTransforms.left=g.pack.createObject("Transform");g.brainHemisphereTransforms.right=g.pack.createObject("Transform")}}else{g.brainTransform.removeShape(g.brainTransform.shapes[0]);if(g.brainTransform.children[0]!=null){g.brainTransform.children[0].removeShape(g.brainTransform.children[0].shapes[0])}if(g.brainTransform.children[1]!=null){g.brainTransform.children[1].removeShape(g.brainTransform.children[1].shapes[0])}}if(i.num_hemispheres!=2){g.brainTransform.removeParam(g.brainTransform.children[0]);g.brainTransform.removeParam(g.brainTransform.children[1])}if(i.num_hemispheres==2&&g.brainHemisphereTransforms==null){g.brainHemisphereTransforms={};g.brainHemisphereTransforms.left=g.pack.createObject("Transform");g.brainHemisphereTransforms.right=g.pack.createObject("Transform")}g.brainTransform.parent=g.client.root;if(j.num_hemisphere==1){g.brainTransform.addShape(j);j.createDrawElements(g.pack,null)}else{g.brainHemisphereTransforms.left.parent=g.brainTransform;g.brainHemisphereTransforms.right.parent=g.brainTransform;g.brainHemisphereTransforms.left.addShape(j.left);g.brainHemisphereTransforms.right.addShape(j.right);j.left.createDrawElements(g.pack,null);j.right.createDrawElements(g.pack,null)}g.model_data=i;if(g.afterCreateBrain!=undefined){g.afterCreateBrain(g.model_data)}};g.createLineObject=function(j){g.model_data=j;var h=g.createMaterial("/shaders/line.txt");var i=g.createLineShape(h,j);if(g.brainTransform==undefined){g.brainTransform=g.pack.createObject("Transform")}g.brainTransform.parent=g.client.root;g.brainTransform.addShape(i);i.createDrawElements(g.pack,null);g.model_data=j;if(g.afterCreate!=undefined){g.afterCreate(g.model_data)}};g.createPolygonObject=function(j){g.model_data=j;var h=g.createMaterial("/shaders/blinnphong.txt");h=f(h);var i=g.createPolygonShape(h,j);if(g.brainTransform==undefined){g.brainTransform=g.pack.createObject("Transform")}g.brainTransform.parent=g.client.root;g.brainTransform.addShape(i);i.createDrawElements(g.pack,null);g.model_data=j;if(g.afterCreate!=undefined){g.afterCreate(g.model_data)}};g.createHemisphere=function(o,n,k){var w=g.pack.createObject("Shape");var t=g.pack.createObject("Primitive");var y=g.pack.createObject("StreamBank");t.material=o;t.owner=w;t.streamBank=y;w.name=k;t.primitiveType=g.o3d.Primitive.TRIANGLELIST;var j=g.pack.createObject("State");var q=g.pack.createObject("VertexBuffer");var s=q.createField("FloatField",3);if(!n.positionArray){alert("PositionArray nil");return false}q.set(n.positionArray);g.numberVertices=n.numberVertices;var x=(n.positionArray.length/3);t.numberVertices=g.numberVertices;if(!n.indexArray){alert("Index Array nil");return false}t.numberPrimitives=n.indexArray.length/3;var m=g.pack.createObject("IndexBuffer");m.set(n.indexArray);t.indexBuffer=m;var v=g.pack.createObject("VertexBuffer");var p=v.createField("FloatField",3);v.set(n.normalArray);var r=[];if(n.colorArray.length==4){for(var l=0;l<x;l++){r.push.apply(r,n.colorArray)}}else{r=n.colorArray}if(r.length<n.positionArray.length){alert("Problem with the colors: "+r.length)}var u=g.pack.createObject("VertexBuffer");var h=u.createField("FloatField",4);u.set(r);r=[];if(g.loading){jQuery(g.loading).html("Buffers Loaded")}y.setVertexStream(g.o3d.Stream.POSITION,0,s,0);y.setVertexStream(g.o3d.Stream.NORMAL,0,p,0);y.setVertexStream(g.o3d.Stream.COLOR,0,h,0);return w};g.createLineShape=function(s,n,C){var r=g.pack.createObject("Shape");var B=g.pack.createObject("StreamBank");r.name=C;if(!n.positionArray){alert("PositionArray nil");return false}g.numberVertices=n.numberVertices;var y=g.pack.createObject("Primitive");y.material=s;y.owner=r;y.streamBank=B;y.primitiveType=g.o3d.Primitive.LINELIST;var p=g.pack.createObject("State");y.material.state=p;var l=new Array();for(var x=0;x<n.nitems;x++){if(x==0){var o=0}else{var o=n.endIndicesArray[x-1]}l.push(n.indexArray[o]);for(var v=o+1;v<n.endIndicesArray[x]-1;v++){l.push(n.indexArray[v]);l.push(n.indexArray[v])}l.push(n.indexArray[n.endIndicesArray[x]-1])}var m=g.pack.createObject("IndexBuffer");y.numberPrimitives=l.length/2;y.numberVertices=l.length;g.indexArray=l;var h=new Float32Array(l.length*3);for(var w=0;w<l.length;w++){h[w*3]=n.positionArray[l[w]*3];h[w*3+1]=n.positionArray[l[w]*3+1];h[w*3+2]=n.positionArray[l[w]*3+2]}var q=[];if(n.colorArray.length==4){for(var x=0;x<numberVertices;x++){q.push.apply(q,[0.5,0.5,0.7,1])}}else{q=new Float32Array(l.length*4);for(var w=0;w<l.length;w++){q[w*4]=n.colorArray[l[w]*4];q[w*4+1]=n.colorArray[l[w]*4+1];q[w*4+2]=n.colorArray[l[w]*4+2];q[w*4+3]=n.colorArray[l[w]*4+3]}}var z=g.pack.createObject("VertexBuffer");var t=z.createField("FloatField",3);z.set(h);B.setVertexStream(g.o3d.Stream.POSITION,0,t,0);if(q.length<n.positionArray.length){alert("Problem with the colors: "+q.length)}var u=g.pack.createObject("VertexBuffer");var A=u.createField("FloatField",4);u.set(q);q=[];B.setVertexStream(g.o3d.Stream.COLOR,0,A,0);if(g.loading){jQuery(g.loading).html("Buffers Loaded")}g.pack.gl.lineWidth(1);return r};g.createPolygonShape=function(q,m,B){var y=g.pack.createObject("Shape");var A=g.pack.createObject("StreamBank");y.name=B;if(!m.positionArray){alert("PositionArray nil");return false}g.numberVertices=m.numberVertices;var k=g.pack.createObject("Primitive");k.material=q;k.owner=y;k.streamBank=A;k.primitiveType=g.o3d.Primitive.TRIANGLELIST;var n=g.pack.createObject("State");n.getStateParam("AlphaBlendEnable").value=true;n.getStateParam("SourceBlendFunction").value=o3djs.base.o3d.State.BLENDFUNC_SOURCE_ALPHA;n.getStateParam("DestinationBlendFunction").value=o3djs.base.o3d.State.BLENDFUNC_INVERSE_SOURCE_ALPHA;n.getStateParam("AlphaTestEnable").value=true;n.getStateParam("AlphaComparisonFunction").value=o3djs.base.o3d.State.CMP_GREATER;k.material.state=n;var l=m.indexArray;k.numberPrimitives=l.length/3;k.numberVertices=l.length;g.indexArray=l;var h=new Float32Array(l.length*3);var w=new Float32Array(l.length*3);for(var u=0;u<l.length;u++){h[u*3]=m.positionArray[l[u]*3];h[u*3+1]=m.positionArray[l[u]*3+1];h[u*3+2]=m.positionArray[l[u]*3+2];w[u*3]=m.normalArray[l[u]*3];w[u*3+1]=m.normalArray[l[u]*3+1];w[u*3+2]=m.normalArray[l[u]*3+2]}alert("positionArray.lenght"+h.length+" normalArray.length"+w.length);var o=[];if(m.colorArray.length==4){for(var v=0;v<k.numberVertices;v++){o.push.apply(o,m.colorArray)}}else{o=new Float32Array(l.length*4);for(var u=0;u<l.length;u++){o[u*4]=m.colorArray[l[u]*4];o[u*4+1]=m.colorArray[l[u]*4+1];o[u*4+2]=m.colorArray[l[u]*4+2];o[u*4+3]=m.colorArray[l[u]*4+3]}}var p=g.pack.createObject("VertexBuffer");var s=p.createField("FloatField",3);p.set(w);A.setVertexStream(g.o3d.Stream.NORMAL,0,s,0);var x=g.pack.createObject("VertexBuffer");var r=x.createField("FloatField",3);x.set(h);A.setVertexStream(g.o3d.Stream.POSITION,0,r,0);if(o.length<m.positionArray.length){alert("Problem with the colors: "+o.length)}var t=g.pack.createObject("VertexBuffer");var z=t.createField("FloatField",4);t.set(o);o=[];A.setVertexStream(g.o3d.Stream.COLOR,0,z,0);if(g.loading){jQuery(g.loading).html("Buffers Loaded")}return y};g.createPinPoint=function(j){var o=g.pack.createObject("Transform");var l=g.createMaterial("/shaders/pinpoint.txt");var h=g.pack.createObject("Shape");var i=g.pack.createObject("Primitive");i.primitiveType=g.o3d.Primitive.POINTLIST;var p=g.pack.createObject("StreamBank");i.material=l;i.owner=h;i.streamBank=p;var k=this.model_data.getVertexInfo(j)["position_vector"];var m=g.pack.createObject("VertexBuffer");var n=m.createField("FloatField",3);m.set(k);p.setVertexStream(g.o3d.Stream.POSITION,0,n,0);o.addShape(h);h.createDrawElements(g.pack,null);return o};g.resetView=function(){g.brainTransform.children[0].visible=true;g.brainTransform.children[1].visible=true;g.brainTransform.identity();g.brainTransform.children[0].identity();g.brainTransform.children[1].identity()};this.setupView=function(h){g.resetView();if(g.model_data&&g.model_data.num_hemispheres==2){var i=g.getViewParams();switch(i.view){case"superior":g.superiorView();break;case"medial":g.medialView();break;case"anterior":g.anteriorView();break;case"inferior":g.inferiorView();break;case"lateral":g.lateralView();break;case"posterior":g.posteriorView();break;default:g.superiorView();break}}if(i.left==true){g.leftHemisphereVisible(true)}else{g.leftHemisphereVisible(false)}if(i.right==true){g.rightHemisphereVisible(true)}else{g.rightHemisphereVisible(false)}g.thatRot=g.math.matrix4.mul(g.brainTransform.localMatrix,g.math.matrix4.identity())};this.leftHemisphereVisible=function(h){g.brainTransform.children[0].visible=h};this.rightHemisphereVisible=function(h){g.brainTransform.children[1].visible=h};this.medialView=function(h){if(g.model_data.num_hemispheres==2){g.brainTransform.children[0].translate([-100,0,0]);g.brainTransform.children[1].translate([100,0,0]);g.brainTransform.children[0].rotateZ(g.math.degToRad(-90));g.brainTransform.children[1].rotateZ(g.math.degToRad(90));g.brainTransform.rotateX(g.math.degToRad(-90))}};this.lateralView=function(h){if(g.model_data.num_hemispheres==2){g.brainTransform.children[0].translate([-100,0,0]);g.brainTransform.children[1].translate([100,0,0]);g.brainTransform.children[0].rotateZ(g.math.degToRad(-90));g.brainTransform.children[1].rotateZ(g.math.degToRad(90));g.brainTransform.rotateX(g.math.degToRad(90));g.brainTransform.rotateY(g.math.degToRad(180))}};this.superiorView=function(){};this.inferiorView=function(){g.brainTransform.rotateY(g.math.degToRad(180))};this.anteriorView=function(h){g.resetView();g.brainTransform.rotateX(g.math.degToRad(-90));g.brainTransform.rotateZ(g.math.degToRad(180))};this.posteriorView=function(h){g.resetView();g.brainTransform.rotateX(g.math.degToRad(-90))};this.separateHemispheres=function(h){if(g.model_data.num_hemispheres==2){this.brainTransform.children[0].translate([-1,0,0]);this.brainTransform.children[1].translate([1,0,0])}};this.setClientSize=function(){var i=parseInt(g.client.width);var h=parseInt(g.client.height);if(i!=g.o3dWidth||h!=g.o3dHeight){g.o3dWidth=i;g.o3dHeight=h;g.updateProjection();g.aball.setAreaSize(g.o3dWidth,g.o3dHeight)}};g.ZoomInOut=function(j){for(var h=0;h<g.eyeView.length;h+=1){g.eyeView[h]=g.eyeView[h]/j}g.viewInfo.drawContext.view=g.math.matrix4.lookAt(g.eyeView,[0,0,0],[0,1,0])};g.scrollMe=function(i){var h=(i.deltaY<0)?1/g.zoomFactor:g.zoomFactor;g.ZoomInOut(h);g.client.render()};function b(h){d();if(h){g.selectedInfo=h}}this.updateInfo=function(){if(!g.treeInfo){g.treeInfo=o3djs.picking.createPickManager(g.client.root)}g.treeInfo.update()};function d(){if(g.selectedInfo){g.highlightShape=null;g.selectedInfo=null}}this.click=function(n,k){var j=o3djs.picking.clientPositionToWorldRay(n.x,n.y,g.viewInfo.drawContext,g.client.width,g.client.height);d();g.treeInfo.update();var l=g.treeInfo.pick(j);if(l){b(l);var p=l.rayIntersectionInfo.primitiveIndex;var m=l.rayIntersectionInfo.position;var h=l.element.owner.name;var o=g.model_data.get_vertex(p,m,h);var i={position_vector:o.position_vector,element:l.element,hemisphere:h,vertex:o.vertex};return k(n,i)}else{jQuery(g.pickInfoElem).html("--nothing--")}return false};g.getInfoForVertex=function(h){return g.model_data.getVertexInfo(h)};g.startDragging=function(h){if(h.shiftKey&&h.ctrlKey&&g.model_data.num_hemispheres==2){g.drag_hemisphere=click(h,function(i,j){if(j.hemisphere=="left"){return 0}else{if(j.hemisphere=="right"){return 1}else{return false}}})}g.lastRot=g.thatRot;g.aball.click([h.x,h.y]);g.dragging=true};g.drag=function(k){if(g.dragging&&k.button==g.o3d.Event.BUTTON_LEFT){var j=g.aball.drag([k.x,k.y]);var i=g.quaternions.quaternionToRotation(j);g.thatRot=g.math.matrix4.mul(g.lastRot,i);if(g.drag_hemisphere===0||g.drag_hemisphere===1){var h=g.brainTransform.children[g.drag_hemisphere].localMatrix;g.math.matrix4.setUpper3x3(h,g.thatRot);g.brainTransform.children[g.drag_hemisphere].localMatrix=h}else{var h=g.brainTransform.localMatrix;g.math.matrix4.setUpper3x3(h,g.thatRot);g.brainTransform.localMatrix=h}}else{if(g.dragging){g.stopDragging(k)}}};g.stopDragging=function(h){g.drag_hemisphere=false;g.dragging=false};g.updateCamera=function(){var h=[0,1,0];g.viewInfo.drawContext.view=g.math.matrix4.lookAt(g.camera.eye,g.camera.target,h);g.lightPosParam.value=g.camera.eye};g.updateProjection=function(){g.viewInfo.drawContext.projection=g.math.matrix4.perspective(g.math.degToRad(45),g.o3dWidth/g.o3dHeight,g.camera.nearPlane,g.camera.farPlane)};g.keyPressedAction=function(h,j){var i=false;switch(h){case"&":g.ZoomInOut(g.zoomFactor);i="zoom_in";break;case"(":g.ZoomInOut(1/g.zoomFactor);i="zoom_out";break;case" ":g.separateHemispheres();i="separate";break}return i};g.keyPressedCallback=function(i){var h=false;switch(i.which){case 38:g.ZoomInOut(g.zoomFactor);h="ZoomIn";break;case 40:g.ZoomInOut(1/g.zoomFactor);h="ZoomOut";break;case 32:g.separateHemispheres();h="Seperate";break}if(h){return false}else{return true}};g.set_fill_mode_wireframe=function(){if(g.model_data.num_hemispheres==2){var h=g.brainTransform.children[0].shapes[0].elements[0].material;g.state=g.pack.createObject("State");h.state=g.state;var i=h.getParam("wires");i.value=true;g.state.getStateParam("FillMode").value=g.o3d.State.WIREFRAME;h=g.brainTransform.children[1].shapes[0].elements[0].material;h.state=g.state;i=h.getParam("wires");i.value=true}else{var h=g.brainTransform.shapes[0].elements[0].material;g.state=g.pack.createObject("State");h.state=g.state;g.state.getStateParam("FillMode").value=g.o3d.State.WIREFRAME;var i=h.getParam("wires");i.value=true}g.client.render()};g.set_fill_mode_solid=function(){if(g.model_data.num_hemispheres==2){var h=g.brainTransform.children[0].shapes[0].elements[0].material;g.state1=g.pack.createObject("State");h.state=g.state1;var i=h.getParam("wires");i.value=false;g.state.getStateParam("FillMode").value=g.o3d.State.SOLID;h=g.brainTransform.children[1].shapes[0].elements[0].material;h.state=g.state;var i=h.getParam("wires");i.value=false}else{var h=g.brainTransform.shapes[0].elements[0].material;g.state=g.pack.createObject("State");h.state=g.state;g.state.getStateParam("FillMode").value=g.o3d.State.SOLID;var i=h.getParam("wires");i.value=false}};function a(h,i,j){jQuery.ajax({type:"GET",url:h,dataType:"text",success:function(k){j(k)},error:function(k,m,l){alert("Failure: "+m)},data:{},async:i,timeout:100000})}function c(k,j){var h=new FileReader();var i=k.files;h.file=i[0];alert(h.file.size);h.onloadend=function(l){j(l.target.result)};h.readAsText(i[0])}g.loadObjFromUrl=function(h){a(h,false,function(i){g.displayObjectFile(new MNIObject(i))})};g.loadObjFromFile=function(h){c(h,function(i){g.displayObjectFile(new MNIObject(i))})};g.loadSpectrumFromUrl=function(h){a(h,true,function(j){var i=new Spectrum(j);g.spectrum=i;if(g.afterLoadSpectrum!=null){g.afterLoadSpectrum(i)}if(g.data){g.updateColors(g.data,g.rangeMin,g.rangeMax,g.spectrum)}})};g.loadSpectrumFromFile=function(h){c(h,function(j){var i=new Spectrum(j);g.spectrum=i;if(g.afterLoadSpectrum!=null){g.afterLoadSpectrum(i)}if(g.data){g.updateColors(g.data,g.rangeMin,g.rangeMax,g.spectrum)}})};g.loadDataFromFile=function(n){var h=n.files[0].name;var l=function(o){g.data=new Data(o);if(g.fixRange==false||g.fixRange==null){g.rangeMin=g.data.min;g.rangeMax=g.data.max;if(g.afterLoadData!=null){g.afterLoadData(g.rangeMin,g.rangeMax,g.data)}}g.updateColors(g.data,g.rangeMin,g.rangeMax,g.spectrum)};if(h.match(/.*.mnc/)){var m=new XMLHttpRequest();m.open("POST","/minc/volume_object_evaluate",false);var j=document.getElementById("datafile-form");var k=new FormData(j);m.send(k);var i=m.response;l(i)}else{if(h.match(/.*.nii/)){var m=new XMLHttpRequest();m.open("POST","/nii/volume_object_evaluate",false);var j=document.getElementById("datafile-form");var k=new FormData(j);m.send(k);var i=m.response;l(i)}else{c(n,l)}}};g.loadDataFromUrl=function(h){a(h,true,function(i){g.data=new Data(i);if(g.fixRange==false||g.fixRange==null){g.rangeMin=g.data.min;g.rangeMax=g.data.max}g.updateColors(g.data,g.rangeMin,g.rangeMax,g.spectrum)})};g.loadCombinedShaderFromUrl=function(h){var i;a(h,false,function(j){i=j});return i};g.updateColors=function(A,s,u,y,k){var z=A.createColorArray(s,u,y,k);if(g.model_data.num_hemispheres==1){var p=g.pack.createObject("VertexBuffer");var t=p.createField("FloatField",4);p.set(z);var j=g.brainTransform.shapes[0];var n=j.elements[0].streamBank;n.setVertexStream(g.o3d.Stream.COLOR,0,t,0)}else{var i=z.slice(0,z.length/2);var r=z.slice(z.length/2,z.length);var o=g.pack.createObject("VertexBuffer");var w=o.createField("FloatField",4);o.set(i);var m=g.brainTransform.children[0].shapes[0];var q=m.elements[0].streamBank;q.setVertexStream(g.o3d.Stream.COLOR,0,w,0);var v=g.pack.createObject("VertexBuffer");var l=v.createField("FloatField",4);v.set(r);var x=g.brainTransform.children[1].shapes[0];var h=x.elements[0].streamBank;h.setVertexStream(g.o3d.Stream.COLOR,0,l,0);g.client.render()}if(g.afterUpdateColors!=null){g.afterUpdateColors(A,s,u,y)}return 1};g.rangeChange=function(i,h){g.rangeMin=i;g.rangeMax=h;g.updateColors(g.data,g.rangeMin,g.rangeMax,g.spectrum);if(g.afterRangeChange!=null){g.afterRangeChange(i,h)}};g.init()}var brainbrowser;function SurfView(){var a=this;brainbrowser=new BrainBrowser();this.brainbrowser=brainbrowser;brainbrowser.getViewParams=function(){return{view:jQuery("[name=hem_view]:checked").val(),left:jQuery("#left_hem_visible").attr("checked"),right:jQuery("#right_hem_visible").attr("checked")}};brainbrowser.afterLoadSpectrum=function(b){var c=b.createSpectrumCanvasWithScale(0,100,null);jQuery('<div id="spectrum" class="box full_box"></div>').html(c).appendTo("#controls");brainbrowser.spectrumObj=b};jQuery("#resetview").click(brainbrowser.setupView);jQuery(".view_button").change(brainbrowser.setupView);jQuery("[name=hem_view]").change(brainbrowser.setupView);this.updateCoordinates=function(b,d,c){jQuery("#x-coord").val(b[0]);jQuery("#y-coord").val(b[1]);jQuery("#z-coord").val(b[2]);jQuery("#v-coord").val(d);jQuery("#value-coord").val(c)};brainbrowser.afterInit=function(b){jQuery("body").keydown(b.keyPressedCallback);o3djs.event.addEventListener(b.o3dElement,"mousedown",function(c){if(c.shiftKey){b.click(c,function(f,d){if(brainbrowser.data){a.updateCoordinates(d.position_vector,d.vertex,brainbrowser.data.values[d.vertex])}})}else{b.startDragging(c)}});o3djs.event.addEventListener(b.o3dElement,"mousemove",function(c){b.drag(c)});o3djs.event.addEventListener(b.o3dElement,"mouseup",function(c){if(!c.shiftKey||c.button==b.o3d.Event.BUTTON_RIGHT){b.stopDragging(c)}});jQuery("#range-slider").slider({range:true,min:-50,max:50,value:[-10,10],slide:function(e,f){var d=parseFloat(f.values[0]);var c=parseFloat(f.values[1]);b.rangeChange(d,c)},step:0.1});b.afterRangeChange=function(e,c){jQuery("#data-range-min").val(e);jQuery("#data-range-max").val(c);var d=b.spectrumObj.createSpectrumCanvasWithScale(e,c,null);jQuery("#spectrum").html(jQuery(d))};b.afterLoadData=function(d,c,e){b.afterRangeChange(d,c);jQuery("#range-slider").slider("values",0,parseFloat(d));jQuery("#range-slider").slider("values",1,parseFloat(c))};jQuery("#meshmode").change(function(c){if(jQuery(c.target).attr("checked")==true){b.set_fill_mode_wireframe()}else{b.set_fill_mode_solid()}});jQuery("#fix_range").click(function(c,d){b.fixRange=jQuery("#fix_range").attr("checked");alert("fixRange "+b.fixRange)});jQuery(".range-box").keypress(function(c){if(c.keyCode=="13"){b.rangeChange(parseFloat(jQuery("#data-range-min").val()),parseFloat(jQuery("#data-range-max").val()))}});jQuery("#data-range-min").change(function(c){jQuery("#range-slider").slider("values",0,parseFloat(jQuery(this).val()))});jQuery("#data-range-max").change(function(c){jQuery("#range-slider").slider("values",1,parseFloat(jQuery(this).val()))});$("#examples").click(function(d){var c=$(d.target).attr("data-example-name");switch(c){case"basic":b.loadObjFromUrl("/models/surf_reg_model_both.obj");break;case"punkdti":b.loadObjFromUrl("/models/dti.obj");b.loadObjFromUrl("/models/left_color.obj");b.loadObjFromUrl("/models/right_color.obj");break;case"realct":b.loadObjFromUrl("/models/realct.obj");b.loadDataFromUrl("/models/realct.txt");break}return false})}};