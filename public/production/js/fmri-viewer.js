/*
* BrainBrowser: Web-based Neurological Visualization Tools
* (https://brainbrowser.cbrain.mcgill.ca)
*
* Copyright (C) 2011 McGill University 
*
* This program is free software: you can redistribute it and/or modify
* it under the terms of the GNU Affero General Public License as
* published by the Free Software Foundation, either version 3 of the
* License, or (at your option) any later version.
*
* This program is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
* GNU Affero General Public License for more details.
*
* You should have received a copy of the GNU Affero General Public License
* along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

/*
* BrainBrowser v1.5.1
*
* Author: Tarek Sherif  <tsherif@gmail.com> (http://tareksherif.ca/)
* Author: Nicolas Kassis
*/
$(function(){"use strict";BrainBrowser.VolumeViewer.start("brainbrowser",function(a){var b=$("#loading");a.addEventListener("ready",function(){$(".button").button(),$("#sync-volumes").change(function(){a.synced=$(this).is(":checked")}),$("#capture-slices").click(function(){var b=a.displays[0][0].canvas.width,c=a.displays[0][0].canvas.height,d=a.active_canvas,e=document.createElement("canvas"),f=e.getContext("2d"),g=new Image;e.width=b*a.displays.length,e.height=3*c,f.fillStyle="#000000",f.fillRect(0,0,e.width,e.height),a.active_canvas=null,a.draw(),a.displays.forEach(function(a,d){a.forEach(function(a,e){f.drawImage(a.canvas,d*b,e*c)})}),a.active_canvas=d,a.draw(),g.onload=function(){$("<div></div>").append(g).dialog({title:"Slices",height:g.height,width:g.width})},g.src=e.toDataURL()}),$(".world-coords").change(function(){var b=$(this),c=b.data("volume-id"),d=parseFloat(b.find("#world-x-"+c).val()),e=parseFloat(b.find("#world-y-"+c).val()),f=parseFloat(b.find("#world-z-"+c).val());BrainBrowser.utils.isNumeric(d)||(d=0),BrainBrowser.utils.isNumeric(e)||(e=0),BrainBrowser.utils.isNumeric(f)||(f=0),a.volumes[c].setWorldCoords(d,e,f),a.redrawVolumes()}),$(".color-map-select").change(function(b){var c=a.volumes[$(this).data("volume-id")];c.color_map=BrainBrowser.VolumeViewer.color_maps[+$(b.target).val()],a.redrawVolumes()}),$(".threshold-div").each(function(){var b=$(this),c=b.data("volume-id"),d=a.volumes[c],e=b.find("#min-threshold-"+c),f=b.find("#max-threshold-"+c),g=b.find(".slider");g.slider({range:!0,min:0,max:255,values:[0,255],step:1,slide:function(b,c){var g=c.values;d.min=g[0],d.max=g[1],a.redrawVolumes(),e.val(g[0]),f.val(g[1])},stop:function(){$(this).find("a").blur()}}),e.change(function(){var b=parseFloat(this.value);BrainBrowser.utils.isNumeric(b)||(b=0),b=Math.max(0,Math.min(b,255)),this.value=b,g.slider("values",0,b),d.min=b,a.redrawVolumes()}),f.change(function(){var b=parseFloat(this.value);BrainBrowser.utils.isNumeric(b)||(b=255),b=Math.max(0,Math.min(b,255)),this.value=b,g.slider("values",1,b),d.max=b,a.redrawVolumes()})}),$(".time-div").each(function(){var b,c=$(this),d=c.data("volume-id"),e=a.volumes[d],f=c.find(".slider"),g=c.find("#time-val-"+d),h=c.find("#play-"+d),i=0,j=e.data.time.space_length-1;f.slider({min:i,max:j,value:0,step:1,slide:function(b,c){var d=+c.value;g.val(d),e.current_time=d,a.redrawVolumes()},stop:function(){$(this).find("a").blur()}}),g.change(function(){var b=parseInt(this.value,10);BrainBrowser.utils.isNumeric(b)||(b=0),b=Math.max(i,Math.min(b,j)),this.value=b,g.val(b),f.slider("value",b),e.current_time=b,a.redrawVolumes()}),h.change(function(){h.is(":checked")?(clearInterval(b),b=setInterval(function(){var b=e.current_time+1;b=b>j?0:b,e.current_time=b,g.val(b),f.slider("value",b),a.redrawVolumes()},200)):clearInterval(b)})}),$(".slice-series-div").each(function(){var b=$(this),c=b.data("volume-id"),d=a.volumes[c],e={xspace:"Sagittal",yspace:"Coronal",zspace:"Transverse"};b.find(".slice-series-button").click(function(){var a,b,c,f=$(this).data("axis"),g=d.data[f],h=g.space_length,i=d.current_time,j=10,k=.5,l=document.createElement("canvas"),m=l.getContext("2d"),n=d.slice(f,0,i).getImage(k),o=new Image;for(l.width=j*n.width,l.height=(h/j+1)*n.height,m.fillStyle="#000000",m.fillRect(0,0,l.width,l.height),a=0;h>a;a++)n=d.slice(f,a,i).getImage(k),b=a%j*n.width,c=Math.floor(a/j)*n.height,m.putImageData(n,b,c);o.onload=function(){$("<div></div>").append(o).dialog({title:e[f]+" Slices",height:600,width:o.width})},o.src=l.toDataURL()})}),b.hide(),$("#brainbrowser-wrapper").slideDown({duration:600}),$(".button").button()}),a.addEventListener("sliceupdate",function(){a.volumes.forEach(function(a,b){var c=a.getWorldCoords(),d=a.getVoxelCoords();$("#world-x-"+b).val(c.x.toPrecision(6)),$("#world-y-"+b).val(c.y.toPrecision(6)),$("#world-z-"+b).val(c.z.toPrecision(6)),$("#voxel-x-"+b).val(d.x.toPrecision(6)),$("#voxel-y-"+b).val(d.y.toPrecision(6)),$("#voxel-z-"+b).val(d.z.toPrecision(6))})}),b.show(),a.loadVolumes({volumes:[{type:"minc",header_url:"data/ibis_410023_LIVING_PHANTOM_STL_SD_HOS_20121212_SCAN1_ep2d_bold_001.mnc?minc_headers=true",raw_data_url:"data/ibis_410023_LIVING_PHANTOM_STL_SD_HOS_20121212_SCAN1_ep2d_bold_001.mnc?raw_data=true",template:{element_id:"volume-ui-template",viewer_insert_class:"volume-viewer-display"}},{type:"minc",header_url:"data/ibis_410023_LIVING_PHANTOM_STL_SD_HOS_20121212_SCAN1_dti_001.mnc?minc_headers=true",raw_data_url:"data/ibis_410023_LIVING_PHANTOM_STL_SD_HOS_20121212_SCAN1_dti_001.mnc?raw_data=true",template:{element_id:"volume-ui-template",viewer_insert_class:"volume-viewer-display"}}],panel_width:256,panel_height:256})})});