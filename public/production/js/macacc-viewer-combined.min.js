/*
 * Copyright (C) 2011 McGill University
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 *   the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

/* brainbrowser v1.1.0 */
!function(){"use strict";Array.prototype.min||(Array.prototype.min=function(){var a,b,c=this[0];for(a=1,b=this.length;b>a;a++)this[a]<c&&(c=this[a]);return c}),Array.prototype.max||(Array.prototype.max=function(){var a,b,c=this[0];for(a=1,b=this.length;b>a;a++)this[a]>c&&(c=this[a]);return c})}(),function(){"use strict";var a=window.BrainBrowser={start:function(b){if(!utils.webWorkersEnabled())return alert("Can't find web workers. Exiting."),void 0;if(!utils.webglEnabled())return alert("Can't get WebGL context. Exiting."),void 0;var c,d=Object.create(a.prototype||{});d.view_window=document.getElementById("brainbrowser"),d.model=void 0;for(c in a.core)a.core.hasOwnProperty(c)&&a.core[c](d);for(c in a.modules)a.modules.hasOwnProperty(c)&&a.modules[c](d);for(c in a.plugins)a.plugins.hasOwnProperty(c)&&a.plugins[c](d);d.render(),b(d)}};a.core={},a.modules={},a.plugins={},a.filetypes={}}(),BrainBrowser.colorManager=function(){"use strict";var a={};return a.createColorMap=function(a,b,c,d,e,f,g,h,i){a=a.colors;var j,k,l,m,n,o=a.length,p=(e-d+(e-d)/o)/o,q=[];for(j=0,k=c.length;k>j;j++)m=c[j],l=d>=m?0:c[j]>e?o-1:parseInt((m-d)/p,10),n=f?255:1,q=a[l]||[0,0,0],b[4*j+0]=n*q[0]*h+g*n,b[4*j+1]=n*q[1]*h+g*n,b[4*j+2]=n*q[2]*h+g*n,b[4*j+3]=i?n*i:n;return b},a.blendColors=function(a){var b,c,d,e,f,g,h=a[0];for(b=0,d=a[0].length/4;d>b;b++)for(c=1,e=a.length;e>c;c++)f=h[4*b+3],g=a[c][4*b+3],h[4*b]=h[4*b]*f+a[c][4*b]*g,h[4*b+1]=h[4*b+1]*f+a[c][4*b+1]*g,h[4*b+2]=h[4*b+2]*f+a[c][4*b+2]*g,h[4*b+3]=f+g;return h},a.blendColorMap=function(b,c){var d,e,f=c.length,g=new Array(f);for(d=0;f>d;d++)e=c[d],g[d]=a.createColorMap(b,new Array(e.values.length),e.values,e.rangeMin,e.rangeMax,!1,0,1,e.alpha);return a.blendColors(g)},a},BrainBrowser.data=function(a,b){"use strict";function c(){var c=new Worker("js/workers/data.worker.js");c.addEventListener("message",function(a){var e,f=a.data;for(e in f)f.hasOwnProperty(e)&&(d[e]=f[e]);b&&b(d),c.terminate()}),c.postMessage({cmd:"parse",data:a})}var d={};d.createColorArray=function(a,b,c,e,f,g,h,i){var j=new Worker("js/workers/data.worker.js");j.addEventListener("message",function(a){var b=a.data;i&&i(b),j.terminate()}),j.postMessage({cmd:"createColorArray",data:{values:d.values,min:a,max:b,spectrum:c.colors,flip:e,clamped:f,original_colors:g,model:{num_hemisphere:h.num_hemisphere,indexArray:h.indexArray}}})},a&&("string"==typeof a?c(a):a.values?(d.values=a.values.concat(),d.min=d.values.min(),d.max=d.values.max()):(d.values=a,d.min=a.min(),d.max=a.max()))},BrainBrowser.spectrum=function(a){"use strict";function b(a,b,c,f){var g,h,i,j=document.createElement("canvas"),k=new Array(256);for($(j).attr("width",256),$(j).attr("height",c),g=0;256>g;g++)f?k[255-g]=g:k[g]=g;for(a=e.createColorMap(d,[],k,0,255,!0,0,1),i=j.getContext("2d"),h=0;256>h;h++)i.fillStyle="rgb("+parseInt(a[4*h],10)+", "+parseInt(a[4*h+1],10)+", "+parseInt(a[4*h+2],10)+")",i.fillRect(h,0,1,b);return j}function c(a){a=a.replace(/^\s+/,"").replace(/\s+$/,"");var b,c,e,f,g,h=a.split(/\n/),i=[];for(b=0,e=h.length;e>b;b++){for(g=h[b].replace(/\s+$/,"").split(/\s+/),f=g.length,c=0;f>c;c++)g[c]=parseFloat(g[c]);4>f&&g.push(1),i.push(g)}return d.colors=i,i}var d={},e=BrainBrowser.colorManager();return d.createSpectrumCanvas=function(a){var c;return a||(a=d.colors),c=b(a,20,20,!1)},d.createSpectrumCanvasWithScale=function(a,c,e,f){var g,h;return null===e&&(e=d.colors),g=b(e,20,40,f),h=g.getContext("2d"),h.fillStyle="#FFA000",h.fillRect(.5,20,1,10),h.fillText(a.toPrecision(3),.5,40),h.fillRect(g.width/4,20,1,10),h.fillText(((a+c)/4).toPrecision(3),g.width/4,40),h.fillRect(g.width/2,20,1,10),h.fillText(((a+c)/2).toPrecision(3),g.width/2,40),h.fillRect(3*(g.width/4),20,1,10),h.fillText((3*((a+c)/4)).toPrecision(3),3*(g.width/4),40),h.fillRect(g.width-.5,20,1,10),h.fillText(c.toPrecision(3),g.width-20,40),g},a&&c(a),d},function(){"use strict";BrainBrowser.filetypes.config={MNIObject:{worker:"js/workers/mniobj.worker.js",afterParse:function(a){a.getVertexInfo=function(b){var c=[a.positionArray[3*b],a.positionArray[3*b+1],a.positionArray[3*b+2]];return{vertex:b,position_vector:c}}}},WavefrontObj:{worker:"js/workers/wavefront_obj.worker.js"},FreeSurferAsc:{worker:"js/workers/freesurfer_asc.worker.js",format_hint:'You can use <a href="http://surfer.nmr.mgh.harvard.edu/fswiki/mris_convert" target="_blank">mris_convert</a> to convert your binary surface files into .asc format.'}}}(),BrainBrowser.filetypes.parse=function(a,b,c){"use strict";var d={},e=BrainBrowser.filetypes.config[a];e.parse&&e.parse(d,b,c),e.worker&&BrainBrowser.filetypes.parseWorker(d,b,e.worker,c),e.afterParse&&e.afterParse(d,b)},BrainBrowser.filetypes.parseWorker=function(a,b,c,d){"use strict";var e=new Worker(c);e.addEventListener("message",function(b){var c,f=b.data;for(c in f)f.hasOwnProperty(c)&&(a[c]=f[c]);d&&d(a),e.terminate()}),e.postMessage(b)},BrainBrowser.core.color=function(a){"use strict";function b(b){var c,d,e,f,g,h,i,j=a.model,k=b.length,l=j.getChildByName("left"),m=l.geometry.faces,n=j.getChildByName("right"),o=n.geometry.faces,p=o.length,q=m.length;for(c=b.slice(0,k/2),d=b.slice(k/2,k),g=Math.max(q,p),f=0;g>f;f++)q>f&&(e=m[f],i=e.vertexColors,h=4*e.a,i[0].setRGB(c[h],c[h+1],c[h+2]),h=4*e.b,i[1].setRGB(c[h],c[h+1],c[h+2]),h=4*e.c,i[2].setRGB(c[h],c[h+1],c[h+2]),e.d&&(h=4*e.d,i[3].setRGB(c[h],c[h+1],c[h+2]))),p>f&&(e=o[f],i=e.vertexColors,h=4*e.a,i[0].setRGB(d[h],d[h+1],d[h+2]),h=4*e.b,i[1].setRGB(d[h],d[h+1],d[h+2]),h=4*e.c,i[2].setRGB(d[h],d[h+1],d[h+2]),e.d&&(h=4*e.d,i[3].setRGB(d[h],d[h+1],d[h+2])));l.geometry.colorsNeedUpdate=!0,n.geometry.colorsNeedUpdate=!0}function c(a,b){var c,d,e,f,g,h,i,j;for(g=0,i=b.length;i>g;g++){for(e=b[g].geometry.faces,h=0,j=e.length;j>h;h++)d=e[h],f=d.vertexColors,c=4*d.a,f[0].setRGB(a[c],a[c+1],a[c+2]),c=4*d.b,f[1].setRGB(a[c],a[c+1],a[c+2]),c=4*d.c,f[2].setRGB(a[c],a[c+1],a[c+2]),d.d&&(c=4*d.d,f[3].setRGB(a[c],a[c+1],a[c+2]));b[g].geometry.colorsNeedUpdate=!0}}var d=BrainBrowser.colorManager();a.updateColors=function(e,f){function g(d){var f;2===a.model_data.num_hemispheres?b(d):(f=e.apply_to_shape?[a.model.getChildByName(e.apply_to_shape,!0)]:a.model.children,c(d,f)),a.afterUpdateColors&&a.afterUpdateColors(e,h,i,j),n&&n()}f=f||{};var h=f.min,i=f.max,j=f.spectrum,k=f.flip,l=f.clamped,m=f.blend,n=f.afterUpdate;a.clamped=l,m?g(d.blendColorMap(j,e,0,1)):e.createColorArray(h,i,j,k,l,a.model_data.colorArray,a.model_data,g)}},BrainBrowser.modules.loader=function(a){"use strict";function b(a,b,c){b=b||{};var d=b.beforeLoad;d&&d(),jQuery.ajax({type:"GET",url:a,dataType:"text",success:function(a){f(b)||c(a)},error:function(a,b){alert("Failure in loadFromURL: "+b)},timeout:1e5})}function c(a,b,c){var d=a.files;if(0!==d.length){b=b||{};var e=b.beforeLoad,f=new FileReader;f.file=d[0],e&&e(),f.onloadend=function(a){c(a.target.result)},f.readAsText(d[0])}}function d(a,b){var c,d,e;c=new XMLHttpRequest,a.match(/.*.mnc/)?c.open("POST","/minc/volume_object_evaluate",!1):c.open("POST","/nii/volume_object_evaluate",!1),d=new FormData(document.getElementById("datafile-form")),c.send(d),e=c.response,b(e)}function e(b,c,d){d||(d=a.model_data.data),d.fixRange||(d.rangeMin=b,d.rangeMax=c)}function f(a){a=a||{};var b=a.cancel||{};utils.isFunction(b)&&(b={test:b});var c=b.test,d=b.cleanup,e=!1;return c&&c()&&(e=!0,d&&d()),e}a.loadModelFromUrl=function(c,d){d=d||{};var e,g,h=d.format||"MNIObject";b(c,d,function(b){e=c.split("/"),g=e[e.length-1],BrainBrowser.filetypes.parse(h,b,function(b){"__FAIL__"!==b.objectClass?f(d)||a.displayObjectFile(b,g,d):void 0!==d.onError&&d.onError()})})},a.loadModelFromFile=function(b,d){d=d||{};var e,f,g=d.format||"MNIObject";c(b,d,function(c){e=b.value.split("\\"),f=e[e.length-1],BrainBrowser.filetypes.parse(g,c,function(b){"__FAIL__"!==b.objectClass?a.displayObjectFile(b,f,d):d.onError&&d.onError()})})},a.loadDataFromUrl=function(c,d,g){g=g||{},b(c,g,function(b){BrainBrowser.data(b,function(b){if(!f(g)){var c=void 0===g.max?b.max:g.max,h=void 0===g.min?b.min:g.min;a.model_data.data=b,b.fileName=d,b.apply_to_shape=g.shape,e(h,c),a.afterLoadData&&a.afterLoadData(b.rangeMin,b.rangeMax,b),a.updateColors(b,{min:b.rangeMin,max:b.rangeMax,spectrum:a.spectrum,flip:a.flip,clamped:a.clamped,afterUpdate:g.afterUpdate})}})})},a.loadDataFromFile=function(b,f){f=f||{};var g=b.files[0].name,h=a.model_data,i=h.positionArray,j=i.length,k=f.blend_index||0,l=1-k;a.blendData=a.blendData||[];var m=function(b){BrainBrowser.data(b,function(b){var c=void 0===f.max?b.max:f.max,d=void 0===f.min?b.min:f.min;return b.fileName=g,b.apply_to_shape=f.shape,b.applied=!1,b.values.length<j/4?(alert("Not enough color points to cover vertices - "+b.values.length+" color points for "+j/3+" vertices."),-1):(h.data=b,a.blendData[k]=b,e(d,c,b),a.blendData[l]&&a.blendData[l].applied?(e(a.blendData[l].values.min(),a.blendData[l].values.max(),a.blendData[l]),a.afterLoadData&&a.afterLoadData(null,null,a.blendData,!0),a.blend(.5),a.afterBlendData&&a.afterBlendData(b.rangeMin,b.rangeMax,b)):(a.afterLoadData&&a.afterLoadData(b.rangeMin,b.rangeMax,b),a.updateColors(b,{min:b.rangeMin,max:b.rangeMax,spectrum:a.spectrum,flip:a.flip,clamped:a.clamped,afterUpdate:f.afterUpdate})),b.applied=!0,void 0)})};g.match(/.*.mnc|.*.nii/)?d(g,m):c(b,null,m)},a.blend=function(b){var c,d=a.blendData,e=d.length;for(d[0].alpha=b,d[1].alpha=1-b,c=2;e>c;c++)d[c].alpha=0;a.updateColors(d,{spectrum:a.spectrum,flip:a.flip,clamped:a.clamped,blend:!0})},a.loadSpectrumFromUrl=function(c,d){d=d||{};var e,f=d.afterLoadSpectrum;b(c,d,function(b){e=BrainBrowser.spectrum(b),a.spectrum=e,f&&f(),a.afterLoadSpectrum&&a.afterLoadSpectrum(e),a.model_data&&a.model_data.data&&a.updateColors(a.model_data.data,{min:a.model_data.data.rangeMin,max:a.model_data.data.rangeMax,spectrum:a.spectrum,flip:a.flip,clamped:a.clamped})})},a.loadSpectrumFromFile=function(b){var d,e=a.model_data;c(b,null,function(b){d=BrainBrowser.spectrum(b),a.spectrum=d,a.afterLoadSpectrum&&a.afterLoadSpectrum(d),e.data&&a.updateColors(e.data,{min:e.data.rangeMin,max:e.data.rangeMax,spectrum:a.spectrum,flip:a.flip,clamped:a.clamped})})},a.loadSeriesDataFromFile=function(b){var c,d,e=b.files.length,f=b.files;a.seriesData=new Array(e),a.seriesData.numberFiles=e,f.forEach(function(b,e){c=new FileReader,c.file=b,c.onloadend=function(c){BrainBrowser.data(c.target.result,function(c){a.seriesData[e]=c,a.seriesData[e].fileName=b.name})},c.readAsText(f[d])}),a.setupSeries()},a.rangeChange=function(b,c,d,e){e=e||{};var f=e.afterChange,g=a.model_data.data;g.rangeMin=b,g.rangeMax=c,a.updateColors(g,{min:g.rangeMin,max:g.rangeMax,spectrum:a.spectrum,flip:a.flip,clamped:d,afterUpdate:e.afterUpdate}),f&&f(),a.afterRangeChange&&a.afterRangeChange(b,c)}},BrainBrowser.core.models=function(a){"use strict";function b(b){var d,e,f=a.model;a.model_data=b,d=c(b.left),d.name="left",d.model_num=0,e=c(b.right),e.name="right",e.model_num=1,f.add(d),f.add(e)}function c(a){var b,c,d,e,f,g,i,j,k=a.positionArray,l=a.indexArray,m={},n={};for(c=0,d=k.length;d>c+2;c+=3)h(m,k[c],k[c+1],k[c+2]);for(n.x=m.minX+.5*(m.maxX-m.minX),n.y=m.minY+.5*(m.maxY-m.minY),n.z=m.minY+.5*(m.maxZ-m.minZ),e=new THREE.Geometry,f=e.vertices,c=0,d=k.length;d>c+2;c+=3)f.push(new THREE.Vector3(k[c]-n.x,k[c+1]-n.y,k[c+2]-n.z));for(g=e.faces,c=0,d=l.length;d>c+2;c+=3)b=new THREE.Face3(l[c],l[c+1],l[c+2]),b.vertexColors=[new THREE.Color,new THREE.Color,new THREE.Color],g.push(b);return e.computeFaceNormals(),e.computeVertexNormals(),i=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:16777215,shininess:100,vertexColors:THREE.VertexColors}),j=new THREE.Mesh(e,i),j.centroid=n,j.position.set(n.x,n.y,n.z),j}function d(b,c,d,f){var g=a.model,h=e(b,d);h.name=c,f&&(h.renderDepth=f),g.add(h)}function e(b,c){var d,e,f,g,i,j,k,l,m,n,o,p,q=b,r=[],s=[],t=[],u={},v={},w=q.nitems,x=[];for(a.model_data=q,d=0;w>d;d++){for(i=0===d?0:q.endIndicesArray[d-1],r.push(q.indexArray[i]),j=q.indexArray,k=q.endIndicesArray[d],f=i+1;k-1>f;f++)r.push(j[f]),r.push(j[f]);r.push(j[k-1])}for(p=a.model_data.positionArray,e=0,g=r.length;g>e;e++)h(u,p[3*r[e]],p[3*r[e]+1],p[3*r[e]+2]);if(v.x=u.minX+.5*(u.maxX-u.minX),v.y=u.minY+.5*(u.maxY-u.minY),v.z=u.minY+.5*(u.maxZ-u.minZ),c)s=a.model_data.meshPositionArray,t=a.model_data.meshColorArray;else{for(e=0,g=r.length;g>e;e++)s.push(new THREE.Vector3(p[3*r[e]]-v.x,p[3*r[e]+1]-v.y,p[3*r[e]+2]-v.z));if(4===q.colorArray.length)for(d=0;d<s.length;d++)x.push(.5,.5,.7,1);else for(x=a.model_data.colorArray,e=0,g=r.length;g>e;e++)l=new THREE.Color,l.setRGB(x[4*r[e]],x[4*r[e]+1],x[4*r[e]+2]),t.push(l)}return m=new THREE.Geometry,m.vertices=s,m.colors=t,m.colorsNeedUpdate=!0,n=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors}),o=new THREE.Line(m,n,THREE.LinePieces),o.position.set(v.x,v.y,v.z),o.centroid=v,o}function f(b,c){var d,e,f,h=a.model,i=b,j=i.shapes;if(a.model_data=i,j)for(e=0,f=j.length;f>e;e++)d=g(a.model_data.shapes[e]),d.name=a.model_data.shapes[e].name||c.split(".")[0]+"_"+e,h.add(d);else d=g(a.model_data),d.name=c,h.add(d);a.afterCreate&&a.afterCreate(a.model_data)}function g(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q=a.positionArray,r=a.indexArray,s=a.colorArray,t=!1,u=[],v=a.faces;for(4===s.length&&(t=!0,n=s[0],o=s[1],p=s[2]),u=[],f=new THREE.Geometry,b=0,d=q.length/3;d>b;b++)f.vertices.push(new THREE.Vector3(q[3*b],q[3*b+1],q[3*b+2])),e=new THREE.Color,t?e.setRGB(n,o,p):e.setRGB(s[4*b],s[4*b+1],s[4*b+2]),u.push(e);if(j=f.faces,v&&v.length>0){for(k=v.length,b=0;k>b;b++)if(l=v[b],m=l.length,!(3>m))if(4>=m)3>=m?i=new THREE.Face3(l[0],l[1],l[2]):4===m&&(i=new THREE.Face4(l[0],l[1],l[2],l[3])),i.vertexColors=[u[i.a],u[i.b],u[i.c]],m>3&&(i.vertexColors[3]=u[i.d]),j.push(i);else for(c=1;m>c+1;c++)i=new THREE.Face3(l[0],l[c],l[c+1]),i.vertexColors=[u[i.a],u[i.b],u[i.c]],j.push(i)}else for(b=0;b+2<r.length;b+=3)i=new THREE.Face3(r[b],r[b+1],r[b+2]),i.vertexColors[0]=u[i.a],i.vertexColors[1]=u[i.b],i.vertexColors[2]=u[i.c],f.faces.push(i);return f.computeFaceNormals(),f.computeVertexNormals(),f.colorsNeedUpdate=!0,g=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:16777215,shininess:100,vertexColors:THREE.VertexColors}),h=new THREE.Mesh(f,g)}function h(a,b,c,d){(!a.minX||a.minX>b)&&(a.minX=b),(!a.maxX||a.maxX<b)&&(a.maxX=b),(!a.minY||a.minY>c)&&(a.minY=c),(!a.maxY||a.maxY<c)&&(a.maxY=c),(!a.minZ||a.minZ>d)&&(a.minZ=d),(!a.maxZ||a.maxZ<d)&&(a.maxZ=d)}a.displayObjectFile=function(c,e,g){var h=g||{},i=h.renderDepth,j=h.afterDisplay;"P"===c.objectClass&&81924===c.numberVertices?b(c,i):"P"===c.objectClass?f(c,e,i):"L"===c.objectClass?d(c,e,!1,i):alert("Object file not supported"),a.afterDisplayObject&&a.afterDisplayObject(a.model),j&&j()}},BrainBrowser.core.rendering=function(a){"use strict";function b(a){for(var b=0,c=0;a.offsetParent;)b+=a.offsetTop,c+=a.offsetLeft,a=a.offsetParent;return{top:b,left:c}}function c(b){var d,e,k=a.model;window.requestAnimationFrame(c),i=h||b,h=b,f.update(),g.update(),d=h-i,e=15e-5*d,a.autoRotate.x&&(k.rotation.x+=e),a.autoRotate.y&&(k.rotation.y+=e),a.autoRotate.z&&(k.rotation.z+=e),j.render(l,m)}var d,e,f,g,h,i,j,k,l=new THREE.Scene,m=new THREE.PerspectiveCamera(30,a.view_window.offsetWidth/a.view_window.offsetHeight,.1,5e3);a.model=new THREE.Object3D,l.add(a.model),a.render=function(){var b=a.view_window;d=new THREE.WebGLRenderer({clearColor:8947848,clearAlpha:1,preserveDrawingBuffer:!0}),d.setSize(b.offsetWidth,b.offsetHeight),j=d,k=new THREE.AnaglyphEffect(d),k.setSize(b.offsetWidth,b.offsetHeight),b.appendChild(d.domElement),m.position.z=500,e=new THREE.PointLight(16777215),e.position.set(0,0,500),l.add(e),f=new THREE.TrackballControls(m,b),g=new THREE.TrackballControls(e,b),f.zoomSpeed=2,g.zoomSpeed=2,a.autoRotate={},window.onresize=function(){j.setSize(b.offsetWidth,b.offsetHeight),m.aspect=b.offsetWidth/b.offsetHeight,m.updateProjectionMatrix()},window.onresize(),c()},a.canvasDataURL=function(){return d.domElement.toDataURL()},a.anaglyphEffect=function(){j=k},a.noEffect=function(){j=d},a.setCamera=function(a,b,c){m.position.set(a,b,c)},a.resetView=function(){var b,c,d,e=a.model,h=new THREE.Matrix4;for(h.getInverse(e.matrix),f.reset(),g.reset(),e.applyMatrix(h),c=0,d=a.model.children.length;d>c;c++)b=e.children[c],b.visible=!0,b.centroid?b.position.set(b.centroid.x,b.centroid.y,b.centroid.z):b.position.set(0,0,0),b.rotation.set(0,0,0)},a.clearScreen=function(){for(var b=a.model.children;b.length>0;)a.model.remove(b[0]);a.resetView(),a.afterClearScreen&&a.afterClearScreen()},a.updateClearColor=function(a){d.setClearColorHex(a,1)},a.set_fill_mode_wireframe=function(){for(var b,c=a.model.children,d=0;d<c.length;d++)b=c[d].material,b.wireframe=!0,b.emissive&&b.emissive.setHex(125269879)},a.set_fill_mode_solid=function(){for(var b,c=a.model.children,d=0;d<c.length;d++)b=c[d].material,b.wireframe=!1,b.emissive&&b.emissive.setHex(0)},a.ZoomInOut=function(a){m.fov*=a,m.updateProjectionMatrix()},a.click=function(c,d){var e,f,g,h=a.view_window,i=b(h),j=new THREE.Projector,k=new THREE.Raycaster,l=2*((c.clientX-i.left+window.scrollX)/h.offsetWidth)-1,n=2*-((c.clientY-i.top+window.scrollY)/h.offsetHeight)+1,o=new THREE.Vector3(l,n,1);return j.unprojectVector(o,m),k.set(m.position,o.sub(m.position).normalize()),e=k.intersectObject(a.model,!0),e.length>0?(f=e[0],g={vertex:f.face.a,point:new THREE.Vector3(f.point.x,f.point.y,f.point.z),object:f.object},d(c,g)):!1}},BrainBrowser.plugins.ui=function(a){"use strict";$("body").keydown(function(b){var c=b.which,d={38:function(){a.ZoomInOut(1/1.1)},40:function(){a.ZoomInOut(1.1)},32:function(){a.separateHemispheres()}};return c in d?(d[c](),!1):!0}),$("#clear_color").change(function(b){a.updateClearColor(parseInt($(b.target).val(),16))}),$("#resetview").click(a.setupView),$(".view_button").change(a.setupView),$("[name=hem_view]").change(a.setupView),$("#meshmode").change(function(b){$(b.target).is(":checked")?a.set_fill_mode_wireframe():a.set_fill_mode_solid()}),$("#threedee").change(function(b){$(b.target).is(":checked")?a.anaglyphEffect():a.noEffect()}),$("#openImage").click(function(){function b(){var a=new Image;a.onload=function(){$("<div></div>").append(a).dialog({title:"Screenshot",height:a.height,width:a.width})},a.src=e.toDataURL()}function c(){var a=new Image;a.onload=function(){g.drawImage(a,0,0),b()},a.src=f.toDataURL()}var d=a.view_window,e=document.createElement("canvas"),f=document.getElementById("spectrum-canvas"),g=e.getContext("2d"),h=new Image;e.width=d.offsetWidth,e.height=d.offsetHeight,h.onload=function(){g.drawImage(h,0,0),f?c():b()},h.src=a.canvasDataURL()}),a.getViewParams=function(){return{view:$("[name=hem_view]:checked").val(),left:$("#left_hem_visible").is(":checked"),right:$("#right_hem_visible").is(":checked")}},$("#autorotate-controls").children().change(function(){a.autoRotate.x=$("#autorotateX").is(":checked"),a.autoRotate.y=$("#autorotateY").is(":checked"),a.autoRotate.z=$("#autorotateZ").is(":checked")})},BrainBrowser.modules.views=function(a){"use strict";function b(a){return a*Math.PI/180}a.changeShapeTransparency=function(b,c){var d,e=a.model.getChildByName(b);e&&(d=e.material,d.opacity=c,d.transparent=1===c?!1:!0)},a.setupView=function(){var b=a.getViewParams(),c=b.view+"View";a.resetView(),a.model_data&&2===a.model_data.num_hemispheres&&("function"==typeof a[c]?a[c]():a.superiorView()),a.model.getChildByName("left")&&a.leftHemisphereVisible(b.left),a.model.getChildByName("right")&&a.rightHemisphereVisible(b.right)},a.leftHemisphereVisible=function(b){a.model.getChildByName("left").visible=b},a.rightHemisphereVisible=function(b){a.model.getChildByName("right").visible=b},a.getInfoForVertex=function(b){var c=a.model_data.getVertexInfo(b),d={vertex:c.vertex,point:new THREE.Vector3(c.position_vector[0],c.position_vector[1],c.position_vector[2])};return d},a.medialView=function(){var c=a.model;2===a.model_data.num_hemispheres&&(c.getChildByName("left").position.x-=100,c.getChildByName("left").rotation.z-=b(90),c.getChildByName("right").position.x+=100,c.getChildByName("right").rotation.z+=b(90),c.rotation.x+=b(-90))},a.lateralView=function(){var c,d,e=a.model;2===a.model_data.num_hemispheres&&(c=e.getChildByName("left"),d=e.getChildByName("right"),c.position.x-=100,c.rotation.z+=b(-90),d.position.x+=100,d.rotation.z+=b(90),e.rotation.x+=b(90),e.rotation.y+=b(180))},a.superiorView=function(){},a.inferiorView=function(){a.model.rotation.y+=b(180)},a.anteriorView=function(){a.resetView(),a.model.rotation.x+=b(-90),a.model.rotation.z+=b(180)},a.posteriorView=function(){a.resetView(),a.model.rotation.x+=b(-90)},a.separateHemispheres=function(){2===a.model_data.num_hemispheres&&(a.model.children[0].position.x-=1,a.model.children[1].position.x+=1)}},function(){"use strict";function a(a,b){var c={};return c.path=b?function(){return a}:function(b,c){var d="ICBM152_"+c.sk,e="ICBM152_"+c.modality+"_MACACC_"+("CT"===c.modality?"mean":"size"),f="T"===c.statistic?"T_map/T_":"P1"===c.statistic?"RTF_C_map/RTF_C_":"P2"===c.statistic?"RTF_V_map/RTF_V_":"";return(a||"/data/")+e+"/"+d+"/"+f+b+".txt"},c.getData=function(a,d,e){var f="aal_atlas"===a?"/assets/aal_atlas.txt":c.path(a,d),g=b?{vertex:a,modality:d.modality,sk:d.sk,statistic:d.statistic}:{};$.ajax({type:"GET",url:f,data:g,dataType:"text",success:function(a){BrainBrowser.data(a,function(a){c.current_data=a,e(c)})},error:function(){alert("Error loading map")}})},c}var b=window.MACACC={};b.collection=function(b,c,d){function e(){f.vertex&&(f.beforeUpdateMap&&f.beforeUpdateMap(),f.dataset.getData(f.vertex,f.getDataControls(),f.updateMap))}var f={brainbrowser:b,dataset:a(c,d)};return f.pickClick=function(a,c){f.vertex=c.vertex,c.object&&c.object.model_num&&(f.vertex+=c.object.model_num*c.object.geometry.vertices.length),f.vertex&&(e(),f.afterVertexUpdate&&f.afterVertexUpdate(c,0),b.secondWindow&&b.secondWindow.postMessage(f.vertex,"*"))},f.updateMap=function(a,c){a=a||f.dataset,c=c||f.dataOptions&&f.dataOptions()||{};var d,e,g=c.flip,h=c.clamped,i=c.fix_range,j=parseFloat(c.data_range_min),k=parseFloat(c.data_range_max),l=f.getDataControls().statistic;return a?(f.dataArray=a.current_data.values,i?(f.data_min=isFinite(j)?j:a.current_data.min,f.data_max=isFinite(k)?k:a.current_data.max):"T"===l&&(f.data_min=a.current_data.min,f.data_max=a.current_data.max),"T"===l?(d=f.data_min,e=f.data_max):(g=!g,d=0,e=1),f.flipRange=g,b.updateColors(f.dataset.current_data,{min:d,max:e,spectrum:b.spectrum,flip:g,clamped:h}),f.afterUpdateModel&&f.afterUpdateModel(l),void 0):(f.afterInvalidMap&&f.afterInvalidMap(),void 0)},f.changeModel=function(a,c){c.format="MNIObject",b.clearScreen(),b.loadModelFromUrl("/data/surfaces/surf_reg_model_both_"+a+".obj",c)},f.rangeChange=function(a){a=a||f.dataOptions&&f.dataOptions()||{};var b=parseFloat(a.data_range_min),c=parseFloat(a.data_range_max);f.beforeRangeChange&&f.beforeRangeChange(b,c),f.updateMap(),f.afterRangeChange&&f.afterRangeChange(b,c)},f.flipXCoordinate=function(){f.dataArray&&(f.vertex>f.dataArray.length/2?f.vertex-=f.dataArray.length/2:f.vertex+=f.dataArray.length/2,f.afterVertexUpdate&&f.afterVertexUpdate(b.getInfoForVertex(f.vertex),0),e())},f.dataControlChange=function(){var a=f.getDataControls();"AAL"===a.modality?(f.beforeUpdateMap&&f.beforeUpdateMap(),f.showAtlas()):e()},f.valueAtPoint=function(a,b){var c=f.dataArray?f.dataArray[b.vertex]:0;f.afterVertexUpdate&&f.afterVertexUpdate(b,c)},f.showAtlas=function(){b.loadDataFromUrl("/assets/aal_atlas.txt")},f.getDataControls=function(){return{modality:"",sk:"",statistic:""}},b.loadSpectrumFromUrl("/assets/spectral_spectrum.txt"),b.valueAtPointCallback=f.valueAtPoint,b.clickCallback=f.pickClick,f}}(),function(){"use strict";window.utils={webglEnabled:function(){try{return!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(a){return!1}},webWorkersEnabled:function(){return!!window.Worker},webGLErrorMessage:function(){var a,b='BrainBrowser requires <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>.<br/>';return b+=window.WebGLRenderingContext?"Your browser seems to support it, but it is <br/> disabled or unavailable.<br/>":"Your browser does not seem to support it.<br/>",b+='Test your browser\'s WebGL support <a href="http://get.webgl.org/">here</a>.',a=document.createElement("div"),a.id="webgl-error",a.innerHTML=b,a},isFunction:function(a){return a instanceof Function||"function"==typeof a},drawDot:function(a,b,c,d){var e=new THREE.SphereGeometry(2),f=new THREE.MeshBasicMaterial({color:16711680}),g=new THREE.Mesh(e,f);g.position.set(b,c,d),a.add(g)}}}(),$(function(){"use strict";var a,b="/data/",c=$("#loading"),d=function(){c.show()},e=function(){c.hide()};return utils.webglEnabled()?(c.show(),BrainBrowser.start(function(c){c.afterLoadSpectrum=function(a){var b=a.createSpectrumCanvasWithScale(0,5,null,!1);b.id="spectrum-canvas",$("#spectrum").html($(b)),c.spectrumObj=a},c.loadModelFromUrl("/models/surf_reg_model_both.obj",{format:"MNIObject",afterDisplay:function(){e(),a=MACACC.collection(c,b),c.afterCreateBrain=function(){a.updateMap()},c.afterUpdateColors=e,a.dataOptions=function(){return{flip:$("#flip_range").is(":checked"),clamped:$("#clamp_range").is(":checked"),fix_range:$("#fix_range").is(":checked"),data_range_min:parseFloat($("#data-range-min").val()),data_range_max:parseFloat($("#data-range-max").val())}},a.afterUpdateModel=function(a){"T"!==a&&($("#range-slider").slider("option","min","0"),$("#range-slider").slider("option","max","1"))},a.afterVertexUpdate=function(a,b){var c=a.vertex;void 0!==c&&void 0!==b&&($("#x-coord").val(a.point.x),$("#y-coord").val(a.point.y),$("#z-coord").val(a.point.z),$("#v-coord").val(c),$("#value-coord").val(b))},a.beforeUpdateMap=d,a.beforeRangeChange=d,a.afterInvalidMap=e,a.afterRangeChange=function(b,d){var e=c.spectrumObj.createSpectrumCanvasWithScale(b,d,null,a.flipRange);e.id="spectrum-canvas",$("#spectrum").html($(e))},a.getDataControls=function(){var a=$("[name=modality]:checked").val(),b=$("#data-sk").val(),c=$("[name=statistic]:checked").val();return{modality:a,sk:b,statistic:c}},$(".data_controls").change(a.dataControlChange),$("#x-coord-flip").click(a.flipXCoordinate),$("#model").change(function(b){d(),a.changeModel($(b.target).val(),{afterDisplay:e})})}}),$("#range-slider").slider({range:!0,min:-10,max:15,values:[0,5],slide:function(a,b){$("#data-range-min").val(b.values[0]),$("#data-range-max").val(b.values[1])},stop:function(){a.rangeChange()},step:.1}),$(".range-box").keypress(function(b){"13"===b.keyCode&&a.rangeChange()}),$("#data-range-min").change(function(){$("#range-slider").slider("values",0,$(this).val()),a.afterRangeChange(parseFloat($("#data-range-min").val()),parseFloat($("#data-range-max").val()))}),$("#data-range-max").change(function(){$("#range-slider").slider("values",1,$(this).val()),a.afterRangeChange(parseFloat($("#data-range-min").val()),parseFloat($("#data-range-max").val()))}),$("#screenshot").click(function(){$(this).attr("href",c.client.toDataUR())}),$("#brainbrowser").mousedown(function(a){var b=$("[name=pointer]:checked").val();a.ctrlKey||"check"===b?c.valueAtPointCallback&&c.click(a,c.valueAtPointCallback):(a.shiftKey||"select"===b)&&c.clickCallback&&c.click(a,c.clickCallback)}),$("#flip_range").change(function(){d(),a.updateMap()}),$("#clamp_range").change(function(){d(),a.updateMap()}),$("#flip_correlation").click(function(){var a=-1*parseFloat($("#data-range-max").val()),b=-1*parseFloat($("#data-range-min").val());$("#data-range-min").val(a).change(),$("#data-range-max").val(b).change(),$("#flip_range").attr("checked",!$("#flip_range").is(":checked")).change()}),$("#secondWindow").click(function(){c.secondWindow=window.open("/macacc.html","secondWindow")}),window.addEventListener("message",function(b){var d=parseInt(b.data,10),e=[c.model_data.positionArray[3*d],c.model_data.positionArray[3*d+1],c.model_data.positionArray[3*d+2]];a.pickClick(b,{position_vector:e,vertex:d,stop:!0})},!1),window.opener&&(c.secondWindow=window.opener)}),void 0):($("#brainbrowser").html(utils.webGLErrorMessage()),void 0)});