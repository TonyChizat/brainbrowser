/*
 * Copyright (C) 2011 McGill University
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 *   the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

/* brainbrowser v0.9.3 */
!function(){"use strict";function a(a,b){var c={};return c.path=b?function(){return a}:function(b,c){var d="ICBM152_"+c.sk,e="ICBM152_"+c.modality+"_MACACC_"+("CT"===c.modality?"mean":"size"),f="T"===c.statistic?"T_map/T_":"P1"===c.statistic?"RTF_C_map/RTF_C_":"P2"===c.statistic?"RTF_V_map/RTF_V_":"";return(a||"/data/")+e+"/"+d+"/"+f+b+".txt"},c.getData=function(a,d,e){var f="aal_atlas"===a?"/assets/aal_atlas.txt":c.path(a,d),g=b?{vertex:a,modality:d.modality,sk:d.sk,statistic:d.statistic}:{};$.ajax({type:"GET",url:f,data:g,dataType:"text",success:function(a){BrainBrowser.SurfaceViewer.data(a,function(a){c.current_data=a,e(c)})},error:function(){alert("Error loading map")}})},c}var b=window.MACACC={};b.collection=function(b,c,d){function e(){f.vertex&&(f.beforeUpdateMap&&f.beforeUpdateMap(),f.dataset.getData(f.vertex,f.getDataControls(),f.updateMap))}var f={viewer:b,dataset:a(c,d)};return f.pickClick=function(a,c){f.vertex=c.vertex,c.object&&c.object.model_num&&(f.vertex+=c.object.model_num*c.object.geometry.vertices.length),f.vertex&&(e(),f.afterVertexUpdate&&f.afterVertexUpdate(c,0),b.secondWindow&&b.secondWindow.postMessage(f.vertex,"*"))},f.updateMap=function(a,c){a=a||f.dataset,c=c||f.dataOptions&&f.dataOptions()||{};var d,e,g=c.flip,h=c.clamped,i=c.fix_range,j=parseFloat(c.data_range_min),k=parseFloat(c.data_range_max),l=f.getDataControls().statistic;return a?(f.dataArray=a.current_data.values,i?(f.data_min=isFinite(j)?j:a.current_data.min,f.data_max=isFinite(k)?k:a.current_data.max):"T"===l&&(f.data_min=a.current_data.min,f.data_max=a.current_data.max),"T"===l?(d=f.data_min,e=f.data_max):(g=!g,d=0,e=1),f.flipRange=g,b.updateColors(f.dataset.current_data,{min:d,max:e,spectrum:b.spectrum,flip:g,clamped:h}),f.afterUpdateModel&&f.afterUpdateModel(l),void 0):(f.afterInvalidMap&&f.afterInvalidMap(),void 0)},f.changeModel=function(a,c){c.format="MNIObject",b.clearScreen(),b.loadModelFromUrl("/data/surfaces/surf_reg_model_both_"+a+".obj",c)},f.rangeChange=function(a){a=a||f.dataOptions&&f.dataOptions()||{};var b=parseFloat(a.data_range_min),c=parseFloat(a.data_range_max);f.beforeRangeChange&&f.beforeRangeChange(b,c),f.updateMap(),f.afterRangeChange&&f.afterRangeChange(b,c)},f.flipXCoordinate=function(){f.dataArray&&(f.vertex>f.dataArray.length/2?f.vertex-=f.dataArray.length/2:f.vertex+=f.dataArray.length/2,f.afterVertexUpdate&&f.afterVertexUpdate(b.getInfoForVertex(f.vertex),0),e())},f.dataControlChange=function(){var a=f.getDataControls();"AAL"===a.modality?(f.beforeUpdateMap&&f.beforeUpdateMap(),f.showAtlas()):e()},f.valueAtPoint=function(a,b){var c=f.dataArray?f.dataArray[b.vertex]:0;f.afterVertexUpdate&&f.afterVertexUpdate(b,c)},f.showAtlas=function(){b.loadDataFromUrl("/assets/aal_atlas.txt")},f.getDataControls=function(){return{modality:"",sk:"",statistic:""}},b.loadSpectrumFromUrl("/assets/spectral_spectrum.txt"),b.valueAtPointCallback=f.valueAtPoint,b.clickCallback=f.pickClick,f}}(),$(function(){"use strict";var a,b="/data/",c=$("#loading"),d=function(){c.show()},e=function(){c.hide()};return BrainBrowser.utils.webglEnabled()?(c.show(),BrainBrowser.SurfaceViewer.start("brainbrowser",function(c){c.addEventListener("loadspectrum",function(a){var b=a.createSpectrumCanvasWithScale(0,5,null,!1);b.id="spectrum-canvas",$("#spectrum").html($(b)),c.spectrumObj=a}),c.loadModelFromUrl("/models/surf_reg_model_both.obj",{format:"MNIObject",afterDisplay:function(){e(),a=MACACC.collection(c,b),c.addEventListener("updatecolors",e),a.dataOptions=function(){return{flip:$("#flip_range").is(":checked"),clamped:$("#clamp_range").is(":checked"),fix_range:$("#fix_range").is(":checked"),data_range_min:parseFloat($("#data-range-min").val()),data_range_max:parseFloat($("#data-range-max").val())}},a.afterUpdateModel=function(a){"T"!==a&&($("#range-slider").slider("option","min","0"),$("#range-slider").slider("option","max","1"))},a.afterVertexUpdate=function(a,b){var c=a.vertex;void 0!==c&&void 0!==b&&($("#x-coord").val(a.point.x),$("#y-coord").val(a.point.y),$("#z-coord").val(a.point.z),$("#v-coord").val(c),$("#value-coord").val(b))},a.beforeUpdateMap=d,a.beforeRangeChange=d,a.afterInvalidMap=e,a.afterRangeChange=function(b,d){var e=c.spectrumObj.createSpectrumCanvasWithScale(b,d,null,a.flipRange);e.id="spectrum-canvas",$("#spectrum").html($(e))},a.getDataControls=function(){var a=$("[name=modality]:checked").val(),b=$("#data-sk").val(),c=$("[name=statistic]:checked").val();return{modality:a,sk:b,statistic:c}},$(".data_controls").change(a.dataControlChange),$("#x-coord-flip").click(a.flipXCoordinate),$("#model").change(function(b){d(),a.changeModel($(b.target).val(),{afterDisplay:e})})}}),$("#range-slider").slider({range:!0,min:-10,max:15,values:[0,5],slide:function(a,b){$("#data-range-min").val(b.values[0]),$("#data-range-max").val(b.values[1])},stop:function(){a.rangeChange()},step:.1}),$(".range-box").keypress(function(b){"13"===b.keyCode&&a.rangeChange()}),$("#data-range-min").change(function(){$("#range-slider").slider("values",0,$(this).val()),a.afterRangeChange(parseFloat($("#data-range-min").val()),parseFloat($("#data-range-max").val()))}),$("#data-range-max").change(function(){$("#range-slider").slider("values",1,$(this).val()),a.afterRangeChange(parseFloat($("#data-range-min").val()),parseFloat($("#data-range-max").val()))}),$("#screenshot").click(function(){$(this).attr("href",c.client.toDataUR())}),$("#brainbrowser").mousedown(function(a){var b=$("[name=pointer]:checked").val();a.ctrlKey||"check"===b?c.valueAtPointCallback&&c.click(a,c.valueAtPointCallback):(a.shiftKey||"select"===b)&&c.clickCallback&&c.click(a,c.clickCallback)}),$("#flip_range").change(function(){d(),a.updateMap()}),$("#clamp_range").change(function(){d(),a.updateMap()}),$("#flip_correlation").click(function(){var a=-1*parseFloat($("#data-range-max").val()),b=-1*parseFloat($("#data-range-min").val());$("#data-range-min").val(a).change(),$("#data-range-max").val(b).change(),$("#flip_range").attr("checked",!$("#flip_range").is(":checked")).change()}),$("#secondWindow").click(function(){c.secondWindow=window.open("/macacc.html","secondWindow")}),window.addEventListener("message",function(b){var d=parseInt(b.data,10),e=[c.model_data.positionArray[3*d],c.model_data.positionArray[3*d+1],c.model_data.positionArray[3*d+2]];a.pickClick(b,{position_vector:e,vertex:d,stop:!0})},!1),window.opener&&(c.secondWindow=window.opener)}),void 0):($("#brainbrowser").html(BrainBrowser.utils.webGLErrorMessage()),void 0)});