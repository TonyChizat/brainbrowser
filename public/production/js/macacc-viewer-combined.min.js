/*
* BrainBrowser: Web-based Neurological Visualization Tools
* (https://brainbrowser.cbrain.mcgill.ca)
*
* Copyright (C) 2011 McGill University 
*
* This program is free software: you can redistribute it and/or modify
* it under the terms of the GNU Affero General Public License as
* published by the Free Software Foundation, either version 3 of the
* License, or (at your option) any later version.
*
* This program is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
* GNU Affero General Public License for more details.
*
* You should have received a copy of the GNU Affero General Public License
* along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

/*
* BrainBrowser v1.5.1
*
* Author: Tarek Sherif  <tsherif@gmail.com> (http://tareksherif.ca/)
* Author: Nicolas Kassis
*/
!function(){"use strict";function a(a,b){var c={};return c.path=b?function(){return a}:function(b,c){var d="ICBM152_"+c.sk,e="ICBM152_"+c.modality+"_MACACC_"+("CT"===c.modality?"mean":"size"),f="T"===c.statistic?"T_map/T_":"P1"===c.statistic?"RTF_C_map/RTF_C_":"P2"===c.statistic?"RTF_V_map/RTF_V_":"";return(a||"/data/")+e+"/"+d+"/"+f+b+".txt"},c.getData=function(a,d,e){var f="aal_atlas"===a?"/assets/aal_atlas.txt":c.path(a,d),g=b?{vertex:a,modality:d.modality,sk:d.sk,statistic:d.statistic}:{};$.ajax({type:"GET",url:f,data:g,dataType:"text",success:function(a){BrainBrowser.SurfaceViewer.parseIntensityData(a,function(a){c.current_data=a,e(c)})},error:function(){alert("Error loading map")}})},c}var b=window.MACACC={};b.collection=function(b,c,d){function e(){f.vertex&&(f.beforeUpdateMap&&f.beforeUpdateMap(),f.dataset.getData(f.vertex,f.getDataControls(),f.updateMap))}var f={viewer:b,dataset:a(c,d)};f.pick=function(a){a&&(f.vertex=a.index,f.vertex&&(e(),f.afterVertexUpdate&&f.afterVertexUpdate(a,0),b.secondWindow&&b.secondWindow.postMessage(f.vertex,"*")))},f.valueAtPoint=function(a){if(a){var b=f.dataArray?f.dataArray[a.index]:0;f.afterVertexUpdate&&f.afterVertexUpdate(a,b)}},f.updateMap=function(a,c){a=a||f.dataset,c=c||f.dataOptions&&f.dataOptions()||{};var d,e,g=c.flip,h=c.clamped,i=c.fix_range,j=parseFloat(c.data_range_min),k=parseFloat(c.data_range_max),l=f.getDataControls().statistic;return a?(f.dataArray=a.current_data.values,i?(f.data_min=isFinite(j)?j:a.current_data.min,f.data_max=isFinite(k)?k:a.current_data.max):"T"===l&&(f.data_min=a.current_data.min,f.data_max=a.current_data.max),"T"===l?(d=f.data_min,e=f.data_max):(g=!g,d=0,e=1),f.flipRange=g,b.setAttribute("clamp_colors",h),b.setAttribute("flip_colors",g),f.dataset.current_data.range_min=d,f.dataset.current_data.range_max=e,b.updateColors(f.dataset.current_data),f.afterUpdateMap&&f.afterUpdateMap(l),void 0):(f.afterInvalidMap&&f.afterInvalidMap(),void 0)},f.changeModel=function(a,c){b.clearScreen(),b.loadModelFromURL("/data/surfaces/surf_reg_model_both_"+a+".obj",c)};var g=null;return f.setIntensityRange=function(a){null===g&&(g=setTimeout(function(){a=a||f.dataOptions&&f.dataOptions()||{};var b=parseFloat(a.data_range_min),c=parseFloat(a.data_range_max);f.beforeRangeChange&&f.beforeRangeChange(b,c),f.updateMap(),f.afterRangeChange&&f.afterRangeChange(b,c),g=null},0))},f.flipXCoordinate=function(){f.dataArray&&(f.vertex>f.dataArray.length/2?f.vertex-=f.dataArray.length/2:f.vertex+=f.dataArray.length/2,f.afterVertexUpdate&&f.afterVertexUpdate(b.getVertexInfo(f.vertex),0),e())},f.dataControlChange=function(){var a=f.getDataControls();"AAL"===a.modality?(f.beforeUpdateMap&&f.beforeUpdateMap(),f.showAtlas()):e()},f.showAtlas=function(){b.loadIntensityDataFromURL("/assets/aal_atlas.txt")},f.getDataControls=function(){return{modality:"",sk:"",statistic:""}},b.loadColorMapFromURL(BrainBrowser.config.surface_viewer.color_maps[0].url),f}}(),$(function(){"use strict";function a(){e.show()}function b(){e.hide()}var c,d="/data/",e=$("#loading");return BrainBrowser.utils.webglEnabled()?(e.show(),BrainBrowser.SurfaceViewer.start("brainbrowser",function(e){e.addEffect("AnaglyphEffect"),e.addEventListener("loadcolormap",function(a){var b=a.createCanvasWithScale(0,5);b.id="spectrum-canvas",$("#spectrum").html($(b))}),e.render(),e.loadModelFromURL("/models/surf_reg_model_both.obj",{format:"mniobj",parse:{split:!0},complete:function(){b(),c=MACACC.collection(e,d),c.dataOptions=function(){return{flip:$("#flip_range").is(":checked"),clamped:$("#clamp_range").is(":checked"),fix_range:$("#fix_range").is(":checked"),data_range_min:parseFloat($("#data-range-min").val()),data_range_max:parseFloat($("#data-range-max").val())}},c.afterUpdateMap=function(a){b(),"T"!==a&&($("#range-slider").slider("option","min","0"),$("#range-slider").slider("option","max","1"))},c.afterVertexUpdate=function(a,b){var c=a.index;void 0!==c&&void 0!==b&&($("#x-coord").val(a.point.x),$("#y-coord").val(a.point.y),$("#z-coord").val(a.point.z),$("#v-coord").val(c),$("#value-coord").val(b))},c.beforeUpdateMap=a,c.afterInvalidMap=b,c.afterRangeChange=function(a,b){var d=e.color_map.createCanvasWithScale(a,b,c.flipRange);d.id="spectrum-canvas",$("#spectrum").html($(d))},c.getDataControls=function(){var a=$("[name=modality]:checked").val(),b=$("#data-sk").val(),c=$("[name=statistic]:checked").val();return{modality:a,sk:b,statistic:c}},$(".data_controls").change(c.dataControlChange),$("#x-coord-flip").click(c.flipXCoordinate),$("#model").change(function(d){a(),c.changeModel($(d.target).val(),{complete:b,format:"mniobj",parse:{split:!0}})})}}),$("body").keydown(function(a){var b=a.keyCode,c={32:function(){e.separateHalves()},38:function(){e.zoom(1.1)},40:function(){e.zoom(1/1.1)}};return c.hasOwnProperty(b)?(c[b](),!1):void 0}),$("#clear_color").change(function(a){e.setClearColor(parseInt($(a.target).val(),16))}),$("#resetview").click(function(){e.setView($("[name=hem_view]:checked").val())}),$(".visibility").change(function(){var a=$(this),b=a.data("hemisphere"),c=e.model.getObjectByName(b);c&&(c.wireframe_active&&(c=c.getObjectByName("__wireframe__")||c),c.visible=a.is(":checked"))}),$("[name=hem_view]").change(function(){e.setView($("[name=hem_view]:checked").val())}),$("#meshmode").change(function(){e.setWireframe($(this).is(":checked"))}),$("#threedee").change(function(){e.setEffect($(this).is(":checked")?"AnaglyphEffect":"None")}),$("#openImage").click(function(){function a(){var a=new Image;a.onload=function(){$("<div></div>").append(a).dialog({title:"Screenshot",height:a.height,width:a.width})},a.src=d.toDataURL()}function b(){var b=new Image;b.onload=function(){g.drawImage(b,0,0),a()},b.src=f.toDataURL()}var c=e.view_window,d=document.createElement("canvas"),f=document.getElementById("spectrum-canvas"),g=d.getContext("2d"),h=new Image;d.width=c.offsetWidth,d.height=c.offsetHeight,h.onload=function(){g.drawImage(h,0,0),$(f).is(":visible")?b():a()},h.src=e.canvasDataURL()}),$("#autorotate-controls").children().change(function(){e.autorotate.x=$("#autorotateX").is(":checked"),e.autorotate.y=$("#autorotateY").is(":checked"),e.autorotate.z=$("#autorotateZ").is(":checked")}),$("#range-slider").slider({range:!0,min:-10,max:15,values:[0,5],slide:function(a,b){$("#data-range-min").val(b.values[0]),$("#data-range-max").val(b.values[1]),c.setIntensityRange()},step:.1}),$(".range-box").keypress(function(a){"13"===a.keyCode&&c.setIntensityRange()}),$("#data-range-min").change(function(){$("#range-slider").slider("values",0,$(this).val()),c.afterRangeChange(parseFloat($("#data-range-min").val()),parseFloat($("#data-range-max").val()))}),$("#data-range-max").change(function(){$("#range-slider").slider("values",1,$(this).val()),c.afterRangeChange(parseFloat($("#data-range-min").val()),parseFloat($("#data-range-max").val()))}),$("#screenshot").click(function(){$(this).attr("href",e.client.toDataUR())}),$("#brainbrowser").mousedown(function(a){var b=e.view_window,d=$("[name=pointer]:checked").val(),f=BrainBrowser.utils.getOffset(b),g=a.clientX-f.left+window.scrollX,h=a.clientY-f.top+window.scrollY;a.ctrlKey||"check"===d?c.valueAtPoint(e.pick(g,h)):(a.shiftKey||"select"===d)&&c.pick(e.pick(g,h))}),$("#flip_range").change(function(){a(),c.updateMap()}),$("#clamp_range").change(function(){a(),c.updateMap()}),$("#flip_correlation").click(function(){var a=-1*parseFloat($("#data-range-max").val()),b=-1*parseFloat($("#data-range-min").val());$("#data-range-min").val(a).change(),$("#data-range-max").val(b).change(),$("#flip_range").attr("checked",!$("#flip_range").is(":checked")).change()}),$("#secondWindow").click(function(){e.secondWindow=window.open("/macacc.html","secondWindow")}),window.addEventListener("message",function(a){var b=parseInt(a.data,10),d=[e.model_data.vertices[3*b],e.model_data.vertices[3*b+1],e.model_data.vertices[3*b+2]];c.pickClick(a,{position_vector:d,vertex:b,stop:!0})},!1),window.opener&&(e.secondWindow=window.opener)}),void 0):($("#brainbrowser").html(BrainBrowser.utils.webGLErrorMessage()),void 0)});