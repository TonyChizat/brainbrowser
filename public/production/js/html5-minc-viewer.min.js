/*
 * Copyright (C) 2011 McGill University
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 *   the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

/* brainbrowser v1.0.0 */
!function(){"use strict";var a=window.BrainCanvas={};a.utilities={},a.volumeType={},a.colorScales=[],a.event_listeners={},a.addEventListener=function(b,c){a.event_listeners[b]||(a.event_listeners[b]=[]),a.event_listeners[b].push(c)},a.triggerEvent=function(b){a.event_listeners[b]&&a.event_listeners[b].forEach(function(a){a()})},a.globalUIControls=function(a,b){var c=document.createElement("div");c.id="global-controls",c.classList.add("braincanvas-controls");var d=document.createElement("input");d.type="checkbox",d.addEventListener("change",function(a){b.synced=a.target.checked},!1);var e=document.createElement("span");e.classList.add("control-heading"),e.innerHTML="Sync Volumes ",e.appendChild(d),c.appendChild(e),a.appendChild(c)},a.viewer=function(b,c){function d(b,c){if(g=document.getElementById(b),h=document.createElement("div"),h.id="braincanvas",c||(c={}),c.horizontal&&(i=!0),c.multi){var d=0,e=c.volumes,f=c.volumes.length;o=!0,a.loader.loadColorScaleFromUrl("/color_scales/spectral.txt","Spectral",function(b){b.cross_hair_color="#FFFFFF",m.defaultScale=b,a.colorScales[0]=b,function c(){f>d?(m.openVolume(e[d],c),d++):m.openVolume({volumes:m.volumes,type:"multiVolume"},r)}()}),a.loader.loadColorScaleFromUrl("/color_scales/thermal.txt","Thermal",function(b){b.cross_hair_color="#FFFFFF",a.colorScales[1]=b}),a.loader.loadColorScaleFromUrl("/color_scales/gray_scale.txt","Gray",function(b){a.colorScales[2]=b}),a.loader.loadColorScaleFromUrl("/color_scales/blue.txt","Blue",function(b){b.cross_hair_color="#FFFFFF",a.colorScales[3]=b}),a.loader.loadColorScaleFromUrl("/color_scales/green.txt","Green",function(b){a.colorScales[4]=b})}else c.volume&&m.openVolume(c.volume,r)}function e(a,b,c){var d=a.data,e=a.width,f=a.height,g=document.createElement("canvas").getContext("2d");if(e===b&&f===c)return a;for(var h=4,i=g.createImageData(b,c),j=i.data,k=e/b,l=f/c,m=0;c>m;m++)for(var n=0;b>n;n++)for(var o=Math.floor(n*k),p=Math.floor(m*l),q=0;h>q;q++)j[Math.floor(m*b+n)*h+q]=d[Math.floor(p*e+o)*h+q];return i}function f(a,b){var c=a.length;if(c>1){for(var d=b.data,e=b.width,f=b.height,g=[],h=0;f>h;h+=1)for(var i=0;e>i;i+=1)for(var j=0;c>j;j+=1){g[j]=g[j]||0;var k=a[j];if(h<k.height&&i<k.width){var l=4*(h*e+i),m=(d[l+3]||0)/255,n=g[j];d[l]=(d[l+0]||0)*m+k.data[n+0]*(k.data[n+3]/255),d[l+1]=(d[l+1]||0)*m+k.data[n+1]*(k.data[n+3]/255),d[l+2]=(d[l+2]||0)*m+k.data[n+2]*(k.data[n+3]/255),d[l+3]=(d[l+3]||0)+k.data[n+3],g[j]+=4}}for(h=3;h<d.length;h+=4)d[h]=255;return b}return a[0]}var g,h,i,j,k,l,m={},n=[],o=!1,p=[],q={xspace:0,yspace:1,zspace:2};m.volumes=n,m.displays=[],m.synced=!1,m.default_zoom_level=1;var r=function(){var b,c,d,e,f;for(m.vols=[],l=n.length,k=300,j=300,a.setupUI(m),b=0;l>b;b++){for(c=document.createElement("div"),d=n[b],e=[],c.classList.add("volume-container"),h.appendChild(c),m.displays.push(a.addCanvasUI(c,m,n[b],b)),p[b]=[],d.position.xspace=d.header.xspace.space_length/2,d.position.yspace=d.header.yspace.space_length/2,d.position.zspace=d.header.zspace.space_length/2,e.push(d.getScaledSlice("xspace",parseInt(d.header.xspace.space_length/2,10),m.default_zoom_level)),e.push(d.getScaledSlice("yspace",parseInt(d.header.yspace.space_length/2,10),m.default_zoom_level)),e.push(d.getScaledSlice("zspace",parseInt(d.header.zspace.space_length/2,10),m.default_zoom_level)),f=0;3>f;f++)e[f].volID=b,e[f].sliceNum=f,e[f].startx=0,e[f].starty=0,e[f].min=d.min,e[f].max=d.max;m.vols.push(e),m.updateVolume(b,e)}a.globalUIControls&&(a.volumeUIControls.defer_until_page_load?a.addEventListener("ready",function(){a.globalUIControls(h,m)}):a.globalUIControls(h,m)),g.appendChild(h),a.triggerEvent("ready"),a.triggerEvent("sliceupdate"),m.draw()};m.openVolume=function(b,c){var d=a.volumeType[b.type];if(!d)throw new Error("Unsuported Volume Type");b=d(b,c),b.position={},n.push(b)},m.updateSlices=function(b,c,d){var e,f=n[b],g=q[c],h=m.displays[b][g],i=h.zoom;void 0===d&&(d=f.position[c]),e=f.getScaledSlice(c,d,i),e.volID=b,e.sliceNum=g,f.position[c]=d,e.startx=0,e.starty=0,e.min=f.min,e.max=f.max,m.updateSlice(b,e.sliceNum,null,null,e),a.triggerEvent("sliceupdate"),m.draw()},m.updateSlice=function(a,b,c,d,g){var h,i,j,k,l,o=0,q=g.length,r=[],s=g.x,t=g.y,u=document.createElement("canvas").getContext("2d"),v=p[a][b]||{x:c,y:d,widthSpace:s,heightSpace:t};for(o=0;q>o;o++){h=g[o];var w=h.colorScale,x=u.createImageData(h.width,h.height);w.colorizeArray(h.data,h.min,h.max,!0,0,1,h.alpha,x.data);var y=Math.abs(h.x.step),z=Math.abs(h.y.step);x=e(x,Math.floor(h.width*y),Math.floor(h.height*z)),r.push(x)}i=Math.max.apply(null,r.map(function(a){return a.width})),j=Math.max.apply(null,r.map(function(a){return a.height})),k=u.createImageData(i,j),k=f(r,k),v.image=k,p[a][b]=v,l=m.displays[a][b],l.slice=p[a][b],l.updateCursor(n[a])},m.updateVolume=function(a,b){var c,d;for(c=0;3>c;c++)d=b[c],m.updateSlice(a,c,d.startx,d.starty,d)},m.redrawVolume=function(a){m.updateSlices(a,"xspace",n[a].position.xspace),m.updateSlices(a,"yspace",n[a].position.yspace),m.updateSlices(a,"zspace",n[a].position.zspace)},m.redrawVolumes=function(){for(var a=0;a<n.length;a++)m.redrawVolume(a)},m.draw=function(){var a,b,c,d,e,f=4,g=f/2;n.forEach(function(h,i){m.displays[i].forEach(function(j,k){c=j.canvas,b=j.context,d=j.zoom,h=n[i],b.globalAlpha=255,b.clearRect(0,0,c.width,c.height),a=p[i][k],a&&(e=h.colorScale||m.defaultScale,j.drawSlice(b,a),j.drawCrosshair(b,e.cross_hair_color,d)),c===m.active_canvas&&(b.save(),b.strokeStyle="#EC2121",b.lineWidth=f,b.strokeRect(g,g,c.width-f,c.height-f),b.restore())})})},m.getSlices=function(a,b,c){var d,e,f=p[b][c],g=m.displays[b][c],h=g.getImageOrigin(),i=g.zoom;g.cursor.x=a.x,g.cursor.y=a.y,a?(d=Math.floor((a.x-h.x)/i),e=Math.floor(f.heightSpace.space_length-(a.y-h.y)/i)):(d=null,e=null),m.updateSlices(b,f.widthSpace.name,d),m.updateSlices(b,f.heightSpace.name,e)},d(b,c)}}(),function(){"use strict";function a(a,b,c,d){var e=document.createElement("canvas");jQuery(e).attr("width",256),jQuery(e).attr("height",c);for(var f=new Array(256),g=0;256>g;g++)d?f[255-g]=g:f[g]=g;var h=[];for(g=0;256>g;g++)h.push(g);for(var i=a.colorizeArray(h,0,255,!0,0,1,!1,[]),j=e.getContext("2d"),k=0;256>k;k++)j.fillStyle="rgb("+parseInt(i[4*k],10)+","+parseInt(i[4*k+1],10)+","+parseInt(i[4*k+2],10)+")",j.fillRect(k,0,1,b);return e}BrainCanvas.ColorScale=function(a){function b(a){a=a.replace(/\s+$/,""),a=a.replace(/^\s+/,"");for(var b=a.split(/\n/),d=[],e=0;e<b.length;e++){for(var f=b[e].replace(/\s+$/,"").split(/\s+/),g=0;g<f.length;g++)f[g]=parseFloat(f[g]);f.length<4&&f.push(1),d.push(f)}return c.colors=d,d}if(!(this instanceof BrainCanvas.ColorScale))return new BrainCanvas.ColorScale(a);var c=this;void 0!==a&&b(a)},BrainCanvas.ColorScale.prototype.createColorScaleCanvas=function(){var b=a(this,20,20,!1);return b},BrainCanvas.ColorScale.prototype.createColorScaleCanvasWithScale=function(b,c,d){var e=a(this,20,40,d),f=e.getContext("2d");return f.fillStyle="#FFA000",f.fillRect(.5,20,1,10),f.fillText(b.toPrecision(3),.5,40),f.fillRect(e.width/4,20,1,10),f.fillText(((b+c)/4).toPrecision(3),e.width/4,40),f.fillRect(e.width/2,20,1,10),f.fillText(((b+c)/2).toPrecision(3),e.width/2,40),f.fillRect(3*(e.width/4),20,1,10),f.fillText((3*((b+c)/4)).toPrecision(3),3*(e.width/4),40),f.fillRect(e.width-.5,20,1,10),f.fillText(c.toPrecision(3),e.width-20,40),e},BrainCanvas.ColorScale.prototype.colorizeArray=function(a,b,c,d,e,f,g,h){h||(h=[]);for(var i,j=this.colors,k=1,l=1*j.length,m=(c-b)/l,n=0;n<a.length;n++){if(a[n]<=b)i=0;else if(a[n]>=c)i=j.length-1;else{var o=a[n];i=parseInt((o-b)/m,10)}d&&(k=255),h[4*n+0]=k*j[i][0]*f+e*k,h[4*n+1]=k*j[i][1]*f+e*k,h[4*n+2]=k*j[i][2]*f+e*k,h[4*n+3]=void 0!==g?g*k:k}return h}}(),function(){"use strict";BrainCanvas.display=oFactory({updateCursor:function(a){var b=this.slice,c=this.getImageOrigin();a&&b&&(this.cursor.x=a.position[b.widthSpace.name]*this.zoom+c.x,this.cursor.y=(b.heightSpace.space_length-a.position[b.heightSpace.name])*this.zoom+c.y)},getVolumePosition:function(){return{x:this.cursor.x/this.zoom,y:this.cursor.y/this.zoom}},getImageOrigin:function(){return{x:this.image_center.x-this.slice.image.width/2,y:this.image_center.y-this.slice.image.height/2}},drawSlice:function(a){var b=this.slice.image,c=this.getImageOrigin();a.putImageData(b,c.x,c.y)},drawCrosshair:function(a,b,c){var d=8;b=b||"#FF0000",a.save(),a.strokeStyle=b,a.translate(this.cursor.x,this.cursor.y),a.scale(c,c),a.lineWidth=2,a.beginPath(),a.moveTo(0,-d),a.lineTo(0,-2),a.moveTo(0,2),a.lineTo(0,d),a.moveTo(-d,0),a.lineTo(-2,0),a.moveTo(2,0),a.lineTo(d,0),a.stroke(),a.restore()}}).mixin({canvas:null,context:null,slice:null,cursor:{x:0,y:0},last_cursor:{x:0,y:0},image_center:{x:0,y:0},mouse:null,zoom:1})}(),function(){"use strict";BrainCanvas.loader={loadArrayBuffer:function(a,b){var c=new XMLHttpRequest;c.open("GET",a,!0),c.responseType="arraybuffer",c.onreadystatechange=function(){4===c.readyState&&200===c.status&&(void 0!==c.mozResponseArrayBuffer?b(c.mozResponseArrayBuffer):b(c.response))},c.send()},loadFromTextFile:function(a,b){var c=new FileReader,d=a.files;c.file=d[0],c.onloadend=function(a){b(a.target.result)},c.readAsText(d[0])},loadFromUrl:function(a,b,c){$.ajax({url:a,type:"GET",success:b,error:c})},loadColorScaleFromFile:function(a,b,c){BrainCanvas.loader.loadFromTextFile(a,function(a){var d=new BrainCanvas.ColorScale(a);d.name=b,c(d)})},loadColorScaleFromUrl:function(a,b,c){BrainCanvas.loader.loadFromUrl(a,function(a){var d=new BrainCanvas.ColorScale(a);d.name=b,c(d)})}}}(),function(){"use strict";BrainCanvas.setupUI=function(a){$(document).keydown(function(b){if(a.active_canvas){var c=a.active_canvas,d=b.which;if(!(37>d||d>40)){var e=a.active_cursor,f=c.getAttribute("data-volume-id"),g=c.getAttribute("data-slice-num");return{37:function(){e.x--},38:function(){e.y--},39:function(){e.x++},40:function(){e.y++}}[d](),a.getSlices(e,f,g),a.synced&&a.displays.forEach(function(b,c){c!==f&&a.getSlices(e,c,g)}),!1}}})},BrainCanvas.addCanvasUI=function(a,b,c,d){function e(a){var b=$(a),c={x:0,y:0};return b.mousemove(function(a){var d=b.offset();c.x=a.pageX-d.left,c.y=a.pageY-d.top}),c}var f=[];if(a=$(a),[0,1,2].forEach(function(c){var g=document.createElement("canvas"),h=g.getContext("2d");g.width=256,g.height=256,g.setAttribute("data-volume-id",d),g.setAttribute("data-slice-num",c),g.classList.add("slice-display"),a.append(g),h.clearRect(0,0,g.width,g.height),f.push(BrainCanvas.display({canvas:g,context:h,cursor:{x:g.width/2,y:g.height/2},image_center:{x:g.width/2,y:g.height/2},mouse:e(g),zoom:b.default_zoom_level}))}),BrainCanvas.volumeUIControls){var g=$('<div class="braincanvas-controls volume-controls"></div>');BrainCanvas.volumeUIControls.defer_until_page_load?BrainCanvas.addEventListener("ready",function(){a.append(g),BrainCanvas.volumeUIControls(g,b,c,d)}):(BrainCanvas.volumeUIControls(g,b,c,d),a.append(g))}return function(){var a=null;f.forEach(function(c,e){function f(f){function g(a){var b,c;b=h.x-a.last_cursor.x,c=h.y-a.last_cursor.y,a.image_center.x+=b,a.image_center.y+=c,a.cursor.x+=b,a.cursor.y+=c,a.last_cursor.x=h.x,a.last_cursor.y=h.y}var h={x:i.x,y:i.y};f.target===a&&(f.shiftKey?(g(c),b.synced&&b.displays.forEach(function(a,b){b!==d&&g(a[e])})):(b.getSlices(h,d,e),b.synced&&b.displays.forEach(function(a,c){c!==d&&b.getSlices(h,c,e)}),c.cursor=b.active_cursor=h),b.draw())}function g(){$(document).unbind("mousemove",f).unbind("mouseup",g),a=null}var h=$(c.canvas),i=c.mouse;h.mousedown(function(h){a=h.target;var j={x:i.x,y:i.y};return h.shiftKey?(c.last_cursor.x=j.x,c.last_cursor.y=j.y,b.synced&&b.displays.forEach(function(a,b){if(b!==d){var c=a[e];c.last_cursor.x=j.x,c.last_cursor.y=j.y}})):(b.getSlices(j,d,e),b.synced&&b.displays.forEach(function(a,c){c!==d&&b.getSlices(j,c,e)}),c.cursor=b.active_cursor=j),b.active_canvas=h.target,$(document).mousemove(f).mouseup(g),b.draw(),!1}),h.mousewheel(function(a,f){return c.zoom=Math.max(c.zoom+.05*f,.05),b.updateSlices(d,["xspace","yspace","zspace"][e]),b.synced&&b.displays.forEach(function(a,c){if(c!==d){var g=a[e];g.zoom=Math.max(g.zoom+.05*f,.05),b.updateSlices(c,["xspace","yspace","zspace"][e])}}),!1})})}(),f},BrainCanvas.volumeUIControls=function(a,b,c,d){BrainCanvas._coordinateUI(a,b,c,d),"multivolume"===c.type?BrainCanvas._blendUI(a,b,c,d):(BrainCanvas._colorScaleUI(a,b,c,d),BrainCanvas._thresholdUI(a,b,c,d))},BrainCanvas._coordinateUI=function(a,b,c,d){var e,f,g;c.getWorldCoords&&(e=$('<div class="coords"></div>'),f=$('<div class="world-coords"><div class="control-heading">World Coordinates</div>X:<input id="world-x" class="control-inputs"></input>Y:<input id="world-y" class="control-inputs"></input>Z:<input id="world-z" class="control-inputs"></input></div>').change(function(){var a={x:+f.find("#world-x").val(),y:+f.find("#world-y").val(),z:+f.find("#world-z").val()};c.setWorldCoords(a.x,a.y,a.z),b.redrawVolume(d)}),g=$('<div class="voxel-coords"><div class="control-heading">Voxel Coordinates</div>X:<input id="voxel-x" class="control-inputs"></input>Y:<input id="voxel-y" class="control-inputs"></input>Z:<input id="voxel-z" class="control-inputs"></input></div>').change(function(){var a={x:+g.find("#voxel-x").val(),y:+g.find("#voxel-y").val(),z:+g.find("#voxel-z").val()};c.setVoxelCoords(a.x,a.y,a.z),b.redrawVolume(d)}),BrainCanvas.addEventListener("sliceupdate",function(){var a=c.getWorldCoords(),b=c.getVoxelCoords();f.find("#world-x").val(a.x),f.find("#world-y").val(a.y),f.find("#world-z").val(a.z),g.find("#voxel-x").val(b.x),g.find("#voxel-y").val(b.y),g.find("#voxel-z").val(b.z)})),e.append(f),e.append(g),a.append(e)},BrainCanvas._blendUI=function(a,b,c,d){var e=$('<div id="blend-slider" class="slider braincanvas-blend"></div>'),f=$('<div class="control-heading">Blend (-50 to 50): </div>'),g=$('<input class="control-inputs" value="0" id ="blend-val"/>');f.append(g),f.append(e),a.append(f),e.slider({min:-50,max:50,step:1,slide:function(a,e){var f=parseInt(e.value,10);c.updateBlendRatio(f),b.redrawVolume(d),g.val(f)},stop:function(){$(this).find("a").blur()}}),g.change(function(){var a=this.value;e.slider("value",a),c.updateBlendRatio(a),b.redrawVolume(d)})},BrainCanvas._colorScaleUI=function(a,b,c){var d=$("<select></select>"),e="";BrainCanvas.colorScales.forEach(function(a,c){e+='<option value="'+c+'"'+(b.defaultScale===a?" SELECTED":"")+">"+a.name+"</option>"}),d.html(e),d.change(function(a){c.colorScale=BrainCanvas.colorScales[+$(a.target).val()],b.redrawVolumes()}),a.append($('<div class="control-heading">Color Scale: </div>').append(d))},BrainCanvas._thresholdUI=function(a,b,c){var d=$('<div class="slider braincanvas-threshold"></div>'),e=$('<div class="control-heading" class="slider-div">Threshold: </div>'),f=$('<input class="control-inputs thresh-input-left" value="0"/>'),g=$('<input class="control-inputs thresh-input-right" value="255"/>'),h=$('<div class="thresh-inputs"></div>');h.append(f).append(g),e.append(h),a.append(e),e.append(d),d.slider({range:!0,min:0,max:255,values:[0,255],step:1,slide:function(a,d){var e=d.values;c.min=e[0],c.max=e[1],b.redrawVolumes(),f.val(e[0]),g.val(e[1])},stop:function(){$(this).find("a").blur()}}),f.change(function(){var a=this.value;d.slider("values",0,a),c.min=a,b.redrawVolumes()}),g.change(function(){var a=this.value;d.slider("values",1,a),c.max=a,b.redrawVolumes()})}}(),function(){"use strict";var a=function(a,b,c){var d=b.split("="),e={};e[d[0]]=d[1],$.ajax({url:a,dataType:"json",data:e,async:!1,success:function(a){c&&c(a)},error:function(a,b){throw{request:a,textStatus:b}}})},b=function(a,b,c){a=a.match(/\?/)?a+"&"+b:a+"?"+b,BrainCanvas.loader.loadArrayBuffer(a,function(a){c(a)})};BrainCanvas.volumeType.minc=function(c,d){var e,f,g={},h=c.getRawDataParam||"raw_data=true",i=c.getHeaderParam||"minc_headers=true";return g.getScaledSlice=function(a,b,c,d){var e=g.data.getScaledSlice(a,b,c,d);e.colorScale=g.colorScale||BrainCanvas.colorScales[0],e.min=g.min,e.max=g.max;var f=[e];return f.axis=a,f.x=e.x,f.y=e.y,f},g.getVoxelCoords=function(){return{x:this.position.xspace,y:this.position.yspace,z:this.position.zspace}},g.setVoxelCoords=function(a,b,c){this.position.xspace=a,this.position.yspace=b,this.position.zspace=c},g.getWorldCoords=function(){return{x:this.data.xspace.start+this.position.xspace*this.data.xspace.step,y:this.data.yspace.start+this.position.yspace*this.data.yspace.step,z:this.data.zspace.start+this.position.zspace*this.data.zspace.step}},g.setWorldCoords=function(a,b,c){this.position.xspace=Math.floor((a-this.data.xspace.start)/this.data.xspace.step),this.position.yspace=Math.floor((b-this.data.yspace.start)/this.data.yspace.step),this.position.zspace=Math.floor((c-this.data.zspace.start)/this.data.zspace.step)},a(c.filename,i,function(a){e=a,b(c.filename,h,function(a){f=new Uint8Array(a),g.data=new BrainCanvas.MincJS(c.filename,e,f),g.header=g.data.header,g.min=0,g.max=255,d&&d(g)})}),g}}(),BrainCanvas.MincJS=function(a,b,c){"use strict";function d(a,b,c){for(var d=new Uint16Array(b*c),e=0;b>e;e++)for(var f=0;c>f;f++)d[e*c+f]=a[f*b+(b-e)];return d}function e(a,b,c){for(var d=new Uint16Array(b*c),e=0;b>e;e++)for(var f=0;c>f;f++)d[e*c+f]=a[(c-f)*b+e];return d}if(!(this instanceof BrainCanvas.MincJS))return new BrainCanvas.MincJS(a,b,c);var f=this;this.parseHeader=function(a){f.header=a,f.order=a.order,4===f.order.length&&(f.order=f.order.slice(1,f.order.length),f.time=a.time),f.xspace=a.xspace,f.yspace=a.yspace,f.zspace=a.zspace,f.xspace.name="xspace",f.yspace.name="yspace",f.zspace.name="zspace",f.xspace.space_length=parseFloat(f.xspace.space_length),f.yspace.space_length=parseFloat(f.yspace.space_length),f.zspace.space_length=parseFloat(f.zspace.space_length),f.xspace.start=parseFloat(f.xspace.start),f.yspace.start=parseFloat(f.yspace.start),f.zspace.start=parseFloat(f.zspace.start),f.xspace.step=parseFloat(f.xspace.step),f.yspace.step=parseFloat(f.yspace.step),f.zspace.step=parseFloat(f.zspace.step),4===f.order.length&&(f.time.space_length=parseFloat(f.time.space_length),f.time.start=parseFloat(f.time.start),f.time.step=parseFloat(f.time.step)),f[f.order[0]].height=parseFloat(f[f.order[1]].space_length),f[f.order[0]].height_space=f[f.order[1]],f[f.order[0]].length=parseFloat(f[f.order[2]].space_length),f[f.order[0]].length_space=f[f.order[2]],f[f.order[0]].width=parseFloat(f[f.order[2]].space_length),f[f.order[0]].width_space=f[f.order[2]],f[f.order[1]].height=parseFloat(f[f.order[2]].space_length),f[f.order[1]].height_space=f[f.order[2]],f[f.order[1]].length=parseFloat(f[f.order[0]].space_length),f[f.order[1]].length_space=f[f.order[0]],f[f.order[1]].width=parseFloat(f[f.order[0]].space_length),f[f.order[1]].width_space=f[f.order[0]],f[f.order[2]].height=parseFloat(f[f.order[1]].space_length),f[f.order[2]].height_space=f[f.order[1]],f[f.order[2]].length=parseFloat(f[f.order[0]].space_length),f[f.order[2]].length_space=f[f.order[0]],f[f.order[2]].width=parseFloat(f[f.order[0]].space_length),f[f.order[2]].width_space=f[f.order[0]],f[f.order[0]].offset=parseFloat(f[f.order[1]].space_length)*parseFloat(f[f.order[2]].space_length),f[f.order[1]].offset=parseFloat(f[f.order[0]].space_length),f[f.order[2]].offset=parseFloat(f[f.order[0]].space_length),f[f.order[0]].slice_length=f[f.order[0]].height*f[f.order[0]].length};var g={};this.slice=function(a,b,c){var h;if(g[a]=g[a]||[],g[a][c]=g[a][c]||[],this[a].step<0&&(b=this[a].space_length-b),void 0!==g[a][c][b])return h=g[a][c][b],h.alpha=1,h.number=b,h;if(void 0===f.order)return!1;var i=0;f.time&&(c||(c=0),i=c*f[f.order[0]].height*f[f.order[0]].length*parseFloat(f[f.order[0]].space_length));var j=f[a].length_space.step,k=f[a].height_space.step;h={};var l,m,n,o,p,q,r,s,t,u;if(f.order[0]===a)if(m=f[a].height*f[a].length,n=f[a].height,o=f[a].length,p=1,q=o,r=m,l=new Uint16Array(m),j>0)if(k>0)for(s=0;m>s;s++)l[s]=this.data[i+r*b+s];else for(s=n;s>0;s--)for(t=0;o>t;t++)l[(n-s)*o+t]=this.data[i+r*b+s*o+t];else if(0>k)for(s=0;n>s;s++)for(t=0;o>t;t++)l[s*o+t]=this.data[i+r*b+s*o+o-t];else for(s=n;s>0;s--)for(t=0;o>t;t++)l[(n-s)*o+t]=this.data[i+r*b+s*o+o-t];else if(f.order[1]===a)if(n=f[a].height,m=f[a].height*f[a].length,o=f[a].length,p=1,q=f[f.order[0]].slice_length,r=f[f.order[0]].length,l=new Uint8Array(m),0>k)for(t=0;n>t;t++)for(u=0;o>u;u++)l[t*o+u]=f.data[i+b*r+q*u+t];else for(t=n;t>=0;t--)for(u=0;o>u;u++)l[(n-t)*o+u]=f.data[i+b*r+q*u+t];else for(n=f[a].height,m=f[a].height*f[a].length,o=f[a].length,p=f[f.order[0]].slice_length,q=f[f.order[0]].length,r=1,l=new Uint16Array(m),t=0;n>t;t++)for(u=0;o>u;u++)l[t*o+u]=f.data[i+b+f[f.order[0]].length*t+u*f[f.order[0]].slice_length];return h.x=f[a].length_space,h.y=f[a].height_space,h.width=o,h.height=n,"xspace"===a&&"yspace"===f.xspace.height_space.name&&(l=f.zspace.step<0?e(l,h.width,h.height):d(l,h.width,h.height),h.x=f[a].height_space,h.y=f[a].length_space,h.width=n,h.height=o),"yspace"===a&&"xspace"===f.yspace.height_space.name&&(l=f.zspace.step<0?e(l,h.width,h.height):d(l,h.width,h.height),h.x=f[a].height_space,h.y=f[a].length_space,h.width=n,h.height=o),"zspace"===a&&"xspace"===f.zspace.height_space.name&&(l=d(l,h.width,h.height),h.x=f[a].length_space,h.y=f[a].height_space,h.width=n,h.height=o),h.data=l,h.x=h.x||f[a].length_space,h.y=h.y||f[a].height_space,h.width=h.width||o,h.height=h.height||n,g[a][c][b]=h,h},this.nearestNeighboor=function(a,b,c,d,e){for(var f=a.data,g={},h=new Uint16Array(d*e),i=b/d,j=c/e,k=0;e>k;k++)for(var l=0;d>l;l++){var m=Math.floor(l*i),n=Math.floor(k*j);h[Math.floor(k*d+l)]=f[Math.floor(n*b+m)]}return g.data=h,g.x=a.x,g.y=a.y,g.width=d,g.height=e,g},this.getScaledSlice=function(a,b,c,g){c=c||1;var h=f.slice(a,b,g);if(1===c)return h;var i=f[a].length,j=f[a].height,k=Math.ceil(Math.abs(f[a].length_space.step)*i*c),l=Math.ceil(Math.abs(f[a].height_space.step)*j*c),m=this.nearestNeighboor(h,i,j,k,l);return"xspace"===a&&"yspace"===f.xspace.height_space.name&&(m.data=f.zspace.step<0?e(m.data,k,l):d(m.data,k,l)),"yspace"===a&&"xspace"===f.yspace.height_space.name&&(m.data=f.zspace.step<0?e(m.data,k,l):d(m.data,k,l)),"zspace"===a&&"xspace"===f.zspace.height_space.name&&(m.data=d(m.data,k,l)),m},this.parseHeader(b),this.data=c},function(){"use strict";function a(a){var b,c=this;c.volumes=[];var d=a.length;for(b=0;d>b;b++)a[b]!==this&&c.volumes.push(a[b]);c.blendRatios=[],d=c.volumes.length;var e=1/d;for(b=0;d>b;b++)c.blendRatios[b]=e}a.prototype.updateBlendRatio=function(a){a+=50,this.blendRatios[0]=(100-a)/100,this.blendRatios[1]=parseFloat(a)/100},a.prototype.slice=function(a,b,c){var d,e,f=this.volumes.length,g=[];for(d=0;f>d;d++){var h=this.volumes[d];h!==this&&(e=this.volumes[d].slice(a,b,c)[0],e.alpha=this.blendRatios[d],g.push(e))}return g.x=g[0].x,g.y=g[0].y,g},a.prototype.getScaledSlice=function(a,b,c,d){var e,f,g=this.volumes.length,h=[];for(e=0;g>e;e++){var i=this.volumes[e];i!==this&&(f=this.volumes[e].getScaledSlice(a,b,c,d)[0],f.alpha=this.blendRatios[e],h.push(f))}return h.x=h[0].x,h.y=h[0].y,h},a.prototype.getVoxelCoords=function(){return{x:this.position.xspace,y:this.position.yspace,z:this.position.zspace}},a.prototype.setVoxelCoords=function(a,b,c){this.position.xspace=a,this.position.yspace=b,this.position.zspace=c},a.prototype.getWorldCoords=function(){var a=this.volumes[0];return{x:a.data.xspace.start+this.position.xspace*a.data.xspace.step,y:a.data.yspace.start+this.position.yspace*a.data.yspace.step,z:a.data.zspace.start+this.position.zspace*a.data.zspace.step}},a.prototype.setWorldCoords=function(a,b,c){var d=this.volumes[0];this.position.xspace=Math.floor((a-d.data.xspace.start)/d.data.xspace.step),this.position.yspace=Math.floor((b-d.data.yspace.start)/d.data.yspace.step),this.position.zspace=Math.floor((c-d.data.zspace.start)/d.data.zspace.step)},BrainCanvas.volumeType.multiVolume=function(b,c){var d=new a(b.volumes);return d.type="multivolume",d.min=0,d.max=255,d.header=b.volumes[0].header,setTimeout(c,1),d}}();