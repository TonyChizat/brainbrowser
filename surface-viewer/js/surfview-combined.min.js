Array.prototype.min=function(){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.min.apply(Math,this.slice(c,c+b-1)))}}else{return Math.min.apply(Math,this)}return a.min()};Array.prototype.max=function(d){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.max.apply(Math,this.slice(c,c+b-1)))}}else{return Math.max.apply(Math,this)}return a.max()};function MNIObject(c){var h;var f=this;this.parse=function(j){f.num_hemispheres=1;j=j.replace(/\s+$/,"");j=j.replace(/^\s+/,"");h=j.split(/\s+/).reverse();f.objectClass=h.pop();if(f.objectClass=="P"){d();f.numberVertices=parseInt(h.pop());e();i();f.nitems=parseInt(h.pop())}else{if(f.objectClass=="L"){d();f.numberVertices=parseInt(h.pop());e();f.nitems=parseInt(h.pop())}else{throw new Error("That object class is not supported currently")}}g();b();a();if(f.objectClass=="P"){if(f.positionArray.length==81924*3){f.brainSurface=true;f.split_hemispheres()}}};function d(){if(f.objectClass=="P"){f.surfaceProperties={ambient:parseFloat(h.pop()),diffuse:parseFloat(h.pop()),specular_reflectance:parseFloat(h.pop()),specular_scattering:parseFloat(h.pop()),transparency:parseFloat(h.pop())}}else{if(f.objectClass=="L"){f.surfaceProperties={width:h.pop()}}}}function e(){f.positionArray=new Array();for(var j=0;j<f.numberVertices;j++){for(var k=0;k<3;k++){f.positionArray.push(parseFloat(h.pop()))}}}function i(){f.normalArray=new Array();for(var k=0;k<f.numberVertices;k++){for(var j=0;j<3;j++){f.normalArray.push(parseFloat(h.pop()))}}}function g(){f.colorFlag=parseInt(h.pop());f.colorArray=new Array();if(f.colorFlag===0){for(var j=0;j<4;j++){f.colorArray.push(parseFloat(h.pop()))}}else{if(f.colorFlag===1){for(var k=0;k<f.numberPolygons;k++){for(var j=0;j<4;j++){f.colorArray.push(parseFloat(h.pop()))}}}else{if(f.colorFlag===2){for(var k=0;k<f.numberVertices;k++){for(var j=0;j<4;j++){f.colorArray.push(parseFloat(h.pop()))}}}else{throw new Error("colorFlag not valid in that file")}}}}function b(){f.endIndicesArray=new Array();for(var j=0;j<f.nitems;j++){f.endIndicesArray.push(parseInt(h.pop()))}}function a(){f.indexArray=new Array();var k=h.length;for(var j=0;j<k;j++){f.indexArray.push(parseInt(h.pop()))}}this.split_hemispheres=function(){this.left={};this.right={};var n=this.positionArray.length;this.left.positionArray=this.positionArray.slice(0,n/2);this.right.positionArray=this.positionArray.slice(n/2,n);var m=this.indexArray.length;this.left.indexArray=this.indexArray.slice(0,m/2);this.right.indexArray=this.indexArray.slice(m/2,m);for(var j=0;j<this.right.indexArray.length;j++){this.right.indexArray[j]=this.right.indexArray[j]-2-m/3/2/2}var k=this.normalArray.length;this.left.normalArray=this.normalArray.slice(0,k/2);this.right.normalArray=this.normalArray.slice(k/2,k);this.left.colorFlag=this.colorFlag;this.right.colorFlag=this.colorFlag;if(this.colorFlag==0||this.colorFlag==1){this.left.colorArray=this.colorArray;this.right.colorArray=this.colorArray}else{var l=this.colorArray.length;this.left.colorArray=this.colorArray.slice(0,l/2);this.right.colorArray=this.colorArray.slice(l/2+1,-1)}this.left.numberVertices=this.numberVertices/2;this.right.numberVertices=this.numberVertices/2;this.left.numberPolygons=this.numberPolygons/2;this.right.numberPolygons=this.numberPolygons/2;this.num_hemispheres=2};this.getVertexInfo=function(k){var j=[this.positionArray[k*3],this.positionArray[k*3+1],this.positionArray[k*3+2]];return{vertex:k,position_vector:j}};this.get_vertex=function(u,r,j){if(this.num_hemispheres>1){var q=this[j];var n=0;if(j=="right"){n=2+q.indexArray.length/3/2}}else{var q=this;var n=0}var p=new Array();var x=u*3;for(var o=0;o<3;o++){p.push(q.indexArray[x+o])}var v=new Array();for(var o=0;o<3;o++){var t=p[o]*3;v[o]=new Array();for(var m=0;m<3;m++){v[o][m]=q.positionArray[t+m]}}var w=new Array();for(var o=0;o<3;o++){w.push(o3djs.math.distance(r,v[o]))}var l=0;if(w[1]<w[0]){l=1}if(w[2]<w[l]){l=2}var s=p[l]+n;var y=v[l];return{vertex:s,position_vector:y}};if(c){this.parse(c)}}function Spectrum(d){var b=this;function a(e,f,k,m){var g=document.createElement("canvas");jQuery(g).attr("width",e.length);jQuery(g).attr("height",k);var j=g.getContext("2d");if(m){for(var h=0;h<e.length;h++){var l=e.length-1-h;j.fillStyle="rgb("+parseInt(parseFloat(e[l][0])*255)+","+parseInt(parseFloat(e[l][1])*255)+","+parseInt(parseFloat(e[l][2])*255)+")";j.fillRect(h,0,1,f)}}else{for(var h=0;h<e.length;h++){j.fillStyle="rgb("+parseInt(parseFloat(e[h][0])*255)+","+parseInt(parseFloat(e[h][1])*255)+","+parseInt(parseFloat(e[h][2])*255)+")";j.fillRect(h,0,1,f)}}return g}b.createSpectrumCanvas=function(e){if(e==null){e=b.colors}var f=a(e,20,20,false);return f};b.createSpectrumCanvasWithScale=function(i,e,f,j){if(f==null){f=b.colors}var g=a(f,20,40,j);var h=g.getContext("2d");h.fillStyle="#FFFFFF";h.fillRect(0.5,20,1,10);h.fillText(i.toPrecision(3),0.5,40);h.fillRect(g.width/4,20,1,10);h.fillText(((i+e)/4).toPrecision(3),g.width/4,40);h.fillRect(g.width/2,20,1,10);h.fillText(((i+e)/2).toPrecision(3),g.width/2,40);h.fillRect(3*(g.width/4),20,1,10);h.fillText((3*((i+e)/4)).toPrecision(3),3*(g.width/4),40);h.fillRect(g.width-0.5,20,1,10);h.fillText(e.toPrecision(3),g.width-20,40);return g};function c(l){l=l.replace(/\s+$/,"");l=l.replace(/^\s+/,"");var h=l.split(/\n/);var e=new Array();for(var g=0;g<h.length;g++){var j=h[g].split(/\s+/);for(var f=0;f<3;f++){j[f]=parseFloat(j[f])}j.push(1);e.push(j)}b.colors=e;return e}if(d!=undefined){c(d)}}function Data(b){var a=this;a.parse=function(c){c=c.replace(/\s+$/,"");c=c.replace(/^\s+/,"");a.values=c.split(/\s+/);for(var d=0;d<a.values.length;d++){a.values[d]=parseFloat(a.values[d])}a.min=a.values.min();a.max=a.values.max()};a.createColorArray=function(g,d,e,k){var e=e.colors;var h=new Array();var c=((d-g)+(d-g)/e.length)/e.length;for(var f=0;f<a.values.length;f++){if(a.values[f]<=g){var j=0}else{if(a.values[f]>d){var j=e.length-1}else{var j=parseInt((a.values[f]-g)/c)}}if(k){h.push.apply(h,e[e.length-1-j])}else{h.push.apply(h,e[j])}}return h};if(b){a.parse(b)}}o3djs.base.o3d=o3d;o3djs.require("o3djs.webgl");o3djs.require("o3djs.math");o3djs.require("o3djs.rendergraph");o3djs.require("o3djs.pack");o3djs.require("o3djs.picking");o3djs.require("o3djs.arcball");o3djs.require("o3djs.quaternions");o3djs.require("o3djs.scene");function BrainBrowser(e){var f=this;this.setup=function(g){f.preload_model(g)};this.init=function(){o3djs.webgl.makeClients(f.initStep2)};f.initStep2=function(h){var i=h[0];f.o3dElement=i;f.client=i.client;f.o3d=i.o3d;f.math=o3djs.math;f.dragging=false;f.o3dWidth=-1;f.o3dHeight=-1;f.quaternions=o3djs.quaternions;f.lastRot=f.math.matrix4.identity();f.thatRot=f.math.matrix4.identity();f.zoomFactor=1.1;f.keyPressDelta=0.1;f.clock=0;f.timeMult=1;f.camera={farPlane:5000,nearPlane:0.1};f.loading=jQuery("#o3d_loading");o3djs.base.init(i);f.pack=f.client.createPack();var g=o3djs.rendergraph.createBasicView(f.pack,f.client.root,f.client.renderGraphRoot,[0.5,0.5,0.5,1]);f.viewInfo=g;g.drawContext.projection=f.math.matrix4.perspective(f.math.degToRad(30),f.client.width/f.client.height,1,5000);f.eyeView=[0,0,500];g.drawContext.view=f.math.matrix4.lookAt(f.eyeView,[0,0,0],[0,1,0]);f.aball=o3djs.arcball.create(100,100);f.client.setRenderCallback(f.renderCallback);jQuery("body").keydown(f.keyPressedCallback);o3djs.event.addEventListener(i,"wheel",f.scrollMe);f.loadSpectrumFromUrl("/assets/spectral_spectrum.txt");if(f.afterInit){f.afterInit(f)}f.updateInfo();jQuery("#screenshot").click(function(j){jQuery(this).attr("href",bb.client.toDataURL())})};this.uninit=function(){if(this.client){this.client.cleanup()}};this.renderCallback=function(g){f.setClientSize()};this.createMaterial=function(g){var i=f.pack.createObject("Effect");var j=f.loadCombinedShaderFromUrl(g);i.loadFromFXString(j);var h=f.pack.createObject("Material");h.drawList=f.viewInfo.performanceDrawList;h.effect=i;i.createUniformParameters(h);return h};f.displayObjectFile=function(g){if(g.objectClass=="P"&&g.numberVertices==81924){f.createBrain(g)}else{if(g.objectClass=="P"){f.createPolygonObject(g)}else{if(g.objectClass=="L"){f.createLineObject(g)}else{alert("Object file not supported")}}}};this.createBrain=function(n){f.model_data=n;var k=f.createMaterial("/shaders/blinnphong.txt");if(n.num_hemispheres==2){var h={left:f.createHemisphere(k,n.left,"left"),right:f.createHemisphere(k,n.right,"right"),num_hemisphere:2}}else{var h=f.createHemisphere(k,n);h.num_hemisphere=1}if(f.brainTransform==null){f.brainTransform=f.pack.createObject("Transform");if(n.num_hemispheres==2){f.brainHemisphereTransforms={};f.brainHemisphereTransforms.left=f.pack.createObject("Transform");f.brainHemisphereTransforms.right=f.pack.createObject("Transform")}}else{f.brainTransform.removeShape(f.brainTransform.shapes[0]);if(f.brainTransform.children[0]!=null){f.brainTransform.children[0].removeShape(f.brainTransform.children[0].shapes[0])}if(f.brainTransform.children[1]!=null){f.brainTransform.children[1].removeShape(f.brainTransform.children[1].shapes[0])}}if(n.num_hemispheres!=2){f.brainTransform.removeParam(f.brainTransform.children[0]);f.brainTransform.removeParam(f.brainTransform.children[1])}if(n.num_hemispheres==2&&f.brainHemisphereTransforms==null){f.brainHemisphereTransforms={};f.brainHemisphereTransforms.left=f.pack.createObject("Transform");f.brainHemisphereTransforms.right=f.pack.createObject("Transform")}var r=k.getParam("lightWorldPos");r.value=f.eyeView;var g=k.getParam("ambient");var m=k.getParam("ambientIntensity");var l=k.getParam("lightIntensity");var p=k.getParam("specular");var o=k.getParam("emissive");var i=k.getParam("colorMult");var q=k.getParam("wires");q.value=false;g.value=[0.04,0.04,0.04,1];m.value=[1,1,1,1];l.value=[0.8,0.8,0.8,1];p.value=[0.5,0.5,0.5,1];o.value=[0,0,0,1];i.value=[1,1,1,1];var j=k.getParam("shininess");j.value=30;f.brainTransform.parent=f.client.root;if(h.num_hemisphere==1){f.brainTransform.addShape(h);h.createDrawElements(f.pack,null)}else{f.brainHemisphereTransforms.left.parent=f.brainTransform;f.brainHemisphereTransforms.right.parent=f.brainTransform;f.brainHemisphereTransforms.left.addShape(h.left);f.brainHemisphereTransforms.right.addShape(h.right);h.left.createDrawElements(f.pack,null);h.right.createDrawElements(f.pack,null)}f.model_data=n;if(f.afterCreateBrain!=undefined){f.afterCreateBrain(f.model_data)}};f.createLineObject=function(i){f.model_data=i;var g=f.createMaterial("/shaders/line.txt");var h=f.createLineShape(g,i);if(f.brainTransform==undefined){f.brainTransform=f.pack.createObject("Transform")}f.brainTransform.parent=f.client.root;f.brainTransform.addShape(h);h.createDrawElements(f.pack,null);f.model_data=i;if(f.afterCreate!=undefined){f.afterCreate(f.model_data)}};f.createPolygonObject=function(n){f.model_data=n;var j=f.createMaterial("/shaders/blinnphong.txt");var r=j.getParam("lightWorldPos");r.value=f.eyeView;var g=j.getParam("ambient");var m=j.getParam("ambientIntensity");var k=j.getParam("lightIntensity");var p=j.getParam("specular");var o=j.getParam("emissive");var h=j.getParam("colorMult");var q=j.getParam("wires");q.value=false;g.value=[0.04,0.04,0.04,1];m.value=[1,1,1,1];k.value=[0.8,0.8,0.8,1];p.value=[0.5,0.5,0.5,1];o.value=[0,0,0,1];h.value=[1,1,1,1];var i=j.getParam("shininess");i.value=30;var l=f.createPolygonShape(j,n);if(f.brainTransform==undefined){f.brainTransform=f.pack.createObject("Transform")}f.brainTransform.parent=f.client.root;f.brainTransform.addShape(l);l.createDrawElements(f.pack,null);f.model_data=n;if(f.afterCreate!=undefined){f.afterCreate(f.model_data)}};f.createHemisphere=function(n,m,j){var v=f.pack.createObject("Shape");var s=f.pack.createObject("Primitive");var x=f.pack.createObject("StreamBank");s.material=n;s.owner=v;s.streamBank=x;v.name=j;s.primitiveType=f.o3d.Primitive.TRIANGLELIST;var h=f.pack.createObject("State");var p=f.pack.createObject("VertexBuffer");var r=p.createField("FloatField",3);if(!m.positionArray){alert("PositionArray nil");return false}p.set(m.positionArray);f.numberVertices=m.numberVertices;var w=(m.positionArray.length/3);s.numberVertices=f.numberVertices;if(!m.indexArray){alert("Index Array nil");return false}s.numberPrimitives=m.indexArray.length/3;var l=f.pack.createObject("IndexBuffer");l.set(m.indexArray);s.indexBuffer=l;var u=f.pack.createObject("VertexBuffer");var o=u.createField("FloatField",3);u.set(m.normalArray);var q=[];if(m.colorArray.length==4){for(var k=0;k<w;k++){q.push.apply(q,m.colorArray)}}else{q=m.colorArray}if(q.length<m.positionArray.length){alert("Problem with the colors: "+q.length)}var t=f.pack.createObject("VertexBuffer");var g=t.createField("FloatField",4);t.set(q);q=[];if(f.loading){jQuery(f.loading).html("Buffers Loaded")}x.setVertexStream(f.o3d.Stream.POSITION,0,r,0);x.setVertexStream(f.o3d.Stream.NORMAL,0,o,0);x.setVertexStream(f.o3d.Stream.COLOR,0,g,0);return v};f.createLineShape=function(r,m,B){var q=f.pack.createObject("Shape");var A=f.pack.createObject("StreamBank");q.name=B;if(!m.positionArray){alert("PositionArray nil");return false}f.numberVertices=m.numberVertices;var x=f.pack.createObject("Primitive");x.material=r;x.owner=q;x.streamBank=A;x.primitiveType=f.o3d.Primitive.LINELIST;var o=f.pack.createObject("State");x.material.state=o;var h=new Array();for(var w=0;w<m.nitems;w++){if(w==0){var n=0}else{var n=m.endIndicesArray[w-1]}h.push(m.indexArray[n]);for(var u=n+1;u<m.endIndicesArray[w]-1;u++){h.push(m.indexArray[u]);h.push(m.indexArray[u])}h.push(m.indexArray[m.endIndicesArray[w]-1])}var l=f.pack.createObject("IndexBuffer");x.numberPrimitives=h.length/2;x.numberVertices=h.length;f.indexArray=h;var g=new Float32Array(h.length*3);for(var v=0;v<h.length;v++){g[v*3]=m.positionArray[h[v]*3];g[v*3+1]=m.positionArray[h[v]*3+1];g[v*3+2]=m.positionArray[h[v]*3+2]}var p=[];if(m.colorArray.length==4){for(var w=0;w<numberVertices;w++){p.push.apply(p,[0.5,0.5,0.7,1])}}else{p=new Float32Array(h.length*4);for(var v=0;v<h.length;v++){p[v*4]=m.colorArray[h[v]*4];p[v*4+1]=m.colorArray[h[v]*4+1];p[v*4+2]=m.colorArray[h[v]*4+2];p[v*4+3]=m.colorArray[h[v]*4+3]}}var y=f.pack.createObject("VertexBuffer");var s=y.createField("FloatField",3);y.set(g);A.setVertexStream(f.o3d.Stream.POSITION,0,s,0);if(p.length<m.positionArray.length){alert("Problem with the colors: "+p.length)}var t=f.pack.createObject("VertexBuffer");var z=t.createField("FloatField",4);t.set(p);p=[];A.setVertexStream(f.o3d.Stream.COLOR,0,z,0);if(f.loading){jQuery(f.loading).html("Buffers Loaded")}f.pack.gl.lineWidth(1);return q};f.createPolygonShape=function(p,l,A){var x=f.pack.createObject("Shape");var z=f.pack.createObject("StreamBank");x.name=A;if(!l.positionArray){alert("PositionArray nil");return false}f.numberVertices=l.numberVertices;var h=f.pack.createObject("Primitive");h.material=p;h.owner=x;h.streamBank=z;h.primitiveType=f.o3d.Primitive.TRIANGLELIST;var m=f.pack.createObject("State");h.material.state=m;var k=l.indexArray;h.numberPrimitives=k.length/3;h.numberVertices=k.length;f.indexArray=k;var g=new Float32Array(k.length*3);var v=new Float32Array(k.length*3);for(var t=0;t<k.length;t++){g[t*3]=l.positionArray[k[t]*3];g[t*3+1]=l.positionArray[k[t]*3+1];g[t*3+2]=l.positionArray[k[t]*3+2];v[t*3]=l.normalArray[k[t]*3];v[t*3+1]=l.normalArray[k[t]*3+1];v[t*3+2]=l.normalArray[k[t]*3+2]}alert("positionArray.lenght"+g.length+" normalArray.length"+v.length);var n=[];if(l.colorArray.length==4){for(var u=0;u<h.numberVertices;u++){n.push.apply(n,[0.5,0.5,0.7,1])}}else{n=new Float32Array(k.length*4);for(var t=0;t<k.length;t++){n[t*4]=l.colorArray[k[t]*4];n[t*4+1]=l.colorArray[k[t]*4+1];n[t*4+2]=l.colorArray[k[t]*4+2];n[t*4+3]=l.colorArray[k[t]*4+3]}}var o=f.pack.createObject("VertexBuffer");var r=o.createField("FloatField",3);o.set(v);z.setVertexStream(f.o3d.Stream.NORMAL,0,r,0);var w=f.pack.createObject("VertexBuffer");var q=w.createField("FloatField",3);w.set(g);z.setVertexStream(f.o3d.Stream.POSITION,0,q,0);if(n.length<l.positionArray.length){alert("Problem with the colors: "+n.length)}var s=f.pack.createObject("VertexBuffer");var y=s.createField("FloatField",4);s.set(n);n=[];z.setVertexStream(f.o3d.Stream.COLOR,0,y,0);if(f.loading){jQuery(f.loading).html("Buffers Loaded")}return x};f.createPinPoint=function(i){var n=f.pack.createObject("Transform");var k=f.createMaterial("/shaders/pinpoint.txt");var g=f.pack.createObject("Shape");var h=f.pack.createObject("Primitive");h.primitiveType=f.o3d.Primitive.POINTLIST;var o=f.pack.createObject("StreamBank");h.material=k;h.owner=g;h.streamBank=o;var j=this.model_data.getVertexInfo(i)["position_vector"];var l=f.pack.createObject("VertexBuffer");var m=l.createField("FloatField",3);l.set(j);o.setVertexStream(f.o3d.Stream.POSITION,0,m,0);n.addShape(g);g.createDrawElements(f.pack,null);return n};f.resetView=function(){f.brainTransform.children[0].visible=true;f.brainTransform.children[1].visible=true;f.brainTransform.identity();f.brainTransform.children[0].identity();f.brainTransform.children[1].identity()};this.setupView=function(g){f.resetView();if(f.model_data&&f.model_data.num_hemispheres==2){var h=f.getViewParams();switch(h.view){case"superior":f.superiorView();break;case"medial":f.medialView();break;case"anterior":f.anteriorView();break;case"inferior":f.inferiorView();break;case"lateral":f.lateralView();break;case"posterior":f.posteriorView();break;default:f.superiorView();break}}if(h.left==true){f.leftHemisphereVisible(true)}else{f.leftHemisphereVisible(false)}if(h.right==true){f.rightHemisphereVisible(true)}else{f.rightHemisphereVisible(false)}f.thatRot=f.math.matrix4.mul(f.brainTransform.localMatrix,f.math.matrix4.identity())};this.leftHemisphereVisible=function(g){f.brainTransform.children[0].visible=g};this.rightHemisphereVisible=function(g){f.brainTransform.children[1].visible=g};this.medialView=function(g){if(f.model_data.num_hemispheres==2){f.brainTransform.children[0].translate([-100,0,0]);f.brainTransform.children[1].translate([100,0,0]);f.brainTransform.children[0].rotateZ(f.math.degToRad(-90));f.brainTransform.children[1].rotateZ(f.math.degToRad(90));f.brainTransform.rotateX(f.math.degToRad(-90))}};this.lateralView=function(g){if(f.model_data.num_hemispheres==2){f.brainTransform.children[0].translate([-100,0,0]);f.brainTransform.children[1].translate([100,0,0]);f.brainTransform.children[0].rotateZ(f.math.degToRad(-90));f.brainTransform.children[1].rotateZ(f.math.degToRad(90));f.brainTransform.rotateX(f.math.degToRad(90));f.brainTransform.rotateY(f.math.degToRad(180))}};this.superiorView=function(){};this.inferiorView=function(){f.brainTransform.rotateY(f.math.degToRad(180))};this.anteriorView=function(g){f.resetView();f.brainTransform.rotateX(f.math.degToRad(-90));f.brainTransform.rotateZ(f.math.degToRad(180))};this.posteriorView=function(g){f.resetView();f.brainTransform.rotateX(f.math.degToRad(-90))};this.separateHemispheres=function(g){if(f.model_data.num_hemispheres==2){this.brainTransform.children[0].translate([-1,0,0]);this.brainTransform.children[1].translate([1,0,0])}};this.setClientSize=function(){var h=parseInt(f.client.width);var g=parseInt(f.client.height);if(h!=f.o3dWidth||g!=f.o3dHeight){f.o3dWidth=h;f.o3dHeight=g;f.updateProjection();f.aball.setAreaSize(f.o3dWidth,f.o3dHeight)}};f.ZoomInOut=function(h){for(var g=0;g<f.eyeView.length;g+=1){f.eyeView[g]=f.eyeView[g]/h}f.viewInfo.drawContext.view=f.math.matrix4.lookAt(f.eyeView,[0,0,0],[0,1,0])};f.scrollMe=function(h){var g=(h.deltaY<0)?1/f.zoomFactor:f.zoomFactor;f.ZoomInOut(g);f.client.render()};function b(g){d();if(g){f.selectedInfo=g}}this.updateInfo=function(){if(!f.treeInfo){f.treeInfo=o3djs.picking.createPickManager(f.client.root)}f.treeInfo.update()};function d(){if(f.selectedInfo){f.highlightShape=null;f.selectedInfo=null}}this.click=function(m,j){var i=o3djs.picking.clientPositionToWorldRay(m.x,m.y,f.viewInfo.drawContext,f.client.width,f.client.height);d();f.treeInfo.update();var k=f.treeInfo.pick(i);if(k){b(k);var o=k.rayIntersectionInfo.primitiveIndex;var l=k.rayIntersectionInfo.position;var g=k.element.owner.name;var n=f.model_data.get_vertex(o,l,g);var h={primitive_index:o,position_vector:n.position_vector,element:k.element,hemisphere:g,vertex:n.vertex};return j(m,h)}else{jQuery(f.pickInfoElem).html("--nothing--")}return false};f.getInfoForVertex=function(g){return f.model_data.getVertexInfo(g)};f.startDragging=function(g){if(g.shiftKey&&g.ctrlKey&&f.model_data.num_hemispheres==2){f.drag_hemisphere=click(g,function(h,i){if(i.hemisphere=="left"){return 0}else{if(i.hemisphere=="right"){return 1}else{return false}}})}f.lastRot=f.thatRot;f.aball.click([g.x,g.y]);f.dragging=true};f.drag=function(j){if(f.dragging&&j.button==f.o3d.Event.BUTTON_LEFT){var i=f.aball.drag([j.x,j.y]);var h=f.quaternions.quaternionToRotation(i);f.thatRot=f.math.matrix4.mul(f.lastRot,h);if(f.drag_hemisphere===0||f.drag_hemisphere===1){var g=f.brainTransform.children[f.drag_hemisphere].localMatrix;f.math.matrix4.setUpper3x3(g,f.thatRot);f.brainTransform.children[f.drag_hemisphere].localMatrix=g}else{var g=f.brainTransform.localMatrix;f.math.matrix4.setUpper3x3(g,f.thatRot);f.brainTransform.localMatrix=g}}else{if(f.dragging){f.stopDragging(j)}}};f.stopDragging=function(g){f.drag_hemisphere=false;f.dragging=false};f.updateCamera=function(){var g=[0,1,0];f.viewInfo.drawContext.view=f.math.matrix4.lookAt(f.camera.eye,f.camera.target,g);f.lightPosParam.value=f.camera.eye};f.updateProjection=function(){f.viewInfo.drawContext.projection=f.math.matrix4.perspective(f.math.degToRad(45),f.o3dWidth/f.o3dHeight,f.camera.nearPlane,f.camera.farPlane)};f.keyPressedAction=function(g,i){var h=false;switch(g){case"&":f.ZoomInOut(f.zoomFactor);h="zoom_in";break;case"(":f.ZoomInOut(1/f.zoomFactor);h="zoom_out";break;case" ":f.separateHemispheres();h="separate";break}return h};f.keyPressedCallback=function(h){var g=false;switch(h.which){case 38:f.ZoomInOut(f.zoomFactor);g="ZoomIn";break;case 40:f.ZoomInOut(1/f.zoomFactor);g="ZoomOut";break;case 32:f.separateHemispheres();g="Seperate";break}if(g){return false}else{return true}};f.set_fill_mode_wireframe=function(){if(f.model_data.num_hemispheres==2){var g=f.brainTransform.children[0].shapes[0].elements[0].material;f.state=f.pack.createObject("State");g.state=f.state;var h=g.getParam("wires");h.value=true;f.state.getStateParam("FillMode").value=f.o3d.State.WIREFRAME;g=f.brainTransform.children[1].shapes[0].elements[0].material;g.state=f.state;h=g.getParam("wires");h.value=true}else{var g=f.brainTransform.shapes[0].elements[0].material;f.state=f.pack.createObject("State");g.state=f.state;f.state.getStateParam("FillMode").value=f.o3d.State.WIREFRAME;var h=g.getParam("wires");h.value=true}f.client.render()};f.set_fill_mode_solid=function(){if(f.model_data.num_hemispheres==2){var g=f.brainTransform.children[0].shapes[0].elements[0].material;f.state1=f.pack.createObject("State");g.state=f.state1;var h=g.getParam("wires");h.value=false;f.state.getStateParam("FillMode").value=f.o3d.State.SOLID;g=f.brainTransform.children[1].shapes[0].elements[0].material;g.state=f.state;var h=g.getParam("wires");h.value=false}else{var g=f.brainTransform.shapes[0].elements[0].material;f.state=f.pack.createObject("State");g.state=f.state;f.state.getStateParam("FillMode").value=f.o3d.State.SOLID;var h=g.getParam("wires");h.value=false}};function a(g,h,i){jQuery.ajax({type:"GET",url:g,dataType:"text",success:function(j){i(j)},error:function(j,l,k){alert("Failure: "+l)},data:{},async:h,timeout:100000})}function c(j,i){var g=new FileReader();var h=j.files;g.file=h[0];g.onloadend=function(k){i(k.target.result)};g.readAsText(h[0])}f.loadObjFromUrl=function(g){a(g,false,function(h){f.createBrain(new MNIObject(h))})};f.loadObjFromFile=function(g){c(g,function(h){f.displayObjectFile(new MNIObject(h))})};f.loadSpectrumFromUrl=function(g){a(g,true,function(i){var h=new Spectrum(i);f.spectrum=h;if(f.afterLoadSpectrum!=null){f.afterLoadSpectrum(h)}if(f.data){f.updateColors(f.data,f.rangeMin,f.rangeMax,f.spectrum)}})};f.loadSpectrumFromFile=function(g){c(g,function(i){var h=new Spectrum(i);f.spectrum=h;if(f.afterLoadSpectrum!=null){f.afterLoadSpectrum(h)}if(f.data){f.updateColors(f.data,f.rangeMin,f.rangeMax,f.spectrum)}})};f.loadDataFromFile=function(m){var g=m.files[0].name;var k=function(n){f.data=new Data(n);if(f.fixRange==false||f.fixRange==null){f.rangeMin=f.data.min;f.rangeMax=f.data.max;if(f.afterLoadData!=null){f.afterLoadData(f.rangeMin,f.rangeMax,f.data)}}f.updateColors(f.data,f.rangeMin,f.rangeMax,f.spectrum)};if(g.match(/.*.mnc/)){var l=new XMLHttpRequest();l.open("POST","/minc/volume_object_evaluate",false);var i=document.getElementById("datafile-form");var j=new FormData(i);l.send(j);var h=l.response;k(h)}else{if(g.match(/.*.nii/)){var l=new XMLHttpRequest();l.open("POST","/nii/volume_object_evaluate",false);var i=document.getElementById("datafile-form");var j=new FormData(i);l.send(j);var h=l.response;k(h)}else{c(m,k)}}};f.loadDataFromUrl=function(g){a(g,true,function(h){f.data=new Data(h);if(f.fixRange==false||f.fixRange==null){f.rangeMin=f.data.min;f.rangeMax=f.data.max}f.updateColors(f.data,f.rangeMin,f.rangeMax,f.spectrum)})};f.loadCombinedShaderFromUrl=function(g){var h;a(g,false,function(i){h=i});return h};f.updateColors=function(z,r,t,x,j){var y=z.createColorArray(r,t,x,j);if(f.model_data.num_hemispheres==1){var o=f.pack.createObject("VertexBuffer");var s=o.createField("FloatField",4);o.set(y);var i=f.brainTransform.shapes[0];var m=i.elements[0].streamBank;m.setVertexStream(f.o3d.Stream.COLOR,0,s,0)}else{var h=y.slice(0,y.length/2);var q=y.slice(y.length/2,y.length);var n=f.pack.createObject("VertexBuffer");var v=n.createField("FloatField",4);n.set(h);var l=f.brainTransform.children[0].shapes[0];var p=l.elements[0].streamBank;p.setVertexStream(f.o3d.Stream.COLOR,0,v,0);var u=f.pack.createObject("VertexBuffer");var k=u.createField("FloatField",4);u.set(q);var w=f.brainTransform.children[1].shapes[0];var g=w.elements[0].streamBank;g.setVertexStream(f.o3d.Stream.COLOR,0,k,0);f.client.render()}if(f.afterUpdateColors!=null){f.afterUpdateColors(z,r,t,x)}return 1};f.rangeChange=function(h,g){f.rangeMin=h;f.rangeMax=g;f.updateColors(f.data,f.rangeMin,f.rangeMax,f.spectrum);if(f.afterRangeChange!=null){f.afterRangeChange(h,g)}};f.init()}var brainbrowser;function SurfView(){var a=this;brainbrowser=new BrainBrowser();this.brainbrowser=brainbrowser;brainbrowser.getViewParams=function(){return{view:jQuery("[name=hem_view]:checked").val(),left:jQuery("#left_hem_visible").attr("checked"),right:jQuery("#right_hem_visible").attr("checked")}};brainbrowser.afterLoadSpectrum=function(b){var c=b.createSpectrumCanvasWithScale(0,100,null);jQuery('<div id="spectrum" class="box full_box"></div>').html(c).appendTo("#controls");brainbrowser.spectrumObj=b};jQuery("#resetview").click(brainbrowser.setupView);jQuery(".view_button").change(brainbrowser.setupView);jQuery("[name=hem_view]").change(brainbrowser.setupView);this.updateCoordinates=function(b,d,c){jQuery("#x-coord").val(b[0]);jQuery("#y-coord").val(b[1]);jQuery("#z-coord").val(b[2]);jQuery("#v-coord").val(d);jQuery("#value-coord").val(c)};brainbrowser.afterInit=function(b){jQuery("body").keydown(b.keyPressedCallback);o3djs.event.addEventListener(b.o3dElement,"mousedown",function(c){if(c.shiftKey){b.click(c,function(f,d){if(brainbrowser.data){a.updateCoordinates(d.position_vector,d.vertex,brainbrowser.data.values[d.vertex])}})}else{b.startDragging(c)}});o3djs.event.addEventListener(b.o3dElement,"mousemove",function(c){b.drag(c)});o3djs.event.addEventListener(b.o3dElement,"mouseup",function(c){if(!c.shiftKey||c.button==b.o3d.Event.BUTTON_RIGHT){b.stopDragging(c)}});jQuery("#range-slider").slider({range:true,min:-50,max:50,value:[-10,10],slide:function(e,f){var d=parseFloat(f.values[0]);var c=parseFloat(f.values[1]);b.rangeChange(d,c)},step:0.1});b.afterRangeChange=function(e,c){jQuery("#data-range-min").val(e);jQuery("#data-range-max").val(c);var d=b.spectrumObj.createSpectrumCanvasWithScale(e,c,null);jQuery("#spectrum").html(jQuery(d))};b.afterLoadData=function(d,c,e){b.afterRangeChange(d,c);jQuery("#range-slider").slider("values",0,parseFloat(d));jQuery("#range-slider").slider("values",1,parseFloat(c))};jQuery("#meshmode").change(function(c){if(jQuery(c.target).attr("checked")==true){b.set_fill_mode_wireframe()}else{b.set_fill_mode_solid()}});jQuery("#fix_range").click(function(c,d){b.fixRange=jQuery("#fix_range").attr("checked");alert("fixRange "+b.fixRange)});jQuery(".range-box").keypress(function(c){if(c.keyCode=="13"){b.rangeChange(parseFloat(jQuery("#data-range-min").val()),parseFloat(jQuery("#data-range-max").val()))}});jQuery("#data-range-min").change(function(c){jQuery("#range-slider").slider("values",0,parseFloat(jQuery(this).val()))});jQuery("#data-range-max").change(function(c){jQuery("#range-slider").slider("values",1,parseFloat(jQuery(this).val()))});$("#examples").click(function(d){var c=$(d.target).attr("data-example-name");switch(c){case"basic":b.loadObjFromUrl("/models/surf_reg_model_both.obj");break;case"punkdti":b.loadObjFromUrl("/models/dti.obj");b.loadObjFromUrl("/models/left_color.obj");break;case"realct":b.loadObjFromUrl("/models/realct.obj");b.loadDataFromUrl("/models/realct.txt");break}return false})}};