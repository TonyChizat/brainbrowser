Array.prototype.min=function(){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.min.apply(Math,this.slice(c,c+b-1)))}}else{return Math.min.apply(Math,this)}return a.min()};Array.prototype.max=function(d){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.max.apply(Math,this.slice(c,c+b-1)))}}else{return Math.max.apply(Math,this)}return a.max()};function Minc(b,a,d){var c=this;this.load_headers=function(e){$.ajax({url:e,dataType:"json",data:{minc_headers:true},async:false,success:function(f){c.header=f;c.order=f.order;if(c.order.length==4){c.order=c.order.slice(1,c.order.length);c.time=f.time}c.xspace=f.xspace;c.yspace=f.yspace;c.zspace=f.zspace;c.xspace.step=parseFloat(f.xspace.step);c.yspace.step=parseFloat(f.yspace.step);c.zspace.step=parseFloat(f.zspace.step);if(c.xspace.step==0){c.xspace.step=1}if(c.yspace.step==0){c.yspace.step=1}if(c.zspace.step==0){c.zspace.step=1}c[c.order[0]].height=c[c.order[1]].space_length;c[c.order[0]].height_space=c.order[1];c[c.order[0]].length=c[c.order[2]].space_length;c[c.order[0]].length_space=c.order[2];c[c.order[1]].height=c[c.order[2]].space_length;c[c.order[1]].height_space=c.order[2];c[c.order[1]].length=c[c.order[0]].space_length;c[c.order[1]].length_space=c.order[0];c[c.order[2]].height=c[c.order[1]].space_length;c[c.order[2]].height_space=c.order[1];c[c.order[2]].length=c[c.order[0]].space_length;c[c.order[2]].length_space=c.order[0];c[c.order[0]].offset=c[c.order[1]].space_length*c[c.order[2]].space_length;c[c.order[1]].offset=c[c.order[0]].space_length;c[c.order[2]].offset=c[c.order[0]].space_length;c[c.order[0]].slice_length=c[c.order[0]].height*c[c.order[0]].length},error:function(f,g){throw {request:f,textStatus:g}}})};this.load_data=function(f,h,e){var g=new XMLHttpRequest();g.open("GET",f+"?raw_data=true",true);g.responseType="arraybuffer";g.onreadystatechange=function(){if(g.readyState==4){if(g.status==200){if(g.mozResponseArrayBuffer!=undefined){c.data=new Uint8Array(g.mozResponseArrayBuffer)}else{c.data=new Uint8Array(g.response)}c.min=0;c.max=255;h(c,e)}}};g.send(null)};this.parseData=function(h,k,e){h=h.replace(/\s+$/,"");h=h.replace(/^\s+/,"");var g=h.split(/\s+/);h="";var j=g.length;for(var f=0;f<j;f++){g[f]=parseInt(g[f])}c.min=g.min();c.max=g.max();g=new Uint16Array(g);c.data=g;k(this,e)};this.slice=function(h,n,g){if(c.order==undefined){return false}if(c.time){if(!g){g=0}var s=g*c[c.order[0]].height*c[c.order[0]].length*c[c.order[0]].space_length}else{var s=0}if(c.order[0]==h){var e=c[h].height*c[h].length;var f=c[h].length;var r=1;var q=f;var m=e;var t=new Uint16Array(e);for(var p=0;p<e;p++){t[p]=this.data[s+m*n+p]}}else{if(c.order[1]==h){var u=c[h].height;var e=c[h].height*c[h].length;var f=c[h].length;var r=1;var q=c[c.order[0]].slice_length;var m=c[c.order[0]].length;var t=new Uint16Array(e);for(var o=0;o<u;o++){for(var l=0;l<f;l++){t[o*(f)+l]=c.data[s+n*m+q*l+o]}}}else{var u=c[h].height;var e=c[h].height*c[h].length;var f=c[h].length;var r=c[c.order[0]].slice_length;var q=c[c.order[0]].length;var m=1;var t=new Uint16Array(e);for(var o=0;o<u;o++){for(var l=0;l<f;l++){t[o*(f)+l]=c.data[s+n+c[c.order[0]].length*o+l*c[c.order[0]].slice_length]}}}}return t};this.getScaledSlice=function(f,n,e,r){if(r==null){r=Math.abs(c[f].step)}var g=c.slice(f,n,e);var q=new Uint16Array(g.length*r*r);for(var p=0;p<c[f].height;p++){for(var o=0;o<r;o++){for(var m=0;m<c[f].length;m++){for(var h=0;h<r;h++){q[(p*r+o)*(c[f].length*r)+m*r+h]=g[p*c[f].length+m]}}}}return q};if(b!=null&&d!=null){this.load_headers(b);this.load_data(b,d,a)}}function createColorMap(f,a,j,c,g,e){var f=f.colors;var h=((g-c)+(g-c)/f.length)/f.length;for(var d=0;d<j.length;d++){if(j[d]<=c){var k=0}else{if(j[d]>g){var k=f.length-1}else{var k=parseInt((j[d]-c)/h)}}if(e){var b=255}else{var b=1}a[d*4+0]=b*f[k][0];a[d*4+1]=b*f[k][1];a[d*4+2]=b*f[k][2];a[d*4+3]=b*1}return a}function Spectrum(d){var b=this;function a(e,f,k,m){var g=document.createElement("canvas");jQuery(g).attr("width",e.length);jQuery(g).attr("height",k);var j=g.getContext("2d");if(m){for(var h=0;h<e.length;h++){var l=e.length-1-h;j.fillStyle="rgb("+parseInt(parseFloat(e[l][0])*255)+","+parseInt(parseFloat(e[l][1])*255)+","+parseInt(parseFloat(e[l][2])*255)+")";j.fillRect(h,0,1,f)}}else{for(var h=0;h<e.length;h++){j.fillStyle="rgb("+parseInt(parseFloat(e[h][0])*255)+","+parseInt(parseFloat(e[h][1])*255)+","+parseInt(parseFloat(e[h][2])*255)+")";j.fillRect(h,0,1,f)}}return g}b.createSpectrumCanvas=function(e){if(e==null){e=b.colors}var f=a(e,20,20,false);return f};b.createSpectrumCanvasWithScale=function(i,e,f,j){if(f==null){f=b.colors}var g=a(f,20,40,j);var h=g.getContext("2d");h.fillStyle="#FFFFFF";h.fillRect(0.5,20,1,10);h.fillText(i.toPrecision(3),0.5,40);h.fillRect(g.width/4,20,1,10);h.fillText(((i+e)/4).toPrecision(3),g.width/4,40);h.fillRect(g.width/2,20,1,10);h.fillText(((i+e)/2).toPrecision(3),g.width/2,40);h.fillRect(3*(g.width/4),20,1,10);h.fillText((3*((i+e)/4)).toPrecision(3),3*(g.width/4),40);h.fillRect(g.width-0.5,20,1,10);h.fillText(e.toPrecision(3),g.width-20,40);return g};function c(l){l=l.replace(/\s+$/,"");l=l.replace(/^\s+/,"");var h=l.split(/\n/);var e=new Array();for(var g=0;g<h.length;g++){var j=h[g].split(/\s+/);for(var f=0;f<3;f++){j[f]=parseFloat(j[f])}j.push(1);e.push(j)}b.colors=e;return e}if(d!=undefined){c(d)}}function Loader(){var c=this;function a(d,e,f){jQuery.ajax({type:"GET",url:d,dataType:"text",success:function(g){f(g)},error:function(g,i,h){alert("Failure: load data")},data:{},async:e,timeout:100000})}function b(g,f){var d=new FileReader();var e=g.files;d.file=e[0];d.onloadend=function(h){f(h.target.result)};d.readAsText(e[0])}c.loadObjFromUrl=function(d){a(d,false,function(e){c.createBrain(new MNIObject(e))})};c.loadObjFromFile=function(d){b(d,function(e){c.createBrain(new MNIObject(e))})};c.loadSpectrumFromUrl=function(e){var d=[];a(e,false,function(f){d=new Spectrum(f);if(c.afterLoadSpectrum!=null){c.afterLoadSpectrum(d)}});return d};c.loadSpectrumFromFile=function(d){b(d,function(f){var e=new Spectrum(f);c.spectrum=e;if(c.afterLoadSpectrum!=null){c.afterLoadSpectrum(e)}if(c.data){c.updateColors(c.data,c.rangeMin,c.rangeMax,c.spectrum)}})}}function BrainCanvas(c){var e=this;var d=c.getContext("2d");var a=new Loader();var g={x:[0,0],y:[0,0],z:[0,0]};e.slices={};var b=a.loadSpectrumFromUrl("/spectrum/spectral.txt");this.initCanvas=function(j,i){c.width=j;c.height=i;d.fillStyle="#000000";d.fillRect(0,0,j,i)};this.update_space=function(j,l,i,m){var n=i.getScaledSlice(j,l,m,null);var k=d.createImageData(i[j].length*Math.abs(i[i[j].length_space].step),i[j].height*Math.abs(i[i[j].height_space].step));k.data=createColorMap(b,k.data,n,i.min,i.max,true);return k};function h(i,j){d.fillStyle="#FF0000";d.fillRect(i-2,j-2,4,4)}this.updateXSpace=function(k,i,l){e.slices.xspace=k;var j=e.update_space("xspace",k,i,l);d.putImageData(j,0,0)};this.updateYSpace=function(k,i,l){e.slices.yspace=k;var j=e.update_space("yspace",k,i,l);d.putImageData(j,0,i.xspace.height*Math.abs(i.xspace.step))};this.updateZSpace=function(k,i,l){e.slices.zspace=k;var j=e.update_space("zspace",k,i,l);d.putImageData(j,0,i.xspace.height*Math.abs(i.xspace.step)+i.yspace.height*Math.abs(i.yspace.step))};this.updateSlices=function(j,k){if(j){var i=e.getSliceNumbersFromPosition(f(j))}else{var i={x:e.slices.xspace,y:e.slices.yspace,z:e.slices.zspace}}e.initCanvas(c.width,c.height);e.updateXSpace(i.x,e.current_minc,k);e.updateYSpace(i.y,e.current_minc,k);e.updateZSpace(i.z,e.current_minc,k);h(e.slices[e.current_minc.xspace.length_space]*Math.abs(e.current_minc.xspace.step),e.slices[e.current_minc.xspace.height_space]*Math.abs(e.current_minc.xspace.step));h(e.slices[e.current_minc.yspace.length_space]*Math.abs(e.current_minc.xspace.step),e.slices[e.current_minc.yspace.height_space]*Math.abs(e.current_minc.xspace.step)+e.current_minc.xspace.height*Math.abs(e.current_minc.xspace.step));h(e.slices[e.current_minc.zspace.length_space]*Math.abs(e.current_minc.xspace.step),e.slices[e.current_minc.zspace.height_space]*Math.abs(e.current_minc.xspace.step)+e.current_minc.xspace.height*Math.abs(e.current_minc.xspace.step)+e.current_minc.yspace.height*Math.abs(e.current_minc.xspace.step))};this.showMinc=function(i){$(c).siblings("#mincinfo").append("Minc Information: <br>order: "+i.order+"<br>xspace.height: "+i.xspace.height+" yspace.height: "+i.yspace.height+" zspace.height: "+i.zspace.height+"<br> xspace.length: "+i.xspace.length+" yspace.length: "+i.yspace.length+" zspace.length: "+i.zspace.length+"xspace step: "+i.xspace.step+"yspace step: "+i.yspace.step+"zspace step: "+i.zspace.step);e.slices.xspace=100;e.slices.yspace=100;e.slices.zspace=100;e.updateXSpace(e.slices.xspace,i);e.updateYSpace(e.slices.yspace,i);e.updateZSpace(e.slices.zspace,i);h(e.slices[e.current_minc.xspace.length_space]*Math.abs(e.current_minc.xspace.step),e.slices[e.current_minc.xspace.height_space]*Math.abs(e.current_minc.xspace.step));h(e.slices[e.current_minc.yspace.length_space]*Math.abs(e.current_minc.xspace.step),e.slices[e.current_minc.yspace.height_space]*Math.abs(e.current_minc.xspace.step)+e.current_minc.xspace.height*Math.abs(e.current_minc.xspace.step));h(e.slices[e.current_minc.zspace.length_space]*Math.abs(e.current_minc.xspace.step),e.slices[e.current_minc.zspace.height_space]*Math.abs(e.current_minc.xspace.step)+e.current_minc.xspace.height*Math.abs(e.current_minc.xspace.step)+e.current_minc.yspace.height*Math.abs(e.current_minc.xspace.step))};function f(j){var i;var k;if(j.pageX!=undefined&&j.pageY!=undefined){i=j.pageX;k=j.pageY}else{i=j.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;k=j.clientY+document.body.scrollTop+document.documentElement.scrollTop}i-=c.offsetLeft;k-=c.offsetTop;return{x:i,y:k}}this.getSliceNumbersFromPosition=function(i){e.position=i;if(i.y/Math.abs(e.current_minc.xspace.step)<e.current_minc.xspace.height){var j={x:e.slices.xspace};if(e.current_minc.xspace.height_space=="yspace"){j.y=parseInt(i.y/Math.abs(e.current_minc.yspace.step));j.z=parseInt(i.x/Math.abs(e.current_minc.zspace.step))}else{j.y=parseInt(i.x/Math.abs(e.current_minc.yspace.step));j.z=parseInt(i.y/Math.abs(e.current_minc.zspace.step))}}else{if(i.y/Math.abs(e.current_minc.yspace.step)<e.current_minc.xspace.height+e.current_minc.yspace.height){var j={y:e.slices.yspace};if(e.current_minc.yspace.height_space=="zspace"){j.x=parseInt(i.x/Math.abs(e.current_minc.xspace.step));j.z=parseInt(i.y/Math.abs(e.current_minc.zspace.step))-e.current_minc.xspace.height}else{j.z=parseInt(i.x/Math.abs(e.current_minc.zspace.step));j.x=parseInt(i.y/Math.abs(e.current_minc.yspace.step))-e.current_minc.xspace.height}}else{var j={z:e.slices.zspace,x:parseInt(i.x/Math.abs(e.current_minc.xspace.step)),y:parseInt(i.y/Math.abs(e.current_minc.yspace.step))-e.current_minc.xspace.height-e.current_minc.yspace.height}}}return j};this.addListeners=function(){c.onmousedown=function(i){e.drag=true};c.onmouseup=function(i){e.drag=false};c.onmousemove=function(i){if(e.drag){e.updateSlices(i)}}};this.showTime=function(){var i=$(c).parent();$("<input type='text' name='time' value=\"0\" size=4>").appendTo(i);$('<div id="time-slider" width="'+c.width+'" + height="10"></div>').slider({value:0,min:0,max:e.current_minc.time.space_length,step:1,slide:function(j,k){e.updateSlices(null,k.value)}}).appendTo(i)};this.openFile=function(i){this.current_minc=new Minc(i,null,function(k,l){var j=k.xspace.height*Math.abs(k.xspace.step)+k.yspace.height*Math.abs(k.yspace.step)+k.yspace.height*Math.abs(k.zspace.step);var m=Math.max(k.xspace.length*Math.abs(k.xspace.step),k.yspace.length*Math.abs(k.yspace.step),k.zspace.length*Math.abs(k.zspace.step));e.initCanvas(m,j);e.showMinc(k);e.addListeners();if(k.time){e.showTime()}})}};