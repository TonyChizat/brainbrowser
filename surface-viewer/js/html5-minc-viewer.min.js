Array.prototype.min=function(){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.min.apply(Math,this.slice(c,c+b-1)))}}else{return Math.min.apply(Math,this)}return a.min()};Array.prototype.max=function(d){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.max.apply(Math,this.slice(c,c+b-1)))}}else{return Math.max.apply(Math,this)}return a.max()};function Minc(b,a,d){var c=this;this.load_headers=function(e){$.ajax({url:e,dataType:"json",data:{minc_headers:true},async:false,success:function(f){c.header=f;c.order=f.order;if(c.order.length==4){c.order=c.order.slice(1,c.order.length);c.time=f.time}c.xspace=f.xspace;c.yspace=f.yspace;c.zspace=f.zspace;c.xspace.step=parseFloat(f.xspace.step);c.yspace.step=parseFloat(f.yspace.step);c.zspace.step=parseFloat(f.zspace.step);c[c.order[0]].height=c[c.order[1]].space_length;c[c.order[0]].height_space=c.order[1];c[c.order[0]].length=c[c.order[2]].space_length;c[c.order[0]].length_space=c.order[2];c[c.order[1]].height=c[c.order[2]].space_length;c[c.order[1]].height_space=c.order[2];c[c.order[1]].length=c[c.order[0]].space_length;c[c.order[1]].length_space=c.order[0];c[c.order[2]].height=c[c.order[1]].space_length;c[c.order[2]].height_space=c.order[1];c[c.order[2]].length=c[c.order[0]].space_length;c[c.order[2]].length_space=c.order[0];c[c.order[0]].offset=c[c.order[1]].space_length*c[c.order[2]].space_length;c[c.order[1]].offset=c[c.order[0]].space_length;c[c.order[2]].offset=c[c.order[0]].space_length;c[c.order[0]].slice_length=c[c.order[0]].height*c[c.order[0]].length},error:function(f,g){throw {request:f,textStatus:g}}})};this.load_data=function(f,h,e){var g=new XMLHttpRequest();g.open("GET",f+"?raw_data=true",true);g.responseType="arraybuffer";g.onreadystatechange=function(){if(g.readyState==4){if(g.status==200){if(g.mozResponseArrayBuffer!=undefined){c.data=new Uint8Array(g.mozResponseArrayBuffer)}else{c.data=new Uint8Array(g.response)}c.min=0;c.max=255;h(c,e)}}};g.send(null)};this.parseData=function(h,k,e){h=h.replace(/\s+$/,"");h=h.replace(/^\s+/,"");var g=h.split(/\s+/);h="";var j=g.length;for(var f=0;f<j;f++){g[f]=parseInt(g[f])}c.min=g.min();c.max=g.max();g=new Uint16Array(g);c.data=g;k(this,e)};this.slice=function(h,n,g){if(c.order==undefined){return false}if(c.time){if(!g){g=0}var s=g*c[c.order[0]].height*c[c.order[0]].length*c[c.order[0]].space_length}else{var s=0}if(c.order[0]==h){var e=c[h].height*c[h].length;var f=c[h].length;var r=1;var q=f;var m=e;var t=new Uint16Array(e);for(var p=0;p<e;p++){t[p]=this.data[s+m*n+p]}}else{if(c.order[1]==h){var u=c[h].height;var e=c[h].height*c[h].length;var f=c[h].length;var r=1;var q=c[c.order[0]].slice_length;var m=c[c.order[0]].length;var t=new Uint16Array(e);for(var o=0;o<u;o++){for(var l=0;l<f;l++){t[o*(f)+l]=c.data[s+n*m+q*l+o]}}}else{var u=c[h].height;var e=c[h].height*c[h].length;var f=c[h].length;var r=c[c.order[0]].slice_length;var q=c[c.order[0]].length;var m=1;var t=new Uint16Array(e);for(var o=0;o<u;o++){for(var l=0;l<f;l++){t[o*(f)+l]=c.data[s+n+c[c.order[0]].length*o+l*c[c.order[0]].slice_length]}}}}return t};this.nearestNeighboor=function(l,f,r,g,e){var n=new Uint16Array(g*e);var p=f/g;var m=r/e;for(var k=0;k<e;k++){for(var h=0;h<g;h++){var q=Math.floor(h*p);var o=Math.floor(k*m);n[Math.floor(k*g+h)]=l[Math.floor(o*f+q)]}}return n};this.getScaledSlice=function(j,k,l){var f=c.slice(j,k,l);var i=c[j].length;var e=c[j].height;var g=Math.ceil(Math.abs(c[c[j].length_space].step)*i);var h=Math.ceil(Math.abs(c[c[j].height_space].step)*e);return this.nearestNeighboor(f,i,e,g,h)};if(b!=null&&d!=null){this.load_headers(b);this.load_data(b,d,a)}}function createColorMap(g,a,l,d,j,f,h,c){var g=g.colors;var k=((j-d)+(j-d)/g.length)/g.length;for(var e=0;e<l.length;e++){if(l[e]<=d){var m=0}else{if(l[e]>j){var m=g.length-1}else{var m=parseInt((l[e]-d)/k)}}if(f){var b=255}else{var b=1}a[e*4+0]=b*g[m][0]*c+h*b;a[e*4+1]=b*g[m][1]*c+h*b;a[e*4+2]=b*g[m][2]*c+h*b;a[e*4+3]=b*1}return a}function Spectrum(d){var b=this;function a(e,f,k,m){var g=document.createElement("canvas");jQuery(g).attr("width",e.length);jQuery(g).attr("height",k);var j=g.getContext("2d");if(m){for(var h=0;h<e.length;h++){var l=e.length-1-h;j.fillStyle="rgb("+parseInt(parseFloat(e[l][0])*255)+","+parseInt(parseFloat(e[l][1])*255)+","+parseInt(parseFloat(e[l][2])*255)+")";j.fillRect(h,0,1,f)}}else{for(var h=0;h<e.length;h++){j.fillStyle="rgb("+parseInt(parseFloat(e[h][0])*255)+","+parseInt(parseFloat(e[h][1])*255)+","+parseInt(parseFloat(e[h][2])*255)+")";j.fillRect(h,0,1,f)}}return g}b.createSpectrumCanvas=function(e){if(e==null){e=b.colors}var f=a(e,20,20,false);return f};b.createSpectrumCanvasWithScale=function(i,e,f,j){if(f==null){f=b.colors}var g=a(f,20,40,j);var h=g.getContext("2d");h.fillStyle="#FFFFFF";h.fillRect(0.5,20,1,10);h.fillText(i.toPrecision(3),0.5,40);h.fillRect(g.width/4,20,1,10);h.fillText(((i+e)/4).toPrecision(3),g.width/4,40);h.fillRect(g.width/2,20,1,10);h.fillText(((i+e)/2).toPrecision(3),g.width/2,40);h.fillRect(3*(g.width/4),20,1,10);h.fillText((3*((i+e)/4)).toPrecision(3),3*(g.width/4),40);h.fillRect(g.width-0.5,20,1,10);h.fillText(e.toPrecision(3),g.width-20,40);return g};function c(l){l=l.replace(/\s+$/,"");l=l.replace(/^\s+/,"");var h=l.split(/\n/);var e=new Array();for(var g=0;g<h.length;g++){var j=h[g].split(/\s+/);for(var f=0;f<3;f++){j[f]=parseFloat(j[f])}j.push(1);e.push(j)}b.colors=e;return e}if(d!=undefined){c(d)}}function Loader(){var c=this;function a(d,e,f){jQuery.ajax({type:"GET",url:d,dataType:"text",success:function(g){f(g)},error:function(g,i,h){},data:{},async:e,timeout:100000})}function b(g,f){var d=new FileReader();var e=g.files;d.file=e[0];d.onloadend=function(h){f(h.target.result)};d.readAsText(e[0])}c.loadObjFromUrl=function(d){a(d,false,function(e){c.createBrain(new MNIObject(e))})};c.loadObjFromFile=function(d){b(d,function(e){c.createBrain(new MNIObject(e))})};c.loadSpectrumFromUrl=function(e){var d=[];a(e,false,function(f){d=new Spectrum(f);if(c.afterLoadSpectrum!=null){c.afterLoadSpectrum(d)}});return d};c.loadSpectrumFromFile=function(d){b(d,function(f){var e=new Spectrum(f);c.spectrum=e;if(c.afterLoadSpectrum!=null){c.afterLoadSpectrum(e)}if(c.data){c.updateColors(c.data,c.rangeMin,c.rangeMax,c.spectrum)}})}}function BrainCanvas(c){var d=this;var b=c.getContext("2d");var h=new Loader();var i={x:[0,0],y:[0,0],z:[0,0]};d.slices={};d.brightness=0;d.contrast=1;var e={spectral:h.loadSpectrumFromUrl("/spectrum/spectral.txt"),grayscale:h.loadSpectrumFromUrl("/spectrum/gray_scale256.txt")};var f=e.spectral;this.initCanvas=function(k,j){c.width=k;c.height=j;b.fillStyle="#000000";b.fillRect(0,0,k,j)};this.update_space=function(k,m,j,n){var o=j.getScaledSlice(k,m,n);var l=b.createImageData(j[k].length*Math.abs(j[j[k].length_space].step),j[k].height*Math.abs(j[j[k].height_space].step));l.data=createColorMap(f,l.data,o,j.min,j.max,true,d.brightness,d.contrast);return l};function a(j,k){b.fillStyle="#FF0000";b.fillRect(j-2,k-2,4,4)}this.updateXSpace=function(l,j,m){d.slices.xspace=l;var k=d.update_space("xspace",l,j,m);b.putImageData(k,0,0)};this.updateYSpace=function(l,j,m){d.slices.yspace=l;var k=d.update_space("yspace",l,j,m);b.putImageData(k,0,parseInt(j.xspace.height*Math.abs(j[j.xspace.height_space].step)))};this.updateZSpace=function(l,j,m){d.slices.zspace=l;var k=d.update_space("zspace",l,j,m);b.putImageData(k,0,parseInt(j.xspace.height*Math.abs(j[j.xspace.height_space].step)+j.yspace.height*Math.abs(j[j.yspace.height_space].step)))};this.showCrosshairs=function(){a(parseInt(d.slices[d.current_minc.xspace.length_space]*Math.abs(d.current_minc[d.current_minc.xspace.length_space].step)),parseInt(d.slices[d.current_minc.xspace.height_space]*Math.abs(d.current_minc[d.current_minc.xspace.length_space].step)));a(parseInt(d.slices[d.current_minc.yspace.length_space]*Math.abs(d.current_minc[d.current_minc.yspace.length_space].step)),parseInt(d.slices[d.current_minc.yspace.height_space]*Math.abs(d.current_minc[d.current_minc.yspace.height_space].step)+d.current_minc.xspace.height*Math.abs(d.current_minc[d.current_minc.xspace.height_space].step)));a(parseInt(d.slices[d.current_minc.zspace.length_space]*Math.abs(d.current_minc[d.current_minc.zspace.length_space].step)),parseInt(d.slices[d.current_minc.zspace.height_space]*Math.abs(d.current_minc[d.current_minc.zspace.height_space].step)+d.current_minc.xspace.height*Math.abs(d.current_minc[d.current_minc.xspace.height_space].step)+d.current_minc.yspace.height*Math.abs(d.current_minc[d.current_minc.yspace.height_space].step)))};this.updateSlices=function(k,l){d.current_time=l;if(k){var j=d.getSliceNumbersFromPosition(g(k))}else{var j={x:d.slices.xspace,y:d.slices.yspace,z:d.slices.zspace}}d.initCanvas(c.width,c.height);d.updateXSpace(j.x,d.current_minc,l);d.updateYSpace(j.y,d.current_minc,l);d.updateZSpace(j.z,d.current_minc,l);d.showCrosshairs()};this.showMinc=function(j){$(c).siblings("#mincinfo").append("Minc Information: <br>order: "+j.order+"<br>xspace.height: "+j.xspace.height+" yspace.height: "+j.yspace.height+" zspace.height: "+j.zspace.height+"<br> xspace.length: "+j.xspace.length+" yspace.length: "+j.yspace.length+" zspace.length: "+j.zspace.length+"xspace step: "+j.xspace.step+"yspace step: "+j.yspace.step+"zspace step: "+j.zspace.step);d.slices.xspace=parseInt(j.xspace.length/2);d.slices.yspace=parseInt(j.yspace.length/2);d.slices.zspace=parseInt(j.zspace.length/2);d.updateXSpace(d.slices.xspace,j);d.updateYSpace(d.slices.yspace,j);d.updateZSpace(d.slices.zspace,j);d.showCrosshairs()};function g(k){var j;var l;if(k.pageX!=undefined&&k.pageY!=undefined){j=k.pageX;l=k.pageY}else{j=k.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;l=k.clientY+document.body.scrollTop+document.documentElement.scrollTop}j-=c.offsetLeft;l-=c.offsetTop;return{x:j,y:l}}this.getSliceNumbersFromPosition=function(j){d.position=j;if(j.y/Math.abs(d.current_minc[d.current_minc.xspace.height_space].step)<d.current_minc.xspace.height){var k={x:d.slices.xspace};if(d.current_minc.xspace.height_space=="yspace"){k.y=parseInt(j.y/Math.abs(d.current_minc[d.current_minc.xspace.height_space].step));k.z=parseInt(j.x/Math.abs(d.current_minc[d.current_minc.xspace.length_space].step))}else{k.y=parseFloat(j.x/Math.abs(d.current_minc[d.current_minc.xspace.height_space].step));k.z=parseFloat(j.y/Math.abs(d.current_minc[d.current_minc.xspace.length_space].step))}}else{if(j.y<(d.current_minc.xspace.height*Math.abs(d.current_minc[d.current_minc.xspace.height_space].step)+d.current_minc.yspace.height*Math.abs(d.current_minc[d.current_minc.yspace.height_space].step))){var k={y:d.slices.yspace};if(d.current_minc.yspace.height_space=="zspace"){k.x=parseInt(j.x/Math.abs(d.current_minc[d.current_minc.yspace.length_space].step));k.z=parseInt((j.y-d.current_minc.xspace.height*Math.abs(d.current_minc[d.current_minc.xspace.height_space].step))/Math.abs(d.current_minc.zspace.step))}else{k.z=parseInt(j.x/Math.abs(d.current_minc[d.current_minc.yspace.length_space].step));k.x=parseInt((j.y-d.current_minc.xspace.height*Math.abs(d.current_minc[d.current_minc.xspace.height_space].step))/Math.abs(d.current_minc.xspace.step))}}else{var k={z:d.slices.zspace,x:parseInt(j.x/Math.abs(d.current_minc[d.current_minc.zspace.length_space].step)),y:parseInt((j.y-d.current_minc.xspace.height*Math.abs(d.current_minc[d.current_minc.xspace.height_space].step)-d.current_minc.yspace.height*Math.abs(d.current_minc[d.current_minc.yspace.height_space].step))/Math.abs(d.current_minc[d.current_minc.zspace.height_space].step))}}}return k};this.addListeners=function(){c.onmousedown=function(j){d.drag=true};c.onmouseup=function(j){d.drag=false};c.onmousemove=function(j){if(d.drag){d.updateSlices(j)}}};this.showTime=function(){$('<div id="time">Time Index: </div>').appendTo($(c).parent());var j=$($(c).parent().children("#time"));$('<span id="time-value">1</span>').appendTo(j);$('<div id="time-slider" width="'+c.width+'" + height="10"></div>').slider({value:0,min:0,max:d.current_minc.time.space_length,step:1,slide:function(k,l){d.updateSlices(null,l.value);$(j).children("#time-value").html(l.value)}}).appendTo(j)};this.showBrightness=function(){$('<div id="brightness">Brightness: </div>').appendTo($(c).parent());var j=$($(c).parent().children("#brightness"));$('<span id="brightness-value">0%</span>').appendTo(j);$('<div id="brightness-slider" width="100px" + height="10"></div>').slider({value:0,min:-1,max:1,step:0.1,slide:function(k,l){d.brightness=l.value;d.updateSlices(null,d.current_time);$(j).children("#brightness-value").html(l.value*100+"%")}}).appendTo(j)};this.showContrast=function(){$('<div id="contrast">Contrast: </div>').appendTo($(c).parent());var j=$($(c).parent().children("#contrast"));$('<span id="contrast-value">1</span>').appendTo(j);$('<div id="contrast-slider" width="100px" + height="10"></div>').slider({value:1,min:1,max:5,step:0.1,slide:function(k,l){d.contrast=l.value;d.updateSlices(null,d.current_time);$(j).children("#contrast-value").html(l.value)}}).appendTo(j)};this.changeSpectrum=function(j){f=e[j];d.updateSlices(null,d.time)};this.showSpectrum=function(){$('<div id="spectrum">Color Scale</div>').appendTo($(c).parent());var j=$($(c).parent().children("#spectrum"));$('<select id="spectrum-select"><option value="spectral">Spectral</option><option value="grayscale">Gray Scale</option></select>').appendTo(j);$(j).children("#spectrum-select").change(function(k){d.changeSpectrum($(k.target).val())})};this.openFile=function(j){this.current_minc=new Minc(j,null,function(l,m){var k=l.xspace.height*Math.abs(l[l.xspace.height_space].step)+l.yspace.height*Math.abs(l[l.yspace.height_space].step)+l.zspace.height*Math.abs(l[l.zspace.height_space].step);var n=Math.max(l.xspace.length*Math.abs(l[l.xspace.length_space].step),l.yspace.length*Math.abs(l[l.yspace.length_space].step),l.zspace.length*Math.abs(l[l.zspace.length_space].step));d.initCanvas(n,k);d.showMinc(l);d.showBrightness();d.showContrast();d.addListeners();d.showSpectrum();if(l.time){d.showTime()}})}};