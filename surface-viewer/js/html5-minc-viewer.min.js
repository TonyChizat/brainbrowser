Array.prototype.min=function(){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.min.apply(Math,this.slice(c,c+b-1)))}}else{return Math.min.apply(Math,this)}return a.min()};Array.prototype.max=function(d){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.max.apply(Math,this.slice(c,c+b-1)))}}else{return Math.max.apply(Math,this)}return a.max()};function rotateUint16Array90Left(f,d,a){var e=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){e[c*a+b]=f[b*d+(d-c)]}}return e}function rotateUint16Array90Right(f,d,a){var e=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){e[c*a+b]=f[(a-b)*d+c]}}return e}function Minc(b,a,d){var c=this;this.load_headers=function(e){$.ajax({url:e,dataType:"json",data:{minc_headers:true},async:false,success:function(f){c.header=f;c.order=f.order;if(c.order.length==4){c.order=c.order.slice(1,c.order.length);c.time=f.time}c.xspace=f.xspace;c.yspace=f.yspace;c.zspace=f.zspace;c.xspace.name="xspace";c.yspace.name="yspace";c.zspace.name="zspace";c[c.order[0]].height=c[c.order[1]].space_length;c[c.order[0]].height_space=c[c.order[1]];c[c.order[0]].length=c[c.order[2]].space_length;c[c.order[0]].length_space=c[c.order[2]];c[c.order[0]].width=c[c.order[2]].space_length;c[c.order[0]].width_space=c[c.order[2]];c[c.order[1]].height=c[c.order[2]].space_length;c[c.order[1]].height_space=c[c.order[2]];c[c.order[1]].length=c[c.order[0]].space_length;c[c.order[1]].length_space=c[c.order[0]];c[c.order[1]].width=c[c.order[0]].space_length;c[c.order[1]].width_space=c[c.order[0]];c[c.order[2]].height=c[c.order[1]].space_length;c[c.order[2]].height_space=c[c.order[1]];c[c.order[2]].length=c[c.order[0]].space_length;c[c.order[2]].length_space=c[c.order[0]];c[c.order[2]].width=c[c.order[0]].space_length;c[c.order[2]].width_space=c[c.order[0]];c[c.order[0]].offset=c[c.order[1]].space_length*c[c.order[2]].space_length;c[c.order[1]].offset=c[c.order[0]].space_length;c[c.order[2]].offset=c[c.order[0]].space_length;c[c.order[0]].slice_length=c[c.order[0]].height*c[c.order[0]].length},error:function(f,g){throw {request:f,textStatus:g}}})};this.load_data=function(f,h,e){var g=new XMLHttpRequest();g.open("GET",f+"?raw_data=true",true);g.responseType="arraybuffer";g.onreadystatechange=function(){if(g.readyState==4){if(g.status==200){if(g.mozResponseArrayBuffer!=undefined){c.data=new Uint8Array(g.mozResponseArrayBuffer)}else{c.data=new Uint8Array(g.response)}c.min=0;c.max=255;h(c,e)}}};g.send(null)};this.parseData=function(h,k,e){h=h.replace(/\s+$/,"");h=h.replace(/^\s+/,"");var g=h.split(/\s+/);h="";var j=g.length;for(var f=0;f<j;f++){g[f]=parseInt(g[f])}c.min=g.min();c.max=g.max();g=new Uint16Array(g);c.data=g;k(this,e)};this.sliceFromCoordinates=function(f,e,h,g){};this.slice=function(f,e,h){if(c.order==undefined){return false}if(c.time){if(!h){h=0}var t=h*c[c.order[0]].height*c[c.order[0]].length*c[c.order[0]].space_length}else{var t=0}var m=c[f].space_length;var g=c[f].step;var p=c[f].length_space.step;var w=c[f].height_space.step;if(c.order[0]==f){var o=c[f].height*c[f].length;var q=c[f].height;var n=c[f].length;var l=1;var r=n;var s=o;var u=new Uint16Array(o);if(p>0){if(w>0){for(var y=0;y<o;y++){u[y]=this.data[t+s*e+y]}}else{for(var y=q;y>0;y--){for(var x=0;x<n;x++){u[(q-y)*n+x]=this.data[t+s*e+y*n+x]}}}}else{if(w<0){for(var y=0;y<q;y++){for(var x=0;x<n;x++){u[y*n+x]=this.data[t+s*e+y*n+n-x]}}}else{for(var y=q;y>0;y--){for(var x=0;x<n;x++){u[(q-y)*n+x]=this.data[t+s*e+y*n+n-x]}}}}}else{if(c.order[1]==f){var q=c[f].height;var o=c[f].height*c[f].length;var n=c[f].length;var l=1;var r=c[c.order[0]].slice_length;var s=c[c.order[0]].length;var u=new Uint16Array(o);if(w<0){for(var x=0;x<q;x++){for(var v=0;v<n;v++){u[x*(n)+v]=c.data[t+e*s+r*v+x]}}}else{for(var x=q;x>=0;x--){for(var v=0;v<n;v++){u[(q-x)*(n)+v]=c.data[t+e*s+r*v+x]}}}}else{var q=c[f].height;var o=c[f].height*c[f].length;var n=c[f].length;var l=c[c.order[0]].slice_length;var r=c[c.order[0]].length;var s=1;var u=new Uint16Array(o);for(var x=0;x<q;x++){for(var v=0;v<n;v++){u[x*(n)+v]=c.data[t+e+c[c.order[0]].length*x+v*c[c.order[0]].slice_length]}}}}return u};this.nearestNeighboor=function(l,f,r,g,e){var n=new Uint16Array(g*e);var p=f/g;var m=r/e;for(var k=0;k<e;k++){for(var h=0;h<g;h++){var q=Math.floor(h*p);var o=Math.floor(k*m);n[Math.floor(k*g+h)]=l[Math.floor(o*f+q)]}}return n};this.getScaledSlice=function(i,k,h){var j=c.slice(i,k,h);var f=c[i].length;var m=c[i].height;var g=Math.ceil(Math.abs(c[i].length_space.step)*f);var e=Math.ceil(Math.abs(c[i].height_space.step)*m);var l=this.nearestNeighboor(j,f,m,g,e);if(i=="xspace"&&c.xspace.height_space.name=="yspace"){if(c.zspace.step<0){l=rotateUint16Array90Right(l,g,e)}else{l=rotateUint16Array90Left(l,g,e)}}if(i=="yspace"&&c.yspace.height_space.name=="xspace"){if(c.zspace.step<0){l=rotateUint16Array90Right(l,g,e)}else{l=rotateUint16Array90Left(l,g,e)}}if(i=="zspace"&&c.zspace.height_space.name=="xspace"){l=rotateUint16Array90Left(l,g,e)}return l};this.getValueAtLocation=function(e,h,g,f){};if(b!=null&&d!=null){this.load_headers(b);this.load_data(b,d,a)}}function createColorMap(g,a,l,d,j,f,h,c){var g=g.colors;var k=((j-d)+(j-d)/g.length)/g.length;for(var e=0;e<l.length;e++){if(l[e]<=d){var m=0}else{if(l[e]>j){var m=g.length-1}else{var m=parseInt((l[e]-d)/k)}}if(f){var b=255}else{var b=1}a[e*4+0]=b*g[m][0]*c+h*b;a[e*4+1]=b*g[m][1]*c+h*b;a[e*4+2]=b*g[m][2]*c+h*b;a[e*4+3]=b*1}return a}function Spectrum(d){var b=this;function a(e,f,k,m){var g=document.createElement("canvas");jQuery(g).attr("width",e.length);jQuery(g).attr("height",k);var j=g.getContext("2d");if(m){for(var h=0;h<e.length;h++){var l=e.length-1-h;j.fillStyle="rgb("+parseInt(parseFloat(e[l][0])*255)+","+parseInt(parseFloat(e[l][1])*255)+","+parseInt(parseFloat(e[l][2])*255)+")";j.fillRect(h,0,1,f)}}else{for(var h=0;h<e.length;h++){j.fillStyle="rgb("+parseInt(parseFloat(e[h][0])*255)+","+parseInt(parseFloat(e[h][1])*255)+","+parseInt(parseFloat(e[h][2])*255)+")";j.fillRect(h,0,1,f)}}return g}b.createSpectrumCanvas=function(e){if(e==null){e=b.colors}var f=a(e,20,20,false);return f};b.createSpectrumCanvasWithScale=function(i,e,f,j){if(f==null){f=b.colors}var g=a(f,20,40,j);var h=g.getContext("2d");h.fillStyle="#FFFFFF";h.fillRect(0.5,20,1,10);h.fillText(i.toPrecision(3),0.5,40);h.fillRect(g.width/4,20,1,10);h.fillText(((i+e)/4).toPrecision(3),g.width/4,40);h.fillRect(g.width/2,20,1,10);h.fillText(((i+e)/2).toPrecision(3),g.width/2,40);h.fillRect(3*(g.width/4),20,1,10);h.fillText((3*((i+e)/4)).toPrecision(3),3*(g.width/4),40);h.fillRect(g.width-0.5,20,1,10);h.fillText(e.toPrecision(3),g.width-20,40);return g};function c(l){l=l.replace(/\s+$/,"");l=l.replace(/^\s+/,"");var h=l.split(/\n/);var e=new Array();for(var g=0;g<h.length;g++){var j=h[g].split(/\s+/);for(var f=0;f<3;f++){j[f]=parseFloat(j[f])}j.push(1);e.push(j)}b.colors=e;return e}if(d!=undefined){c(d)}}function Loader(){var c=this;function a(d,e,f){jQuery.ajax({type:"GET",url:d,dataType:"text",success:function(g){f(g)},error:function(g,i,h){},data:{},async:e,timeout:100000})}function b(g,f){var d=new FileReader();var e=g.files;d.file=e[0];d.onloadend=function(h){f(h.target.result)};d.readAsText(e[0])}c.loadObjFromUrl=function(d){a(d,false,function(e){c.createBrain(new MNIObject(e))})};c.loadObjFromFile=function(d){b(d,function(e){c.createBrain(new MNIObject(e))})};c.loadSpectrumFromUrl=function(e){var d=[];a(e,false,function(f){d=new Spectrum(f);if(c.afterLoadSpectrum!=null){c.afterLoadSpectrum(d)}});return d};c.loadSpectrumFromFile=function(d){b(d,function(f){var e=new Spectrum(f);c.spectrum=e;if(c.afterLoadSpectrum!=null){c.afterLoadSpectrum(e)}if(c.data){c.updateColors(c.data,c.rangeMin,c.rangeMax,c.spectrum)}})}}function BrainCanvas(b,k,d){var h=this;var f=b.getContext("2d");var e=k.getContext("2d");var c=d.getContext("2d");var l=new Loader();h.slices={};h.brightness=0;h.contrast=1;var g={spectral:l.loadSpectrumFromUrl("/spectrum/spectral-brainview.txt"),grayscale:l.loadSpectrumFromUrl("/spectrum/gray_scale256.txt")};var i=g.spectral;h.spectrums=g;this.initCanvas=function(n,p,m){n.width=p;n.height=m;var o=n.getContext("2d");o.fillStyle="#000000";o.fillRect(0,0,p,m)};this.update_space=function(n,p,o,m,q){var r=m.getScaledSlice(n,o,q);p.data=createColorMap(i,p.data,r,m.min,m.max,true,h.brightness,h.contrast);return p};function a(n,m,o){n.fillStyle="#FF0000";n.fillRect(m-2,o-2,4,4)}this.updateXSpace=function(p,m,q){h.slices.xspace=p;var o=f.createImageData(Math.ceil(Math.abs(m.yspace.step)*m.yspace.space_length),Math.ceil(Math.abs(m.zspace.step)*m.zspace.space_length));var n=h.update_space("xspace",o,p,m,q);f.putImageData(n,0,0)};this.updateYSpace=function(p,m,q){h.slices.yspace=p;var o=e.createImageData(Math.ceil(Math.abs(m.xspace.step)*m.xspace.space_length),Math.ceil(Math.abs(m.zspace.step)*m.zspace.space_length));var n=h.update_space("yspace",o,p,m,q);e.putImageData(n,0,0)};this.updateZSpace=function(p,m,q){h.slices.zspace=p;var o=c.createImageData(Math.ceil(Math.abs(m.xspace.step)*m.xspace.space_length),Math.ceil(Math.abs(m.yspace.step)*m.yspace.space_length));var n=h.update_space("zspace",o,p,m,q);c.putImageData(n,0,0)};this.showCrosshairs=function(){if(h.current_minc.xspace.step<0){var r=(h.current_minc.xspace.space_length-h.slices.xspace)*Math.abs(h.current_minc.yspace.step);var q=r}else{var r=h.slices.xspace*Math.abs(h.current_minc.yspace.step);var q=r}if(h.current_minc.yspace.step>0){var m=(h.current_minc.yspace.space_length-h.slices.yspace)*Math.abs(h.current_minc.yspace.step);var p=h.slices.yspace*Math.abs(h.current_minc.yspace.step)}else{var m=h.slices.yspace*Math.abs(h.current_minc.yspace.step);var p=(h.current_minc.yspace.space_length-h.slices.yspace)*Math.abs(h.current_minc.yspace.step)}if(h.current_minc.zspace.step>0){var n=(h.current_minc.zspace.space_length-h.slices.zspace)*Math.abs(h.current_minc.zspace.step);var o=n}else{var n=h.slices.zspace*Math.abs(h.current_minc.yspace.step);var o=n}a(f,p,n);a(e,q,n);a(c,q,m)};h.showCoordinates=function(){$('<div id="coordinates">x:<span id="x"></span> y:<span id="y"></span> z:<span id="z"></span></div>').appendTo($(b).parent())};h.updateCoordinates=function(m){$(b).siblings("#coordinates").children("#x").html(m.x);$(b).siblings("#coordinates").children("#y").html(m.y);$(b).siblings("#coordinates").children("#z").html(m.z)};this.updateSlices=function(n,o){h.current_time=o;if(n){var m=h.getSliceNumbersFromPosition(j(n))}else{var m={x:h.slices.xspace,y:h.slices.yspace,z:h.slices.zspace}}h.initCanvas(b,b.width,b.height);h.initCanvas(k,k.width,k.height);h.initCanvas(d,d.width,d.height);h.updateXSpace(m.x,h.current_minc,o);h.updateYSpace(m.y,h.current_minc,o);h.updateZSpace(m.z,h.current_minc,o);h.showCrosshairs();h.updateCoordinates(h.sliceToWorldCoordinates(m))};this.showMinc=function(m){$(b).siblings("#mincinfo").append("Minc Information: <br>order: "+m.order+"<br>xspace.height: "+m.xspace.height+" yspace.height: "+m.yspace.height+" zspace.height: "+m.zspace.height+"<br> xspace.length: "+m.xspace.length+" yspace.length: "+m.yspace.length+" zspace.length: "+m.zspace.length+"xspace step: "+m.xspace.step+"yspace step: "+m.yspace.step+"zspace step: "+m.zspace.step);h.slices.xspace=parseInt(m.xspace.length/2);h.slices.yspace=parseInt(m.yspace.length/2);h.slices.zspace=parseInt(m.zspace.length/2);h.updateXSpace(h.slices.xspace,m);h.updateYSpace(h.slices.yspace,m);h.updateZSpace(h.slices.zspace,m);h.showCrosshairs();h.updateCoordinates(m.xspace.length/2,m.yspace.length/2,m.zspace.length/2)};function j(n){var m;var o;if(n.pageX!=undefined&&n.pageY!=undefined){m=n.pageX;o=n.pageY}else{m=n.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;o=n.clientY+document.body.scrollTop+document.documentElement.scrollTop}m-=n.target.offsetLeft;o-=n.target.offsetTop;o=n.target.height-o;return{target:n.target,x:m,y:o}}this.sliceToWorldCoordinates=function(s){var q=h.current_minc.xspace.start;var n=h.current_minc.xspace.step;var p=h.current_minc.yspace.start;var r=h.current_minc.yspace.step;var m=h.current_minc.zspace.start;var o=h.current_minc.zspace.step;return{x:q+s.x*n,y:p+s.y*r,z:m+s.z*o}};this.getSliceNumbersFromPosition=function(m){h.position=m;if(m.target.id==b.id){var n={x:h.slices.xspace,y:parseInt(m.x/Math.abs(h.current_minc.xspace.height_space.step)),z:parseInt(m.y/Math.abs(h.current_minc.xspace.length_space.step))};if(h.current_minc.yspace.step<0){n.y=h.current_minc.yspace.space_length-n.y}if(h.current_minc.zspace.step<0){n.z=h.current_minc.zspace.space_length-n.z}}else{if(m.target.id==k.id){var n={y:h.slices.yspace,x:parseInt(m.x/Math.abs(h.current_minc.xspace.step)),z:parseInt(m.y/Math.abs(h.current_minc.zspace.step))};if(h.current_minc.xspace.step<0){n.x=h.current_minc.xspace.space_length-n.x}if(h.current_minc.zspace.step<0){n.z=h.current_minc.zspace.space_length-n.z}}else{var n={z:h.slices.zspace,x:parseInt(m.x/Math.abs(h.current_minc.zspace.length_space.step)),y:parseInt(m.y/Math.abs(h.current_minc.yspace.step))};if(h.current_minc.xspace.step<0){n.x=h.current_minc.xspace.space_length-n.x}if(h.current_minc.yspace.step<0){n.y=h.current_minc.yspace.space_length-n.y}}}return n};this.addListeners=function(m){m.onmousedown=function(n){h.drag=true};m.onmouseup=function(n){h.drag=false};m.onmousemove=function(n){if(h.drag){h.updateSlices(n)}}};this.showTime=function(){$('<div id="time">Time Index: </div>').appendTo($(b).parent());var m=$($(b).parent().children("#time"));$('<span id="time-value">1</span>').appendTo(m);$('<div id="time-slider" width="'+b.width+'" + height="10"></div>').slider({value:0,min:0,max:h.current_minc.time.space_length,step:1,slide:function(n,o){h.updateSlices(null,o.value);$(m).children("#time-value").html(o.value)}}).appendTo(m)};this.showBrightness=function(){$('<div id="brightness">Brightness: </div>').appendTo($(b).parent());var m=$($(b).parent().children("#brightness"));$('<span id="brightness-value">0%</span>').appendTo(m);$('<div id="brightness-slider" width="100px" + height="10"></div>').slider({value:0,min:-1,max:1,step:0.1,slide:function(n,o){h.brightness=o.value;h.updateSlices(null,h.current_time);$(m).children("#brightness-value").html(o.value*100+"%")}}).appendTo(m)};this.showContrast=function(){$('<div id="contrast">Contrast: </div>').appendTo($(b).parent());var m=$($(b).parent().children("#contrast"));$('<span id="contrast-value">1</span>').appendTo(m);$('<div id="contrast-slider" width="100px" + height="10"></div>').slider({value:1,min:1,max:5,step:0.1,slide:function(n,o){h.contrast=o.value;h.updateSlices(null,h.current_time);$(m).children("#contrast-value").html(o.value)}}).appendTo(m)};this.changeSpectrum=function(m){i=g[m];h.updateSlices(null,h.time)};this.showSpectrum=function(){$('<div id="spectrum">Color Scale</div>').appendTo($(b).parent());var m=$($(b).parent().children("#spectrum"));$('<select id="spectrum-select"><option value="spectral">Spectral</option><option value="grayscale">Gray Scale</option></select>').appendTo(m);$(m).children("#spectrum-select").change(function(n){h.changeSpectrum($(n.target).val())})};this.openFile=function(m){this.current_minc=new Minc(m,null,function(n,p){var u=n.zspace.space_length*Math.abs(n.zspace.step);var t=n.yspace.space_length*Math.abs(n.yspace.step);var o=n.zspace.space_length*Math.abs(n.zspace.step);var s=n.xspace.space_length*Math.abs(n.xspace.step);var q=n.yspace.space_length*Math.abs(n.yspace.step);var r=n.xspace.space_length*Math.abs(n.xspace.step);h.initCanvas(b,t,u);h.initCanvas(k,s,o);h.initCanvas(d,r,q);h.showCoordinates();h.showMinc(n);h.showBrightness();h.showContrast();h.addListeners(b);h.addListeners(k);h.addListeners(d);h.showSpectrum();if(n.time){h.showTime()}})}};