/*! 
 * Copyright (C) 2011 McGill University
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 *   the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
function Data(b){var a=this;a.parse=function(c){c=c.replace(/\s+$/,"");c=c.replace(/^\s+/,"");a.values=c.split(/\s+/);for(var d=0;d<a.values.length;d++){a.values[d]=parseFloat(a.values[d])}a.min=a.values.min();a.max=a.values.max()};this.createColorArray=function(g,o,n,k,r,d,l){var n=n.colors;var q=new Array();var p=((o-g)+(o-g)/n.length)/n.length;for(var h=0;h<a.values.length;h++){if(a.values[h]<=g){if(a.values[h]<g&&!r){var s=-1}else{var s=0}}else{if(a.values[h]>o){if(!r){var s=-1}else{var s=n.length-1}}else{var s=parseInt((a.values[h]-g)/p)}}if(k&&s!=-1){q.push.apply(q,n[n.length-1-s])}else{if(s==-1){if(d.length==4){q.push.apply(q,d)}else{q.push.apply(q,[d[h*4],d[h*4+1],d[h*4+2],d[h*4+3]])}}else{q.push.apply(q,n[s])}}}if(l.num_hemisphere!=2){var m=[];var c=l.indexArray.length;for(var f=0;f<c;f++){m[f*4]=q[l.indexArray[f]*4];m[f*4+1]=q[l.indexArray[f]*4+1];m[f*4+2]=q[l.indexArray[f]*4+2];m[f*4+3]=q[l.indexArray[f]*4+3]}q.nonIndexedColorArray=m}return q};if(b){if(typeof b=="string"){a.parse(b)}else{if(b.values!=undefined){this.values=cloneArray(b.values);this.min=this.values.min();this.max=this.values.max()}else{console.log("copying data length: "+b.length);this.values=b;this.min=b.min();this.max=b.max()}}}}Array.prototype.min=function(){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.min.apply(Math,this.slice(c,c+b-1)))}}else{return Math.min.apply(Math,this)}return a.min()};Array.prototype.max=function(d){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.max.apply(Math,this.slice(c,c+b-1)))}}else{return Math.max.apply(Math,this)}return a.max()};function cloneArray(b){var c=new Array(b.length);for(var a=0;a<c.length;a++){c[a]=b[a]}return c}function rotateUint16Array90Left(g,d,a){var f=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){f[c*a+b]=g[b*d+(d-c)]}}return f}function rotateUint16Array90Right(g,d,a){var f=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){f[c*a+b]=g[(a-b)*d+c]}}return f}function interpolateDataArray(h,c,b,a){console.log(h.values.length);var f=h.values.length;var g=new Array(f);console.log("Percentage: "+b);for(var d=0;d<f;d++){if(a){g[d]=(h.values[d]*(100-b*100)+c.values[d]*(b*100))/100}else{g[d]=(h.values[d]*(100-b*100)+c.values[d]*(b*100))/100}}console.log(g.length);return g}function ColorManager(){function c(m,d,q,j,o,l,n,h,g){var m=m.colors;var p=((o-j)+(o-j)/m.length)/m.length;for(var k=0;k<q.length;k++){if(q[k]<=j){var r=0}else{if(q[k]>o){var r=m.length-1}else{var r=parseInt((q[k]-j)/p)}}if(l){var f=255}else{var f=1}d[k*4+0]=f*m[r][0]*h+n*f;d[k*4+1]=f*m[r][1]*h+n*f;d[k*4+2]=f*m[r][2]*h+n*f;if(g){d[k*4+3]=f*g}else{d[k*4+3]=f}}return d}this.createColorMap=c;function a(l){var d=l[0];for(var h=0;h<l[0].length/4;h++){for(var g=1;g<l.length;g++){var f=d[h*4+3];var k=l[g][h*4+3];d[h*4]=d[h*4]*f+l[g][h*4]*k;d[h*4+1]=d[h*4+1]*f+l[g][h*4+1]*k;d[h*4+2]=d[h*4+2]*f+l[g][h*4+2]*k;d[h*4+3]=f+k}}return d}this.blendColors=a;function b(f,m,k,h){var d=m.length;var l=new Array(d);var j=0;for(var g=0;g<d;g++){l[g]=c(f,new Array(m[g].values.length),m[g].values,m[g].rangeMin,m[g].rangeMax,false,0,1,m[g].alpha)}return a(l)}this.blendColorMap=b}function Spectrum(f){var c=this;var a=new ColorManager();function b(g,q,j,p){var l=document.createElement("canvas");jQuery(l).attr("width",256);jQuery(l).attr("height",j);var m=new Array(256);for(var o=0;o<256;o++){if(p){m[255-o]=o}else{m[o]=o}}g=a.createColorMap(c,[],m,0,255,true,0,1);var h=l.getContext("2d");for(var n=0;n<256;n++){h.fillStyle="rgb("+parseInt(g[n*4])+","+parseInt(g[n*4+1])+","+parseInt(g[n*4+2])+")";h.fillRect(n,0,1,q)}return l}c.createSpectrumCanvas=function(g){if(g==null){g=c.colors}var h=b(g,20,20,false);return h};c.createSpectrumCanvasWithScale=function(l,g,h,m){if(h==null){h=c.colors}var j=b(h,20,40,m);var k=j.getContext("2d");k.fillStyle="#FFA000";k.fillRect(0.5,20,1,10);k.fillText(l.toPrecision(3),0.5,40);k.fillRect(j.width/4,20,1,10);k.fillText(((l+g)/4).toPrecision(3),j.width/4,40);k.fillRect(j.width/2,20,1,10);k.fillText(((l+g)/2).toPrecision(3),j.width/2,40);k.fillRect(3*(j.width/4),20,1,10);k.fillText((3*((l+g)/4)).toPrecision(3),3*(j.width/4),40);k.fillRect(j.width-0.5,20,1,10);k.fillText(g.toPrecision(3),j.width-20,40);return j};function d(n){n=n.replace(/\s+$/,"");n=n.replace(/^\s+/,"");var l=n.split(/\n/);var g=new Array();for(var j=0;j<l.length;j++){var m=l[j].replace(/\s+$/,"").split(/\s+/);for(var h=0;h<m.length;h++){m[h]=parseFloat(m[h])}if(m.length<4){m.push(1)}g.push(m)}c.colors=g;return g}if(f!=undefined){d(f)}}function BrainBrowser(f){if(!(this instanceof BrainBrowser)){return new BrainBrowser(f)}var d=this;this.view_window=$("#brainbrowser");this.model=undefined;this.scene=undefined;this.camera=undefined;var c;for(c in BrainBrowser.modules){if(BrainBrowser.modules.hasOwnProperty(c)){BrainBrowser.modules[c](this)}}
/*! 
   * WebGL test taken from Detector.js by
   * alteredq / http://alteredqualia.com/
   * mr.doob / http://mrdoob.com/
  */
function a(){try{return !!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(g){return false}}function b(){var g;var h='BrainBrowser requires <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>.<br/>';h+=window.WebGLRenderingContext?"Your browser seems to support it, but it is <br/> disabled or unavailable.<br/>":"Your browser does not seem to support it.<br/>";h+='Test your browser\'s WebGL support <a href="http://get.webgl.org/">here</a>.';g=$('<div id="webgl-error">'+h+"</div>");return g}if(a()){this.render()}else{this.view_window.html(b());return}f(this)}BrainBrowser.filetypes={};BrainBrowser.modules={};BrainBrowser.modules.rendering=function(f){var g;var d;var b;var l;var h;var a;var m;var c;f.model=new THREE.Object3D();f.scene=new THREE.Scene();f.camera=new THREE.PerspectiveCamera(30,f.view_window.width()/f.view_window.height(),0.1,5000);f.render=function(){var n=f.view_window;g=new THREE.WebGLRenderer({clearColor:8947848,clearAlpha:1,preserveDrawingBuffer:true});g.setSize(n.width(),n.height());m=g;c=new THREE.AnaglyphEffect(g);c.setSize(n.width(),n.height());n.append(g.domElement);f.camera.position.z=500;d=new THREE.PointLight(16777215);d.position.x=0;d.position.y=0;d.position.z=500;f.scene.add(d);b=new THREE.TrackballControls(f.camera,n[0]);l=new THREE.TrackballControls(d,n[0]);b.zoomSpeed=2;l.zoomSpeed=2;window.onresize=function(){m.setSize(n.width(),n.height());f.camera.aspect=n.width()/n.height();f.camera.updateProjectionMatrix()};window.onresize();k()};f.anaglyphEffect=function(){m=c};f.noEffect=function(){m=g};f.setCamera=function(n,p,o){f.camera.position.set(n,p,o)};f.resetView=function(){var n=f.model;var q;var o,p;b.reset();l.reset();n.position.set(0,0,0);n.rotation.set(0,0,0);for(o=0,p=f.model.children.length;o<p;o++){q=n.children[o];q.visible=true;if(q.centroid){q.position.set(q.centroid.x,q.centroid.y,q.centroid.z)}else{q.position.set(0,0,0)}q.rotation.set(0,0,0)}};f.clearScreen=function(){if(f.model){f.scene.remove(f.model)}f.resetView();f.model=new THREE.Object3D();if(f.afterClearScreen!=undefined){f.afterClearScreen()}};f.updateClearColor=function(n){g.setClearColor(new THREE.Color(n))};f.updateClearColorFromName=function(n){if(n=="white"){f.updateClearColor(16777215)}else{if(n=="black"){f.updateClearColor(0)}else{if(n=="pink"){f.updateClearColor(16711935)}else{f.updateClearColor(8947848)}}}};f.set_fill_mode_wireframe=function(){var o=f.model.children;var p;for(var n=0;n<o.length;n++){p=o[n].material;p.wireframe=true;if(p.emissive){p.emissive.setHex(125269879)}}};f.set_fill_mode_solid=function(){var o=f.model.children;var p;for(var n=0;n<o.length;n++){p=o[n].material;p.wireframe=false;if(p.emissive){p.emissive.setHex(0)}}};f.ZoomInOut=function(n){f.camera.fov*=n;f.camera.updateProjectionMatrix()};function k(p){var n=f.model;var q;var o;requestAnimationFrame(k);a=h||p;h=p;b.update();l.update();q=h-a;o=q*0.00015;if(f.autoRotate){if(f.autoRotate.x){n.rotation.x+=o}if(f.autoRotate.y){n.rotation.y+=o}if(f.autoRotate.z){n.rotation.z+=o}}m.render(f.scene,f.camera)}function j(n,s,r){var q=new THREE.SphereGeometry(2);var p=new THREE.MeshBasicMaterial({color:16711680});var o=new THREE.Mesh(q,p);o.position.set(n,s,r);f.scene.add(o)}};BrainBrowser.modules.color=function(d){var a=new ColorManager();d.updateColors=function(k,j,p,o,l,q,n,m,g){var r=g||{};var h=r.afterUpdate;var f;d.clamped=q;if(n){f=a.blendColorMap(o,k,0,1)}else{f=k.createColorArray(j,p,o,l,q,d.model_data.colorArray,d.model_data)}if(d.model_data.num_hemispheres===2){b(f)}else{c(f)}if(h){h()}if(d.afterUpdateColors!=null){d.afterUpdateColors(k,j,p,o)}};function b(x){var j=d.model;var k=x.length;var f;var o;var n=[];var t=[];var r=j.getChildByName("left");var u=r.geometry.faces;var g=j.getChildByName("right");var h=g.geometry.faces;var v=h.length;var q=u.length;var m;var s,l;var w;var p;f=x.slice(0,k/2);o=x.slice(k/2,k);l=Math.max(q,v);for(s=0;s<l;s++){if(s<q){m=u[s];p=m.vertexColors;w=m.a*4;p[0].setRGB(f[w],f[w+1],f[w+2]);w=m.b*4;p[1].setRGB(f[w],f[w+1],f[w+2]);w=m.c*4;p[2].setRGB(f[w],f[w+1],f[w+2]);if(m.d){w=m.d*4;p[3].setRGB(f[w],f[w+1],f[w+2])}}if(s<v){m=h[s];p=m.vertexColors;w=m.a*4;p[0].setRGB(o[w],o[w+1],o[w+2]);w=m.b*4;p[1].setRGB(o[w],o[w+1],o[w+2]);w=m.c*4;p[2].setRGB(o[w],o[w+1],o[w+2]);if(m.d){w=m.d*4;p[3].setRGB(o[w],o[w+1],o[w+2])}}}r.geometry.colorsNeedUpdate=true;g.geometry.colorsNeedUpdate=true}function c(f){var p=d.model;var r=f.length;var m=[];var t;var h;var s,k;var g;var l;var o,n;var q;g=p.children;for(o=0,q=g.length;o<q;o++){k=g[o].geometry.faces;for(n=0,q=k.length;n<q;n++){s=k[n];l=s.vertexColors;t=s.a*4;l[0].setRGB(f[t],f[t+1],f[t+2]);t=s.b*4;l[0].setRGB(f[t],f[t+1],f[t+2]);t=s.c*4;l[0].setRGB(f[t],f[t+1],f[t+2]);if(s.d){t=s.d*4;l[0].setRGB(f[t],f[t+1],f[t+2])}}g[o].geometry.colorsNeedUpdate=true}}};BrainBrowser.modules.data=function(g){var d=BrainBrowser.filetypes;g.loadModelFromUrl=function(k,m){var j=m||{};var n;var h;var l=j.format||"MNIObject";b(k,m,function(o){n=k.split("/");h=n[n.length-1];g.displayObjectFile(new d[l](o),h,j)})};g.loadModelFromFile=function(o,l){var j=l||{};var n;var h;var m;var k=j.format||"MNIObject";c(o,j,function(p){n=o.value.split("\\");h=n[n.length-1];m=new d[k](p);if(m.objectClass!=="__FAIL__"){g.displayObjectFile(m,h,j)}else{if(j.onError!=undefined){j.onError()}}})};g.loadDataFromUrl=function(j,h){b(j,null,function(m,k){var l;g.model_data.data=new Data(m);l=g.model_data.data;l.fileName=h;a(l.min,l.max);if(g.afterLoadData!=undefined){g.afterLoadData(l.rangeMin,l.rangeMax,l)}g.updateColors(l,l.rangeMin,l.rangeMax,g.spectrum)})};g.loadDataFromFile=function(n){var j=n.files[0].name;var k=g.model_data;var h=k.positionArray;var l=h.length;var m=function(p){var o=new Data(p);o.fileName=j;if(o.values.length<l/4){alert("Number of numbers in datafile lower than number of vertices Vertices"+l/3+" data values:"+o.values.length);return -1}else{k.data=o}a(o.min,o.max);if(g.afterLoadData!=null){g.afterLoadData(o.rangeMin,o.rangeMax,o)}g.updateColors(o,o.rangeMin,o.rangeMax,g.spectrum,g.flip,g.clamped)};if(j.match(/.*.mnc|.*.nii/)){f(j,m)}else{c(n,null,m)}};g.loadSpectrumFromUrl=function(k,m){var j=m||{};var l=j.afterLoadSpectrum;var h;b(k,j,function(n){h=new Spectrum(n);g.spectrum=h;if(l){l()}if(g.afterLoadSpectrum!=null){g.afterLoadSpectrum(h)}if(g.model_data.data){g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum,g.flip,g.clamped)}})};g.loadSpectrumFromFile=function(k){var h;var j=g.model_data;c(k,null,function(l){h=new Spectrum(l);g.spectrum=h;if(g.afterLoadSpectrum!=null){g.afterLoadSpectrum(h)}if(j.data){g.updateColors(j.data,j.data.rangeMin,j.data.rangeMax,g.spectrum,g.flip,g.clamped)}})};g.blend=function(k){var h=g.blendData;var l=h.length;var j;h[0].alpha=k;h[1].alpha=1-k;for(j=2;j<l;j++){h[j].alpha=0}g.updateColors(h,null,null,g.spectrum,g.flip,g.clamped,true)};g.loadSeriesDataFromFile=function(m){var l=m.files.length;var k=m.files;var h;var j;g.seriesData=new Array(l);g.seriesData.numberFiles=l;for(j=0;j<l;j++){h=new FileReader();h.file=k[j];h.onloadend=(function(o,n){return function(p){console.log(p.target.result.length);console.log(n);g.seriesData[n]=new Data(p.target.result);g.seriesData[n].fileName=o.name}})(h.file,j);h.readAsText(k[j])}g.setupSeries()};g.setupSeries=function(){var k=g.model_data;var j=g.seriesData;var h=g.model_data.positionArray;$('<div id="series">Series: </div>').appendTo("#surface_choice");var l=$("#series");$('<span id="series-value">0</span>').appendTo(l);$('<div id="series-slider" width="100px" + height="10"></div>').slider({value:0,min:0,max:j.numberFiles-1,step:0.1,slide:function(m,n){if(n.value-Math.floor(n.value)<0.01){k.data=j[n.value]}else{if(j[0].fileName.match("pval.*")){k.data=new Data(interpolateDataArray(j[Math.floor(n.value)],j[Math.floor(n.value)+1],(n.value-Math.floor(n.value)),true))}else{k.data=new Data(interpolateDataArray(j[Math.floor(n.value)],j[Math.floor(n.value)+1],(n.value-Math.floor(n.value))))}}if(j[0].fileName.match("mt.*")){$("#age_series").html("Age: "+(n.value*3+5).toFixed(1))}else{if(j[0].fileName.match("pval.*")){$("#age_series").html("Age: "+(n.value*1+10))}}$(l).children("#series-value").html(n.value);if(k.data.values.length<h.length/4){console.log("Number of numbers in datafile lower than number of vertices Vertices"+h.length/3+" data values:"+k.data.values.length);return -1}a(k.data.min,k.data.max);if(g.afterLoadData!=null){g.afterLoadData(k.data.rangeMin,k.data.rangeMax,k.data)}g.updateColors(k.data,k.data.rangeMin,k.data.rangeMax,g.spectrum,g.flip,g.clamped);return null}}).appendTo(l)};g.loadBlendDataFromFile=function(o){var n=o.files.length;var m=o.files;var h;var l,j;g.blendData=new Array(n);g.blendData.numberFiles=n;for(l=0;l<n;l++){h=new FileReader();h.file=m[l];h.onloadend=(function(p,k){return function(q){g.blendData[k]=new Data(q.target.result);g.blendData.alpha=1/n;g.blendData[k].fileName=p.name;for(j=0;j<2;j++){if(g.blendData[j]==undefined){console.log("not done yet");return}}a(g.blendData[0].values.min(),g.blendData[0].values.max(),g.blendData[0]);a(g.blendData[1].values.min(),g.blendData[1].values.max(),g.blendData[1]);if(g.afterLoadData!=null){g.afterLoadData(null,null,g.blendData,true)}g.blend($(".blend_slider").slider("value"))}})(h.file,l);h.readAsText(m[l])}g.setupBlendColors()};g.rangeChange=function(l,h,m,n){var k=n||{};var j=k.afterChange;var o=g.model_data.data;o.rangeMin=l;o.rangeMax=h;g.updateColors(o,o.rangeMin,o.rangeMax,g.spectrum,g.flip,m);if(j){j()}if(g.afterRangeChange!=null){g.afterRangeChange(l,h)}};function b(j,l,m){var h=l||{};var k=h.beforeLoad;if(k){k()}jQuery.ajax({type:"GET",url:j,dataType:"text",success:function(n){m(n)},error:function(n,p,o){alert("Failure in loadFromURL: "+p)},data:{},timeout:100000})}function c(o,m,n){var l=o.files;if(l.length===0){return}var j=m||{};var k=j.beforeLoad;var h=new FileReader();h.file=l[0];if(k){k()}h.onloadend=function(p){n(p.target.result)};h.readAsText(l[0])}function f(h,l){var n;var k;var m;var j;n=new XMLHttpRequest();if(h.match(/.*.mnc/)){n.open("POST","/minc/volume_object_evaluate",false)}else{n.open("POST","/nii/volume_object_evaluate",false)}m=new FormData(document.getElementById("datafile-form"));n.send(m);var j=n.response;l(j)}function a(k,h,j){if(!j){j=g.model_data.data}if(!j.fixRange){j.rangeMin=k;j.rangeMax=h}}};BrainBrowser.modules.models=function(h){h.displayObjectFile=function(o,l,n){var m=n||{};var p=m.renderDepth;var k=m.afterDisplay;if(o.objectClass=="P"&&o.numberVertices==81924){a(o,p)}else{if(o.objectClass=="P"){c(o,l,p)}else{if(o.objectClass=="L"){d(o,l,false,p)}else{alert("Object file not supported")}}}if(h.afterDisplayObject!=undefined){h.afterDisplayObject(h.model)}if(k){k()}};function a(n,o){var k=h.model;var m,l;h.model_data=n;m=j(n.left);m.name="left";m.model_num=0;l=j(n.right);l.name="right";l.model_num=1;k.add(m);k.add(l);h.scene.add(k)}function j(o){var w=o.positionArray;var n=o.indexArray;var v={};var l={};var t;var p,q;var u,s,m,r,k;for(p=0,q=w.length;p+2<q;p+=3){f(v,w[p],w[p+1],w[p+2])}l.x=v.minX+0.5*(v.maxX-v.minX);l.y=v.minY+0.5*(v.maxY-v.minY);l.z=v.minY+0.5*(v.maxZ-v.minZ);u=new THREE.Geometry();s=u.vertices;for(p=0,q=w.length;p+2<q;p+=3){s.push(new THREE.Vector3(w[p]-l.x,w[p+1]-l.y,w[p+2]-l.z))}m=u.faces;for(p=0,q=n.length;p+2<q;p+=3){t=new THREE.Face3(n[p],n[p+1],n[p+2]);t.vertexColors=[new THREE.Color(),new THREE.Color(),new THREE.Color()];m.push(t)}u.computeFaceNormals();u.computeVertexNormals();r=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:526344,vertexColors:THREE.VertexColors});k=new THREE.Mesh(u,r);k.centroid=l;k.position.set(l.x,l.y,l.z);return k}function d(n,k,p,o){var l=h.model;var m=g(n,p);m.name=k;if(o){m.renderDepth=o}l.add(m);h.scene.add(l)}function g(z,l){var t=z;var u=[];var G=[];var w=[];var D={};var x={};var F,E,C,v;var m=t.nitems;var p;var n;var o;var B;var s=[];var r;var q,y,A;var H;h.model_data=t;for(F=0;F<m;F++){if(F===0){p=0}else{p=t.endIndicesArray[F-1]}u.push(t.indexArray[p]);n=t.indexArray;o=t.endIndicesArray[F];for(C=p+1;C<o-1;C++){u.push(n[C]);u.push(n[C])}u.push(n[o-1])}H=h.model_data.positionArray;for(E=0,v=u.length;E<v;E++){f(D,H[u[E]*3],H[u[E]*3+1],H[u[E]*3+2])}x.x=D.minX+0.5*(D.maxX-D.minX);x.y=D.minY+0.5*(D.maxY-D.minY);x.z=D.minY+0.5*(D.maxZ-D.minZ);if(!l){for(E=0,v=u.length;E<v;E++){G.push(new THREE.Vector3(H[u[E]*3]-x.x,H[u[E]*3+1]-x.y,H[u[E]*3+2]-x.z))}if(t.colorArray.length===4){for(F=0;F<numberVertices;F++){s.push(0.5,0.5,0.7,1)}}else{s=h.model_data.colorArray;for(E=0,v=u.length;E<v;E++){r=new THREE.Color();r.setRGB(s[u[E]*4],s[u[E]*4+1],s[u[E]*4+2]);w.push(r)}}}else{G=h.model_data.meshPositionArray;w=h.model_data.meshColorArray}q=new THREE.Geometry();q.vertices=G;q.colors=w;q.colorsNeedUpdate=true;y=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});A=new THREE.Line(q,y,THREE.LinePieces);A.position.set(x.x,x.y,x.z);A.centroid=x;return A}function c(n,k,m){var p=h.model;var r;var o,q;var s=n;var l=s.shapes;h.model_data=s;if(l){for(o=0,q=l.length;o<q;o++){r=b(h.model_data.shapes[o]);r.name=h.model_data.shapes[o].name;p.add(r)}}else{r=b(h.model_data);r.name=k;p.add(r)}if(h.afterCreate!=undefined){h.afterCreate(h.model_data)}h.scene.add(p)}function b(p){var k=p.positionArray;var m=p.indexArray;var o=[];var y=p.colorArray;var B,A,s;var r;var n=false;var q,z,D;var w=[];var u;var l;var C=p.faces;var t;var v;var x;if(y.length==4){n=true;r=new THREE.Color();r.setRGB(y[0],y[1],y[2])}w=[];q=new THREE.Geometry();for(B=0,s=k.length/3;B<s;B++){q.vertices.push(new THREE.Vector3(k[B*3],k[B*3+1],k[B*3+2]));if(!n){r=new THREE.Color();r.setRGB(y[B*4],y[B*4+1],y[B*4+2])}w.push(r)}l=q.faces;if(C&&C.length>0){t=C.length;for(B=0;B<t;B++){v=C[B];x=v.length;if(x<3){continue}if(x<=4){if(x<=3){u=new THREE.Face3(v[0],v[1],v[2])}else{if(x===4){u=new THREE.Face4(v[0],v[1],v[2],v[3])}}u.vertexColors=[w[u.a],w[u.b],w[u.c]];if(x>3){u.vertexColors[3]=w[u.d]}l.push(u)}else{for(A=1;A+1<x;A++){u=new THREE.Face3(v[0],v[A],v[A+1]);u.vertexColors=[w[u.a],w[u.b],w[u.c]];l.push(u)}}}}else{for(B=0;B+2<m.length;B+=3){u=new THREE.Face3(m[B],m[B+1],m[B+2]);u.vertexColors[0]=w[u.a];u.vertexColors[1]=w[u.b];u.vertexColors[2]=w[u.c];q.faces.push(u)}}q.computeFaceNormals();q.computeVertexNormals();q.colorsNeedUpdate=true;z=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:526344,vertexColors:THREE.VertexColors});D=new THREE.Mesh(q,z);if(h.loading){$(h.loading).html("Buffers Loaded")}return D}h.changeShapeTransparency=function(m,n){var k=brain.getChildByName(m);var l;if(k){l=k.material;l.opacity=n;if(n===1){l.transparent=false}else{l.transparent=true}}};function f(l,k,n,m){if(!l.minX||l.minX>k){l.minX=k}if(!l.maxX||l.maxX<k){l.maxX=k}if(!l.minY||l.minY>n){l.minY=n}if(!l.maxY||l.maxY<n){l.maxY=n}if(!l.minZ||l.minZ>m){l.minZ=m}if(!l.maxZ||l.maxZ<m){l.maxZ=m}}};BrainBrowser.modules.picking=function(a){a.click=function(k,g){var p=a.view_window;var l=a.camera;var h=p.offset();var n=new THREE.Projector();var m=new THREE.Raycaster();var f=((k.clientX-h.left+$(window).scrollLeft())/p.width())*2-1;var d=-((k.clientY-h.top+$(window).scrollTop())/p.height())*2+1;var c=new THREE.Vector3(f,d,1);var j,b,o;n.unprojectVector(c,l);m.set(l.position,c.sub(l.position).normalize());j=m.intersectObject(a.model,true);if(j.length>0){b=j[0];o={vertex:b.face.a,point:new THREE.Vector3(b.point.x,b.point.y,b.point.z),object:b.object};return g(k,o)}else{$(a.pickInfoElem).html("--nothing--");return false}}};BrainBrowser.modules.ui=function(b){var a=document;b.keyPressedCallback=function(d){var c=false;switch(d.which){case 38:b.ZoomInOut(1.1);c=true;break;case 40:b.ZoomInOut(1/1.1);c=true;break;case 32:b.separateHemispheres();c=true;break}return !c};b.setupBlendColors=function(){console.log("Blend colors has run "+b.blendData.numberFiles);$("#blend").remove();$('<div id="blend">Blend ratios: </div>').appendTo("#surface_choice");var c=$("#blend");$('<span id="blend_value'+i+'">0</span>').appendTo(c);$('<div class="blend_slider" id="blend_slider'+i+'" width="100px" + height="10"></div>').slider({value:0,min:0.1,max:0.99,value:0.5,step:0.01,slide:function(d,f){b.blend($(this).slider("value"))}}).appendTo(c)};b.getImageUrl=function(){var g=a.createElement("canvas");var c=a.getElementById("spectrum_canvas");var h=g.getContext("2d");var d=new Image();g.width=view_window.width();g.height=view_window.height();function f(){var j=new Image();j.onload=function(){h.drawImage(j,0,0);window.open(g.toDataURL(),"screenshot")};j.src=c.toDataURL()}d.onload=function(){h.drawImage(d,0,0);if(c){f()}else{window.open(g.toDataURL(),"screenshot")}};d.src=renderer.domElement.toDataURL()}};BrainBrowser.modules.views=function(b){b.setupView=function(c){var d=b.getViewParams();b.resetView();if(b.model_data&&b.model_data.num_hemispheres===2){switch(d.view){case"superior":b.superiorView();break;case"medial":b.medialView();break;case"anterior":b.anteriorView();break;case"inferior":b.inferiorView();break;case"lateral":b.lateralView();break;case"posterior":b.posteriorView();break;default:b.superiorView();break}}if(b.model.getChildByName("left")){if(d.left){b.leftHemisphereVisible(true)}else{b.leftHemisphereVisible(false)}}if(b.model.getChildByName("right")){if(d.right){b.rightHemisphereVisible(true)}else{b.rightHemisphereVisible(false)}}};b.leftHemisphereVisible=function(c){b.model.getChildByName("left").visible=c};b.rightHemisphereVisible=function(c){b.model.getChildByName("right").visible=c};b.getInfoForVertex=function(d){var c=b.model_data.getVertexInfo(d);var f={vertex:c.vertex,point:new THREE.Vector3(c.position_vector[0],c.position_vector[1],c.position_vector[2])};return f};b.medialView=function(d){var c=b.model;if(b.model_data.num_hemispheres==2){c.getChildByName("left").position.x-=100;c.getChildByName("left").rotation.z-=a(90);c.getChildByName("right").position.x+=100;c.getChildByName("right").rotation.z+=a(90);c.rotation.x+=a(-90)}};b.lateralView=function(g){var c=b.model;var f,d;if(b.model_data.num_hemispheres==2){f=c.getChildByName("left");d=c.getChildByName("right");f.position.x-=100;f.rotation.z+=a(-90);d.position.x+=100;d.rotation.z+=a(90);c.rotation.x+=a(90);c.rotation.y+=a(180)}};b.superiorView=function(){};b.inferiorView=function(){b.model.rotation.y+=a(180)};b.anteriorView=function(c){b.resetView();b.model.rotation.x+=a(-90);b.model.rotation.z+=a(180)};b.posteriorView=function(c){b.resetView();b.model.rotation.x+=a(-90)};b.separateHemispheres=function(c){if(b.model_data.num_hemispheres==2){b.model.children[0].position.x-=1;b.model.children[1].position.x+=1}};function a(c){return c*Math.PI/180}};var surfview=(function(){function a(c,d){var b=document.getElementById("brainbrowser");b.onselectstart=function(){return false};b.onmousedown=function(){return false};$(".button").button();$(".buttonset").buttonset();BrainBrowser(function(h){h.getViewParams=function(){return{view:$("[name=hem_view]:checked").val(),left:$("#left_hem_visible").is(":checked"),right:$("#right_hem_visible").is(":checked")}};h.afterLoadSpectrum=function(j){var k=j.createSpectrumCanvasWithScale(0,100,null);var l=document.getElementById("color_bar");k.id="spectrum_canvas";if(!l){$('<div id="color_bar"></div>').html(k).appendTo("#data-range")}else{$(l).html(k)}h.spectrumObj=j};h.afterDisplayObject=function(k){var j;var l;$("#shapes").html("");if(k.children.length>0){for(l=0;l<k.children.length;l++){j=k.children[l];$('<div id="shape_'+l+'" data-shape-name="'+j.name+'" class="shape"><h4>Shape '+(l+1)+"</h4>Name: "+j.name+'<br />Opacity: <div class="opacity-slider slider"  data-shape-name='+j.name+"></div></div>").appendTo("#shapes")}}h.afterClearScreen=function(){$("#shapes").html("")};$(".opacity-slider").slider({value:100,min:-1,max:101,slide:function(m,o){var n=$(m.target).attr("data-shape-name");var p=$(m.target).slider("value");p=Math.min(100,Math.max(0,p))/100;h.changeShapeTransparency(n,p)}})};$("#resetview").click(h.setupView);$(".view_button").change(h.setupView);$("[name=hem_view]").change(h.setupView);h.clamped=true;h.flip=false;h.clearScreen();$("body").keydown(h.keyPressedCallback);$("#range-slider").slider({range:true,min:-50,max:50,value:[-10,10],slide:function(l,m){var k=parseFloat(m.values[0]);var j=parseFloat(m.values[1]);h.rangeChange(k,j,$("#clamp_range").is(":checked"))},step:0.1});h.afterRangeChange=function(l,j){$("#data-range-min").val(l);$("#data-range-max").val(j);var k=h.spectrumObj.createSpectrumCanvasWithScale(l,j,null);k.id="spectrum_canvas";$("#color_bar").html($(k))};function g(n){var j=$("#data-range");var q=false;var p=['<div id="data_range_multiple"><ul>'];var k=[];var n=n.length?n:[n];var l,m;$(j).html("");for(l=0,m=n.length;l<m;l++){p.push('<li><a href="#data_file'+l+'">'+n[l].fileName+"</a></li>");k.push('<div id="data_file'+l+'" class="box full_box">');k.push("<h4>Thresholding</h4>");k.push('Min: <input class="range-box" id="data-range-min" type="text" name="range_min" size="5" ><br />');k.push('<div id="range-slider+'+l+'" data-blend-index="'+l+'" class="slider"></div>');k.push('Max: <input class="range-box" id="data-range-max" type="text" name="range_max" size="5" >');k.push('<input type="checkbox" class="button" id="fix_range"><label for="fix_range">Fix Range</label>');k.push('<input type="checkbox" class="button" id="clamp_range" checked="true"><label for="clamp_range">Clamp range</label>');k.push('<input type="checkbox" class="button" id="flip_range"><label for="flip_range">Flip Colors</label>');k.push("</div>")}p.push("</ul>");$(j).html(p.join("")+k.join("")+"</div>");$(j).tabs();$("#data_range").find(".slider").each(function(r,s){$(s).slider({range:true,min:n[0].values.min(),max:n[0].values.max(),values:[n[r].rangeMin,n[r].rangeMax],step:0.1,slide:function(u,v){if(!q){var t=$(this).attr("data-blend-index");q=true;n[0].rangeMin=v.values[0];n[0].rangeMax=v.values[1];h.model_data.data=n[0];h.rangeChange(n[0].rangeMin,n[0].rangeMax,h.clamped,{afterChange:function(){q=false}})}}})});function o(t){var s=$("#data-range-min").val();var r=$("#data-range-max").val();$(t.target).siblings(".slider").slider("values",0,s);$(t.target).siblings(".slider").slider("values",1,r);h.rangeChange(s,r,$(t.target).siblings("#clamp_range").is(":checked"))}$("#data-range-min").change(o);$("#data-range-max").change(o);$("#fix_range").click(function(r,s){h.fixRange=$(e.target).is(":checked")});$("#clamp_range").change(function(t){var s=parseFloat($(t.target).siblings("#data-range-min").val());var r=parseFloat($(t.target).siblings("#data-range-max").val());if($(t.target).is(":checked")){h.rangeChange(s,r,true)}else{h.rangeChange(s,r,false)}});$("#flip_range").change(function(r){h.flip=$(r.target).is(":checked");h.updateColors(h.model_data.data,h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.spectrum,h.flip,h.clamped)})}h.afterLoadData=function(l,k,m,j){if(j){g(m)}else{g(m);$("#range-slider").slider("values",0,parseFloat(l));$("#range-slider").slider("values",1,parseFloat(k));h.afterRangeChange(l,k)}};$("#meshmode").change(function(j){if($(j.target).is(":checked")){h.set_fill_mode_wireframe()}else{h.set_fill_mode_solid()}});$("#threedee").change(function(j){if($(j.target).is(":checked")){h.anaglyphEffect()}else{h.noEffect()}});$("#clearshapes").click(function(j){h.clearScreen()});$("#openImage").click(function(j){h.getImageUrl()});function f(j){if($("#autorotate").is(":checked")){h.autoRotate={};h.autoRotate.x=$("#autorotateX").is(":checked");h.autoRotate.y=$("#autorotateY").is(":checked");h.autoRotate.z=$("#autorotateZ").is(":checked")}else{h.autoRotate=false}}$("#autorotate-controls").children().change(f);$("#autorotate").change(f);$(".range-box").keypress(function(j){if(j.keyCode=="13"){h.rangeChange(parseFloat($("#data-range-min").val()),parseFloat($("#data-range-max").val()))}});$("#clear_color").change(function(k){var j=$(k.target).val();h.updateClearColorFromName(j)});$("#examples").click(function(l){var j=$(l.target).attr("data-example-name");var m,k;switch(j){case"basic":$("#loading").show();h.clearScreen();h.loadModelFromUrl("/models/surf_reg_model_both.obj",{format:"MNIObject",afterDisplay:function(){$("#loading").hide()}});break;case"punkdti":$("#loading").show();h.clearScreen();h.loadModelFromUrl("/models/dti.obj",{format:"MNIObject",renderDepth:999,afterDisplay:function(){$("#loading").hide()}});h.loadModelFromUrl("/models/left_color.obj",{format:"MNIObject"});h.loadModelFromUrl("/models/right_color.obj",{format:"MNIObject"});break;case"realct":$("#loading").show();h.clearScreen();h.loadModelFromUrl("/models/realct.obj",{format:"MNIObject",afterDisplay:function(){h.loadDataFromUrl("/models/realct.txt","cortical thickness");$("#loading").hide()}});break;case"car":$("#loading").show();h.clearScreen();h.loadModelFromUrl("/models/car.obj",{format:"WavefrontObj",afterDisplay:function(){$("#loading").hide()}});h.setCamera(0,0,100);m=new THREE.Matrix4();m.makeRotationX(-0.25*Math.PI);k=new THREE.Matrix4();k.makeRotationY(0.4*Math.PI);h.model.applyMatrix(k.multiply(m));break;case"plane":$("#loading").show();h.clearScreen();h.loadModelFromUrl("/models/dlr_bigger.streamlines.obj",{format:"MNIObject"});h.loadModelFromUrl("/models/dlr.model.obj",{format:"MNIObject",afterDisplay:function(){$("#loading").hide()}});h.setCamera(0,0,75);m=new THREE.Matrix4();m.makeRotationX(-0.25*Math.PI);k=new THREE.Matrix4();k.makeRotationY(0.4*Math.PI);h.model.applyMatrix(k.multiply(m))}return false});$("#obj_file_format").change(function(){var j=$("#obj_file_format").closest("#obj_file_select").find("#obj_file_format option:selected").val();if(j==="freesurfer"){$("#format_hints").html('You can use <a href="http://surfer.nmr.mgh.harvard.edu/fswiki/mris_convert" target="_blank">mris_convert</a> to convert your binary surface files into .asc format.')}else{$("#format_hints").html("")}});$("#obj_file_submit").click(function(){var j=$("#obj_file_format").closest("#obj_file_select").find("#obj_file_format option:selected").val();h.loadModelFromFile(document.getElementById("objfile"),{format:j,beforeLoad:function(){$("#loading").show()},afterDisplay:function(){$("#loading").hide()},onError:function(){$("#loading").hide()}});return false});$("#datafile").change(function(){h.loadDataFromFile(document.getElementById("datafile"))});$("#spectrum").change(function(){h.loadSpectrumFromFile(document.getElementById("spectrum"))});$("#dataseriesfile").change(function(){h.loadSeriesDataFromFile(document.getElementById("dataseriesfile"))});$("#datablendfile").change(function(){h.loadBlendDataFromFile(document.getElementById("datablendfile"))});if(typeof c=="string"&&c!=""){h.loadModelFromUrl(c,d)}else{if(typeof c=="function"){c(h)}}})}return{init:a,}})();BrainBrowser.filetypes.WavefrontObj=function(A){var m=this;var v;var j=[];var o=[];var y=[];var c,z,q;var h;var d;var b,s;var u,p,t,r,w,f;var g,a,x;A=A.split("\n");m.shapes=[];v={name:A.name|"undefined",faces:[],positionArray:[],colorArray:[],indexArray:[],texIndexArray:[],normalIndexArray:[]};m.shapes.push(v);for(u=0,f=A.length;u<f;u++){h=A[u].split(/\s+/);d=h[0];b=h.length;if(!(d.match("#"))||h===""){switch(d){case"o":case"g":v={name:h[1],faces:[],positionArray:[],colorArray:[],indexArray:[],texIndexArray:[],normalIndexArray:[]};m.shapes.push(v);break;case"v":j.push(parseFloat(h[1]));j.push(parseFloat(h[2]));j.push(parseFloat(h[3]));break;case"vt":for(p=1;p<b;p++){o.push(parseFloat(h[p]))}break;case"vn":y.push(parseFloat(h[1]));y.push(parseFloat(h[2]));y.push(parseFloat(h[3]));break;case"f":g=[];c=v.indexArray;z=v.texIndexArray;q=v.normalIndexArray;for(t=1;t<4;t++){x=h[t].split("/");g.push(parseInt(x[0])-1);c.push(parseInt(x[0],10)-1);z.push(parseInt(x[1],10)-1);if(x[2]){q.push(parseInt(x[2],10)-1)}}if(b>=4){while(t<b){x=h[t].split("/");g.push(parseInt(x[0],10)-1);w=v.indexArray.length;c.push(v.indexArray[w-1]);c.push(v.indexArray[w-3]);c.push(x[0]-1);t++}}v.faces.push(g);break}}}s=m.shapes.length;for(r=0;r<s;r++){a=m.shapes[r];a.positionArray=j;if(a.colorArray.length===0){a.colorArray=[0.8,0.8,0.8,1]}}m.objectClass="P";m.vertexArray=j;m.texCoordArray=o};BrainBrowser.filetypes.FreeSurferAsc=function(j){var h=this;var b;var c=[];var p=[];var m=[];var o;var a;var q;var r;var n,k;var d;var g,f;j=j.split("\n");h.shapes=[];b={name:j.name|"undefined",faces:[],positionArray:[],colorArray:[],indexArray:[],texIndexArray:[],normalIndexArray:[]};h.shapes.push(b);o=j[1].split(/\s+/);a=parseInt(o[0],10);q=parseInt(o[1],10);for(g=2;g<a+2;g++){r=j[g].split(/\s+/);c.push(parseFloat(r[0]));c.push(parseFloat(r[1]));c.push(parseFloat(r[2]))}for(g=a+2;g<a+q+2;g++){r=j[g].split(/\s+/);n=[];n.push(parseInt(r[0],10));n.push(parseInt(r[1],10));n.push(parseInt(r[2],10));b.faces.push(n)}d=h.shapes.length;for(f=0;f<d;f++){k=h.shapes[f];k.positionArray=c;if(k.colorArray.length==0){k.colorArray=[0.8,0.8,0.8,1]}}h.objectClass="P";h.vertexArray=c};BrainBrowser.filetypes.MNIObject=function(d){var k;var h=this;function b(n){var m=n.replace(/\s+$/,"");var o=m.replace(/^\s+/,"");h.num_hemispheres=1;k=o.split(/\s+/).reverse();h.objectClass=k.pop();if(h.objectClass==="P"){f();h.numberVertices=parseInt(k.pop());g();l();h.nitems=parseInt(k.pop())}else{if(h.objectClass==="L"){f();h.numberVertices=parseInt(k.pop());g();h.nitems=parseInt(k.pop())}else{h.objectClass="__FAIL__";return}}j();c();a();if(h.objectClass=="P"){if(h.positionArray.length==81924*3){h.brainSurface=true;h.split_hemispheres()}}}function f(){if(h.objectClass=="P"){h.surfaceProperties={ambient:parseFloat(k.pop()),diffuse:parseFloat(k.pop()),specular_reflectance:parseFloat(k.pop()),specular_scattering:parseFloat(k.pop()),transparency:parseFloat(k.pop())}}else{if(h.objectClass=="L"){h.surfaceProperties={width:k.pop()}}}}function g(){var n=[];var m=h.numberVertices;var o,p;for(o=0;o<m;o++){for(p=0;p<3;p++){n.push(parseFloat(k.pop()))}}h.positionArray=n}function l(){var p=[];var m=h.numberVertices;var q,o;for(q=0;q<m;q++){for(o=0;o<3;o++){p.push(parseFloat(k.pop()))}}h.normalArray=p}function j(){var o=[];var p=parseInt(k.pop(),10);var m,q,n;if(p===0){for(m=0;m<4;m++){o.push(parseFloat(k.pop()))}}else{if(p===1){for(q=0,n=h.numberPolygons;q<n;q++){for(m=0;m<4;m++){o.push(parseFloat(k.pop()))}}}else{if(p===2){for(q=0,n=h.numberVertices;q<n;q++){for(m=0;m<4;m++){o.push(parseFloat(k.pop()))}}}else{throw new Error("colorFlag not valid in that file")}}}h.colorFlag=p;h.colorArray=o}function c(){var m=h.nitems;var o=h.endIndicesArray;var o=[];var q,n;for(q=0,n=h.nitems;q<n;q++){o.push(parseInt(k.pop(),10))}h.endIndicesArray=o}function a(){var p=k.length;var n=[];var m;var o,q;for(o=0,q=k.length;o<p;o++){m=parseInt(k.pop(),10);n.push(m)}h.indexArray=n}h.split_hemispheres=function(){var o={};var u={};var v;var n;var m,q,p,t;var r,s;m=h.positionArray.length;o.positionArray=h.positionArray.slice(0,m/2);u.positionArray=h.positionArray.slice(m/2,m);q=h.indexArray.length;o.indexArray=h.indexArray.slice(0,q/2);u.indexArray=h.indexArray.slice(q/2,q);v=u.indexArray;n=q/3/2/2;for(r=0,s=v.length;r<s;r++){v[r]=v[r]-2-n}p=h.normalArray.length;o.normalArray=h.normalArray.slice(0,p/2);u.normalArray=h.normalArray.slice(p/2,p);o.colorFlag=h.colorFlag;u.colorFlag=h.colorFlag;if(h.colorFlag===0||h.colorFlag===1){o.colorArray=h.colorArray;u.colorArray=h.colorArray}else{t=h.colorArray.length;o.colorArray=h.colorArray.slice(0,t/2);u.colorArray=h.colorArray.slice(t/2+1,-1)}o.numberVertices=h.numberVertices/2;u.numberVertices=h.numberVertices/2;o.numberPolygons=h.numberPolygons/2;u.numberPolygons=h.numberPolygons/2;h.num_hemispheres=2;h.left=o;h.right=u};h.getVertexInfo=function(n){var m=[h.positionArray[n*3],h.positionArray[n*3+1],h.positionArray[n*3+2]];return{vertex:n,position_vector:m}};if(d){b(d)}};