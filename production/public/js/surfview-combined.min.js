/*! 
 * Copyright (C) 2011 McGill University
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 *   the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
if(!Array.prototype.min){Array.prototype.min=function(){var b=this[0];var a,c;for(a=1,c=this.length;a<c;a++){if(this[a]<b){b=this[a]}}return b}}if(!Array.prototype.max){Array.prototype.max=function(){var a=this[0];var b,c;for(b=1,c=this.length;b<c;b++){if(this[b]>a){a=this[b]}}return a}}function ColorManager(){this.createColorMap=function(l,a,q,g,n,k,m,f,d){var l=l.colors;var c=l.length;var p=((n-g)+(n-g)/c)/c;var h,j;var r;var o;var b;for(h=0,j=q.length;h<j;h++){o=q[h];if(o<=g){r=0}else{if(q[h]>n){r=c-1}else{r=parseInt((o-g)/p)}}if(k){b=255}else{b=1}a[h*4+0]=b*l[r][0]*f+m*b;a[h*4+1]=b*l[r][1]*f+m*b;a[h*4+2]=b*l[r][2]*f+m*b;if(d){a[h*4+3]=b*d}else{a[h*4+3]=b}}return a};this.blendColors=function(k){var a=k[0];var g,d,f,c;var b,h;for(g=0,f=k[0].length/4;g<f;g++){for(d=1,c=k.length;d<c;d++){b=a[g*4+3];h=k[d][g*4+3];a[g*4]=a[g*4]*b+k[d][g*4]*h;a[g*4+1]=a[g*4+1]*b+k[d][g*4+1]*h;a[g*4+2]=a[g*4+2]*b+k[d][g*4+2]*h;a[g*4+3]=b+h}}return a};this.blendColorMap=function(h,g,j,c){var f=g.length;var a=new Array(f);var k=0;var d;var b;for(d=0;d<f;d++){b=g[d];a[d]=this.createColorMap(h,new Array(b.values.length),b.values,b.rangeMin,b.rangeMax,false,0,1,b.alpha)}return blendColors(a)}}function Spectrum(f){var c=this;var a=new ColorManager();function b(g,q,j,p){var l=document.createElement("canvas");var m=new Array(256);var o,n;var h;$(l).attr("width",256);$(l).attr("height",j);for(o=0;o<256;o++){if(p){m[255-o]=o}else{m[o]=o}}g=a.createColorMap(c,[],m,0,255,true,0,1);h=l.getContext("2d");for(n=0;n<256;n++){h.fillStyle="rgb("+parseInt(g[n*4],10)+", "+parseInt(g[n*4+1])+", "+parseInt(g[n*4+2])+")";h.fillRect(n,0,1,q)}return l}c.createSpectrumCanvas=function(g){var h;if(g===null){g=c.colors}h=b(g,20,20,false);return h};c.createSpectrumCanvasWithScale=function(l,g,h,m){var j;var k;if(h===null){h=c.colors}j=b(h,20,40,m);k=j.getContext("2d");k.fillStyle="#FFA000";k.fillRect(0.5,20,1,10);k.fillText(l.toPrecision(3),0.5,40);k.fillRect(j.width/4,20,1,10);k.fillText(((l+g)/4).toPrecision(3),j.width/4,40);k.fillRect(j.width/2,20,1,10);k.fillText(((l+g)/2).toPrecision(3),j.width/2,40);k.fillRect(3*(j.width/4),20,1,10);k.fillText((3*((l+g)/4)).toPrecision(3),3*(j.width/4),40);k.fillRect(j.width-0.5,20,1,10);k.fillText(g.toPrecision(3),j.width-20,40);return j};function d(p){p=p.replace(/^\s+/,"").replace(/\s+$/,"");var n=p.split(/\n/);var g=[];var m,h,l,j;var o;for(m=0,l=n.length;m<l;m++){o=n[m].replace(/\s+$/,"").split(/\s+/);j=o.length;for(h=0;h<j;h++){o[h]=parseFloat(o[h])}if(j<4){o.push(1)}g.push(o)}c.colors=g;return g}if(f!=undefined){d(f)}}function BrainBrowser(b){if(!(this instanceof BrainBrowser)){return new BrainBrowser(b)}this.view_window=document.getElementById("brainbrowser");this.model=undefined;BrainBrowser.rendering(this);var a;for(a in BrainBrowser.core){if(BrainBrowser.core.hasOwnProperty(a)){BrainBrowser.core[a](this)}}for(a in BrainBrowser.modules){if(BrainBrowser.modules.hasOwnProperty(a)){BrainBrowser.modules[a](this)}}for(a in BrainBrowser.plugins){if(BrainBrowser.plugins.hasOwnProperty(a)){BrainBrowser.plugins[a](this)}}if(BrainBrowser.webgl_enabled()){this.render()}else{alert("Can't get WebGL constext. Exiting.");return}b(this)}BrainBrowser.core={};BrainBrowser.modules={};BrainBrowser.plugins={};BrainBrowser.data={};BrainBrowser.filetypes={};
/*! 
 * WebGL test taken from Detector.js by
 * alteredq / http://alteredqualia.com/
 * mr.doob / http://mrdoob.com/
*/
BrainBrowser.webgl_enabled=function(){try{return !!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(a){return false}};BrainBrowser.webGLErrorMessage=function(){var a;var b='BrainBrowser requires <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>.<br/>';b+=window.WebGLRenderingContext?"Your browser seems to support it, but it is <br/> disabled or unavailable.<br/>":"Your browser does not seem to support it.<br/>";b+='Test your browser\'s WebGL support <a href="http://get.webgl.org/">here</a>.';a=document.createElement("div");a.id="webgl-error";a.innerHTML=b;return a};BrainBrowser.core.color=function(d){var a=new ColorManager();d.updateColors=function(k,j,p,n,l,q,m,g){var r=g||{};var h=r.afterUpdate;var f;function o(t){var s;if(d.model_data.num_hemispheres===2){b(t)}else{if(k.apply_to_shape){s=[d.model.getChildByName(k.apply_to_shape,true)]}else{s=d.model.children}c(t,s)}if(d.afterUpdateColors){d.afterUpdateColors(k,j,p,n)}if(h){h()}}d.clamped=q;if(m){o(a.blendColorMap(n,k,0,1))}else{k.createColorArray(j,p,n,l,q,d.model_data.colorArray,d.model_data,o)}};function b(x){var j=d.model;var k=x.length;var f;var o;var n=[];var t=[];var r=j.getChildByName("left");var u=r.geometry.faces;var g=j.getChildByName("right");var h=g.geometry.faces;var v=h.length;var q=u.length;var m;var s,l;var w;var p;f=x.slice(0,k/2);o=x.slice(k/2,k);l=Math.max(q,v);for(s=0;s<l;s++){if(s<q){m=u[s];p=m.vertexColors;w=m.a*4;p[0].setRGB(f[w],f[w+1],f[w+2]);w=m.b*4;p[1].setRGB(f[w],f[w+1],f[w+2]);w=m.c*4;p[2].setRGB(f[w],f[w+1],f[w+2]);if(m.d){w=m.d*4;p[3].setRGB(f[w],f[w+1],f[w+2])}}if(s<v){m=h[s];p=m.vertexColors;w=m.a*4;p[0].setRGB(o[w],o[w+1],o[w+2]);w=m.b*4;p[1].setRGB(o[w],o[w+1],o[w+2]);w=m.c*4;p[2].setRGB(o[w],o[w+1],o[w+2]);if(m.d){w=m.d*4;p[3].setRGB(o[w],o[w+1],o[w+2])}}}r.geometry.colorsNeedUpdate=true;g.geometry.colorsNeedUpdate=true}function c(f,g){var p=f.length;var m=[];var t;var h;var s,k;var l;var o,n;var r,q;for(o=0,r=g.length;o<r;o++){k=g[o].geometry.faces;for(n=0,q=k.length;n<q;n++){s=k[n];l=s.vertexColors;t=s.a*4;l[0].setRGB(f[t],f[t+1],f[t+2]);t=s.b*4;l[1].setRGB(f[t],f[t+1],f[t+2]);t=s.c*4;l[2].setRGB(f[t],f[t+1],f[t+2]);if(s.d){t=s.d*4;l[3].setRGB(f[t],f[t+1],f[t+2])}}g[o].geometry.colorsNeedUpdate=true}}};BrainBrowser.modules.loader=function(g){var j=BrainBrowser.data.Data;var f=BrainBrowser.filetypes;g.loadModelFromUrl=function(n,p){var m=p||{};var q;var l;var o=m.format||"MNIObject";c(n,p,function(r){q=n.split("/");l=q[q.length-1];f[o](r,function(s){if(s.objectClass!=="__FAIL__"){if(!b(m)){g.displayObjectFile(s,l,m)}}else{if(m.onError!=undefined){m.onError()}}})})};g.loadModelFromFile=function(q,o){var m=o||{};var p;var l;var n=m.format||"MNIObject";a(q,m,function(r){p=q.value.split("\\");l=p[p.length-1];f[n](r,function(s){if(s.objectClass!=="__FAIL__"){g.displayObjectFile(s,l,m)}else{if(m.onError!=undefined){m.onError()}}})})};g.loadDataFromUrl=function(o,m,n){var l=n||{};c(o,l,function(q,p){j(q,function(t){if(b(l)){return}var r=l.max===undefined?t.max:l.max;var s=l.min===undefined?t.min:l.min;g.model_data.data=t;t.fileName=m;t.apply_to_shape=l.shape;d(s,r);if(g.afterLoadData){g.afterLoadData(t.rangeMin,t.rangeMax,t)}g.updateColors(t,t.rangeMin,t.rangeMax,g.spectrum,g.flip,g.clamped,false,l)})})};g.loadDataFromFile=function(s,p){var n=p||{};var m=s.files[0].name;var o=g.model_data;var l=o.positionArray;var q=l.length;var r=function(t){j(t,function(w){var u=n.max===undefined?w.max:n.max;var v=n.min===undefined?w.min:n.min;w.fileName=m;w.apply_to_shape=n.shape;if(w.values.length<q/4){alert("Number of numbers in datafile lower than number of vertices Vertices"+q/3+" data values:"+w.values.length);return -1}else{o.data=w}d(v,u);if(g.afterLoadData){g.afterLoadData(w.rangeMin,w.rangeMax,w)}g.updateColors(w,w.rangeMin,w.rangeMax,g.spectrum,g.flip,g.clamped,false,n)})};if(m.match(/.*.mnc|.*.nii/)){k(m,r)}else{a(s,null,r)}};g.loadSpectrumFromUrl=function(n,p){var m=p||{};var o=m.afterLoadSpectrum;var l;c(n,m,function(q){l=new Spectrum(q);g.spectrum=l;if(o){o()}if(g.afterLoadSpectrum!=null){g.afterLoadSpectrum(l)}if(g.model_data&&g.model_data.data){g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum,g.flip,g.clamped)}})};g.loadSpectrumFromFile=function(n){var l;var m=g.model_data;a(n,null,function(o){l=new Spectrum(o);g.spectrum=l;if(g.afterLoadSpectrum!=null){g.afterLoadSpectrum(l)}if(m.data){g.updateColors(m.data,m.data.rangeMin,m.data.rangeMax,g.spectrum,g.flip,g.clamped)}})};g.blend=function(n){var l=g.blendData;var o=l.length;var m;l[0].alpha=n;l[1].alpha=1-n;for(m=2;m<o;m++){l[m].alpha=0}g.updateColors(l,null,null,g.spectrum,g.flip,g.clamped,true)};g.loadSeriesDataFromFile=function(p){var o=p.files.length;var n=p.files;var l;var m;g.seriesData=new Array(o);g.seriesData.numberFiles=o;for(m=0;m<o;m++){l=new FileReader();l.file=n[m];l.onloadend=(function(r,q){return function(s){console.log(s.target.result.length);console.log(q);j(s.target.result,function(t){g.seriesData[q]=t;g.seriesData[q].fileName=r.name})}})(l.file,m);l.readAsText(n[m])}g.setupSeries()};function h(r,n,m,l){console.log(r.values.length);var o;var p=r.values.length;var q=new Array(p);console.log("Percentage: "+m);for(o=0;o<p;o++){if(l){q[o]=(r.values[o]*(100-m*100)+n.values[o]*(m*100))/100}else{q[o]=(r.values[o]*(100-m*100)+n.values[o]*(m*100))/100}}console.log(q.length);return q}g.loadBlendDataFromFile=function(r,q){var p=r.files.length;var o=r.files;var l;var n,m;g.blendData=new Array(p);g.blendData.numberFiles=p;for(n=0;n<p;n++){l=new FileReader();l.file=o[n];l.onloadend=(function(t,s){return function(u){j(u.target.result,function(v){g.blendData[s]=v;g.blendData.alpha=1/p;g.blendData[s].fileName=t.name;for(m=0;m<2;m++){if(g.blendData[m]==undefined){console.log("not done yet");return}}d(g.blendData[0].values.min(),g.blendData[0].values.max(),g.blendData[0]);d(g.blendData[1].values.min(),g.blendData[1].values.max(),g.blendData[1]);if(g.afterLoadData!=null){g.afterLoadData(null,null,g.blendData,true)}g.blend(q)})}})(l.file,n);l.readAsText(o[n])}g.setupBlendColors()};g.rangeChange=function(o,l,p,q){var n=q||{};var m=n.afterChange;var r=g.model_data.data;r.rangeMin=o;r.rangeMax=l;g.updateColors(r,r.rangeMin,r.rangeMax,g.spectrum,g.flip,p,false,n);if(m){m()}if(g.afterRangeChange!=null){g.afterRangeChange(o,l)}};function c(m,o,p){var l=o||{};var n=l.beforeLoad;if(n){n()}jQuery.ajax({type:"GET",url:m,dataType:"text",success:function(q){if(!b(l)){p(q)}},error:function(q,s,r){alert("Failure in loadFromURL: "+s)},data:{},timeout:100000})}function a(r,p,q){var o=r.files;if(o.length===0){return}var m=p||{};var n=m.beforeLoad;var l=new FileReader();l.file=o[0];if(n){n()}l.onloadend=function(s){q(s.target.result)};l.readAsText(o[0])}function k(l,o){var q;var n;var p;var m;q=new XMLHttpRequest();if(l.match(/.*.mnc/)){q.open("POST","/minc/volume_object_evaluate",false)}else{q.open("POST","/nii/volume_object_evaluate",false)}p=new FormData(document.getElementById("datafile-form"));q.send(p);var m=q.response;o(m)}function d(n,l,m){if(!m){m=g.model_data.data}if(!m.fixRange){m.rangeMin=n;m.rangeMax=l}}function b(o){var l=o||{};var p=l.cancel||{};var m=p.test;var q=p.cleanup;var n=false;if(m&&m()){n=true;if(q){q()}}return n}};BrainBrowser.core.models=function(h){h.displayObjectFile=function(o,l,n){var m=n||{};var p=m.renderDepth;var k=m.afterDisplay;if(o.objectClass=="P"&&o.numberVertices==81924){a(o,p)}else{if(o.objectClass=="P"){c(o,l,p)}else{if(o.objectClass=="L"){d(o,l,false,p)}else{alert("Object file not supported")}}}if(h.afterDisplayObject){h.afterDisplayObject(h.model)}if(k){k()}};function a(n,o){var k=h.model;var m,l;h.model_data=n;m=j(n.left);m.name="left";m.model_num=0;l=j(n.right);l.name="right";l.model_num=1;k.add(m);k.add(l)}function j(o){var w=o.positionArray;var n=o.indexArray;var v={};var l={};var t;var p,q;var u,s,m,r,k;for(p=0,q=w.length;p+2<q;p+=3){f(v,w[p],w[p+1],w[p+2])}l.x=v.minX+0.5*(v.maxX-v.minX);l.y=v.minY+0.5*(v.maxY-v.minY);l.z=v.minY+0.5*(v.maxZ-v.minZ);u=new THREE.Geometry();s=u.vertices;for(p=0,q=w.length;p+2<q;p+=3){s.push(new THREE.Vector3(w[p]-l.x,w[p+1]-l.y,w[p+2]-l.z))}m=u.faces;for(p=0,q=n.length;p+2<q;p+=3){t=new THREE.Face3(n[p],n[p+1],n[p+2]);t.vertexColors=[new THREE.Color(),new THREE.Color(),new THREE.Color()];m.push(t)}u.computeFaceNormals();u.computeVertexNormals();r=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:526344,vertexColors:THREE.VertexColors});k=new THREE.Mesh(u,r);k.centroid=l;k.position.set(l.x,l.y,l.z);return k}function d(n,k,p,o){var l=h.model;var m=g(n,p);m.name=k;if(o){m.renderDepth=o}l.add(m)}function g(z,l){var t=z;var u=[];var G=[];var w=[];var D={};var x={};var F,E,C,v;var m=t.nitems;var p;var n;var o;var B;var s=[];var r;var q,y,A;var H;h.model_data=t;for(F=0;F<m;F++){if(F===0){p=0}else{p=t.endIndicesArray[F-1]}u.push(t.indexArray[p]);n=t.indexArray;o=t.endIndicesArray[F];for(C=p+1;C<o-1;C++){u.push(n[C]);u.push(n[C])}u.push(n[o-1])}H=h.model_data.positionArray;for(E=0,v=u.length;E<v;E++){f(D,H[u[E]*3],H[u[E]*3+1],H[u[E]*3+2])}x.x=D.minX+0.5*(D.maxX-D.minX);x.y=D.minY+0.5*(D.maxY-D.minY);x.z=D.minY+0.5*(D.maxZ-D.minZ);if(!l){for(E=0,v=u.length;E<v;E++){G.push(new THREE.Vector3(H[u[E]*3]-x.x,H[u[E]*3+1]-x.y,H[u[E]*3+2]-x.z))}if(t.colorArray.length===4){for(F=0;F<numberVertices;F++){s.push(0.5,0.5,0.7,1)}}else{s=h.model_data.colorArray;for(E=0,v=u.length;E<v;E++){r=new THREE.Color();r.setRGB(s[u[E]*4],s[u[E]*4+1],s[u[E]*4+2]);w.push(r)}}}else{G=h.model_data.meshPositionArray;w=h.model_data.meshColorArray}q=new THREE.Geometry();q.vertices=G;q.colors=w;q.colorsNeedUpdate=true;y=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});A=new THREE.Line(q,y,THREE.LinePieces);A.position.set(x.x,x.y,x.z);A.centroid=x;return A}function c(n,k,m){var p=h.model;var r;var o,q;var s=n;var l=s.shapes;h.model_data=s;if(l){for(o=0,q=l.length;o<q;o++){r=b(h.model_data.shapes[o]);r.name=h.model_data.shapes[o].name||(k.split(".")[0]+"_"+o);p.add(r)}}else{r=b(h.model_data);r.name=k;p.add(r)}if(h.afterCreate!=undefined){h.afterCreate(h.model_data)}}function b(p){var k=p.positionArray;var m=p.indexArray;var o=[];var y=p.colorArray;var E,D,s;var r;var n=false;var q,z,G;var w=[];var u;var l;var F=p.faces;var t;var v;var x;var C,B,A;if(y.length===4){n=true;C=y[0];B=y[1];A=y[2]}w=[];q=new THREE.Geometry();for(E=0,s=k.length/3;E<s;E++){q.vertices.push(new THREE.Vector3(k[E*3],k[E*3+1],k[E*3+2]));r=new THREE.Color();if(!n){r.setRGB(y[E*4],y[E*4+1],y[E*4+2])}else{r.setRGB(C,B,A)}w.push(r)}l=q.faces;if(F&&F.length>0){t=F.length;for(E=0;E<t;E++){v=F[E];x=v.length;if(x<3){continue}if(x<=4){if(x<=3){u=new THREE.Face3(v[0],v[1],v[2])}else{if(x===4){u=new THREE.Face4(v[0],v[1],v[2],v[3])}}u.vertexColors=[w[u.a],w[u.b],w[u.c]];if(x>3){u.vertexColors[3]=w[u.d]}l.push(u)}else{for(D=1;D+1<x;D++){u=new THREE.Face3(v[0],v[D],v[D+1]);u.vertexColors=[w[u.a],w[u.b],w[u.c]];l.push(u)}}}}else{for(E=0;E+2<m.length;E+=3){u=new THREE.Face3(m[E],m[E+1],m[E+2]);u.vertexColors[0]=w[u.a];u.vertexColors[1]=w[u.b];u.vertexColors[2]=w[u.c];q.faces.push(u)}}q.computeFaceNormals();q.computeVertexNormals();q.colorsNeedUpdate=true;z=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:526344,vertexColors:THREE.VertexColors});G=new THREE.Mesh(q,z);return G}function f(l,k,n,m){if(!l.minX||l.minX>k){l.minX=k}if(!l.maxX||l.maxX<k){l.maxX=k}if(!l.minY||l.minY>n){l.minY=n}if(!l.maxY||l.maxY<n){l.maxY=n}if(!l.minZ||l.minZ>m){l.minZ=m}if(!l.maxZ||l.maxZ<m){l.maxZ=m}}};BrainBrowser.rendering=function(h){var j;var c=new THREE.Scene();var g;var f=new THREE.PerspectiveCamera(30,h.view_window.offsetWidth/h.view_window.offsetHeight,0.1,5000);var b;var p;var k;var a;var o;var d;h.model=new THREE.Object3D();c.add(h.model);h.render=function(){var q=h.view_window;j=new THREE.WebGLRenderer({clearColor:8947848,clearAlpha:1,preserveDrawingBuffer:true});j.setSize(q.offsetWidth,q.offsetHeight);o=j;d=new THREE.AnaglyphEffect(j);d.setSize(q.offsetWidth,q.offsetHeight);q.appendChild(j.domElement);f.position.z=500;g=new THREE.PointLight(16777215);g.position.set(0,0,500);c.add(g);b=new THREE.TrackballControls(f,q);p=new THREE.TrackballControls(g,q);b.zoomSpeed=2;p.zoomSpeed=2;h.autoRotate={};window.onresize=function(){o.setSize(q.offsetWidth,q.offsetHeight);f.aspect=q.offsetWidth/q.offsetHeight;f.updateProjectionMatrix()};window.onresize();m()};h.canvasDataURL=function(){return j.domElement.toDataURL()};h.anaglyphEffect=function(){o=d};h.noEffect=function(){o=j};h.setCamera=function(q,s,r){f.position.set(q,s,r)};h.resetView=function(){var r=h.model;var u;var s,t;var q=new THREE.Matrix4();q.getInverse(r.matrix);b.reset();p.reset();r.applyMatrix(q);for(s=0,t=h.model.children.length;s<t;s++){u=r.children[s];u.visible=true;if(u.centroid){u.position.set(u.centroid.x,u.centroid.y,u.centroid.z)}else{u.position.set(0,0,0)}u.rotation.set(0,0,0)}};h.clearScreen=function(){var q=h.model.children;while(q.length>0){h.model.remove(q[0])}h.resetView();if(h.afterClearScreen!=undefined){h.afterClearScreen()}};h.updateClearColor=function(q){j.setClearColorHex(q,1)};h.set_fill_mode_wireframe=function(){var r=h.model.children;var s;for(var q=0;q<r.length;q++){s=r[q].material;s.wireframe=true;if(s.emissive){s.emissive.setHex(125269879)}}};h.set_fill_mode_solid=function(){var r=h.model.children;var s;for(var q=0;q<r.length;q++){s=r[q].material;s.wireframe=false;if(s.emissive){s.emissive.setHex(0)}}};h.ZoomInOut=function(q){f.fov*=q;f.updateProjectionMatrix()};h.click=function(x,u){var B=h.view_window;var v=n(B);var z=new THREE.Projector();var y=new THREE.Raycaster();var t=((x.clientX-v.left+window.scrollX)/B.offsetWidth)*2-1;var s=-((x.clientY-v.top+window.scrollY)/B.offsetHeight)*2+1;var r=new THREE.Vector3(t,s,1);var w,q,A;z.unprojectVector(r,f);y.set(f.position,r.sub(f.position).normalize());w=y.intersectObject(h.model,true);if(w.length>0){q=w[0];A={vertex:q.face.a,point:new THREE.Vector3(q.point.x,q.point.y,q.point.z),object:q.object};return u(x,A)}else{return false}};function n(q){var s=0;var r=0;while(q.offsetParent){s+=q.offsetTop;r+=q.offsetLeft;q=q.offsetParent}return{top:s,left:r}}function m(s){var q=h.model;var t;var r;requestAnimationFrame(m);a=k||s;k=s;b.update();p.update();t=k-a;r=t*0.00015;if(h.autoRotate.x){q.rotation.x+=r}if(h.autoRotate.y){q.rotation.y+=r}if(h.autoRotate.z){q.rotation.z+=r}o.render(c,f)}function l(q,v,u){var t=new THREE.SphereGeometry(2);var s=new THREE.MeshBasicMaterial({color:16711680});var r=new THREE.Mesh(t,s);r.position.set(q,v,u);c.add(r)}};BrainBrowser.plugins.ui=function(c){var b=document;c.keyPressedCallback=function(f){var d=false;switch(f.which){case 38:c.ZoomInOut(1/1.1);d=true;break;case 40:c.ZoomInOut(1.1);d=true;break;case 32:c.separateHemispheres();d=true;break}return !d};c.setupBlendColors=function(){console.log("Blend colors has run "+c.blendData.numberFiles);$("#blend").remove();$('<div id="blend">Blend ratios: </div>').appendTo("#surface_choice");var d=$("#blend");$('<span id="blend_value'+i+'">0</span>').appendTo(d);$('<div class="blend_slider" id="blend_slider'+i+'" width="100px" + height="10"></div>').slider({value:0,min:0.1,max:0.99,value:0.5,step:0.01,slide:function(f,g){c.blend($(this).slider("value"))}}).appendTo(d)};c.setupSeries=function(){var g=c.model_data;var f=c.seriesData;var d=c.model_data.positionArray;$('<div id="series">Series: </div>').appendTo("#surface_choice");var h=$("#series");$('<span id="series-value">0</span>').appendTo(h);$('<div id="series-slider" width="100px" + height="10"></div>').slider({value:0,min:0,max:f.numberFiles-1,step:0.1,slide:function(j,k){if(k.value-Math.floor(k.value)<0.01){g.data=f[k.value]}else{if(f[0].fileName.match("pval.*")){g.data=new Data(interpolateDataArray(f[Math.floor(k.value)],f[Math.floor(k.value)+1],(k.value-Math.floor(k.value)),true))}else{g.data=new Data(interpolateDataArray(f[Math.floor(k.value)],f[Math.floor(k.value)+1],(k.value-Math.floor(k.value))))}}if(f[0].fileName.match("mt.*")){$("#age_series").html("Age: "+(k.value*3+5).toFixed(1))}else{if(f[0].fileName.match("pval.*")){$("#age_series").html("Age: "+(k.value*1+10))}}$(h).children("#series-value").html(k.value);if(g.data.values.length<d.length/4){console.log("Number of numbers in datafile lower than number of vertices Vertices"+d.length/3+" data values:"+g.data.values.length);return -1}initRange(g.data.min,g.data.max);if(c.afterLoadData!=null){c.afterLoadData(g.data.rangeMin,g.data.rangeMax,g.data)}c.updateColors(g.data,g.data.rangeMin,g.data.rangeMax,c.spectrum,c.flip,c.clamped);return null}}).appendTo(h)};c.getImageUrl=function(){var g=c.view_window;var j=b.createElement("canvas");var d=b.getElementById("spectrum_canvas");var k=j.getContext("2d");var f=new Image();j.width=g.offsetWidth;j.height=g.offsetHeight;function h(){var l=new Image();l.onload=function(){k.drawImage(l,0,0);window.open(j.toDataURL(),"screenshot")};l.src=d.toDataURL()}f.onload=function(){k.drawImage(f,0,0);if(d){h()}else{window.open(j.toDataURL(),"screenshot")}};f.src=c.canvasDataURL()};c.getViewParams=function(){return{view:$("[name=hem_view]:checked").val(),left:$("#left_hem_visible").is(":checked"),right:$("#right_hem_visible").is(":checked")}};function a(d){c.autoRotate.x=$("#autorotateX").is(":checked");c.autoRotate.y=$("#autorotateY").is(":checked");c.autoRotate.z=$("#autorotateZ").is(":checked")}$("body").keydown(c.keyPressedCallback);$("#clear_color").change(function(d){c.updateClearColor(parseInt($(d.target).val(),16))});$("#resetview").click(c.setupView);$(".view_button").change(c.setupView);$("[name=hem_view]").change(c.setupView);$("#meshmode").change(function(d){if($(d.target).is(":checked")){c.set_fill_mode_wireframe()}else{c.set_fill_mode_solid()}});$("#threedee").change(function(d){if($(d.target).is(":checked")){c.anaglyphEffect()}else{c.noEffect()}});$("#openImage").click(function(d){c.getImageUrl()});$("#autorotate-controls").children().change(a);$("#autorotate").change(a)};BrainBrowser.modules.views=function(b){b.changeShapeTransparency=function(f,g){var c=b.model.getChildByName(f);var d;if(c){d=c.material;d.opacity=g;if(g===1){d.transparent=false}else{d.transparent=true}}};b.setupView=function(c){var d=b.getViewParams();b.resetView();if(b.model_data&&b.model_data.num_hemispheres===2){switch(d.view){case"superior":b.superiorView();break;case"medial":b.medialView();break;case"anterior":b.anteriorView();break;case"inferior":b.inferiorView();break;case"lateral":b.lateralView();break;case"posterior":b.posteriorView();break;default:b.superiorView();break}}if(b.model.getChildByName("left")){if(d.left){b.leftHemisphereVisible(true)}else{b.leftHemisphereVisible(false)}}if(b.model.getChildByName("right")){if(d.right){b.rightHemisphereVisible(true)}else{b.rightHemisphereVisible(false)}}};b.leftHemisphereVisible=function(c){b.model.getChildByName("left").visible=c};b.rightHemisphereVisible=function(c){b.model.getChildByName("right").visible=c};b.getInfoForVertex=function(d){var c=b.model_data.getVertexInfo(d);var f={vertex:c.vertex,point:new THREE.Vector3(c.position_vector[0],c.position_vector[1],c.position_vector[2])};return f};b.medialView=function(d){var c=b.model;if(b.model_data.num_hemispheres==2){c.getChildByName("left").position.x-=100;c.getChildByName("left").rotation.z-=a(90);c.getChildByName("right").position.x+=100;c.getChildByName("right").rotation.z+=a(90);c.rotation.x+=a(-90)}};b.lateralView=function(g){var c=b.model;var f,d;if(b.model_data.num_hemispheres==2){f=c.getChildByName("left");d=c.getChildByName("right");f.position.x-=100;f.rotation.z+=a(-90);d.position.x+=100;d.rotation.z+=a(90);c.rotation.x+=a(90);c.rotation.y+=a(180)}};b.superiorView=function(){};b.inferiorView=function(){b.model.rotation.y+=a(180)};b.anteriorView=function(c){b.resetView();b.model.rotation.x+=a(-90);b.model.rotation.z+=a(180)};b.posteriorView=function(c){b.resetView();b.model.rotation.x+=a(-90)};b.separateHemispheres=function(c){if(b.model_data.num_hemispheres==2){b.model.children[0].position.x-=1;b.model.children[1].position.x+=1}};function a(c){return c*Math.PI/180}};BrainBrowser.data.Data=function(b,d){if(!(this instanceof BrainBrowser.data.Data)){return new BrainBrowser.data.Data(b,d)}var a=this;function c(){var f=new Worker("js/data.worker.js");f.addEventListener("message",function(h){var g=h.data;var j;for(j in g){if(g.hasOwnProperty(j)){a[j]=g[j]}}if(d){d(a)}f.terminate()});f.postMessage({cmd:"parse",data:b})}a.createColorArray=function(h,m,l,j,n,g,k,o){var f=new Worker("js/data.worker.js");f.addEventListener("message",function(q){var p=q.data;var r;if(o){o(p)}f.terminate()});f.postMessage({cmd:"createColorArray",data:{values:a.values,min:h,max:m,spectrum:l.colors,flip:j,clamped:n,original_colors:g,model:{num_hemisphere:k.num_hemisphere,indexArray:k.indexArray}}})};if(b){if(typeof b==="string"){c(b)}else{if(b.values!=undefined){this.values=b.values.concat();this.min=this.values.min();this.max=this.values.max()}else{console.log("copying data length: "+b.length);this.values=b;this.min=b.min();this.max=b.max()}}}};$(function(){var c=0;var b="";var a=$("#loading");$(".button").button();$(".buttonset").buttonset();$("#data-range-box").hide();if(!BrainBrowser.webgl_enabled()){$("#brainbrowser").html(BrainBrowser.webGLErrorMessage());return}BrainBrowser(function(f){f.loadSpectrumFromUrl("/assets/spectral_spectrum.txt");f.clamped=true;f.flip=false;f.afterLoadSpectrum=function(g){var h=g.createSpectrumCanvasWithScale(0,100,null);var j=document.getElementById("color_bar");h.id="spectrum_canvas";if(!j){$('<div id="color_bar"></div>').html(h).appendTo("#data-range")}else{$(j).html(h)}f.spectrumObj=g};f.afterDisplayObject=function(j){var h;var n,g;var l,m;var k=j.children;var o=$("#shapes").children();if(k.length-o.length>0){for(l=o.length,m=k.length;l<m;l++){h=k[l];g=$('<div id="shape_'+l+'" class="shape"><h4>Shape '+(l+1)+"</h4>Name: "+h.name+"<br />Opacity: </div>");n=$('<div class="opacity-slider slider"  data-shape-name="'+h.name+'"></div>');n.slider({value:100,min:-1,max:101,slide:function(p,r){var t=p.target;var q=$(t).attr("data-shape-name");var s=$(t).slider("value");s=Math.min(100,Math.max(0,s))/100;f.changeShapeTransparency(q,s)}});n.appendTo(g);g.appendTo("#shapes")}}f.afterClearScreen=function(){$("#shapes").html("");$("#data-range-box").hide()}};$("#clearshapes").click(function(g){f.clearScreen();c=0;b="";a.hide()});$("#range-slider").slider({range:true,min:-50,max:50,value:[-10,10],slider:function(j,k){var h=parseFloat(k.values[0]);var g=parseFloat(k.values[1]);f.rangeChange(h,g,$("#clamp_range").is(":checked"))},step:0.1});f.afterRangeChange=function(j,g){$("#data-range-min").val(j);$("#data-range-max").val(g);var h=f.spectrumObj.createSpectrumCanvasWithScale(j,g,null);h.id="spectrum_canvas";$("#color_bar").html($(h))};function d(l){var g=$("#data-range");var n='<div id="data-range-multiple"><ul>';var h="";var l=l.length?l:[l];var j,k;g.html("");for(j=0,k=l.length;j<k;j++){n+='<li><a href="#data_file'+j+'">'+l[j].fileName+"</a></li>";h+='<div id="data_file'+j+'" class="box full_box">';h+='Min: <input class="range-box" id="data-range-min" type="text" name="range_min" size="5" ><br />';h+='<div id="range-slider+'+j+'" data-blend-index="'+j+'" class="slider"></div><br />';h+='Max: <input class="range-box" id="data-range-max" type="text" name="range_max" size="5" >';h+='<input type="checkbox" class="button" id="fix_range"><label for="fix_range">Fix Range</label>';h+='<input type="checkbox" class="button" id="clamp_range" checked="true"><label for="clamp_range">Clamp range</label>';h+='<input type="checkbox" class="button" id="flip_range"><label for="flip_range">Flip Colors</label>';h+="</div>"}n+="</ul>";g.html(n+h+"</div>");$("#data-range-box").show();g.find("#data-range-multiple").tabs();$("#data-range").find(".slider").each(function(p,r){var q=l[0].values.min();var o=l[0].values.max();$(r).slider({range:true,min:q,max:o,values:[l[p].rangeMin,l[p].rangeMax],step:(o-q)/100,slide:function(s,t){$("#data-range-min").val(t.values[0]);$("#data-range-max").val(t.values[1])},stop:function(t,u){a.show();var s=$(this).attr("data-blend-index");range_updating=true;l[0].rangeMin=u.values[0];l[0].rangeMax=u.values[1];f.model_data.data=l[0];f.rangeChange(l[0].rangeMin,l[0].rangeMax,f.clamped,{afterUpdate:function(){a.hide()}})}})});function m(q){a.show();var p=$("#data-range-min").val();var o=$("#data-range-max").val();$(q.target).siblings(".slider").slider("values",0,p);$(q.target).siblings(".slider").slider("values",1,o);f.rangeChange(p,o,$(q.target).siblings("#clamp_range").is(":checked"),{afterUpdate:function(){a.hide()}})}$("#data-range-min").change(m);$("#data-range-max").change(m);$("#fix_range").click(function(o,p){f.fixRange=$(e.target).is(":checked")});$("#clamp_range").change(function(q){var p=parseFloat($(q.target).siblings("#data-range-min").val());var o=parseFloat($(q.target).siblings("#data-range-max").val());if($(q.target).is(":checked")){f.rangeChange(p,o,true)}else{f.rangeChange(p,o,false)}});$("#flip_range").change(function(o){f.flip=$(o.target).is(":checked");a.show();f.updateColors(f.model_data.data,f.model_data.data.rangeMin,f.model_data.data.rangeMax,f.spectrum,f.flip,f.clamped,false,{afterUpdate:function(){a.hide()}})})}f.afterLoadData=function(j,h,k,g){if(g){d(k)}else{d(k);$("#range-slider").slider("values",0,parseFloat(j));$("#range-slider").slider("values",1,parseFloat(h));f.afterRangeChange(j,h)}};$(".range-box").keypress(function(g){if(g.keyCode=="13"){f.rangeChange(parseFloat($("#data-range-min").val()),parseFloat($("#data-range-max").val()))}});$("#examples").click(function(k){c++;var h=$(k.target).attr("data-example-name");var m,j;if(b===h){return}b=h;function l(n){return{test:function(){return n!==c}}}function g(){a.hide()}a.show();f.clearScreen();switch(h){case"basic":f.loadModelFromUrl("/models/surf_reg_model_both.obj",{format:"MNIObject",afterDisplay:g,cancel:l(c)});break;case"punkdti":f.loadModelFromUrl("/models/dti.obj",{format:"MNIObject",renderDepth:999,afterDisplay:g,cancel:l(c)});f.loadModelFromUrl("/models/left_color.obj",{format:"MNIObject",cancel:l(c)});f.loadModelFromUrl("/models/right_color.obj",{format:"MNIObject",cancel:l(c)});break;case"realct":f.loadModelFromUrl("/models/realct.obj",{format:"MNIObject",afterDisplay:function(){f.loadDataFromUrl("/models/realct.txt","Cortical Thickness",{afterUpdate:g,cancel:l(c)})},cancel:l(c)});break;case"car":f.loadModelFromUrl("/models/car.obj",{format:"WavefrontObj",afterDisplay:g,cancel:l(c)});f.setCamera(0,0,100);m=new THREE.Matrix4();m.makeRotationX(-0.25*Math.PI);j=new THREE.Matrix4();j.makeRotationY(0.4*Math.PI);f.model.applyMatrix(j.multiply(m));break;case"plane":f.loadModelFromUrl("/models/dlr_bigger.streamlines.obj",{format:"MNIObject",cancel:l(c)});f.loadModelFromUrl("/models/dlr.model.obj",{format:"MNIObject",afterDisplay:function(){g()},cancel:l(c)});f.setCamera(0,0,75);m=new THREE.Matrix4();m.makeRotationX(-0.25*Math.PI);j=new THREE.Matrix4();j.makeRotationY(0.4*Math.PI);f.model.applyMatrix(j.multiply(m));break;case"mouse":f.loadModelFromUrl("/models/mouse_surf.obj",{format:"MNIObject",afterDisplay:function(){f.loadDataFromUrl("/models/mouse_alzheimer_map.txt","Cortical Amyloid Burden, Tg AD Mouse, 18 Months Old",{shape:"mouse_surf.obj",min:0,max:0.25,afterUpdate:g,cancel:l(c)})},cancel:l(c)});f.loadModelFromUrl("/models/mouse_brain_outline.obj",{format:"MNIObject",afterDisplay:function(){$(".opacity-slider[data-shape-name='mouse_brain_outline.obj']").slider("value",50);f.changeShapeTransparency("mouse_brain_outline.obj",0.5)},cancel:l(c)});f.setCamera(0,0,40)}return false});$("#obj_file_format").change(function(){var g=$("#obj_file_format").closest("#obj_file_select").find("#obj_file_format option:selected").val();if(g==="freesurfer"){$("#format_hints").html('You can use <a href="http://surfer.nmr.mgh.harvard.edu/fswiki/mris_convert" target="_blank">mris_convert</a> to convert your binary surface files into .asc format.')}else{$("#format_hints").html("")}});$("#obj_file_submit").click(function(){var g=$("#obj_file_format").closest("#obj_file_select").find("#obj_file_format option:selected").val();f.loadModelFromFile(document.getElementById("objfile"),{format:g,beforeLoad:function(){a.show()},afterDisplay:function(){a.hide()},onError:function(){a.hide()}});return false});$("#datafile").change(function(){f.loadDataFromFile(document.getElementById("datafile"))});$("#spectrum").change(function(){f.loadSpectrumFromFile(document.getElementById("spectrum"))});$("#dataseriesfile").change(function(){f.loadSeriesDataFromFile(document.getElementById("dataseriesfile"))});$("#datablendfile").change(function(){f.loadBlendDataFromFile(document.getElementById("datablendfile"),$(".blend_slider").slider("value"))})});$("a.example[data-example-name=realct]").click()});BrainBrowser.filetypes.parsing=function(a,c,b,f){var d=new Worker(b);d.addEventListener("message",function(h){var g=h.data;var j;for(j in g){if(g.hasOwnProperty(j)){a[j]=g[j]}}if(f){f(a)}d.terminate()});d.postMessage(c)};BrainBrowser.filetypes.WavefrontObj=function(b,c){if(!(this instanceof BrainBrowser.filetypes.WavefrontObj)){return new BrainBrowser.filetypes.WavefrontObj(b,c)}var a=this;BrainBrowser.filetypes.parsing(a,b,"js/wavefront_obj.worker.js",c)};BrainBrowser.filetypes.FreeSurferAsc=function(b,c){if(!(this instanceof BrainBrowser.filetypes.FreeSurferAsc)){return new BrainBrowser.filetypes.FreeSurferAsc(b,c)}var a=this;BrainBrowser.filetypes.parsing(a,b,"js/freesurfer_asc.worker.js",c)};BrainBrowser.filetypes.MNIObject=function(b,c){if(!(this instanceof BrainBrowser.filetypes.MNIObject)){return new BrainBrowser.filetypes.MNIObject(b,c)}var a=this;BrainBrowser.filetypes.parsing(a,b,"js/mniobj.worker.js",c);a.getVertexInfo=function(f){var d=[a.positionArray[f*3],a.positionArray[f*3+1],a.positionArray[f*3+2]];return{vertex:f,position_vector:d}}};