function Data(b){var a=this;a.parse=function(c){c=c.replace(/\s+$/,"");c=c.replace(/^\s+/,"");a.values=c.split(/\s+/);for(var d=0;d<a.values.length;d++){a.values[d]=parseFloat(a.values[d])}a.min=a.values.min();a.max=a.values.max()};this.createColorArray=function(g,o,n,k,r,d,l){var n=n.colors;var q=new Array();var p=((o-g)+(o-g)/n.length)/n.length;for(var h=0;h<a.values.length;h++){if(a.values[h]<=g){if(a.values[h]<g&&!r){var s=-1}else{var s=0}}else{if(a.values[h]>o){if(!r){var s=-1}else{var s=n.length-1}}else{var s=parseInt((a.values[h]-g)/p)}}if(k&&s!=-1){q.push.apply(q,n[n.length-1-s])}else{if(s==-1){if(d.length==4){q.push.apply(q,d)}else{q.push.apply(q,[d[h*4],d[h*4+1],d[h*4+2],d[h*4+3]])}}else{q.push.apply(q,n[s])}}}if(l.num_hemisphere!=2){var m=[];var c=l.indexArray.length;for(var f=0;f<c;f++){m[f*4]=q[l.indexArray[f]*4];m[f*4+1]=q[l.indexArray[f]*4+1];m[f*4+2]=q[l.indexArray[f]*4+2];m[f*4+3]=q[l.indexArray[f]*4+3]}q.nonIndexedColorArray=m}return q};if(b){if(typeof b=="string"){a.parse(b)}else{if(b.values!=undefined){this.values=cloneArray(b.values);this.min=this.values.min();this.max=this.values.max()}else{console.log("copying data length: "+b.length);this.values=b;this.min=b.min();this.max=b.max()}}}}Array.prototype.min=function(){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.min.apply(Math,this.slice(c,c+b-1)))}}else{return Math.min.apply(Math,this)}return a.min()};Array.prototype.max=function(d){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.max.apply(Math,this.slice(c,c+b-1)))}}else{return Math.max.apply(Math,this)}return a.max()};function cloneArray(b){var c=new Array(b.length);for(var a=0;a<c.length;a++){c[a]=b[a]}return c}function rotateUint16Array90Left(g,d,a){var f=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){f[c*a+b]=g[b*d+(d-c)]}}return f}function rotateUint16Array90Right(g,d,a){var f=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){f[c*a+b]=g[(a-b)*d+c]}}return f}function interpolateDataArray(h,c,b,a){console.log(h.values.length);var f=h.values.length;var g=new Array(f);console.log("Percentage: "+b);for(var d=0;d<f;d++){if(a){g[d]=(h.values[d]*(100-b*100)+c.values[d]*(b*100))/100}else{g[d]=(h.values[d]*(100-b*100)+c.values[d]*(b*100))/100}}console.log(g.length);return g}function ColorManager(){function c(m,d,q,j,o,l,n,h,g){var m=m.colors;var p=((o-j)+(o-j)/m.length)/m.length;for(var k=0;k<q.length;k++){if(q[k]<=j){var r=0}else{if(q[k]>o){var r=m.length-1}else{var r=parseInt((q[k]-j)/p)}}if(l){var f=255}else{var f=1}d[k*4+0]=f*m[r][0]*h+n*f;d[k*4+1]=f*m[r][1]*h+n*f;d[k*4+2]=f*m[r][2]*h+n*f;if(g){d[k*4+3]=f*g}else{d[k*4+3]=f}}return d}this.createColorMap=c;function a(l){var d=l[0];for(var h=0;h<l[0].length/4;h++){for(var g=1;g<l.length;g++){var f=d[h*4+3];var k=l[g][h*4+3];d[h*4]=d[h*4]*f+l[g][h*4]*k;d[h*4+1]=d[h*4+1]*f+l[g][h*4+1]*k;d[h*4+2]=d[h*4+2]*f+l[g][h*4+2]*k;d[h*4+3]=f+k}}return d}this.blendColors=a;function b(f,m,k,h){var d=m.length;var l=new Array(d);var j=0;for(var g=0;g<d;g++){l[g]=c(f,new Array(m[g].values.length),m[g].values,m[g].rangeMin,m[g].rangeMax,false,0,1,m[g].alpha)}return a(l)}this.blendColorMap=b}function Spectrum(f){var c=this;var a=new ColorManager();function b(g,q,j,p){var l=document.createElement("canvas");jQuery(l).attr("width",256);jQuery(l).attr("height",j);var m=new Array(256);for(var o=0;o<256;o++){if(p){m[255-o]=o}else{m[o]=o}}g=a.createColorMap(c,[],m,0,255,true,0,1);var h=l.getContext("2d");for(var n=0;n<256;n++){h.fillStyle="rgb("+parseInt(g[n*4])+","+parseInt(g[n*4+1])+","+parseInt(g[n*4+2])+")";h.fillRect(n,0,1,q)}return l}c.createSpectrumCanvas=function(g){if(g==null){g=c.colors}var h=b(g,20,20,false);return h};c.createSpectrumCanvasWithScale=function(l,g,h,m){if(h==null){h=c.colors}var j=b(h,20,40,m);var k=j.getContext("2d");k.fillStyle="#FFA000";k.fillRect(0.5,20,1,10);k.fillText(l.toPrecision(3),0.5,40);k.fillRect(j.width/4,20,1,10);k.fillText(((l+g)/4).toPrecision(3),j.width/4,40);k.fillRect(j.width/2,20,1,10);k.fillText(((l+g)/2).toPrecision(3),j.width/2,40);k.fillRect(3*(j.width/4),20,1,10);k.fillText((3*((l+g)/4)).toPrecision(3),3*(j.width/4),40);k.fillRect(j.width-0.5,20,1,10);k.fillText(g.toPrecision(3),j.width-20,40);return j};function d(n){n=n.replace(/\s+$/,"");n=n.replace(/^\s+/,"");var l=n.split(/\n/);var g=new Array();for(var j=0;j<l.length;j++){var m=l[j].replace(/\s+$/,"").split(/\s+/);for(var h=0;h<m.length;h++){m[h]=parseFloat(m[h])}if(m.length<4){m.push(1)}g.push(m)}c.colors=g;return g}if(f!=undefined){d(f)}}function WavefrontObj(o){var m=this;o=o.split("\n");m.shapes=[];var b;var c=[];var u=[];var s=[];b={name:o.name|"undefined",faces:[],positionArray:[],colorArray:[],indexArray:[],texIndexArray:[],normalIndexArray:[]};m.shapes.push(b);for(var p=0;p<o.length;p++){var v=o[p].split(/\s+/);if(!(v[0].match("#"))||v==""){if(v[0]=="o"|v[0]=="g"){console.log(v[1]);b={name:v[1],faces:[],positionArray:[],colorArray:[],indexArray:[],texIndexArray:[],normalIndexArray:[]};m.shapes.push(b)}else{if(v[0]=="v"){c.push(parseFloat(v[1]));c.push(parseFloat(v[2]));c.push(parseFloat(v[3]))}else{if(v[0]=="vt"){for(var f=1;f<v.length;f++){u.push(parseFloat(v[f]))}}else{if(v[0]=="vn"){s.push(parseFloat(v[1]));s.push(parseFloat(v[2]));s.push(parseFloat(v[3]))}else{if(v[0]=="f"){var t=[];for(var j=1;j<4;j++){var g=v[j].split("/");t.push(parseInt(g[0])-1);b.indexArray.push(parseInt(g[0])-1);b.texIndexArray.push(parseInt(g[1])-1);if(g[2]){b.normalIndexArray.push(parseInt(g[2])-1)}}if(v.length>=4){for(j;j<v.length;j++){var g=v[j].split("/");t.push(parseInt(g[0])-1);var q=b.indexArray.length;b.indexArray.push(b.indexArray[q-1]);b.indexArray.push(b.indexArray[q-3]);b.indexArray.push(g[0]-1)}}b.faces.push(t)}}}}}}}var a=Array(c.length/3);var d=m.shapes.length;for(var h=0;h<d;h++){var r=m.shapes[h];r.positionArray=c;if(r.colorArray.length==0){r.colorArray=[0.8,0.8,0.8,1]}}m.objectClass="P";m.vertexArray=c;m.texCoordArray=u}function MNIObject(d){var k;var h=this;function b(n){h.num_hemispheres=1;var m=n.replace(/\s+$/,"");var o=m.replace(/^\s+/,"");k=o.split(/\s+/).reverse();h.objectClass=k.pop();if(h.objectClass=="P"){f();h.numberVertices=parseInt(k.pop());g();l();h.nitems=parseInt(k.pop())}else{if(h.objectClass=="L"){f();h.numberVertices=parseInt(k.pop());g();h.nitems=parseInt(k.pop())}else{h.objectClass="__FAIL__";return}}j();c();a();if(h.objectClass=="P"){if(h.positionArray.length==81924*3){h.brainSurface=true;h.split_hemispheres()}}}function f(){if(h.objectClass=="P"){h.surfaceProperties={ambient:parseFloat(k.pop()),diffuse:parseFloat(k.pop()),specular_reflectance:parseFloat(k.pop()),specular_scattering:parseFloat(k.pop()),transparency:parseFloat(k.pop())}}else{if(h.objectClass=="L"){h.surfaceProperties={width:k.pop()}}}}function g(){h.positionArray=new Array();for(var m=0;m<h.numberVertices;m++){for(var n=0;n<3;n++){h.positionArray.push(parseFloat(k.pop()))}}}function l(){h.normalArray=new Array();for(var o=0;o<h.numberVertices;o++){for(var m=0;m<3;m++){h.normalArray.push(parseFloat(k.pop()))}}}function j(){h.colorFlag=parseInt(k.pop());h.colorArray=new Array();if(h.colorFlag===0){for(var m=0;m<4;m++){h.colorArray.push(parseFloat(k.pop()))}}else{if(h.colorFlag===1){for(var n=0;n<h.numberPolygons;n++){for(var m=0;m<4;m++){h.colorArray.push(parseFloat(k.pop()))}}}else{if(h.colorFlag===2){for(var n=0;n<h.numberVertices;n++){for(var m=0;m<4;m++){h.colorArray.push(parseFloat(k.pop()))}}}else{throw new Error("colorFlag not valid in that file")}}}}function c(){h.endIndicesArray=new Array();for(var m=0;m<h.nitems;m++){h.endIndicesArray.push(parseInt(k.pop()))}}function a(){h.indexArray=new Array();var n=k.length;for(var m=0;m<n;m++){h.indexArray.push(parseInt(k.pop()))}}h.split_hemispheres=function(){h.left={};h.right={};var q=h.positionArray.length;h.left.positionArray=h.positionArray.slice(0,q/2);h.right.positionArray=h.positionArray.slice(q/2,q);var p=h.indexArray.length;h.left.indexArray=h.indexArray.slice(0,p/2);h.right.indexArray=h.indexArray.slice(p/2,p);for(var m=0;m<h.right.indexArray.length;m++){h.right.indexArray[m]=h.right.indexArray[m]-2-p/3/2/2}var n=h.normalArray.length;h.left.normalArray=h.normalArray.slice(0,n/2);h.right.normalArray=h.normalArray.slice(n/2,n);h.left.colorFlag=h.colorFlag;h.right.colorFlag=h.colorFlag;if(h.colorFlag==0||h.colorFlag==1){h.left.colorArray=h.colorArray;h.right.colorArray=h.colorArray}else{var o=h.colorArray.length;h.left.colorArray=h.colorArray.slice(0,o/2);h.right.colorArray=h.colorArray.slice(o/2+1,-1)}h.left.numberVertices=h.numberVertices/2;h.right.numberVertices=h.numberVertices/2;h.left.numberPolygons=h.numberPolygons/2;h.right.numberPolygons=h.numberPolygons/2;h.num_hemispheres=2};h.getVertexInfo=function(n){var m=[h.positionArray[n*3],h.positionArray[n*3+1],h.positionArray[n*3+2]];return{vertex:n,position_vector:m}};h.get_vertex=function(w,t,m){if(h.num_hemispheres>1){var s=h[m];var p=0;if(m=="right"){p=2+s.indexArray.length/3/2}}else{var s=h;var p=0}var r=new Array();var z=w*3;for(var q=0;q<3;q++){r.push(s.indexArray[z+q])}var x=new Array();for(var q=0;q<3;q++){var v=r[q]*3;x[q]=new Array();for(var o=0;o<3;o++){x[q][o]=s.positionArray[v+o]}}var y=new Array();for(var q=0;q<3;q++){y.push(o3djs.math.distance(t,x[q]))}var n=0;if(y[1]<y[0]){n=1}if(y[2]<y[n]){n=2}var u=r[n]+p;var A=x[n];return{vertex:u,position_vector:A}};if(d){b(d)}}function BrainBrowser(){var h=this;var k=new ColorManager();var f;var w;var z;var y;var B;var n=new THREE.Object3D();var j;var x;var c;var C;var r;var A;this.start=function(){window.onload=function(){setTimeout(function(){h.init()},0)}};this.init=function(){B=new THREE.Scene();f=$("#view-window");z=new THREE.PerspectiveCamera(30,f.width()/f.height(),0.1,5000);if(g()){w=new THREE.WebGLRenderer({clearColor:8947848,clearAlpha:1,preserveDrawingBuffer:true})}else{f.html(o());return}w.setSize(f.width(),f.height());r=w;A=new THREE.AnaglyphEffect(w);A.setSize(f.width(),f.height());f.append(w.domElement);z.position.z=500;y=new THREE.PointLight(16777215);y.position.x=0;y.position.y=0;y.position.z=500;B.add(y);j=new THREE.TrackballControls(z,f[0]);x=new THREE.TrackballControls(y,f[0]);j.zoomSpeed=2;x.zoomSpeed=2;function G(H){requestAnimationFrame(G);C=c||H;c=H;j.update();x.update();h.renderCallback(H)}if(h.afterInit){h.afterInit(h)}window.onresize();G()};
/*! 
   * WebGL test taken from Detector.js by
   * alteredq / http://alteredqualia.com/
   * mr.doob / http://mrdoob.com/
  */
function g(){try{return !!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(G){return false}}function o(){var H='BrainBrowser requires <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>.<br/>';H+=window.WebGLRenderingContext?"Your browser seems to support it, but it is <br/> disabled or unavailable.<br/>":"Your browser does not seem to support it.<br/>";H+='Test your browser\'s WebGL support <a href="http://get.webgl.org/">here</a>.';var G=$('<div id="webgl-error">'+H+"</div>");return G}this.anaglyphEffect=function(){r=A};this.noEffect=function(){r=w};this.setCamera=function(G,I,H){z.position.set(G,I,H)};this.getModel=function(){return n};function l(I,J){h.model_data=I;var H=s(I.left);H.name="left";H.model_num=0;var G=s(I.right);G.name="right";G.model_num=1;n.add(H);n.add(G);B.add(n)}function s(J){var P=J.positionArray;var I=J.indexArray;var O={};var H={};var M;for(var K=0;K+2<P.length;K+=3){t(O,P[K],P[K+1],P[K+2])}H.x=O.minX+0.5*(O.maxX-O.minX);H.y=O.minY+0.5*(O.maxY-O.minY);H.z=O.minY+0.5*(O.maxZ-O.minZ);var N=new THREE.Geometry();for(var K=0;K+2<P.length;K+=3){N.vertices.push(new THREE.Vector3(P[K]-H.x,P[K+1]-H.y,P[K+2]-H.z))}for(var K=0;K+2<I.length;K+=3){M=new THREE.Face3(I[K],I[K+1],I[K+2]);M.vertexColors[0]=new THREE.Color();M.vertexColors[1]=new THREE.Color();M.vertexColors[2]=new THREE.Color();N.faces.push(M)}N.computeFaceNormals();N.computeVertexNormals();var L=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:526344,vertexColors:THREE.VertexColors});var G=new THREE.Mesh(N,L);G.centroid=H;G.position.set(H.x,H.y,H.z);return G}function v(I,G,K,J){var H=q(I,K);H.name=G;if(J){H.renderDepth=J}n.add(H);B.add(n)}function q(N,W){h.model_data=N;var V=[];var T=[];var G=[];var R={};var I={};for(var O=0;O<h.model_data.nitems;O++){if(O==0){var H=0}else{var H=h.model_data.endIndicesArray[O-1]}V.push(h.model_data.indexArray[H]);for(var L=H+1;L<h.model_data.endIndicesArray[O]-1;L++){V.push(h.model_data.indexArray[L]);V.push(h.model_data.indexArray[L])}V.push(h.model_data.indexArray[h.model_data.endIndicesArray[O]-1])}var S=h.model_data.positionArray;for(var M=0;M<V.length;M++){t(R,S[V[M]*3],S[V[M]*3+1],S[V[M]*3+2])}I.x=R.minX+0.5*(R.maxX-R.minX);I.y=R.minY+0.5*(R.maxY-R.minY);I.z=R.minY+0.5*(R.maxZ-R.minZ);if(!W){for(var M=0;M<V.length;M++){T.push(new THREE.Vector3(S[V[M]*3]-I.x,S[V[M]*3+1]-I.y,S[V[M]*3+2]-I.z))}var U=[];if(h.model_data.colorArray.length==4){for(var O=0;O<numberVertices;O++){U.push.apply(U,[0.5,0.5,0.7,1])}}else{var U=h.model_data.colorArray;for(var M=0;M<V.length;M++){var J=new THREE.Color();J.setRGB(U[V[M]*4],U[V[M]*4+1],U[V[M]*4+2]);G.push(J)}}}else{T=h.model_data.meshPositionArray;G=h.model_data.meshColorArray}var Q=new THREE.Geometry();Q.vertices=T;Q.colors=G;Q.colorsNeedUpdate=true;var P=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});var K=new THREE.Line(Q,P,THREE.LinePieces);K.position.set(I.x,I.y,I.z);K.centroid=I;return K}function E(J,H,K){h.model_data=J;if(h.model_data.shapes){for(var I=0;I<h.model_data.shapes.length;I++){var G=m(h.model_data.shapes[I]);G.name=h.model_data.shapes[I].name;n.add(G)}}else{var G=m(h.model_data);G.name=H;n.add(G)}if(h.afterCreate!=undefined){h.afterCreate(h.model_data)}B.add(n)}function m(R){var M=R.positionArray;var S=R.indexArray;var T=[];if(R.colorArray.length==4){for(var L=0;L<M.length/3;L++){T.push(R.colorArray[0]);T.push(R.colorArray[1]);T.push(R.colorArray[2])}}else{T=[];var J=S.length;for(var K=0;K+2<R.colorArray.length;K+=4){T.push(R.colorArray[K]);T.push(R.colorArray[K+1]);T.push(R.colorArray[K+2])}}var G=[];var I;var P=new THREE.Geometry();for(var L=0;L+2<M.length;L+=3){P.vertices.push(new THREE.Vector3(M[L],M[L+1],M[L+2]));I=new THREE.Color();I.setRGB(T[L],T[L+1],T[L+2]);G.push(I)}if(R.faces&&R.faces.length>0){var H=R.faces;for(var L=0;L<H.length;L++){if(H[L].length<3){continue}if(H[L].length<=4){if(H[L].length<=3){var O=new THREE.Face3(H[L][0],H[L][1],H[L][2])}else{if(H[L].length==4){var O=new THREE.Face4(H[L][0],H[L][1],H[L][2],H[L][3])}}O.vertexColors[0]=G[O.a];O.vertexColors[1]=G[O.b];O.vertexColors[2]=G[O.c];if(H[L].length>3){O.vertexColors[3]=G[O.d]}P.faces.push(O)}else{for(var K=1;K+1<H[L].length;K++){var O=new THREE.Face3(H[L][0],H[L][K],H[L][K+1]);O.vertexColors[0]=G[O.a];O.vertexColors[1]=G[O.b];O.vertexColors[2]=G[O.c];P.faces.push(O)}}}}else{for(var L=0;L+2<S.length;L+=3){var O=new THREE.Face3(S[L],S[L+1],S[L+2]);O.vertexColors[0]=G[O.a];O.vertexColors[1]=G[O.b];O.vertexColors[2]=G[O.c];P.faces.push(O)}}P.computeFaceNormals();P.computeVertexNormals();P.colorsNeedUpdate=true;var N=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:526344,vertexColors:THREE.VertexColors});var Q=new THREE.Mesh(P,N);if(h.loading){jQuery(h.loading).html("Buffers Loaded")}return Q}this.uninit=function(){if(this.client){this.client.cleanup()}};this.renderCallback=function(){var H=c-C;var G=H*0.00015;if(h.autoRotate){if(h.autoRotate.x){n.rotation.x+=G}if(h.autoRotate.y){n.rotation.y+=G}if(h.autoRotate.z){n.rotation.z+=G}}r.render(B,z)};this.clearScreen=function(){if(n){B.remove(n)}h.resetView();n=new THREE.Object3D();if(h.afterClearScreen!=undefined){h.afterClearScreen()}};this.displayObjectFile=function(K,H,J){var I=J||{};var L=I.renderDepth;if(K.objectClass=="P"&&K.numberVertices==81924){l(K,L)}else{if(K.objectClass=="P"){E(K,H,L)}else{if(K.objectClass=="L"){v(K,H,false,L)}else{alert("Object file not supported")}}}if(h.afterDisplayObject!=undefined){h.afterDisplayObject(n)}var I=J||{};var G=I.afterDisplay;if(G){G()}};function d(I,G,H){if(H==null){H=h.model_data.data}if(H.fixRange==false||H.fixRange==null){H.rangeMin=I;H.rangeMax=G}}this.updateClearColor=function(G){w.setClearColor(new THREE.Color(G))};this.updateClearColorFromName=function(G){if(G=="white"){h.updateClearColor(16777215)}else{if(G=="black"){h.updateClearColor(0)}else{if(G=="pink"){h.updateClearColor(16711935)}else{h.updateClearColor(8947848)}}}};this.resetView=function(){j.reset();x.reset();n.position.set(0,0,0);n.rotation.set(0,0,0);for(var G=0;G<n.children.length;G++){var H=n.children[G];H.visible=true;if(H.centroid){H.position.set(H.centroid.x,H.centroid.y,H.centroid.z)}else{H.position.set(0,0,0)}H.rotation.set(0,0,0)}};this.setupView=function(G){h.resetView();if(h.model_data&&h.model_data.num_hemispheres==2){var H=h.getViewParams();switch(H.view){case"superior":h.superiorView();break;case"medial":h.medialView();break;case"anterior":h.anteriorView();break;case"inferior":h.inferiorView();break;case"lateral":h.lateralView();break;case"posterior":h.posteriorView();break;default:h.superiorView();break}}if(n.getChildByName("left")){if(H.left==true){h.leftHemisphereVisible(true)}else{h.leftHemisphereVisible(false)}}if(n.getChildByName("right")){if(H.right==true){h.rightHemisphereVisible(true)}else{h.rightHemisphereVisible(false)}}};function a(G){return G*Math.PI/180}this.leftHemisphereVisible=function(G){n.getChildByName("left").visible=G};this.rightHemisphereVisible=function(G){n.getChildByName("right").visible=G};this.medialView=function(G){if(h.model_data.num_hemispheres==2){n.getChildByName("left").position.x-=100;n.getChildByName("left").rotation.z-=a(90);n.getChildByName("right").position.x+=100;n.getChildByName("right").rotation.z+=a(90);n.rotation.x+=a(-90)}};this.lateralView=function(G){if(h.model_data.num_hemispheres==2){n.getChildByName("left").position.x-=100;n.getChildByName("left").rotation.z+=a(-90);n.getChildByName("right").position.x+=100;n.getChildByName("right").rotation.z+=a(90);n.rotation.x+=a(90);n.rotation.y+=a(180)}};this.superiorView=function(){};this.inferiorView=function(){n.rotation.y+=a(180)};this.anteriorView=function(G){h.resetView();n.rotation.x+=a(-90);n.rotation.z+=a(180)};this.posteriorView=function(G){h.resetView();n.rotation.x+=a(-90)};this.separateHemispheres=function(G){if(h.model_data.num_hemispheres==2){n.children[0].position.x-=1;n.children[1].position.x+=1}};this.ZoomInOut=function(G){z.fov*=G;z.updateProjectionMatrix()};h.scrollMe=function(H){var G=(H.deltaY<0)?1/h.zoomFactor:h.zoomFactor;h.ZoomInOut(G);h.client.render()};function u(G){D();if(G){h.selectedInfo=G}}function D(){if(h.selectedInfo){h.highlightShape=null;h.selectedInfo=null}}this.click=function(L,I){var J=f.offset();mouseX=((L.clientX-J.left+$(window).scrollLeft())/f.width())*2-1;mouseY=-((L.clientY-J.top+$(window).scrollTop())/f.height())*2+1;var N=new THREE.Projector();var M=new THREE.Raycaster();D();var H=new THREE.Vector3(mouseX,mouseY,1);N.unprojectVector(H,z);M.set(z.position,H.sub(z.position).normalize());var K=M.intersectObject(n,true);if(K.length>0){var G=K[0];var O={vertex:G.face.a,point:new THREE.Vector3(G.point.x,G.point.y,G.point.z),object:G.object};return I(L,O)}else{jQuery(h.pickInfoElem).html("--nothing--");return false}};this.getInfoForVertex=function(H){var G=h.model_data.getVertexInfo(H);var I={vertex:G.vertex,point:new THREE.Vector3(G.position_vector[0],G.position_vector[1],G.position_vector[2])};return I};this.keyPressedCallback=function(H){var G=false;switch(H.which){case 38:h.ZoomInOut(1.1);G="ZoomIn";break;case 40:h.ZoomInOut(1/1.1);G="ZoomOut";break;case 32:h.separateHemispheres();G="Seperate";break}if(G){return false}else{return true}};function t(I,G,J,H){if(!I.minX||I.minX>G){I.minX=G}if(!I.maxX||I.maxX<G){I.maxX=G}if(!I.minY||I.minY>J){I.minY=J}if(!I.maxY||I.maxY<J){I.maxY=J}if(!I.minZ||I.minZ>H){I.minZ=H}if(!I.maxZ||I.maxZ<H){I.maxZ=H}}function p(G,L,K){var J=new THREE.SphereGeometry(2);var I=new THREE.MeshBasicMaterial({color:16711680});var H=new THREE.Mesh(J,I);H.position.set(G,L,K);B.add(H)}this.set_fill_mode_wireframe=function(){var H=n.children;for(var G=0;G<H.length;G++){var I=H[G].material;I.wireframe=true;if(I.emissive){I.emissive.setHex(125269879)}}};this.set_fill_mode_solid=function(){var H=n.children;for(var G=0;G<H.length;G++){var I=H[G].material;I.wireframe=false;if(I.emissive){I.emissive.setHex(0)}}};function F(H,J,K){var G=J||{};var I=G.beforeLoad;if(I){I()}jQuery.ajax({type:"GET",url:H,dataType:"text",success:function(L){K(L)},error:function(L,N,M){alert("Failure in loadFromURL: "+N)},data:{},timeout:100000})}function b(M,K,L){var J=M.files;if(J.length===0){return}var H=K||{};var I=H.beforeLoad;var G=new FileReader();G.file=J[0];if(I){I()}G.onloadend=function(N){L(N.target.result)};G.readAsText(J[0])}this.loadObjFromUrl=function(G,H){F(G,H,function(J){var K=G.split("/");var I=K[K.length-1];h.displayObjectFile(new MNIObject(J),I,H)})};this.loadWavefrontObjFromUrl=function(G,H){F(G,H,function(J){var K=G.split("/");var I=K[K.length-1];h.displayObjectFile(new WavefrontObj(J),I,H)})};this.loadObjFromFile=function(I,H){var G=H||{};b(I,G,function(J){var M=I.value.split("\\");var K=M[M.length-1];var L;if(G.format==="wavefront"){L=new WavefrontObj(J)}else{L=new MNIObject(J)}if(L.objectClass!=="__FAIL__"){h.displayObjectFile(L,K,G)}else{if(G.onError!=undefined){G.onError()}}})};this.loadSpectrumFromUrl=function(G,I){options=I||{};var H=options.afterLoadSpectrum;F(G,options,function(K){var J=new Spectrum(K);h.spectrum=J;if(H){H()}if(h.afterLoadSpectrum!=null){h.afterLoadSpectrum(J)}if(h.model_data.data){h.updateColors(h.model_data.data,h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.spectrum,h.flip,h.clamped)}})};this.loadSpectrumFromFile=function(G){b(G,null,function(I){var H=new Spectrum(I);h.spectrum=H;if(h.afterLoadSpectrum!=null){h.afterLoadSpectrum(H)}if(h.model_data.data){h.updateColors(h.model_data.data,h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.spectrum,h.flip,h.clamped)}})};this.loadDataFromFile=function(M){var G=M.files[0].name;var K=function(O){var N=new Data(O);N.fileName=G;if(N.values.length<h.model_data.positionArray.length/4){alert("Number of numbers in datafile lower than number of vertices Vertices"+h.model_data.positionArray.length/3+" data values:"+N.values.length);return -1}else{h.model_data.data=N}d(h.model_data.data.min,h.model_data.data.max);if(h.afterLoadData!=null){h.afterLoadData(h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.model_data.data)}h.updateColors(h.model_data.data,h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.spectrum,h.flip,h.clamped);return null};if(G.match(/.*.mnc|.*.nii/)){var L=new XMLHttpRequest();if(G.match(/.*.mnc/)){L.open("POST","/minc/volume_object_evaluate",false)}else{L.open("POST","/nii/volume_object_evaluate",false)}var I=document.getElementById("datafile-form");var J=new FormData(I);L.send(J);var H=L.response;K(H)}else{b(M,null,K)}};this.loadSeriesDataFromFile=function(L){console.log(L.files.length);var K=L.files.length;h.seriesData=new Array(K);h.seriesData.numberFiles=K;var I=L.files;for(var H=0;H<K;H++){var G=new FileReader();G.file=I[H];var J=G.onloadend=(function(N,M){return function(O){console.log(O.target.result.length);console.log(M);h.seriesData[M]=new Data(O.target.result);h.seriesData[M].fileName=N.name}})(G.file,H);G.readAsText(I[H])}h.setupSeries()};this.setupSeries=function(){$('<div id="series">Series: </div>').appendTo("#surface_choice");var G=$("#series");$('<span id="series-value">0</span>').appendTo(G);$('<div id="series-slider" width="100px" + height="10"></div>').slider({value:0,min:0,max:h.seriesData.numberFiles-1,step:0.1,slide:function(H,I){if(I.value-Math.floor(I.value)<0.01){h.model_data.data=h.seriesData[I.value]}else{if(h.seriesData[0].fileName.match("pval.*")){h.model_data.data=new Data(interpolateDataArray(h.seriesData[Math.floor(I.value)],h.seriesData[Math.floor(I.value)+1],(I.value-Math.floor(I.value)),true))}else{h.model_data.data=new Data(interpolateDataArray(h.seriesData[Math.floor(I.value)],h.seriesData[Math.floor(I.value)+1],(I.value-Math.floor(I.value))))}}if(h.seriesData[0].fileName.match("mt.*")){$("#age_series").html("Age: "+(I.value*3+5).toFixed(1))}else{if(h.seriesData[0].fileName.match("pval.*")){$("#age_series").html("Age: "+(I.value*1+10))}}$(G).children("#series-value").html(I.value);if(h.model_data.data.values.length<h.model_data.positionArray.length/4){console.log("Number of numbers in datafile lower than number of vertices Vertices"+h.model_data.positionArray.length/3+" data values:"+h.model_data.data.values.length);return -1}d(h.model_data.data.min,h.model_data.data.max);if(h.afterLoadData!=null){h.afterLoadData(h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.model_data.data)}h.updateColors(h.model_data.data,h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.spectrum,h.flip,h.clamped);return null}}).appendTo(G)};this.loadBlendDataFromFile=function(L){var K=L.files.length;h.blendData=new Array(K);h.blendData.numberFiles=K;var I=L.files;for(var H=0;H<K;H++){var G=new FileReader();G.file=I[H];var J=G.onloadend=(function(N,M){return function(P){h.blendData[M]=new Data(P.target.result);h.blendData.alpha=1/K;h.blendData[M].fileName=N.name;for(var O=0;O<2;O++){if(h.blendData[O]==undefined){console.log("not done yet");return}}d(h.blendData[0].values.min(),h.blendData[0].values.max(),h.blendData[0]);d(h.blendData[1].values.min(),h.blendData[1].values.max(),h.blendData[1]);if(h.afterLoadData!=null){h.afterLoadData(null,null,h.blendData,true)}h.blend($(".blend_slider").slider("value"))}})(G.file,H);G.readAsText(I[H])}h.setupBlendColors()};this.setupBlendColors=function(){console.log("Blend colors has ran "+h.blendData.numberFiles);$("#blend").remove();$('<div id="blend">Blend ratios: </div>').appendTo("#surface_choice");var G=$("#blend");$('<span id="blend_value'+i+'">0</span>').appendTo(G);$('<div class="blend_slider" id="blend_slider'+i+'" width="100px" + height="10"></div>').slider({value:0,min:0.1,max:0.99,value:0.5,step:0.01,slide:function(H,I){h.blend($(this).slider("value"))}}).appendTo(G)};this.blend=function(H){h.blendData[0].alpha=H;h.blendData[1].alpha=1-H;for(var G=2;G<h.blendData.length;G++){h.blendData[G].alpha=0}h.updateColors(h.blendData,null,null,h.spectrum,h.flip,h.clamped,true)};this.loadDataFromUrl=function(H,G){F(H,null,function(J,I){h.model_data.data=new Data(J);h.model_data.data.fileName=G;d(h.model_data.data.min,h.model_data.data.max);if(h.afterLoadData!=undefined){h.afterLoadData(h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.model_data.data)}h.updateColors(h.model_data.data,h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.spectrum)})};this.updateColors=function(ak,Y,ad,ai,Q,W,ab,I,U){var N=U||{};var J=N.afterUpdate;h.clamped=W;if(ab){var aj=k.blendColorMap(ai,ak,0,1)}else{var aj=ak.createColorArray(Y,ad,ai,Q,W,h.model_data.colorArray,h.model_data)}if(h.model_data.num_hemispheres==2){var G=aj.slice(0,aj.length/2);var V=aj.slice(aj.length/2,aj.length);var S=[];var ae=[];var Z=n.getChildByName("left");var ag=Z.geometry.faces;var K=n.getChildByName("right");var L=K.geometry.faces;var R;var af=L.length;var X=ag.length;var M;var ah;M=Math.max(X,af);for(var ac=0;ac<M;ac++){if(ac<X){R=ag[ac];ah=R.a*4;R.vertexColors[0].setRGB(G[ah],G[ah+1],G[ah+2]);ah=R.b*4;R.vertexColors[1].setRGB(G[ah],G[ah+1],G[ah+2]);ah=R.c*4;R.vertexColors[2].setRGB(G[ah],G[ah+1],G[ah+2]);if(R.d){ah=R.d*4;R.vertexColors[3].setRGB(G[ah],G[ah+1],G[ah+2])}}if(ac<af){R=L[ac];ah=R.a*4;R.vertexColors[0].setRGB(V[ah],V[ah+1],V[ah+2]);ah=R.b*4;R.vertexColors[1].setRGB(V[ah],V[ah+1],V[ah+2]);ah=R.c*4;R.vertexColors[2].setRGB(V[ah],V[ah+1],V[ah+2]);if(R.d){ah=R.d*4;R.vertexColors[3].setRGB(V[ah],V[ah+1],V[ah+2])}}}Z.geometry.colorsNeedUpdate=true;K.geometry.colorsNeedUpdate=true}else{var T=[];for(var ac=0;ac+2<aj.length;ac+=4){var P=new THREE.Color();P.setRGB(aj[ac],aj[ac+1],aj[ac+2]);T.push(P)}var O=n.children;for(var ac=0;ac<O.length;ac++){var H=O[ac].geometry.faces;for(var aa=0;aa<H.length;aa++){var R=H[aa];R.vertexColors[0]=T[R.a];R.vertexColors[1]=T[R.b];R.vertexColors[2]=T[R.c];if(R.d){R.vertexColors[3]=T[R.d]}}O[ac].geometry.colorsNeedUpdate=true}}if(J){J()}if(h.afterUpdateColors!=null){h.afterUpdateColors(ak,Y,ad,ai)}return 1};this.rangeChange=function(J,G,K,L){var I=L||{};var H=I.afterChange;h.model_data.data.rangeMin=J;h.model_data.data.rangeMax=G;h.updateColors(h.model_data.data,h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.spectrum,h.flip,K);if(H){H()}if(h.afterRangeChange!=null){h.afterRangeChange(J,G)}};this.changeShapeTransparency=function(H,I){var G=n.getChildByName(H);if(G){G.material.opacity=I;if(I==1){G.material.transparent=false}else{G.material.transparent=true}}};this.getImageUrl=function(){var J=document.createElement("canvas");var G=document.getElementById("spectrum_canvas");J.width=f.width();J.height=f.height();var K=J.getContext("2d");var H=new Image();function I(){var L=new Image();L.onload=function(){K.drawImage(L,0,0);window.open(J.toDataURL(),"screenshot")};L.src=G.toDataURL()}H.onload=function(){K.drawImage(H,0,0);if(G){I()}else{window.open(J.toDataURL(),"screenshot")}};H.src=w.domElement.toDataURL()};window.onresize=function(){f=$("#view-window");r.setSize(f.width(),f.height());z.aspect=f.width()/f.height();z.updateProjectionMatrix()};h.start()}var brainbrowser;function SurfView(a){var b=this;brainbrowser=new BrainBrowser();this.brainbrowser=brainbrowser;brainbrowser.getViewParams=function(){return{view:jQuery("[name=hem_view]:checked").val(),left:jQuery("#left_hem_visible").is(":checked"),right:jQuery("#right_hem_visible").is(":checked")}};brainbrowser.afterLoadSpectrum=function(c){var d=c.createSpectrumCanvasWithScale(0,100,null);d.id="spectrum_canvas";var f=document.getElementById("color_bar");if(!f){jQuery('<div id="color_bar"></div>').html(d).appendTo("#data-range")}else{jQuery(f).html(d)}brainbrowser.spectrumObj=c};brainbrowser.afterDisplayObject=function(d){$("#shapes").html("");if(d.children.length>0){for(var f=0;f<d.children.length;f++){var c=d.children[f];$('<div id="shape_'+f+'" data-shape-name="'+c.name+'" class="shape"><h4>Shape '+(f+1)+"</h4>Name: "+c.name+'<br />Opacity: <div class="opacity-slider slider"  data-shape-name='+c.name+"></div></div>").appendTo("#shapes")}}brainbrowser.afterClearScreen=function(){$("#shapes").html("")};$(".opacity-slider").slider({value:100,min:-1,max:101,slide:function(g,j){var h=$(g.target).attr("data-shape-name");var k=$(g.target).slider("value");k=Math.min(100,Math.max(0,k))/100;brainbrowser.changeShapeTransparency(h,k)}})};jQuery("#resetview").click(brainbrowser.setupView);jQuery(".view_button").change(brainbrowser.setupView);jQuery("[name=hem_view]").change(brainbrowser.setupView);this.updateCoordinates=function(c,f,d){jQuery("#x-coord").val(c[0]);jQuery("#y-coord").val(c[1]);jQuery("#z-coord").val(c[2]);jQuery("#v-coord").val(f);jQuery("#value-coord").val(d)};brainbrowser.afterInit=function(f){f.clamped=true;f.flip=false;f.clearScreen();if(typeof a=="string"&&a!=""){f.loadObjFromUrl(a)}else{if(typeof a=="function"){a(f)}}jQuery("body").keydown(f.keyPressedCallback);jQuery("#range-slider").slider({range:true,min:-50,max:50,value:[-10,10],slide:function(j,k){var h=parseFloat(k.values[0]);var g=parseFloat(k.values[1]);f.rangeChange(h,g,$("#clamp_range").is(":checked"))},step:0.1});f.afterRangeChange=function(j,g){$("#data-range-min").val(j);$("#data-range-max").val(g);var h=f.spectrumObj.createSpectrumCanvasWithScale(j,g,null);h.id="spectrum_canvas";$("#color_bar").html($(h))};function d(m){var g=$("#data-range");var o=false;var l='<div id="data_range_multiple"><ul>';var m=m.length?m:[m];$(g).html("");for(var j=0;j<m.length;j++){l+='<li><a href="#data_file'+j+'">'+m[j].fileName+"</a></li>"}l+="</ul>";for(var h=0;h<m.length;h++){l+='<div id="data_file'+h+'" class="box full_box"><h4>Thresholding</h4>Min: <input class="range-box" id="data-range-min" type="text" name="range_min" size="5" ><br /><div id="range-slider+'+h+'" data-blend-index="'+h+'" class="slider"></div>Max: <input class="range-box" id="data-range-max" type="text" name="range_max" size="5" ><input type="checkbox" class="button" id="fix_range"><label for="fix_range">Fix Range</label><input type="checkbox" class="button" id="clamp_range" checked="true"><label for="clamp_range">Clamp range</label><input type="checkbox" class="button" id="flip_range"><label for="flip_range">Flip Colors</label></div>'}l+="</div>";$(g).html(l);$(g).tabs();$("#data_range").find(".slider").each(function(k,p){$(p).slider({range:true,min:m[0].values.min(),max:m[0].values.max(),values:[m[k].rangeMin,m[k].rangeMax],step:0.1,slide:function(r,s){if(!o){o=true;var q=$(this).attr("data-blend-index");m[0].rangeMin=s.values[0];m[0].rangeMax=s.values[1];f.model_data.data=m[0];f.rangeChange(m[0].rangeMin,m[0].rangeMax,f.clamped,{afterChange:function(){o=false}})}}})});function n(q){var p=$("#data-range-min").val();var k=$("#data-range-max").val();jQuery(q.target).siblings(".slider").slider("values",0,p);jQuery(q.target).siblings(".slider").slider("values",1,k);f.rangeChange(p,k,$(q.target).siblings("#clamp_range").is(":checked"))}jQuery("#data-range-min").change(n);jQuery("#data-range-max").change(n);jQuery("#fix_range").click(function(k,p){f.fixRange=jQuery(e.target).is(":checked")});jQuery("#clamp_range").change(function(q){var p=parseFloat($(q.target).siblings("#data-range-min").val());var k=parseFloat($(q.target).siblings("#data-range-max").val());if($(q.target).is(":checked")){f.rangeChange(p,k,true)}else{f.rangeChange(p,k,false)}});jQuery("#flip_range").change(function(k){f.flip=$(k.target).is(":checked");f.updateColors(f.model_data.data,f.model_data.data.rangeMin,f.model_data.data.rangeMax,brainbrowser.spectrum,f.flip,f.clamped)})}f.afterLoadData=function(j,h,k,g){if(g){d(k)}else{d(k);jQuery("#range-slider").slider("values",0,parseFloat(j));jQuery("#range-slider").slider("values",1,parseFloat(h));f.afterRangeChange(j,h)}};$("#meshmode").change(function(g){if($(g.target).is(":checked")){f.set_fill_mode_wireframe()}else{f.set_fill_mode_solid()}});$("#threedee").change(function(g){if($(g.target).is(":checked")){f.anaglyphEffect()}else{f.noEffect()}});jQuery("#clearshapes").click(function(g){brainbrowser.clearScreen()});jQuery("#openImage").click(function(g){brainbrowser.getImageUrl()});function c(g){if($("#autorotate").is(":checked")){f.autoRotate={};f.autoRotate.x=$("#autorotateX").is(":checked");f.autoRotate.y=$("#autorotateY").is(":checked");f.autoRotate.z=$("#autorotateZ").is(":checked")}else{f.autoRotate=false}}$("#autorotate-controls").children().change(c);$("#autorotate").change(c);$(".range-box").keypress(function(g){if(g.keyCode=="13"){f.rangeChange(parseFloat(jQuery("#data-range-min").val()),parseFloat(jQuery("#data-range-max").val()))}});$("#clear_color").change(function(h){var g=$(h.target).val();f.updateClearColorFromName(g)});$("#examples").click(function(k){var h=$(k.target).attr("data-example-name");switch(h){case"basic":$("#loading").show();f.clearScreen();f.loadObjFromUrl("/models/surf_reg_model_both.obj",{afterDisplay:function(){$("#loading").hide()}});break;case"punkdti":$("#loading").show();f.clearScreen();f.loadObjFromUrl("/models/dti.obj",{renderDepth:999,afterDisplay:function(){$("#loading").hide()}});f.loadObjFromUrl("/models/left_color.obj");f.loadObjFromUrl("/models/right_color.obj");break;case"realct":$("#loading").show();f.clearScreen();f.loadObjFromUrl("/models/realct.obj",{afterDisplay:function(){f.loadDataFromUrl("/models/realct.txt","cortical thickness");$("#loading").hide()}});break;case"car":$("#loading").show();f.clearScreen();f.loadWavefrontObjFromUrl("/models/car.obj",{afterDisplay:function(){$("#loading").hide()}});f.setCamera(0,0,100);var l=new THREE.Matrix4();l.makeRotationX(-0.25*Math.PI);var j=new THREE.Matrix4();j.makeRotationY(0.4*Math.PI);f.getModel().applyMatrix(j.multiply(l));break;case"plane":$("#loading").show();f.clearScreen();f.loadObjFromUrl("/models/dlr_bigger.streamlines.obj");f.loadObjFromUrl("/models/dlr.model.obj",{afterDisplay:function(){$("#loading").hide()}});f.setCamera(0,0,75);var g=new THREE.Matrix4();var l=new THREE.Matrix4();l.makeRotationX(-0.25*Math.PI);var j=new THREE.Matrix4();j.makeRotationY(0.4*Math.PI);g.multiplyMatrices(j,l);f.getModel().applyMatrix(g)}return false})}};