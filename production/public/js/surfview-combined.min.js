Array.prototype.min=function(){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.min.apply(Math,this.slice(c,c+b-1)))}}else{return Math.min.apply(Math,this)}return a.min()};Array.prototype.max=function(d){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.max.apply(Math,this.slice(c,c+b-1)))}}else{return Math.max.apply(Math,this)}return a.max()};function cloneArray(b){var c=new Array(b.length);for(var a=0;a<c.length;a++){c[a]=b[a]}return c}function rotateUint16Array90Left(f,d,a){var e=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){e[c*a+b]=f[b*d+(d-c)]}}return e}function rotateUint16Array90Right(f,d,a){var e=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){e[c*a+b]=f[(a-b)*d+c]}}return e}function interpolateDataArray(g,c,b,a){console.log(g.values.length);var e=g.values.length;var f=new Array(e);console.log("Percentage: "+b);for(var d=0;d<e;d++){if(a){f[d]=(g.values[d]*(100-b*100)+c.values[d]*(b*100))/100}else{f[d]=(g.values[d]*(100-b*100)+c.values[d]*(b*100))/100}}console.log(f.length);return f}function MNIObject(c){var h;var f=this;this.parse=function(k){f.num_hemispheres=1;var j=k.replace(/\s+$/,"");var l=j.replace(/^\s+/,"");h=l.split(/\s+/).reverse();f.objectClass=h.pop();if(f.objectClass=="P"){d();f.numberVertices=parseInt(h.pop());e();i();f.nitems=parseInt(h.pop())}else{if(f.objectClass=="L"){d();f.numberVertices=parseInt(h.pop());e();f.nitems=parseInt(h.pop())}else{throw new Error("That object class is not supported currently")}}g();b();a();if(f.objectClass=="P"){if(f.positionArray.length==81924*3){f.brainSurface=true;f.split_hemispheres()}}};function d(){if(f.objectClass=="P"){f.surfaceProperties={ambient:parseFloat(h.pop()),diffuse:parseFloat(h.pop()),specular_reflectance:parseFloat(h.pop()),specular_scattering:parseFloat(h.pop()),transparency:parseFloat(h.pop())}}else{if(f.objectClass=="L"){f.surfaceProperties={width:h.pop()}}}}function e(){f.positionArray=new Array();for(var j=0;j<f.numberVertices;j++){for(var k=0;k<3;k++){f.positionArray.push(parseFloat(h.pop()))}}}function i(){f.normalArray=new Array();for(var k=0;k<f.numberVertices;k++){for(var j=0;j<3;j++){f.normalArray.push(parseFloat(h.pop()))}}}function g(){f.colorFlag=parseInt(h.pop());f.colorArray=new Array();if(f.colorFlag===0){for(var j=0;j<4;j++){f.colorArray.push(parseFloat(h.pop()))}}else{if(f.colorFlag===1){for(var k=0;k<f.numberPolygons;k++){for(var j=0;j<4;j++){f.colorArray.push(parseFloat(h.pop()))}}}else{if(f.colorFlag===2){for(var k=0;k<f.numberVertices;k++){for(var j=0;j<4;j++){f.colorArray.push(parseFloat(h.pop()))}}}else{throw new Error("colorFlag not valid in that file")}}}}function b(){f.endIndicesArray=new Array();for(var j=0;j<f.nitems;j++){f.endIndicesArray.push(parseInt(h.pop()))}}function a(){f.indexArray=new Array();var k=h.length;for(var j=0;j<k;j++){f.indexArray.push(parseInt(h.pop()))}}this.split_hemispheres=function(){this.left={};this.right={};var n=this.positionArray.length;this.left.positionArray=this.positionArray.slice(0,n/2);this.right.positionArray=this.positionArray.slice(n/2,n);var m=this.indexArray.length;this.left.indexArray=this.indexArray.slice(0,m/2);this.right.indexArray=this.indexArray.slice(m/2,m);for(var j=0;j<this.right.indexArray.length;j++){this.right.indexArray[j]=this.right.indexArray[j]-2-m/3/2/2}var k=this.normalArray.length;this.left.normalArray=this.normalArray.slice(0,k/2);this.right.normalArray=this.normalArray.slice(k/2,k);this.left.colorFlag=this.colorFlag;this.right.colorFlag=this.colorFlag;if(this.colorFlag==0||this.colorFlag==1){this.left.colorArray=this.colorArray;this.right.colorArray=this.colorArray}else{var l=this.colorArray.length;this.left.colorArray=this.colorArray.slice(0,l/2);this.right.colorArray=this.colorArray.slice(l/2+1,-1)}this.left.numberVertices=this.numberVertices/2;this.right.numberVertices=this.numberVertices/2;this.left.numberPolygons=this.numberPolygons/2;this.right.numberPolygons=this.numberPolygons/2;this.num_hemispheres=2};this.getVertexInfo=function(k){var j=[this.positionArray[k*3],this.positionArray[k*3+1],this.positionArray[k*3+2]];return{vertex:k,position_vector:j}};this.get_vertex=function(u,r,j){if(this.num_hemispheres>1){var q=this[j];var n=0;if(j=="right"){n=2+q.indexArray.length/3/2}}else{var q=this;var n=0}var p=new Array();var x=u*3;for(var o=0;o<3;o++){p.push(q.indexArray[x+o])}var v=new Array();for(var o=0;o<3;o++){var t=p[o]*3;v[o]=new Array();for(var m=0;m<3;m++){v[o][m]=q.positionArray[t+m]}}var w=new Array();for(var o=0;o<3;o++){w.push(o3djs.math.distance(r,v[o]))}var l=0;if(w[1]<w[0]){l=1}if(w[2]<w[l]){l=2}var s=p[l]+n;var y=v[l];return{vertex:s,position_vector:y}};if(c){this.parse(c)}}function Spectrum(d){var b=this;function a(e,f,k,m){var g=document.createElement("canvas");jQuery(g).attr("width",e.length);jQuery(g).attr("height",k);var j=g.getContext("2d");if(m){for(var h=0;h<e.length;h++){var l=e.length-1-h;j.fillStyle="rgb("+parseInt(parseFloat(e[l][0])*255)+","+parseInt(parseFloat(e[l][1])*255)+","+parseInt(parseFloat(e[l][2])*255)+")";j.fillRect(h,0,1,f)}}else{for(var h=0;h<e.length;h++){j.fillStyle="rgb("+parseInt(parseFloat(e[h][0])*255)+","+parseInt(parseFloat(e[h][1])*255)+","+parseInt(parseFloat(e[h][2])*255)+")";j.fillRect(h,0,1,f)}}return g}b.createSpectrumCanvas=function(e){if(e==null){e=b.colors}var f=a(e,20,20,false);return f};b.createSpectrumCanvasWithScale=function(i,e,f,j){if(f==null){f=b.colors}var g=a(f,20,40,j);var h=g.getContext("2d");h.fillStyle="#FF0000";h.fillRect(0.5,20,1,10);h.fillText(i.toPrecision(3),0.5,40);h.fillRect(g.width/4,20,1,10);h.fillText(((i+e)/4).toPrecision(3),g.width/4,40);h.fillRect(g.width/2,20,1,10);h.fillText(((i+e)/2).toPrecision(3),g.width/2,40);h.fillRect(3*(g.width/4),20,1,10);h.fillText((3*((i+e)/4)).toPrecision(3),3*(g.width/4),40);h.fillRect(g.width-0.5,20,1,10);h.fillText(e.toPrecision(3),g.width-20,40);return g};function c(l){l=l.replace(/\s+$/,"");l=l.replace(/^\s+/,"");var h=l.split(/\n/);var e=new Array();for(var g=0;g<h.length;g++){var j=h[g].split(/\s+/);for(var f=0;f<3;f++){j[f]=parseFloat(j[f])}j.push(1);e.push(j)}b.colors=e;return e}if(d!=undefined){c(d)}}function Data(b){var a=this;a.parse=function(c){c=c.replace(/\s+$/,"");c=c.replace(/^\s+/,"");a.values=c.split(/\s+/);for(var d=0;d<a.values.length;d++){a.values[d]=parseFloat(a.values[d])}a.min=a.values.min();a.max=a.values.max()};a.createColorArray=function(d,h,g,f,l,c){var g=g.colors;var k=new Array();var j=((h-d)+(h-d)/g.length)/g.length;for(var e=0;e<a.values.length;e++){if(a.values[e]<=d){if(a.values[e]<d&&!l){var m=-1}else{var m=0}}else{if(a.values[e]>h){if(!l){var m=-1}else{var m=g.length-1}}else{var m=parseInt((a.values[e]-d)/j)}}if(f&&m!=-1){k.push.apply(k,g[g.length-1-m])}else{if(m==-1){if(c.length==4){k.push.apply(k,c)}else{k.push.apply(k,[c[e*4],c[e*4+1],c[e*4+2],c[e*4+3]])}}else{k.push.apply(k,g[m])}}}return k};if(b){if(typeof b=="string"){a.parse(b)}else{if(b.values!=undefined){this.values=cloneArray(b.values);this.min=this.values.min();this.max=this.values.max()}else{console.log("copying data length: "+b.length);this.values=b;this.min=b.min();this.max=b.max()}}}}o3djs.base.o3d=o3d;o3djs.require("o3djs.webgl");o3djs.require("o3djs.math");o3djs.require("o3djs.rendergraph");o3djs.require("o3djs.pack");o3djs.require("o3djs.picking");o3djs.require("o3djs.arcball");o3djs.require("o3djs.quaternions");o3djs.require("o3djs.scene");function BrainBrowser(e){var g=this;this.setup=function(i){g.preload_model(i)};this.init=function(){o3djs.webgl.makeClients(g.initStep2)};g.initStep2=function(j){var k=j[0];g.o3dElement=k;g.client=k.client;g.o3d=k.o3d;g.math=o3djs.math;g.dragging=false;g.o3dWidth=-1;g.o3dHeight=-1;g.quaternions=o3djs.quaternions;g.lastRot=g.math.matrix4.identity();g.thatRot=g.math.matrix4.identity();g.zoomFactor=1.1;g.keyPressDelta=0.1;g.clock=0;g.timeMult=1;g.camera={farPlane:5000,nearPlane:0.1};g.object_origin=[0,0,0];g.loading=jQuery("#o3d_loading");o3djs.base.init(k);g.pack=g.client.createPack();var i=o3djs.rendergraph.createBasicView(g.pack,g.client.root,g.client.renderGraphRoot,[0.5,0.5,0.5,1]);g.viewInfo=i;i.drawContext.projection=g.math.matrix4.perspective(g.math.degToRad(30),g.client.width/g.client.height,1,5000);g.eyeView=[0,0,500];i.drawContext.view=g.math.matrix4.lookAt(g.eyeView,[0,0,0],[0,1,0]);g.aball=o3djs.arcball.create(100,100);g.client.setRenderCallback(g.renderCallback);jQuery("body").keydown(g.keyPressedCallback);o3djs.event.addEventListener(k,"wheel",g.scrollMe);g.loadSpectrumFromUrl("/assets/spectral_spectrum.txt");if(g.afterInit){g.afterInit(g)}g.updateInfo();jQuery("#screenshot").click(function(l){jQuery(this).attr("href",bb.client.toDataURL())})};this.uninit=function(){if(this.client){this.client.cleanup()}};this.renderCallback=function(i){g.setClientSize();if(g.autoRotate==true){}};this.createMaterial=function(i){var k=g.pack.createObject("Effect");var l=g.loadCombinedShaderFromUrl(i);k.loadFromFXString(l);var j=g.pack.createObject("Material");j.drawList=g.viewInfo.performanceDrawList;j.effect=k;k.createUniformParameters(j);return j};g.clearScreen=function(){if(brainbrowser.brainTransform!=undefined){if(brainbrowser.brainTransform.shapes!=undefined){var j=brainbrowser.brainTransform.shapes.length;for(var k=0;k<j;k++){brainbrowser.brainTransform.removeShape(brainbrowser.brainTransform.shapes[0])}}if(brainbrowser.brainTransform.children.length){var l=brainbrowser.brainTransform.children.length;for(var k=0;k<l;k++){var j=brainbrowser.brainTransform.children[k].length;brainbrowser.brainTransform.children[k].removeShape(brainbrowser.brainTransform.children[k].shapes[0])}}if(g.afterClearScreen!=undefined){g.afterClearScreen()}}};g.displayObjectFile=function(j,i){if(j.objectClass=="P"&&j.numberVertices<=81924){g.createBrain(j,i)}else{if(j.objectClass=="P"){g.createPolygonObject(j,i)}else{if(j.objectClass=="L"){g.createLineObject(j,i)}else{alert("Object file not supported")}}}if(g.afterDisplayObject!=undefined){g.afterDisplayObject(g.brainTransform)}};g.updateClearColor=function(i){g.viewInfo.clearBuffer.clearColor=i};g.updateClearColorFromName=function(i){if(i=="white"){g.updateClearColor([1,1,1,1])}else{if(i=="black"){g.updateClearColor([0,0,0,1])}else{if(i=="pink"){g.updateClearColor([1,0,1,1])}else{g.updateClearColor([0.5,0.5,0.5,1])}}}};function f(n){var o=n.getParam("transAlpha");o.value=1;var s=n.getParam("lightWorldPos");s.value=g.eyeView;var i=n.getParam("ambient");var m=n.getParam("ambientIntensity");var l=n.getParam("lightIntensity");var q=n.getParam("specular");var p=n.getParam("emissive");var j=n.getParam("colorMult");var r=n.getParam("wires");r.value=false;i.value=[0.04,0.04,0.04,1];m.value=[1,1,1,1];l.value=[0.8,0.8,0.8,1];q.value=[0.5,0.5,0.5,1];p.value=[0,0,0,1];j.value=[1,1,1,1];var k=n.getParam("shininess");k.value=30;return n}this.createBrain=function(j,i){g.model_data=j;if(j.num_hemispheres==2){var k={left:g.createHemisphere(j.left,"left"),right:g.createHemisphere(j.right,"right"),num_hemisphere:2}}else{var k=g.createHemisphere(j,"filename");k.num_hemisphere=1}if(g.brainTransform==null){g.brainTransform=g.pack.createObject("Transform");if(j.num_hemispheres==2){g.brainHemisphereTransforms={};g.brainHemisphereTransforms.left=g.pack.createObject("Transform");g.brainHemisphereTransforms.right=g.pack.createObject("Transform")}}else{g.brainTransform.removeShape(g.brainTransform.shapes[0]);if(g.brainTransform.children[0]!=null){g.brainTransform.children[0].removeShape(g.brainTransform.children[0].shapes[0])}if(g.brainTransform.children[1]!=null){g.brainTransform.children[1].removeShape(g.brainTransform.children[1].shapes[0])}}if(j.num_hemispheres!=2){g.brainTransform.removeParam(g.brainTransform.children[0]);g.brainTransform.removeParam(g.brainTransform.children[1])}if(j.num_hemispheres==2&&g.brainHemisphereTransforms==null){g.brainHemisphereTransforms={};g.brainHemisphereTransforms.left=g.pack.createObject("Transform");g.brainHemisphereTransforms.right=g.pack.createObject("Transform")}g.brainTransform.parent=g.client.root;if(k.num_hemisphere==1){g.brainTransform.addShape(k);k.createDrawElements(g.pack,null)}else{g.brainHemisphereTransforms.left.parent=g.brainTransform;g.brainHemisphereTransforms.right.parent=g.brainTransform;g.brainHemisphereTransforms.left.addShape(k.left);g.brainHemisphereTransforms.right.addShape(k.right);k.left.createDrawElements(g.pack,null);k.right.createDrawElements(g.pack,null)}g.model_data=j;if(g.afterCreateBrain!=undefined){g.afterCreateBrain(g.model_data)}};g.createLineObject=function(l,k){g.model_data=l;var i=g.createMaterial("/shaders/line.txt");var m=i.getParam("transAlpha");m.value=1;var j=g.createLineShape(i,l);j.name=k;if(g.brainTransform==undefined){g.brainTransform=g.pack.createObject("Transform")}g.brainTransform.parent=g.client.root;g.brainTransform.addShape(j);j.createDrawElements(g.pack,null);g.model_data=l;if(g.afterCreate!=undefined){g.afterCreate(g.model_data)}};g.createPolygonObject=function(l,k){g.model_data=l;var i=g.createMaterial("/shaders/blinnphong.txt");i=f(i);var j=g.createPolygonShape(i,l);j.name=k;if(g.brainTransform==undefined){g.brainTransform=g.pack.createObject("Transform")}g.brainTransform.parent=g.client.root;g.brainTransform.addShape(j);j.createDrawElements(g.pack,null);g.model_data=l;if(g.afterCreate!=undefined){g.afterCreate(g.model_data)}};g.createHemisphere=function(o,l){var p=g.createMaterial("/shaders/blinnphong.txt");p=f(p);var x=g.pack.createObject("Shape");var u=g.pack.createObject("Primitive");var z=g.pack.createObject("StreamBank");u.material=p;u.owner=x;u.streamBank=z;x.name=l;u.primitiveType=g.o3d.Primitive.TRIANGLELIST;var k=g.pack.createObject("State");k.getStateParam("AlphaBlendEnable").value=true;k.getStateParam("SourceBlendFunction").value=o3djs.base.o3d.State.BLENDFUNC_SOURCE_ALPHA;k.getStateParam("DestinationBlendFunction").value=o3djs.base.o3d.State.BLENDFUNC_INVERSE_SOURCE_ALPHA;k.getStateParam("AlphaTestEnable").value=true;k.getStateParam("AlphaComparisonFunction").value=o3djs.base.o3d.State.CMP_GREATER;u.material.state=k;var r=g.pack.createObject("VertexBuffer");var t=r.createField("FloatField",3);if(!o.positionArray){alert("PositionArray nil");return false}r.set(o.positionArray);g.numberVertices=o.numberVertices;var y=(o.positionArray.length/3);u.numberVertices=g.numberVertices;if(!o.indexArray){alert("Index Array nil");return false}u.numberPrimitives=o.indexArray.length/3;var n=g.pack.createObject("IndexBuffer");n.set(o.indexArray);u.indexBuffer=n;var w=g.pack.createObject("VertexBuffer");var q=w.createField("FloatField",3);w.set(o.normalArray);var s=[];if(o.colorArray.length==4){for(var m=0;m<y;m++){s.push.apply(s,o.colorArray)}}else{s=o.colorArray}if(s.length<o.positionArray.length){alert("Problem with the colors: "+s.length)}var v=g.pack.createObject("VertexBuffer");var j=v.createField("FloatField",4);v.set(s);s=[];if(g.loading){jQuery(g.loading).html("Buffers Loaded")}z.setVertexStream(g.o3d.Stream.POSITION,0,t,0);z.setVertexStream(g.o3d.Stream.NORMAL,0,q,0);z.setVertexStream(g.o3d.Stream.COLOR,0,j,0);return x};g.createLineShape=function(t,o,D){var s=g.pack.createObject("Shape");var C=g.pack.createObject("StreamBank");s.name=D;if(!o.positionArray){alert("PositionArray nil");return false}g.numberVertices=o.numberVertices;var z=g.pack.createObject("Primitive");z.material=t;z.owner=s;z.streamBank=C;z.primitiveType=g.o3d.Primitive.LINELIST;var q=g.pack.createObject("State");q.getStateParam("AlphaBlendEnable").value=true;q.getStateParam("SourceBlendFunction").value=o3djs.base.o3d.State.BLENDFUNC_SOURCE_ALPHA;q.getStateParam("DestinationBlendFunction").value=o3djs.base.o3d.State.BLENDFUNC_INVERSE_SOURCE_ALPHA;q.getStateParam("AlphaTestEnable").value=true;q.getStateParam("AlphaComparisonFunction").value=o3djs.base.o3d.State.CMP_GREATER;z.material.state=q;var m=new Array();for(var y=0;y<o.nitems;y++){if(y==0){var p=0}else{var p=o.endIndicesArray[y-1]}m.push(o.indexArray[p]);for(var w=p+1;w<o.endIndicesArray[y]-1;w++){m.push(o.indexArray[w]);m.push(o.indexArray[w])}m.push(o.indexArray[o.endIndicesArray[y]-1])}var n=g.pack.createObject("IndexBuffer");z.numberPrimitives=m.length/2;z.numberVertices=m.length;g.indexArray=m;var l=new Float32Array(m.length*3);for(var x=0;x<m.length;x++){l[x*3]=o.positionArray[m[x]*3];l[x*3+1]=o.positionArray[m[x]*3+1];l[x*3+2]=o.positionArray[m[x]*3+2]}var r=[];if(o.colorArray.length==4){for(var y=0;y<numberVertices;y++){r.push.apply(r,[0.5,0.5,0.7,1])}}else{r=new Float32Array(m.length*4);for(var x=0;x<m.length;x++){r[x*4]=o.colorArray[m[x]*4];r[x*4+1]=o.colorArray[m[x]*4+1];r[x*4+2]=o.colorArray[m[x]*4+2];r[x*4+3]=o.colorArray[m[x]*4+3]}}var A=g.pack.createObject("VertexBuffer");var u=A.createField("FloatField",3);A.set(l);C.setVertexStream(g.o3d.Stream.POSITION,0,u,0);if(r.length<o.positionArray.length){alert("Problem with the colors: "+r.length)}var v=g.pack.createObject("VertexBuffer");var B=v.createField("FloatField",4);v.set(r);r=[];C.setVertexStream(g.o3d.Stream.COLOR,0,B,0);if(g.loading){jQuery(g.loading).html("Buffers Loaded")}g.pack.gl.lineWidth(1);return s};g.createPolygonShape=function(r,n,C){var z=g.pack.createObject("Shape");var B=g.pack.createObject("StreamBank");z.name=C;if(!n.positionArray){alert("PositionArray nil");return false}g.numberVertices=n.numberVertices;var l=g.pack.createObject("Primitive");l.material=r;l.owner=z;l.streamBank=B;l.primitiveType=g.o3d.Primitive.TRIANGLELIST;var o=g.pack.createObject("State");o.getStateParam("AlphaBlendEnable").value=true;o.getStateParam("SourceBlendFunction").value=o3djs.base.o3d.State.BLENDFUNC_SOURCE_ALPHA;o.getStateParam("DestinationBlendFunction").value=o3djs.base.o3d.State.BLENDFUNC_INVERSE_SOURCE_ALPHA;o.getStateParam("AlphaTestEnable").value=true;o.getStateParam("AlphaComparisonFunction").value=o3djs.base.o3d.State.CMP_GREATER;l.material.state=o;var m=n.indexArray;l.numberPrimitives=m.length/3;l.numberVertices=m.length;g.indexArray=m;var k=new Float32Array(m.length*3);var x=new Float32Array(m.length*3);for(var v=0;v<m.length;v++){k[v*3]=n.positionArray[m[v]*3];k[v*3+1]=n.positionArray[m[v]*3+1];k[v*3+2]=n.positionArray[m[v]*3+2];x[v*3]=n.normalArray[m[v]*3];x[v*3+1]=n.normalArray[m[v]*3+1];x[v*3+2]=n.normalArray[m[v]*3+2]}var p=[];if(n.colorArray.length==4){for(var w=0;w<l.numberVertices;w++){p.push.apply(p,n.colorArray)}}else{p=new Float32Array(m.length*4);for(var v=0;v<m.length;v++){p[v*4]=n.colorArray[m[v]*4];p[v*4+1]=n.colorArray[m[v]*4+1];p[v*4+2]=n.colorArray[m[v]*4+2];p[v*4+3]=n.colorArray[m[v]*4+3]}}var q=g.pack.createObject("VertexBuffer");var t=q.createField("FloatField",3);q.set(x);B.setVertexStream(g.o3d.Stream.NORMAL,0,t,0);var y=g.pack.createObject("VertexBuffer");var s=y.createField("FloatField",3);y.set(k);B.setVertexStream(g.o3d.Stream.POSITION,0,s,0);if(p.length<n.positionArray.length){alert("Problem with the colors: "+p.length)}var u=g.pack.createObject("VertexBuffer");var A=u.createField("FloatField",4);u.set(p);p=[];B.setVertexStream(g.o3d.Stream.COLOR,0,A,0);if(g.loading){jQuery(g.loading).html("Buffers Loaded")}return z};g.createPinPoint=function(k){var p=g.pack.createObject("Transform");var m=g.createMaterial("/shaders/pinpoint.txt");var i=g.pack.createObject("Shape");var j=g.pack.createObject("Primitive");j.primitiveType=g.o3d.Primitive.POINTLIST;var q=g.pack.createObject("StreamBank");j.material=m;j.owner=i;j.streamBank=q;var l=this.model_data.getVertexInfo(k)["position_vector"];var n=g.pack.createObject("VertexBuffer");var o=n.createField("FloatField",3);n.set(l);q.setVertexStream(g.o3d.Stream.POSITION,0,o,0);p.addShape(i);i.createDrawElements(g.pack,null);return p};g.resetView=function(){g.brainTransform.children[0].visible=true;g.brainTransform.children[1].visible=true;g.brainTransform.identity();g.brainTransform.children[0].identity();g.brainTransform.children[1].identity()};this.setupView=function(i){g.resetView();if(g.model_data&&g.model_data.num_hemispheres==2){var j=g.getViewParams();switch(j.view){case"superior":g.superiorView();break;case"medial":g.medialView();break;case"anterior":g.anteriorView();break;case"inferior":g.inferiorView();break;case"lateral":g.lateralView();break;case"posterior":g.posteriorView();break;default:g.superiorView();break}}if(j.left==true){g.leftHemisphereVisible(true)}else{g.leftHemisphereVisible(false)}if(j.right==true){g.rightHemisphereVisible(true)}else{g.rightHemisphereVisible(false)}g.thatRot=g.math.matrix4.mul(g.brainTransform.localMatrix,g.math.matrix4.identity())};this.leftHemisphereVisible=function(i){g.brainTransform.children[0].visible=i};this.rightHemisphereVisible=function(i){g.brainTransform.children[1].visible=i};this.medialView=function(i){if(g.model_data.num_hemispheres==2){g.brainTransform.children[0].translate([-100,0,0]);g.brainTransform.children[1].translate([100,0,0]);g.brainTransform.children[0].rotateZ(g.math.degToRad(-90));g.brainTransform.children[1].rotateZ(g.math.degToRad(90));g.brainTransform.rotateX(g.math.degToRad(-90))}};this.lateralView=function(i){if(g.model_data.num_hemispheres==2){g.brainTransform.children[0].translate([-100,0,0]);g.brainTransform.children[1].translate([100,0,0]);g.brainTransform.children[0].rotateZ(g.math.degToRad(-90));g.brainTransform.children[1].rotateZ(g.math.degToRad(90));g.brainTransform.rotateX(g.math.degToRad(90));g.brainTransform.rotateY(g.math.degToRad(180))}};this.superiorView=function(){};this.inferiorView=function(){g.brainTransform.rotateY(g.math.degToRad(180))};this.anteriorView=function(i){g.resetView();g.brainTransform.rotateX(g.math.degToRad(-90));g.brainTransform.rotateZ(g.math.degToRad(180))};this.posteriorView=function(i){g.resetView();g.brainTransform.rotateX(g.math.degToRad(-90))};this.separateHemispheres=function(i){if(g.model_data.num_hemispheres==2){this.brainTransform.children[0].translate([-1,0,0]);this.brainTransform.children[1].translate([1,0,0])}};window.onresize=function(i){g.client.height=$(window).height()};this.setClientSize=function(){var j=parseInt(g.client.width);var i=parseInt(g.client.height);if(j!=g.o3dWidth||i!=g.o3dHeight){g.o3dWidth=j;g.o3dHeight=i;g.updateProjection();g.aball.setAreaSize(g.o3dWidth,g.o3dHeight)}};g.ZoomInOut=function(k){for(var j=0;j<g.eyeView.length;j+=1){g.eyeView[j]=g.eyeView[j]/k}g.viewInfo.drawContext.view=g.math.matrix4.lookAt(g.eyeView,[0,0,0],[0,1,0])};g.scrollMe=function(j){var i=(j.deltaY<0)?1/g.zoomFactor:g.zoomFactor;g.ZoomInOut(i);g.client.render()};function b(i){d();if(i){g.selectedInfo=i}}this.updateInfo=function(){if(!g.treeInfo){g.treeInfo=o3djs.picking.createPickManager(g.client.root)}g.treeInfo.update()};function d(){if(g.selectedInfo){g.highlightShape=null;g.selectedInfo=null}}this.click=function(o,l){var k=o3djs.picking.clientPositionToWorldRay(o.x,o.y,g.viewInfo.drawContext,g.client.width,g.client.height);d();g.treeInfo.update();var m=g.treeInfo.pick(k);if(m){b(m);var q=m.rayIntersectionInfo.primitiveIndex;var n=m.rayIntersectionInfo.position;var i=m.element.owner.name;var p=g.model_data.get_vertex(q,n,i);var j={ray_position:n,position_vector:p.position_vector,element:m.element,hemisphere:i,vertex:p.vertex};return l(o,j)}else{jQuery(g.pickInfoElem).html("--nothing--")}return false};g.getInfoForVertex=function(i){return g.model_data.getVertexInfo(i)};function h(j){var i;var k;if(j.pageX!=undefined&&j.pageY!=undefined){i=j.pageX;k=j.pageY}else{i=j.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;k=j.clientY+document.body.scrollTop+document.documentElement.scrollTop}i-=g.o3dElement.offsetLeft;k-=g.o3dElement.offsetTop;return{x:i,y:k}}g.startDragging=function(j){if(j.button==g.o3d.Event.BUTTON_RIGHT){var i=h(j);g.startPosition=o3djs.picking.clientPositionToWorldRay(i.x,i.y,g.viewInfo.drawContext,g.client.height,g.client.width).far;g.dragging=true}else{if(j.shiftKey&&j.ctrlKey&&g.model_data.num_hemispheres==2){g.drag_hemisphere=click(j,function(k,l){if(l.hemisphere=="left"){return 0}else{if(l.hemisphere=="right"){return 1}else{return false}}})}g.lastRot=g.thatRot;g.aball.click([j.x,j.y]);g.dragging=true}};g.drag=function(p){if(g.dragging&&p.button==g.o3d.Event.BUTTON_LEFT){var k=g.aball.drag([p.x,p.y]);var j=g.quaternions.quaternionToRotation(k);g.thatRot=g.math.matrix4.mul(g.lastRot,j);if(g.drag_hemisphere===0||g.drag_hemisphere===1){var i=g.brainTransform.children[g.drag_hemisphere].localMatrix;g.math.matrix4.setUpper3x3(i,g.thatRot);g.brainTransform.children[g.drag_hemisphere].localMatrix=i}else{var i=g.brainTransform.localMatrix;g.math.matrix4.setUpper3x3(i,g.thatRot);g.brainTransform.localMatrix=i}}else{if(g.dragging&&p.button==g.o3d.Event.BUTTON_RIGHT){var o=h(p);var n=o3djs.picking.clientPositionToWorldRay(o.x,o.y,g.viewInfo.drawContext,g.client.height,g.client.width).far;q=[0,0,0];var l=g.eyeView[0];var q=[(n[0]-g.startPosition[0])/5000*g.eyeView[2],(n[1]-g.startPosition[1])/5000*g.eyeView[2],0];g.startPosition=n;g.brainTransform.translate(q)}else{if(g.dragging){g.stopDragging(p)}}}};g.stopDragging=function(i){g.drag_hemisphere=false;g.dragging=false};g.updateCamera=function(){var i=[0,1,0];g.viewInfo.drawContext.view=g.math.matrix4.lookAt(g.camera.eye,g.camera.target,i);g.lightPosParam.value=g.camera.eye};g.updateProjection=function(){g.viewInfo.drawContext.projection=g.math.matrix4.perspective(g.math.degToRad(45),g.o3dWidth/g.o3dHeight,g.camera.nearPlane,g.camera.farPlane)};g.keyPressedAction=function(i,k){var j=false;switch(i){case"&":g.ZoomInOut(g.zoomFactor);j="zoom_in";break;case"(":g.ZoomInOut(1/g.zoomFactor);j="zoom_out";break;case" ":g.separateHemispheres();j="separate";break}return j};g.keyPressedCallback=function(j){var i=false;switch(j.which){case 38:g.ZoomInOut(g.zoomFactor);i="ZoomIn";break;case 40:g.ZoomInOut(1/g.zoomFactor);i="ZoomOut";break;case 32:g.separateHemispheres();i="Seperate";break}if(i){return false}else{return true}};g.set_fill_mode_wireframe=function(){if(g.model_data.num_hemispheres==2){var i=g.brainTransform.children[0].shapes[0].elements[0].material;g.state=g.pack.createObject("State");i.state=g.state;var j=i.getParam("wires");j.value=true;g.state.getStateParam("FillMode").value=g.o3d.State.WIREFRAME;i=g.brainTransform.children[1].shapes[0].elements[0].material;i.state=g.state;j=i.getParam("wires");j.value=true}else{var i=g.brainTransform.shapes[0].elements[0].material;g.state=g.pack.createObject("State");i.state=g.state;g.state.getStateParam("FillMode").value=g.o3d.State.WIREFRAME;var j=i.getParam("wires");j.value=true}g.client.render()};g.set_fill_mode_solid=function(){if(g.model_data.num_hemispheres==2){var i=g.brainTransform.children[0].shapes[0].elements[0].material;g.state1=g.pack.createObject("State");i.state=g.state1;var j=i.getParam("wires");j.value=false;g.state.getStateParam("FillMode").value=g.o3d.State.SOLID;i=g.brainTransform.children[1].shapes[0].elements[0].material;i.state=g.state;var j=i.getParam("wires");j.value=false}else{var i=g.brainTransform.shapes[0].elements[0].material;g.state=g.pack.createObject("State");i.state=g.state;g.state.getStateParam("FillMode").value=g.o3d.State.SOLID;var j=i.getParam("wires");j.value=false}};function a(i,j,k){jQuery.ajax({type:"GET",url:i,dataType:"text",success:function(l){k(l)},error:function(l,n,m){alert("Failure: "+n)},data:{},async:j,timeout:100000})}function c(l,k){var i=new FileReader();var j=l.files;i.file=j[0];i.onloadend=function(m){k(m.target.result)};i.readAsText(j[0])}g.loadObjFromUrl=function(i){a(i,false,function(k){var l=i.split("/");var j=l[l.length-1];g.displayObjectFile(new MNIObject(k),j)})};g.loadObjFromFile=function(i){c(i,function(j){var l=i.value.split("\\");var k=l[l.length-1];g.displayObjectFile(new MNIObject(j),k)})};g.loadSpectrumFromUrl=function(i){a(i,true,function(k){var j=new Spectrum(k);g.spectrum=j;if(g.afterLoadSpectrum!=null){g.afterLoadSpectrum(j)}if(g.data){g.updateColors(g.data,g.rangeMin,g.rangeMax,g.spectrum,g.flip,g.clamped)}})};g.loadSpectrumFromFile=function(i){c(i,function(k){var j=new Spectrum(k);g.spectrum=j;if(g.afterLoadSpectrum!=null){g.afterLoadSpectrum(j)}if(g.data){g.updateColors(g.data,g.rangeMin,g.rangeMax,g.spectrum,g.flip,g.clamped)}})};g.loadDataFromFile=function(o){var i=o.files[0].name;var m=function(q){var p=new Data(q);if(p.values.length<g.model_data.positionArray.length/4){alert("Number of numbers in datafile lower than number of vertices Vertices"+g.model_data.positionArray.length/3+" data values:"+p.values.length);return -1}else{g.data=p}if(g.fixRange==false||g.fixRange==null){g.rangeMin=g.data.min;g.rangeMax=g.data.max;if(g.afterLoadData!=null){g.afterLoadData(g.rangeMin,g.rangeMax,g.data)}}g.updateColors(g.data,g.rangeMin,g.rangeMax,g.spectrum,g.flip,g.clamped);return null};if(i.match(/.*.mnc|.*.nii/)){var n=new XMLHttpRequest();if(i.match(/.*.mnc/)){n.open("POST","/minc/volume_object_evaluate",false)}else{n.open("POST","/nii/volume_object_evaluate",false)}var k=document.getElementById("datafile-form");var l=new FormData(k);n.send(l);var j=n.response;m(j)}else{c(o,m)}};g.loadSeriesDataFromFile=function(o){console.log(o.files.length);var n=o.files.length;g.seriesData=new Array(n);g.seriesData.numberFiles=n;var l=o.files;for(var k=0;k<n;k++){var j=new FileReader();j.file=l[k];var m=j.onloadend=(function(p,i){return function(q){console.log(q.target.result.length);console.log(i);g.seriesData[i]=new Data(q.target.result);g.seriesData[i].fileName=p.name}})(j.file,k);j.readAsText(l[k])}g.setupSeries()};g.setupSeries=function(){$('<div id="series">Series: </div>').appendTo("#surface_choice");var i=$("#series");$('<span id="series-value">0</span>').appendTo(i);$('<div id="series-slider" width="100px" + height="10"></div>').slider({value:0,min:0,max:g.seriesData.numberFiles-1,step:0.1,slide:function(j,k){if(k.value-Math.floor(k.value)<0.01){g.data=g.seriesData[k.value]}else{if(g.seriesData[0].fileName.match("pval.*")){g.data=new Data(interpolateDataArray(g.seriesData[Math.floor(k.value)],g.seriesData[Math.floor(k.value)+1],(k.value-Math.floor(k.value)),true))}else{g.data=new Data(interpolateDataArray(g.seriesData[Math.floor(k.value)],g.seriesData[Math.floor(k.value)+1],(k.value-Math.floor(k.value))))}}if(g.seriesData[0].fileName.match("mt.*")){$("#age_series").html("Age: "+(k.value*3+5).toFixed(1))}else{if(g.seriesData[0].fileName.match("pval.*")){$("#age_series").html("Age: "+(k.value*1+10))}}$(i).children("#series-value").html(k.value);if(g.data.values.length<g.model_data.positionArray.length/4){console.log("Number of numbers in datafile lower than number of vertices Vertices"+g.model_data.positionArray.length/3+" data values:"+g.data.values.length);return -1}if(g.fixRange==false||g.fixRange==null){g.rangeMin=g.data.min;g.rangeMax=g.data.max;if(g.afterLoadData!=null){g.afterLoadData(g.rangeMin,g.rangeMax,g.data)}}g.updateColors(g.data,g.rangeMin,g.rangeMax,g.spectrum,g.flip,g.clamped);return null}}).appendTo(i)};g.loadDataFromUrl=function(i){a(i,true,function(j){g.data=new Data(j);if(g.fixRange==false||g.fixRange==null){g.rangeMin=g.data.min;g.rangeMax=g.data.max;if(g.afterLoadData!=undefined){g.afterLoadData(g.rangeMin,g.rangeMax,g.data)}}g.updateColors(g.data,g.rangeMin,g.rangeMax,g.spectrum)})};g.loadCombinedShaderFromUrl=function(i){var j;a(i,false,function(k){j=k});return j};g.updateColors=function(C,u,x,A,l,t){g.clamped=t;var B=C.createColorArray(u,x,A,l,t,g.model_data.colorArray);if(g.model_data.num_hemispheres==1){var q=g.pack.createObject("VertexBuffer");var v=q.createField("FloatField",4);q.set(B);var k=g.brainTransform.shapes[0];var o=k.elements[0].streamBank;o.setVertexStream(g.o3d.Stream.COLOR,0,v,0)}else{var j=B.slice(0,B.length/2);var s=B.slice(B.length/2,B.length);var p=g.pack.createObject("VertexBuffer");var y=p.createField("FloatField",4);p.set(j);var n=g.brainTransform.children[0].shapes[0];var r=n.elements[0].streamBank;r.setVertexStream(g.o3d.Stream.COLOR,0,y,0);var w=g.pack.createObject("VertexBuffer");var m=w.createField("FloatField",4);w.set(s);var z=g.brainTransform.children[1].shapes[0];var i=z.elements[0].streamBank;i.setVertexStream(g.o3d.Stream.COLOR,0,m,0);g.client.render()}if(g.afterUpdateColors!=null){g.afterUpdateColors(C,u,x,A)}return 1};g.rangeChange=function(j,i,k){g.rangeMin=j;g.rangeMax=i;g.updateColors(g.data,g.rangeMin,g.rangeMax,g.spectrum,g.flip,k);if(g.afterRangeChange!=null){g.afterRangeChange(j,i)}};g.changeShapeTransparency=function(n,o){var l=null;if(g.brainTransform.shapes!=undefined){for(var m=0;m<g.brainTransform.shapes.length;m++){if(g.brainTransform.shapes[m].name==n){l=g.brainTransform.shapes[m]}}}for(var j=0;j<g.brainTransform.children.length;j++){for(var m=0;m<g.brainTransform.children[j].shapes.length;m++){if(g.brainTransform.children[j].shapes[m].name==n){l=g.brainTransform.children[j].shapes[m]}}}if(l){l.elements[0].material.getParam("transAlpha").value=o}};g.getImageUrl=function(){var l=document.createElement("canvas");var i=document.getElementById("spectrum_canvas");l.width=g.o3dElement.width;l.height=g.o3dElement.height;var m=l.getContext("2d");var j=new Image;function k(){var n=new Image();n.onload=function(){m.drawImage(n,0,0);window.open(l.toDataURL(),"screenshot")};n.src=i.toDataURL()}j.onload=function(){m.drawImage(j,0,0);k()};j.src=g.o3dElement.toDataURL()};g.init()}var brainbrowser;function SurfView(){var a=this;brainbrowser=new BrainBrowser();this.brainbrowser=brainbrowser;brainbrowser.getViewParams=function(){return{view:jQuery("[name=hem_view]:checked").val(),left:jQuery("#left_hem_visible").attr("checked"),right:jQuery("#right_hem_visible").attr("checked")}};brainbrowser.afterLoadSpectrum=function(b){var c=b.createSpectrumCanvasWithScale(0,100,null);c.id="spectrum_canvas";jQuery('<div id="spectrum" class="box full_box"></div>').html(c).appendTo("#controls");brainbrowser.spectrumObj=b};brainbrowser.afterDisplayObject=function(d){$("#shapes").html("");if(d.shapes!=undefined){for(var e=0;e<d.shapes.length;e++){var c=d.shapes[e];$('<div id="shape_'+e+'" data-shape-name="'+c.name+'" class="shape"><h4>Shape '+(e+1)+"</h4>Name: "+c.name+'<br />Opacity: <div class="opacity-slider slider"  data-shape-name='+c.name+"></div></div>").appendTo("#shapes")}}if(d.children.length>0){for(var b=0;b<d.children.length;b++){for(var e=0;e<d.children[b].shapes.length;e++){var c=d.children[b].shapes[e];$('<div id="shape_'+e+'" data-shape-name="'+c.name+'" class="shape"><h4>Shape '+(e+1)+"</h4>Name: "+c.name+'<br />Opacity: <div class="opacity-slider slider"  data-shape-name='+c.name+"></div></div>").appendTo("#shapes")}}}brainbrowser.afterClearScreen=function(){$("#shapes").html("")};$(".opacity-slider").slider({value:100,min:0,max:100,slide:function(f,h){var g=$(f.target).attr("data-shape-name");var i=$(f.target).slider("value")/100;brainbrowser.changeShapeTransparency(g,i)}})};jQuery("#resetview").click(brainbrowser.setupView);jQuery(".view_button").change(brainbrowser.setupView);jQuery("[name=hem_view]").change(brainbrowser.setupView);this.updateCoordinates=function(b,d,c){jQuery("#x-coord").val(b[0]);jQuery("#y-coord").val(b[1]);jQuery("#z-coord").val(b[2]);jQuery("#v-coord").val(d);jQuery("#value-coord").val(c)};brainbrowser.afterInit=function(b){b.clamped=true;b.flip=false;b.clearScreen();b.loadObjFromUrl("/models/surf_reg_model_both.obj");jQuery("body").keydown(b.keyPressedCallback);o3djs.event.addEventListener(b.o3dElement,"mousedown",function(c){if(c.shiftKey){b.click(c,function(f,d){if(brainbrowser.data){a.updateCoordinates(d.position_vector,d.vertex,brainbrowser.data.values[d.vertex])}})}else{b.startDragging(c)}});o3djs.event.addEventListener(b.o3dElement,"mousemove",function(c){b.drag(c)});o3djs.event.addEventListener(b.o3dElement,"mouseup",function(c){if(!c.shiftKey||c.button==b.o3d.Event.BUTTON_RIGHT){b.stopDragging(c)}});$(b.o3dElement).bind("contextmenu",function(c){return false});jQuery("#range-slider").slider({range:true,min:-50,max:50,value:[-10,10],slide:function(e,f){var d=parseFloat(f.values[0]);var c=parseFloat(f.values[1]);b.rangeChange(d,c,$("#clamp_range").attr("checked"))},step:0.1});b.afterRangeChange=function(e,c){jQuery("#data-range-min").val(e);jQuery("#data-range-max").val(c);var d=b.spectrumObj.createSpectrumCanvasWithScale(e,c,null);d.id="spectrum_canvas";jQuery("#spectrum").html(jQuery(d))};b.afterLoadData=function(d,c,e){b.afterRangeChange(d,c);jQuery("#range-slider").slider("values",0,parseFloat(d));jQuery("#range-slider").slider("values",1,parseFloat(c))};jQuery("#meshmode").change(function(c){if(jQuery(c.target).attr("checked")==true){b.set_fill_mode_wireframe()}else{b.set_fill_mode_solid()}});jQuery("#clearshapes").click(function(c){brainbrowser.clearScreen()});jQuery("#openImage").click(function(c){brainbrowser.getImageUrl()});jQuery("#fix_range").click(function(c,d){b.fixRange=jQuery("#fix_range").attr("checked")});jQuery("#clamp_range").change(function(f){var d=parseFloat(jQuery("#data-range-min").val());var c=parseFloat(jQuery("#data-range-max").val());if($(f.target).attr("checked")==true){b.rangeChange(d,c,true)}else{b.rangeChange(d,c,false)}});jQuery("#flip_range").change(function(c){b.flip=$(c.target).attr("checked");b.updateColors(b.data,b.data.min,b.data.max,brainbrowser.spectrum,b.flip,b.clamped)});jQuery(".range-box").keypress(function(c){if(c.keyCode=="13"){b.rangeChange(parseFloat(jQuery("#data-range-min").val()),parseFloat(jQuery("#data-range-max").val()))}});jQuery("#clearColor").change(function(d){var c=$(d.target).val();b.updateClearColorFromName(c)});jQuery("#data-range-min").change(function(c){jQuery("#range-slider").slider("values",0,parseFloat(jQuery(this).val()))});jQuery("#data-range-max").change(function(c){jQuery("#range-slider").slider("values",1,parseFloat(jQuery(this).val()))});$("#examples").click(function(d){var c=$(d.target).attr("data-example-name");switch(c){case"basic":b.clearScreen();b.loadObjFromUrl("/models/surf_reg_model_both.obj");break;case"punkdti":b.clearScreen();b.loadObjFromUrl("/models/dti.obj");b.loadObjFromUrl("/models/left_color.obj");b.loadObjFromUrl("/models/right_color.obj");break;case"realct":b.clearScreen();b.loadObjFromUrl("/models/realct.obj");b.loadDataFromUrl("/models/realct.txt");break}return false})}};