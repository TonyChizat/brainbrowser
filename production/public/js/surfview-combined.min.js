function Data(b){var a=this;a.parse=function(c){c=c.replace(/\s+$/,"");c=c.replace(/^\s+/,"");a.values=c.split(/\s+/);for(var d=0;d<a.values.length;d++){a.values[d]=parseFloat(a.values[d])}a.min=a.values.min();a.max=a.values.max()};this.createColorArray=function(g,o,n,k,r,d,l){var n=n.colors;var q=new Array();var p=((o-g)+(o-g)/n.length)/n.length;for(var h=0;h<a.values.length;h++){if(a.values[h]<=g){if(a.values[h]<g&&!r){var s=-1}else{var s=0}}else{if(a.values[h]>o){if(!r){var s=-1}else{var s=n.length-1}}else{var s=parseInt((a.values[h]-g)/p)}}if(k&&s!=-1){q.push.apply(q,n[n.length-1-s])}else{if(s==-1){if(d.length==4){q.push.apply(q,d)}else{q.push.apply(q,[d[h*4],d[h*4+1],d[h*4+2],d[h*4+3]])}}else{q.push.apply(q,n[s])}}}if(l.num_hemisphere!=2){var m=[];var c=l.indexArray.length;for(var f=0;f<c;f++){m[f*4]=q[l.indexArray[f]*4];m[f*4+1]=q[l.indexArray[f]*4+1];m[f*4+2]=q[l.indexArray[f]*4+2];m[f*4+3]=q[l.indexArray[f]*4+3]}q.nonIndexedColorArray=m}return q};if(b){if(typeof b=="string"){a.parse(b)}else{if(b.values!=undefined){this.values=cloneArray(b.values);this.min=this.values.min();this.max=this.values.max()}else{console.log("copying data length: "+b.length);this.values=b;this.min=b.min();this.max=b.max()}}}}Array.prototype.min=function(){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.min.apply(Math,this.slice(c,c+b-1)))}}else{return Math.min.apply(Math,this)}return a.min()};Array.prototype.max=function(d){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.max.apply(Math,this.slice(c,c+b-1)))}}else{return Math.max.apply(Math,this)}return a.max()};function cloneArray(b){var c=new Array(b.length);for(var a=0;a<c.length;a++){c[a]=b[a]}return c}function rotateUint16Array90Left(g,d,a){var f=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){f[c*a+b]=g[b*d+(d-c)]}}return f}function rotateUint16Array90Right(g,d,a){var f=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){f[c*a+b]=g[(a-b)*d+c]}}return f}function interpolateDataArray(h,c,b,a){console.log(h.values.length);var f=h.values.length;var g=new Array(f);console.log("Percentage: "+b);for(var d=0;d<f;d++){if(a){g[d]=(h.values[d]*(100-b*100)+c.values[d]*(b*100))/100}else{g[d]=(h.values[d]*(100-b*100)+c.values[d]*(b*100))/100}}console.log(g.length);return g}function ColorManager(){function c(m,d,q,j,o,l,n,h,g){var m=m.colors;var p=((o-j)+(o-j)/m.length)/m.length;for(var k=0;k<q.length;k++){if(q[k]<=j){var r=0}else{if(q[k]>o){var r=m.length-1}else{var r=parseInt((q[k]-j)/p)}}if(l){var f=255}else{var f=1}d[k*4+0]=f*m[r][0]*h+n*f;d[k*4+1]=f*m[r][1]*h+n*f;d[k*4+2]=f*m[r][2]*h+n*f;if(g){d[k*4+3]=f*g}else{d[k*4+3]=f}}return d}this.createColorMap=c;function a(l){var d=l[0];for(var h=0;h<l[0].length/4;h++){for(var g=1;g<l.length;g++){var f=d[h*4+3];var k=l[g][h*4+3];d[h*4]=d[h*4]*f+l[g][h*4]*k;d[h*4+1]=d[h*4+1]*f+l[g][h*4+1]*k;d[h*4+2]=d[h*4+2]*f+l[g][h*4+2]*k;d[h*4+3]=f+k}}return d}this.blendColors=a;function b(f,m,k,h){var d=m.length;var l=new Array(d);var j=0;for(var g=0;g<d;g++){l[g]=c(f,new Array(m[g].values.length),m[g].values,m[g].rangeMin,m[g].rangeMax,false,0,1,m[g].alpha)}return a(l)}this.blendColorMap=b}function Spectrum(f){var c=this;var a=new ColorManager();function b(g,q,j,p){var l=document.createElement("canvas");jQuery(l).attr("width",256);jQuery(l).attr("height",j);var m=new Array(256);for(var o=0;o<256;o++){if(p){m[255-o]=o}else{m[o]=o}}g=a.createColorMap(c,[],m,0,255,true,0,1);var h=l.getContext("2d");for(var n=0;n<256;n++){h.fillStyle="rgb("+parseInt(g[n*4])+","+parseInt(g[n*4+1])+","+parseInt(g[n*4+2])+")";h.fillRect(n,0,1,q)}console.log("rgb("+parseInt(g[100*4+0])+","+parseInt(g[100*4+1])+","+parseInt(g[100*4+2]));console.log(h.fillStyle);return l}c.createSpectrumCanvas=function(g){if(g==null){g=c.colors}var h=b(g,20,20,false);return h};c.createSpectrumCanvasWithScale=function(l,g,h,m){if(h==null){h=c.colors}var j=b(h,20,40,m);var k=j.getContext("2d");k.fillStyle="#FFA000";k.fillRect(0.5,20,1,10);k.fillText(l.toPrecision(3),0.5,40);k.fillRect(j.width/4,20,1,10);k.fillText(((l+g)/4).toPrecision(3),j.width/4,40);k.fillRect(j.width/2,20,1,10);k.fillText(((l+g)/2).toPrecision(3),j.width/2,40);k.fillRect(3*(j.width/4),20,1,10);k.fillText((3*((l+g)/4)).toPrecision(3),3*(j.width/4),40);k.fillRect(j.width-0.5,20,1,10);k.fillText(g.toPrecision(3),j.width-20,40);return j};function d(n){n=n.replace(/\s+$/,"");n=n.replace(/^\s+/,"");var l=n.split(/\n/);var g=new Array();for(var j=0;j<l.length;j++){var m=l[j].replace(/\s+$/,"").split(/\s+/);for(var h=0;h<m.length;h++){m[h]=parseFloat(m[h])}if(m.length<4){m.push(1)}g.push(m)}c.colors=g;return g}if(f!=undefined){d(f)}}function WavefrontObj(o){var m=this;o=o.split("\n");m.shapes=[];var b;var c=[];var u=[];var s=[];b={name:o.name|"undefined",faces:[],positionArray:[],colorArray:[],indexArray:[],texIndexArray:[],normalIndexArray:[]};m.shapes.push(b);for(var p=0;p<o.length;p++){var v=o[p].split(/\s+/);if(!(v[0].match("#"))||v==""){if(v[0]=="o"|v[0]=="g"){console.log(v[1]);b={name:v[1],faces:[],positionArray:[],colorArray:[],indexArray:[],texIndexArray:[],normalIndexArray:[]};m.shapes.push(b)}else{if(v[0]=="v"){c.push(parseFloat(v[1]));c.push(parseFloat(v[2]));c.push(parseFloat(v[3]))}else{if(v[0]=="vt"){for(var f=1;f<v.length;f++){u.push(parseFloat(v[f]))}}else{if(v[0]=="vn"){s.push(parseFloat(v[1]));s.push(parseFloat(v[2]));s.push(parseFloat(v[3]))}else{if(v[0]=="f"){var t=[];for(var j=1;j<4;j++){var g=v[j].split("/");t.push(parseInt(g[0])-1);b.indexArray.push(parseInt(g[0])-1);b.texIndexArray.push(parseInt(g[1])-1);if(g[2]){b.normalIndexArray.push(parseInt(g[2])-1)}}if(v.length>=4){for(j;j<v.length;j++){var g=v[j].split("/");t.push(parseInt(g[0])-1);var q=b.indexArray.length;b.indexArray.push(b.indexArray[q-1]);b.indexArray.push(b.indexArray[q-3]);b.indexArray.push(g[0]-1)}}b.faces.push(t)}}}}}}}var a=Array(c.length/3);var d=m.shapes.length;for(var h=0;h<d;h++){var r=m.shapes[h];r.positionArray=c;if(r.colorArray.length==0){r.colorArray=[0.8,0.8,0.8,1]}}m.objectClass="P";m.vertexArray=c;m.texCoordArray=u}function MNIObject(d){var k;var h=this;function b(n){h.num_hemispheres=1;var m=n.replace(/\s+$/,"");var o=m.replace(/^\s+/,"");k=o.split(/\s+/).reverse();h.objectClass=k.pop();if(h.objectClass=="P"){f();h.numberVertices=parseInt(k.pop());g();l();h.nitems=parseInt(k.pop())}else{if(h.objectClass=="L"){f();h.numberVertices=parseInt(k.pop());g();h.nitems=parseInt(k.pop())}else{throw new Error("That object class is not supported currently")}}j();c();a();if(h.objectClass=="P"){if(h.positionArray.length==81924*3){h.brainSurface=true;h.split_hemispheres()}}}function f(){if(h.objectClass=="P"){h.surfaceProperties={ambient:parseFloat(k.pop()),diffuse:parseFloat(k.pop()),specular_reflectance:parseFloat(k.pop()),specular_scattering:parseFloat(k.pop()),transparency:parseFloat(k.pop())}}else{if(h.objectClass=="L"){h.surfaceProperties={width:k.pop()}}}}function g(){h.positionArray=new Array();for(var m=0;m<h.numberVertices;m++){for(var n=0;n<3;n++){h.positionArray.push(parseFloat(k.pop()))}}}function l(){h.normalArray=new Array();for(var o=0;o<h.numberVertices;o++){for(var m=0;m<3;m++){h.normalArray.push(parseFloat(k.pop()))}}}function j(){h.colorFlag=parseInt(k.pop());h.colorArray=new Array();if(h.colorFlag===0){for(var m=0;m<4;m++){h.colorArray.push(parseFloat(k.pop()))}}else{if(h.colorFlag===1){for(var n=0;n<h.numberPolygons;n++){for(var m=0;m<4;m++){h.colorArray.push(parseFloat(k.pop()))}}}else{if(h.colorFlag===2){for(var n=0;n<h.numberVertices;n++){for(var m=0;m<4;m++){h.colorArray.push(parseFloat(k.pop()))}}}else{throw new Error("colorFlag not valid in that file")}}}}function c(){h.endIndicesArray=new Array();for(var m=0;m<h.nitems;m++){h.endIndicesArray.push(parseInt(k.pop()))}}function a(){h.indexArray=new Array();var n=k.length;for(var m=0;m<n;m++){h.indexArray.push(parseInt(k.pop()))}}h.split_hemispheres=function(){h.left={};h.right={};var q=h.positionArray.length;h.left.positionArray=h.positionArray.slice(0,q/2);h.right.positionArray=h.positionArray.slice(q/2,q);var p=h.indexArray.length;h.left.indexArray=h.indexArray.slice(0,p/2);h.right.indexArray=h.indexArray.slice(p/2,p);for(var m=0;m<h.right.indexArray.length;m++){h.right.indexArray[m]=h.right.indexArray[m]-2-p/3/2/2}var n=h.normalArray.length;h.left.normalArray=h.normalArray.slice(0,n/2);h.right.normalArray=h.normalArray.slice(n/2,n);h.left.colorFlag=h.colorFlag;h.right.colorFlag=h.colorFlag;if(h.colorFlag==0||h.colorFlag==1){h.left.colorArray=h.colorArray;h.right.colorArray=h.colorArray}else{var o=h.colorArray.length;h.left.colorArray=h.colorArray.slice(0,o/2);h.right.colorArray=h.colorArray.slice(o/2+1,-1)}h.left.numberVertices=h.numberVertices/2;h.right.numberVertices=h.numberVertices/2;h.left.numberPolygons=h.numberPolygons/2;h.right.numberPolygons=h.numberPolygons/2;h.num_hemispheres=2};h.getVertexInfo=function(n){var m=[h.positionArray[n*3],h.positionArray[n*3+1],h.positionArray[n*3+2]];return{vertex:n,position_vector:m}};h.get_vertex=function(w,t,m){if(h.num_hemispheres>1){var s=h[m];var p=0;if(m=="right"){p=2+s.indexArray.length/3/2}}else{var s=h;var p=0}var r=new Array();var z=w*3;for(var q=0;q<3;q++){r.push(s.indexArray[z+q])}var x=new Array();for(var q=0;q<3;q++){var v=r[q]*3;x[q]=new Array();for(var o=0;o<3;o++){x[q][o]=s.positionArray[v+o]}}var y=new Array();for(var q=0;q<3;q++){y.push(o3djs.math.distance(t,x[q]))}var n=0;if(y[1]<y[0]){n=1}if(y[2]<y[n]){n=2}var u=r[n]+p;var A=x[n];return{vertex:u,position_vector:A}};if(d){b(d)}}function bbObject(a){var b=a;b.createBrain=function(d,c){b.model_data=d;if(d.num_hemispheres==2){var f={left:b.createHemisphere(d.left,"left"),right:b.createHemisphere(d.right,"right"),num_hemisphere:2}}else{var f=b.createHemisphere(d,"filename");f.num_hemisphere=1}if(b.brainTransform==null){b.brainTransform=b.pack.createObject("Transform");if(d.num_hemispheres==2){b.brainHemisphereTransforms={};b.brainHemisphereTransforms.left=b.pack.createObject("Transform");b.brainHemisphereTransforms.right=b.pack.createObject("Transform")}}else{b.brainTransform.removeShape(b.brainTransform.shapes[0]);if(b.brainTransform.children[0]!=null){b.brainTransform.children[0].removeShape(b.brainTransform.children[0].shapes[0])}if(b.brainTransform.children[1]!=null){b.brainTransform.children[1].removeShape(b.brainTransform.children[1].shapes[0])}}if(d.num_hemispheres!=2){b.brainTransform.removeParam(b.brainTransform.children[0]);b.brainTransform.removeParam(b.brainTransform.children[1])}if(d.num_hemispheres==2&&b.brainHemisphereTransforms==null){b.brainHemisphereTransforms={};b.brainHemisphereTransforms.left=b.pack.createObject("Transform");b.brainHemisphereTransforms.right=b.pack.createObject("Transform")}b.brainTransform.parent=b.client.root;if(f.num_hemisphere==1){b.brainTransform.addShape(f);f.createDrawElements(b.pack,null)}else{b.brainHemisphereTransforms.left.parent=b.brainTransform;b.brainHemisphereTransforms.right.parent=b.brainTransform;b.brainHemisphereTransforms.left.addShape(f.left);b.brainHemisphereTransforms.right.addShape(f.right);f.left.createDrawElements(b.pack,null);f.right.createDrawElements(b.pack,null)}b.model_data=d;if(b.afterCreateBrain!=undefined){b.afterCreateBrain(b.model_data)}};b.createLineObject=function(g,f,j){b.model_data=g;var c=b.createMaterial("/shaders/line.txt");var h=c.getParam("transAlpha");h.value=1;if(j){console.log("mesh")}var d=b.createLineShape(c,g,f,j);d.name=f;if(b.brainTransform==undefined){b.brainTransform=b.pack.createObject("Transform")}b.brainTransform.parent=b.client.root;b.brainTransform.addShape(d);d.createDrawElements(b.pack,null);b.model_data=g;if(b.afterCreate!=undefined){b.afterCreate(b.model_data)}};b.createPolygonObject=function(g,f){b.model_data=g;var c=b.createMaterial("/shaders/blinnphong.txt");c=b.blinnphongParams(c);if(b.brainTransform==undefined){b.brainTransform=b.pack.createObject("Transform")}b.brainTransform.parent=b.client.root;if(g.shapes){console.log("multi_shape");console.log(g);for(var h=0;h<g.shapes.length;h++){console.log(g.shapes[h]);var d=b.createPolygonShape(c,g.shapes[h]);d.name=g.shapes[h].name;b.brainTransform.addShape(d);d.createDrawElements(b.pack,null)}}else{var d=b.createPolygonShape(c,g);d.name=f;b.brainTransform.addShape(d);d.createDrawElements(b.pack,null)}b.model_data=g;if(b.afterCreate!=undefined){b.afterCreate(b.model_data)}};b.createHemisphere=function(j,f){var k=b.createMaterial("/shaders/blinnphong.txt");k=b.blinnphongParams(k);var s=b.pack.createObject("Shape");var p=b.pack.createObject("Primitive");var u=b.pack.createObject("StreamBank");p.material=k;p.owner=s;p.streamBank=u;s.name=f;p.primitiveType=b.o3d.Primitive.TRIANGLELIST;var d=b.pack.createObject("State");b.enableAlphaBlending(d);p.material.state=d;var m=b.pack.createObject("VertexBuffer");var o=m.createField("FloatField",3);if(!j.positionArray){alert("PositionArray nil");return false}m.set(j.positionArray);b.numberVertices=j.numberVertices;var t=(j.positionArray.length/3);p.numberVertices=b.numberVertices;if(!j.indexArray){alert("Index Array nil");return false}p.numberPrimitives=j.indexArray.length/3;var h=b.pack.createObject("IndexBuffer");h.set(j.indexArray);p.indexBuffer=h;var r=b.pack.createObject("VertexBuffer");var l=r.createField("FloatField",3);r.set(j.normalArray);var n=[];if(j.colorArray.length==4){for(var g=0;g<t;g++){n.push.apply(n,j.colorArray)}}else{n=j.colorArray}if(n.length<j.positionArray.length){alert("Problem with the colors: "+n.length)}var q=b.pack.createObject("VertexBuffer");var c=q.createField("FloatField",4);q.set(n);n=[];if(b.loading){jQuery(b.loading).html("Buffers Loaded")}u.setVertexStream(b.o3d.Stream.POSITION,0,o,0);u.setVertexStream(b.o3d.Stream.NORMAL,0,l,0);u.setVertexStream(b.o3d.Stream.COLOR,0,c,0);return s};b.createLineShape=function(p,h,z,c){var o=b.pack.createObject("Shape");var y=b.pack.createObject("StreamBank");o.name=z;if(!h.positionArray){alert("PositionArray nil");return false}b.numberVertices=h.numberVertices;var v=b.pack.createObject("Primitive");v.material=p;v.owner=o;v.streamBank=y;v.primitiveType=b.o3d.Primitive.LINELIST;var m=b.pack.createObject("State");b.enableAlphaBlending(m);v.material.state=m;var f=new Array();for(var u=0;u<h.nitems;u++){if(u==0){var l=0}else{var l=h.endIndicesArray[u-1]}f.push(h.indexArray[l]);for(var s=l+1;s<h.endIndicesArray[u]-1;s++){f.push(h.indexArray[s]);f.push(h.indexArray[s])}f.push(h.indexArray[h.endIndicesArray[u]-1])}if(!c){var g=b.pack.createObject("IndexBuffer");v.numberPrimitives=f.length/2;v.numberVertices=f.length;b.indexArray=f;var d=new Float32Array(f.length*3);for(var t=0;t<f.length;t++){d[t*3]=h.positionArray[f[t]*3];d[t*3+1]=h.positionArray[f[t]*3+1];d[t*3+2]=h.positionArray[f[t]*3+2]}var n=[];if(h.colorArray.length==4){for(var u=0;u<numberVertices;u++){n.push.apply(n,[0.5,0.5,0.7,1])}}else{n=new Float32Array(f.length*4);for(var t=0;t<f.length;t++){n[t*4]=h.colorArray[f[t]*4];n[t*4+1]=h.colorArray[f[t]*4+1];n[t*4+2]=h.colorArray[f[t]*4+2];n[t*4+3]=h.colorArray[f[t]*4+3]}}}else{console.log("mesh shape");v.numberVertices=h.meshPostionArray.length/3;v.numberPrimitives=v.numberVertices/2;var d=h.meshPositionArray;var n=h.meshColorArray}var w=b.pack.createObject("VertexBuffer");var q=w.createField("FloatField",3);w.set(d);y.setVertexStream(b.o3d.Stream.POSITION,0,q,0);if(n.length/4<d.length/3){alert("Problem with the colors: "+n.length)}var r=b.pack.createObject("VertexBuffer");var x=r.createField("FloatField",4);r.set(n);y.setVertexStream(b.o3d.Stream.COLOR,0,x,0);if(b.loading){jQuery(b.loading).html("Buffers Loaded")}b.pack.gl.lineWidth(1);return o};b.createPolygonShape=function(p,g,G){var D=b.pack.createObject("Shape");var F=b.pack.createObject("StreamBank");D.name=G;if(!g.positionArray){alert("PositionArray nil");return false}b.numberVertices=g.numberVertices;var d=b.pack.createObject("Primitive");d.material=p;d.owner=D;d.streamBank=F;d.primitiveType=b.o3d.Primitive.TRIANGLELIST;var h=b.pack.createObject("State");b.enableAlphaBlending(h);d.material.state=h;if(g.nonindexed==undefined){var f=g.indexArray;d.numberPrimitives=f.length/3;d.numberVertices=f.length;b.indexArray=f;var c=new Float32Array(f.length*3);var B=new Array(f.length*3);var q=new Array(f.length*4);var A=new Float32Array(f.length*3);var n=f.length;for(var x=0;x<n;x++){c[x*3]=g.positionArray[f[x]*3];c[x*3+1]=g.positionArray[f[x]*3+1];c[x*3+2]=g.positionArray[f[x]*3+2];A[x*3]=g.normalArray[f[x]*3];A[x*3+1]=g.normalArray[f[x]*3+1];A[x*3+2]=g.normalArray[f[x]*3+2]}for(var w=0;w<n;w+=3){var z=[];z[0]=[g.positionArray[f[w]*3],g.positionArray[f[w]*3+1],g.positionArray[f[w]*3+2]];z[1]=[g.positionArray[f[w+1]*3],g.positionArray[f[w+1]*3+1],g.positionArray[f[w+1]*3+2]];z[2]=[g.positionArray[f[w+2]*3],g.positionArray[f[w+2]*3+1],g.positionArray[f[w+2]*3+2]];B.push.apply(B,z[0]);B.push.apply(B,z[1]);B.push.apply(B,z[1]);B.push.apply(B,z[2]);B.push.apply(B,z[2]);B.push.apply(B,z[0])}D.meshPositionArray=B}else{d.numberPrimitives=g.positionArray.length/3/3;d.numberVertices=g.positionArray.length/3;var c=new Float32Array(g.positionArray);var A=new Float32Array(g.normalArray);console.log(g)}var m=[];if(g.colorArray.length==4){for(var y=0;y<d.numberVertices;y++){m.push.apply(m,g.colorArray)}}else{m=new Float32Array(f.length*4);var n=f.length;for(var x=0;x<n;x++){m[x*4]=m[x*4+1]=g.colorArray[f[x]*4+1];m[x*4+2]=g.colorArray[f[x]*4+2];m[x*4+3]=g.colorArray[f[x]*4+3]}for(var u=0;u<indexArrayLenght;u+=3){var v=[];v[0]=[g.colorArray[f[x]*4],g.colorArray[f[x]*4+1],g.colorArray[f[x]*4+2],g.colorArray[f[x]*4+3]];v[1]=[g.colorArray[f[x+1]*4],g.colorArray[f[x+1]*4+1],g.colorArray[f[x+1]*4+2],g.colorArray[f[x+1]*4+3]];v[2]=[g.colorArray[f[x+2]*4],g.colorArray[f[x+2]*4+1],g.colorArray[f[x+2]*4+2],g.colorArray[f[x+2]*4+3]];q.push.apply(q,v[0]);q.push.apply(q,v[1]);q.push.apply(q,v[1]);q.push.apply(q,v[2]);q.push.apply(q,v[2]);q.push.apply(q,v[0])}}g.meshPositionArray=B;g.meshColorArray=q;var o=b.pack.createObject("VertexBuffer");var s=o.createField("FloatField",3);o.set(A);F.setVertexStream(b.o3d.Stream.NORMAL,0,s,0);var C=b.pack.createObject("VertexBuffer");var r=C.createField("FloatField",3);C.set(c);F.setVertexStream(b.o3d.Stream.POSITION,0,r,0);if(m.length<g.positionArray.length){alert("Problem with the colors: "+m.length)}var t=b.pack.createObject("VertexBuffer");var E=t.createField("FloatField",4);t.set(m);m=[];F.setVertexStream(b.o3d.Stream.COLOR,0,E,0);if(b.loading){jQuery(b.loading).html("Buffers Loaded")}return D}}function BrainBrowser(){var g=this;bbObject(this);var j=new ColorManager();var d;var u;var x;var w;var y;var m=new THREE.Object3D();var h;var v;this.start=function(){window.onload=function(){setTimeout(function(){g.init()},1)}};this.init=function(){y=new THREE.Scene();d=$("#view-window");x=new THREE.PerspectiveCamera(30,d.width()/d.height(),0.1,5000);if(f()){u=new THREE.WebGLRenderer({clearColor:8947848,clearAlpha:1,preserveDrawingBuffer:true})}else{d.html(n());return}u.setSize(d.width(),d.height());d.append(u.domElement);x.position.z=500;w=new THREE.PointLight(16777215);w.position.x=0;w.position.y=0;w.position.z=500;y.add(w);h=new THREE.TrackballControls(x,d[0]);v=new THREE.TrackballControls(w,d[0]);h.zoomSpeed=2;v.zoomSpeed=2;function D(E){requestAnimationFrame(D);h.update();v.update();g.renderCallback()}if(this.afterInit){this.afterInit(g)}window.onresize();g.loadSpectrumFromUrl("/assets/spectral_spectrum.txt");D()};
/*! 
   * WebGL test taken from Detector.js by
   * alteredq / http://alteredqualia.com/
   * mr.doob / http://mrdoob.com/
  */
function f(){try{return !!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(D){return false}}function n(){var E='BrainBrowser requires <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>.<br/>';E+=window.WebGLRenderingContext?"Your browser seems to support it, but it is <br/> disabled or unavailable.<br/>":"Your browser does not seem to support it.<br/>";E+='Test your browser\'s WebGL support <a href="http://get.webgl.org/">here</a>.';var D=$('<div id="webgl-error">'+E+"</div>");return D}this.setCamera=function(D,F,E){x.position.set(D,F,E)};this.getModel=function(){return m};function k(F,G){g.model_data=F;var E=q(F.left);E.name="left";E.model_num=0;var D=q(F.right);D.name="right";D.model_num=1;m.add(E);m.add(D);y.add(m)}function q(G){var L=G.positionArray;var F=G.indexArray;var K={};var E={};for(var H=0;H+2<L.length;H+=3){r(K,L[H],L[H+1],L[H+2])}E.x=K.minX+0.5*(K.maxX-K.minX);E.y=K.minY+0.5*(K.maxY-K.minY);E.z=K.minY+0.5*(K.maxZ-K.minZ);var J=new THREE.Geometry();for(var H=0;H+2<L.length;H+=3){J.vertices.push(new THREE.Vector3(L[H]-E.x,L[H+1]-E.y,L[H+2]-E.z))}for(var H=0;H+2<F.length;H+=3){J.faces.push(new THREE.Face3(F[H],F[H+1],F[H+2]))}J.computeFaceNormals();J.computeVertexNormals();var I=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:526344,vertexColors:THREE.VertexColors});var D=new THREE.Mesh(J,I);D.centroid=E;D.position.set(E.x,E.y,E.z);return D}function t(F,D,H,G){var E=p(F,H);E.name=D;if(G){E.renderDepth=G}m.add(E);y.add(m)}function p(K,T){g.model_data=K;var S=[];var Q=[];var D=[];var O={};var F={};for(var L=0;L<g.model_data.nitems;L++){if(L==0){var E=0}else{var E=g.model_data.endIndicesArray[L-1]}S.push(g.model_data.indexArray[E]);for(var I=E+1;I<g.model_data.endIndicesArray[L]-1;I++){S.push(g.model_data.indexArray[I]);S.push(g.model_data.indexArray[I])}S.push(g.model_data.indexArray[g.model_data.endIndicesArray[L]-1])}var P=g.model_data.positionArray;for(var J=0;J<S.length;J++){r(O,P[S[J]*3],P[S[J]*3+1],P[S[J]*3+2])}F.x=O.minX+0.5*(O.maxX-O.minX);F.y=O.minY+0.5*(O.maxY-O.minY);F.z=O.minY+0.5*(O.maxZ-O.minZ);if(!T){for(var J=0;J<S.length;J++){Q.push(new THREE.Vector3(P[S[J]*3]-F.x,P[S[J]*3+1]-F.y,P[S[J]*3+2]-F.z))}var R=[];if(g.model_data.colorArray.length==4){for(var L=0;L<numberVertices;L++){R.push.apply(R,[0.5,0.5,0.7,1])}}else{var R=g.model_data.colorArray;for(var J=0;J<S.length;J++){var G=new THREE.Color();G.setRGB(R[S[J]*4],R[S[J]*4+1],R[S[J]*4+2]);D.push(G)}}}else{console.log("mesh shape");Q=g.model_data.meshPositionArray;D=g.model_data.meshColorArray}var N=new THREE.Geometry();N.vertices=Q;N.colors=D;N.colorsNeedUpdate=true;var M=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});var H=new THREE.Line(N,M,THREE.LinePieces);H.position.set(F.x,F.y,F.z);H.centroid=F;return H}function A(G,E,H){g.model_data=G;if(g.model_data.shapes){for(var F=0;F<g.model_data.shapes.length;F++){var D=l(g.model_data.shapes[F]);D.name=g.model_data.shapes[F].name;m.add(D)}}else{var D=l(g.model_data);D.name=E;m.add(D)}if(g.afterCreate!=undefined){g.afterCreate(g.model_data)}y.add(m)}function l(O){var J=O.positionArray;var P=O.indexArray;var Q=[];if(O.colorArray.length==4){for(var I=0;I<J.length/3;I++){Q.push(O.colorArray[0]);Q.push(O.colorArray[1]);Q.push(O.colorArray[2])}}else{Q=[];var G=P.length;for(var H=0;H+2<O.colorArray.length;H+=4){Q.push(O.colorArray[H]);Q.push(O.colorArray[H+1]);Q.push(O.colorArray[H+2])}}var D=[];var F;var M=new THREE.Geometry();for(var I=0;I+2<J.length;I+=3){M.vertices.push(new THREE.Vector3(J[I],J[I+1],J[I+2]));F=new THREE.Color();F.setRGB(Q[I],Q[I+1],Q[I+2]);D.push(F)}if(O.faces&&O.faces.length>0){var E=O.faces;for(var I=0;I<E.length;I++){if(E[I].length<3){continue}if(E[I].length<=4){if(E[I].length<=3){var L=new THREE.Face3(E[I][0],E[I][1],E[I][2])}else{if(E[I].length==4){var L=new THREE.Face4(E[I][0],E[I][1],E[I][2],E[I][3])}}L.vertexColors[0]=D[L.a];L.vertexColors[1]=D[L.b];L.vertexColors[2]=D[L.c];if(E[I].length>3){L.vertexColors[3]=D[L.d]}M.faces.push(L)}else{for(var H=1;H+1<E[I].length;H++){var L=new THREE.Face3(E[I][0],E[I][H],E[I][H+1]);L.vertexColors[0]=D[L.a];L.vertexColors[1]=D[L.b];L.vertexColors[2]=D[L.c];M.faces.push(L)}}}}else{for(var I=0;I+2<P.length;I+=3){var L=new THREE.Face3(P[I],P[I+1],P[I+2]);L.vertexColors[0]=D[L.a];L.vertexColors[1]=D[L.b];L.vertexColors[2]=D[L.c];M.faces.push(L)}}M.computeFaceNormals();M.computeVertexNormals();M.colorsNeedUpdate=true;var K=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:526344,vertexColors:THREE.VertexColors});var N=new THREE.Mesh(M,K);if(g.loading){jQuery(g.loading).html("Buffers Loaded")}return N}this.uninit=function(){if(this.client){this.client.cleanup()}};this.renderCallback=function(D){if(g.autoRotate){if(g.autoRotate.x){m.rotation.x+=0.01}if(g.autoRotate.y){m.rotation.y+=0.01}if(g.autoRotate.z){m.rotation.z+=0.01}}u.render(y,x)};this.clearScreen=function(){if(m){y.remove(m)}g.resetView();m=new THREE.Object3D();if(g.afterClearScreen!=undefined){g.afterClearScreen()}};this.displayObjectFile=function(G,D,F){var E=F||{};var H=E.renderDepth;if(G.objectClass=="P"&&G.numberVertices==81924){k(G,H)}else{if(G.objectClass=="P"){A(G,D,H)}else{if(G.objectClass=="L"){t(G,D,false,H)}else{alert("Object file not supported")}}}if(g.afterDisplayObject!=undefined){g.afterDisplayObject(m)}};function c(F,D,E){if(E==null){E=g.model_data.data}if(E.fixRange==false||E.fixRange==null){E.rangeMin=F;E.rangeMax=D}}this.updateClearColor=function(D){u.setClearColor(new THREE.Color(D))};this.updateClearColorFromName=function(D){if(D=="white"){g.updateClearColor(16777215)}else{if(D=="black"){g.updateClearColor(0)}else{if(D=="pink"){g.updateClearColor(16711935)}else{g.updateClearColor(8947848)}}}};this.resetView=function(){h.reset();v.reset();m.position.set(0,0,0);m.rotation.set(0,0,0);for(var D=0;D<m.children.length;D++){var E=m.children[D];E.visible=true;if(E.centroid){E.position.set(E.centroid.x,E.centroid.y,E.centroid.z)}else{E.position.set(0,0,0)}E.rotation.set(0,0,0)}};this.setupView=function(D){g.resetView();if(g.model_data&&g.model_data.num_hemispheres==2){var E=g.getViewParams();switch(E.view){case"superior":g.superiorView();break;case"medial":g.medialView();break;case"anterior":g.anteriorView();break;case"inferior":g.inferiorView();break;case"lateral":g.lateralView();break;case"posterior":g.posteriorView();break;default:g.superiorView();break}}if(m.getChildByName("left")){if(E.left==true){g.leftHemisphereVisible(true)}else{g.leftHemisphereVisible(false)}}if(m.getChildByName("right")){if(E.right==true){g.rightHemisphereVisible(true)}else{g.rightHemisphereVisible(false)}}};function a(D){return D*Math.PI/180}this.leftHemisphereVisible=function(D){m.getChildByName("left").visible=D};this.rightHemisphereVisible=function(D){m.getChildByName("right").visible=D};this.medialView=function(D){if(g.model_data.num_hemispheres==2){m.getChildByName("left").position.x-=100;m.getChildByName("left").rotation.z-=a(90);m.getChildByName("right").position.x+=100;m.getChildByName("right").rotation.z+=a(90);m.rotation.x+=a(-90)}};this.lateralView=function(D){if(g.model_data.num_hemispheres==2){m.getChildByName("left").position.x-=100;m.getChildByName("left").rotation.z+=a(-90);m.getChildByName("right").position.x+=100;m.getChildByName("right").rotation.z+=a(90);m.rotation.x+=a(90);m.rotation.y+=a(180)}};this.superiorView=function(){};this.inferiorView=function(){m.rotation.y+=a(180)};this.anteriorView=function(D){g.resetView();m.rotation.x+=a(-90);m.rotation.z+=a(180)};this.posteriorView=function(D){g.resetView();m.rotation.x+=a(-90)};this.separateHemispheres=function(D){if(g.model_data.num_hemispheres==2){m.children[0].position.x-=1;m.children[1].position.x+=1}};this.ZoomInOut=function(D){x.fov*=D;x.updateProjectionMatrix()};g.scrollMe=function(E){var D=(E.deltaY<0)?1/g.zoomFactor:g.zoomFactor;g.ZoomInOut(D);g.client.render()};function s(D){z();if(D){g.selectedInfo=D}}function z(){if(g.selectedInfo){g.highlightShape=null;g.selectedInfo=null}}this.click=function(H,E){var J=d.offset();mouseX=((H.clientX-J.left)/d.width())*2-1;mouseY=-((H.clientY-J.top)/d.height())*2+1;var I=new THREE.Projector();var F=new THREE.Raycaster();z();var D=new THREE.Vector3(mouseX,mouseY,1);I.unprojectVector(D,x);F.set(x.position,D.sub(x.position).normalize());var G=F.intersectObject(m,true);if(G.length>0){return E(H,G[0])}else{jQuery(g.pickInfoElem).html("--nothing--");return false}};this.getInfoForVertex=function(D){return g.model_data.getVertexInfo(D)};this.keyPressedCallback=function(E){var D=false;switch(E.which){case 38:g.ZoomInOut(1.1);D="ZoomIn";break;case 40:g.ZoomInOut(1/1.1);D="ZoomOut";break;case 32:g.separateHemispheres();D="Seperate";break}if(D){return false}else{return true}};function r(F,D,G,E){if(!F.minX||F.minX>D){F.minX=D}if(!F.maxX||F.maxX<D){F.maxX=D}if(!F.minY||F.minY>G){F.minY=G}if(!F.maxY||F.maxY<G){F.maxY=G}if(!F.minZ||F.minZ>E){F.minZ=E}if(!F.maxZ||F.maxZ<E){F.maxZ=E}}function o(D,I,H){var G=new THREE.SphereGeometry(2);var F=new THREE.MeshBasicMaterial({color:16711680});var E=new THREE.Mesh(G,F);E.position.set(D,I,H);y.add(E)}this.set_fill_mode_wireframe=function(){var E=m.children;for(var D=0;D<E.length;D++){E[D].material.wireframe=true}};this.set_fill_mode_solid=function(){var E=m.children;for(var D=0;D<E.length;D++){E[D].material.wireframe=false}};function C(D,E,F){jQuery.ajax({type:"GET",url:D,dataType:"text",success:function(G){F(G)},error:function(G,I,H){alert("Failure in loadFromURL: "+I)},data:{},async:E,timeout:100000})}function b(G,F){var D=new FileReader();var E=G.files;D.file=E[0];D.onloadend=function(H){F(H.target.result)};D.readAsText(E[0])}this.loadObjFromUrl=function(D,E){C(D,false,function(G){var H=D.split("/");var F=H[H.length-1];g.displayObjectFile(new MNIObject(G),F,E)})};this.loadWavefrontObjFromUrl=function(D,E){C(D,false,function(G){var H=D.split("/");var F=H[H.length-1];g.displayObjectFile(new WavefrontObj(G),F,E)})};this.loadObjFromFile=function(F,E){var D=E||{};b(F,function(G){var J=F.value.split("\\");var H=J[J.length-1];var I;if(D.format=="wavefront"){I=new WavefrontObj(G)}else{I=new MNIObject(G)}g.displayObjectFile(I,H,D)})};this.loadSpectrumFromUrl=function(D){C(D,true,function(F){var E=new Spectrum(F);g.spectrum=E;if(g.afterLoadSpectrum!=null){g.afterLoadSpectrum(E)}if(g.model_data.data){g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum,g.flip,g.clamped)}})};this.loadSpectrumFromFile=function(D){b(D,function(F){var E=new Spectrum(F);g.spectrum=E;if(g.afterLoadSpectrum!=null){g.afterLoadSpectrum(E)}if(g.model_data.data){g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum,g.flip,g.clamped)}})};function B(D){}this.loadDataFromFile=function(J){var D=J.files[0].name;var H=function(L){var K=new Data(L);K.fileName=D;if(K.values.length<g.model_data.positionArray.length/4){alert("Number of numbers in datafile lower than number of vertices Vertices"+g.model_data.positionArray.length/3+" data values:"+K.values.length);return -1}else{g.model_data.data=K}c(g.model_data.data.min,g.model_data.data.max);if(g.afterLoadData!=null){g.afterLoadData(g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.model_data.data)}g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum,g.flip,g.clamped);return null};if(D.match(/.*.mnc|.*.nii/)){var I=new XMLHttpRequest();if(D.match(/.*.mnc/)){I.open("POST","/minc/volume_object_evaluate",false)}else{I.open("POST","/nii/volume_object_evaluate",false)}var F=document.getElementById("datafile-form");var G=new FormData(F);I.send(G);var E=I.response;H(E)}else{b(J,H)}};this.loadSeriesDataFromFile=function(I){console.log(I.files.length);var H=I.files.length;g.seriesData=new Array(H);g.seriesData.numberFiles=H;var F=I.files;for(var E=0;E<H;E++){var D=new FileReader();D.file=F[E];var G=D.onloadend=(function(K,J){return function(L){console.log(L.target.result.length);console.log(J);g.seriesData[J]=new Data(L.target.result);g.seriesData[J].fileName=K.name}})(D.file,E);D.readAsText(F[E])}g.setupSeries()};this.setupSeries=function(){$('<div id="series">Series: </div>').appendTo("#surface_choice");var D=$("#series");$('<span id="series-value">0</span>').appendTo(D);$('<div id="series-slider" width="100px" + height="10"></div>').slider({value:0,min:0,max:g.seriesData.numberFiles-1,step:0.1,slide:function(E,F){if(F.value-Math.floor(F.value)<0.01){g.model_data.data=g.seriesData[F.value]}else{if(g.seriesData[0].fileName.match("pval.*")){g.model_data.data=new Data(interpolateDataArray(g.seriesData[Math.floor(F.value)],g.seriesData[Math.floor(F.value)+1],(F.value-Math.floor(F.value)),true))}else{g.model_data.data=new Data(interpolateDataArray(g.seriesData[Math.floor(F.value)],g.seriesData[Math.floor(F.value)+1],(F.value-Math.floor(F.value))))}}if(g.seriesData[0].fileName.match("mt.*")){$("#age_series").html("Age: "+(F.value*3+5).toFixed(1))}else{if(g.seriesData[0].fileName.match("pval.*")){$("#age_series").html("Age: "+(F.value*1+10))}}$(D).children("#series-value").html(F.value);if(g.model_data.data.values.length<g.model_data.positionArray.length/4){console.log("Number of numbers in datafile lower than number of vertices Vertices"+g.model_data.positionArray.length/3+" data values:"+g.model_data.data.values.length);return -1}c(g.model_data.data.min,g.model_data.data.max);if(g.afterLoadData!=null){g.afterLoadData(g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.model_data.data)}g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum,g.flip,g.clamped);return null}}).appendTo(D)};this.loadBlendDataFromFile=function(I){var H=I.files.length;g.blendData=new Array(H);g.blendData.numberFiles=H;var F=I.files;for(var E=0;E<H;E++){var D=new FileReader();D.file=F[E];var G=D.onloadend=(function(K,J){return function(M){g.blendData[J]=new Data(M.target.result);g.blendData.alpha=1/H;g.blendData[J].fileName=K.name;for(var L=0;L<2;L++){if(g.blendData[L]==undefined){console.log("not done yet");return}}c(g.blendData[0].values.min(),g.blendData[0].values.max(),g.blendData[0]);c(g.blendData[1].values.min(),g.blendData[1].values.max(),g.blendData[1]);if(g.afterLoadData!=null){g.afterLoadData(null,null,g.blendData,true)}g.blend($(".blend_slider").slider("value"))}})(D.file,E);D.readAsText(F[E])}g.setupBlendColors()};this.setupBlendColors=function(){console.log("Blend colors has ran "+g.blendData.numberFiles);$("#blend").remove();$('<div id="blend">Blend ratios: </div>').appendTo("#surface_choice");var D=$("#blend");$('<span id="blend_value'+i+'">0</span>').appendTo(D);$('<div class="blend_slider" id="blend_slider'+i+'" width="100px" + height="10"></div>').slider({value:0,min:0.1,max:0.99,value:0.5,step:0.01,slide:function(E,F){g.blend($(this).slider("value"))}}).appendTo(D)};this.blend=function(E){g.blendData[0].alpha=E;g.blendData[1].alpha=1-E;for(var D=2;D<g.blendData.length;D++){g.blendData[D].alpha=0}g.updateColors(g.blendData,null,null,g.spectrum,g.flip,g.clamped,true)};this.loadDataFromUrl=function(E,D){C(E,true,function(G,F){g.model_data.data=new Data(G);g.model_data.data.fileName=D;c(g.model_data.data.min,g.model_data.data.max);if(g.afterLoadData!=undefined){g.afterLoadData(g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.model_data.data)}g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum)})};this.loadCombinedShaderFromUrl=function(D){var E;C(D,false,function(F){E=F});return E};this.updateColors=function(Z,P,T,X,J,O,S,E){g.clamped=O;if(S){var Y=j.blendColorMap(X,Z,0,1)}else{var Y=Z.createColorArray(P,T,X,J,O,g.model_data.colorArray,g.model_data)}if(g.model_data.num_hemispheres==2){var D=Y.slice(0,Y.length/2);var N=Y.slice(Y.length/2,Y.length);var L=[];var V=[];for(var U=0;U+2<Y.length;U+=4){var I=new THREE.Color();I.setRGB(D[U],D[U+1],D[U+2]);L.push(I);I=new THREE.Color();I.setRGB(N[U],N[U+1],N[U+2]);V.push(I)}var Q=m.getChildByName("left");var W=Q.geometry.faces;for(var U=0;U<W.length;U++){var K=W[U];K.vertexColors[0]=L[K.a];K.vertexColors[1]=L[K.b];K.vertexColors[2]=L[K.c];if(K.d){K.vertexColors[3]=L[K.d]}}Q.geometry.colorsNeedUpdate=true;var F=m.getChildByName("right");var G=F.geometry.faces;for(var U=0;U<G.length;U++){var K=G[U];K.vertexColors[0]=V[K.a];K.vertexColors[1]=V[K.b];K.vertexColors[2]=V[K.c];if(K.d){K.vertexColors[3]=V[K.d]}}F.geometry.colorsNeedUpdate=true}else{var M=[];for(var U=0;U+2<Y.length;U+=4){var I=new THREE.Color();I.setRGB(Y[U],Y[U+1],Y[U+2]);M.push(I)}var H=g.brain.children;for(var U=0;U<H.length;U++){for(var R=0;R<H[U].faces.length;R++){var K=H[U].faces[R];K.vertexColors[0]=M[K.a];K.vertexColors[1]=M[K.b];K.vertexColors[2]=M[K.c];if(K.d){K.vertexColors[3]=M[K.d]}}H[U].geometry.colorsNeedUpdate=true}}if(g.afterUpdateColors!=null){g.afterUpdateColors(Z,P,T,X)}return 1};this.rangeChange=function(E,D,F){g.model_data.data.rangeMin=E;g.model_data.data.rangeMax=D;g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum,g.flip,F);if(g.afterRangeChange!=null){g.afterRangeChange(E,D)}};this.changeShapeTransparency=function(E,F){var D=m.getChildByName(E);if(D){D.material.opacity=F;if(F==1){D.material.transparent=false}else{D.material.transparent=true}}};this.getImageUrl=function(){var G=document.createElement("canvas");var D=document.getElementById("spectrum_canvas");G.width=d.width();G.height=d.height();var H=G.getContext("2d");var E=new Image();function F(){var I=new Image();I.onload=function(){H.drawImage(I,0,0);window.open(G.toDataURL(),"screenshot")};I.src=D.toDataURL()}E.onload=function(){H.drawImage(E,0,0);if(D){F()}else{window.open(G.toDataURL(),"screenshot")}};E.src=u.domElement.toDataURL()};window.onresize=function(){d=$("#view-window");u.setSize(d.width(),d.height());x.aspect=d.width()/d.height();x.updateProjectionMatrix()};g.start()}var brainbrowser;function SurfView(a){var b=this;brainbrowser=new BrainBrowser();this.brainbrowser=brainbrowser;brainbrowser.getViewParams=function(){return{view:jQuery("[name=hem_view]:checked").val(),left:jQuery("#left_hem_visible").attr("checked"),right:jQuery("#right_hem_visible").attr("checked")}};brainbrowser.afterLoadSpectrum=function(c){var d=c.createSpectrumCanvasWithScale(0,100,null);d.id="spectrum_canvas";var f=document.getElementById("color_bar");if(!f){jQuery('<div id="color_bar"></div>').html(d).appendTo("#data-range")}else{jQuery(f).html(d)}brainbrowser.spectrumObj=c};brainbrowser.afterDisplayObject=function(d){$("#shapes").html("");if(d.children.length>0){for(var f=0;f<d.children.length;f++){var c=d.children[f];$('<div id="shape_'+f+'" data-shape-name="'+c.name+'" class="shape"><h4>Shape '+(f+1)+"</h4>Name: "+c.name+'<br />Opacity: <div class="opacity-slider slider"  data-shape-name='+c.name+"></div></div>").appendTo("#shapes")}}brainbrowser.afterClearScreen=function(){$("#shapes").html("")};$(".opacity-slider").slider({value:100,min:-1,max:101,slide:function(g,j){var h=$(g.target).attr("data-shape-name");var k=$(g.target).slider("value");k=Math.min(100,Math.max(0,k))/100;brainbrowser.changeShapeTransparency(h,k)}})};jQuery("#resetview").click(brainbrowser.setupView);jQuery(".view_button").change(brainbrowser.setupView);jQuery("[name=hem_view]").change(brainbrowser.setupView);this.updateCoordinates=function(c,f,d){jQuery("#x-coord").val(c[0]);jQuery("#y-coord").val(c[1]);jQuery("#z-coord").val(c[2]);jQuery("#v-coord").val(f);jQuery("#value-coord").val(d)};brainbrowser.afterInit=function(f){f.clamped=true;f.flip=false;f.clearScreen();if(typeof a=="string"&&a!=""){f.loadObjFromUrl(a)}else{if(typeof a=="function"){console.log("loading models");a(f)}}jQuery("body").keydown(f.keyPressedCallback);jQuery("#range-slider").slider({range:true,min:-50,max:50,value:[-10,10],slide:function(j,k){var h=parseFloat(k.values[0]);var g=parseFloat(k.values[1]);f.rangeChange(h,g,$("#clamp_range").attr("checked"))},step:0.1});f.afterRangeChange=function(j,g){jQuery("#data-range-min").val(j);jQuery("#data-range-max").val(g);var h=f.spectrumObj.createSpectrumCanvasWithScale(j,g,null);h.id="spectrum_canvas";jQuery("#color_bar").html(jQuery(h))};function d(m){var g=$("#data-range");$(g).html("");var l='<div id="data_range_multiple"><ul>';if(!m.length){var m=[m]}for(var j=0;j<m.length;j++){l+='<li><a href="#data_file'+j+'">'+m[j].fileName+"</a></li>"}l+="</ul>";for(var h=0;h<m.length;h++){l+='<div id="data_file'+h+'" class="box full_box"><h4>Thresholding</h4>Min: <input class="range-box" id="data-range-min" type="text" name="range_min" size="5" ><br /><div id="range-slider+'+h+'" data-blend-index="'+h+'" class="slider"></div>Max: <input class="range-box" id="data-range-max" type="text" name="range_max" size="5" ><input type="checkbox" class="button" id="fix_range"><label for="fix_range">Fix Range</label><input type="checkbox" class="button" id="clamp_range" checked="true"><label for="clamp_range">Clamp range</label><input type="checkbox" class="button" id="flip_range"><label for="flip_range">Flip Colors</label></div>'}l+="</div>";$(g).html(l);$(g).tabs();$("#data_range").find(".slider").each(function(k,o){$(o).slider({range:true,min:m[0].values.min(),max:m[0].values.max(),values:[m[k].rangeMin,m[k].rangeMax],step:0.1,slide:function(q,r){var p=$(this).attr("data-blend-index");m[0].rangeMin=r.values[0];m[0].rangeMax=r.values[1];f.model_data.data=m[0];f.updateColors(f.model_data.data,f.model_data.data.rangeMin,f.model_data.data.rangeMax,f.spectrum,f.flip,f.clamped,false);f.rangeChange(m[0].rangeMin,m[0].rangeMax,f.clamped)}})});function n(p){var o=$("#data-range-min").val();var k=$("#data-range-max").val();jQuery(p.target).siblings(".slider").slider("values",0,o);jQuery(p.target).siblings(".slider").slider("values",1,k);f.rangeChange(o,k,$(p.target).siblings("#clamp_range").attr("checked"))}jQuery("#data-range-min").change(n);jQuery("#data-range-max").change(n);jQuery("#fix_range").click(function(k,o){f.fixRange=jQuery(e.target).attr("checked")});jQuery("#clamp_range").change(function(p){var o=parseFloat($(p.target).siblings("#data-range-min").val());var k=parseFloat($(p.target).siblings("#data-range-max").val());if($(p.target).attr("checked")==true){f.rangeChange(o,k,true)}else{f.rangeChange(o,k,false)}});jQuery("#flip_range").change(function(k){f.flip=$(k.target).attr("checked");f.updateColors(f.model_data.data,f.model_data.data.rangeMin,f.model_data.data.rangeMax,brainbrowser.spectrum,f.flip,f.clamped)})}f.afterLoadData=function(j,h,k,g){if(g){d(k)}else{d(k);jQuery("#range-slider").slider("values",0,parseFloat(j));jQuery("#range-slider").slider("values",1,parseFloat(h));f.afterRangeChange(j,h)}};jQuery("#meshmode").change(function(g){if(jQuery(g.target).attr("checked")==true){f.set_fill_mode_wireframe()}else{f.set_fill_mode_solid()}});jQuery("#clearshapes").click(function(g){brainbrowser.clearScreen()});jQuery("#openImage").click(function(g){brainbrowser.getImageUrl()});function c(g){if($("#autorotate").attr("checked")){f.autoRotate={};f.autoRotate.x=$("#autorotateX").attr("checked");f.autoRotate.y=$("#autorotateY").attr("checked");f.autoRotate.z=$("#autorotateZ").attr("checked")}else{f.autoRotate=false}}jQuery("#autorotate-controls").children().change(c);jQuery("#autorotate").change(c);jQuery(".range-box").keypress(function(g){if(g.keyCode=="13"){f.rangeChange(parseFloat(jQuery("#data-range-min").val()),parseFloat(jQuery("#data-range-max").val()))}});jQuery("#clearColor").change(function(h){var g=$(h.target).val();f.updateClearColorFromName(g)});$("#examples").click(function(k){var h=$(k.target).attr("data-example-name");switch(h){case"basic":f.clearScreen();f.loadObjFromUrl("/models/surf_reg_model_both.obj");f.setupView();break;case"punkdti":f.clearScreen();f.loadObjFromUrl("/models/dti.obj",999);f.loadObjFromUrl("/models/left_color.obj");f.loadObjFromUrl("/models/right_color.obj");f.setupView();break;case"realct":f.clearScreen();f.loadObjFromUrl("/models/realct.obj");f.loadDataFromUrl("/models/realct.txt","cortical thickness");f.setupView();break;case"car":f.clearScreen();f.loadWavefrontObjFromUrl("/models/car.obj");f.setCamera(0,0,100);var l=new THREE.Matrix4();l.makeRotationX(-0.25*Math.PI);var j=new THREE.Matrix4();j.makeRotationY(0.4*Math.PI);f.getModel().applyMatrix(j.multiply(l));break;case"plane":f.clearScreen();f.updateClearColorFromName("black");f.loadObjFromUrl("/models/dlr_bigger.streamlines.obj");f.loadObjFromUrl("/models/dlr.model.obj");f.setCamera(0,0,75);var g=new THREE.Matrix4();var l=new THREE.Matrix4();l.makeRotationX(-0.25*Math.PI);var j=new THREE.Matrix4();j.makeRotationY(0.4*Math.PI);g.multiplyMatrices(j,l);f.getModel().applyMatrix(g)}return false})}};