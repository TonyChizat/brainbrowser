/*! 
 * Copyright (C) 2011 McGill University
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 *   the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
if(!Array.prototype.min){Array.prototype.min=function(){var b=this[0];var a,c;for(a=1,c=this.length;a<c;a++){if(this[a]<b){b=this[a]}}return b}}if(!Array.prototype.max){Array.prototype.max=function(){var a=this[0];var b,c;for(b=1,c=this.length;b<c;b++){if(this[b]>a){a=this[b]}}return a}}function ColorManager(){this.createColorMap=function(m,a,r,h,o,l,n,g,f){var m=m.colors;var d=m.length;var q=((o-h)+(o-h)/d)/d;var j,k;var s;var p;var b;var c=[];for(j=0,k=r.length;j<k;j++){p=r[j];if(p<=h){s=0}else{if(r[j]>o){s=d-1}else{s=parseInt((p-h)/q)}}if(l){b=255}else{b=1}c=m[s]||[0,0,0];a[j*4+0]=b*c[0]*g+n*b;a[j*4+1]=b*c[1]*g+n*b;a[j*4+2]=b*c[2]*g+n*b;if(f){a[j*4+3]=b*f}else{a[j*4+3]=b}}return a};this.blendColors=function(k){var a=k[0];var g,d,f,c;var b,h;for(g=0,f=k[0].length/4;g<f;g++){for(d=1,c=k.length;d<c;d++){b=a[g*4+3];h=k[d][g*4+3];a[g*4]=a[g*4]*b+k[d][g*4]*h;a[g*4+1]=a[g*4+1]*b+k[d][g*4+1]*h;a[g*4+2]=a[g*4+2]*b+k[d][g*4+2]*h;a[g*4+3]=b+h}}return a};this.blendColorMap=function(h,g,j,c){var f=g.length;var a=new Array(f);var k=0;var d;var b;for(d=0;d<f;d++){b=g[d];a[d]=this.createColorMap(h,new Array(b.values.length),b.values,b.rangeMin,b.rangeMax,false,0,1,b.alpha)}return this.blendColors(a)}}function Spectrum(f){var c=this;var a=new ColorManager();function b(g,q,j,p){var l=document.createElement("canvas");var m=new Array(256);var o,n;var h;$(l).attr("width",256);$(l).attr("height",j);for(o=0;o<256;o++){if(p){m[255-o]=o}else{m[o]=o}}g=a.createColorMap(c,[],m,0,255,true,0,1);h=l.getContext("2d");for(n=0;n<256;n++){h.fillStyle="rgb("+parseInt(g[n*4],10)+", "+parseInt(g[n*4+1])+", "+parseInt(g[n*4+2])+")";h.fillRect(n,0,1,q)}return l}c.createSpectrumCanvas=function(g){var h;if(g===null){g=c.colors}h=b(g,20,20,false);return h};c.createSpectrumCanvasWithScale=function(k,g,h,l){var i;var j;if(h===null){h=c.colors}i=b(h,20,40,l);j=i.getContext("2d");j.fillStyle="#FFA000";j.fillRect(0.5,20,1,10);j.fillText(k.toPrecision(3),0.5,40);j.fillRect(i.width/4,20,1,10);j.fillText(((k+g)/4).toPrecision(3),i.width/4,40);j.fillRect(i.width/2,20,1,10);j.fillText(((k+g)/2).toPrecision(3),i.width/2,40);j.fillRect(3*(i.width/4),20,1,10);j.fillText((3*((k+g)/4)).toPrecision(3),3*(i.width/4),40);j.fillRect(i.width-0.5,20,1,10);j.fillText(g.toPrecision(3),i.width-20,40);return i};function d(p){p=p.replace(/^\s+/,"").replace(/\s+$/,"");var n=p.split(/\n/);var g=[];var m,h,l,j;var o;for(m=0,l=n.length;m<l;m++){o=n[m].replace(/\s+$/,"").split(/\s+/);j=o.length;for(h=0;h<j;h++){o[h]=parseFloat(o[h])}if(j<4){o.push(1)}g.push(o)}c.colors=g;return g}if(f!=undefined){d(f)}}function BrainBrowser(b){if(!BrainBrowser.utils.webWorkersEnabled()){alert("Can't find web workers. Exiting.");return}if(!BrainBrowser.utils.webglEnabled()){alert("Can't get WebGL context. Exiting.");return}if(!(this instanceof BrainBrowser)){return new BrainBrowser(b)}this.view_window=document.getElementById("brainbrowser");this.model=undefined;var a;for(a in BrainBrowser.core){if(BrainBrowser.core.hasOwnProperty(a)){BrainBrowser.core[a](this)}}for(a in BrainBrowser.modules){if(BrainBrowser.modules.hasOwnProperty(a)){BrainBrowser.modules[a](this)}}for(a in BrainBrowser.plugins){if(BrainBrowser.plugins.hasOwnProperty(a)){BrainBrowser.plugins[a](this)}}this.render();b(this)}BrainBrowser.core={};BrainBrowser.modules={};BrainBrowser.plugins={};BrainBrowser.data={};BrainBrowser.filetypes={};BrainBrowser.core.color=function(d){var a=new ColorManager();d.updateColors=function(j,i,o,m,k,p,l,g){var q=g||{};var h=q.afterUpdate;var f;function n(s){var r;if(d.model_data.num_hemispheres===2){b(s)}else{if(j.apply_to_shape){r=[d.model.getChildByName(j.apply_to_shape,true)]}else{r=d.model.children}c(s,r)}if(d.afterUpdateColors){d.afterUpdateColors(j,i,o,m)}if(h){h()}}d.clamped=p;if(l){n(a.blendColorMap(m,j,0,1))}else{j.createColorArray(i,o,m,k,p,d.model_data.colorArray,d.model_data,n)}};function b(x){var j=d.model;var k=x.length;var f;var o;var n=[];var t=[];var r=j.getChildByName("left");var u=r.geometry.faces;var g=j.getChildByName("right");var h=g.geometry.faces;var v=h.length;var q=u.length;var m;var s,l;var w;var p;f=x.slice(0,k/2);o=x.slice(k/2,k);l=Math.max(q,v);for(s=0;s<l;s++){if(s<q){m=u[s];p=m.vertexColors;w=m.a*4;p[0].setRGB(f[w],f[w+1],f[w+2]);w=m.b*4;p[1].setRGB(f[w],f[w+1],f[w+2]);w=m.c*4;p[2].setRGB(f[w],f[w+1],f[w+2]);if(m.d){w=m.d*4;p[3].setRGB(f[w],f[w+1],f[w+2])}}if(s<v){m=h[s];p=m.vertexColors;w=m.a*4;p[0].setRGB(o[w],o[w+1],o[w+2]);w=m.b*4;p[1].setRGB(o[w],o[w+1],o[w+2]);w=m.c*4;p[2].setRGB(o[w],o[w+1],o[w+2]);if(m.d){w=m.d*4;p[3].setRGB(o[w],o[w+1],o[w+2])}}}r.geometry.colorsNeedUpdate=true;g.geometry.colorsNeedUpdate=true}function c(f,g){var p=f.length;var m=[];var t;var h;var s,k;var l;var o,n;var r,q;for(o=0,r=g.length;o<r;o++){k=g[o].geometry.faces;for(n=0,q=k.length;n<q;n++){s=k[n];l=s.vertexColors;t=s.a*4;l[0].setRGB(f[t],f[t+1],f[t+2]);t=s.b*4;l[1].setRGB(f[t],f[t+1],f[t+2]);t=s.c*4;l[2].setRGB(f[t],f[t+1],f[t+2]);if(s.d){t=s.d*4;l[3].setRGB(f[t],f[t+1],f[t+2])}}g[o].geometry.colorsNeedUpdate=true}}};BrainBrowser.modules.loader=function(h){var f=BrainBrowser.data.Data;h.loadModelFromUrl=function(k,m){var j=m||{};var n;var i;var l=j.format||"MNIObject";b(k,m,function(o){n=k.split("/");i=n[n.length-1];BrainBrowser.filetypes.parse(l,o,function(p){if(p.objectClass!=="__FAIL__"){if(!c(j)){h.displayObjectFile(p,i,j)}}else{if(j.onError!==undefined){j.onError()}}})})};h.loadModelFromFile=function(n,l){var j=l||{};var m;var i;var k=j.format||"MNIObject";d(n,j,function(o){m=n.value.split("\\");i=m[m.length-1];BrainBrowser.filetypes.parse(k,o,function(p){if(p.objectClass!=="__FAIL__"){h.displayObjectFile(p,i,j)}else{if(j.onError!=undefined){j.onError()}}})})};h.loadDataFromUrl=function(l,j,k){var i=k||{};b(l,i,function(n,m){f(n,function(q){if(c(i)){return}var o=i.max===undefined?q.max:i.max;var p=i.min===undefined?q.min:i.min;h.model_data.data=q;q.fileName=j;q.apply_to_shape=i.shape;a(p,o);if(h.afterLoadData){h.afterLoadData(q.rangeMin,q.rangeMax,q)}h.updateColors(q,q.rangeMin,q.rangeMax,h.spectrum,h.flip,h.clamped,false,i)})})};h.loadDataFromFile=function(n,j){var r=j||{};var k=n.files[0].name;var q=h.model_data;var o=q.positionArray;var l=o.length;var p=r.blend_index||0;var i=1-p;h.blendData=h.blendData||[];var m=function(s){f(s,function(v){var t=r.max===undefined?v.max:r.max;var u=r.min===undefined?v.min:r.min;v.fileName=k;v.apply_to_shape=r.shape;v.applied=false;if(v.values.length<l/4){alert("Not enough color points to cover vertices - "+v.values.length+" color points for "+l/3+" vertices.");return -1}q.data=v;h.blendData[p]=v;a(u,t,v);if(h.blendData[i]&&h.blendData[i].applied){a(h.blendData[i].values.min(),h.blendData[i].values.max(),h.blendData[i]);if(h.afterLoadData!=null){h.afterLoadData(null,null,h.blendData,true)}h.blend(0.5);h.setupBlendColors()}else{if(h.afterLoadData){h.afterLoadData(v.rangeMin,v.rangeMax,v)}h.updateColors(v,v.rangeMin,v.rangeMax,h.spectrum,h.flip,h.clamped,false,r)}v.applied=true})};if(k.match(/.*.mnc|.*.nii/)){g(k,m)}else{d(n,null,m)}};h.blend=function(l){var j=h.blendData;var m=j.length;var k;j[0].alpha=l;j[1].alpha=1-l;for(k=2;k<m;k++){j[k].alpha=0}h.updateColors(j,null,null,h.spectrum,h.flip,h.clamped,true)};h.loadSpectrumFromUrl=function(k,m){var j=m||{};var l=j.afterLoadSpectrum;var i;b(k,j,function(n){i=new Spectrum(n);h.spectrum=i;if(l){l()}if(h.afterLoadSpectrum!=null){h.afterLoadSpectrum(i)}if(h.model_data&&h.model_data.data){h.updateColors(h.model_data.data,h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.spectrum,h.flip,h.clamped)}})};h.loadSpectrumFromFile=function(k){var i;var j=h.model_data;d(k,null,function(l){i=new Spectrum(l);h.spectrum=i;if(h.afterLoadSpectrum!=null){h.afterLoadSpectrum(i)}if(j.data){h.updateColors(j.data,j.data.rangeMin,j.data.rangeMax,h.spectrum,h.flip,h.clamped)}})};h.loadSeriesDataFromFile=function(n){var m=n.files.length;var l=n.files;var j;var k;h.seriesData=new Array(m);h.seriesData.numberFiles=m;for(k=0;k<m;k++){j=new FileReader();j.file=l[k];j.onloadend=(function(o,i){return function(p){console.log(p.target.result.length);console.log(i);f(p.target.result,function(q){h.seriesData[i]=q;h.seriesData[i].fileName=o.name})}})(j.file,k);j.readAsText(l[k])}h.setupSeries()};h.rangeChange=function(l,i,m,n){var k=n||{};var j=k.afterChange;var o=h.model_data.data;o.rangeMin=l;o.rangeMax=i;h.updateColors(o,o.rangeMin,o.rangeMax,h.spectrum,h.flip,m,false,k);if(j){j()}if(h.afterRangeChange!=null){h.afterRangeChange(l,i)}};function b(j,l,m){var i=l||{};var k=i.beforeLoad;if(k){k()}jQuery.ajax({type:"GET",url:j,dataType:"text",success:function(n){if(!c(i)){m(n)}},error:function(n,p,o){alert("Failure in loadFromURL: "+p)},timeout:100000})}function d(o,m,n){var l=o.files;if(l.length===0){return}var j=m||{};var k=j.beforeLoad;var i=new FileReader();i.file=l[0];if(k){k()}i.onloadend=function(p){n(p.target.result)};i.readAsText(l[0])}function g(i,l){var n;var k;var m;var j;n=new XMLHttpRequest();if(i.match(/.*.mnc/)){n.open("POST","/minc/volume_object_evaluate",false)}else{n.open("POST","/nii/volume_object_evaluate",false)}m=new FormData(document.getElementById("datafile-form"));n.send(m);var j=n.response;l(j)}function a(k,i,j){if(!j){j=h.model_data.data}if(!j.fixRange){j.rangeMin=k;j.rangeMax=i}}function c(l){var i=l||{};var m=i.cancel||{};if(BrainBrowser.utils.isFunction(m)){m={test:m}}var j=m.test;var n=m.cleanup;var k=false;if(j&&j()){k=true;if(n){n()}}return k}};BrainBrowser.core.models=function(h){h.displayObjectFile=function(n,k,m){var l=m||{};var o=l.renderDepth;var j=l.afterDisplay;if(n.objectClass=="P"&&n.numberVertices==81924){a(n,o)}else{if(n.objectClass=="P"){c(n,k,o)}else{if(n.objectClass=="L"){d(n,k,false,o)}else{alert("Object file not supported")}}}if(h.afterDisplayObject){h.afterDisplayObject(h.model)}if(j){j()}};function a(m,n){var j=h.model;var l,k;h.model_data=m;l=i(m.left);l.name="left";l.model_num=0;k=i(m.right);k.name="right";k.model_num=1;j.add(l);j.add(k)}function i(n){var v=n.positionArray;var m=n.indexArray;var u={};var k={};var s;var o,p;var t,r,l,q,j;for(o=0,p=v.length;o+2<p;o+=3){f(u,v[o],v[o+1],v[o+2])}k.x=u.minX+0.5*(u.maxX-u.minX);k.y=u.minY+0.5*(u.maxY-u.minY);k.z=u.minY+0.5*(u.maxZ-u.minZ);t=new THREE.Geometry();r=t.vertices;for(o=0,p=v.length;o+2<p;o+=3){r.push(new THREE.Vector3(v[o]-k.x,v[o+1]-k.y,v[o+2]-k.z))}l=t.faces;for(o=0,p=m.length;o+2<p;o+=3){s=new THREE.Face3(m[o],m[o+1],m[o+2]);s.vertexColors=[new THREE.Color(),new THREE.Color(),new THREE.Color()];l.push(s)}t.computeFaceNormals();t.computeVertexNormals();q=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:16777215,shininess:100,vertexColors:THREE.VertexColors});j=new THREE.Mesh(t,q);j.centroid=k;j.position.set(k.x,k.y,k.z);return j}function d(m,j,o,n){var k=h.model;var l=g(m,o);l.name=j;if(n){l.renderDepth=n}k.add(l)}function g(z,l){var t=z;var u=[];var G=[];var w=[];var D={};var x={};var F,E,C,v;var m=t.nitems;var p;var n;var o;var B;var s=[];var r;var q,y,A;var H;h.model_data=t;for(F=0;F<m;F++){if(F===0){p=0}else{p=t.endIndicesArray[F-1]}u.push(t.indexArray[p]);n=t.indexArray;o=t.endIndicesArray[F];for(C=p+1;C<o-1;C++){u.push(n[C]);u.push(n[C])}u.push(n[o-1])}H=h.model_data.positionArray;for(E=0,v=u.length;E<v;E++){f(D,H[u[E]*3],H[u[E]*3+1],H[u[E]*3+2])}x.x=D.minX+0.5*(D.maxX-D.minX);x.y=D.minY+0.5*(D.maxY-D.minY);x.z=D.minY+0.5*(D.maxZ-D.minZ);if(!l){for(E=0,v=u.length;E<v;E++){G.push(new THREE.Vector3(H[u[E]*3]-x.x,H[u[E]*3+1]-x.y,H[u[E]*3+2]-x.z))}if(t.colorArray.length===4){for(F=0;F<numberVertices;F++){s.push(0.5,0.5,0.7,1)}}else{s=h.model_data.colorArray;for(E=0,v=u.length;E<v;E++){r=new THREE.Color();r.setRGB(s[u[E]*4],s[u[E]*4+1],s[u[E]*4+2]);w.push(r)}}}else{G=h.model_data.meshPositionArray;w=h.model_data.meshColorArray}q=new THREE.Geometry();q.vertices=G;q.colors=w;q.colorsNeedUpdate=true;y=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});A=new THREE.Line(q,y,THREE.LinePieces);A.position.set(x.x,x.y,x.z);A.centroid=x;return A}function c(m,j,l){var o=h.model;var q;var n,p;var r=m;var k=r.shapes;h.model_data=r;if(k){for(n=0,p=k.length;n<p;n++){q=b(h.model_data.shapes[n]);q.name=h.model_data.shapes[n].name||(j.split(".")[0]+"_"+n);o.add(q)}}else{q=b(h.model_data);q.name=j;o.add(q)}if(h.afterCreate!=undefined){h.afterCreate(h.model_data)}}function b(p){var k=p.positionArray;var m=p.indexArray;var o=[];var y=p.colorArray;var E,D,s;var r;var n=false;var q,z,G;var w=[];var u;var l;var F=p.faces;var t;var v;var x;var C,B,A;if(y.length===4){n=true;C=y[0];B=y[1];A=y[2]}w=[];q=new THREE.Geometry();for(E=0,s=k.length/3;E<s;E++){q.vertices.push(new THREE.Vector3(k[E*3],k[E*3+1],k[E*3+2]));r=new THREE.Color();if(!n){r.setRGB(y[E*4],y[E*4+1],y[E*4+2])}else{r.setRGB(C,B,A)}w.push(r)}l=q.faces;if(F&&F.length>0){t=F.length;for(E=0;E<t;E++){v=F[E];x=v.length;if(x<3){continue}if(x<=4){if(x<=3){u=new THREE.Face3(v[0],v[1],v[2])}else{if(x===4){u=new THREE.Face4(v[0],v[1],v[2],v[3])}}u.vertexColors=[w[u.a],w[u.b],w[u.c]];if(x>3){u.vertexColors[3]=w[u.d]}l.push(u)}else{for(D=1;D+1<x;D++){u=new THREE.Face3(v[0],v[D],v[D+1]);u.vertexColors=[w[u.a],w[u.b],w[u.c]];l.push(u)}}}}else{for(E=0;E+2<m.length;E+=3){u=new THREE.Face3(m[E],m[E+1],m[E+2]);u.vertexColors[0]=w[u.a];u.vertexColors[1]=w[u.b];u.vertexColors[2]=w[u.c];q.faces.push(u)}}q.computeFaceNormals();q.computeVertexNormals();q.colorsNeedUpdate=true;z=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:16777215,shininess:100,vertexColors:THREE.VertexColors});G=new THREE.Mesh(q,z);return G}function f(k,j,m,l){if(!k.minX||k.minX>j){k.minX=j}if(!k.maxX||k.maxX<j){k.maxX=j}if(!k.minY||k.minY>m){k.minY=m}if(!k.maxY||k.maxY<m){k.maxY=m}if(!k.minZ||k.minZ>l){k.minZ=l}if(!k.maxZ||k.maxZ<l){k.maxZ=l}}};BrainBrowser.core.rendering=function(h){var i;var c=new THREE.Scene();var g;var f=new THREE.PerspectiveCamera(30,h.view_window.offsetWidth/h.view_window.offsetHeight,0.1,5000);var b;var o;var j;var a;var n;var d;h.model=new THREE.Object3D();c.add(h.model);h.render=function(){var p=h.view_window;i=new THREE.WebGLRenderer({clearColor:8947848,clearAlpha:1,preserveDrawingBuffer:true});i.setSize(p.offsetWidth,p.offsetHeight);n=i;d=new THREE.AnaglyphEffect(i);d.setSize(p.offsetWidth,p.offsetHeight);p.appendChild(i.domElement);f.position.z=500;g=new THREE.PointLight(16777215);g.position.set(0,0,500);c.add(g);b=new THREE.TrackballControls(f,p);o=new THREE.TrackballControls(g,p);b.zoomSpeed=2;o.zoomSpeed=2;h.autoRotate={};window.onresize=function(){n.setSize(p.offsetWidth,p.offsetHeight);f.aspect=p.offsetWidth/p.offsetHeight;f.updateProjectionMatrix()};window.onresize();l()};h.canvasDataURL=function(){return i.domElement.toDataURL()};h.anaglyphEffect=function(){n=d};h.noEffect=function(){n=i};h.setCamera=function(p,r,q){f.position.set(p,r,q)};h.resetView=function(){var q=h.model;var t;var r,s;var p=new THREE.Matrix4();p.getInverse(q.matrix);b.reset();o.reset();q.applyMatrix(p);for(r=0,s=h.model.children.length;r<s;r++){t=q.children[r];t.visible=true;if(t.centroid){t.position.set(t.centroid.x,t.centroid.y,t.centroid.z)}else{t.position.set(0,0,0)}t.rotation.set(0,0,0)}};h.clearScreen=function(){var p=h.model.children;while(p.length>0){h.model.remove(p[0])}h.resetView();if(h.afterClearScreen!=undefined){h.afterClearScreen()}};h.updateClearColor=function(p){i.setClearColorHex(p,1)};h.set_fill_mode_wireframe=function(){var q=h.model.children;var r;for(var p=0;p<q.length;p++){r=q[p].material;r.wireframe=true;if(r.emissive){r.emissive.setHex(125269879)}}};h.set_fill_mode_solid=function(){var q=h.model.children;var r;for(var p=0;p<q.length;p++){r=q[p].material;r.wireframe=false;if(r.emissive){r.emissive.setHex(0)}}};h.ZoomInOut=function(p){f.fov*=p;f.updateProjectionMatrix()};h.click=function(w,t){var A=h.view_window;var u=m(A);var y=new THREE.Projector();var x=new THREE.Raycaster();var s=((w.clientX-u.left+window.scrollX)/A.offsetWidth)*2-1;var r=-((w.clientY-u.top+window.scrollY)/A.offsetHeight)*2+1;var q=new THREE.Vector3(s,r,1);var v,p,z;y.unprojectVector(q,f);x.set(f.position,q.sub(f.position).normalize());v=x.intersectObject(h.model,true);if(v.length>0){p=v[0];z={vertex:p.face.a,point:new THREE.Vector3(p.point.x,p.point.y,p.point.z),object:p.object};return t(w,z)}else{return false}};function m(p){var r=0;var q=0;while(p.offsetParent){r+=p.offsetTop;q+=p.offsetLeft;p=p.offsetParent}return{top:r,left:q}}function l(r){var p=h.model;var s;var q;requestAnimationFrame(l);a=j||r;j=r;b.update();o.update();s=j-a;q=s*0.00015;if(h.autoRotate.x){p.rotation.x+=q}if(h.autoRotate.y){p.rotation.y+=q}if(h.autoRotate.z){p.rotation.z+=q}n.render(c,f)}function k(p,u,t){var s=new THREE.SphereGeometry(2);var r=new THREE.MeshBasicMaterial({color:16711680});var q=new THREE.Mesh(s,r);q.position.set(p,u,t);c.add(q)}};BrainBrowser.plugins.ui=function(h){var g=document;var d=BrainBrowser.data.Data;var f=$("#loading");h.keyPressedCallback=function(j){var i=false;switch(j.which){case 38:h.ZoomInOut(1/1.1);i=true;break;case 40:h.ZoomInOut(1.1);i=true;break;case 32:h.separateHemispheres();i=true;break}return !i};h.setupBlendColors=function(){var i=$("#blend-box");i.html("Blend Ratio: ");$('<span id="blend_value">0.5</span>').appendTo(i);$('<div class="blend_slider" id="blend_slider" width="100px" + height="10"></div>').slider({value:0,min:0.1,max:0.99,value:0.5,step:0.01,slide:function(k,l){var j=$(this);j.siblings("span").html(j.slider("value"))},stop:function(j,k){h.blend($(this).slider("value"))}}).appendTo(i)};h.setupSeries=function(){var l=h.model_data;var k=h.seriesData;var i=h.model_data.positionArray;var j;$('<div id="series">Series: </div>').appendTo("#surface_choice");var m=$("#series");$('<span id="series-value">0</span>').appendTo(m);$('<div id="series-slider" width="100px" + height="10"></div>').slider({value:0,min:0,max:k.numberFiles-1,step:0.1,slide:function(n,o){if(k[0].fileName.match("mt.*")){$("#age_series").html("Age: "+(o.value*3+5).toFixed(1))}else{if(k[0].fileName.match("pval.*")){$("#age_series").html("Age: "+(o.value*1+10))}}},stop:function(n,o){f.show();$(m).children("#series-value").html(o.value);if(o.value-Math.floor(o.value)<0.01){l.data=k[o.value];c(l.data)}else{j=a(k[Math.floor(o.value)],k[Math.floor(o.value)+1],o.value-Math.floor(o.value));d(j,c)}}}).appendTo(m)};function c(i){if(i.values.length<positionArray.length/4){console.log("Number of numbers in datafile lower than number of vertices Vertices"+positionArray.length/3+" data values:"+i.values.length);return -1}if(h.afterLoadData!=null){h.afterLoadData(i.rangeMin,i.rangeMax,i)}h.updateColors(i,i.rangeMin,i.rangeMax,h.spectrum,h.flip,h.clamped,{afterUpdate:function(){f.hide()}})}function a(o,k,j){console.log(o.values.length);var l;var m=o.values.length;var n=new Array(m);console.log("Percentage: "+j);for(l=0;l<m;l++){n[l]=(o.values[l]*(100-j*100)+k.values[l]*(j*100))/100}console.log(n.length);return n}h.getImageUrl=function(){var j=h.view_window;var l=g.createElement("canvas");var n=g.getElementById("spectrum-canvas");var m=l.getContext("2d");var i=new Image();l.width=j.offsetWidth;l.height=j.offsetHeight;function k(){var o=new Image();o.onload=function(){m.drawImage(o,0,0)};o.src=n.toDataURL()}i.onload=function(){m.drawImage(i,0,0);if(n){k()}};i.src=h.canvasDataURL();$("<div></div>").append(l).dialog({title:"Screenshot",height:l.height,width:l.width})};h.getViewParams=function(){return{view:$("[name=hem_view]:checked").val(),left:$("#left_hem_visible").is(":checked"),right:$("#right_hem_visible").is(":checked")}};function b(i){h.autoRotate.x=$("#autorotateX").is(":checked");h.autoRotate.y=$("#autorotateY").is(":checked");h.autoRotate.z=$("#autorotateZ").is(":checked")}$("body").keydown(h.keyPressedCallback);$("#clear_color").change(function(i){h.updateClearColor(parseInt($(i.target).val(),16))});$("#resetview").click(h.setupView);$(".view_button").change(h.setupView);$("[name=hem_view]").change(h.setupView);$("#meshmode").change(function(i){if($(i.target).is(":checked")){h.set_fill_mode_wireframe()}else{h.set_fill_mode_solid()}});$("#threedee").change(function(i){if($(i.target).is(":checked")){h.anaglyphEffect()}else{h.noEffect()}});$("#openImage").click(function(i){h.getImageUrl()});$("#autorotate-controls").children().change(b);$("#autorotate").change(b)};var BrainBrowser=BrainBrowser||{};BrainBrowser.utils=(function(){
/*! 
   * WebGL test taken from Detector.js by
   * alteredq / http://alteredqualia.com/
   * mr.doob / http://mrdoob.com/
  */
function b(){try{return !!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(f){return false}}function a(){return !!window.Worker}function c(){var f;var g='BrainBrowser requires <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>.<br/>';g+=window.WebGLRenderingContext?"Your browser seems to support it, but it is <br/> disabled or unavailable.<br/>":"Your browser does not seem to support it.<br/>";g+='Test your browser\'s WebGL support <a href="http://get.webgl.org/">here</a>.';f=document.createElement("div");f.id="webgl-error";f.innerHTML=g;return f}function d(f){return f instanceof Function||typeof f==="function"}return{webglEnabled:b,webWorkersEnabled:a,webGLErrorMessage:c,isFunction:d}})();BrainBrowser.modules.views=function(b){b.changeShapeTransparency=function(f,g){var c=b.model.getChildByName(f);var d;if(c){d=c.material;d.opacity=g;if(g===1){d.transparent=false}else{d.transparent=true}}};b.setupView=function(c){var d=b.getViewParams();b.resetView();if(b.model_data&&b.model_data.num_hemispheres===2){switch(d.view){case"superior":b.superiorView();break;case"medial":b.medialView();break;case"anterior":b.anteriorView();break;case"inferior":b.inferiorView();break;case"lateral":b.lateralView();break;case"posterior":b.posteriorView();break;default:b.superiorView();break}}if(b.model.getChildByName("left")){if(d.left){b.leftHemisphereVisible(true)}else{b.leftHemisphereVisible(false)}}if(b.model.getChildByName("right")){if(d.right){b.rightHemisphereVisible(true)}else{b.rightHemisphereVisible(false)}}};b.leftHemisphereVisible=function(c){b.model.getChildByName("left").visible=c};b.rightHemisphereVisible=function(c){b.model.getChildByName("right").visible=c};b.getInfoForVertex=function(d){var c=b.model_data.getVertexInfo(d);var f={vertex:c.vertex,point:new THREE.Vector3(c.position_vector[0],c.position_vector[1],c.position_vector[2])};return f};b.medialView=function(d){var c=b.model;if(b.model_data.num_hemispheres==2){c.getChildByName("left").position.x-=100;c.getChildByName("left").rotation.z-=a(90);c.getChildByName("right").position.x+=100;c.getChildByName("right").rotation.z+=a(90);c.rotation.x+=a(-90)}};b.lateralView=function(g){var c=b.model;var f,d;if(b.model_data.num_hemispheres==2){f=c.getChildByName("left");d=c.getChildByName("right");f.position.x-=100;f.rotation.z+=a(-90);d.position.x+=100;d.rotation.z+=a(90);c.rotation.x+=a(90);c.rotation.y+=a(180)}};b.superiorView=function(){};b.inferiorView=function(){b.model.rotation.y+=a(180)};b.anteriorView=function(c){b.resetView();b.model.rotation.x+=a(-90);b.model.rotation.z+=a(180)};b.posteriorView=function(c){b.resetView();b.model.rotation.x+=a(-90)};b.separateHemispheres=function(c){if(b.model_data.num_hemispheres==2){b.model.children[0].position.x-=1;b.model.children[1].position.x+=1}};function a(c){return c*Math.PI/180}};BrainBrowser.data.Data=function(b,d){if(!(this instanceof BrainBrowser.data.Data)){return new BrainBrowser.data.Data(b,d)}var a=this;function c(){var f=new Worker("js/workers/data.worker.js");f.addEventListener("message",function(h){var g=h.data;var i;for(i in g){if(g.hasOwnProperty(i)){a[i]=g[i]}}if(d){d(a)}f.terminate()});f.postMessage({cmd:"parse",data:b})}a.createColorArray=function(h,l,k,i,m,g,j,n){var f=new Worker("js/workers/data.worker.js");f.addEventListener("message",function(p){var o=p.data;var q;if(n){n(o)}f.terminate()});f.postMessage({cmd:"createColorArray",data:{values:a.values,min:h,max:l,spectrum:k.colors,flip:i,clamped:m,original_colors:g,model:{num_hemisphere:j.num_hemisphere,indexArray:j.indexArray}}})};if(b){if(typeof b==="string"){c(b)}else{if(b.values!=undefined){this.values=b.values.concat();this.min=this.values.min();this.max=this.values.max()}else{console.log("copying data length: "+b.length);this.values=b;this.min=b.min();this.max=b.max()}}}};BrainBrowser.filetypes.config={MNIObject:{worker:"js/workers/mniobj.worker.js",afterParse:function(a){a.getVertexInfo=function(c){var b=[a.positionArray[c*3],a.positionArray[c*3+1],a.positionArray[c*3+2]];return{vertex:c,position_vector:b}}}},WavefrontObj:{worker:"js/workers/wavefront_obj.worker.js"},FreeSurferAsc:{worker:"js/workers/freesurfer_asc.worker.js",format_hint:'You can use <a href="http://surfer.nmr.mgh.harvard.edu/fswiki/mris_convert" target="_blank">mris_convert</a> to convert your binary surface files into .asc format.'}};BrainBrowser.filetypes.parse=function(b,c,f){var d={};var a=BrainBrowser.filetypes.config[b];if(a.parse){a.parse(d,c,f)}if(a.worker){BrainBrowser.filetypes.parseWorker(d,c,a.worker,f)}if(a.afterParse){a.afterParse(d,c)}};BrainBrowser.filetypes.parseWorker=function(a,c,b,f){var d=new Worker(b);d.addEventListener("message",function(h){var g=h.data;var i;for(i in g){if(g.hasOwnProperty(i)){a[i]=g[i]}}if(f){f(a)}d.terminate()});d.postMessage(c)};$(function(){var c=0;var b="";var a=$("#loading");$(".button").button();$(".buttonset").buttonset();$("#data-range-box").hide();if(!BrainBrowser.utils.webglEnabled()){$("#brainbrowser").html(BrainBrowser.utils.webGLErrorMessage());return}BrainBrowser(function(f){f.loadSpectrumFromUrl("/assets/spectral_spectrum.txt");f.clamped=true;f.flip=false;f.afterLoadSpectrum=function(g){var h=g.createSpectrumCanvasWithScale(0,100,null);var i=document.getElementById("color-bar");h.id="spectrum-canvas";if(!i){$('<div id="color-bar"></div>').html(h).appendTo("#data-range-box")}else{$(i).html(h)}f.spectrumObj=g};f.afterDisplayObject=function(j){var h;var n,g;var l,m;var k=j.children;var o=$("#shapes").children();if(k.length-o.length>0){for(l=o.length,m=k.length;l<m;l++){h=k[l];g=$('<div id="shape_'+l+'" class="shape"><h4>Shape '+(l+1)+"</h4>Name: "+h.name+"<br />Opacity: </div>");n=$('<div class="opacity-slider slider"  data-shape-name="'+h.name+'"></div>');n.slider({value:100,min:-1,max:101,slide:function(i,q){var s=i.target;var p=$(s).attr("data-shape-name");var r=$(s).slider("value");r=Math.min(100,Math.max(0,r))/100;f.changeShapeTransparency(p,r)}});n.appendTo(g);g.appendTo("#shapes")}}f.afterClearScreen=function(){$("#shapes").html("");$("#data-range-box").hide()}};$("#clearshapes").click(function(g){f.clearScreen();c=0;b="";a.hide()});$("#range-slider").slider({range:true,min:-50,max:50,value:[-10,10],slider:function(i,j){var h=parseFloat(j.values[0]);var g=parseFloat(j.values[1]);f.rangeChange(h,g,$("#clamp_range").is(":checked"))},step:0.1});f.afterRangeChange=function(i,g){$("#data-range-min").val(i);$("#data-range-max").val(g);var h=f.spectrumObj.createSpectrumCanvasWithScale(i,g,null);h.id="spectrum-canvas";$("#color-bar").html($(h))};function d(l){var g=$("#data-range");var n='<div id="data-range-multiple"><ul>';var h="";var l=l.length?l:[l];var j,k;g.html("");for(j=0,k=l.length;j<k;j++){n+='<li><a href="#data_file'+j+'">'+l[j].fileName+"</a></li>";h+='<div id="data_file'+j+'" class="box full_box">';h+='Min: <input class="range-box" id="data-range-min" type="text" name="range_min" size="5" ><br />';h+='<div id="range-slider+'+j+'" data-blend-index="'+j+'" class="slider"></div><br />';h+='Max: <input class="range-box" id="data-range-max" type="text" name="range_max" size="5" >';h+='<input type="checkbox" class="button" id="fix_range"><label for="fix_range">Fix Range</label>';h+='<input type="checkbox" class="button" id="clamp_range" checked="true"><label for="clamp_range">Clamp range</label>';h+='<input type="checkbox" class="button" id="flip_range"><label for="flip_range">Flip Colors</label>';h+="</div>"}n+="</ul>";g.html(n+h+"</div>");$("#data-range-box").show();g.find("#data-range-multiple").tabs();$("#data-range").find(".slider").each(function(o,q){var p=l[0].values.min();var i=l[0].values.max();$(q).slider({range:true,min:p,max:i,values:[l[o].rangeMin,l[o].rangeMax],step:(i-p)/100,slide:function(r,s){$("#data-range-min").val(s.values[0]);$("#data-range-max").val(s.values[1])},stop:function(s,t){a.show();var r=$(this).attr("data-blend-index");range_updating=true;l[0].rangeMin=t.values[0];l[0].rangeMax=t.values[1];f.model_data.data=l[0];f.rangeChange(l[0].rangeMin,l[0].rangeMax,f.clamped,{afterUpdate:function(){a.hide()}})}})});function m(p){a.show();var o=$("#data-range-min").val();var i=$("#data-range-max").val();$(p.target).siblings(".slider").slider("values",0,o);$(p.target).siblings(".slider").slider("values",1,i);f.rangeChange(o,i,$(p.target).siblings("#clamp_range").is(":checked"),{afterUpdate:function(){a.hide()}})}$("#data-range-min").change(m);$("#data-range-max").change(m);$("#fix_range").click(function(i,o){f.fixRange=$(e.target).is(":checked")});$("#clamp_range").change(function(p){var o=parseFloat($(p.target).siblings("#data-range-min").val());var i=parseFloat($(p.target).siblings("#data-range-max").val());if($(p.target).is(":checked")){f.rangeChange(o,i,true)}else{f.rangeChange(o,i,false)}});$("#flip_range").change(function(i){f.flip=$(i.target).is(":checked");a.show();f.updateColors(f.model_data.data,f.model_data.data.rangeMin,f.model_data.data.rangeMax,f.spectrum,f.flip,f.clamped,false,{afterUpdate:function(){a.hide()}})})}f.afterLoadData=function(i,h,j,g){if(g){d(j)}else{d(j);$("#range-slider").slider("values",0,parseFloat(i));$("#range-slider").slider("values",1,parseFloat(h));f.afterRangeChange(i,h)}};$(".range-box").keypress(function(g){if(g.keyCode=="13"){f.rangeChange(parseFloat($("#data-range-min").val()),parseFloat($("#data-range-max").val()))}});$("#examples").click(function(j){c++;var h=$(j.target).attr("data-example-name");var l,i;if(b===h){return}b=h;function k(m){return function(){return m!==c}}function g(){a.hide()}a.show();f.clearScreen();switch(h){case"basic":f.loadModelFromUrl("/models/surf_reg_model_both.obj",{format:"MNIObject",afterDisplay:g,cancel:k(c)});break;case"punkdti":f.loadModelFromUrl("/models/dti.obj",{format:"MNIObject",renderDepth:999,afterDisplay:g,cancel:k(c)});f.loadModelFromUrl("/models/left_color.obj",{format:"MNIObject",cancel:k(c)});f.loadModelFromUrl("/models/right_color.obj",{format:"MNIObject",cancel:k(c)});break;case"realct":f.loadModelFromUrl("/models/realct.obj",{format:"MNIObject",afterDisplay:function(){f.loadDataFromUrl("/models/realct.txt","Cortical Thickness",{afterUpdate:g,cancel:k(c)})},cancel:k(c)});break;case"car":f.loadModelFromUrl("/models/car.obj",{format:"WavefrontObj",afterDisplay:g,cancel:k(c)});f.setCamera(0,0,100);l=new THREE.Matrix4();l.makeRotationX(-0.25*Math.PI);i=new THREE.Matrix4();i.makeRotationY(0.4*Math.PI);f.model.applyMatrix(i.multiply(l));break;case"plane":f.loadModelFromUrl("/models/dlr_bigger.streamlines.obj",{format:"MNIObject",cancel:k(c)});f.loadModelFromUrl("/models/dlr.model.obj",{format:"MNIObject",afterDisplay:function(){g()},cancel:k(c)});f.setCamera(0,0,75);l=new THREE.Matrix4();l.makeRotationX(-0.25*Math.PI);i=new THREE.Matrix4();i.makeRotationY(0.4*Math.PI);f.model.applyMatrix(i.multiply(l));break;case"mouse":f.loadModelFromUrl("/models/mouse_surf.obj",{format:"MNIObject",afterDisplay:function(){f.loadDataFromUrl("/models/mouse_alzheimer_map.txt","Cortical Amyloid Burden, Tg AD Mouse, 18 Months Old",{shape:"mouse_surf.obj",min:0,max:0.25,afterUpdate:g,cancel:k(c)})},cancel:k(c)});f.loadModelFromUrl("/models/mouse_brain_outline.obj",{format:"MNIObject",afterDisplay:function(){$(".opacity-slider[data-shape-name='mouse_brain_outline.obj']").slider("value",50);f.changeShapeTransparency("mouse_brain_outline.obj",0.5)},cancel:k(c)});f.setCamera(0,0,40)}return false});$("#obj_file_format").change(function(){var g=$("#obj_file_format").closest("#obj_file_select").find("#obj_file_format option:selected").val();$("#format_hint").html(BrainBrowser.filetypes.config[g].format_hint||"")});$("#obj_file_submit").click(function(){var g=$("#obj_file_format").closest("#obj_file_select").find("#obj_file_format option:selected").val();f.loadModelFromFile(document.getElementById("objfile"),{format:g,beforeLoad:function(){a.show()},afterDisplay:function(){a.hide()},onError:function(){a.hide()}});return false});$(".datafile").change(function(){var g=parseInt(this.id.slice(-1),10);f.loadDataFromFile(this,{blend_index:g-1})});$("#spectrum").change(function(){f.loadSpectrumFromFile(document.getElementById("spectrum"))});$("#dataseriesfile").change(function(){f.loadSeriesDataFromFile(document.getElementById("dataseriesfile"))})});$("a.example[data-example-name=realct]").click()});