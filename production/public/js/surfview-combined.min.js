function Data(b){var a=this;a.parse=function(c){c=c.replace(/\s+$/,"");c=c.replace(/^\s+/,"");a.values=c.split(/\s+/);for(var d=0;d<a.values.length;d++){a.values[d]=parseFloat(a.values[d])}a.min=a.values.min();a.max=a.values.max()};this.createColorArray=function(g,o,n,k,r,d,l){var n=n.colors;var q=new Array();var p=((o-g)+(o-g)/n.length)/n.length;for(var h=0;h<a.values.length;h++){if(a.values[h]<=g){if(a.values[h]<g&&!r){var s=-1}else{var s=0}}else{if(a.values[h]>o){if(!r){var s=-1}else{var s=n.length-1}}else{var s=parseInt((a.values[h]-g)/p)}}if(k&&s!=-1){q.push.apply(q,n[n.length-1-s])}else{if(s==-1){if(d.length==4){q.push.apply(q,d)}else{q.push.apply(q,[d[h*4],d[h*4+1],d[h*4+2],d[h*4+3]])}}else{q.push.apply(q,n[s])}}}if(l.num_hemisphere!=2){var m=[];var c=l.indexArray.length;for(var f=0;f<c;f++){m[f*4]=q[l.indexArray[f]*4];m[f*4+1]=q[l.indexArray[f]*4+1];m[f*4+2]=q[l.indexArray[f]*4+2];m[f*4+3]=q[l.indexArray[f]*4+3]}q.nonIndexedColorArray=m}return q};if(b){if(typeof b=="string"){a.parse(b)}else{if(b.values!=undefined){this.values=cloneArray(b.values);this.min=this.values.min();this.max=this.values.max()}else{console.log("copying data length: "+b.length);this.values=b;this.min=b.min();this.max=b.max()}}}}Array.prototype.min=function(){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.min.apply(Math,this.slice(c,c+b-1)))}}else{return Math.min.apply(Math,this)}return a.min()};Array.prototype.max=function(d){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.max.apply(Math,this.slice(c,c+b-1)))}}else{return Math.max.apply(Math,this)}return a.max()};function cloneArray(b){var c=new Array(b.length);for(var a=0;a<c.length;a++){c[a]=b[a]}return c}function rotateUint16Array90Left(g,d,a){var f=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){f[c*a+b]=g[b*d+(d-c)]}}return f}function rotateUint16Array90Right(g,d,a){var f=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){f[c*a+b]=g[(a-b)*d+c]}}return f}function interpolateDataArray(h,c,b,a){console.log(h.values.length);var f=h.values.length;var g=new Array(f);console.log("Percentage: "+b);for(var d=0;d<f;d++){if(a){g[d]=(h.values[d]*(100-b*100)+c.values[d]*(b*100))/100}else{g[d]=(h.values[d]*(100-b*100)+c.values[d]*(b*100))/100}}console.log(g.length);return g}function ColorManager(){function c(m,d,q,j,o,l,n,h,g){var m=m.colors;var p=((o-j)+(o-j)/m.length)/m.length;for(var k=0;k<q.length;k++){if(q[k]<=j){var r=0}else{if(q[k]>o){var r=m.length-1}else{var r=parseInt((q[k]-j)/p)}}if(l){var f=255}else{var f=1}d[k*4+0]=f*m[r][0]*h+n*f;d[k*4+1]=f*m[r][1]*h+n*f;d[k*4+2]=f*m[r][2]*h+n*f;if(g){d[k*4+3]=f*g}else{d[k*4+3]=f}}return d}this.createColorMap=c;function a(l){var d=l[0];for(var h=0;h<l[0].length/4;h++){for(var g=1;g<l.length;g++){var f=d[h*4+3];var k=l[g][h*4+3];d[h*4]=d[h*4]*f+l[g][h*4]*k;d[h*4+1]=d[h*4+1]*f+l[g][h*4+1]*k;d[h*4+2]=d[h*4+2]*f+l[g][h*4+2]*k;d[h*4+3]=f+k}}return d}this.blendColors=a;function b(f,m,k,h){var d=m.length;var l=new Array(d);var j=0;for(var g=0;g<d;g++){l[g]=c(f,new Array(m[g].values.length),m[g].values,m[g].rangeMin,m[g].rangeMax,false,0,1,m[g].alpha)}return a(l)}this.blendColorMap=b}function Spectrum(f){var c=this;var a=new ColorManager();function b(g,q,j,p){var l=document.createElement("canvas");jQuery(l).attr("width",256);jQuery(l).attr("height",j);var m=new Array(256);for(var o=0;o<256;o++){if(p){m[255-o]=o}else{m[o]=o}}g=a.createColorMap(c,[],m,0,255,true,0,1);var h=l.getContext("2d");for(var n=0;n<256;n++){h.fillStyle="rgb("+parseInt(g[n*4])+","+parseInt(g[n*4+1])+","+parseInt(g[n*4+2])+")";h.fillRect(n,0,1,q)}return l}c.createSpectrumCanvas=function(g){if(g==null){g=c.colors}var h=b(g,20,20,false);return h};c.createSpectrumCanvasWithScale=function(l,g,h,m){if(h==null){h=c.colors}var j=b(h,20,40,m);var k=j.getContext("2d");k.fillStyle="#FFA000";k.fillRect(0.5,20,1,10);k.fillText(l.toPrecision(3),0.5,40);k.fillRect(j.width/4,20,1,10);k.fillText(((l+g)/4).toPrecision(3),j.width/4,40);k.fillRect(j.width/2,20,1,10);k.fillText(((l+g)/2).toPrecision(3),j.width/2,40);k.fillRect(3*(j.width/4),20,1,10);k.fillText((3*((l+g)/4)).toPrecision(3),3*(j.width/4),40);k.fillRect(j.width-0.5,20,1,10);k.fillText(g.toPrecision(3),j.width-20,40);return j};function d(n){n=n.replace(/\s+$/,"");n=n.replace(/^\s+/,"");var l=n.split(/\n/);var g=new Array();for(var j=0;j<l.length;j++){var m=l[j].replace(/\s+$/,"").split(/\s+/);for(var h=0;h<m.length;h++){m[h]=parseFloat(m[h])}if(m.length<4){m.push(1)}g.push(m)}c.colors=g;return g}if(f!=undefined){d(f)}}function WavefrontObj(o){var m=this;o=o.split("\n");m.shapes=[];var b;var c=[];var u=[];var s=[];b={name:o.name|"undefined",faces:[],positionArray:[],colorArray:[],indexArray:[],texIndexArray:[],normalIndexArray:[]};m.shapes.push(b);for(var p=0;p<o.length;p++){var v=o[p].split(/\s+/);if(!(v[0].match("#"))||v==""){if(v[0]=="o"|v[0]=="g"){console.log(v[1]);b={name:v[1],faces:[],positionArray:[],colorArray:[],indexArray:[],texIndexArray:[],normalIndexArray:[]};m.shapes.push(b)}else{if(v[0]=="v"){c.push(parseFloat(v[1]));c.push(parseFloat(v[2]));c.push(parseFloat(v[3]))}else{if(v[0]=="vt"){for(var f=1;f<v.length;f++){u.push(parseFloat(v[f]))}}else{if(v[0]=="vn"){s.push(parseFloat(v[1]));s.push(parseFloat(v[2]));s.push(parseFloat(v[3]))}else{if(v[0]=="f"){var t=[];for(var j=1;j<4;j++){var g=v[j].split("/");t.push(parseInt(g[0])-1);b.indexArray.push(parseInt(g[0])-1);b.texIndexArray.push(parseInt(g[1])-1);if(g[2]){b.normalIndexArray.push(parseInt(g[2])-1)}}if(v.length>=4){for(j;j<v.length;j++){var g=v[j].split("/");t.push(parseInt(g[0])-1);var q=b.indexArray.length;b.indexArray.push(b.indexArray[q-1]);b.indexArray.push(b.indexArray[q-3]);b.indexArray.push(g[0]-1)}}b.faces.push(t)}}}}}}}var a=Array(c.length/3);var d=m.shapes.length;for(var h=0;h<d;h++){var r=m.shapes[h];r.positionArray=c;if(r.colorArray.length==0){r.colorArray=[0.8,0.8,0.8,1]}}m.objectClass="P";m.vertexArray=c;m.texCoordArray=u}function MNIObject(d){var k;var h=this;function b(n){h.num_hemispheres=1;var m=n.replace(/\s+$/,"");var o=m.replace(/^\s+/,"");k=o.split(/\s+/).reverse();h.objectClass=k.pop();if(h.objectClass=="P"){f();h.numberVertices=parseInt(k.pop());g();l();h.nitems=parseInt(k.pop())}else{if(h.objectClass=="L"){f();h.numberVertices=parseInt(k.pop());g();h.nitems=parseInt(k.pop())}else{h.objectClass="__FAIL__";return}}j();c();a();if(h.objectClass=="P"){if(h.positionArray.length==81924*3){h.brainSurface=true;h.split_hemispheres()}}}function f(){if(h.objectClass=="P"){h.surfaceProperties={ambient:parseFloat(k.pop()),diffuse:parseFloat(k.pop()),specular_reflectance:parseFloat(k.pop()),specular_scattering:parseFloat(k.pop()),transparency:parseFloat(k.pop())}}else{if(h.objectClass=="L"){h.surfaceProperties={width:k.pop()}}}}function g(){h.positionArray=new Array();for(var m=0;m<h.numberVertices;m++){for(var n=0;n<3;n++){h.positionArray.push(parseFloat(k.pop()))}}}function l(){h.normalArray=new Array();for(var o=0;o<h.numberVertices;o++){for(var m=0;m<3;m++){h.normalArray.push(parseFloat(k.pop()))}}}function j(){h.colorFlag=parseInt(k.pop());h.colorArray=new Array();if(h.colorFlag===0){for(var m=0;m<4;m++){h.colorArray.push(parseFloat(k.pop()))}}else{if(h.colorFlag===1){for(var n=0;n<h.numberPolygons;n++){for(var m=0;m<4;m++){h.colorArray.push(parseFloat(k.pop()))}}}else{if(h.colorFlag===2){for(var n=0;n<h.numberVertices;n++){for(var m=0;m<4;m++){h.colorArray.push(parseFloat(k.pop()))}}}else{throw new Error("colorFlag not valid in that file")}}}}function c(){h.endIndicesArray=new Array();for(var m=0;m<h.nitems;m++){h.endIndicesArray.push(parseInt(k.pop()))}}function a(){h.indexArray=new Array();var n=k.length;for(var m=0;m<n;m++){h.indexArray.push(parseInt(k.pop()))}}h.split_hemispheres=function(){h.left={};h.right={};var q=h.positionArray.length;h.left.positionArray=h.positionArray.slice(0,q/2);h.right.positionArray=h.positionArray.slice(q/2,q);var p=h.indexArray.length;h.left.indexArray=h.indexArray.slice(0,p/2);h.right.indexArray=h.indexArray.slice(p/2,p);for(var m=0;m<h.right.indexArray.length;m++){h.right.indexArray[m]=h.right.indexArray[m]-2-p/3/2/2}var n=h.normalArray.length;h.left.normalArray=h.normalArray.slice(0,n/2);h.right.normalArray=h.normalArray.slice(n/2,n);h.left.colorFlag=h.colorFlag;h.right.colorFlag=h.colorFlag;if(h.colorFlag==0||h.colorFlag==1){h.left.colorArray=h.colorArray;h.right.colorArray=h.colorArray}else{var o=h.colorArray.length;h.left.colorArray=h.colorArray.slice(0,o/2);h.right.colorArray=h.colorArray.slice(o/2+1,-1)}h.left.numberVertices=h.numberVertices/2;h.right.numberVertices=h.numberVertices/2;h.left.numberPolygons=h.numberPolygons/2;h.right.numberPolygons=h.numberPolygons/2;h.num_hemispheres=2};h.getVertexInfo=function(n){var m=[h.positionArray[n*3],h.positionArray[n*3+1],h.positionArray[n*3+2]];return{vertex:n,position_vector:m}};h.get_vertex=function(w,t,m){if(h.num_hemispheres>1){var s=h[m];var p=0;if(m=="right"){p=2+s.indexArray.length/3/2}}else{var s=h;var p=0}var r=new Array();var z=w*3;for(var q=0;q<3;q++){r.push(s.indexArray[z+q])}var x=new Array();for(var q=0;q<3;q++){var v=r[q]*3;x[q]=new Array();for(var o=0;o<3;o++){x[q][o]=s.positionArray[v+o]}}var y=new Array();for(var q=0;q<3;q++){y.push(o3djs.math.distance(t,x[q]))}var n=0;if(y[1]<y[0]){n=1}if(y[2]<y[n]){n=2}var u=r[n]+p;var A=x[n];return{vertex:u,position_vector:A}};if(d){b(d)}}function BrainBrowser(){var h=this;var k=new ColorManager();var f;var v;var y;var x;var z;var n=new THREE.Object3D();var j;var w;var c;var A;this.start=function(){window.onload=function(){setTimeout(function(){h.init()},0)}};this.init=function(){z=new THREE.Scene();f=$("#view-window");y=new THREE.PerspectiveCamera(30,f.width()/f.height(),0.1,5000);if(g()){v=new THREE.WebGLRenderer({clearColor:8947848,clearAlpha:1,preserveDrawingBuffer:true})}else{f.html(o());return}v.setSize(f.width(),f.height());f.append(v.domElement);y.position.z=500;x=new THREE.PointLight(16777215);x.position.x=0;x.position.y=0;x.position.z=500;z.add(x);j=new THREE.TrackballControls(y,f[0]);w=new THREE.TrackballControls(x,f[0]);j.zoomSpeed=2;w.zoomSpeed=2;function E(F){requestAnimationFrame(E);A=c||F;c=F;j.update();w.update();h.renderCallback(F)}if(h.afterInit){h.afterInit(h)}window.onresize();E()};
/*! 
   * WebGL test taken from Detector.js by
   * alteredq / http://alteredqualia.com/
   * mr.doob / http://mrdoob.com/
  */
function g(){try{return !!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(E){return false}}function o(){var F='BrainBrowser requires <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>.<br/>';F+=window.WebGLRenderingContext?"Your browser seems to support it, but it is <br/> disabled or unavailable.<br/>":"Your browser does not seem to support it.<br/>";F+='Test your browser\'s WebGL support <a href="http://get.webgl.org/">here</a>.';var E=$('<div id="webgl-error">'+F+"</div>");return E}this.setCamera=function(E,G,F){y.position.set(E,G,F)};this.getModel=function(){return n};function l(G,H){h.model_data=G;var F=r(G.left);F.name="left";F.model_num=0;var E=r(G.right);E.name="right";E.model_num=1;n.add(F);n.add(E);z.add(n)}function r(H){var N=H.positionArray;var G=H.indexArray;var M={};var F={};var K;for(var I=0;I+2<N.length;I+=3){s(M,N[I],N[I+1],N[I+2])}F.x=M.minX+0.5*(M.maxX-M.minX);F.y=M.minY+0.5*(M.maxY-M.minY);F.z=M.minY+0.5*(M.maxZ-M.minZ);var L=new THREE.Geometry();for(var I=0;I+2<N.length;I+=3){L.vertices.push(new THREE.Vector3(N[I]-F.x,N[I+1]-F.y,N[I+2]-F.z))}for(var I=0;I+2<G.length;I+=3){K=new THREE.Face3(G[I],G[I+1],G[I+2]);K.vertexColors[0]=new THREE.Color();K.vertexColors[1]=new THREE.Color();K.vertexColors[2]=new THREE.Color();L.faces.push(K)}L.computeFaceNormals();L.computeVertexNormals();var J=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:526344,vertexColors:THREE.VertexColors});var E=new THREE.Mesh(L,J);E.centroid=F;E.position.set(F.x,F.y,F.z);return E}function u(G,E,I,H){var F=q(G,I);F.name=E;if(H){F.renderDepth=H}n.add(F);z.add(n)}function q(L,U){h.model_data=L;var T=[];var R=[];var E=[];var P={};var G={};for(var M=0;M<h.model_data.nitems;M++){if(M==0){var F=0}else{var F=h.model_data.endIndicesArray[M-1]}T.push(h.model_data.indexArray[F]);for(var J=F+1;J<h.model_data.endIndicesArray[M]-1;J++){T.push(h.model_data.indexArray[J]);T.push(h.model_data.indexArray[J])}T.push(h.model_data.indexArray[h.model_data.endIndicesArray[M]-1])}var Q=h.model_data.positionArray;for(var K=0;K<T.length;K++){s(P,Q[T[K]*3],Q[T[K]*3+1],Q[T[K]*3+2])}G.x=P.minX+0.5*(P.maxX-P.minX);G.y=P.minY+0.5*(P.maxY-P.minY);G.z=P.minY+0.5*(P.maxZ-P.minZ);if(!U){for(var K=0;K<T.length;K++){R.push(new THREE.Vector3(Q[T[K]*3]-G.x,Q[T[K]*3+1]-G.y,Q[T[K]*3+2]-G.z))}var S=[];if(h.model_data.colorArray.length==4){for(var M=0;M<numberVertices;M++){S.push.apply(S,[0.5,0.5,0.7,1])}}else{var S=h.model_data.colorArray;for(var K=0;K<T.length;K++){var H=new THREE.Color();H.setRGB(S[T[K]*4],S[T[K]*4+1],S[T[K]*4+2]);E.push(H)}}}else{R=h.model_data.meshPositionArray;E=h.model_data.meshColorArray}var O=new THREE.Geometry();O.vertices=R;O.colors=E;O.colorsNeedUpdate=true;var N=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});var I=new THREE.Line(O,N,THREE.LinePieces);I.position.set(G.x,G.y,G.z);I.centroid=G;return I}function C(H,F,I){h.model_data=H;if(h.model_data.shapes){for(var G=0;G<h.model_data.shapes.length;G++){var E=m(h.model_data.shapes[G]);E.name=h.model_data.shapes[G].name;n.add(E)}}else{var E=m(h.model_data);E.name=F;n.add(E)}if(h.afterCreate!=undefined){h.afterCreate(h.model_data)}z.add(n)}function m(P){var K=P.positionArray;var Q=P.indexArray;var R=[];if(P.colorArray.length==4){for(var J=0;J<K.length/3;J++){R.push(P.colorArray[0]);R.push(P.colorArray[1]);R.push(P.colorArray[2])}}else{R=[];var H=Q.length;for(var I=0;I+2<P.colorArray.length;I+=4){R.push(P.colorArray[I]);R.push(P.colorArray[I+1]);R.push(P.colorArray[I+2])}}var E=[];var G;var N=new THREE.Geometry();for(var J=0;J+2<K.length;J+=3){N.vertices.push(new THREE.Vector3(K[J],K[J+1],K[J+2]));G=new THREE.Color();G.setRGB(R[J],R[J+1],R[J+2]);E.push(G)}if(P.faces&&P.faces.length>0){var F=P.faces;for(var J=0;J<F.length;J++){if(F[J].length<3){continue}if(F[J].length<=4){if(F[J].length<=3){var M=new THREE.Face3(F[J][0],F[J][1],F[J][2])}else{if(F[J].length==4){var M=new THREE.Face4(F[J][0],F[J][1],F[J][2],F[J][3])}}M.vertexColors[0]=E[M.a];M.vertexColors[1]=E[M.b];M.vertexColors[2]=E[M.c];if(F[J].length>3){M.vertexColors[3]=E[M.d]}N.faces.push(M)}else{for(var I=1;I+1<F[J].length;I++){var M=new THREE.Face3(F[J][0],F[J][I],F[J][I+1]);M.vertexColors[0]=E[M.a];M.vertexColors[1]=E[M.b];M.vertexColors[2]=E[M.c];N.faces.push(M)}}}}else{for(var J=0;J+2<Q.length;J+=3){var M=new THREE.Face3(Q[J],Q[J+1],Q[J+2]);M.vertexColors[0]=E[M.a];M.vertexColors[1]=E[M.b];M.vertexColors[2]=E[M.c];N.faces.push(M)}}N.computeFaceNormals();N.computeVertexNormals();N.colorsNeedUpdate=true;var L=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:526344,vertexColors:THREE.VertexColors});var O=new THREE.Mesh(N,L);if(h.loading){jQuery(h.loading).html("Buffers Loaded")}return O}this.uninit=function(){if(this.client){this.client.cleanup()}};this.renderCallback=function(){var F=c-A;var E=F*0.00015;if(h.autoRotate){if(h.autoRotate.x){n.rotation.x+=E}if(h.autoRotate.y){n.rotation.y+=E}if(h.autoRotate.z){n.rotation.z+=E}}v.render(z,y)};this.clearScreen=function(){if(n){z.remove(n)}h.resetView();n=new THREE.Object3D();if(h.afterClearScreen!=undefined){h.afterClearScreen()}};this.displayObjectFile=function(I,F,H){var G=H||{};var J=G.renderDepth;if(I.objectClass=="P"&&I.numberVertices==81924){l(I,J)}else{if(I.objectClass=="P"){C(I,F,J)}else{if(I.objectClass=="L"){u(I,F,false,J)}else{alert("Object file not supported")}}}if(h.afterDisplayObject!=undefined){h.afterDisplayObject(n)}var G=H||{};var E=G.afterDisplay;if(E){E()}};function d(G,E,F){if(F==null){F=h.model_data.data}if(F.fixRange==false||F.fixRange==null){F.rangeMin=G;F.rangeMax=E}}this.updateClearColor=function(E){v.setClearColor(new THREE.Color(E))};this.updateClearColorFromName=function(E){if(E=="white"){h.updateClearColor(16777215)}else{if(E=="black"){h.updateClearColor(0)}else{if(E=="pink"){h.updateClearColor(16711935)}else{h.updateClearColor(8947848)}}}};this.resetView=function(){j.reset();w.reset();n.position.set(0,0,0);n.rotation.set(0,0,0);for(var E=0;E<n.children.length;E++){var F=n.children[E];F.visible=true;if(F.centroid){F.position.set(F.centroid.x,F.centroid.y,F.centroid.z)}else{F.position.set(0,0,0)}F.rotation.set(0,0,0)}};this.setupView=function(E){h.resetView();if(h.model_data&&h.model_data.num_hemispheres==2){var F=h.getViewParams();switch(F.view){case"superior":h.superiorView();break;case"medial":h.medialView();break;case"anterior":h.anteriorView();break;case"inferior":h.inferiorView();break;case"lateral":h.lateralView();break;case"posterior":h.posteriorView();break;default:h.superiorView();break}}if(n.getChildByName("left")){if(F.left==true){h.leftHemisphereVisible(true)}else{h.leftHemisphereVisible(false)}}if(n.getChildByName("right")){if(F.right==true){h.rightHemisphereVisible(true)}else{h.rightHemisphereVisible(false)}}};function a(E){return E*Math.PI/180}this.leftHemisphereVisible=function(E){n.getChildByName("left").visible=E};this.rightHemisphereVisible=function(E){n.getChildByName("right").visible=E};this.medialView=function(E){if(h.model_data.num_hemispheres==2){n.getChildByName("left").position.x-=100;n.getChildByName("left").rotation.z-=a(90);n.getChildByName("right").position.x+=100;n.getChildByName("right").rotation.z+=a(90);n.rotation.x+=a(-90)}};this.lateralView=function(E){if(h.model_data.num_hemispheres==2){n.getChildByName("left").position.x-=100;n.getChildByName("left").rotation.z+=a(-90);n.getChildByName("right").position.x+=100;n.getChildByName("right").rotation.z+=a(90);n.rotation.x+=a(90);n.rotation.y+=a(180)}};this.superiorView=function(){};this.inferiorView=function(){n.rotation.y+=a(180)};this.anteriorView=function(E){h.resetView();n.rotation.x+=a(-90);n.rotation.z+=a(180)};this.posteriorView=function(E){h.resetView();n.rotation.x+=a(-90)};this.separateHemispheres=function(E){if(h.model_data.num_hemispheres==2){n.children[0].position.x-=1;n.children[1].position.x+=1}};this.ZoomInOut=function(E){y.fov*=E;y.updateProjectionMatrix()};h.scrollMe=function(F){var E=(F.deltaY<0)?1/h.zoomFactor:h.zoomFactor;h.ZoomInOut(E);h.client.render()};function t(E){B();if(E){h.selectedInfo=E}}function B(){if(h.selectedInfo){h.highlightShape=null;h.selectedInfo=null}}this.click=function(J,G){var H=f.offset();mouseX=((J.clientX-H.left+$(window).scrollLeft())/f.width())*2-1;mouseY=-((J.clientY-H.top+$(window).scrollTop())/f.height())*2+1;var L=new THREE.Projector();var K=new THREE.Raycaster();B();var F=new THREE.Vector3(mouseX,mouseY,1);L.unprojectVector(F,y);K.set(y.position,F.sub(y.position).normalize());var I=K.intersectObject(n,true);if(I.length>0){var E=I[0];var M={vertex:E.face.a,point:new THREE.Vector3(E.point.x,E.point.y,E.point.z),object:E.object};return G(J,M)}else{jQuery(h.pickInfoElem).html("--nothing--");return false}};this.getInfoForVertex=function(F){var E=h.model_data.getVertexInfo(F);var G={vertex:E.vertex,point:new THREE.Vector3(E.position_vector[0],E.position_vector[1],E.position_vector[2])};return G};this.keyPressedCallback=function(F){var E=false;switch(F.which){case 38:h.ZoomInOut(1.1);E="ZoomIn";break;case 40:h.ZoomInOut(1/1.1);E="ZoomOut";break;case 32:h.separateHemispheres();E="Seperate";break}if(E){return false}else{return true}};function s(G,E,H,F){if(!G.minX||G.minX>E){G.minX=E}if(!G.maxX||G.maxX<E){G.maxX=E}if(!G.minY||G.minY>H){G.minY=H}if(!G.maxY||G.maxY<H){G.maxY=H}if(!G.minZ||G.minZ>F){G.minZ=F}if(!G.maxZ||G.maxZ<F){G.maxZ=F}}function p(E,J,I){var H=new THREE.SphereGeometry(2);var G=new THREE.MeshBasicMaterial({color:16711680});var F=new THREE.Mesh(H,G);F.position.set(E,J,I);z.add(F)}this.set_fill_mode_wireframe=function(){var F=n.children;for(var E=0;E<F.length;E++){var G=F[E].material;G.wireframe=true;if(G.emissive){G.emissive.setHex(125269879)}}};this.set_fill_mode_solid=function(){var F=n.children;for(var E=0;E<F.length;E++){var G=F[E].material;G.wireframe=false;if(G.emissive){G.emissive.setHex(0)}}};function D(F,H,I){var E=H||{};var G=E.beforeLoad;if(G){G()}jQuery.ajax({type:"GET",url:F,dataType:"text",success:function(J){I(J)},error:function(J,L,K){alert("Failure in loadFromURL: "+L)},data:{},timeout:100000})}function b(K,I,J){var H=K.files;if(H.length===0){return}var F=I||{};var G=F.beforeLoad;var E=new FileReader();E.file=H[0];if(G){G()}E.onloadend=function(L){J(L.target.result)};E.readAsText(H[0])}this.loadObjFromUrl=function(E,F){D(E,F,function(H){var I=E.split("/");var G=I[I.length-1];h.displayObjectFile(new MNIObject(H),G,F)})};this.loadWavefrontObjFromUrl=function(E,F){D(E,F,function(H){var I=E.split("/");var G=I[I.length-1];h.displayObjectFile(new WavefrontObj(H),G,F)})};this.loadObjFromFile=function(G,F){var E=F||{};b(G,E,function(H){var K=G.value.split("\\");var I=K[K.length-1];var J;if(E.format==="wavefront"){J=new WavefrontObj(H)}else{J=new MNIObject(H)}if(J.objectClass!=="__FAIL__"){h.displayObjectFile(J,I,E)}else{if(E.onError!=undefined){E.onError()}}})};this.loadSpectrumFromUrl=function(E,G){options=G||{};var F=options.afterLoadSpectrum;D(E,options,function(I){var H=new Spectrum(I);h.spectrum=H;if(F){F()}if(h.afterLoadSpectrum!=null){h.afterLoadSpectrum(H)}if(h.model_data.data){h.updateColors(h.model_data.data,h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.spectrum,h.flip,h.clamped)}})};this.loadSpectrumFromFile=function(E){b(E,null,function(G){var F=new Spectrum(G);h.spectrum=F;if(h.afterLoadSpectrum!=null){h.afterLoadSpectrum(F)}if(h.model_data.data){h.updateColors(h.model_data.data,h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.spectrum,h.flip,h.clamped)}})};this.loadDataFromFile=function(K){var E=K.files[0].name;var I=function(M){var L=new Data(M);L.fileName=E;if(L.values.length<h.model_data.positionArray.length/4){alert("Number of numbers in datafile lower than number of vertices Vertices"+h.model_data.positionArray.length/3+" data values:"+L.values.length);return -1}else{h.model_data.data=L}d(h.model_data.data.min,h.model_data.data.max);if(h.afterLoadData!=null){h.afterLoadData(h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.model_data.data)}h.updateColors(h.model_data.data,h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.spectrum,h.flip,h.clamped);return null};if(E.match(/.*.mnc|.*.nii/)){var J=new XMLHttpRequest();if(E.match(/.*.mnc/)){J.open("POST","/minc/volume_object_evaluate",false)}else{J.open("POST","/nii/volume_object_evaluate",false)}var G=document.getElementById("datafile-form");var H=new FormData(G);J.send(H);var F=J.response;I(F)}else{b(K,null,I)}};this.loadSeriesDataFromFile=function(J){console.log(J.files.length);var I=J.files.length;h.seriesData=new Array(I);h.seriesData.numberFiles=I;var G=J.files;for(var F=0;F<I;F++){var E=new FileReader();E.file=G[F];var H=E.onloadend=(function(L,K){return function(M){console.log(M.target.result.length);console.log(K);h.seriesData[K]=new Data(M.target.result);h.seriesData[K].fileName=L.name}})(E.file,F);E.readAsText(G[F])}h.setupSeries()};this.setupSeries=function(){$('<div id="series">Series: </div>').appendTo("#surface_choice");var E=$("#series");$('<span id="series-value">0</span>').appendTo(E);$('<div id="series-slider" width="100px" + height="10"></div>').slider({value:0,min:0,max:h.seriesData.numberFiles-1,step:0.1,slide:function(F,G){if(G.value-Math.floor(G.value)<0.01){h.model_data.data=h.seriesData[G.value]}else{if(h.seriesData[0].fileName.match("pval.*")){h.model_data.data=new Data(interpolateDataArray(h.seriesData[Math.floor(G.value)],h.seriesData[Math.floor(G.value)+1],(G.value-Math.floor(G.value)),true))}else{h.model_data.data=new Data(interpolateDataArray(h.seriesData[Math.floor(G.value)],h.seriesData[Math.floor(G.value)+1],(G.value-Math.floor(G.value))))}}if(h.seriesData[0].fileName.match("mt.*")){$("#age_series").html("Age: "+(G.value*3+5).toFixed(1))}else{if(h.seriesData[0].fileName.match("pval.*")){$("#age_series").html("Age: "+(G.value*1+10))}}$(E).children("#series-value").html(G.value);if(h.model_data.data.values.length<h.model_data.positionArray.length/4){console.log("Number of numbers in datafile lower than number of vertices Vertices"+h.model_data.positionArray.length/3+" data values:"+h.model_data.data.values.length);return -1}d(h.model_data.data.min,h.model_data.data.max);if(h.afterLoadData!=null){h.afterLoadData(h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.model_data.data)}h.updateColors(h.model_data.data,h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.spectrum,h.flip,h.clamped);return null}}).appendTo(E)};this.loadBlendDataFromFile=function(J){var I=J.files.length;h.blendData=new Array(I);h.blendData.numberFiles=I;var G=J.files;for(var F=0;F<I;F++){var E=new FileReader();E.file=G[F];var H=E.onloadend=(function(L,K){return function(N){h.blendData[K]=new Data(N.target.result);h.blendData.alpha=1/I;h.blendData[K].fileName=L.name;for(var M=0;M<2;M++){if(h.blendData[M]==undefined){console.log("not done yet");return}}d(h.blendData[0].values.min(),h.blendData[0].values.max(),h.blendData[0]);d(h.blendData[1].values.min(),h.blendData[1].values.max(),h.blendData[1]);if(h.afterLoadData!=null){h.afterLoadData(null,null,h.blendData,true)}h.blend($(".blend_slider").slider("value"))}})(E.file,F);E.readAsText(G[F])}h.setupBlendColors()};this.setupBlendColors=function(){console.log("Blend colors has ran "+h.blendData.numberFiles);$("#blend").remove();$('<div id="blend">Blend ratios: </div>').appendTo("#surface_choice");var E=$("#blend");$('<span id="blend_value'+i+'">0</span>').appendTo(E);$('<div class="blend_slider" id="blend_slider'+i+'" width="100px" + height="10"></div>').slider({value:0,min:0.1,max:0.99,value:0.5,step:0.01,slide:function(F,G){h.blend($(this).slider("value"))}}).appendTo(E)};this.blend=function(F){h.blendData[0].alpha=F;h.blendData[1].alpha=1-F;for(var E=2;E<h.blendData.length;E++){h.blendData[E].alpha=0}h.updateColors(h.blendData,null,null,h.spectrum,h.flip,h.clamped,true)};this.loadDataFromUrl=function(F,E){D(F,null,function(H,G){h.model_data.data=new Data(H);h.model_data.data.fileName=E;d(h.model_data.data.min,h.model_data.data.max);if(h.afterLoadData!=undefined){h.afterLoadData(h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.model_data.data)}h.updateColors(h.model_data.data,h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.spectrum)})};this.updateColors=function(ai,W,ab,ag,O,U,Z,G,S){var L=S||{};var H=L.afterUpdate;h.clamped=U;if(Z){var ah=k.blendColorMap(ag,ai,0,1)}else{var ah=ai.createColorArray(W,ab,ag,O,U,h.model_data.colorArray,h.model_data)}if(h.model_data.num_hemispheres==2){var E=ah.slice(0,ah.length/2);var T=ah.slice(ah.length/2,ah.length);var Q=[];var ac=[];var X=n.getChildByName("left");var ae=X.geometry.faces;var I=n.getChildByName("right");var J=I.geometry.faces;var P;var ad=J.length;var V=ae.length;var K;var af;K=Math.max(V,ad);for(var aa=0;aa<K;aa++){if(aa<V){P=ae[aa];af=P.a*4;P.vertexColors[0].setRGB(E[af],E[af+1],E[af+2]);af=P.b*4;P.vertexColors[1].setRGB(E[af],E[af+1],E[af+2]);af=P.c*4;P.vertexColors[2].setRGB(E[af],E[af+1],E[af+2]);if(P.d){af=P.d*4;P.vertexColors[3].setRGB(E[af],E[af+1],E[af+2])}}if(aa<ad){P=J[aa];af=P.a*4;P.vertexColors[0].setRGB(T[af],T[af+1],T[af+2]);af=P.b*4;P.vertexColors[1].setRGB(T[af],T[af+1],T[af+2]);af=P.c*4;P.vertexColors[2].setRGB(T[af],T[af+1],T[af+2]);if(P.d){af=P.d*4;P.vertexColors[3].setRGB(T[af],T[af+1],T[af+2])}}}X.geometry.colorsNeedUpdate=true;I.geometry.colorsNeedUpdate=true}else{var R=[];for(var aa=0;aa+2<ah.length;aa+=4){var N=new THREE.Color();N.setRGB(ah[aa],ah[aa+1],ah[aa+2]);R.push(N)}var M=n.children;for(var aa=0;aa<M.length;aa++){var F=M[aa].geometry.faces;for(var Y=0;Y<F.length;Y++){var P=F[Y];P.vertexColors[0]=R[P.a];P.vertexColors[1]=R[P.b];P.vertexColors[2]=R[P.c];if(P.d){P.vertexColors[3]=R[P.d]}}M[aa].geometry.colorsNeedUpdate=true}}if(H){H()}if(h.afterUpdateColors!=null){h.afterUpdateColors(ai,W,ab,ag)}return 1};this.rangeChange=function(H,E,I,J){var G=J||{};var F=G.afterChange;h.model_data.data.rangeMin=H;h.model_data.data.rangeMax=E;h.updateColors(h.model_data.data,h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.spectrum,h.flip,I);if(F){F()}if(h.afterRangeChange!=null){h.afterRangeChange(H,E)}};this.changeShapeTransparency=function(F,G){var E=n.getChildByName(F);if(E){E.material.opacity=G;if(G==1){E.material.transparent=false}else{E.material.transparent=true}}};this.getImageUrl=function(){var H=document.createElement("canvas");var E=document.getElementById("spectrum_canvas");H.width=f.width();H.height=f.height();var I=H.getContext("2d");var F=new Image();function G(){var J=new Image();J.onload=function(){I.drawImage(J,0,0);window.open(H.toDataURL(),"screenshot")};J.src=E.toDataURL()}F.onload=function(){I.drawImage(F,0,0);if(E){G()}else{window.open(H.toDataURL(),"screenshot")}};F.src=v.domElement.toDataURL()};window.onresize=function(){f=$("#view-window");v.setSize(f.width(),f.height());y.aspect=f.width()/f.height();y.updateProjectionMatrix()};h.start()}var brainbrowser;function SurfView(a){var b=this;brainbrowser=new BrainBrowser();this.brainbrowser=brainbrowser;brainbrowser.getViewParams=function(){return{view:jQuery("[name=hem_view]:checked").val(),left:jQuery("#left_hem_visible").is(":checked"),right:jQuery("#right_hem_visible").is(":checked")}};brainbrowser.afterLoadSpectrum=function(c){var d=c.createSpectrumCanvasWithScale(0,100,null);d.id="spectrum_canvas";var f=document.getElementById("color_bar");if(!f){jQuery('<div id="color_bar"></div>').html(d).appendTo("#data-range")}else{jQuery(f).html(d)}brainbrowser.spectrumObj=c};brainbrowser.afterDisplayObject=function(d){$("#shapes").html("");if(d.children.length>0){for(var f=0;f<d.children.length;f++){var c=d.children[f];$('<div id="shape_'+f+'" data-shape-name="'+c.name+'" class="shape"><h4>Shape '+(f+1)+"</h4>Name: "+c.name+'<br />Opacity: <div class="opacity-slider slider"  data-shape-name='+c.name+"></div></div>").appendTo("#shapes")}}brainbrowser.afterClearScreen=function(){$("#shapes").html("")};$(".opacity-slider").slider({value:100,min:-1,max:101,slide:function(g,j){var h=$(g.target).attr("data-shape-name");var k=$(g.target).slider("value");k=Math.min(100,Math.max(0,k))/100;brainbrowser.changeShapeTransparency(h,k)}})};jQuery("#resetview").click(brainbrowser.setupView);jQuery(".view_button").change(brainbrowser.setupView);jQuery("[name=hem_view]").change(brainbrowser.setupView);this.updateCoordinates=function(c,f,d){jQuery("#x-coord").val(c[0]);jQuery("#y-coord").val(c[1]);jQuery("#z-coord").val(c[2]);jQuery("#v-coord").val(f);jQuery("#value-coord").val(d)};brainbrowser.afterInit=function(f){f.clamped=true;f.flip=false;f.clearScreen();if(typeof a=="string"&&a!=""){f.loadObjFromUrl(a)}else{if(typeof a=="function"){a(f)}}jQuery("body").keydown(f.keyPressedCallback);jQuery("#range-slider").slider({range:true,min:-50,max:50,value:[-10,10],slide:function(j,k){var h=parseFloat(k.values[0]);var g=parseFloat(k.values[1]);f.rangeChange(h,g,$("#clamp_range").is(":checked"))},step:0.1});f.afterRangeChange=function(j,g){$("#data-range-min").val(j);$("#data-range-max").val(g);var h=f.spectrumObj.createSpectrumCanvasWithScale(j,g,null);h.id="spectrum_canvas";$("#color_bar").html($(h))};function d(m){var g=$("#data-range");var o=false;var l='<div id="data_range_multiple"><ul>';var m=m.length?m:[m];$(g).html("");for(var j=0;j<m.length;j++){l+='<li><a href="#data_file'+j+'">'+m[j].fileName+"</a></li>"}l+="</ul>";for(var h=0;h<m.length;h++){l+='<div id="data_file'+h+'" class="box full_box"><h4>Thresholding</h4>Min: <input class="range-box" id="data-range-min" type="text" name="range_min" size="5" ><br /><div id="range-slider+'+h+'" data-blend-index="'+h+'" class="slider"></div>Max: <input class="range-box" id="data-range-max" type="text" name="range_max" size="5" ><input type="checkbox" class="button" id="fix_range"><label for="fix_range">Fix Range</label><input type="checkbox" class="button" id="clamp_range" checked="true"><label for="clamp_range">Clamp range</label><input type="checkbox" class="button" id="flip_range"><label for="flip_range">Flip Colors</label></div>'}l+="</div>";$(g).html(l);$(g).tabs();$("#data_range").find(".slider").each(function(k,p){$(p).slider({range:true,min:m[0].values.min(),max:m[0].values.max(),values:[m[k].rangeMin,m[k].rangeMax],step:0.1,slide:function(r,s){if(!o){o=true;var q=$(this).attr("data-blend-index");m[0].rangeMin=s.values[0];m[0].rangeMax=s.values[1];f.model_data.data=m[0];f.rangeChange(m[0].rangeMin,m[0].rangeMax,f.clamped,{afterChange:function(){o=false}})}}})});function n(q){var p=$("#data-range-min").val();var k=$("#data-range-max").val();jQuery(q.target).siblings(".slider").slider("values",0,p);jQuery(q.target).siblings(".slider").slider("values",1,k);f.rangeChange(p,k,$(q.target).siblings("#clamp_range").is(":checked"))}jQuery("#data-range-min").change(n);jQuery("#data-range-max").change(n);jQuery("#fix_range").click(function(k,p){f.fixRange=jQuery(e.target).is(":checked")});jQuery("#clamp_range").change(function(q){var p=parseFloat($(q.target).siblings("#data-range-min").val());var k=parseFloat($(q.target).siblings("#data-range-max").val());if($(q.target).is(":checked")){f.rangeChange(p,k,true)}else{f.rangeChange(p,k,false)}});jQuery("#flip_range").change(function(k){f.flip=$(k.target).is(":checked");f.updateColors(f.model_data.data,f.model_data.data.rangeMin,f.model_data.data.rangeMax,brainbrowser.spectrum,f.flip,f.clamped)})}f.afterLoadData=function(j,h,k,g){if(g){d(k)}else{d(k);jQuery("#range-slider").slider("values",0,parseFloat(j));jQuery("#range-slider").slider("values",1,parseFloat(h));f.afterRangeChange(j,h)}};jQuery("#meshmode").change(function(g){if(jQuery(g.target).is(":checked")){f.set_fill_mode_wireframe()}else{f.set_fill_mode_solid()}});jQuery("#clearshapes").click(function(g){brainbrowser.clearScreen()});jQuery("#openImage").click(function(g){brainbrowser.getImageUrl()});function c(g){if($("#autorotate").is(":checked")){f.autoRotate={};f.autoRotate.x=$("#autorotateX").is(":checked");f.autoRotate.y=$("#autorotateY").is(":checked");f.autoRotate.z=$("#autorotateZ").is(":checked")}else{f.autoRotate=false}}$("#autorotate-controls").children().change(c);$("#autorotate").change(c);$(".range-box").keypress(function(g){if(g.keyCode=="13"){f.rangeChange(parseFloat(jQuery("#data-range-min").val()),parseFloat(jQuery("#data-range-max").val()))}});$("#clear_color").change(function(h){var g=$(h.target).val();f.updateClearColorFromName(g)});$("#examples").click(function(k){var h=$(k.target).attr("data-example-name");switch(h){case"basic":$("#loading").show();f.clearScreen();f.loadObjFromUrl("/models/surf_reg_model_both.obj",{afterDisplay:function(){$("#loading").hide()}});break;case"punkdti":$("#loading").show();f.clearScreen();f.loadObjFromUrl("/models/dti.obj",{renderDepth:999,afterDisplay:function(){$("#loading").hide()}});f.loadObjFromUrl("/models/left_color.obj");f.loadObjFromUrl("/models/right_color.obj");break;case"realct":$("#loading").show();f.clearScreen();f.loadObjFromUrl("/models/realct.obj",{afterDisplay:function(){f.loadDataFromUrl("/models/realct.txt","cortical thickness");$("#loading").hide()}});break;case"car":$("#loading").show();f.clearScreen();f.loadWavefrontObjFromUrl("/models/car.obj",{afterDisplay:function(){$("#loading").hide()}});f.setCamera(0,0,100);var l=new THREE.Matrix4();l.makeRotationX(-0.25*Math.PI);var j=new THREE.Matrix4();j.makeRotationY(0.4*Math.PI);f.getModel().applyMatrix(j.multiply(l));break;case"plane":$("#loading").show();f.clearScreen();f.loadObjFromUrl("/models/dlr_bigger.streamlines.obj");f.loadObjFromUrl("/models/dlr.model.obj",{afterDisplay:function(){$("#loading").hide()}});f.setCamera(0,0,75);var g=new THREE.Matrix4();var l=new THREE.Matrix4();l.makeRotationX(-0.25*Math.PI);var j=new THREE.Matrix4();j.makeRotationY(0.4*Math.PI);g.multiplyMatrices(j,l);f.getModel().applyMatrix(g)}return false})}};