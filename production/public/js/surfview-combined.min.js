function Data(b){var a=this;a.parse=function(c){c=c.replace(/\s+$/,"");c=c.replace(/^\s+/,"");a.values=c.split(/\s+/);for(var d=0;d<a.values.length;d++){a.values[d]=parseFloat(a.values[d])}a.min=a.values.min();a.max=a.values.max()};this.createColorArray=function(g,o,n,k,r,d,l){var n=n.colors;var q=new Array();var p=((o-g)+(o-g)/n.length)/n.length;for(var h=0;h<a.values.length;h++){if(a.values[h]<=g){if(a.values[h]<g&&!r){var s=-1}else{var s=0}}else{if(a.values[h]>o){if(!r){var s=-1}else{var s=n.length-1}}else{var s=parseInt((a.values[h]-g)/p)}}if(k&&s!=-1){q.push.apply(q,n[n.length-1-s])}else{if(s==-1){if(d.length==4){q.push.apply(q,d)}else{q.push.apply(q,[d[h*4],d[h*4+1],d[h*4+2],d[h*4+3]])}}else{q.push.apply(q,n[s])}}}if(l.num_hemisphere!=2){var m=[];var c=l.indexArray.length;for(var f=0;f<c;f++){m[f*4]=q[l.indexArray[f]*4];m[f*4+1]=q[l.indexArray[f]*4+1];m[f*4+2]=q[l.indexArray[f]*4+2];m[f*4+3]=q[l.indexArray[f]*4+3]}q.nonIndexedColorArray=m}return q};if(b){if(typeof b=="string"){a.parse(b)}else{if(b.values!=undefined){this.values=cloneArray(b.values);this.min=this.values.min();this.max=this.values.max()}else{console.log("copying data length: "+b.length);this.values=b;this.min=b.min();this.max=b.max()}}}}Array.prototype.min=function(){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.min.apply(Math,this.slice(c,c+b-1)))}}else{return Math.min.apply(Math,this)}return a.min()};Array.prototype.max=function(d){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.max.apply(Math,this.slice(c,c+b-1)))}}else{return Math.max.apply(Math,this)}return a.max()};function cloneArray(b){var c=new Array(b.length);for(var a=0;a<c.length;a++){c[a]=b[a]}return c}function rotateUint16Array90Left(g,d,a){var f=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){f[c*a+b]=g[b*d+(d-c)]}}return f}function rotateUint16Array90Right(g,d,a){var f=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){f[c*a+b]=g[(a-b)*d+c]}}return f}function interpolateDataArray(h,c,b,a){console.log(h.values.length);var f=h.values.length;var g=new Array(f);console.log("Percentage: "+b);for(var d=0;d<f;d++){if(a){g[d]=(h.values[d]*(100-b*100)+c.values[d]*(b*100))/100}else{g[d]=(h.values[d]*(100-b*100)+c.values[d]*(b*100))/100}}console.log(g.length);return g}function ColorManager(){function c(m,d,q,j,o,l,n,h,g){var m=m.colors;var p=((o-j)+(o-j)/m.length)/m.length;for(var k=0;k<q.length;k++){if(q[k]<=j){var r=0}else{if(q[k]>o){var r=m.length-1}else{var r=parseInt((q[k]-j)/p)}}if(l){var f=255}else{var f=1}d[k*4+0]=f*m[r][0]*h+n*f;d[k*4+1]=f*m[r][1]*h+n*f;d[k*4+2]=f*m[r][2]*h+n*f;if(g){d[k*4+3]=f*g}else{d[k*4+3]=f}}return d}this.createColorMap=c;function a(l){var d=l[0];for(var h=0;h<l[0].length/4;h++){for(var g=1;g<l.length;g++){var f=d[h*4+3];var k=l[g][h*4+3];d[h*4]=d[h*4]*f+l[g][h*4]*k;d[h*4+1]=d[h*4+1]*f+l[g][h*4+1]*k;d[h*4+2]=d[h*4+2]*f+l[g][h*4+2]*k;d[h*4+3]=f+k}}return d}this.blendColors=a;function b(f,m,k,h){var d=m.length;var l=new Array(d);var j=0;for(var g=0;g<d;g++){l[g]=c(f,new Array(m[g].values.length),m[g].values,m[g].rangeMin,m[g].rangeMax,false,0,1,m[g].alpha)}return a(l)}this.blendColorMap=b}function Spectrum(f){var c=this;var a=new ColorManager();function b(g,q,j,p){var l=document.createElement("canvas");jQuery(l).attr("width",256);jQuery(l).attr("height",j);var m=new Array(256);for(var o=0;o<256;o++){if(p){m[255-o]=o}else{m[o]=o}}g=a.createColorMap(c,[],m,0,255,true,0,1);var h=l.getContext("2d");for(var n=0;n<256;n++){h.fillStyle="rgb("+parseInt(g[n*4])+","+parseInt(g[n*4+1])+","+parseInt(g[n*4+2])+")";h.fillRect(n,0,1,q)}console.log("rgb("+parseInt(g[100*4+0])+","+parseInt(g[100*4+1])+","+parseInt(g[100*4+2]));console.log(h.fillStyle);return l}c.createSpectrumCanvas=function(g){if(g==null){g=c.colors}var h=b(g,20,20,false);return h};c.createSpectrumCanvasWithScale=function(l,g,h,m){if(h==null){h=c.colors}var j=b(h,20,40,m);var k=j.getContext("2d");k.fillStyle="#FFA000";k.fillRect(0.5,20,1,10);k.fillText(l.toPrecision(3),0.5,40);k.fillRect(j.width/4,20,1,10);k.fillText(((l+g)/4).toPrecision(3),j.width/4,40);k.fillRect(j.width/2,20,1,10);k.fillText(((l+g)/2).toPrecision(3),j.width/2,40);k.fillRect(3*(j.width/4),20,1,10);k.fillText((3*((l+g)/4)).toPrecision(3),3*(j.width/4),40);k.fillRect(j.width-0.5,20,1,10);k.fillText(g.toPrecision(3),j.width-20,40);return j};function d(n){n=n.replace(/\s+$/,"");n=n.replace(/^\s+/,"");var l=n.split(/\n/);var g=new Array();for(var j=0;j<l.length;j++){var m=l[j].replace(/\s+$/,"").split(/\s+/);for(var h=0;h<m.length;h++){m[h]=parseFloat(m[h])}if(m.length<4){m.push(1)}g.push(m)}c.colors=g;return g}if(f!=undefined){d(f)}}function WavefrontObj(o){var m=this;o=o.split("\n");m.shapes=[];var b;var c=[];var u=[];var s=[];b={name:o.name|"undefined",faces:[],positionArray:[],colorArray:[],indexArray:[],texIndexArray:[],normalIndexArray:[]};m.shapes.push(b);for(var p=0;p<o.length;p++){var v=o[p].split(/\s+/);if(!(v[0].match("#"))||v==""){if(v[0]=="o"|v[0]=="g"){console.log(v[1]);b={name:v[1],faces:[],positionArray:[],colorArray:[],indexArray:[],texIndexArray:[],normalIndexArray:[]};m.shapes.push(b)}else{if(v[0]=="v"){c.push(parseFloat(v[1]));c.push(parseFloat(v[2]));c.push(parseFloat(v[3]))}else{if(v[0]=="vt"){for(var f=1;f<v.length;f++){u.push(parseFloat(v[f]))}}else{if(v[0]=="vn"){s.push(parseFloat(v[1]));s.push(parseFloat(v[2]));s.push(parseFloat(v[3]))}else{if(v[0]=="f"){var t=[];for(var j=1;j<4;j++){var g=v[j].split("/");t.push(parseInt(g[0])-1);b.indexArray.push(parseInt(g[0])-1);b.texIndexArray.push(parseInt(g[1])-1);if(g[2]){b.normalIndexArray.push(parseInt(g[2])-1)}}if(v.length>=4){for(j;j<v.length;j++){var g=v[j].split("/");t.push(parseInt(g[0])-1);var q=b.indexArray.length;b.indexArray.push(b.indexArray[q-1]);b.indexArray.push(b.indexArray[q-3]);b.indexArray.push(g[0]-1)}}b.faces.push(t)}}}}}}}var a=Array(c.length/3);var d=m.shapes.length;for(var h=0;h<d;h++){var r=m.shapes[h];r.positionArray=c;if(r.colorArray.length==0){r.colorArray=[0.8,0.8,0.8,1]}}m.objectClass="P";m.vertexArray=c;m.texCoordArray=u}function MNIObject(d){var k;var h=this;function b(n){h.num_hemispheres=1;var m=n.replace(/\s+$/,"");var o=m.replace(/^\s+/,"");k=o.split(/\s+/).reverse();h.objectClass=k.pop();if(h.objectClass=="P"){f();h.numberVertices=parseInt(k.pop());g();l();h.nitems=parseInt(k.pop())}else{if(h.objectClass=="L"){f();h.numberVertices=parseInt(k.pop());g();h.nitems=parseInt(k.pop())}else{throw new Error("That object class is not supported currently")}}j();c();a();if(h.objectClass=="P"){if(h.positionArray.length==81924*3){h.brainSurface=true;h.split_hemispheres()}}}function f(){if(h.objectClass=="P"){h.surfaceProperties={ambient:parseFloat(k.pop()),diffuse:parseFloat(k.pop()),specular_reflectance:parseFloat(k.pop()),specular_scattering:parseFloat(k.pop()),transparency:parseFloat(k.pop())}}else{if(h.objectClass=="L"){h.surfaceProperties={width:k.pop()}}}}function g(){h.positionArray=new Array();for(var m=0;m<h.numberVertices;m++){for(var n=0;n<3;n++){h.positionArray.push(parseFloat(k.pop()))}}}function l(){h.normalArray=new Array();for(var o=0;o<h.numberVertices;o++){for(var m=0;m<3;m++){h.normalArray.push(parseFloat(k.pop()))}}}function j(){h.colorFlag=parseInt(k.pop());h.colorArray=new Array();if(h.colorFlag===0){for(var m=0;m<4;m++){h.colorArray.push(parseFloat(k.pop()))}}else{if(h.colorFlag===1){for(var n=0;n<h.numberPolygons;n++){for(var m=0;m<4;m++){h.colorArray.push(parseFloat(k.pop()))}}}else{if(h.colorFlag===2){for(var n=0;n<h.numberVertices;n++){for(var m=0;m<4;m++){h.colorArray.push(parseFloat(k.pop()))}}}else{throw new Error("colorFlag not valid in that file")}}}}function c(){h.endIndicesArray=new Array();for(var m=0;m<h.nitems;m++){h.endIndicesArray.push(parseInt(k.pop()))}}function a(){h.indexArray=new Array();var n=k.length;for(var m=0;m<n;m++){h.indexArray.push(parseInt(k.pop()))}}h.split_hemispheres=function(){h.left={};h.right={};var q=h.positionArray.length;h.left.positionArray=h.positionArray.slice(0,q/2);h.right.positionArray=h.positionArray.slice(q/2,q);var p=h.indexArray.length;h.left.indexArray=h.indexArray.slice(0,p/2);h.right.indexArray=h.indexArray.slice(p/2,p);for(var m=0;m<h.right.indexArray.length;m++){h.right.indexArray[m]=h.right.indexArray[m]-2-p/3/2/2}var n=h.normalArray.length;h.left.normalArray=h.normalArray.slice(0,n/2);h.right.normalArray=h.normalArray.slice(n/2,n);h.left.colorFlag=h.colorFlag;h.right.colorFlag=h.colorFlag;if(h.colorFlag==0||h.colorFlag==1){h.left.colorArray=h.colorArray;h.right.colorArray=h.colorArray}else{var o=h.colorArray.length;h.left.colorArray=h.colorArray.slice(0,o/2);h.right.colorArray=h.colorArray.slice(o/2+1,-1)}h.left.numberVertices=h.numberVertices/2;h.right.numberVertices=h.numberVertices/2;h.left.numberPolygons=h.numberPolygons/2;h.right.numberPolygons=h.numberPolygons/2;h.num_hemispheres=2};h.getVertexInfo=function(n){var m=[h.positionArray[n*3],h.positionArray[n*3+1],h.positionArray[n*3+2]];return{vertex:n,position_vector:m}};h.get_vertex=function(w,t,m){if(h.num_hemispheres>1){var s=h[m];var p=0;if(m=="right"){p=2+s.indexArray.length/3/2}}else{var s=h;var p=0}var r=new Array();var z=w*3;for(var q=0;q<3;q++){r.push(s.indexArray[z+q])}var x=new Array();for(var q=0;q<3;q++){var v=r[q]*3;x[q]=new Array();for(var o=0;o<3;o++){x[q][o]=s.positionArray[v+o]}}var y=new Array();for(var q=0;q<3;q++){y.push(o3djs.math.distance(t,x[q]))}var n=0;if(y[1]<y[0]){n=1}if(y[2]<y[n]){n=2}var u=r[n]+p;var A=x[n];return{vertex:u,position_vector:A}};if(d){b(d)}}function bbObject(a){var b=a;b.createBrain=function(d,c){b.model_data=d;if(d.num_hemispheres==2){var f={left:b.createHemisphere(d.left,"left"),right:b.createHemisphere(d.right,"right"),num_hemisphere:2}}else{var f=b.createHemisphere(d,"filename");f.num_hemisphere=1}if(b.brainTransform==null){b.brainTransform=b.pack.createObject("Transform");if(d.num_hemispheres==2){b.brainHemisphereTransforms={};b.brainHemisphereTransforms.left=b.pack.createObject("Transform");b.brainHemisphereTransforms.right=b.pack.createObject("Transform")}}else{b.brainTransform.removeShape(b.brainTransform.shapes[0]);if(b.brainTransform.children[0]!=null){b.brainTransform.children[0].removeShape(b.brainTransform.children[0].shapes[0])}if(b.brainTransform.children[1]!=null){b.brainTransform.children[1].removeShape(b.brainTransform.children[1].shapes[0])}}if(d.num_hemispheres!=2){b.brainTransform.removeParam(b.brainTransform.children[0]);b.brainTransform.removeParam(b.brainTransform.children[1])}if(d.num_hemispheres==2&&b.brainHemisphereTransforms==null){b.brainHemisphereTransforms={};b.brainHemisphereTransforms.left=b.pack.createObject("Transform");b.brainHemisphereTransforms.right=b.pack.createObject("Transform")}b.brainTransform.parent=b.client.root;if(f.num_hemisphere==1){b.brainTransform.addShape(f);f.createDrawElements(b.pack,null)}else{b.brainHemisphereTransforms.left.parent=b.brainTransform;b.brainHemisphereTransforms.right.parent=b.brainTransform;b.brainHemisphereTransforms.left.addShape(f.left);b.brainHemisphereTransforms.right.addShape(f.right);f.left.createDrawElements(b.pack,null);f.right.createDrawElements(b.pack,null)}b.model_data=d;if(b.afterCreateBrain!=undefined){b.afterCreateBrain(b.model_data)}};b.createLineObject=function(g,f,j){b.model_data=g;var c=b.createMaterial("/shaders/line.txt");var h=c.getParam("transAlpha");h.value=1;if(j){console.log("mesh")}var d=b.createLineShape(c,g,f,j);d.name=f;if(b.brainTransform==undefined){b.brainTransform=b.pack.createObject("Transform")}b.brainTransform.parent=b.client.root;b.brainTransform.addShape(d);d.createDrawElements(b.pack,null);b.model_data=g;if(b.afterCreate!=undefined){b.afterCreate(b.model_data)}};b.createPolygonObject=function(g,f){b.model_data=g;var c=b.createMaterial("/shaders/blinnphong.txt");c=b.blinnphongParams(c);if(b.brainTransform==undefined){b.brainTransform=b.pack.createObject("Transform")}b.brainTransform.parent=b.client.root;if(g.shapes){console.log("multi_shape");console.log(g);for(var h=0;h<g.shapes.length;h++){console.log(g.shapes[h]);var d=b.createPolygonShape(c,g.shapes[h]);d.name=g.shapes[h].name;b.brainTransform.addShape(d);d.createDrawElements(b.pack,null)}}else{var d=b.createPolygonShape(c,g);d.name=f;b.brainTransform.addShape(d);d.createDrawElements(b.pack,null)}b.model_data=g;if(b.afterCreate!=undefined){b.afterCreate(b.model_data)}};b.createHemisphere=function(j,f){var k=b.createMaterial("/shaders/blinnphong.txt");k=b.blinnphongParams(k);var s=b.pack.createObject("Shape");var p=b.pack.createObject("Primitive");var u=b.pack.createObject("StreamBank");p.material=k;p.owner=s;p.streamBank=u;s.name=f;p.primitiveType=b.o3d.Primitive.TRIANGLELIST;var d=b.pack.createObject("State");b.enableAlphaBlending(d);p.material.state=d;var m=b.pack.createObject("VertexBuffer");var o=m.createField("FloatField",3);if(!j.positionArray){alert("PositionArray nil");return false}m.set(j.positionArray);b.numberVertices=j.numberVertices;var t=(j.positionArray.length/3);p.numberVertices=b.numberVertices;if(!j.indexArray){alert("Index Array nil");return false}p.numberPrimitives=j.indexArray.length/3;var h=b.pack.createObject("IndexBuffer");h.set(j.indexArray);p.indexBuffer=h;var r=b.pack.createObject("VertexBuffer");var l=r.createField("FloatField",3);r.set(j.normalArray);var n=[];if(j.colorArray.length==4){for(var g=0;g<t;g++){n.push.apply(n,j.colorArray)}}else{n=j.colorArray}if(n.length<j.positionArray.length){alert("Problem with the colors: "+n.length)}var q=b.pack.createObject("VertexBuffer");var c=q.createField("FloatField",4);q.set(n);n=[];if(b.loading){jQuery(b.loading).html("Buffers Loaded")}u.setVertexStream(b.o3d.Stream.POSITION,0,o,0);u.setVertexStream(b.o3d.Stream.NORMAL,0,l,0);u.setVertexStream(b.o3d.Stream.COLOR,0,c,0);return s};b.createLineShape=function(p,h,z,c){var o=b.pack.createObject("Shape");var y=b.pack.createObject("StreamBank");o.name=z;if(!h.positionArray){alert("PositionArray nil");return false}b.numberVertices=h.numberVertices;var v=b.pack.createObject("Primitive");v.material=p;v.owner=o;v.streamBank=y;v.primitiveType=b.o3d.Primitive.LINELIST;var m=b.pack.createObject("State");b.enableAlphaBlending(m);v.material.state=m;var f=new Array();for(var u=0;u<h.nitems;u++){if(u==0){var l=0}else{var l=h.endIndicesArray[u-1]}f.push(h.indexArray[l]);for(var s=l+1;s<h.endIndicesArray[u]-1;s++){f.push(h.indexArray[s]);f.push(h.indexArray[s])}f.push(h.indexArray[h.endIndicesArray[u]-1])}if(!c){var g=b.pack.createObject("IndexBuffer");v.numberPrimitives=f.length/2;v.numberVertices=f.length;b.indexArray=f;var d=new Float32Array(f.length*3);for(var t=0;t<f.length;t++){d[t*3]=h.positionArray[f[t]*3];d[t*3+1]=h.positionArray[f[t]*3+1];d[t*3+2]=h.positionArray[f[t]*3+2]}var n=[];if(h.colorArray.length==4){for(var u=0;u<numberVertices;u++){n.push.apply(n,[0.5,0.5,0.7,1])}}else{n=new Float32Array(f.length*4);for(var t=0;t<f.length;t++){n[t*4]=h.colorArray[f[t]*4];n[t*4+1]=h.colorArray[f[t]*4+1];n[t*4+2]=h.colorArray[f[t]*4+2];n[t*4+3]=h.colorArray[f[t]*4+3]}}}else{console.log("mesh shape");v.numberVertices=h.meshPostionArray.length/3;v.numberPrimitives=v.numberVertices/2;var d=h.meshPositionArray;var n=h.meshColorArray}var w=b.pack.createObject("VertexBuffer");var q=w.createField("FloatField",3);w.set(d);y.setVertexStream(b.o3d.Stream.POSITION,0,q,0);if(n.length/4<d.length/3){alert("Problem with the colors: "+n.length)}var r=b.pack.createObject("VertexBuffer");var x=r.createField("FloatField",4);r.set(n);y.setVertexStream(b.o3d.Stream.COLOR,0,x,0);if(b.loading){jQuery(b.loading).html("Buffers Loaded")}b.pack.gl.lineWidth(1);return o};b.createPolygonShape=function(p,g,G){var D=b.pack.createObject("Shape");var F=b.pack.createObject("StreamBank");D.name=G;if(!g.positionArray){alert("PositionArray nil");return false}b.numberVertices=g.numberVertices;var d=b.pack.createObject("Primitive");d.material=p;d.owner=D;d.streamBank=F;d.primitiveType=b.o3d.Primitive.TRIANGLELIST;var h=b.pack.createObject("State");b.enableAlphaBlending(h);d.material.state=h;if(g.nonindexed==undefined){var f=g.indexArray;d.numberPrimitives=f.length/3;d.numberVertices=f.length;b.indexArray=f;var c=new Float32Array(f.length*3);var B=new Array(f.length*3);var q=new Array(f.length*4);var A=new Float32Array(f.length*3);var n=f.length;for(var x=0;x<n;x++){c[x*3]=g.positionArray[f[x]*3];c[x*3+1]=g.positionArray[f[x]*3+1];c[x*3+2]=g.positionArray[f[x]*3+2];A[x*3]=g.normalArray[f[x]*3];A[x*3+1]=g.normalArray[f[x]*3+1];A[x*3+2]=g.normalArray[f[x]*3+2]}for(var w=0;w<n;w+=3){var z=[];z[0]=[g.positionArray[f[w]*3],g.positionArray[f[w]*3+1],g.positionArray[f[w]*3+2]];z[1]=[g.positionArray[f[w+1]*3],g.positionArray[f[w+1]*3+1],g.positionArray[f[w+1]*3+2]];z[2]=[g.positionArray[f[w+2]*3],g.positionArray[f[w+2]*3+1],g.positionArray[f[w+2]*3+2]];B.push.apply(B,z[0]);B.push.apply(B,z[1]);B.push.apply(B,z[1]);B.push.apply(B,z[2]);B.push.apply(B,z[2]);B.push.apply(B,z[0])}D.meshPositionArray=B}else{d.numberPrimitives=g.positionArray.length/3/3;d.numberVertices=g.positionArray.length/3;var c=new Float32Array(g.positionArray);var A=new Float32Array(g.normalArray);console.log(g)}var m=[];if(g.colorArray.length==4){for(var y=0;y<d.numberVertices;y++){m.push.apply(m,g.colorArray)}}else{m=new Float32Array(f.length*4);var n=f.length;for(var x=0;x<n;x++){m[x*4]=m[x*4+1]=g.colorArray[f[x]*4+1];m[x*4+2]=g.colorArray[f[x]*4+2];m[x*4+3]=g.colorArray[f[x]*4+3]}for(var u=0;u<indexArrayLenght;u+=3){var v=[];v[0]=[g.colorArray[f[x]*4],g.colorArray[f[x]*4+1],g.colorArray[f[x]*4+2],g.colorArray[f[x]*4+3]];v[1]=[g.colorArray[f[x+1]*4],g.colorArray[f[x+1]*4+1],g.colorArray[f[x+1]*4+2],g.colorArray[f[x+1]*4+3]];v[2]=[g.colorArray[f[x+2]*4],g.colorArray[f[x+2]*4+1],g.colorArray[f[x+2]*4+2],g.colorArray[f[x+2]*4+3]];q.push.apply(q,v[0]);q.push.apply(q,v[1]);q.push.apply(q,v[1]);q.push.apply(q,v[2]);q.push.apply(q,v[2]);q.push.apply(q,v[0])}}g.meshPositionArray=B;g.meshColorArray=q;var o=b.pack.createObject("VertexBuffer");var s=o.createField("FloatField",3);o.set(A);F.setVertexStream(b.o3d.Stream.NORMAL,0,s,0);var C=b.pack.createObject("VertexBuffer");var r=C.createField("FloatField",3);C.set(c);F.setVertexStream(b.o3d.Stream.POSITION,0,r,0);if(m.length<g.positionArray.length){alert("Problem with the colors: "+m.length)}var t=b.pack.createObject("VertexBuffer");var E=t.createField("FloatField",4);t.set(m);m=[];F.setVertexStream(b.o3d.Stream.COLOR,0,E,0);if(b.loading){jQuery(b.loading).html("Buffers Loaded")}return D}}function BrainBrowser(){var h=this;bbObject(this);var k=new ColorManager();var f;var v;var y;var x;var z;var n=new THREE.Object3D();var j;var w;var c;var A;this.start=function(){window.onload=function(){setTimeout(function(){h.init()},1)}};this.init=function(){z=new THREE.Scene();f=$("#view-window");y=new THREE.PerspectiveCamera(30,f.width()/f.height(),0.1,5000);if(g()){v=new THREE.WebGLRenderer({clearColor:8947848,clearAlpha:1,preserveDrawingBuffer:true})}else{f.html(o());return}v.setSize(f.width(),f.height());f.append(v.domElement);y.position.z=500;x=new THREE.PointLight(16777215);x.position.x=0;x.position.y=0;x.position.z=500;z.add(x);j=new THREE.TrackballControls(y,f[0]);w=new THREE.TrackballControls(x,f[0]);j.zoomSpeed=2;w.zoomSpeed=2;function F(G){requestAnimationFrame(F);A=c||G;c=G;j.update();w.update();h.renderCallback(G)}if(h.afterInit){h.afterInit(h)}window.onresize();F()};
/*! 
   * WebGL test taken from Detector.js by
   * alteredq / http://alteredqualia.com/
   * mr.doob / http://mrdoob.com/
  */
function g(){try{return !!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(F){return false}}function o(){var G='BrainBrowser requires <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>.<br/>';G+=window.WebGLRenderingContext?"Your browser seems to support it, but it is <br/> disabled or unavailable.<br/>":"Your browser does not seem to support it.<br/>";G+='Test your browser\'s WebGL support <a href="http://get.webgl.org/">here</a>.';var F=$('<div id="webgl-error">'+G+"</div>");return F}this.setCamera=function(F,H,G){y.position.set(F,H,G)};this.getModel=function(){return n};function l(H,I){h.model_data=H;var G=r(H.left);G.name="left";G.model_num=0;var F=r(H.right);F.name="right";F.model_num=1;n.add(G);n.add(F);z.add(n)}function r(I){var N=I.positionArray;var H=I.indexArray;var M={};var G={};for(var J=0;J+2<N.length;J+=3){s(M,N[J],N[J+1],N[J+2])}G.x=M.minX+0.5*(M.maxX-M.minX);G.y=M.minY+0.5*(M.maxY-M.minY);G.z=M.minY+0.5*(M.maxZ-M.minZ);var L=new THREE.Geometry();for(var J=0;J+2<N.length;J+=3){L.vertices.push(new THREE.Vector3(N[J]-G.x,N[J+1]-G.y,N[J+2]-G.z))}for(var J=0;J+2<H.length;J+=3){L.faces.push(new THREE.Face3(H[J],H[J+1],H[J+2]))}L.computeFaceNormals();L.computeVertexNormals();var K=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:526344,vertexColors:THREE.VertexColors});var F=new THREE.Mesh(L,K);F.centroid=G;F.position.set(G.x,G.y,G.z);return F}function u(H,F,J,I){var G=q(H,J);G.name=F;if(I){G.renderDepth=I}n.add(G);z.add(n)}function q(M,V){h.model_data=M;var U=[];var S=[];var F=[];var Q={};var H={};for(var N=0;N<h.model_data.nitems;N++){if(N==0){var G=0}else{var G=h.model_data.endIndicesArray[N-1]}U.push(h.model_data.indexArray[G]);for(var K=G+1;K<h.model_data.endIndicesArray[N]-1;K++){U.push(h.model_data.indexArray[K]);U.push(h.model_data.indexArray[K])}U.push(h.model_data.indexArray[h.model_data.endIndicesArray[N]-1])}var R=h.model_data.positionArray;for(var L=0;L<U.length;L++){s(Q,R[U[L]*3],R[U[L]*3+1],R[U[L]*3+2])}H.x=Q.minX+0.5*(Q.maxX-Q.minX);H.y=Q.minY+0.5*(Q.maxY-Q.minY);H.z=Q.minY+0.5*(Q.maxZ-Q.minZ);if(!V){for(var L=0;L<U.length;L++){S.push(new THREE.Vector3(R[U[L]*3]-H.x,R[U[L]*3+1]-H.y,R[U[L]*3+2]-H.z))}var T=[];if(h.model_data.colorArray.length==4){for(var N=0;N<numberVertices;N++){T.push.apply(T,[0.5,0.5,0.7,1])}}else{var T=h.model_data.colorArray;for(var L=0;L<U.length;L++){var I=new THREE.Color();I.setRGB(T[U[L]*4],T[U[L]*4+1],T[U[L]*4+2]);F.push(I)}}}else{S=h.model_data.meshPositionArray;F=h.model_data.meshColorArray}var P=new THREE.Geometry();P.vertices=S;P.colors=F;P.colorsNeedUpdate=true;var O=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});var J=new THREE.Line(P,O,THREE.LinePieces);J.position.set(H.x,H.y,H.z);J.centroid=H;return J}function C(I,G,J){h.model_data=I;if(h.model_data.shapes){for(var H=0;H<h.model_data.shapes.length;H++){var F=m(h.model_data.shapes[H]);F.name=h.model_data.shapes[H].name;n.add(F)}}else{var F=m(h.model_data);F.name=G;n.add(F)}if(h.afterCreate!=undefined){h.afterCreate(h.model_data)}z.add(n)}function m(Q){var L=Q.positionArray;var R=Q.indexArray;var S=[];if(Q.colorArray.length==4){for(var K=0;K<L.length/3;K++){S.push(Q.colorArray[0]);S.push(Q.colorArray[1]);S.push(Q.colorArray[2])}}else{S=[];var I=R.length;for(var J=0;J+2<Q.colorArray.length;J+=4){S.push(Q.colorArray[J]);S.push(Q.colorArray[J+1]);S.push(Q.colorArray[J+2])}}var F=[];var H;var O=new THREE.Geometry();for(var K=0;K+2<L.length;K+=3){O.vertices.push(new THREE.Vector3(L[K],L[K+1],L[K+2]));H=new THREE.Color();H.setRGB(S[K],S[K+1],S[K+2]);F.push(H)}if(Q.faces&&Q.faces.length>0){var G=Q.faces;for(var K=0;K<G.length;K++){if(G[K].length<3){continue}if(G[K].length<=4){if(G[K].length<=3){var N=new THREE.Face3(G[K][0],G[K][1],G[K][2])}else{if(G[K].length==4){var N=new THREE.Face4(G[K][0],G[K][1],G[K][2],G[K][3])}}N.vertexColors[0]=F[N.a];N.vertexColors[1]=F[N.b];N.vertexColors[2]=F[N.c];if(G[K].length>3){N.vertexColors[3]=F[N.d]}O.faces.push(N)}else{for(var J=1;J+1<G[K].length;J++){var N=new THREE.Face3(G[K][0],G[K][J],G[K][J+1]);N.vertexColors[0]=F[N.a];N.vertexColors[1]=F[N.b];N.vertexColors[2]=F[N.c];O.faces.push(N)}}}}else{for(var K=0;K+2<R.length;K+=3){var N=new THREE.Face3(R[K],R[K+1],R[K+2]);N.vertexColors[0]=F[N.a];N.vertexColors[1]=F[N.b];N.vertexColors[2]=F[N.c];O.faces.push(N)}}O.computeFaceNormals();O.computeVertexNormals();O.colorsNeedUpdate=true;var M=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:526344,vertexColors:THREE.VertexColors});var P=new THREE.Mesh(O,M);if(h.loading){jQuery(h.loading).html("Buffers Loaded")}return P}this.uninit=function(){if(this.client){this.client.cleanup()}};this.renderCallback=function(){var G=c-A;var F=G*0.00015;if(h.autoRotate){if(h.autoRotate.x){n.rotation.x+=F}if(h.autoRotate.y){n.rotation.y+=F}if(h.autoRotate.z){n.rotation.z+=F}}v.render(z,y)};this.clearScreen=function(){if(n){z.remove(n)}h.resetView();n=new THREE.Object3D();if(h.afterClearScreen!=undefined){h.afterClearScreen()}};this.displayObjectFile=function(J,G,I){var H=I||{};var K=H.renderDepth;if(J.objectClass=="P"&&J.numberVertices==81924){l(J,K)}else{if(J.objectClass=="P"){C(J,G,K)}else{if(J.objectClass=="L"){u(J,G,false,K)}else{alert("Object file not supported")}}}if(h.afterDisplayObject!=undefined){h.afterDisplayObject(n)}var H=I||{};var F=H.afterDisplay;if(F){F()}};function d(H,F,G){if(G==null){G=h.model_data.data}if(G.fixRange==false||G.fixRange==null){G.rangeMin=H;G.rangeMax=F}}this.updateClearColor=function(F){v.setClearColor(new THREE.Color(F))};this.updateClearColorFromName=function(F){if(F=="white"){h.updateClearColor(16777215)}else{if(F=="black"){h.updateClearColor(0)}else{if(F=="pink"){h.updateClearColor(16711935)}else{h.updateClearColor(8947848)}}}};this.resetView=function(){j.reset();w.reset();n.position.set(0,0,0);n.rotation.set(0,0,0);for(var F=0;F<n.children.length;F++){var G=n.children[F];G.visible=true;if(G.centroid){G.position.set(G.centroid.x,G.centroid.y,G.centroid.z)}else{G.position.set(0,0,0)}G.rotation.set(0,0,0)}};this.setupView=function(F){h.resetView();if(h.model_data&&h.model_data.num_hemispheres==2){var G=h.getViewParams();switch(G.view){case"superior":h.superiorView();break;case"medial":h.medialView();break;case"anterior":h.anteriorView();break;case"inferior":h.inferiorView();break;case"lateral":h.lateralView();break;case"posterior":h.posteriorView();break;default:h.superiorView();break}}if(n.getChildByName("left")){if(G.left==true){h.leftHemisphereVisible(true)}else{h.leftHemisphereVisible(false)}}if(n.getChildByName("right")){if(G.right==true){h.rightHemisphereVisible(true)}else{h.rightHemisphereVisible(false)}}};function a(F){return F*Math.PI/180}this.leftHemisphereVisible=function(F){n.getChildByName("left").visible=F};this.rightHemisphereVisible=function(F){n.getChildByName("right").visible=F};this.medialView=function(F){if(h.model_data.num_hemispheres==2){n.getChildByName("left").position.x-=100;n.getChildByName("left").rotation.z-=a(90);n.getChildByName("right").position.x+=100;n.getChildByName("right").rotation.z+=a(90);n.rotation.x+=a(-90)}};this.lateralView=function(F){if(h.model_data.num_hemispheres==2){n.getChildByName("left").position.x-=100;n.getChildByName("left").rotation.z+=a(-90);n.getChildByName("right").position.x+=100;n.getChildByName("right").rotation.z+=a(90);n.rotation.x+=a(90);n.rotation.y+=a(180)}};this.superiorView=function(){};this.inferiorView=function(){n.rotation.y+=a(180)};this.anteriorView=function(F){h.resetView();n.rotation.x+=a(-90);n.rotation.z+=a(180)};this.posteriorView=function(F){h.resetView();n.rotation.x+=a(-90)};this.separateHemispheres=function(F){if(h.model_data.num_hemispheres==2){n.children[0].position.x-=1;n.children[1].position.x+=1}};this.ZoomInOut=function(F){y.fov*=F;y.updateProjectionMatrix()};h.scrollMe=function(G){var F=(G.deltaY<0)?1/h.zoomFactor:h.zoomFactor;h.ZoomInOut(F);h.client.render()};function t(F){B();if(F){h.selectedInfo=F}}function B(){if(h.selectedInfo){h.highlightShape=null;h.selectedInfo=null}}this.click=function(K,H){var I=f.offset();mouseX=((K.clientX-I.left)/f.width())*2-1;mouseY=-((K.clientY-I.top)/f.height())*2+1;var M=new THREE.Projector();var L=new THREE.Raycaster();B();var G=new THREE.Vector3(mouseX,mouseY,1);M.unprojectVector(G,y);L.set(y.position,G.sub(y.position).normalize());var J=L.intersectObject(n,true);if(J.length>0){var F=J[0];var N={vertex:F.face.a,point:new THREE.Vector3(F.point.x,F.point.y,F.point.z),object:F.object};return H(K,N)}else{jQuery(h.pickInfoElem).html("--nothing--");return false}};this.getInfoForVertex=function(G){var F=h.model_data.getVertexInfo(G);var H={vertex:F.vertex,point:new THREE.Vector3(F.position_vector[0],F.position_vector[1],F.position_vector[2])};return H};this.keyPressedCallback=function(G){var F=false;switch(G.which){case 38:h.ZoomInOut(1.1);F="ZoomIn";break;case 40:h.ZoomInOut(1/1.1);F="ZoomOut";break;case 32:h.separateHemispheres();F="Seperate";break}if(F){return false}else{return true}};function s(H,F,I,G){if(!H.minX||H.minX>F){H.minX=F}if(!H.maxX||H.maxX<F){H.maxX=F}if(!H.minY||H.minY>I){H.minY=I}if(!H.maxY||H.maxY<I){H.maxY=I}if(!H.minZ||H.minZ>G){H.minZ=G}if(!H.maxZ||H.maxZ<G){H.maxZ=G}}function p(F,K,J){var I=new THREE.SphereGeometry(2);var H=new THREE.MeshBasicMaterial({color:16711680});var G=new THREE.Mesh(I,H);G.position.set(F,K,J);z.add(G)}this.set_fill_mode_wireframe=function(){var G=n.children;for(var F=0;F<G.length;F++){G[F].material.wireframe=true}};this.set_fill_mode_solid=function(){var G=n.children;for(var F=0;F<G.length;F++){G[F].material.wireframe=false}};function E(F,G){jQuery.ajax({type:"GET",url:F,dataType:"text",success:function(H){G(H)},error:function(H,J,I){alert("Failure in loadFromURL: "+J)},data:{},timeout:100000})}function b(I,H){var F=new FileReader();var G=I.files;F.file=G[0];F.onloadend=function(J){H(J.target.result)};F.readAsText(G[0])}this.loadObjFromUrl=function(G,I){var F=I||{};var H=F.beforeLoad;if(H){H()}E(G,function(K){var L=G.split("/");var J=L[L.length-1];h.displayObjectFile(new MNIObject(K),J,F)})};this.loadWavefrontObjFromUrl=function(G,I){var F=I||{};var H=F.beforeLoad;if(H){H()}E(G,function(K){var L=G.split("/");var J=L[L.length-1];h.displayObjectFile(new WavefrontObj(K),J,F)})};this.loadObjFromFile=function(I,H){var F=H||{};var G=F.beforeLoad;if(G){G()}b(I,function(J){var M=I.value.split("\\");var K=M[M.length-1];var L;if(F.format=="wavefront"){L=new WavefrontObj(J)}else{L=new MNIObject(J)}h.displayObjectFile(L,K,F)})};this.loadSpectrumFromUrl=function(F){E(F,function(H){var G=new Spectrum(H);h.spectrum=G;if(h.afterLoadSpectrum!=null){h.afterLoadSpectrum(G)}if(h.model_data.data){h.updateColors(h.model_data.data,h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.spectrum,h.flip,h.clamped)}})};this.loadSpectrumFromFile=function(F){b(F,function(H){var G=new Spectrum(H);h.spectrum=G;if(h.afterLoadSpectrum!=null){h.afterLoadSpectrum(G)}if(h.model_data.data){h.updateColors(h.model_data.data,h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.spectrum,h.flip,h.clamped)}})};function D(F){}this.loadDataFromFile=function(L){var F=L.files[0].name;var J=function(N){var M=new Data(N);M.fileName=F;if(M.values.length<h.model_data.positionArray.length/4){alert("Number of numbers in datafile lower than number of vertices Vertices"+h.model_data.positionArray.length/3+" data values:"+M.values.length);return -1}else{h.model_data.data=M}d(h.model_data.data.min,h.model_data.data.max);if(h.afterLoadData!=null){h.afterLoadData(h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.model_data.data)}h.updateColors(h.model_data.data,h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.spectrum,h.flip,h.clamped);return null};if(F.match(/.*.mnc|.*.nii/)){var K=new XMLHttpRequest();if(F.match(/.*.mnc/)){K.open("POST","/minc/volume_object_evaluate",false)}else{K.open("POST","/nii/volume_object_evaluate",false)}var H=document.getElementById("datafile-form");var I=new FormData(H);K.send(I);var G=K.response;J(G)}else{b(L,J)}};this.loadSeriesDataFromFile=function(K){console.log(K.files.length);var J=K.files.length;h.seriesData=new Array(J);h.seriesData.numberFiles=J;var H=K.files;for(var G=0;G<J;G++){var F=new FileReader();F.file=H[G];var I=F.onloadend=(function(M,L){return function(N){console.log(N.target.result.length);console.log(L);h.seriesData[L]=new Data(N.target.result);h.seriesData[L].fileName=M.name}})(F.file,G);F.readAsText(H[G])}h.setupSeries()};this.setupSeries=function(){$('<div id="series">Series: </div>').appendTo("#surface_choice");var F=$("#series");$('<span id="series-value">0</span>').appendTo(F);$('<div id="series-slider" width="100px" + height="10"></div>').slider({value:0,min:0,max:h.seriesData.numberFiles-1,step:0.1,slide:function(G,H){if(H.value-Math.floor(H.value)<0.01){h.model_data.data=h.seriesData[H.value]}else{if(h.seriesData[0].fileName.match("pval.*")){h.model_data.data=new Data(interpolateDataArray(h.seriesData[Math.floor(H.value)],h.seriesData[Math.floor(H.value)+1],(H.value-Math.floor(H.value)),true))}else{h.model_data.data=new Data(interpolateDataArray(h.seriesData[Math.floor(H.value)],h.seriesData[Math.floor(H.value)+1],(H.value-Math.floor(H.value))))}}if(h.seriesData[0].fileName.match("mt.*")){$("#age_series").html("Age: "+(H.value*3+5).toFixed(1))}else{if(h.seriesData[0].fileName.match("pval.*")){$("#age_series").html("Age: "+(H.value*1+10))}}$(F).children("#series-value").html(H.value);if(h.model_data.data.values.length<h.model_data.positionArray.length/4){console.log("Number of numbers in datafile lower than number of vertices Vertices"+h.model_data.positionArray.length/3+" data values:"+h.model_data.data.values.length);return -1}d(h.model_data.data.min,h.model_data.data.max);if(h.afterLoadData!=null){h.afterLoadData(h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.model_data.data)}h.updateColors(h.model_data.data,h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.spectrum,h.flip,h.clamped);return null}}).appendTo(F)};this.loadBlendDataFromFile=function(K){var J=K.files.length;h.blendData=new Array(J);h.blendData.numberFiles=J;var H=K.files;for(var G=0;G<J;G++){var F=new FileReader();F.file=H[G];var I=F.onloadend=(function(M,L){return function(O){h.blendData[L]=new Data(O.target.result);h.blendData.alpha=1/J;h.blendData[L].fileName=M.name;for(var N=0;N<2;N++){if(h.blendData[N]==undefined){console.log("not done yet");return}}d(h.blendData[0].values.min(),h.blendData[0].values.max(),h.blendData[0]);d(h.blendData[1].values.min(),h.blendData[1].values.max(),h.blendData[1]);if(h.afterLoadData!=null){h.afterLoadData(null,null,h.blendData,true)}h.blend($(".blend_slider").slider("value"))}})(F.file,G);F.readAsText(H[G])}h.setupBlendColors()};this.setupBlendColors=function(){console.log("Blend colors has ran "+h.blendData.numberFiles);$("#blend").remove();$('<div id="blend">Blend ratios: </div>').appendTo("#surface_choice");var F=$("#blend");$('<span id="blend_value'+i+'">0</span>').appendTo(F);$('<div class="blend_slider" id="blend_slider'+i+'" width="100px" + height="10"></div>').slider({value:0,min:0.1,max:0.99,value:0.5,step:0.01,slide:function(G,H){h.blend($(this).slider("value"))}}).appendTo(F)};this.blend=function(G){h.blendData[0].alpha=G;h.blendData[1].alpha=1-G;for(var F=2;F<h.blendData.length;F++){h.blendData[F].alpha=0}h.updateColors(h.blendData,null,null,h.spectrum,h.flip,h.clamped,true)};this.loadDataFromUrl=function(G,F){E(G,function(I,H){h.model_data.data=new Data(I);h.model_data.data.fileName=F;d(h.model_data.data.min,h.model_data.data.max);if(h.afterLoadData!=undefined){h.afterLoadData(h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.model_data.data)}h.updateColors(h.model_data.data,h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.spectrum)})};this.loadCombinedShaderFromUrl=function(F){var G;E(F,function(H){G=H});return G};this.updateColors=function(ab,R,V,Z,L,Q,U,G){h.clamped=Q;if(U){var aa=k.blendColorMap(Z,ab,0,1)}else{var aa=ab.createColorArray(R,V,Z,L,Q,h.model_data.colorArray,h.model_data)}if(h.model_data.num_hemispheres==2){var F=aa.slice(0,aa.length/2);var P=aa.slice(aa.length/2,aa.length);var N=[];var X=[];for(var W=0;W+2<aa.length;W+=4){var K=new THREE.Color();K.setRGB(F[W],F[W+1],F[W+2]);N.push(K);K=new THREE.Color();K.setRGB(P[W],P[W+1],P[W+2]);X.push(K)}var S=n.getChildByName("left");var Y=S.geometry.faces;for(var W=0;W<Y.length;W++){var M=Y[W];M.vertexColors[0]=N[M.a];M.vertexColors[1]=N[M.b];M.vertexColors[2]=N[M.c];if(M.d){M.vertexColors[3]=N[M.d]}}S.geometry.colorsNeedUpdate=true;var H=n.getChildByName("right");var I=H.geometry.faces;for(var W=0;W<I.length;W++){var M=I[W];M.vertexColors[0]=X[M.a];M.vertexColors[1]=X[M.b];M.vertexColors[2]=X[M.c];if(M.d){M.vertexColors[3]=X[M.d]}}H.geometry.colorsNeedUpdate=true}else{var O=[];for(var W=0;W+2<aa.length;W+=4){var K=new THREE.Color();K.setRGB(aa[W],aa[W+1],aa[W+2]);O.push(K)}var J=h.brain.children;for(var W=0;W<J.length;W++){for(var T=0;T<J[W].faces.length;T++){var M=J[W].faces[T];M.vertexColors[0]=O[M.a];M.vertexColors[1]=O[M.b];M.vertexColors[2]=O[M.c];if(M.d){M.vertexColors[3]=O[M.d]}}J[W].geometry.colorsNeedUpdate=true}}if(h.afterUpdateColors!=null){h.afterUpdateColors(ab,R,V,Z)}return 1};this.rangeChange=function(G,F,H){h.model_data.data.rangeMin=G;h.model_data.data.rangeMax=F;h.updateColors(h.model_data.data,h.model_data.data.rangeMin,h.model_data.data.rangeMax,h.spectrum,h.flip,H);if(h.afterRangeChange!=null){h.afterRangeChange(G,F)}};this.changeShapeTransparency=function(G,H){var F=n.getChildByName(G);if(F){F.material.opacity=H;if(H==1){F.material.transparent=false}else{F.material.transparent=true}}};this.getImageUrl=function(){var I=document.createElement("canvas");var F=document.getElementById("spectrum_canvas");I.width=f.width();I.height=f.height();var J=I.getContext("2d");var G=new Image();function H(){var K=new Image();K.onload=function(){J.drawImage(K,0,0);window.open(I.toDataURL(),"screenshot")};K.src=F.toDataURL()}G.onload=function(){J.drawImage(G,0,0);if(F){H()}else{window.open(I.toDataURL(),"screenshot")}};G.src=v.domElement.toDataURL()};window.onresize=function(){f=$("#view-window");v.setSize(f.width(),f.height());y.aspect=f.width()/f.height();y.updateProjectionMatrix()};h.start()}var brainbrowser;function SurfView(a){var b=this;brainbrowser=new BrainBrowser();this.brainbrowser=brainbrowser;brainbrowser.getViewParams=function(){return{view:jQuery("[name=hem_view]:checked").val(),left:jQuery("#left_hem_visible").attr("checked"),right:jQuery("#right_hem_visible").attr("checked")}};brainbrowser.afterLoadSpectrum=function(c){var d=c.createSpectrumCanvasWithScale(0,100,null);d.id="spectrum_canvas";var f=document.getElementById("color_bar");if(!f){jQuery('<div id="color_bar"></div>').html(d).appendTo("#data-range")}else{jQuery(f).html(d)}brainbrowser.spectrumObj=c};brainbrowser.afterDisplayObject=function(d){$("#shapes").html("");if(d.children.length>0){for(var f=0;f<d.children.length;f++){var c=d.children[f];$('<div id="shape_'+f+'" data-shape-name="'+c.name+'" class="shape"><h4>Shape '+(f+1)+"</h4>Name: "+c.name+'<br />Opacity: <div class="opacity-slider slider"  data-shape-name='+c.name+"></div></div>").appendTo("#shapes")}}brainbrowser.afterClearScreen=function(){$("#shapes").html("")};$(".opacity-slider").slider({value:100,min:-1,max:101,slide:function(g,j){var h=$(g.target).attr("data-shape-name");var k=$(g.target).slider("value");k=Math.min(100,Math.max(0,k))/100;brainbrowser.changeShapeTransparency(h,k)}})};jQuery("#resetview").click(brainbrowser.setupView);jQuery(".view_button").change(brainbrowser.setupView);jQuery("[name=hem_view]").change(brainbrowser.setupView);this.updateCoordinates=function(c,f,d){jQuery("#x-coord").val(c[0]);jQuery("#y-coord").val(c[1]);jQuery("#z-coord").val(c[2]);jQuery("#v-coord").val(f);jQuery("#value-coord").val(d)};brainbrowser.afterInit=function(f){f.clamped=true;f.flip=false;f.clearScreen();if(typeof a=="string"&&a!=""){f.loadObjFromUrl(a)}else{if(typeof a=="function"){console.log("loading models");a(f)}}jQuery("body").keydown(f.keyPressedCallback);jQuery("#range-slider").slider({range:true,min:-50,max:50,value:[-10,10],slide:function(j,k){var h=parseFloat(k.values[0]);var g=parseFloat(k.values[1]);f.rangeChange(h,g,$("#clamp_range").attr("checked"))},step:0.1});f.afterRangeChange=function(j,g){jQuery("#data-range-min").val(j);jQuery("#data-range-max").val(g);var h=f.spectrumObj.createSpectrumCanvasWithScale(j,g,null);h.id="spectrum_canvas";jQuery("#color_bar").html(jQuery(h))};function d(m){var g=$("#data-range");$(g).html("");var l='<div id="data_range_multiple"><ul>';if(!m.length){var m=[m]}for(var j=0;j<m.length;j++){l+='<li><a href="#data_file'+j+'">'+m[j].fileName+"</a></li>"}l+="</ul>";for(var h=0;h<m.length;h++){l+='<div id="data_file'+h+'" class="box full_box"><h4>Thresholding</h4>Min: <input class="range-box" id="data-range-min" type="text" name="range_min" size="5" ><br /><div id="range-slider+'+h+'" data-blend-index="'+h+'" class="slider"></div>Max: <input class="range-box" id="data-range-max" type="text" name="range_max" size="5" ><input type="checkbox" class="button" id="fix_range"><label for="fix_range">Fix Range</label><input type="checkbox" class="button" id="clamp_range" checked="true"><label for="clamp_range">Clamp range</label><input type="checkbox" class="button" id="flip_range"><label for="flip_range">Flip Colors</label></div>'}l+="</div>";$(g).html(l);$(g).tabs();$("#data_range").find(".slider").each(function(k,o){$(o).slider({range:true,min:m[0].values.min(),max:m[0].values.max(),values:[m[k].rangeMin,m[k].rangeMax],step:0.1,slide:function(q,r){var p=$(this).attr("data-blend-index");m[0].rangeMin=r.values[0];m[0].rangeMax=r.values[1];f.model_data.data=m[0];f.updateColors(f.model_data.data,f.model_data.data.rangeMin,f.model_data.data.rangeMax,f.spectrum,f.flip,f.clamped,false);f.rangeChange(m[0].rangeMin,m[0].rangeMax,f.clamped)}})});function n(p){var o=$("#data-range-min").val();var k=$("#data-range-max").val();jQuery(p.target).siblings(".slider").slider("values",0,o);jQuery(p.target).siblings(".slider").slider("values",1,k);f.rangeChange(o,k,$(p.target).siblings("#clamp_range").attr("checked"))}jQuery("#data-range-min").change(n);jQuery("#data-range-max").change(n);jQuery("#fix_range").click(function(k,o){f.fixRange=jQuery(e.target).attr("checked")});jQuery("#clamp_range").change(function(p){var o=parseFloat($(p.target).siblings("#data-range-min").val());var k=parseFloat($(p.target).siblings("#data-range-max").val());if($(p.target).attr("checked")==true){f.rangeChange(o,k,true)}else{f.rangeChange(o,k,false)}});jQuery("#flip_range").change(function(k){f.flip=$(k.target).attr("checked");f.updateColors(f.model_data.data,f.model_data.data.rangeMin,f.model_data.data.rangeMax,brainbrowser.spectrum,f.flip,f.clamped)})}f.afterLoadData=function(j,h,k,g){if(g){d(k)}else{d(k);jQuery("#range-slider").slider("values",0,parseFloat(j));jQuery("#range-slider").slider("values",1,parseFloat(h));f.afterRangeChange(j,h)}};jQuery("#meshmode").change(function(g){if(jQuery(g.target).attr("checked")==true){f.set_fill_mode_wireframe()}else{f.set_fill_mode_solid()}});jQuery("#clearshapes").click(function(g){brainbrowser.clearScreen()});jQuery("#openImage").click(function(g){brainbrowser.getImageUrl()});function c(g){if($("#autorotate").attr("checked")){f.autoRotate={};f.autoRotate.x=$("#autorotateX").attr("checked");f.autoRotate.y=$("#autorotateY").attr("checked");f.autoRotate.z=$("#autorotateZ").attr("checked")}else{f.autoRotate=false}}jQuery("#autorotate-controls").children().change(c);jQuery("#autorotate").change(c);jQuery(".range-box").keypress(function(g){if(g.keyCode=="13"){f.rangeChange(parseFloat(jQuery("#data-range-min").val()),parseFloat(jQuery("#data-range-max").val()))}});jQuery("#clearColor").change(function(h){var g=$(h.target).val();f.updateClearColorFromName(g)});$("#examples").click(function(k){var h=$(k.target).attr("data-example-name");switch(h){case"basic":f.clearScreen();f.loadObjFromUrl("/models/surf_reg_model_both.obj",{beforeLoad:function(){$("#loading").show()},afterDisplay:function(){$("#loading").hide()}});break;case"punkdti":f.clearScreen();f.loadObjFromUrl("/models/dti.obj",{renderDepth:999,beforeLoad:function(){$("#loading").show()},afterDisplay:function(){$("#loading").hide()}});f.loadObjFromUrl("/models/left_color.obj");f.loadObjFromUrl("/models/right_color.obj");break;case"realct":f.clearScreen();f.loadObjFromUrl("/models/realct.obj",{beforeLoad:function(){$("#loading").show()},afterDisplay:function(){f.loadDataFromUrl("/models/realct.txt","cortical thickness");$("#loading").hide()}});break;case"car":f.clearScreen();f.loadWavefrontObjFromUrl("/models/car.obj",{beforeLoad:function(){$("#loading").show()},afterDisplay:function(){$("#loading").hide()}});f.setCamera(0,0,100);var l=new THREE.Matrix4();l.makeRotationX(-0.25*Math.PI);var j=new THREE.Matrix4();j.makeRotationY(0.4*Math.PI);f.getModel().applyMatrix(j.multiply(l));break;case"plane":f.clearScreen();f.loadObjFromUrl("/models/dlr_bigger.streamlines.obj");f.loadObjFromUrl("/models/dlr.model.obj",{beforeLoad:function(){$("#loading").show()},afterDisplay:function(){$("#loading").hide()}});f.setCamera(0,0,75);var g=new THREE.Matrix4();var l=new THREE.Matrix4();l.makeRotationX(-0.25*Math.PI);var j=new THREE.Matrix4();j.makeRotationY(0.4*Math.PI);g.multiplyMatrices(j,l);f.getModel().applyMatrix(g)}return false})}};