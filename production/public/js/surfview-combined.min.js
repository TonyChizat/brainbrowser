/*! 
 * Copyright (C) 2011 McGill University
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 *   the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
if(!Array.prototype.min){Array.prototype.min=function(){var b=this[0];var a,c;for(a=1,c=this.length;a<c;a++){if(this[a]<b){b=this[a]}}return b}}if(!Array.prototype.max){Array.prototype.max=function(){var a=this[0];var b,c;for(b=1,c=this.length;b<c;b++){if(this[b]>a){a=this[b]}}return a}}function ColorManager(){this.createColorMap=function(l,a,q,g,n,k,m,f,e){var l=l.colors;var d=l.length;var p=((n-g)+(n-g)/d)/d;var h,j;var r;var o;var b;var c=[];for(h=0,j=q.length;h<j;h++){o=q[h];if(o<=g){r=0}else{if(q[h]>n){r=d-1}else{r=parseInt((o-g)/p)}}if(k){b=255}else{b=1}c=l[r]||[0,0,0];a[h*4+0]=b*c[0]*f+m*b;a[h*4+1]=b*c[1]*f+m*b;a[h*4+2]=b*c[2]*f+m*b;if(e){a[h*4+3]=b*e}else{a[h*4+3]=b}}return a};this.blendColors=function(h){var a=h[0];var f,d,e,c;var b,g;for(f=0,e=h[0].length/4;f<e;f++){for(d=1,c=h.length;d<c;d++){b=a[f*4+3];g=h[d][f*4+3];a[f*4]=a[f*4]*b+h[d][f*4]*g;a[f*4+1]=a[f*4+1]*b+h[d][f*4+1]*g;a[f*4+2]=a[f*4+2]*b+h[d][f*4+2]*g;a[f*4+3]=b+g}}return a};this.blendColorMap=function(g,f,h,c){var e=f.length;var a=new Array(e);var j=0;var d;var b;for(d=0;d<e;d++){b=f[d];a[d]=this.createColorMap(g,new Array(b.values.length),b.values,b.rangeMin,b.rangeMax,false,0,1,b.alpha)}return this.blendColors(a)}}function Spectrum(e){var c=this;var a=new ColorManager();function b(f,p,h,o){var j=document.createElement("canvas");var l=new Array(256);var n,m;var g;$(j).attr("width",256);$(j).attr("height",h);for(n=0;n<256;n++){if(o){l[255-n]=n}else{l[n]=n}}f=a.createColorMap(c,[],l,0,255,true,0,1);g=j.getContext("2d");for(m=0;m<256;m++){g.fillStyle="rgb("+parseInt(f[m*4],10)+", "+parseInt(f[m*4+1])+", "+parseInt(f[m*4+2])+")";g.fillRect(m,0,1,p)}return j}c.createSpectrumCanvas=function(f){var g;if(f===null){f=c.colors}g=b(f,20,20,false);return g};c.createSpectrumCanvasWithScale=function(j,f,g,k){var h;var i;if(g===null){g=c.colors}h=b(g,20,40,k);i=h.getContext("2d");i.fillStyle="#FFA000";i.fillRect(0.5,20,1,10);i.fillText(j.toPrecision(3),0.5,40);i.fillRect(h.width/4,20,1,10);i.fillText(((j+f)/4).toPrecision(3),h.width/4,40);i.fillRect(h.width/2,20,1,10);i.fillText(((j+f)/2).toPrecision(3),h.width/2,40);i.fillRect(3*(h.width/4),20,1,10);i.fillText((3*((j+f)/4)).toPrecision(3),3*(h.width/4),40);i.fillRect(h.width-0.5,20,1,10);i.fillText(f.toPrecision(3),h.width-20,40);return h};function d(o){o=o.replace(/^\s+/,"").replace(/\s+$/,"");var m=o.split(/\n/);var f=[];var l,g,j,h;var n;for(l=0,j=m.length;l<j;l++){n=m[l].replace(/\s+$/,"").split(/\s+/);h=n.length;for(g=0;g<h;g++){n[g]=parseFloat(n[g])}if(h<4){n.push(1)}f.push(n)}c.colors=f;return f}if(e!=undefined){d(e)}}var BrainBrowser={start:function(c){if(!BrainBrowser.utils.webWorkersEnabled()){alert("Can't find web workers. Exiting.");return}if(!BrainBrowser.utils.webglEnabled()){alert("Can't get WebGL context. Exiting.");return}var a=Object.create(BrainBrowser.prototype||{});var b;a.view_window=document.getElementById("brainbrowser");a.model=undefined;for(b in BrainBrowser.core){if(BrainBrowser.core.hasOwnProperty(b)){BrainBrowser.core[b](a)}}for(b in BrainBrowser.modules){if(BrainBrowser.modules.hasOwnProperty(b)){BrainBrowser.modules[b](a)}}for(b in BrainBrowser.plugins){if(BrainBrowser.plugins.hasOwnProperty(b)){BrainBrowser.plugins[b](a)}}a.render();c(a)}};BrainBrowser.core={};BrainBrowser.modules={};BrainBrowser.plugins={};BrainBrowser.filetypes={};BrainBrowser.core.color=function(d){var a=new ColorManager();d.updateColors=function(h,o){var o=o||{};var g=o.min;var m=o.max;var k=o.spectrum;var i=o.flip;var n=o.clamped;var j=o.blend;var f=o.afterUpdate;var e;function l(q){var p;if(d.model_data.num_hemispheres===2){b(q)}else{if(h.apply_to_shape){p=[d.model.getChildByName(h.apply_to_shape,true)]}else{p=d.model.children}c(q,p)}if(d.afterUpdateColors){d.afterUpdateColors(h,g,m,k)}if(f){f()}}d.clamped=n;if(j){l(a.blendColorMap(k,h,0,1))}else{h.createColorArray(g,m,k,i,n,d.model_data.colorArray,d.model_data,l)}};function b(w){var h=d.model;var j=w.length;var e;var n;var m=[];var s=[];var q=h.getChildByName("left");var t=q.geometry.faces;var f=h.getChildByName("right");var g=f.geometry.faces;var u=g.length;var p=t.length;var l;var r,k;var v;var o;e=w.slice(0,j/2);n=w.slice(j/2,j);k=Math.max(p,u);for(r=0;r<k;r++){if(r<p){l=t[r];o=l.vertexColors;v=l.a*4;o[0].setRGB(e[v],e[v+1],e[v+2]);v=l.b*4;o[1].setRGB(e[v],e[v+1],e[v+2]);v=l.c*4;o[2].setRGB(e[v],e[v+1],e[v+2]);if(l.d){v=l.d*4;o[3].setRGB(e[v],e[v+1],e[v+2])}}if(r<u){l=g[r];o=l.vertexColors;v=l.a*4;o[0].setRGB(n[v],n[v+1],n[v+2]);v=l.b*4;o[1].setRGB(n[v],n[v+1],n[v+2]);v=l.c*4;o[2].setRGB(n[v],n[v+1],n[v+2]);if(l.d){v=l.d*4;o[3].setRGB(n[v],n[v+1],n[v+2])}}}q.geometry.colorsNeedUpdate=true;f.geometry.colorsNeedUpdate=true}function c(e,f){var o=e.length;var l=[];var s;var g;var r,h;var k;var n,m;var q,p;for(n=0,q=f.length;n<q;n++){h=f[n].geometry.faces;for(m=0,p=h.length;m<p;m++){r=h[m];k=r.vertexColors;s=r.a*4;k[0].setRGB(e[s],e[s+1],e[s+2]);s=r.b*4;k[1].setRGB(e[s],e[s+1],e[s+2]);s=r.c*4;k[2].setRGB(e[s],e[s+1],e[s+2]);if(r.d){s=r.d*4;k[3].setRGB(e[s],e[s+1],e[s+2])}}f[n].geometry.colorsNeedUpdate=true}}};BrainBrowser.modules.loader=function(f){f.loadModelFromUrl=function(i,h){h=h||{};var k;var g;var j=h.format||"MNIObject";b(i,h,function(l){k=i.split("/");g=k[k.length-1];BrainBrowser.filetypes.parse(j,l,function(m){if(m.objectClass!=="__FAIL__"){if(!c(h)){f.displayObjectFile(m,g,h)}}else{if(h.onError!==undefined){h.onError()}}})})};f.loadModelFromFile=function(k,h){h=h||{};var j;var g;var i=h.format||"MNIObject";d(k,h,function(l){j=k.value.split("\\");g=j[j.length-1];BrainBrowser.filetypes.parse(i,l,function(m){if(m.objectClass!=="__FAIL__"){f.displayObjectFile(m,g,h)}else{if(h.onError!=undefined){h.onError()}}})})};f.loadDataFromUrl=function(i,h,g){g=g||{};b(i,g,function(k,j){BrainBrowser.data(k,function(n){if(c(g)){return}var l=g.max===undefined?n.max:g.max;var m=g.min===undefined?n.min:g.min;f.model_data.data=n;n.fileName=h;n.apply_to_shape=g.shape;a(m,l);if(f.afterLoadData){f.afterLoadData(n.rangeMin,n.rangeMax,n)}f.updateColors(n,{min:n.rangeMin,max:n.rangeMax,spectrum:f.spectrum,flip:f.flip,clamped:f.clamped,afterUpdate:g.afterUpdate})})})};f.loadDataFromFile=function(k,o){o=o||{};var h=k.files[0].name;var n=f.model_data;var l=n.positionArray;var i=l.length;var m=o.blend_index||0;var g=1-m;f.blendData=f.blendData||[];var j=function(p){BrainBrowser.data(p,function(s){var q=o.max===undefined?s.max:o.max;var r=o.min===undefined?s.min:o.min;s.fileName=h;s.apply_to_shape=o.shape;s.applied=false;if(s.values.length<i/4){alert("Not enough color points to cover vertices - "+s.values.length+" color points for "+i/3+" vertices.");return -1}n.data=s;f.blendData[m]=s;a(r,q,s);if(f.blendData[g]&&f.blendData[g].applied){a(f.blendData[g].values.min(),f.blendData[g].values.max(),f.blendData[g]);if(f.afterLoadData!=null){f.afterLoadData(null,null,f.blendData,true)}f.blend(0.5);if(f.afterBlendData){f.afterBlendData(s.rangeMin,s.rangeMax,s)}}else{if(f.afterLoadData){f.afterLoadData(s.rangeMin,s.rangeMax,s)}f.updateColors(s,{min:s.rangeMin,max:s.rangeMax,spectrum:f.spectrum,flip:f.flip,clamped:f.clamped,afterUpdate:o.afterUpdate})}s.applied=true})};if(h.match(/.*.mnc|.*.nii/)){e(h,j)}else{d(k,null,j)}};f.blend=function(j){var g=f.blendData;var k=g.length;var h;g[0].alpha=j;g[1].alpha=1-j;for(h=2;h<k;h++){g[h].alpha=0}f.updateColors(g,{spectrum:f.spectrum,flip:f.flip,clamped:f.clamped,blend:true})};f.loadSpectrumFromUrl=function(i,h){h=h||{};var j=h.afterLoadSpectrum;var g;b(i,h,function(k){g=new Spectrum(k);f.spectrum=g;if(j){j()}if(f.afterLoadSpectrum!=null){f.afterLoadSpectrum(g)}if(f.model_data&&f.model_data.data){f.updateColors(f.model_data.data,{min:f.model_data.data.rangeMin,max:f.model_data.data.rangeMax,spectrum:f.spectrum,flip:f.flip,clamped:f.clamped})}})};f.loadSpectrumFromFile=function(i){var g;var h=f.model_data;d(i,null,function(j){g=new Spectrum(j);f.spectrum=g;if(f.afterLoadSpectrum!=null){f.afterLoadSpectrum(g)}if(h.data){f.updateColors(h.data,{min:h.data.rangeMin,max:h.data.rangeMax,spectrum:f.spectrum,flip:f.flip,clamped:f.clamped})}})};f.loadSeriesDataFromFile=function(l){var k=l.files.length;var j=l.files;var g;var h;f.seriesData=new Array(k);f.seriesData.numberFiles=k;for(h=0;h<k;h++){g=new FileReader();g.file=j[h];g.onloadend=(function(m,i){return function(n){console.log(n.target.result.length);console.log(i);BrainBrowser.data(n.target.result,function(o){f.seriesData[i]=o;f.seriesData[i].fileName=m.name})}})(g.file,h);g.readAsText(j[h])}f.setupSeries()};f.rangeChange=function(j,g,k,i){i=i||{};var h=i.afterChange;var l=f.model_data.data;l.rangeMin=j;l.rangeMax=g;f.updateColors(l,{min:l.rangeMin,max:l.rangeMax,spectrum:f.spectrum,flip:f.flip,clamped:k,afterUpdate:i.afterUpdate});if(h){h()}if(f.afterRangeChange!=null){f.afterRangeChange(j,g)}};function b(h,g,j){g=g||{};var i=g.beforeLoad;if(i){i()}jQuery.ajax({type:"GET",url:h,dataType:"text",success:function(k){if(!c(g)){j(k)}},error:function(k,m,l){alert("Failure in loadFromURL: "+m)},timeout:100000})}function d(l,h,k){var j=l.files;if(j.length===0){return}h=h||{};var i=h.beforeLoad;var g=new FileReader();g.file=j[0];if(i){i()}g.onloadend=function(m){k(m.target.result)};g.readAsText(j[0])}function e(g,j){var l;var i;var k;var h;l=new XMLHttpRequest();if(g.match(/.*.mnc/)){l.open("POST","/minc/volume_object_evaluate",false)}else{l.open("POST","/nii/volume_object_evaluate",false)}k=new FormData(document.getElementById("datafile-form"));l.send(k);var h=l.response;j(h)}function a(i,g,h){if(!h){h=f.model_data.data}if(!h.fixRange){h.rangeMin=i;h.rangeMax=g}}function c(g){g=g||{};var j=g.cancel||{};if(BrainBrowser.utils.isFunction(j)){j={test:j}}var h=j.test;var k=j.cleanup;var i=false;if(h&&h()){i=true;if(k){k()}}return i}};BrainBrowser.core.models=function(g){g.displayObjectFile=function(m,j,l){var k=l||{};var n=k.renderDepth;var i=k.afterDisplay;if(m.objectClass=="P"&&m.numberVertices==81924){a(m,n)}else{if(m.objectClass=="P"){c(m,j,n)}else{if(m.objectClass=="L"){d(m,j,false,n)}else{alert("Object file not supported")}}}if(g.afterDisplayObject){g.afterDisplayObject(g.model)}if(i){i()}};function a(l,m){var i=g.model;var k,j;g.model_data=l;k=h(l.left);k.name="left";k.model_num=0;j=h(l.right);j.name="right";j.model_num=1;i.add(k);i.add(j)}function h(n){var v=n.positionArray;var m=n.indexArray;var u={};var k={};var s;var o,p;var t,r,l,q,j;for(o=0,p=v.length;o+2<p;o+=3){e(u,v[o],v[o+1],v[o+2])}k.x=u.minX+0.5*(u.maxX-u.minX);k.y=u.minY+0.5*(u.maxY-u.minY);k.z=u.minY+0.5*(u.maxZ-u.minZ);t=new THREE.Geometry();r=t.vertices;for(o=0,p=v.length;o+2<p;o+=3){r.push(new THREE.Vector3(v[o]-k.x,v[o+1]-k.y,v[o+2]-k.z))}l=t.faces;for(o=0,p=m.length;o+2<p;o+=3){s=new THREE.Face3(m[o],m[o+1],m[o+2]);s.vertexColors=[new THREE.Color(),new THREE.Color(),new THREE.Color()];l.push(s)}t.computeFaceNormals();t.computeVertexNormals();q=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:16777215,shininess:100,vertexColors:THREE.VertexColors});j=new THREE.Mesh(t,q);j.centroid=k;j.position.set(k.x,k.y,k.z);return j}function d(l,i,n,m){var j=g.model;var k=f(l,n);k.name=i;if(m){k.renderDepth=m}j.add(k)}function f(z,l){var t=z;var u=[];var G=[];var w=[];var D={};var x={};var F,E,C,v;var m=t.nitems;var p;var n;var o;var B;var s=[];var r;var q,y,A;var H;g.model_data=t;for(F=0;F<m;F++){if(F===0){p=0}else{p=t.endIndicesArray[F-1]}u.push(t.indexArray[p]);n=t.indexArray;o=t.endIndicesArray[F];for(C=p+1;C<o-1;C++){u.push(n[C]);u.push(n[C])}u.push(n[o-1])}H=g.model_data.positionArray;for(E=0,v=u.length;E<v;E++){e(D,H[u[E]*3],H[u[E]*3+1],H[u[E]*3+2])}x.x=D.minX+0.5*(D.maxX-D.minX);x.y=D.minY+0.5*(D.maxY-D.minY);x.z=D.minY+0.5*(D.maxZ-D.minZ);if(!l){for(E=0,v=u.length;E<v;E++){G.push(new THREE.Vector3(H[u[E]*3]-x.x,H[u[E]*3+1]-x.y,H[u[E]*3+2]-x.z))}if(t.colorArray.length===4){for(F=0;F<numberVertices;F++){s.push(0.5,0.5,0.7,1)}}else{s=g.model_data.colorArray;for(E=0,v=u.length;E<v;E++){r=new THREE.Color();r.setRGB(s[u[E]*4],s[u[E]*4+1],s[u[E]*4+2]);w.push(r)}}}else{G=g.model_data.meshPositionArray;w=g.model_data.meshColorArray}q=new THREE.Geometry();q.vertices=G;q.colors=w;q.colorsNeedUpdate=true;y=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});A=new THREE.Line(q,y,THREE.LinePieces);A.position.set(x.x,x.y,x.z);A.centroid=x;return A}function c(m,j,l){var o=g.model;var q;var n,p;var r=m;var k=r.shapes;g.model_data=r;if(k){for(n=0,p=k.length;n<p;n++){q=b(g.model_data.shapes[n]);q.name=g.model_data.shapes[n].name||(j.split(".")[0]+"_"+n);o.add(q)}}else{q=b(g.model_data);q.name=j;o.add(q)}if(g.afterCreate!=undefined){g.afterCreate(g.model_data)}}function b(p){var k=p.positionArray;var m=p.indexArray;var o=[];var y=p.colorArray;var E,D,s;var r;var n=false;var q,z,G;var w=[];var u;var l;var F=p.faces;var t;var v;var x;var C,B,A;if(y.length===4){n=true;C=y[0];B=y[1];A=y[2]}w=[];q=new THREE.Geometry();for(E=0,s=k.length/3;E<s;E++){q.vertices.push(new THREE.Vector3(k[E*3],k[E*3+1],k[E*3+2]));r=new THREE.Color();if(!n){r.setRGB(y[E*4],y[E*4+1],y[E*4+2])}else{r.setRGB(C,B,A)}w.push(r)}l=q.faces;if(F&&F.length>0){t=F.length;for(E=0;E<t;E++){v=F[E];x=v.length;if(x<3){continue}if(x<=4){if(x<=3){u=new THREE.Face3(v[0],v[1],v[2])}else{if(x===4){u=new THREE.Face4(v[0],v[1],v[2],v[3])}}u.vertexColors=[w[u.a],w[u.b],w[u.c]];if(x>3){u.vertexColors[3]=w[u.d]}l.push(u)}else{for(D=1;D+1<x;D++){u=new THREE.Face3(v[0],v[D],v[D+1]);u.vertexColors=[w[u.a],w[u.b],w[u.c]];l.push(u)}}}}else{for(E=0;E+2<m.length;E+=3){u=new THREE.Face3(m[E],m[E+1],m[E+2]);u.vertexColors[0]=w[u.a];u.vertexColors[1]=w[u.b];u.vertexColors[2]=w[u.c];q.faces.push(u)}}q.computeFaceNormals();q.computeVertexNormals();q.colorsNeedUpdate=true;z=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:16777215,shininess:100,vertexColors:THREE.VertexColors});G=new THREE.Mesh(q,z);return G}function e(j,i,l,k){if(!j.minX||j.minX>i){j.minX=i}if(!j.maxX||j.maxX<i){j.maxX=i}if(!j.minY||j.minY>l){j.minY=l}if(!j.maxY||j.maxY<l){j.maxY=l}if(!j.minZ||j.minZ>k){j.minZ=k}if(!j.maxZ||j.maxZ<k){j.maxZ=k}}};BrainBrowser.core.rendering=function(g){var h;var c=new THREE.Scene();var f;var e=new THREE.PerspectiveCamera(30,g.view_window.offsetWidth/g.view_window.offsetHeight,0.1,5000);var b;var n;var i;var a;var m;var d;g.model=new THREE.Object3D();c.add(g.model);g.render=function(){var o=g.view_window;h=new THREE.WebGLRenderer({clearColor:8947848,clearAlpha:1,preserveDrawingBuffer:true});h.setSize(o.offsetWidth,o.offsetHeight);m=h;d=new THREE.AnaglyphEffect(h);d.setSize(o.offsetWidth,o.offsetHeight);o.appendChild(h.domElement);e.position.z=500;f=new THREE.PointLight(16777215);f.position.set(0,0,500);c.add(f);b=new THREE.TrackballControls(e,o);n=new THREE.TrackballControls(f,o);b.zoomSpeed=2;n.zoomSpeed=2;g.autoRotate={};window.onresize=function(){m.setSize(o.offsetWidth,o.offsetHeight);e.aspect=o.offsetWidth/o.offsetHeight;e.updateProjectionMatrix()};window.onresize();k()};g.canvasDataURL=function(){return h.domElement.toDataURL()};g.anaglyphEffect=function(){m=d};g.noEffect=function(){m=h};g.setCamera=function(o,q,p){e.position.set(o,q,p)};g.resetView=function(){var p=g.model;var s;var q,r;var o=new THREE.Matrix4();o.getInverse(p.matrix);b.reset();n.reset();p.applyMatrix(o);for(q=0,r=g.model.children.length;q<r;q++){s=p.children[q];s.visible=true;if(s.centroid){s.position.set(s.centroid.x,s.centroid.y,s.centroid.z)}else{s.position.set(0,0,0)}s.rotation.set(0,0,0)}};g.clearScreen=function(){var o=g.model.children;while(o.length>0){g.model.remove(o[0])}g.resetView();if(g.afterClearScreen!=undefined){g.afterClearScreen()}};g.updateClearColor=function(o){h.setClearColorHex(o,1)};g.set_fill_mode_wireframe=function(){var p=g.model.children;var q;for(var o=0;o<p.length;o++){q=p[o].material;q.wireframe=true;if(q.emissive){q.emissive.setHex(125269879)}}};g.set_fill_mode_solid=function(){var p=g.model.children;var q;for(var o=0;o<p.length;o++){q=p[o].material;q.wireframe=false;if(q.emissive){q.emissive.setHex(0)}}};g.ZoomInOut=function(o){e.fov*=o;e.updateProjectionMatrix()};g.click=function(v,s){var z=g.view_window;var t=l(z);var x=new THREE.Projector();var w=new THREE.Raycaster();var r=((v.clientX-t.left+window.scrollX)/z.offsetWidth)*2-1;var q=-((v.clientY-t.top+window.scrollY)/z.offsetHeight)*2+1;var p=new THREE.Vector3(r,q,1);var u,o,y;x.unprojectVector(p,e);w.set(e.position,p.sub(e.position).normalize());u=w.intersectObject(g.model,true);if(u.length>0){o=u[0];y={vertex:o.face.a,point:new THREE.Vector3(o.point.x,o.point.y,o.point.z),object:o.object};return s(v,y)}else{return false}};function l(o){var q=0;var p=0;while(o.offsetParent){q+=o.offsetTop;p+=o.offsetLeft;o=o.offsetParent}return{top:q,left:p}}function k(q){var o=g.model;var r;var p;requestAnimationFrame(k);a=i||q;i=q;b.update();n.update();r=i-a;p=r*0.00015;if(g.autoRotate.x){o.rotation.x+=p}if(g.autoRotate.y){o.rotation.y+=p}if(g.autoRotate.z){o.rotation.z+=p}m.render(c,e)}function j(o,t,s){var r=new THREE.SphereGeometry(2);var q=new THREE.MeshBasicMaterial({color:16711680});var p=new THREE.Mesh(r,q);p.position.set(o,t,s);c.add(p)}};BrainBrowser.plugins.ui=function(b){var a=$("#loading");$("body").keydown(function(c){switch(c.which){case 38:b.ZoomInOut(1/1.1);return false;case 40:b.ZoomInOut(1.1);return false;case 32:b.separateHemispheres();return false}return true});$("#clear_color").change(function(c){b.updateClearColor(parseInt($(c.target).val(),16))});$("#resetview").click(b.setupView);$(".view_button").change(b.setupView);$("[name=hem_view]").change(b.setupView);$("#meshmode").change(function(c){if($(c.target).is(":checked")){b.set_fill_mode_wireframe()}else{b.set_fill_mode_solid()}});$("#threedee").change(function(c){if($(c.target).is(":checked")){b.anaglyphEffect()}else{b.noEffect()}});$("#openImage").click(function(){var d=b.view_window;var f=document.createElement("canvas");var h=document.getElementById("spectrum-canvas");var g=f.getContext("2d");var c=new Image();f.width=d.offsetWidth;f.height=d.offsetHeight;function e(){var i=new Image();i.onload=function(){g.drawImage(i,0,0)};i.src=h.toDataURL()}c.onload=function(){g.drawImage(c,0,0);if(h){e()}};c.src=b.canvasDataURL();$("<div></div>").append(f).dialog({title:"Screenshot",height:f.height,width:f.width})});b.getViewParams=function(){return{view:$("[name=hem_view]:checked").val(),left:$("#left_hem_visible").is(":checked"),right:$("#right_hem_visible").is(":checked")}};$("#autorotate-controls").children().change(function(c){b.autoRotate.x=$("#autorotateX").is(":checked");b.autoRotate.y=$("#autorotateY").is(":checked");b.autoRotate.z=$("#autorotateZ").is(":checked")})};var BrainBrowser=BrainBrowser||{};BrainBrowser.utils=(function(){
/*! 
   * WebGL test taken from Detector.js by
   * alteredq / http://alteredqualia.com/
   * mr.doob / http://mrdoob.com/
  */
function b(){try{return !!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(f){return false}}function a(){return !!window.Worker}function c(){var e;var f='BrainBrowser requires <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>.<br/>';f+=window.WebGLRenderingContext?"Your browser seems to support it, but it is <br/> disabled or unavailable.<br/>":"Your browser does not seem to support it.<br/>";f+='Test your browser\'s WebGL support <a href="http://get.webgl.org/">here</a>.';e=document.createElement("div");e.id="webgl-error";e.innerHTML=f;return e}function d(e){return e instanceof Function||typeof e==="function"}return{webglEnabled:b,webWorkersEnabled:a,webGLErrorMessage:c,isFunction:d}})();BrainBrowser.modules.views=function(b){b.changeShapeTransparency=function(e,f){var c=b.model.getChildByName(e);var d;if(c){d=c.material;d.opacity=f;if(f===1){d.transparent=false}else{d.transparent=true}}};b.setupView=function(c){var d=b.getViewParams();b.resetView();if(b.model_data&&b.model_data.num_hemispheres===2){switch(d.view){case"superior":b.superiorView();break;case"medial":b.medialView();break;case"anterior":b.anteriorView();break;case"inferior":b.inferiorView();break;case"lateral":b.lateralView();break;case"posterior":b.posteriorView();break;default:b.superiorView();break}}if(b.model.getChildByName("left")){if(d.left){b.leftHemisphereVisible(true)}else{b.leftHemisphereVisible(false)}}if(b.model.getChildByName("right")){if(d.right){b.rightHemisphereVisible(true)}else{b.rightHemisphereVisible(false)}}};b.leftHemisphereVisible=function(c){b.model.getChildByName("left").visible=c};b.rightHemisphereVisible=function(c){b.model.getChildByName("right").visible=c};b.getInfoForVertex=function(d){var c=b.model_data.getVertexInfo(d);var e={vertex:c.vertex,point:new THREE.Vector3(c.position_vector[0],c.position_vector[1],c.position_vector[2])};return e};b.medialView=function(d){var c=b.model;if(b.model_data.num_hemispheres==2){c.getChildByName("left").position.x-=100;c.getChildByName("left").rotation.z-=a(90);c.getChildByName("right").position.x+=100;c.getChildByName("right").rotation.z+=a(90);c.rotation.x+=a(-90)}};b.lateralView=function(g){var c=b.model;var f,d;if(b.model_data.num_hemispheres==2){f=c.getChildByName("left");d=c.getChildByName("right");f.position.x-=100;f.rotation.z+=a(-90);d.position.x+=100;d.rotation.z+=a(90);c.rotation.x+=a(90);c.rotation.y+=a(180)}};b.superiorView=function(){};b.inferiorView=function(){b.model.rotation.y+=a(180)};b.anteriorView=function(c){b.resetView();b.model.rotation.x+=a(-90);b.model.rotation.z+=a(180)};b.posteriorView=function(c){b.resetView();b.model.rotation.x+=a(-90)};b.separateHemispheres=function(c){if(b.model_data.num_hemispheres==2){b.model.children[0].position.x-=1;b.model.children[1].position.x+=1}};function a(c){return c*Math.PI/180}};BrainBrowser.data=function(a,d){var c={};function b(){var e=new Worker("js/workers/data.worker.js");e.addEventListener("message",function(g){var f=g.data;var h;for(h in f){if(f.hasOwnProperty(h)){c[h]=f[h]}}if(d){d(c)}e.terminate()});e.postMessage({cmd:"parse",data:a})}c.createColorArray=function(g,k,j,h,l,f,i,m){var e=new Worker("js/workers/data.worker.js");e.addEventListener("message",function(o){var n=o.data;var p;if(m){m(n)}e.terminate()});e.postMessage({cmd:"createColorArray",data:{values:c.values,min:g,max:k,spectrum:j.colors,flip:h,clamped:l,original_colors:f,model:{num_hemisphere:i.num_hemisphere,indexArray:i.indexArray}}})};if(a){if(typeof a==="string"){b(a)}else{if(a.values!=undefined){c.values=a.values.concat();c.min=c.values.min();c.max=c.values.max()}else{console.log("copying data length: "+a.length);c.values=a;c.min=a.min();c.max=a.max()}}}};BrainBrowser.filetypes.config={MNIObject:{worker:"js/workers/mniobj.worker.js",afterParse:function(a){a.getVertexInfo=function(c){var b=[a.positionArray[c*3],a.positionArray[c*3+1],a.positionArray[c*3+2]];return{vertex:c,position_vector:b}}}},WavefrontObj:{worker:"js/workers/wavefront_obj.worker.js"},FreeSurferAsc:{worker:"js/workers/freesurfer_asc.worker.js",format_hint:'You can use <a href="http://surfer.nmr.mgh.harvard.edu/fswiki/mris_convert" target="_blank">mris_convert</a> to convert your binary surface files into .asc format.'}};BrainBrowser.filetypes.parse=function(b,c,e){var d={};var a=BrainBrowser.filetypes.config[b];if(a.parse){a.parse(d,c,e)}if(a.worker){BrainBrowser.filetypes.parseWorker(d,c,a.worker,e)}if(a.afterParse){a.afterParse(d,c)}};BrainBrowser.filetypes.parseWorker=function(a,c,b,e){var d=new Worker(b);d.addEventListener("message",function(g){var f=g.data;var h;for(h in f){if(f.hasOwnProperty(h)){a[h]=f[h]}}if(e){e(a)}d.terminate()});d.postMessage(c)};$(function(){var c=0;var b="";var a=$("#loading");if(!BrainBrowser.utils.webglEnabled()){$("#brainbrowser").html(BrainBrowser.utils.webGLErrorMessage());return}BrainBrowser.start(function(d){d.loadSpectrumFromUrl("/assets/spectral_spectrum.txt");d.clamped=true;d.flip=false;d.afterLoadSpectrum=function(e){var f=e.createSpectrumCanvasWithScale(0,100,null);var g=document.getElementById("color-bar");f.id="spectrum-canvas";if(!g){$('<div id="color-bar"></div>').html(f).appendTo("#data-range-box")}else{$(g).html(f)}d.spectrumObj=e};d.afterDisplayObject=function(g){var f;var l,e;var j,k;var h=g.children;var m=$("#shapes").children();if(h.length-m.length>0){for(j=m.length,k=h.length;j<k;j++){f=h[j];e=$('<div id="shape_'+j+'" class="shape"><h4>Shape '+(j+1)+"</h4>Name: "+f.name+"<br />Opacity: </div>");l=$('<div class="opacity-slider slider"  data-shape-name="'+f.name+'"></div>');l.slider({value:100,min:-1,max:101,slide:function(i,o){var q=i.target;var n=$(q).attr("data-shape-name");var p=$(q).slider("value");p=Math.min(100,Math.max(0,p))/100;d.changeShapeTransparency(n,p)}});l.appendTo(e);e.appendTo("#shapes")}}d.afterClearScreen=function(){$("#shapes").html("");$("#data-range-box").hide()}};$("#clearshapes").click(function(f){d.clearScreen();c=0;b="";a.hide()});$("#range-slider").slider({range:true,min:-50,max:50,value:[-10,10],slider:function(g,h){var f=parseFloat(h.values[0]);var e=parseFloat(h.values[1]);d.rangeChange(f,e,$("#clamp_range").is(":checked"))},step:0.1});d.afterRangeChange=function(g,e){$("#data-range-min").val(g);$("#data-range-max").val(e);var f=d.spectrumObj.createSpectrumCanvasWithScale(g,e,null);f.id="spectrum-canvas";$("#color-bar").html($(f))};d.afterLoadData=function(g,l,h,o){var f=$("#data-range");var e='<div id="data-range-multiple"><ul>';var m="";var h=h.length?h:[h];var j,k;f.html("");for(j=0,k=h.length;j<k;j++){e+='<li><a href="#data_file'+j+'">'+h[j].fileName+"</a></li>";m+='<div id="data_file'+j+'" class="box">';m+='Min: <input class="range-box" id="data-range-min" type="text" name="range_min" size="5" >';m+='<div id="range-slider+'+j+'" data-blend-index="'+j+'" class="slider"></div>';m+='Max: <input class="range-box" id="data-range-max" type="text" name="range_max" size="5" >';m+='<input type="checkbox" class="button" id="fix_range"><label for="fix_range">Fix Range</label>';m+='<input type="checkbox" class="button" id="clamp_range" checked="true"><label for="clamp_range">Clamp range</label>';m+='<input type="checkbox" class="button" id="flip_range"><label for="flip_range">Flip Colors</label>';m+="</div>"}e+="</ul>";f.html(e+m+"</div>");$("#data-range-box").show();f.find("#data-range-multiple").tabs();$("#data-range").find(".slider").each(function(p,r){var q=h[0].values.min();var i=h[0].values.max();$(r).slider({range:true,min:q,max:i,values:[h[p].rangeMin,h[p].rangeMax],step:(i-q)/100,slide:function(s,t){$("#data-range-min").val(t.values[0]);$("#data-range-max").val(t.values[1])},stop:function(t,u){a.show();var s=$(this).attr("data-blend-index");range_updating=true;h[0].rangeMin=u.values[0];h[0].rangeMax=u.values[1];d.model_data.data=h[0];d.rangeChange(h[0].rangeMin,h[0].rangeMax,d.clamped,{afterUpdate:function(){a.hide()}})}})});function n(q){a.show();var p=$("#data-range-min").val();var i=$("#data-range-max").val();$(q.target).siblings(".slider").slider("values",0,p);$(q.target).siblings(".slider").slider("values",1,i);d.rangeChange(p,i,$(q.target).siblings("#clamp_range").is(":checked"),{afterUpdate:function(){a.hide()}})}$("#data-range-min").change(n);$("#data-range-max").change(n);$("#fix_range").click(function(i,p){d.fixRange=$(i.target).is(":checked")});$("#clamp_range").change(function(q){var p=parseFloat($(q.target).siblings("#data-range-min").val());var i=parseFloat($(q.target).siblings("#data-range-max").val());if($(q.target).is(":checked")){d.rangeChange(p,i,true)}else{d.rangeChange(p,i,false)}});$("#flip_range").change(function(i){d.flip=$(i.target).is(":checked");a.show();d.updateColors(d.model_data.data,{min:d.model_data.data.rangeMin,max:d.model_data.data.rangeMax,spectrum:d.spectrum,flip:d.flip,clamped:d.clamped,afterUpdate:function(){a.hide()}})});if(!o){$("#range-slider").slider("values",0,parseFloat(g));$("#range-slider").slider("values",1,parseFloat(l));d.afterRangeChange(g,l)}};d.afterBlendData=function(){var e=$("#blend-box");e.html("Blend Ratio: ");$('<span id="blend_value">0.5</span>').appendTo(e);$('<div class="blend_slider" id="blend_slider" width="100px" + height="10"></div>').slider({value:0,min:0.1,max:0.99,value:0.5,step:0.01,slide:function(g,h){var f=$(this);f.siblings("span").html(f.slider("value"))},stop:function(f,g){d.blend($(this).slider("value"))}}).appendTo(e)};$(".range-box").keypress(function(f){if(f.keyCode=="13"){d.rangeChange(parseFloat($("#data-range-min").val()),parseFloat($("#data-range-max").val()))}});$("#examples").click(function(i){c++;var g=$(i.target).attr("data-example-name");var k,h;if(b===g){return}b=g;function j(e){return function(){return e!==c}}function f(){a.hide()}a.show();d.clearScreen();switch(g){case"basic":d.loadModelFromUrl("/models/surf_reg_model_both.obj",{format:"MNIObject",afterDisplay:f,cancel:j(c)});break;case"punkdti":d.loadModelFromUrl("/models/dti.obj",{format:"MNIObject",renderDepth:999,afterDisplay:f,cancel:j(c)});d.loadModelFromUrl("/models/left_color.obj",{format:"MNIObject",cancel:j(c)});d.loadModelFromUrl("/models/right_color.obj",{format:"MNIObject",cancel:j(c)});break;case"realct":d.loadModelFromUrl("/models/realct.obj",{format:"MNIObject",afterDisplay:function(){d.loadDataFromUrl("/models/realct.txt","Cortical Thickness",{afterUpdate:f,cancel:j(c)})},cancel:j(c)});break;case"car":d.loadModelFromUrl("/models/car.obj",{format:"WavefrontObj",afterDisplay:f,cancel:j(c)});d.setCamera(0,0,100);k=new THREE.Matrix4();k.makeRotationX(-0.25*Math.PI);h=new THREE.Matrix4();h.makeRotationY(0.4*Math.PI);d.model.applyMatrix(h.multiply(k));break;case"plane":d.loadModelFromUrl("/models/dlr_bigger.streamlines.obj",{format:"MNIObject",cancel:j(c)});d.loadModelFromUrl("/models/dlr.model.obj",{format:"MNIObject",afterDisplay:function(){f()},cancel:j(c)});d.setCamera(0,0,75);k=new THREE.Matrix4();k.makeRotationX(-0.25*Math.PI);h=new THREE.Matrix4();h.makeRotationY(0.4*Math.PI);d.model.applyMatrix(h.multiply(k));break;case"mouse":d.loadModelFromUrl("/models/mouse_surf.obj",{format:"MNIObject",afterDisplay:function(){d.loadDataFromUrl("/models/mouse_alzheimer_map.txt","Cortical Amyloid Burden, Tg AD Mouse, 18 Months Old",{shape:"mouse_surf.obj",min:0,max:0.25,afterUpdate:f,cancel:j(c)})},cancel:j(c)});d.loadModelFromUrl("/models/mouse_brain_outline.obj",{format:"MNIObject",afterDisplay:function(){$(".opacity-slider[data-shape-name='mouse_brain_outline.obj']").slider("value",50);d.changeShapeTransparency("mouse_brain_outline.obj",0.5)},cancel:j(c)});d.setCamera(0,0,40)}return false});$("#obj_file_format").change(function(){var e=$("#obj_file_format").closest("#obj_file_select").find("#obj_file_format option:selected").val();$("#format_hint").html(BrainBrowser.filetypes.config[e].format_hint||"")});$("#obj_file_submit").click(function(){var e=$("#obj_file_format").closest("#obj_file_select").find("#obj_file_format option:selected").val();d.loadModelFromFile(document.getElementById("objfile"),{format:e,beforeLoad:function(){a.show()},afterDisplay:function(){a.hide()},onError:function(){a.hide()}});return false});$(".datafile").change(function(){var e=parseInt(this.id.slice(-1),10);d.loadDataFromFile(this,{blend_index:e-1})});$("#spectrum").change(function(){d.loadSpectrumFromFile(document.getElementById("spectrum"))});$("a.example[data-example-name=realct]").click()})});