Array.prototype.min=function(){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.min.apply(Math,this.slice(c,c+b-1)))}}else{return Math.min.apply(Math,this)}return a.min()};Array.prototype.max=function(d){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.max.apply(Math,this.slice(c,c+b-1)))}}else{return Math.max.apply(Math,this)}return a.max()};function cloneArray(b){var c=new Array(b.length);for(var a=0;a<c.length;a++){c[a]=b[a]}return c}function rotateUint16Array90Left(f,d,a){var e=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){e[c*a+b]=f[b*d+(d-c)]}}return e}function rotateUint16Array90Right(f,d,a){var e=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){e[c*a+b]=f[(a-b)*d+c]}}return e}function interpolateDataArray(g,c,b,a){console.log(g.values.length);var e=g.values.length;var f=new Array(e);console.log("Percentage: "+b);for(var d=0;d<e;d++){if(a){f[d]=(g.values[d]*(100-b*100)+c.values[d]*(b*100))/100}else{f[d]=(g.values[d]*(100-b*100)+c.values[d]*(b*100))/100}}console.log(f.length);return f}function WavefrontObj(m){var j=this;m=m.split("\n");j.shapes=[];var b;var c=[];var t=[];var r=[];b={name:m.name|"undefined",faces:[],positionArray:[],colorArray:[],indexArray:[],texIndexArray:[],normalIndexArray:[]};j.shapes.push(b);for(var o=0;o<m.length;o++){var u=m[o].split(/\s+/);if(!(u[0].match("#"))||u==""){if(u[0]=="o"|u[0]=="g"){console.log(u[1]);b={name:u[1],faces:[],positionArray:[],colorArray:[],indexArray:[],texIndexArray:[],normalIndexArray:[]};j.shapes.push(b)}else{if(u[0]=="v"){c.push(parseFloat(u[1]));c.push(parseFloat(u[2]));c.push(parseFloat(u[3]))}else{if(u[0]=="vt"){for(var e=1;e<u.length;e++){t.push(parseFloat(u[e]))}}else{if(u[0]=="vn"){r.push(parseFloat(u[1]));r.push(parseFloat(u[2]));r.push(parseFloat(u[3]))}else{if(u[0]=="f"){var s=[];for(var h=1;h<4;h++){var f=u[h].split("/");s.push(parseInt(f[0])-1);b.indexArray.push(parseInt(f[0])-1);b.texIndexArray.push(parseInt(f[1])-1);if(f[2]){b.normalIndexArray.push(parseInt(f[2])-1)}}if(u.length>=4){for(h;h<u.length;h++){var f=u[h].split("/");s.push(parseInt(f[0])-1);var p=b.indexArray.length;b.indexArray.push(b.indexArray[p-1]);b.indexArray.push(b.indexArray[p-3]);b.indexArray.push(f[0]-1)}}b.faces.push(s)}}}}}}}var a=Array(c.length/3);var d=j.shapes.length;for(var g=0;g<d;g++){var q=j.shapes[g];q.positionArray=c;if(q.colorArray.length==0){q.colorArray=[0.8,0.8,0.8,1]}}j.objectClass="P";j.vertexArray=c;j.texCoordArray=t}function MNIObject(d){var j;var g=this;function b(m){g.num_hemispheres=1;var l=m.replace(/\s+$/,"");var n=l.replace(/^\s+/,"");j=n.split(/\s+/).reverse();g.objectClass=j.pop();if(g.objectClass=="P"){e();g.numberVertices=parseInt(j.pop());f();k();g.nitems=parseInt(j.pop())}else{if(g.objectClass=="L"){e();g.numberVertices=parseInt(j.pop());f();g.nitems=parseInt(j.pop())}else{g.objectClass="__FAIL__";return}}h();c();a();if(g.objectClass=="P"){if(g.positionArray.length==81924*3){g.brainSurface=true;g.split_hemispheres()}}}function e(){if(g.objectClass=="P"){g.surfaceProperties={ambient:parseFloat(j.pop()),diffuse:parseFloat(j.pop()),specular_reflectance:parseFloat(j.pop()),specular_scattering:parseFloat(j.pop()),transparency:parseFloat(j.pop())}}else{if(g.objectClass=="L"){g.surfaceProperties={width:j.pop()}}}}function f(){g.positionArray=new Array();for(var l=0;l<g.numberVertices;l++){for(var m=0;m<3;m++){g.positionArray.push(parseFloat(j.pop()))}}}function k(){g.normalArray=new Array();for(var m=0;m<g.numberVertices;m++){for(var l=0;l<3;l++){g.normalArray.push(parseFloat(j.pop()))}}}function h(){g.colorFlag=parseInt(j.pop());g.colorArray=new Array();if(g.colorFlag===0){for(var l=0;l<4;l++){g.colorArray.push(parseFloat(j.pop()))}}else{if(g.colorFlag===1){for(var m=0;m<g.numberPolygons;m++){for(var l=0;l<4;l++){g.colorArray.push(parseFloat(j.pop()))}}}else{if(g.colorFlag===2){for(var m=0;m<g.numberVertices;m++){for(var l=0;l<4;l++){g.colorArray.push(parseFloat(j.pop()))}}}else{throw new Error("colorFlag not valid in that file")}}}}function c(){g.endIndicesArray=new Array();for(var l=0;l<g.nitems;l++){g.endIndicesArray.push(parseInt(j.pop()))}}function a(){g.indexArray=new Array();var m=j.length;for(var l=0;l<m;l++){g.indexArray.push(parseInt(j.pop()))}}g.split_hemispheres=function(){g.left={};g.right={};var p=g.positionArray.length;g.left.positionArray=g.positionArray.slice(0,p/2);g.right.positionArray=g.positionArray.slice(p/2,p);var o=g.indexArray.length;g.left.indexArray=g.indexArray.slice(0,o/2);g.right.indexArray=g.indexArray.slice(o/2,o);for(var l=0;l<g.right.indexArray.length;l++){g.right.indexArray[l]=g.right.indexArray[l]-2-o/3/2/2}var m=g.normalArray.length;g.left.normalArray=g.normalArray.slice(0,m/2);g.right.normalArray=g.normalArray.slice(m/2,m);g.left.colorFlag=g.colorFlag;g.right.colorFlag=g.colorFlag;if(g.colorFlag==0||g.colorFlag==1){g.left.colorArray=g.colorArray;g.right.colorArray=g.colorArray}else{var n=g.colorArray.length;g.left.colorArray=g.colorArray.slice(0,n/2);g.right.colorArray=g.colorArray.slice(n/2+1,-1)}g.left.numberVertices=g.numberVertices/2;g.right.numberVertices=g.numberVertices/2;g.left.numberPolygons=g.numberPolygons/2;g.right.numberPolygons=g.numberPolygons/2;g.num_hemispheres=2};g.getVertexInfo=function(m){var l=[g.positionArray[m*3],g.positionArray[m*3+1],g.positionArray[m*3+2]];return{vertex:m,position_vector:l}};g.get_vertex=function(v,s,l){if(g.num_hemispheres>1){var r=g[l];var o=0;if(l=="right"){o=2+r.indexArray.length/3/2}}else{var r=g;var o=0}var q=new Array();var y=v*3;for(var p=0;p<3;p++){q.push(r.indexArray[y+p])}var w=new Array();for(var p=0;p<3;p++){var u=q[p]*3;w[p]=new Array();for(var n=0;n<3;n++){w[p][n]=r.positionArray[u+n]}}var x=new Array();for(var p=0;p<3;p++){x.push(o3djs.math.distance(s,w[p]))}var m=0;if(x[1]<x[0]){m=1}if(x[2]<x[m]){m=2}var t=q[m]+o;var z=w[m];return{vertex:t,position_vector:z}};if(d){b(d)}}function ColorManager(){function c(l,d,p,h,n,k,m,g,f){var l=l.colors;var o=((n-h)+(n-h)/l.length)/l.length;for(var j=0;j<p.length;j++){if(p[j]<=h){var q=0}else{if(p[j]>n){var q=l.length-1}else{var q=parseInt((p[j]-h)/o)}}if(k){var e=255}else{var e=1}d[j*4+0]=e*l[q][0]*g+m*e;d[j*4+1]=e*l[q][1]*g+m*e;d[j*4+2]=e*l[q][2]*g+m*e;if(f){d[j*4+3]=e*f}else{d[j*4+3]=e}}return d}this.createColorMap=c;function a(k){var d=k[0];for(var g=0;g<k[0].length/4;g++){for(var f=1;f<k.length;f++){var e=d[g*4+3];var h=k[f][g*4+3];d[g*4]=d[g*4]*e+k[f][g*4]*h;d[g*4+1]=d[g*4+1]*e+k[f][g*4+1]*h;d[g*4+2]=d[g*4+2]*e+k[f][g*4+2]*h;d[g*4+3]=e+h}}return d}this.blendColors=a;function b(e,l,j,g){var d=l.length;var k=new Array(d);var h=0;for(var f=0;f<d;f++){k[f]=c(e,new Array(l[f].values.length),l[f].values,l[f].rangeMin,l[f].rangeMax,false,0,1,l[f].alpha)}return a(k)}this.blendColorMap=b}function Spectrum(e){var c=this;var a=new ColorManager();function b(f,p,h,o){var j=document.createElement("canvas");jQuery(j).attr("width",256);jQuery(j).attr("height",h);var l=new Array(256);for(var n=0;n<256;n++){if(o){l[255-n]=n}else{l[n]=n}}f=a.createColorMap(c,[],l,0,255,true,0,1);var g=j.getContext("2d");for(var m=0;m<256;m++){g.fillStyle="rgb("+parseInt(f[m*4])+","+parseInt(f[m*4+1])+","+parseInt(f[m*4+2])+")";g.fillRect(m,0,1,p)}return j}c.createSpectrumCanvas=function(f){if(f==null){f=c.colors}var g=b(f,20,20,false);return g};c.createSpectrumCanvasWithScale=function(k,f,g,l){if(g==null){g=c.colors}var h=b(g,20,40,l);var j=h.getContext("2d");j.fillStyle="#FFA000";j.fillRect(0.5,20,1,10);j.fillText(k.toPrecision(3),0.5,40);j.fillRect(h.width/4,20,1,10);j.fillText(((k+f)/4).toPrecision(3),h.width/4,40);j.fillRect(h.width/2,20,1,10);j.fillText(((k+f)/2).toPrecision(3),h.width/2,40);j.fillRect(3*(h.width/4),20,1,10);j.fillText((3*((k+f)/4)).toPrecision(3),3*(h.width/4),40);j.fillRect(h.width-0.5,20,1,10);j.fillText(f.toPrecision(3),h.width-20,40);return h};function d(m){m=m.replace(/\s+$/,"");m=m.replace(/^\s+/,"");var j=m.split(/\n/);var f=new Array();for(var h=0;h<j.length;h++){var l=j[h].replace(/\s+$/,"").split(/\s+/);for(var g=0;g<l.length;g++){l[g]=parseFloat(l[g])}if(l.length<4){l.push(1)}f.push(l)}c.colors=f;return f}if(e!=undefined){d(e)}}function Data(b){var a=this;a.parse=function(c){c=c.replace(/\s+$/,"");c=c.replace(/^\s+/,"");a.values=c.split(/\s+/);for(var d=0;d<a.values.length;d++){a.values[d]=parseFloat(a.values[d])}a.min=a.values.min();a.max=a.values.max()};this.createColorArray=function(f,n,m,h,q,d,k){var m=m.colors;var p=new Array();var o=((n-f)+(n-f)/m.length)/m.length;for(var g=0;g<a.values.length;g++){if(a.values[g]<=f){if(a.values[g]<f&&!q){var r=-1}else{var r=0}}else{if(a.values[g]>n){if(!q){var r=-1}else{var r=m.length-1}}else{var r=parseInt((a.values[g]-f)/o)}}if(h&&r!=-1){p.push.apply(p,m[m.length-1-r])}else{if(r==-1){if(d.length==4){p.push.apply(p,d)}else{p.push.apply(p,[d[g*4],d[g*4+1],d[g*4+2],d[g*4+3]])}}else{p.push.apply(p,m[r])}}}if(k.num_hemisphere!=2){var l=[];var c=k.indexArray.length;for(var e=0;e<c;e++){l[e*4]=p[k.indexArray[e]*4];l[e*4+1]=p[k.indexArray[e]*4+1];l[e*4+2]=p[k.indexArray[e]*4+2];l[e*4+3]=p[k.indexArray[e]*4+3]}p.nonIndexedColorArray=l}return p};if(b){if(typeof b=="string"){a.parse(b)}else{if(b.values!=undefined){this.values=cloneArray(b.values);this.min=this.values.min();this.max=this.values.max()}else{console.log("copying data length: "+b.length);this.values=b;this.min=b.min();this.max=b.max()}}}}function Dataset(a,b){if(b==null){this.path=function(g,f){var d="ICBM152_"+f.sk;if(f.modality=="CT"){var c="ICBM152_"+f.modality+"_MACACC_mean"}else{var c="ICBM152_"+f.modality+"_MACACC_size"}if(f.statistic=="T"){var e="T_map/T_"}else{if(f.statistic=="P1"){var e="RTF_C_map/RTF_C_"}else{if(f.statistic=="P2"){var e="RTF_V_map/RTF_V_"}}}if(a==null){a="/data/"}return a+c+"/"+d+"/"+e+g+".txt"}}else{this.path=function(d,c){return a}}this.get_data=function(f,c,h){if(f=="aal_atlas"){var g="/assets/aal_atlas.txt"}else{var g=this.path(f,c)}if(b){var e={vertex:f,modality:c.modality,sk:c.sk,statistic:c.statistic}}var d=this;jQuery.ajax({type:"GET",url:g,data:e,dataType:"text",success:function(j){d.current_data=new Data(j);h(d)},error:function(){jQuery(g_pickInfoElem).html("Error loading map")}})}}function BrainBrowser(){var g=this;var j=new ColorManager();var e;var u;var x;var w;var y;var m=new THREE.Object3D();var h;var v;var c;var z;this.start=function(){window.onload=function(){setTimeout(function(){g.init()},0)}};this.init=function(){y=new THREE.Scene();e=$("#view-window");x=new THREE.PerspectiveCamera(30,e.width()/e.height(),0.1,5000);if(f()){u=new THREE.WebGLRenderer({clearColor:8947848,clearAlpha:1,preserveDrawingBuffer:true})}else{e.html(n());return}u.setSize(e.width(),e.height());e.append(u.domElement);x.position.z=500;w=new THREE.PointLight(16777215);w.position.x=0;w.position.y=0;w.position.z=500;y.add(w);h=new THREE.TrackballControls(x,e[0]);v=new THREE.TrackballControls(w,e[0]);h.zoomSpeed=2;v.zoomSpeed=2;function D(E){requestAnimationFrame(D);z=c||E;c=E;h.update();v.update();g.renderCallback(E)}if(g.afterInit){g.afterInit(g)}window.onresize();D()};
/*! 
   * WebGL test taken from Detector.js by
   * alteredq / http://alteredqualia.com/
   * mr.doob / http://mrdoob.com/
  */
function f(){try{return !!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(D){return false}}function n(){var E='BrainBrowser requires <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>.<br/>';E+=window.WebGLRenderingContext?"Your browser seems to support it, but it is <br/> disabled or unavailable.<br/>":"Your browser does not seem to support it.<br/>";E+='Test your browser\'s WebGL support <a href="http://get.webgl.org/">here</a>.';var D=$('<div id="webgl-error">'+E+"</div>");return D}this.setCamera=function(D,F,E){x.position.set(D,F,E)};this.getModel=function(){return m};function k(F,G){g.model_data=F;var E=q(F.left);E.name="left";E.model_num=0;var D=q(F.right);D.name="right";D.model_num=1;m.add(E);m.add(D);y.add(m)}function q(G){var M=G.positionArray;var F=G.indexArray;var L={};var E={};var J;for(var H=0;H+2<M.length;H+=3){r(L,M[H],M[H+1],M[H+2])}E.x=L.minX+0.5*(L.maxX-L.minX);E.y=L.minY+0.5*(L.maxY-L.minY);E.z=L.minY+0.5*(L.maxZ-L.minZ);var K=new THREE.Geometry();for(var H=0;H+2<M.length;H+=3){K.vertices.push(new THREE.Vector3(M[H]-E.x,M[H+1]-E.y,M[H+2]-E.z))}for(var H=0;H+2<F.length;H+=3){J=new THREE.Face3(F[H],F[H+1],F[H+2]);J.vertexColors[0]=new THREE.Color();J.vertexColors[1]=new THREE.Color();J.vertexColors[2]=new THREE.Color();K.faces.push(J)}K.computeFaceNormals();K.computeVertexNormals();var I=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:526344,vertexColors:THREE.VertexColors});var D=new THREE.Mesh(K,I);D.centroid=E;D.position.set(E.x,E.y,E.z);return D}function t(F,D,H,G){var E=p(F,H);E.name=D;if(G){E.renderDepth=G}m.add(E);y.add(m)}function p(K,T){g.model_data=K;var S=[];var Q=[];var D=[];var O={};var F={};for(var L=0;L<g.model_data.nitems;L++){if(L==0){var E=0}else{var E=g.model_data.endIndicesArray[L-1]}S.push(g.model_data.indexArray[E]);for(var I=E+1;I<g.model_data.endIndicesArray[L]-1;I++){S.push(g.model_data.indexArray[I]);S.push(g.model_data.indexArray[I])}S.push(g.model_data.indexArray[g.model_data.endIndicesArray[L]-1])}var P=g.model_data.positionArray;for(var J=0;J<S.length;J++){r(O,P[S[J]*3],P[S[J]*3+1],P[S[J]*3+2])}F.x=O.minX+0.5*(O.maxX-O.minX);F.y=O.minY+0.5*(O.maxY-O.minY);F.z=O.minY+0.5*(O.maxZ-O.minZ);if(!T){for(var J=0;J<S.length;J++){Q.push(new THREE.Vector3(P[S[J]*3]-F.x,P[S[J]*3+1]-F.y,P[S[J]*3+2]-F.z))}var R=[];if(g.model_data.colorArray.length==4){for(var L=0;L<numberVertices;L++){R.push.apply(R,[0.5,0.5,0.7,1])}}else{var R=g.model_data.colorArray;for(var J=0;J<S.length;J++){var G=new THREE.Color();G.setRGB(R[S[J]*4],R[S[J]*4+1],R[S[J]*4+2]);D.push(G)}}}else{Q=g.model_data.meshPositionArray;D=g.model_data.meshColorArray}var N=new THREE.Geometry();N.vertices=Q;N.colors=D;N.colorsNeedUpdate=true;var M=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});var H=new THREE.Line(N,M,THREE.LinePieces);H.position.set(F.x,F.y,F.z);H.centroid=F;return H}function B(G,E,H){g.model_data=G;if(g.model_data.shapes){for(var F=0;F<g.model_data.shapes.length;F++){var D=l(g.model_data.shapes[F]);D.name=g.model_data.shapes[F].name;m.add(D)}}else{var D=l(g.model_data);D.name=E;m.add(D)}if(g.afterCreate!=undefined){g.afterCreate(g.model_data)}y.add(m)}function l(O){var J=O.positionArray;var P=O.indexArray;var Q=[];if(O.colorArray.length==4){for(var I=0;I<J.length/3;I++){Q.push(O.colorArray[0]);Q.push(O.colorArray[1]);Q.push(O.colorArray[2])}}else{Q=[];var G=P.length;for(var H=0;H+2<O.colorArray.length;H+=4){Q.push(O.colorArray[H]);Q.push(O.colorArray[H+1]);Q.push(O.colorArray[H+2])}}var D=[];var F;var M=new THREE.Geometry();for(var I=0;I+2<J.length;I+=3){M.vertices.push(new THREE.Vector3(J[I],J[I+1],J[I+2]));F=new THREE.Color();F.setRGB(Q[I],Q[I+1],Q[I+2]);D.push(F)}if(O.faces&&O.faces.length>0){var E=O.faces;for(var I=0;I<E.length;I++){if(E[I].length<3){continue}if(E[I].length<=4){if(E[I].length<=3){var L=new THREE.Face3(E[I][0],E[I][1],E[I][2])}else{if(E[I].length==4){var L=new THREE.Face4(E[I][0],E[I][1],E[I][2],E[I][3])}}L.vertexColors[0]=D[L.a];L.vertexColors[1]=D[L.b];L.vertexColors[2]=D[L.c];if(E[I].length>3){L.vertexColors[3]=D[L.d]}M.faces.push(L)}else{for(var H=1;H+1<E[I].length;H++){var L=new THREE.Face3(E[I][0],E[I][H],E[I][H+1]);L.vertexColors[0]=D[L.a];L.vertexColors[1]=D[L.b];L.vertexColors[2]=D[L.c];M.faces.push(L)}}}}else{for(var I=0;I+2<P.length;I+=3){var L=new THREE.Face3(P[I],P[I+1],P[I+2]);L.vertexColors[0]=D[L.a];L.vertexColors[1]=D[L.b];L.vertexColors[2]=D[L.c];M.faces.push(L)}}M.computeFaceNormals();M.computeVertexNormals();M.colorsNeedUpdate=true;var K=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:526344,vertexColors:THREE.VertexColors});var N=new THREE.Mesh(M,K);if(g.loading){jQuery(g.loading).html("Buffers Loaded")}return N}this.uninit=function(){if(this.client){this.client.cleanup()}};this.renderCallback=function(){var E=c-z;var D=E*0.00015;if(g.autoRotate){if(g.autoRotate.x){m.rotation.x+=D}if(g.autoRotate.y){m.rotation.y+=D}if(g.autoRotate.z){m.rotation.z+=D}}u.render(y,x)};this.clearScreen=function(){if(m){y.remove(m)}g.resetView();m=new THREE.Object3D();if(g.afterClearScreen!=undefined){g.afterClearScreen()}};this.displayObjectFile=function(H,E,G){var F=G||{};var I=F.renderDepth;if(H.objectClass=="P"&&H.numberVertices==81924){k(H,I)}else{if(H.objectClass=="P"){B(H,E,I)}else{if(H.objectClass=="L"){t(H,E,false,I)}else{alert("Object file not supported")}}}if(g.afterDisplayObject!=undefined){g.afterDisplayObject(m)}var F=G||{};var D=F.afterDisplay;if(D){D()}};function d(F,D,E){if(E==null){E=g.model_data.data}if(E.fixRange==false||E.fixRange==null){E.rangeMin=F;E.rangeMax=D}}this.updateClearColor=function(D){u.setClearColor(new THREE.Color(D))};this.updateClearColorFromName=function(D){if(D=="white"){g.updateClearColor(16777215)}else{if(D=="black"){g.updateClearColor(0)}else{if(D=="pink"){g.updateClearColor(16711935)}else{g.updateClearColor(8947848)}}}};this.resetView=function(){h.reset();v.reset();m.position.set(0,0,0);m.rotation.set(0,0,0);for(var D=0;D<m.children.length;D++){var E=m.children[D];E.visible=true;if(E.centroid){E.position.set(E.centroid.x,E.centroid.y,E.centroid.z)}else{E.position.set(0,0,0)}E.rotation.set(0,0,0)}};this.setupView=function(D){g.resetView();if(g.model_data&&g.model_data.num_hemispheres==2){var E=g.getViewParams();switch(E.view){case"superior":g.superiorView();break;case"medial":g.medialView();break;case"anterior":g.anteriorView();break;case"inferior":g.inferiorView();break;case"lateral":g.lateralView();break;case"posterior":g.posteriorView();break;default:g.superiorView();break}}if(m.getChildByName("left")){if(E.left==true){g.leftHemisphereVisible(true)}else{g.leftHemisphereVisible(false)}}if(m.getChildByName("right")){if(E.right==true){g.rightHemisphereVisible(true)}else{g.rightHemisphereVisible(false)}}};function a(D){return D*Math.PI/180}this.leftHemisphereVisible=function(D){m.getChildByName("left").visible=D};this.rightHemisphereVisible=function(D){m.getChildByName("right").visible=D};this.medialView=function(D){if(g.model_data.num_hemispheres==2){m.getChildByName("left").position.x-=100;m.getChildByName("left").rotation.z-=a(90);m.getChildByName("right").position.x+=100;m.getChildByName("right").rotation.z+=a(90);m.rotation.x+=a(-90)}};this.lateralView=function(D){if(g.model_data.num_hemispheres==2){m.getChildByName("left").position.x-=100;m.getChildByName("left").rotation.z+=a(-90);m.getChildByName("right").position.x+=100;m.getChildByName("right").rotation.z+=a(90);m.rotation.x+=a(90);m.rotation.y+=a(180)}};this.superiorView=function(){};this.inferiorView=function(){m.rotation.y+=a(180)};this.anteriorView=function(D){g.resetView();m.rotation.x+=a(-90);m.rotation.z+=a(180)};this.posteriorView=function(D){g.resetView();m.rotation.x+=a(-90)};this.separateHemispheres=function(D){if(g.model_data.num_hemispheres==2){m.children[0].position.x-=1;m.children[1].position.x+=1}};this.ZoomInOut=function(D){x.fov*=D;x.updateProjectionMatrix()};g.scrollMe=function(E){var D=(E.deltaY<0)?1/g.zoomFactor:g.zoomFactor;g.ZoomInOut(D);g.client.render()};function s(D){A();if(D){g.selectedInfo=D}}function A(){if(g.selectedInfo){g.highlightShape=null;g.selectedInfo=null}}this.click=function(I,F){var G=e.offset();mouseX=((I.clientX-G.left+$(window).scrollLeft())/e.width())*2-1;mouseY=-((I.clientY-G.top+$(window).scrollTop())/e.height())*2+1;var K=new THREE.Projector();var J=new THREE.Raycaster();A();var E=new THREE.Vector3(mouseX,mouseY,1);K.unprojectVector(E,x);J.set(x.position,E.sub(x.position).normalize());var H=J.intersectObject(m,true);if(H.length>0){var D=H[0];var L={vertex:D.face.a,point:new THREE.Vector3(D.point.x,D.point.y,D.point.z),object:D.object};return F(I,L)}else{jQuery(g.pickInfoElem).html("--nothing--");return false}};this.getInfoForVertex=function(E){var D=g.model_data.getVertexInfo(E);var F={vertex:D.vertex,point:new THREE.Vector3(D.position_vector[0],D.position_vector[1],D.position_vector[2])};return F};this.keyPressedCallback=function(E){var D=false;switch(E.which){case 38:g.ZoomInOut(1.1);D="ZoomIn";break;case 40:g.ZoomInOut(1/1.1);D="ZoomOut";break;case 32:g.separateHemispheres();D="Seperate";break}if(D){return false}else{return true}};function r(F,D,G,E){if(!F.minX||F.minX>D){F.minX=D}if(!F.maxX||F.maxX<D){F.maxX=D}if(!F.minY||F.minY>G){F.minY=G}if(!F.maxY||F.maxY<G){F.maxY=G}if(!F.minZ||F.minZ>E){F.minZ=E}if(!F.maxZ||F.maxZ<E){F.maxZ=E}}function o(D,I,H){var G=new THREE.SphereGeometry(2);var F=new THREE.MeshBasicMaterial({color:16711680});var E=new THREE.Mesh(G,F);E.position.set(D,I,H);y.add(E)}this.set_fill_mode_wireframe=function(){var E=m.children;for(var D=0;D<E.length;D++){var F=E[D].material;F.wireframe=true;if(F.emissive){F.emissive.setHex(125269879)}}};this.set_fill_mode_solid=function(){var E=m.children;for(var D=0;D<E.length;D++){var F=E[D].material;F.wireframe=false;if(F.emissive){F.emissive.setHex(0)}}};function C(E,G,H){var D=G||{};var F=D.beforeLoad;if(F){F()}jQuery.ajax({type:"GET",url:E,dataType:"text",success:function(I){H(I)},error:function(I,K,J){alert("Failure in loadFromURL: "+K)},data:{},timeout:100000})}function b(J,H,I){var G=J.files;if(G.length===0){return}var E=H||{};var F=E.beforeLoad;var D=new FileReader();D.file=G[0];if(F){F()}D.onloadend=function(K){I(K.target.result)};D.readAsText(G[0])}this.loadObjFromUrl=function(D,E){C(D,E,function(G){var H=D.split("/");var F=H[H.length-1];g.displayObjectFile(new MNIObject(G),F,E)})};this.loadWavefrontObjFromUrl=function(D,E){C(D,E,function(G){var H=D.split("/");var F=H[H.length-1];g.displayObjectFile(new WavefrontObj(G),F,E)})};this.loadObjFromFile=function(F,E){var D=E||{};b(F,D,function(G){var J=F.value.split("\\");var H=J[J.length-1];var I;if(D.format==="wavefront"){I=new WavefrontObj(G)}else{I=new MNIObject(G)}if(I.objectClass!=="__FAIL__"){g.displayObjectFile(I,H,D)}else{if(D.onError!=undefined){D.onError()}}})};this.loadSpectrumFromUrl=function(D,F){options=F||{};var E=options.afterLoadSpectrum;C(D,options,function(H){var G=new Spectrum(H);g.spectrum=G;if(E){E()}if(g.afterLoadSpectrum!=null){g.afterLoadSpectrum(G)}if(g.model_data.data){g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum,g.flip,g.clamped)}})};this.loadSpectrumFromFile=function(D){b(D,null,function(F){var E=new Spectrum(F);g.spectrum=E;if(g.afterLoadSpectrum!=null){g.afterLoadSpectrum(E)}if(g.model_data.data){g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum,g.flip,g.clamped)}})};this.loadDataFromFile=function(J){var D=J.files[0].name;var H=function(L){var K=new Data(L);K.fileName=D;if(K.values.length<g.model_data.positionArray.length/4){alert("Number of numbers in datafile lower than number of vertices Vertices"+g.model_data.positionArray.length/3+" data values:"+K.values.length);return -1}else{g.model_data.data=K}d(g.model_data.data.min,g.model_data.data.max);if(g.afterLoadData!=null){g.afterLoadData(g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.model_data.data)}g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum,g.flip,g.clamped);return null};if(D.match(/.*.mnc|.*.nii/)){var I=new XMLHttpRequest();if(D.match(/.*.mnc/)){I.open("POST","/minc/volume_object_evaluate",false)}else{I.open("POST","/nii/volume_object_evaluate",false)}var F=document.getElementById("datafile-form");var G=new FormData(F);I.send(G);var E=I.response;H(E)}else{b(J,null,H)}};this.loadSeriesDataFromFile=function(I){console.log(I.files.length);var H=I.files.length;g.seriesData=new Array(H);g.seriesData.numberFiles=H;var F=I.files;for(var E=0;E<H;E++){var D=new FileReader();D.file=F[E];var G=D.onloadend=(function(K,J){return function(L){console.log(L.target.result.length);console.log(J);g.seriesData[J]=new Data(L.target.result);g.seriesData[J].fileName=K.name}})(D.file,E);D.readAsText(F[E])}g.setupSeries()};this.setupSeries=function(){$('<div id="series">Series: </div>').appendTo("#surface_choice");var D=$("#series");$('<span id="series-value">0</span>').appendTo(D);$('<div id="series-slider" width="100px" + height="10"></div>').slider({value:0,min:0,max:g.seriesData.numberFiles-1,step:0.1,slide:function(E,F){if(F.value-Math.floor(F.value)<0.01){g.model_data.data=g.seriesData[F.value]}else{if(g.seriesData[0].fileName.match("pval.*")){g.model_data.data=new Data(interpolateDataArray(g.seriesData[Math.floor(F.value)],g.seriesData[Math.floor(F.value)+1],(F.value-Math.floor(F.value)),true))}else{g.model_data.data=new Data(interpolateDataArray(g.seriesData[Math.floor(F.value)],g.seriesData[Math.floor(F.value)+1],(F.value-Math.floor(F.value))))}}if(g.seriesData[0].fileName.match("mt.*")){$("#age_series").html("Age: "+(F.value*3+5).toFixed(1))}else{if(g.seriesData[0].fileName.match("pval.*")){$("#age_series").html("Age: "+(F.value*1+10))}}$(D).children("#series-value").html(F.value);if(g.model_data.data.values.length<g.model_data.positionArray.length/4){console.log("Number of numbers in datafile lower than number of vertices Vertices"+g.model_data.positionArray.length/3+" data values:"+g.model_data.data.values.length);return -1}d(g.model_data.data.min,g.model_data.data.max);if(g.afterLoadData!=null){g.afterLoadData(g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.model_data.data)}g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum,g.flip,g.clamped);return null}}).appendTo(D)};this.loadBlendDataFromFile=function(I){var H=I.files.length;g.blendData=new Array(H);g.blendData.numberFiles=H;var F=I.files;for(var E=0;E<H;E++){var D=new FileReader();D.file=F[E];var G=D.onloadend=(function(K,J){return function(M){g.blendData[J]=new Data(M.target.result);g.blendData.alpha=1/H;g.blendData[J].fileName=K.name;for(var L=0;L<2;L++){if(g.blendData[L]==undefined){console.log("not done yet");return}}d(g.blendData[0].values.min(),g.blendData[0].values.max(),g.blendData[0]);d(g.blendData[1].values.min(),g.blendData[1].values.max(),g.blendData[1]);if(g.afterLoadData!=null){g.afterLoadData(null,null,g.blendData,true)}g.blend($(".blend_slider").slider("value"))}})(D.file,E);D.readAsText(F[E])}g.setupBlendColors()};this.setupBlendColors=function(){console.log("Blend colors has ran "+g.blendData.numberFiles);$("#blend").remove();$('<div id="blend">Blend ratios: </div>').appendTo("#surface_choice");var D=$("#blend");$('<span id="blend_value'+i+'">0</span>').appendTo(D);$('<div class="blend_slider" id="blend_slider'+i+'" width="100px" + height="10"></div>').slider({value:0,min:0.1,max:0.99,value:0.5,step:0.01,slide:function(E,F){g.blend($(this).slider("value"))}}).appendTo(D)};this.blend=function(E){g.blendData[0].alpha=E;g.blendData[1].alpha=1-E;for(var D=2;D<g.blendData.length;D++){g.blendData[D].alpha=0}g.updateColors(g.blendData,null,null,g.spectrum,g.flip,g.clamped,true)};this.loadDataFromUrl=function(E,D){C(E,null,function(G,F){g.model_data.data=new Data(G);g.model_data.data.fileName=D;d(g.model_data.data.min,g.model_data.data.max);if(g.afterLoadData!=undefined){g.afterLoadData(g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.model_data.data)}g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum)})};this.updateColors=function(ah,V,aa,af,N,T,Y,F,R){var K=R||{};var G=K.afterUpdate;g.clamped=T;if(Y){var ag=j.blendColorMap(af,ah,0,1)}else{var ag=ah.createColorArray(V,aa,af,N,T,g.model_data.colorArray,g.model_data)}if(g.model_data.num_hemispheres==2){var D=ag.slice(0,ag.length/2);var S=ag.slice(ag.length/2,ag.length);var P=[];var ab=[];var W=m.getChildByName("left");var ad=W.geometry.faces;var H=m.getChildByName("right");var I=H.geometry.faces;var O;var ac=I.length;var U=ad.length;var J;var ae;J=Math.max(U,ac);for(var Z=0;Z<J;Z++){if(Z<U){O=ad[Z];ae=O.a*4;O.vertexColors[0].setRGB(D[ae],D[ae+1],D[ae+2]);ae=O.b*4;O.vertexColors[1].setRGB(D[ae],D[ae+1],D[ae+2]);ae=O.c*4;O.vertexColors[2].setRGB(D[ae],D[ae+1],D[ae+2]);if(O.d){ae=O.d*4;O.vertexColors[3].setRGB(D[ae],D[ae+1],D[ae+2])}}if(Z<ac){O=I[Z];ae=O.a*4;O.vertexColors[0].setRGB(S[ae],S[ae+1],S[ae+2]);ae=O.b*4;O.vertexColors[1].setRGB(S[ae],S[ae+1],S[ae+2]);ae=O.c*4;O.vertexColors[2].setRGB(S[ae],S[ae+1],S[ae+2]);if(O.d){ae=O.d*4;O.vertexColors[3].setRGB(S[ae],S[ae+1],S[ae+2])}}}W.geometry.colorsNeedUpdate=true;H.geometry.colorsNeedUpdate=true}else{var Q=[];for(var Z=0;Z+2<ag.length;Z+=4){var M=new THREE.Color();M.setRGB(ag[Z],ag[Z+1],ag[Z+2]);Q.push(M)}var L=m.children;for(var Z=0;Z<L.length;Z++){var E=L[Z].geometry.faces;for(var X=0;X<E.length;X++){var O=E[X];O.vertexColors[0]=Q[O.a];O.vertexColors[1]=Q[O.b];O.vertexColors[2]=Q[O.c];if(O.d){O.vertexColors[3]=Q[O.d]}}L[Z].geometry.colorsNeedUpdate=true}}if(G){G()}if(g.afterUpdateColors!=null){g.afterUpdateColors(ah,V,aa,af)}return 1};this.rangeChange=function(G,D,H,I){var F=I||{};var E=F.afterChange;g.model_data.data.rangeMin=G;g.model_data.data.rangeMax=D;g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum,g.flip,H);if(E){E()}if(g.afterRangeChange!=null){g.afterRangeChange(G,D)}};this.changeShapeTransparency=function(E,F){var D=m.getChildByName(E);if(D){D.material.opacity=F;if(F==1){D.material.transparent=false}else{D.material.transparent=true}}};this.getImageUrl=function(){var G=document.createElement("canvas");var D=document.getElementById("spectrum_canvas");G.width=e.width();G.height=e.height();var H=G.getContext("2d");var E=new Image();function F(){var I=new Image();I.onload=function(){H.drawImage(I,0,0);window.open(G.toDataURL(),"screenshot")};I.src=D.toDataURL()}E.onload=function(){H.drawImage(E,0,0);if(D){F()}else{window.open(G.toDataURL(),"screenshot")}};E.src=u.domElement.toDataURL()};window.onresize=function(){e=$("#view-window");u.setSize(e.width(),e.height());x.aspect=e.width()/e.height();x.updateProjectionMatrix()};g.start()}var g_spectrum;function MacaccObject(b,g,h){var d=this;this.brainbrowser=b;this.dataSet=new Dataset(g,h);d.debugLineGroup;d.debugLine;d.selectedInfo=null;d.treeInfo;d.pickInfoElem;d.flashTimer=0;d.highlightMaterial;d.highlightShape;d.vertex;d.positionVector;d.primitiveIndex;d.dataArray;d.data_max;d.data_min;d.range_max;d.range_min;d.spectrum;d.coordinates=jQuery("#coordinates");d.selectPoint=null;function c(l,k){var j=l.vertex;if(j!=undefined&&k!=undefined){jQuery("#x-coord").val(l.point.x);jQuery("#y-coord").val(l.point.y);jQuery("#z-coord").val(l.point.z);jQuery("#v-coord").val(j);jQuery("#value-coord").val(k)}}this.pickClick=function(j,k){d.vertex=k.vertex;if(k.object&&k.object.model_num){d.vertex+=k.object.model_num*k.object.geometry.vertices.length}if(d.vertex){f();c(k,0);if(b.secondWindow!=undefined&&true){b.secondWindow.postMessage(d.vertex,"*")}}else{jQuery(d.pickInfoElem).html("--nothing--")}};this.change_model=function(l,j){var k=jQuery(l.target).val();b.clearScreen();b.loadObjFromUrl("/data/surfaces/surf_reg_model_both_"+k+".obj",j)};this.flipXCoordinate=function(){if(!d.dataArray){return}if(d.vertex>d.dataArray.length/2){d.vertex-=d.dataArray.length/2}else{d.vertex+=d.dataArray.length/2}c(b.getInfoForVertex(d.vertex),0);f()};this.valueAtPoint=function(k,l){var j=d.dataArray[l.vertex];c(l,j)};function a(){var l=jQuery("[name=modality]:checked").val();var k=jQuery("#data-sk").val();var j=jQuery("[name=statistic]:checked").val();return{modality:l,sk:k,statistic:j}}this.update_model=function(l){d.dataArray=l.current_data.values;b.current_dataset=l;if(jQuery("#fix_range").is(":checked")){if(!(d.data_min=parseFloat(jQuery("#data-range-min").val()))){if(!d.data_min===0){d.data_min=l.current_data.min}}if(!(d.data_max=parseFloat(jQuery("#data-range-max").val()))){if(!d.data_max===0){d.data_max=l.current_data.max}}}else{if(a().statistic=="T"){d.data_min=l.current_data.min;d.data_max=l.current_data.max}}var k=jQuery("#flip_range").is(":checked");var j=jQuery("#clamp_range").is(":checked");if(a().statistic=="T"){d.flipRange=k;b.updateColors(d.dataSet.current_data,d.data_min,d.data_max,b.spectrum,k,j)}else{d.flipRange=!k;jQuery("#range-slider").slider("option","min","0");jQuery("#range-slider").slider("option","max","1");b.updateColors(d.dataSet.current_data,0,1,b.spectrum,!k,j)}};function f(){d.dataSet.get_data(d.vertex,a(),d.update_model);jQuery(d.pickInfoElem).html("Viewing data for vertex: "+d.vertex)}this.show_atlas=function(){b.loadDataFromUrl("/assets/aal_atlas.txt")};function e(k,j){if(!jQuery("#fix_range").attr("checked")){jQuery("#data-range-min").val(k);jQuery("#data-range-max").val(j);jQuery("#range-slider").slider("values",0,k);jQuery("#range-slider").slider("values",1,j)}if(d.afterRangeChange!=undefined){d.afterRangeChange(k,j)}}this.range_change=function(){var k=parseFloat($("#data-range-min").val());var j=parseFloat($("#data-range-max").val());b.updateColors(d.dataSet.current_data,k,j,b.spectrum,$("#flip_range").is(":checked"),$("#clamp_range").is(":checked"));if(d.afterRangeChange!=undefined){d.afterRangeChange(k,j)}};this.data_control_change=function(){var j=a();if(j.modality=="AAL"){d.show_atlas()}else{if(d.vertex){f()}}};b.loadSpectrumFromUrl("/assets/spectral_spectrum.txt");b.valueAtPointCallback=this.valueAtPoint;b.clickCallback=this.pickClick}var brainbrowser;var macacc;function initMacacc(a,b){brainbrowser=new BrainBrowser();brainbrowser.getViewParams=function(){return{view:jQuery("[name=hem_view]:checked").val(),left:jQuery("#left_hem_visible").is(":checked"),right:jQuery("#right_hem_visible").is(":checked")}};brainbrowser.afterLoadSpectrum=function(c){var d=c.createSpectrumCanvasWithScale(0,5,null,false);jQuery("#spectrum").html(jQuery(d));brainbrowser.spectrumObj=c};brainbrowser.afterInit=function(c){c.loadObjFromUrl("/models/surf_reg_model_both.obj",{afterDisplay:function(){$("#loading").hide();macacc=new MacaccObject(c,a,b);brainbrowser.afterCreateBrain=function(){if(c.current_dataset!=undefined){macacc.update_model(c.current_dataset)}};macacc.afterRangeChange=function(f,d){if(macacc.flipRange==true){var e=c.spectrumObj.createSpectrumCanvasWithScale(f,d,null,true)}else{var e=c.spectrumObj.createSpectrumCanvasWithScale(f,d,null,false)}jQuery("#spectrum").html(jQuery(e))};jQuery(".data_controls").change(macacc.data_control_change);macacc.pickInfoElem=jQuery("#vertex_info");jQuery("#x-coord-flip").click(macacc.flipXCoordinate);jQuery("#model").change(function(d){$("#loading").show();macacc.change_model(d,{afterDisplay:function(){$("#loading").hide()}})})}});$("#meshmode").change(function(d){if(jQuery(d.target).is(":checked")){c.set_fill_mode_wireframe()}else{c.set_fill_mode_solid()}});$("#clear_color").change(function(f){var d=$(f.target).val();c.updateClearColorFromName(d)});$("#range-slider").slider({range:true,min:-10,max:15,values:[0,5],slide:function(d,e){jQuery("#data-range-min").val(e.values[0]);jQuery("#data-range-max").val(e.values[1]);if(c.current_dataset){macacc.range_change()}},step:0.1});$(".range-box").keypress(function(d){if(d.keyCode=="13"){macacc.range_change(d)}});$("#data-range-min").change(function(d){$("#range-slider").slider("values",0,$(this).val());macacc.afterRangeChange(parseFloat($("#data-range-min").val()),parseFloat($("#data-range-max").val()))});$("#data-range-max").change(function(d){jQuery("#range-slider").slider("values",1,jQuery(this).val());macacc.afterRangeChange(parseFloat(jQuery("#data-range-min").val()),parseFloat(jQuery("#data-range-max").val()))});$("[name=pointer]").change(function(d){if($("[name=pointer]:checked").val()=="AAL_atlas"){macacc.show_atlas()}});jQuery("#screenshot").click(function(d){jQuery(this).attr("href",c.client.toDataUR())});$("#view-window").mousedown(function(d){var f=jQuery("[name=pointer]:checked").val();if(d.ctrlKey||f=="check"){if(c.valueAtPointCallback){c.click(d,c.valueAtPointCallback)}}else{if(d.shiftKey||f=="select"){if(c.clickCallback){c.click(d,c.clickCallback)}}}});jQuery("#flip_range").change(function(d){macacc.update_model(brainbrowser.current_dataset)});jQuery("#clamp_range").change(function(d){macacc.update_model(brainbrowser.current_dataset)});jQuery("#flip_correlation").click(function(g){var f=-1*parseFloat(jQuery("#data-range-max").val());var d=-1*parseFloat(jQuery("#data-range-min").val());jQuery("#data-range-min").val(f).change();jQuery("#data-range-max").val(d).change();jQuery("#flip_range").attr("checked",!jQuery("#flip_range").attr("checked")).change()})};jQuery("#resetview").click(brainbrowser.setupView);jQuery(".view_button").change(brainbrowser.setupView);jQuery("[name=hem_view]").change(brainbrowser.setupView);jQuery(".button").button();jQuery(".button_set").buttonset();jQuery("#secondWindow").click(function(c){brainbrowser.secondWindow=window.open("/macacc.html","secondWindow")});window.addEventListener("message",function(f){var d=parseInt(f.data);var c=[brainbrowser.model_data.positionArray[d*3],brainbrowser.model_data.positionArray[d*3+1],brainbrowser.model_data.positionArray[d*3+2]];macacc.pickClick(f,{position_vector:c,vertex:d,stop:true,})},false);if(window.opener!=null){brainbrowser.secondWindow=window.opener}};