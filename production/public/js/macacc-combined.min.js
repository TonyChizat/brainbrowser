/*! 
 * Copyright (C) 2011 McGill University
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 *   the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
Array.prototype.min=function(){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.min.apply(Math,this.slice(c,c+b-1)))}}else{return Math.min.apply(Math,this)}return a.min()};Array.prototype.max=function(d){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.max.apply(Math,this.slice(c,c+b-1)))}}else{return Math.max.apply(Math,this)}return a.max()};function cloneArray(b){var c=new Array(b.length);for(var a=0;a<c.length;a++){c[a]=b[a]}return c}function rotateUint16Array90Left(f,d,a){var e=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){e[c*a+b]=f[b*d+(d-c)]}}return e}function rotateUint16Array90Right(f,d,a){var e=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){e[c*a+b]=f[(a-b)*d+c]}}return e}function interpolateDataArray(g,c,b,a){console.log(g.values.length);var e=g.values.length;var f=new Array(e);console.log("Percentage: "+b);for(var d=0;d<e;d++){if(a){f[d]=(g.values[d]*(100-b*100)+c.values[d]*(b*100))/100}else{f[d]=(g.values[d]*(100-b*100)+c.values[d]*(b*100))/100}}console.log(f.length);return f}function ColorManager(){function c(l,d,p,h,n,k,m,g,f){var l=l.colors;var o=((n-h)+(n-h)/l.length)/l.length;for(var j=0;j<p.length;j++){if(p[j]<=h){var q=0}else{if(p[j]>n){var q=l.length-1}else{var q=parseInt((p[j]-h)/o)}}if(k){var e=255}else{var e=1}d[j*4+0]=e*l[q][0]*g+m*e;d[j*4+1]=e*l[q][1]*g+m*e;d[j*4+2]=e*l[q][2]*g+m*e;if(f){d[j*4+3]=e*f}else{d[j*4+3]=e}}return d}this.createColorMap=c;function a(k){var d=k[0];for(var g=0;g<k[0].length/4;g++){for(var f=1;f<k.length;f++){var e=d[g*4+3];var h=k[f][g*4+3];d[g*4]=d[g*4]*e+k[f][g*4]*h;d[g*4+1]=d[g*4+1]*e+k[f][g*4+1]*h;d[g*4+2]=d[g*4+2]*e+k[f][g*4+2]*h;d[g*4+3]=e+h}}return d}this.blendColors=a;function b(e,l,j,g){var d=l.length;var k=new Array(d);var h=0;for(var f=0;f<d;f++){k[f]=c(e,new Array(l[f].values.length),l[f].values,l[f].rangeMin,l[f].rangeMax,false,0,1,l[f].alpha)}return a(k)}this.blendColorMap=b}function Spectrum(e){var c=this;var a=new ColorManager();function b(f,p,h,o){var j=document.createElement("canvas");jQuery(j).attr("width",256);jQuery(j).attr("height",h);var l=new Array(256);for(var n=0;n<256;n++){if(o){l[255-n]=n}else{l[n]=n}}f=a.createColorMap(c,[],l,0,255,true,0,1);var g=j.getContext("2d");for(var m=0;m<256;m++){g.fillStyle="rgb("+parseInt(f[m*4])+","+parseInt(f[m*4+1])+","+parseInt(f[m*4+2])+")";g.fillRect(m,0,1,p)}return j}c.createSpectrumCanvas=function(f){if(f==null){f=c.colors}var g=b(f,20,20,false);return g};c.createSpectrumCanvasWithScale=function(k,f,g,l){if(g==null){g=c.colors}var h=b(g,20,40,l);var j=h.getContext("2d");j.fillStyle="#FFA000";j.fillRect(0.5,20,1,10);j.fillText(k.toPrecision(3),0.5,40);j.fillRect(h.width/4,20,1,10);j.fillText(((k+f)/4).toPrecision(3),h.width/4,40);j.fillRect(h.width/2,20,1,10);j.fillText(((k+f)/2).toPrecision(3),h.width/2,40);j.fillRect(3*(h.width/4),20,1,10);j.fillText((3*((k+f)/4)).toPrecision(3),3*(h.width/4),40);j.fillRect(h.width-0.5,20,1,10);j.fillText(f.toPrecision(3),h.width-20,40);return h};function d(m){m=m.replace(/\s+$/,"");m=m.replace(/^\s+/,"");var j=m.split(/\n/);var f=new Array();for(var h=0;h<j.length;h++){var l=j[h].replace(/\s+$/,"").split(/\s+/);for(var g=0;g<l.length;g++){l[g]=parseFloat(l[g])}if(l.length<4){l.push(1)}f.push(l)}c.colors=f;return f}if(e!=undefined){d(e)}}function Data(b){var a=this;a.parse=function(c){c=c.replace(/\s+$/,"");c=c.replace(/^\s+/,"");a.values=c.split(/\s+/);for(var d=0;d<a.values.length;d++){a.values[d]=parseFloat(a.values[d])}a.min=a.values.min();a.max=a.values.max()};this.createColorArray=function(f,n,m,h,q,d,k){var m=m.colors;var p=new Array();var o=((n-f)+(n-f)/m.length)/m.length;for(var g=0;g<a.values.length;g++){if(a.values[g]<=f){if(a.values[g]<f&&!q){var r=-1}else{var r=0}}else{if(a.values[g]>n){if(!q){var r=-1}else{var r=m.length-1}}else{var r=parseInt((a.values[g]-f)/o)}}if(h&&r!=-1){p.push.apply(p,m[m.length-1-r])}else{if(r==-1){if(d.length==4){p.push.apply(p,d)}else{p.push.apply(p,[d[g*4],d[g*4+1],d[g*4+2],d[g*4+3]])}}else{p.push.apply(p,m[r])}}}if(k.num_hemisphere!=2){var l=[];var c=k.indexArray.length;for(var e=0;e<c;e++){l[e*4]=p[k.indexArray[e]*4];l[e*4+1]=p[k.indexArray[e]*4+1];l[e*4+2]=p[k.indexArray[e]*4+2];l[e*4+3]=p[k.indexArray[e]*4+3]}p.nonIndexedColorArray=l}return p};if(b){if(typeof b=="string"){a.parse(b)}else{if(b.values!=undefined){this.values=cloneArray(b.values);this.min=this.values.min();this.max=this.values.max()}else{console.log("copying data length: "+b.length);this.values=b;this.min=b.min();this.max=b.max()}}}}function Dataset(a,b){if(b==null){this.path=function(g,f){var d="ICBM152_"+f.sk;if(f.modality=="CT"){var c="ICBM152_"+f.modality+"_MACACC_mean"}else{var c="ICBM152_"+f.modality+"_MACACC_size"}if(f.statistic=="T"){var e="T_map/T_"}else{if(f.statistic=="P1"){var e="RTF_C_map/RTF_C_"}else{if(f.statistic=="P2"){var e="RTF_V_map/RTF_V_"}}}if(a==null){a="/data/"}return a+c+"/"+d+"/"+e+g+".txt"}}else{this.path=function(d,c){return a}}this.get_data=function(f,c,h){if(f=="aal_atlas"){var g="/assets/aal_atlas.txt"}else{var g=this.path(f,c)}if(b){var e={vertex:f,modality:c.modality,sk:c.sk,statistic:c.statistic}}var d=this;jQuery.ajax({type:"GET",url:g,data:e,dataType:"text",success:function(j){d.current_data=new Data(j);h(d)},error:function(){jQuery(g_pickInfoElem).html("Error loading map")}})}}function BrainBrowser(c){if(!(this instanceof BrainBrowser)){return new BrainBrowser(c)}var b=this;this.view_window=$("#brainbrowser");this.model=undefined;this.scene=undefined;this.camera=undefined;var a;for(a in BrainBrowser.core){if(BrainBrowser.core.hasOwnProperty(a)){BrainBrowser.core[a](this)}}for(a in BrainBrowser.modules){if(BrainBrowser.modules.hasOwnProperty(a)){BrainBrowser.modules[a](this)}}for(a in BrainBrowser.plugins){if(BrainBrowser.plugins.hasOwnProperty(a)){BrainBrowser.plugins[a](this)}}if(BrainBrowser.webgl_enabled()){this.render()}else{alert("Can't get WebGL constext. Exiting.");return}c(this)}BrainBrowser.core={};BrainBrowser.modules={};BrainBrowser.plugins={};BrainBrowser.filetypes={};
/*! 
 * WebGL test taken from Detector.js by
 * alteredq / http://alteredqualia.com/
 * mr.doob / http://mrdoob.com/
*/
BrainBrowser.webgl_enabled=function(){try{return !!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(a){return false}};BrainBrowser.webGLErrorMessage=function(){var a;var b='BrainBrowser requires <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>.<br/>';b+=window.WebGLRenderingContext?"Your browser seems to support it, but it is <br/> disabled or unavailable.<br/>":"Your browser does not seem to support it.<br/>";b+='Test your browser\'s WebGL support <a href="http://get.webgl.org/">here</a>.';a=$('<div id="webgl-error">'+b+"</div>");return a};BrainBrowser.modules.color=function(d){var a=new ColorManager();d.updateColors=function(j,h,o,n,k,p,m,l,f){var q=f||{};var g=q.afterUpdate;var e;d.clamped=p;if(m){e=a.blendColorMap(n,j,0,1)}else{e=j.createColorArray(h,o,n,k,p,d.model_data.colorArray,d.model_data)}if(d.model_data.num_hemispheres===2){b(e)}else{c(e)}if(g){g()}if(d.afterUpdateColors!=null){d.afterUpdateColors(j,h,o,n)}};function b(w){var h=d.model;var j=w.length;var e;var n;var m=[];var s=[];var q=h.getChildByName("left");var t=q.geometry.faces;var f=h.getChildByName("right");var g=f.geometry.faces;var u=g.length;var p=t.length;var l;var r,k;var v;var o;e=w.slice(0,j/2);n=w.slice(j/2,j);k=Math.max(p,u);for(r=0;r<k;r++){if(r<p){l=t[r];o=l.vertexColors;v=l.a*4;o[0].setRGB(e[v],e[v+1],e[v+2]);v=l.b*4;o[1].setRGB(e[v],e[v+1],e[v+2]);v=l.c*4;o[2].setRGB(e[v],e[v+1],e[v+2]);if(l.d){v=l.d*4;o[3].setRGB(e[v],e[v+1],e[v+2])}}if(r<u){l=g[r];o=l.vertexColors;v=l.a*4;o[0].setRGB(n[v],n[v+1],n[v+2]);v=l.b*4;o[1].setRGB(n[v],n[v+1],n[v+2]);v=l.c*4;o[2].setRGB(n[v],n[v+1],n[v+2]);if(l.d){v=l.d*4;o[3].setRGB(n[v],n[v+1],n[v+2])}}}q.geometry.colorsNeedUpdate=true;f.geometry.colorsNeedUpdate=true}function c(e){var o=d.model;var q=e.length;var l=[];var s;var g;var r,h;var f;var k;var n,m;var p;f=o.children;for(n=0,p=f.length;n<p;n++){h=f[n].geometry.faces;for(m=0,p=h.length;m<p;m++){r=h[m];k=r.vertexColors;s=r.a*4;k[0].setRGB(e[s],e[s+1],e[s+2]);s=r.b*4;k[0].setRGB(e[s],e[s+1],e[s+2]);s=r.c*4;k[0].setRGB(e[s],e[s+1],e[s+2]);if(r.d){s=r.d*4;k[0].setRGB(e[s],e[s+1],e[s+2])}}f[n].geometry.colorsNeedUpdate=true}}};BrainBrowser.modules.data=function(f){var d=BrainBrowser.filetypes;f.loadModelFromUrl=function(j,l){var h=l||{};var m;var g;var k=h.format||"MNIObject";b(j,l,function(n){m=j.split("/");g=m[m.length-1];f.displayObjectFile(new d[k](n),g,h)})};f.loadModelFromFile=function(n,k){var h=k||{};var m;var g;var l;var j=h.format||"MNIObject";c(n,h,function(o){m=n.value.split("\\");g=m[m.length-1];l=new d[j](o);if(l.objectClass!=="__FAIL__"){f.displayObjectFile(l,g,h)}else{if(h.onError!=undefined){h.onError()}}})};f.loadDataFromUrl=function(h,g){b(h,null,function(l,j){var k;f.model_data.data=new Data(l);k=f.model_data.data;k.fileName=g;a(k.min,k.max);if(f.afterLoadData!=undefined){f.afterLoadData(k.rangeMin,k.rangeMax,k)}f.updateColors(k,k.rangeMin,k.rangeMax,f.spectrum)})};f.loadDataFromFile=function(m){var h=m.files[0].name;var j=f.model_data;var g=j.positionArray;var k=g.length;var l=function(o){var n=new Data(o);n.fileName=h;if(n.values.length<k/4){alert("Number of numbers in datafile lower than number of vertices Vertices"+k/3+" data values:"+n.values.length);return -1}else{j.data=n}a(n.min,n.max);if(f.afterLoadData!=null){f.afterLoadData(n.rangeMin,n.rangeMax,n)}f.updateColors(n,n.rangeMin,n.rangeMax,f.spectrum,f.flip,f.clamped)};if(h.match(/.*.mnc|.*.nii/)){e(h,l)}else{c(m,null,l)}};f.loadSpectrumFromUrl=function(j,l){var h=l||{};var k=h.afterLoadSpectrum;var g;b(j,h,function(m){g=new Spectrum(m);f.spectrum=g;if(k){k()}if(f.afterLoadSpectrum!=null){f.afterLoadSpectrum(g)}if(f.model_data.data){f.updateColors(f.model_data.data,f.model_data.data.rangeMin,f.model_data.data.rangeMax,f.spectrum,f.flip,f.clamped)}})};f.loadSpectrumFromFile=function(j){var g;var h=f.model_data;c(j,null,function(k){g=new Spectrum(k);f.spectrum=g;if(f.afterLoadSpectrum!=null){f.afterLoadSpectrum(g)}if(h.data){f.updateColors(h.data,h.data.rangeMin,h.data.rangeMax,f.spectrum,f.flip,f.clamped)}})};f.blend=function(j){var g=f.blendData;var k=g.length;var h;g[0].alpha=j;g[1].alpha=1-j;for(h=2;h<k;h++){g[h].alpha=0}f.updateColors(g,null,null,f.spectrum,f.flip,f.clamped,true)};f.loadSeriesDataFromFile=function(l){var k=l.files.length;var j=l.files;var g;var h;f.seriesData=new Array(k);f.seriesData.numberFiles=k;for(h=0;h<k;h++){g=new FileReader();g.file=j[h];g.onloadend=(function(n,m){return function(o){console.log(o.target.result.length);console.log(m);f.seriesData[m]=new Data(o.target.result);f.seriesData[m].fileName=n.name}})(g.file,h);g.readAsText(j[h])}f.setupSeries()};f.setupSeries=function(){var j=f.model_data;var h=f.seriesData;var g=f.model_data.positionArray;$('<div id="series">Series: </div>').appendTo("#surface_choice");var k=$("#series");$('<span id="series-value">0</span>').appendTo(k);$('<div id="series-slider" width="100px" + height="10"></div>').slider({value:0,min:0,max:h.numberFiles-1,step:0.1,slide:function(l,m){if(m.value-Math.floor(m.value)<0.01){j.data=h[m.value]}else{if(h[0].fileName.match("pval.*")){j.data=new Data(interpolateDataArray(h[Math.floor(m.value)],h[Math.floor(m.value)+1],(m.value-Math.floor(m.value)),true))}else{j.data=new Data(interpolateDataArray(h[Math.floor(m.value)],h[Math.floor(m.value)+1],(m.value-Math.floor(m.value))))}}if(h[0].fileName.match("mt.*")){$("#age_series").html("Age: "+(m.value*3+5).toFixed(1))}else{if(h[0].fileName.match("pval.*")){$("#age_series").html("Age: "+(m.value*1+10))}}$(k).children("#series-value").html(m.value);if(j.data.values.length<g.length/4){console.log("Number of numbers in datafile lower than number of vertices Vertices"+g.length/3+" data values:"+j.data.values.length);return -1}a(j.data.min,j.data.max);if(f.afterLoadData!=null){f.afterLoadData(j.data.rangeMin,j.data.rangeMax,j.data)}f.updateColors(j.data,j.data.rangeMin,j.data.rangeMax,f.spectrum,f.flip,f.clamped);return null}}).appendTo(k)};f.loadBlendDataFromFile=function(n){var m=n.files.length;var l=n.files;var g;var j,h;f.blendData=new Array(m);f.blendData.numberFiles=m;for(j=0;j<m;j++){g=new FileReader();g.file=l[j];g.onloadend=(function(o,k){return function(p){f.blendData[k]=new Data(p.target.result);f.blendData.alpha=1/m;f.blendData[k].fileName=o.name;for(h=0;h<2;h++){if(f.blendData[h]==undefined){console.log("not done yet");return}}a(f.blendData[0].values.min(),f.blendData[0].values.max(),f.blendData[0]);a(f.blendData[1].values.min(),f.blendData[1].values.max(),f.blendData[1]);if(f.afterLoadData!=null){f.afterLoadData(null,null,f.blendData,true)}f.blend($(".blend_slider").slider("value"))}})(g.file,j);g.readAsText(l[j])}f.setupBlendColors()};f.rangeChange=function(k,g,l,m){var j=m||{};var h=j.afterChange;var n=f.model_data.data;n.rangeMin=k;n.rangeMax=g;f.updateColors(n,n.rangeMin,n.rangeMax,f.spectrum,f.flip,l);if(h){h()}if(f.afterRangeChange!=null){f.afterRangeChange(k,g)}};function b(h,k,l){var g=k||{};var j=g.beforeLoad;if(j){j()}jQuery.ajax({type:"GET",url:h,dataType:"text",success:function(m){l(m)},error:function(m,o,n){alert("Failure in loadFromURL: "+o)},data:{},timeout:100000})}function c(n,l,m){var k=n.files;if(k.length===0){return}var h=l||{};var j=h.beforeLoad;var g=new FileReader();g.file=k[0];if(j){j()}g.onloadend=function(o){m(o.target.result)};g.readAsText(k[0])}function e(g,k){var m;var j;var l;var h;m=new XMLHttpRequest();if(g.match(/.*.mnc/)){m.open("POST","/minc/volume_object_evaluate",false)}else{m.open("POST","/nii/volume_object_evaluate",false)}l=new FormData(document.getElementById("datafile-form"));m.send(l);var h=m.response;k(h)}function a(j,g,h){if(!h){h=f.model_data.data}if(!h.fixRange){h.rangeMin=j;h.rangeMax=g}}};BrainBrowser.modules.models=function(g){g.displayObjectFile=function(n,k,m){var l=m||{};var o=l.renderDepth;var j=l.afterDisplay;if(n.objectClass=="P"&&n.numberVertices==81924){a(n,o)}else{if(n.objectClass=="P"){c(n,k,o)}else{if(n.objectClass=="L"){d(n,k,false,o)}else{alert("Object file not supported")}}}if(g.afterDisplayObject!=undefined){g.afterDisplayObject(g.model)}if(j){j()}};function a(m,n){var j=g.model;var l,k;g.model_data=m;l=h(m.left);l.name="left";l.model_num=0;k=h(m.right);k.name="right";k.model_num=1;j.add(l);j.add(k);g.scene.add(j)}function h(n){var v=n.positionArray;var m=n.indexArray;var u={};var k={};var s;var o,p;var t,r,l,q,j;for(o=0,p=v.length;o+2<p;o+=3){e(u,v[o],v[o+1],v[o+2])}k.x=u.minX+0.5*(u.maxX-u.minX);k.y=u.minY+0.5*(u.maxY-u.minY);k.z=u.minY+0.5*(u.maxZ-u.minZ);t=new THREE.Geometry();r=t.vertices;for(o=0,p=v.length;o+2<p;o+=3){r.push(new THREE.Vector3(v[o]-k.x,v[o+1]-k.y,v[o+2]-k.z))}l=t.faces;for(o=0,p=m.length;o+2<p;o+=3){s=new THREE.Face3(m[o],m[o+1],m[o+2]);s.vertexColors=[new THREE.Color(),new THREE.Color(),new THREE.Color()];l.push(s)}t.computeFaceNormals();t.computeVertexNormals();q=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:526344,vertexColors:THREE.VertexColors});j=new THREE.Mesh(t,q);j.centroid=k;j.position.set(k.x,k.y,k.z);return j}function d(m,j,o,n){var k=g.model;var l=f(m,o);l.name=j;if(n){l.renderDepth=n}k.add(l);g.scene.add(k)}function f(z,l){var t=z;var u=[];var G=[];var w=[];var D={};var x={};var F,E,C,v;var m=t.nitems;var p;var n;var o;var B;var s=[];var r;var q,y,A;var H;g.model_data=t;for(F=0;F<m;F++){if(F===0){p=0}else{p=t.endIndicesArray[F-1]}u.push(t.indexArray[p]);n=t.indexArray;o=t.endIndicesArray[F];for(C=p+1;C<o-1;C++){u.push(n[C]);u.push(n[C])}u.push(n[o-1])}H=g.model_data.positionArray;for(E=0,v=u.length;E<v;E++){e(D,H[u[E]*3],H[u[E]*3+1],H[u[E]*3+2])}x.x=D.minX+0.5*(D.maxX-D.minX);x.y=D.minY+0.5*(D.maxY-D.minY);x.z=D.minY+0.5*(D.maxZ-D.minZ);if(!l){for(E=0,v=u.length;E<v;E++){G.push(new THREE.Vector3(H[u[E]*3]-x.x,H[u[E]*3+1]-x.y,H[u[E]*3+2]-x.z))}if(t.colorArray.length===4){for(F=0;F<numberVertices;F++){s.push(0.5,0.5,0.7,1)}}else{s=g.model_data.colorArray;for(E=0,v=u.length;E<v;E++){r=new THREE.Color();r.setRGB(s[u[E]*4],s[u[E]*4+1],s[u[E]*4+2]);w.push(r)}}}else{G=g.model_data.meshPositionArray;w=g.model_data.meshColorArray}q=new THREE.Geometry();q.vertices=G;q.colors=w;q.colorsNeedUpdate=true;y=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});A=new THREE.Line(q,y,THREE.LinePieces);A.position.set(x.x,x.y,x.z);A.centroid=x;return A}function c(m,j,l){var o=g.model;var q;var n,p;var r=m;var k=r.shapes;g.model_data=r;if(k){for(n=0,p=k.length;n<p;n++){q=b(g.model_data.shapes[n]);q.name=g.model_data.shapes[n].name;o.add(q)}}else{q=b(g.model_data);q.name=j;o.add(q)}if(g.afterCreate!=undefined){g.afterCreate(g.model_data)}g.scene.add(o)}function b(p){var k=p.positionArray;var m=p.indexArray;var o=[];var y=p.colorArray;var B,A,s;var r;var n=false;var q,z,D;var w=[];var u;var l;var C=p.faces;var t;var v;var x;if(y.length==4){n=true;r=new THREE.Color();r.setRGB(y[0],y[1],y[2])}w=[];q=new THREE.Geometry();for(B=0,s=k.length/3;B<s;B++){q.vertices.push(new THREE.Vector3(k[B*3],k[B*3+1],k[B*3+2]));if(!n){r=new THREE.Color();r.setRGB(y[B*4],y[B*4+1],y[B*4+2])}w.push(r)}l=q.faces;if(C&&C.length>0){t=C.length;for(B=0;B<t;B++){v=C[B];x=v.length;if(x<3){continue}if(x<=4){if(x<=3){u=new THREE.Face3(v[0],v[1],v[2])}else{if(x===4){u=new THREE.Face4(v[0],v[1],v[2],v[3])}}u.vertexColors=[w[u.a],w[u.b],w[u.c]];if(x>3){u.vertexColors[3]=w[u.d]}l.push(u)}else{for(A=1;A+1<x;A++){u=new THREE.Face3(v[0],v[A],v[A+1]);u.vertexColors=[w[u.a],w[u.b],w[u.c]];l.push(u)}}}}else{for(B=0;B+2<m.length;B+=3){u=new THREE.Face3(m[B],m[B+1],m[B+2]);u.vertexColors[0]=w[u.a];u.vertexColors[1]=w[u.b];u.vertexColors[2]=w[u.c];q.faces.push(u)}}q.computeFaceNormals();q.computeVertexNormals();q.colorsNeedUpdate=true;z=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:526344,vertexColors:THREE.VertexColors});D=new THREE.Mesh(q,z);if(g.loading){$(g.loading).html("Buffers Loaded")}return D}g.changeShapeTransparency=function(l,m){var j=g.model.getChildByName(l);var k;if(j){k=j.material;k.opacity=m;if(m===1){k.transparent=false}else{k.transparent=true}}};function e(k,j,m,l){if(!k.minX||k.minX>j){k.minX=j}if(!k.maxX||k.maxX<j){k.maxX=j}if(!k.minY||k.minY>m){k.minY=m}if(!k.maxY||k.maxY<m){k.maxY=m}if(!k.minZ||k.minZ>l){k.minZ=l}if(!k.maxZ||k.maxZ<l){k.maxZ=l}}};BrainBrowser.modules.picking=function(a){a.click=function(k,g){var p=a.view_window;var l=a.camera;var h=p.offset();var n=new THREE.Projector();var m=new THREE.Raycaster();var f=((k.clientX-h.left+$(window).scrollLeft())/p.width())*2-1;var d=-((k.clientY-h.top+$(window).scrollTop())/p.height())*2+1;var c=new THREE.Vector3(f,d,1);var j,b,o;n.unprojectVector(c,l);m.set(l.position,c.sub(l.position).normalize());j=m.intersectObject(a.model,true);if(j.length>0){b=j[0];o={vertex:b.face.a,point:new THREE.Vector3(b.point.x,b.point.y,b.point.z),object:b.object};return g(k,o)}else{$(a.pickInfoElem).html("--nothing--");return false}}};BrainBrowser.core.rendering=function(e){var f;var d;var b;var k;var g;var a;var l;var c;e.model=new THREE.Object3D();e.scene=new THREE.Scene();e.camera=new THREE.PerspectiveCamera(30,e.view_window.width()/e.view_window.height(),0.1,5000);e.render=function(){var m=e.view_window;f=new THREE.WebGLRenderer({clearColor:8947848,clearAlpha:1,preserveDrawingBuffer:true});f.setSize(m.width(),m.height());l=f;c=new THREE.AnaglyphEffect(f);c.setSize(m.width(),m.height());m.append(f.domElement);e.camera.position.z=500;d=new THREE.PointLight(16777215);d.position.x=0;d.position.y=0;d.position.z=500;e.scene.add(d);b=new THREE.TrackballControls(e.camera,m[0]);k=new THREE.TrackballControls(d,m[0]);b.zoomSpeed=2;k.zoomSpeed=2;window.onresize=function(){l.setSize(m.width(),m.height());e.camera.aspect=m.width()/m.height();e.camera.updateProjectionMatrix()};window.onresize();j()};e.anaglyphEffect=function(){l=c};e.noEffect=function(){l=f};e.setCamera=function(m,o,n){e.camera.position.set(m,o,n)};e.resetView=function(){var m=e.model;var p;var n,o;b.reset();k.reset();m.position.set(0,0,0);m.rotation.set(0,0,0);for(n=0,o=e.model.children.length;n<o;n++){p=m.children[n];p.visible=true;if(p.centroid){p.position.set(p.centroid.x,p.centroid.y,p.centroid.z)}else{p.position.set(0,0,0)}p.rotation.set(0,0,0)}};e.clearScreen=function(){if(e.model){e.scene.remove(e.model)}e.resetView();e.model=new THREE.Object3D();if(e.afterClearScreen!=undefined){e.afterClearScreen()}};e.updateClearColor=function(m){f.setClearColor(new THREE.Color(m))};e.updateClearColorFromName=function(m){if(m=="white"){e.updateClearColor(16777215)}else{if(m=="black"){e.updateClearColor(0)}else{if(m=="pink"){e.updateClearColor(16711935)}else{e.updateClearColor(8947848)}}}};e.set_fill_mode_wireframe=function(){var n=e.model.children;var o;for(var m=0;m<n.length;m++){o=n[m].material;o.wireframe=true;if(o.emissive){o.emissive.setHex(125269879)}}};e.set_fill_mode_solid=function(){var n=e.model.children;var o;for(var m=0;m<n.length;m++){o=n[m].material;o.wireframe=false;if(o.emissive){o.emissive.setHex(0)}}};e.ZoomInOut=function(m){e.camera.fov*=m;e.camera.updateProjectionMatrix()};function j(o){var m=e.model;var p;var n;requestAnimationFrame(j);a=g||o;g=o;b.update();k.update();p=g-a;n=p*0.00015;if(e.autoRotate){if(e.autoRotate.x){m.rotation.x+=n}if(e.autoRotate.y){m.rotation.y+=n}if(e.autoRotate.z){m.rotation.z+=n}}l.render(e.scene,e.camera)}function h(m,r,q){var p=new THREE.SphereGeometry(2);var o=new THREE.MeshBasicMaterial({color:16711680});var n=new THREE.Mesh(p,o);n.position.set(m,r,q);e.scene.add(n)}};BrainBrowser.plugins.ui=function(c){var b=document;c.keyPressedCallback=function(e){var d=false;switch(e.which){case 38:c.ZoomInOut(1/1.1);d=true;break;case 40:c.ZoomInOut(1.1);d=true;break;case 32:c.separateHemispheres();d=true;break}return !d};c.setupBlendColors=function(){console.log("Blend colors has run "+c.blendData.numberFiles);$("#blend").remove();$('<div id="blend">Blend ratios: </div>').appendTo("#surface_choice");var d=$("#blend");$('<span id="blend_value'+i+'">0</span>').appendTo(d);$('<div class="blend_slider" id="blend_slider'+i+'" width="100px" + height="10"></div>').slider({value:0,min:0.1,max:0.99,value:0.5,step:0.01,slide:function(e,f){c.blend($(this).slider("value"))}}).appendTo(d)};c.getImageUrl=function(){var g=b.createElement("canvas");var d=b.getElementById("spectrum_canvas");var h=g.getContext("2d");var e=new Image();g.width=view_window.width();g.height=view_window.height();function f(){var j=new Image();j.onload=function(){h.drawImage(j,0,0);window.open(g.toDataURL(),"screenshot")};j.src=d.toDataURL()}e.onload=function(){h.drawImage(e,0,0);if(d){f()}else{window.open(g.toDataURL(),"screenshot")}};e.src=renderer.domElement.toDataURL()};c.getViewParams=function(){return{view:$("[name=hem_view]:checked").val(),left:$("#left_hem_visible").is(":checked"),right:$("#right_hem_visible").is(":checked")}};function a(d){if($("#autorotate").is(":checked")){c.autoRotate={};c.autoRotate.x=$("#autorotateX").is(":checked");c.autoRotate.y=$("#autorotateY").is(":checked");c.autoRotate.z=$("#autorotateZ").is(":checked")}else{c.autoRotate=false}}$("body").keydown(c.keyPressedCallback);$("#clear_color").change(function(f){var d=$(f.target).val();c.updateClearColorFromName(d)});$("#resetview").click(c.setupView);$(".view_button").change(c.setupView);$("[name=hem_view]").change(c.setupView);$("#meshmode").change(function(d){if($(d.target).is(":checked")){c.set_fill_mode_wireframe()}else{c.set_fill_mode_solid()}});$("#threedee").change(function(d){if($(d.target).is(":checked")){c.anaglyphEffect()}else{c.noEffect()}});$("#openImage").click(function(d){c.getImageUrl()});$("#autorotate-controls").children().change(a);$("#autorotate").change(a)};BrainBrowser.modules.views=function(b){b.setupView=function(c){var d=b.getViewParams();b.resetView();if(b.model_data&&b.model_data.num_hemispheres===2){switch(d.view){case"superior":b.superiorView();break;case"medial":b.medialView();break;case"anterior":b.anteriorView();break;case"inferior":b.inferiorView();break;case"lateral":b.lateralView();break;case"posterior":b.posteriorView();break;default:b.superiorView();break}}if(b.model.getChildByName("left")){if(d.left){b.leftHemisphereVisible(true)}else{b.leftHemisphereVisible(false)}}if(b.model.getChildByName("right")){if(d.right){b.rightHemisphereVisible(true)}else{b.rightHemisphereVisible(false)}}};b.leftHemisphereVisible=function(c){b.model.getChildByName("left").visible=c};b.rightHemisphereVisible=function(c){b.model.getChildByName("right").visible=c};b.getInfoForVertex=function(d){var c=b.model_data.getVertexInfo(d);var e={vertex:c.vertex,point:new THREE.Vector3(c.position_vector[0],c.position_vector[1],c.position_vector[2])};return e};b.medialView=function(d){var c=b.model;if(b.model_data.num_hemispheres==2){c.getChildByName("left").position.x-=100;c.getChildByName("left").rotation.z-=a(90);c.getChildByName("right").position.x+=100;c.getChildByName("right").rotation.z+=a(90);c.rotation.x+=a(-90)}};b.lateralView=function(g){var c=b.model;var f,d;if(b.model_data.num_hemispheres==2){f=c.getChildByName("left");d=c.getChildByName("right");f.position.x-=100;f.rotation.z+=a(-90);d.position.x+=100;d.rotation.z+=a(90);c.rotation.x+=a(90);c.rotation.y+=a(180)}};b.superiorView=function(){};b.inferiorView=function(){b.model.rotation.y+=a(180)};b.anteriorView=function(c){b.resetView();b.model.rotation.x+=a(-90);b.model.rotation.z+=a(180)};b.posteriorView=function(c){b.resetView();b.model.rotation.x+=a(-90)};b.separateHemispheres=function(c){if(b.model_data.num_hemispheres==2){b.model.children[0].position.x-=1;b.model.children[1].position.x+=1}};function a(c){return c*Math.PI/180}};function MacaccObject(b,g,h){var d=this;this.brainbrowser=b;this.dataSet=new Dataset(g,h);d.debugLineGroup;d.debugLine;d.selectedInfo=null;d.treeInfo;d.pickInfoElem;d.flashTimer=0;d.highlightMaterial;d.highlightShape;d.vertex;d.positionVector;d.primitiveIndex;d.dataArray;d.data_max;d.data_min;d.range_max;d.range_min;d.spectrum;d.coordinates=$("#coordinates");d.selectPoint=null;function c(l,k){var j=l.vertex;if(j!=undefined&&k!=undefined){$("#x-coord").val(l.point.x);$("#y-coord").val(l.point.y);$("#z-coord").val(l.point.z);$("#v-coord").val(j);$("#value-coord").val(k)}}this.pickClick=function(j,k){d.vertex=k.vertex;if(k.object&&k.object.model_num){d.vertex+=k.object.model_num*k.object.geometry.vertices.length}if(d.vertex){f();c(k,0);if(b.secondWindow!=undefined&&true){b.secondWindow.postMessage(d.vertex,"*")}}else{$(d.pickInfoElem).html("--nothing--")}};this.change_model=function(l,j){var k=$(l.target).val();j.format="MNIObject";b.clearScreen();b.loadModelFromUrl("/data/surfaces/surf_reg_model_both_"+k+".obj",j)};this.flipXCoordinate=function(){if(!d.dataArray){return}if(d.vertex>d.dataArray.length/2){d.vertex-=d.dataArray.length/2}else{d.vertex+=d.dataArray.length/2}c(b.getInfoForVertex(d.vertex),0);f()};this.valueAtPoint=function(k,l){var j=d.dataArray[l.vertex];c(l,j)};function a(){var l=$("[name=modality]:checked").val();var k=$("#data-sk").val();var j=$("[name=statistic]:checked").val();return{modality:l,sk:k,statistic:j}}this.update_model=function(l){var k;var j;d.dataArray=l.current_data.values;b.current_dataset=l;if($("#fix_range").is(":checked")){if(!(d.data_min=parseFloat($("#data-range-min").val()))){if(!d.data_min===0){d.data_min=l.current_data.min}}if(!(d.data_max=parseFloat($("#data-range-max").val()))){if(!d.data_max===0){d.data_max=l.current_data.max}}}else{if(a().statistic=="T"){d.data_min=l.current_data.min;d.data_max=l.current_data.max}}k=$("#flip_range").is(":checked");j=$("#clamp_range").is(":checked");if(a().statistic=="T"){d.flipRange=k;b.updateColors(d.dataSet.current_data,d.data_min,d.data_max,b.spectrum,k,j)}else{d.flipRange=!k;$("#range-slider").slider("option","min","0");$("#range-slider").slider("option","max","1");b.updateColors(d.dataSet.current_data,0,1,b.spectrum,!k,j)}};function f(){d.dataSet.get_data(d.vertex,a(),d.update_model);$(d.pickInfoElem).html("Viewing data for vertex: "+d.vertex)}this.show_atlas=function(){b.loadDataFromUrl("/assets/aal_atlas.txt")};function e(k,j){if(!$("#fix_range").is(":checked")){$("#data-range-min").val(k);$("#data-range-max").val(j);$("#range-slider").slider("values",0,k);$("#range-slider").slider("values",1,j)}if(d.afterRangeChange!=undefined){d.afterRangeChange(k,j)}}this.range_change=function(){var k=parseFloat($("#data-range-min").val());var j=parseFloat($("#data-range-max").val());b.updateColors(d.dataSet.current_data,k,j,b.spectrum,$("#flip_range").is(":checked"),$("#clamp_range").is(":checked"));if(d.afterRangeChange!=undefined){d.afterRangeChange(k,j)}};this.data_control_change=function(){var j=a();if(j.modality=="AAL"){d.show_atlas()}else{if(d.vertex){f()}}};b.loadSpectrumFromUrl("/assets/spectral_spectrum.txt");b.valueAtPointCallback=this.valueAtPoint;b.clickCallback=this.pickClick}function initMacacc(a,c){var b;BrainBrowser(function(d){d.afterLoadSpectrum=function(e){var f=e.createSpectrumCanvasWithScale(0,5,null,false);$("#spectrum").html($(f));d.spectrumObj=e};d.loadModelFromUrl("/models/surf_reg_model_both.obj",{format:"MNIObject",afterDisplay:function(){$("#loading").hide();b=new MacaccObject(d,a,c);d.afterCreateBrain=function(){if(d.current_dataset!=undefined){b.update_model(d.current_dataset)}};b.afterRangeChange=function(g,e){if(b.flipRange){var f=d.spectrumObj.createSpectrumCanvasWithScale(g,e,null,true)}else{var f=d.spectrumObj.createSpectrumCanvasWithScale(g,e,null,false)}$("#spectrum").html($(f))};$(".data_controls").change(b.data_control_change);b.pickInfoElem=$("#vertex_info");$("#x-coord-flip").click(b.flipXCoordinate);$("#model").change(function(e){$("#loading").show();b.change_model(e,{afterDisplay:function(){$("#loading").hide()}})})}});$("#range-slider").slider({range:true,min:-10,max:15,values:[0,5],slide:function(e,f){$("#data-range-min").val(f.values[0]);$("#data-range-max").val(f.values[1]);if(d.current_dataset){b.range_change()}},step:0.1});$(".range-box").keypress(function(f){if(f.keyCode=="13"){b.range_change(f)}});$("#data-range-min").change(function(f){$("#range-slider").slider("values",0,$(this).val());b.afterRangeChange(parseFloat($("#data-range-min").val()),parseFloat($("#data-range-max").val()))});$("#data-range-max").change(function(f){$("#range-slider").slider("values",1,$(this).val());b.afterRangeChange(parseFloat($("#data-range-min").val()),parseFloat($("#data-range-max").val()))});$("[name=pointer]").change(function(f){if($("[name=pointer]:checked").val()=="AAL_atlas"){b.show_atlas()}});$("#screenshot").click(function(e){$(this).attr("href",d.client.toDataUR())});$("#brainbrowser").mousedown(function(f){var g=$("[name=pointer]:checked").val();if(f.ctrlKey||g=="check"){if(d.valueAtPointCallback){d.click(f,d.valueAtPointCallback)}}else{if(f.shiftKey||g=="select"){if(d.clickCallback){d.click(f,d.clickCallback)}}}});$("#flip_range").change(function(f){b.update_model(d.current_dataset)});$("#clamp_range").change(function(f){b.update_model(d.current_dataset)});$("#flip_correlation").click(function(h){var g=-1*parseFloat($("#data-range-max").val());var f=-1*parseFloat($("#data-range-min").val());$("#data-range-min").val(g).change();$("#data-range-max").val(f).change();$("#flip_range").attr("checked",!$("#flip_range").attr("checked")).change()});$("#secondWindow").click(function(f){d.secondWindow=window.open("/macacc.html","secondWindow")});window.addEventListener("message",function(h){var g=parseInt(h.data);var f=[d.model_data.positionArray[g*3],d.model_data.positionArray[g*3+1],d.model_data.positionArray[g*3+2]];b.pickClick(h,{position_vector:f,vertex:g,stop:true,})},false);if(window.opener!=null){d.secondWindow=window.opener}})}BrainBrowser.filetypes.MNIObject=function(d){var j;var g=this;function b(m){var l=m.replace(/\s+$/,"");var n=l.replace(/^\s+/,"");g.num_hemispheres=1;j=n.split(/\s+/).reverse();g.objectClass=j.pop();if(g.objectClass==="P"){e();g.numberVertices=parseInt(j.pop());f();k();g.nitems=parseInt(j.pop())}else{if(g.objectClass==="L"){e();g.numberVertices=parseInt(j.pop());f();g.nitems=parseInt(j.pop())}else{g.objectClass="__FAIL__";return}}h();c();a();if(g.objectClass=="P"){if(g.positionArray.length==81924*3){g.brainSurface=true;g.split_hemispheres()}}}function e(){if(g.objectClass=="P"){g.surfaceProperties={ambient:parseFloat(j.pop()),diffuse:parseFloat(j.pop()),specular_reflectance:parseFloat(j.pop()),specular_scattering:parseFloat(j.pop()),transparency:parseFloat(j.pop())}}else{if(g.objectClass=="L"){g.surfaceProperties={width:j.pop()}}}}function f(){var m=[];var l=g.numberVertices;var n,o;for(n=0;n<l;n++){for(o=0;o<3;o++){m.push(parseFloat(j.pop()))}}g.positionArray=m}function k(){var o=[];var l=g.numberVertices;var p,m;for(p=0;p<l;p++){for(m=0;m<3;m++){o.push(parseFloat(j.pop()))}}g.normalArray=o}function h(){var n=[];var o=parseInt(j.pop(),10);var l,p,m;if(o===0){for(l=0;l<4;l++){n.push(parseFloat(j.pop()))}}else{if(o===1){for(p=0,m=g.numberPolygons;p<m;p++){for(l=0;l<4;l++){n.push(parseFloat(j.pop()))}}}else{if(o===2){for(p=0,m=g.numberVertices;p<m;p++){for(l=0;l<4;l++){n.push(parseFloat(j.pop()))}}}else{throw new Error("colorFlag not valid in that file")}}}g.colorFlag=o;g.colorArray=n}function c(){var l=g.nitems;var n=g.endIndicesArray;var n=[];var o,m;for(o=0,m=g.nitems;o<m;o++){n.push(parseInt(j.pop(),10))}g.endIndicesArray=n}function a(){var o=j.length;var m=[];var l;var n,p;for(n=0,p=j.length;n<o;n++){l=parseInt(j.pop(),10);m.push(l)}g.indexArray=m}g.split_hemispheres=function(){var n={};var t={};var u;var m;var l,p,o,s;var q,r;l=g.positionArray.length;n.positionArray=g.positionArray.slice(0,l/2);t.positionArray=g.positionArray.slice(l/2,l);p=g.indexArray.length;n.indexArray=g.indexArray.slice(0,p/2);t.indexArray=g.indexArray.slice(p/2,p);u=t.indexArray;m=p/3/2/2;for(q=0,r=u.length;q<r;q++){u[q]=u[q]-2-m}o=g.normalArray.length;n.normalArray=g.normalArray.slice(0,o/2);t.normalArray=g.normalArray.slice(o/2,o);n.colorFlag=g.colorFlag;t.colorFlag=g.colorFlag;if(g.colorFlag===0||g.colorFlag===1){n.colorArray=g.colorArray;t.colorArray=g.colorArray}else{s=g.colorArray.length;n.colorArray=g.colorArray.slice(0,s/2);t.colorArray=g.colorArray.slice(s/2+1,-1)}n.numberVertices=g.numberVertices/2;t.numberVertices=g.numberVertices/2;n.numberPolygons=g.numberPolygons/2;t.numberPolygons=g.numberPolygons/2;g.num_hemispheres=2;g.left=n;g.right=t};g.getVertexInfo=function(m){var l=[g.positionArray[m*3],g.positionArray[m*3+1],g.positionArray[m*3+2]];return{vertex:m,position_vector:l}};if(d){b(d)}};