Array.prototype.min=function(){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.min.apply(Math,this.slice(c,c+b-1)))}}else{return Math.min.apply(Math,this)}return a.min()};Array.prototype.max=function(d){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.max.apply(Math,this.slice(c,c+b-1)))}}else{return Math.max.apply(Math,this)}return a.max()};function cloneArray(b){var c=new Array(b.length);for(var a=0;a<c.length;a++){c[a]=b[a]}return c}function rotateUint16Array90Left(f,d,a){var e=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){e[c*a+b]=f[b*d+(d-c)]}}return e}function rotateUint16Array90Right(f,d,a){var e=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){e[c*a+b]=f[(a-b)*d+c]}}return e}function interpolateDataArray(g,c,b,a){console.log(g.values.length);var e=g.values.length;var f=new Array(e);console.log("Percentage: "+b);for(var d=0;d<e;d++){if(a){f[d]=(g.values[d]*(100-b*100)+c.values[d]*(b*100))/100}else{f[d]=(g.values[d]*(100-b*100)+c.values[d]*(b*100))/100}}console.log(f.length);return f}function WavefrontObj(m){var j=this;m=m.split("\n");j.shapes=[];var b;var c=[];var t=[];var r=[];b={name:m.name|"undefined",faces:[],positionArray:[],colorArray:[],indexArray:[],texIndexArray:[],normalIndexArray:[]};j.shapes.push(b);for(var o=0;o<m.length;o++){var u=m[o].split(/\s+/);if(!(u[0].match("#"))||u==""){if(u[0]=="o"|u[0]=="g"){console.log(u[1]);b={name:u[1],faces:[],positionArray:[],colorArray:[],indexArray:[],texIndexArray:[],normalIndexArray:[]};j.shapes.push(b)}else{if(u[0]=="v"){c.push(parseFloat(u[1]));c.push(parseFloat(u[2]));c.push(parseFloat(u[3]))}else{if(u[0]=="vt"){for(var e=1;e<u.length;e++){t.push(parseFloat(u[e]))}}else{if(u[0]=="vn"){r.push(parseFloat(u[1]));r.push(parseFloat(u[2]));r.push(parseFloat(u[3]))}else{if(u[0]=="f"){var s=[];for(var h=1;h<4;h++){var f=u[h].split("/");s.push(parseInt(f[0])-1);b.indexArray.push(parseInt(f[0])-1);b.texIndexArray.push(parseInt(f[1])-1);if(f[2]){b.normalIndexArray.push(parseInt(f[2])-1)}}if(u.length>=4){for(h;h<u.length;h++){var f=u[h].split("/");s.push(parseInt(f[0])-1);var p=b.indexArray.length;b.indexArray.push(b.indexArray[p-1]);b.indexArray.push(b.indexArray[p-3]);b.indexArray.push(f[0]-1)}}b.faces.push(s)}}}}}}}var a=Array(c.length/3);var d=j.shapes.length;for(var g=0;g<d;g++){var q=j.shapes[g];q.positionArray=c;if(q.colorArray.length==0){q.colorArray=[0.8,0.8,0.8,1]}}j.objectClass="P";j.vertexArray=c;j.texCoordArray=t}function MNIObject(d){var j;var g=this;function b(m){g.num_hemispheres=1;var l=m.replace(/\s+$/,"");var n=l.replace(/^\s+/,"");j=n.split(/\s+/).reverse();g.objectClass=j.pop();if(g.objectClass=="P"){e();g.numberVertices=parseInt(j.pop());f();k();g.nitems=parseInt(j.pop())}else{if(g.objectClass=="L"){e();g.numberVertices=parseInt(j.pop());f();g.nitems=parseInt(j.pop())}else{throw new Error("That object class is not supported currently")}}h();c();a();if(g.objectClass=="P"){if(g.positionArray.length==81924*3){g.brainSurface=true;g.split_hemispheres()}}}function e(){if(g.objectClass=="P"){g.surfaceProperties={ambient:parseFloat(j.pop()),diffuse:parseFloat(j.pop()),specular_reflectance:parseFloat(j.pop()),specular_scattering:parseFloat(j.pop()),transparency:parseFloat(j.pop())}}else{if(g.objectClass=="L"){g.surfaceProperties={width:j.pop()}}}}function f(){g.positionArray=new Array();for(var l=0;l<g.numberVertices;l++){for(var m=0;m<3;m++){g.positionArray.push(parseFloat(j.pop()))}}}function k(){g.normalArray=new Array();for(var m=0;m<g.numberVertices;m++){for(var l=0;l<3;l++){g.normalArray.push(parseFloat(j.pop()))}}}function h(){g.colorFlag=parseInt(j.pop());g.colorArray=new Array();if(g.colorFlag===0){for(var l=0;l<4;l++){g.colorArray.push(parseFloat(j.pop()))}}else{if(g.colorFlag===1){for(var m=0;m<g.numberPolygons;m++){for(var l=0;l<4;l++){g.colorArray.push(parseFloat(j.pop()))}}}else{if(g.colorFlag===2){for(var m=0;m<g.numberVertices;m++){for(var l=0;l<4;l++){g.colorArray.push(parseFloat(j.pop()))}}}else{throw new Error("colorFlag not valid in that file")}}}}function c(){g.endIndicesArray=new Array();for(var l=0;l<g.nitems;l++){g.endIndicesArray.push(parseInt(j.pop()))}}function a(){g.indexArray=new Array();var m=j.length;for(var l=0;l<m;l++){g.indexArray.push(parseInt(j.pop()))}}g.split_hemispheres=function(){g.left={};g.right={};var p=g.positionArray.length;g.left.positionArray=g.positionArray.slice(0,p/2);g.right.positionArray=g.positionArray.slice(p/2,p);var o=g.indexArray.length;g.left.indexArray=g.indexArray.slice(0,o/2);g.right.indexArray=g.indexArray.slice(o/2,o);for(var l=0;l<g.right.indexArray.length;l++){g.right.indexArray[l]=g.right.indexArray[l]-2-o/3/2/2}var m=g.normalArray.length;g.left.normalArray=g.normalArray.slice(0,m/2);g.right.normalArray=g.normalArray.slice(m/2,m);g.left.colorFlag=g.colorFlag;g.right.colorFlag=g.colorFlag;if(g.colorFlag==0||g.colorFlag==1){g.left.colorArray=g.colorArray;g.right.colorArray=g.colorArray}else{var n=g.colorArray.length;g.left.colorArray=g.colorArray.slice(0,n/2);g.right.colorArray=g.colorArray.slice(n/2+1,-1)}g.left.numberVertices=g.numberVertices/2;g.right.numberVertices=g.numberVertices/2;g.left.numberPolygons=g.numberPolygons/2;g.right.numberPolygons=g.numberPolygons/2;g.num_hemispheres=2};g.getVertexInfo=function(m){var l=[g.positionArray[m*3],g.positionArray[m*3+1],g.positionArray[m*3+2]];return{vertex:m,position_vector:l}};g.get_vertex=function(v,s,l){if(g.num_hemispheres>1){var r=g[l];var o=0;if(l=="right"){o=2+r.indexArray.length/3/2}}else{var r=g;var o=0}var q=new Array();var y=v*3;for(var p=0;p<3;p++){q.push(r.indexArray[y+p])}var w=new Array();for(var p=0;p<3;p++){var u=q[p]*3;w[p]=new Array();for(var n=0;n<3;n++){w[p][n]=r.positionArray[u+n]}}var x=new Array();for(var p=0;p<3;p++){x.push(o3djs.math.distance(s,w[p]))}var m=0;if(x[1]<x[0]){m=1}if(x[2]<x[m]){m=2}var t=q[m]+o;var z=w[m];return{vertex:t,position_vector:z}};if(d){b(d)}}function ColorManager(){function c(l,d,p,h,n,k,m,g,f){var l=l.colors;var o=((n-h)+(n-h)/l.length)/l.length;for(var j=0;j<p.length;j++){if(p[j]<=h){var q=0}else{if(p[j]>n){var q=l.length-1}else{var q=parseInt((p[j]-h)/o)}}if(k){var e=255}else{var e=1}d[j*4+0]=e*l[q][0]*g+m*e;d[j*4+1]=e*l[q][1]*g+m*e;d[j*4+2]=e*l[q][2]*g+m*e;if(f){d[j*4+3]=e*f}else{d[j*4+3]=e}}return d}this.createColorMap=c;function a(k){var d=k[0];for(var g=0;g<k[0].length/4;g++){for(var f=1;f<k.length;f++){var e=d[g*4+3];var h=k[f][g*4+3];d[g*4]=d[g*4]*e+k[f][g*4]*h;d[g*4+1]=d[g*4+1]*e+k[f][g*4+1]*h;d[g*4+2]=d[g*4+2]*e+k[f][g*4+2]*h;d[g*4+3]=e+h}}return d}this.blendColors=a;function b(e,l,j,g){var d=l.length;var k=new Array(d);var h=0;for(var f=0;f<d;f++){k[f]=c(e,new Array(l[f].values.length),l[f].values,l[f].rangeMin,l[f].rangeMax,false,0,1,l[f].alpha)}return a(k)}this.blendColorMap=b}function Spectrum(e){var c=this;var a=new ColorManager();function b(f,p,h,o){var j=document.createElement("canvas");jQuery(j).attr("width",256);jQuery(j).attr("height",h);var l=new Array(256);for(var n=0;n<256;n++){if(o){l[255-n]=n}else{l[n]=n}}f=a.createColorMap(c,[],l,0,255,true,0,1);var g=j.getContext("2d");for(var m=0;m<256;m++){g.fillStyle="rgb("+parseInt(f[m*4])+","+parseInt(f[m*4+1])+","+parseInt(f[m*4+2])+")";g.fillRect(m,0,1,p)}console.log("rgb("+parseInt(f[100*4+0])+","+parseInt(f[100*4+1])+","+parseInt(f[100*4+2]));console.log(g.fillStyle);return j}c.createSpectrumCanvas=function(f){if(f==null){f=c.colors}var g=b(f,20,20,false);return g};c.createSpectrumCanvasWithScale=function(k,f,g,l){if(g==null){g=c.colors}var h=b(g,20,40,l);var j=h.getContext("2d");j.fillStyle="#FFA000";j.fillRect(0.5,20,1,10);j.fillText(k.toPrecision(3),0.5,40);j.fillRect(h.width/4,20,1,10);j.fillText(((k+f)/4).toPrecision(3),h.width/4,40);j.fillRect(h.width/2,20,1,10);j.fillText(((k+f)/2).toPrecision(3),h.width/2,40);j.fillRect(3*(h.width/4),20,1,10);j.fillText((3*((k+f)/4)).toPrecision(3),3*(h.width/4),40);j.fillRect(h.width-0.5,20,1,10);j.fillText(f.toPrecision(3),h.width-20,40);return h};function d(m){m=m.replace(/\s+$/,"");m=m.replace(/^\s+/,"");var j=m.split(/\n/);var f=new Array();for(var h=0;h<j.length;h++){var l=j[h].replace(/\s+$/,"").split(/\s+/);for(var g=0;g<l.length;g++){l[g]=parseFloat(l[g])}if(l.length<4){l.push(1)}f.push(l)}c.colors=f;return f}if(e!=undefined){d(e)}}function Data(b){var a=this;a.parse=function(c){c=c.replace(/\s+$/,"");c=c.replace(/^\s+/,"");a.values=c.split(/\s+/);for(var d=0;d<a.values.length;d++){a.values[d]=parseFloat(a.values[d])}a.min=a.values.min();a.max=a.values.max()};this.createColorArray=function(f,n,m,h,q,d,k){var m=m.colors;var p=new Array();var o=((n-f)+(n-f)/m.length)/m.length;for(var g=0;g<a.values.length;g++){if(a.values[g]<=f){if(a.values[g]<f&&!q){var r=-1}else{var r=0}}else{if(a.values[g]>n){if(!q){var r=-1}else{var r=m.length-1}}else{var r=parseInt((a.values[g]-f)/o)}}if(h&&r!=-1){p.push.apply(p,m[m.length-1-r])}else{if(r==-1){if(d.length==4){p.push.apply(p,d)}else{p.push.apply(p,[d[g*4],d[g*4+1],d[g*4+2],d[g*4+3]])}}else{p.push.apply(p,m[r])}}}if(k.num_hemisphere!=2){var l=[];var c=k.indexArray.length;for(var e=0;e<c;e++){l[e*4]=p[k.indexArray[e]*4];l[e*4+1]=p[k.indexArray[e]*4+1];l[e*4+2]=p[k.indexArray[e]*4+2];l[e*4+3]=p[k.indexArray[e]*4+3]}p.nonIndexedColorArray=l}return p};if(b){if(typeof b=="string"){a.parse(b)}else{if(b.values!=undefined){this.values=cloneArray(b.values);this.min=this.values.min();this.max=this.values.max()}else{console.log("copying data length: "+b.length);this.values=b;this.min=b.min();this.max=b.max()}}}}function Dataset(a,b){if(b==null){this.path=function(g,f){var d="ICBM152_"+f.sk;if(f.modality=="CT"){var c="ICBM152_"+f.modality+"_MACACC_mean"}else{var c="ICBM152_"+f.modality+"_MACACC_size"}if(f.statistic=="T"){var e="T_map/T_"}else{if(f.statistic=="P1"){var e="RTF_C_map/RTF_C_"}else{if(f.statistic=="P2"){var e="RTF_V_map/RTF_V_"}}}if(a==null){a="/data/"}return a+c+"/"+d+"/"+e+g+".txt"}}else{this.path=function(d,c){return a}}this.get_data=function(f,c,h){if(f=="aal_atlas"){var g="/assets/aal_atlas.txt"}else{var g=this.path(f,c)}if(b){var e={vertex:f,modality:c.modality,sk:c.sk,statistic:c.statistic}}var d=this;jQuery.ajax({type:"GET",url:g,data:e,dataType:"text",success:function(j){d.current_data=new Data(j);h(d)},error:function(){jQuery(g_pickInfoElem).html("Error loading map")}})}}function bbObject(a){var b=a;b.createBrain=function(d,c){b.model_data=d;if(d.num_hemispheres==2){var e={left:b.createHemisphere(d.left,"left"),right:b.createHemisphere(d.right,"right"),num_hemisphere:2}}else{var e=b.createHemisphere(d,"filename");e.num_hemisphere=1}if(b.brainTransform==null){b.brainTransform=b.pack.createObject("Transform");if(d.num_hemispheres==2){b.brainHemisphereTransforms={};b.brainHemisphereTransforms.left=b.pack.createObject("Transform");b.brainHemisphereTransforms.right=b.pack.createObject("Transform")}}else{b.brainTransform.removeShape(b.brainTransform.shapes[0]);if(b.brainTransform.children[0]!=null){b.brainTransform.children[0].removeShape(b.brainTransform.children[0].shapes[0])}if(b.brainTransform.children[1]!=null){b.brainTransform.children[1].removeShape(b.brainTransform.children[1].shapes[0])}}if(d.num_hemispheres!=2){b.brainTransform.removeParam(b.brainTransform.children[0]);b.brainTransform.removeParam(b.brainTransform.children[1])}if(d.num_hemispheres==2&&b.brainHemisphereTransforms==null){b.brainHemisphereTransforms={};b.brainHemisphereTransforms.left=b.pack.createObject("Transform");b.brainHemisphereTransforms.right=b.pack.createObject("Transform")}b.brainTransform.parent=b.client.root;if(e.num_hemisphere==1){b.brainTransform.addShape(e);e.createDrawElements(b.pack,null)}else{b.brainHemisphereTransforms.left.parent=b.brainTransform;b.brainHemisphereTransforms.right.parent=b.brainTransform;b.brainHemisphereTransforms.left.addShape(e.left);b.brainHemisphereTransforms.right.addShape(e.right);e.left.createDrawElements(b.pack,null);e.right.createDrawElements(b.pack,null)}b.model_data=d;if(b.afterCreateBrain!=undefined){b.afterCreateBrain(b.model_data)}};b.createLineObject=function(f,e,h){b.model_data=f;var c=b.createMaterial("/shaders/line.txt");var g=c.getParam("transAlpha");g.value=1;if(h){console.log("mesh")}var d=b.createLineShape(c,f,e,h);d.name=e;if(b.brainTransform==undefined){b.brainTransform=b.pack.createObject("Transform")}b.brainTransform.parent=b.client.root;b.brainTransform.addShape(d);d.createDrawElements(b.pack,null);b.model_data=f;if(b.afterCreate!=undefined){b.afterCreate(b.model_data)}};b.createPolygonObject=function(f,e){b.model_data=f;var c=b.createMaterial("/shaders/blinnphong.txt");c=b.blinnphongParams(c);if(b.brainTransform==undefined){b.brainTransform=b.pack.createObject("Transform")}b.brainTransform.parent=b.client.root;if(f.shapes){console.log("multi_shape");console.log(f);for(var g=0;g<f.shapes.length;g++){console.log(f.shapes[g]);var d=b.createPolygonShape(c,f.shapes[g]);d.name=f.shapes[g].name;b.brainTransform.addShape(d);d.createDrawElements(b.pack,null)}}else{var d=b.createPolygonShape(c,f);d.name=e;b.brainTransform.addShape(d);d.createDrawElements(b.pack,null)}b.model_data=f;if(b.afterCreate!=undefined){b.afterCreate(b.model_data)}};b.createHemisphere=function(h,e){var j=b.createMaterial("/shaders/blinnphong.txt");j=b.blinnphongParams(j);var r=b.pack.createObject("Shape");var o=b.pack.createObject("Primitive");var t=b.pack.createObject("StreamBank");o.material=j;o.owner=r;o.streamBank=t;r.name=e;o.primitiveType=b.o3d.Primitive.TRIANGLELIST;var d=b.pack.createObject("State");b.enableAlphaBlending(d);o.material.state=d;var l=b.pack.createObject("VertexBuffer");var n=l.createField("FloatField",3);if(!h.positionArray){alert("PositionArray nil");return false}l.set(h.positionArray);b.numberVertices=h.numberVertices;var s=(h.positionArray.length/3);o.numberVertices=b.numberVertices;if(!h.indexArray){alert("Index Array nil");return false}o.numberPrimitives=h.indexArray.length/3;var g=b.pack.createObject("IndexBuffer");g.set(h.indexArray);o.indexBuffer=g;var q=b.pack.createObject("VertexBuffer");var k=q.createField("FloatField",3);q.set(h.normalArray);var m=[];if(h.colorArray.length==4){for(var f=0;f<s;f++){m.push.apply(m,h.colorArray)}}else{m=h.colorArray}if(m.length<h.positionArray.length){alert("Problem with the colors: "+m.length)}var p=b.pack.createObject("VertexBuffer");var c=p.createField("FloatField",4);p.set(m);m=[];if(b.loading){jQuery(b.loading).html("Buffers Loaded")}t.setVertexStream(b.o3d.Stream.POSITION,0,n,0);t.setVertexStream(b.o3d.Stream.NORMAL,0,k,0);t.setVertexStream(b.o3d.Stream.COLOR,0,c,0);return r};b.createLineShape=function(o,g,y,c){var n=b.pack.createObject("Shape");var x=b.pack.createObject("StreamBank");n.name=y;if(!g.positionArray){alert("PositionArray nil");return false}b.numberVertices=g.numberVertices;var u=b.pack.createObject("Primitive");u.material=o;u.owner=n;u.streamBank=x;u.primitiveType=b.o3d.Primitive.LINELIST;var l=b.pack.createObject("State");b.enableAlphaBlending(l);u.material.state=l;var e=new Array();for(var t=0;t<g.nitems;t++){if(t==0){var h=0}else{var h=g.endIndicesArray[t-1]}e.push(g.indexArray[h]);for(var r=h+1;r<g.endIndicesArray[t]-1;r++){e.push(g.indexArray[r]);e.push(g.indexArray[r])}e.push(g.indexArray[g.endIndicesArray[t]-1])}if(!c){var f=b.pack.createObject("IndexBuffer");u.numberPrimitives=e.length/2;u.numberVertices=e.length;b.indexArray=e;var d=new Float32Array(e.length*3);for(var s=0;s<e.length;s++){d[s*3]=g.positionArray[e[s]*3];d[s*3+1]=g.positionArray[e[s]*3+1];d[s*3+2]=g.positionArray[e[s]*3+2]}var m=[];if(g.colorArray.length==4){for(var t=0;t<numberVertices;t++){m.push.apply(m,[0.5,0.5,0.7,1])}}else{m=new Float32Array(e.length*4);for(var s=0;s<e.length;s++){m[s*4]=g.colorArray[e[s]*4];m[s*4+1]=g.colorArray[e[s]*4+1];m[s*4+2]=g.colorArray[e[s]*4+2];m[s*4+3]=g.colorArray[e[s]*4+3]}}}else{console.log("mesh shape");u.numberVertices=g.meshPostionArray.length/3;u.numberPrimitives=u.numberVertices/2;var d=g.meshPositionArray;var m=g.meshColorArray}var v=b.pack.createObject("VertexBuffer");var p=v.createField("FloatField",3);v.set(d);x.setVertexStream(b.o3d.Stream.POSITION,0,p,0);if(m.length/4<d.length/3){alert("Problem with the colors: "+m.length)}var q=b.pack.createObject("VertexBuffer");var w=q.createField("FloatField",4);q.set(m);x.setVertexStream(b.o3d.Stream.COLOR,0,w,0);if(b.loading){jQuery(b.loading).html("Buffers Loaded")}b.pack.gl.lineWidth(1);return n};b.createPolygonShape=function(o,f,F){var C=b.pack.createObject("Shape");var E=b.pack.createObject("StreamBank");C.name=F;if(!f.positionArray){alert("PositionArray nil");return false}b.numberVertices=f.numberVertices;var d=b.pack.createObject("Primitive");d.material=o;d.owner=C;d.streamBank=E;d.primitiveType=b.o3d.Primitive.TRIANGLELIST;var g=b.pack.createObject("State");b.enableAlphaBlending(g);d.material.state=g;if(f.nonindexed==undefined){var e=f.indexArray;d.numberPrimitives=e.length/3;d.numberVertices=e.length;b.indexArray=e;var c=new Float32Array(e.length*3);var A=new Array(e.length*3);var p=new Array(e.length*4);var z=new Float32Array(e.length*3);var m=e.length;for(var w=0;w<m;w++){c[w*3]=f.positionArray[e[w]*3];c[w*3+1]=f.positionArray[e[w]*3+1];c[w*3+2]=f.positionArray[e[w]*3+2];z[w*3]=f.normalArray[e[w]*3];z[w*3+1]=f.normalArray[e[w]*3+1];z[w*3+2]=f.normalArray[e[w]*3+2]}for(var v=0;v<m;v+=3){var y=[];y[0]=[f.positionArray[e[v]*3],f.positionArray[e[v]*3+1],f.positionArray[e[v]*3+2]];y[1]=[f.positionArray[e[v+1]*3],f.positionArray[e[v+1]*3+1],f.positionArray[e[v+1]*3+2]];y[2]=[f.positionArray[e[v+2]*3],f.positionArray[e[v+2]*3+1],f.positionArray[e[v+2]*3+2]];A.push.apply(A,y[0]);A.push.apply(A,y[1]);A.push.apply(A,y[1]);A.push.apply(A,y[2]);A.push.apply(A,y[2]);A.push.apply(A,y[0])}C.meshPositionArray=A}else{d.numberPrimitives=f.positionArray.length/3/3;d.numberVertices=f.positionArray.length/3;var c=new Float32Array(f.positionArray);var z=new Float32Array(f.normalArray);console.log(f)}var h=[];if(f.colorArray.length==4){for(var x=0;x<d.numberVertices;x++){h.push.apply(h,f.colorArray)}}else{h=new Float32Array(e.length*4);var m=e.length;for(var w=0;w<m;w++){h[w*4]=h[w*4+1]=f.colorArray[e[w]*4+1];h[w*4+2]=f.colorArray[e[w]*4+2];h[w*4+3]=f.colorArray[e[w]*4+3]}for(var t=0;t<indexArrayLenght;t+=3){var u=[];u[0]=[f.colorArray[e[w]*4],f.colorArray[e[w]*4+1],f.colorArray[e[w]*4+2],f.colorArray[e[w]*4+3]];u[1]=[f.colorArray[e[w+1]*4],f.colorArray[e[w+1]*4+1],f.colorArray[e[w+1]*4+2],f.colorArray[e[w+1]*4+3]];u[2]=[f.colorArray[e[w+2]*4],f.colorArray[e[w+2]*4+1],f.colorArray[e[w+2]*4+2],f.colorArray[e[w+2]*4+3]];p.push.apply(p,u[0]);p.push.apply(p,u[1]);p.push.apply(p,u[1]);p.push.apply(p,u[2]);p.push.apply(p,u[2]);p.push.apply(p,u[0])}}f.meshPositionArray=A;f.meshColorArray=p;var n=b.pack.createObject("VertexBuffer");var r=n.createField("FloatField",3);n.set(z);E.setVertexStream(b.o3d.Stream.NORMAL,0,r,0);var B=b.pack.createObject("VertexBuffer");var q=B.createField("FloatField",3);B.set(c);E.setVertexStream(b.o3d.Stream.POSITION,0,q,0);if(h.length<f.positionArray.length){alert("Problem with the colors: "+h.length)}var s=b.pack.createObject("VertexBuffer");var D=s.createField("FloatField",4);s.set(h);h=[];E.setVertexStream(b.o3d.Stream.COLOR,0,D,0);if(b.loading){jQuery(b.loading).html("Buffers Loaded")}return C}}function BrainBrowser(){var g=this;bbObject(this);var j=new ColorManager();var e;var u;var x;var w;var y;var m=new THREE.Object3D();var h;var v;var c;var z;this.start=function(){window.onload=function(){setTimeout(function(){g.init()},1)}};this.init=function(){y=new THREE.Scene();e=$("#view-window");x=new THREE.PerspectiveCamera(30,e.width()/e.height(),0.1,5000);if(f()){u=new THREE.WebGLRenderer({clearColor:8947848,clearAlpha:1,preserveDrawingBuffer:true})}else{e.html(n());return}u.setSize(e.width(),e.height());e.append(u.domElement);x.position.z=500;w=new THREE.PointLight(16777215);w.position.x=0;w.position.y=0;w.position.z=500;y.add(w);h=new THREE.TrackballControls(x,e[0]);v=new THREE.TrackballControls(w,e[0]);h.zoomSpeed=2;v.zoomSpeed=2;function E(F){requestAnimationFrame(E);h.update();v.update();z=c||F;c=F;g.renderCallback(F)}if(this.afterInit){this.afterInit(g)}window.onresize();g.loadSpectrumFromUrl("/assets/spectral_spectrum.txt");E()};
/*! 
   * WebGL test taken from Detector.js by
   * alteredq / http://alteredqualia.com/
   * mr.doob / http://mrdoob.com/
  */
function f(){try{return !!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(E){return false}}function n(){var F='BrainBrowser requires <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>.<br/>';F+=window.WebGLRenderingContext?"Your browser seems to support it, but it is <br/> disabled or unavailable.<br/>":"Your browser does not seem to support it.<br/>";F+='Test your browser\'s WebGL support <a href="http://get.webgl.org/">here</a>.';var E=$('<div id="webgl-error">'+F+"</div>");return E}this.setCamera=function(E,G,F){x.position.set(E,G,F)};this.getModel=function(){return m};function k(G,H){g.model_data=G;var F=q(G.left);F.name="left";F.model_num=0;var E=q(G.right);E.name="right";E.model_num=1;m.add(F);m.add(E);y.add(m)}function q(H){var M=H.positionArray;var G=H.indexArray;var L={};var F={};for(var I=0;I+2<M.length;I+=3){r(L,M[I],M[I+1],M[I+2])}F.x=L.minX+0.5*(L.maxX-L.minX);F.y=L.minY+0.5*(L.maxY-L.minY);F.z=L.minY+0.5*(L.maxZ-L.minZ);var K=new THREE.Geometry();for(var I=0;I+2<M.length;I+=3){K.vertices.push(new THREE.Vector3(M[I]-F.x,M[I+1]-F.y,M[I+2]-F.z))}for(var I=0;I+2<G.length;I+=3){K.faces.push(new THREE.Face3(G[I],G[I+1],G[I+2]))}K.computeFaceNormals();K.computeVertexNormals();var J=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:526344,vertexColors:THREE.VertexColors});var E=new THREE.Mesh(K,J);E.centroid=F;E.position.set(F.x,F.y,F.z);return E}function t(G,E,I,H){var F=p(G,I);F.name=E;if(H){F.renderDepth=H}m.add(F);y.add(m)}function p(L,U){g.model_data=L;var T=[];var R=[];var E=[];var P={};var G={};for(var M=0;M<g.model_data.nitems;M++){if(M==0){var F=0}else{var F=g.model_data.endIndicesArray[M-1]}T.push(g.model_data.indexArray[F]);for(var J=F+1;J<g.model_data.endIndicesArray[M]-1;J++){T.push(g.model_data.indexArray[J]);T.push(g.model_data.indexArray[J])}T.push(g.model_data.indexArray[g.model_data.endIndicesArray[M]-1])}var Q=g.model_data.positionArray;for(var K=0;K<T.length;K++){r(P,Q[T[K]*3],Q[T[K]*3+1],Q[T[K]*3+2])}G.x=P.minX+0.5*(P.maxX-P.minX);G.y=P.minY+0.5*(P.maxY-P.minY);G.z=P.minY+0.5*(P.maxZ-P.minZ);if(!U){for(var K=0;K<T.length;K++){R.push(new THREE.Vector3(Q[T[K]*3]-G.x,Q[T[K]*3+1]-G.y,Q[T[K]*3+2]-G.z))}var S=[];if(g.model_data.colorArray.length==4){for(var M=0;M<numberVertices;M++){S.push.apply(S,[0.5,0.5,0.7,1])}}else{var S=g.model_data.colorArray;for(var K=0;K<T.length;K++){var H=new THREE.Color();H.setRGB(S[T[K]*4],S[T[K]*4+1],S[T[K]*4+2]);E.push(H)}}}else{R=g.model_data.meshPositionArray;E=g.model_data.meshColorArray}var O=new THREE.Geometry();O.vertices=R;O.colors=E;O.colorsNeedUpdate=true;var N=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});var I=new THREE.Line(O,N,THREE.LinePieces);I.position.set(G.x,G.y,G.z);I.centroid=G;return I}function B(H,F,I){g.model_data=H;if(g.model_data.shapes){for(var G=0;G<g.model_data.shapes.length;G++){var E=l(g.model_data.shapes[G]);E.name=g.model_data.shapes[G].name;m.add(E)}}else{var E=l(g.model_data);E.name=F;m.add(E)}if(g.afterCreate!=undefined){g.afterCreate(g.model_data)}y.add(m)}function l(P){var K=P.positionArray;var Q=P.indexArray;var R=[];if(P.colorArray.length==4){for(var J=0;J<K.length/3;J++){R.push(P.colorArray[0]);R.push(P.colorArray[1]);R.push(P.colorArray[2])}}else{R=[];var H=Q.length;for(var I=0;I+2<P.colorArray.length;I+=4){R.push(P.colorArray[I]);R.push(P.colorArray[I+1]);R.push(P.colorArray[I+2])}}var E=[];var G;var N=new THREE.Geometry();for(var J=0;J+2<K.length;J+=3){N.vertices.push(new THREE.Vector3(K[J],K[J+1],K[J+2]));G=new THREE.Color();G.setRGB(R[J],R[J+1],R[J+2]);E.push(G)}if(P.faces&&P.faces.length>0){var F=P.faces;for(var J=0;J<F.length;J++){if(F[J].length<3){continue}if(F[J].length<=4){if(F[J].length<=3){var M=new THREE.Face3(F[J][0],F[J][1],F[J][2])}else{if(F[J].length==4){var M=new THREE.Face4(F[J][0],F[J][1],F[J][2],F[J][3])}}M.vertexColors[0]=E[M.a];M.vertexColors[1]=E[M.b];M.vertexColors[2]=E[M.c];if(F[J].length>3){M.vertexColors[3]=E[M.d]}N.faces.push(M)}else{for(var I=1;I+1<F[J].length;I++){var M=new THREE.Face3(F[J][0],F[J][I],F[J][I+1]);M.vertexColors[0]=E[M.a];M.vertexColors[1]=E[M.b];M.vertexColors[2]=E[M.c];N.faces.push(M)}}}}else{for(var J=0;J+2<Q.length;J+=3){var M=new THREE.Face3(Q[J],Q[J+1],Q[J+2]);M.vertexColors[0]=E[M.a];M.vertexColors[1]=E[M.b];M.vertexColors[2]=E[M.c];N.faces.push(M)}}N.computeFaceNormals();N.computeVertexNormals();N.colorsNeedUpdate=true;var L=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:526344,vertexColors:THREE.VertexColors});var O=new THREE.Mesh(N,L);if(g.loading){jQuery(g.loading).html("Buffers Loaded")}return O}this.uninit=function(){if(this.client){this.client.cleanup()}};this.renderCallback=function(){var F=c-z;var E=F*0.00015;if(g.autoRotate){if(g.autoRotate.x){m.rotation.x+=E}if(g.autoRotate.y){m.rotation.y+=E}if(g.autoRotate.z){m.rotation.z+=E}}u.render(y,x)};this.clearScreen=function(){if(m){y.remove(m)}g.resetView();m=new THREE.Object3D();if(g.afterClearScreen!=undefined){g.afterClearScreen()}};this.displayObjectFile=function(H,E,G){var F=G||{};var I=F.renderDepth;if(H.objectClass=="P"&&H.numberVertices==81924){k(H,I)}else{if(H.objectClass=="P"){B(H,E,I)}else{if(H.objectClass=="L"){t(H,E,false,I)}else{alert("Object file not supported")}}}if(g.afterDisplayObject!=undefined){g.afterDisplayObject(m)}};function d(G,E,F){if(F==null){F=g.model_data.data}if(F.fixRange==false||F.fixRange==null){F.rangeMin=G;F.rangeMax=E}}this.updateClearColor=function(E){u.setClearColor(new THREE.Color(E))};this.updateClearColorFromName=function(E){if(E=="white"){g.updateClearColor(16777215)}else{if(E=="black"){g.updateClearColor(0)}else{if(E=="pink"){g.updateClearColor(16711935)}else{g.updateClearColor(8947848)}}}};this.resetView=function(){h.reset();v.reset();m.position.set(0,0,0);m.rotation.set(0,0,0);for(var E=0;E<m.children.length;E++){var F=m.children[E];F.visible=true;if(F.centroid){F.position.set(F.centroid.x,F.centroid.y,F.centroid.z)}else{F.position.set(0,0,0)}F.rotation.set(0,0,0)}};this.setupView=function(E){g.resetView();if(g.model_data&&g.model_data.num_hemispheres==2){var F=g.getViewParams();switch(F.view){case"superior":g.superiorView();break;case"medial":g.medialView();break;case"anterior":g.anteriorView();break;case"inferior":g.inferiorView();break;case"lateral":g.lateralView();break;case"posterior":g.posteriorView();break;default:g.superiorView();break}}if(m.getChildByName("left")){if(F.left==true){g.leftHemisphereVisible(true)}else{g.leftHemisphereVisible(false)}}if(m.getChildByName("right")){if(F.right==true){g.rightHemisphereVisible(true)}else{g.rightHemisphereVisible(false)}}};function a(E){return E*Math.PI/180}this.leftHemisphereVisible=function(E){m.getChildByName("left").visible=E};this.rightHemisphereVisible=function(E){m.getChildByName("right").visible=E};this.medialView=function(E){if(g.model_data.num_hemispheres==2){m.getChildByName("left").position.x-=100;m.getChildByName("left").rotation.z-=a(90);m.getChildByName("right").position.x+=100;m.getChildByName("right").rotation.z+=a(90);m.rotation.x+=a(-90)}};this.lateralView=function(E){if(g.model_data.num_hemispheres==2){m.getChildByName("left").position.x-=100;m.getChildByName("left").rotation.z+=a(-90);m.getChildByName("right").position.x+=100;m.getChildByName("right").rotation.z+=a(90);m.rotation.x+=a(90);m.rotation.y+=a(180)}};this.superiorView=function(){};this.inferiorView=function(){m.rotation.y+=a(180)};this.anteriorView=function(E){g.resetView();m.rotation.x+=a(-90);m.rotation.z+=a(180)};this.posteriorView=function(E){g.resetView();m.rotation.x+=a(-90)};this.separateHemispheres=function(E){if(g.model_data.num_hemispheres==2){m.children[0].position.x-=1;m.children[1].position.x+=1}};this.ZoomInOut=function(E){x.fov*=E;x.updateProjectionMatrix()};g.scrollMe=function(F){var E=(F.deltaY<0)?1/g.zoomFactor:g.zoomFactor;g.ZoomInOut(E);g.client.render()};function s(E){A();if(E){g.selectedInfo=E}}function A(){if(g.selectedInfo){g.highlightShape=null;g.selectedInfo=null}}this.click=function(J,G){var H=e.offset();mouseX=((J.clientX-H.left)/e.width())*2-1;mouseY=-((J.clientY-H.top)/e.height())*2+1;var L=new THREE.Projector();var K=new THREE.Raycaster();A();var F=new THREE.Vector3(mouseX,mouseY,1);L.unprojectVector(F,x);K.set(x.position,F.sub(x.position).normalize());var I=K.intersectObject(m,true);if(I.length>0){var E=I[0];var M={vertex:E.face.a,point:new THREE.Vector3(E.point.x,E.point.y,E.point.z),object:E.object};return G(J,M)}else{jQuery(g.pickInfoElem).html("--nothing--");return false}};this.getInfoForVertex=function(F){var E=g.model_data.getVertexInfo(F);var G={vertex:E.vertex,point:new THREE.Vector3(E.position_vector[0],E.position_vector[1],E.position_vector[2])};return G};this.keyPressedCallback=function(F){var E=false;switch(F.which){case 38:g.ZoomInOut(1.1);E="ZoomIn";break;case 40:g.ZoomInOut(1/1.1);E="ZoomOut";break;case 32:g.separateHemispheres();E="Seperate";break}if(E){return false}else{return true}};function r(G,E,H,F){if(!G.minX||G.minX>E){G.minX=E}if(!G.maxX||G.maxX<E){G.maxX=E}if(!G.minY||G.minY>H){G.minY=H}if(!G.maxY||G.maxY<H){G.maxY=H}if(!G.minZ||G.minZ>F){G.minZ=F}if(!G.maxZ||G.maxZ<F){G.maxZ=F}}function o(E,J,I){var H=new THREE.SphereGeometry(2);var G=new THREE.MeshBasicMaterial({color:16711680});var F=new THREE.Mesh(H,G);F.position.set(E,J,I);y.add(F)}this.set_fill_mode_wireframe=function(){var F=m.children;for(var E=0;E<F.length;E++){F[E].material.wireframe=true}};this.set_fill_mode_solid=function(){var F=m.children;for(var E=0;E<F.length;E++){F[E].material.wireframe=false}};function D(E,F,G){jQuery.ajax({type:"GET",url:E,dataType:"text",success:function(H){G(H)},error:function(H,J,I){alert("Failure in loadFromURL: "+J)},data:{},async:F,timeout:100000})}function b(H,G){var E=new FileReader();var F=H.files;E.file=F[0];E.onloadend=function(I){G(I.target.result)};E.readAsText(F[0])}this.loadObjFromUrl=function(E,F){D(E,false,function(H){var I=E.split("/");var G=I[I.length-1];g.displayObjectFile(new MNIObject(H),G,F)})};this.loadWavefrontObjFromUrl=function(E,F){D(E,false,function(H){var I=E.split("/");var G=I[I.length-1];g.displayObjectFile(new WavefrontObj(H),G,F)})};this.loadObjFromFile=function(G,F){var E=F||{};b(G,function(H){var K=G.value.split("\\");var I=K[K.length-1];var J;if(E.format=="wavefront"){J=new WavefrontObj(H)}else{J=new MNIObject(H)}g.displayObjectFile(J,I,E)})};this.loadSpectrumFromUrl=function(E){D(E,true,function(G){var F=new Spectrum(G);g.spectrum=F;if(g.afterLoadSpectrum!=null){g.afterLoadSpectrum(F)}if(g.model_data.data){g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum,g.flip,g.clamped)}})};this.loadSpectrumFromFile=function(E){b(E,function(G){var F=new Spectrum(G);g.spectrum=F;if(g.afterLoadSpectrum!=null){g.afterLoadSpectrum(F)}if(g.model_data.data){g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum,g.flip,g.clamped)}})};function C(E){}this.loadDataFromFile=function(K){var E=K.files[0].name;var I=function(M){var L=new Data(M);L.fileName=E;if(L.values.length<g.model_data.positionArray.length/4){alert("Number of numbers in datafile lower than number of vertices Vertices"+g.model_data.positionArray.length/3+" data values:"+L.values.length);return -1}else{g.model_data.data=L}d(g.model_data.data.min,g.model_data.data.max);if(g.afterLoadData!=null){g.afterLoadData(g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.model_data.data)}g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum,g.flip,g.clamped);return null};if(E.match(/.*.mnc|.*.nii/)){var J=new XMLHttpRequest();if(E.match(/.*.mnc/)){J.open("POST","/minc/volume_object_evaluate",false)}else{J.open("POST","/nii/volume_object_evaluate",false)}var G=document.getElementById("datafile-form");var H=new FormData(G);J.send(H);var F=J.response;I(F)}else{b(K,I)}};this.loadSeriesDataFromFile=function(J){console.log(J.files.length);var I=J.files.length;g.seriesData=new Array(I);g.seriesData.numberFiles=I;var G=J.files;for(var F=0;F<I;F++){var E=new FileReader();E.file=G[F];var H=E.onloadend=(function(L,K){return function(M){console.log(M.target.result.length);console.log(K);g.seriesData[K]=new Data(M.target.result);g.seriesData[K].fileName=L.name}})(E.file,F);E.readAsText(G[F])}g.setupSeries()};this.setupSeries=function(){$('<div id="series">Series: </div>').appendTo("#surface_choice");var E=$("#series");$('<span id="series-value">0</span>').appendTo(E);$('<div id="series-slider" width="100px" + height="10"></div>').slider({value:0,min:0,max:g.seriesData.numberFiles-1,step:0.1,slide:function(F,G){if(G.value-Math.floor(G.value)<0.01){g.model_data.data=g.seriesData[G.value]}else{if(g.seriesData[0].fileName.match("pval.*")){g.model_data.data=new Data(interpolateDataArray(g.seriesData[Math.floor(G.value)],g.seriesData[Math.floor(G.value)+1],(G.value-Math.floor(G.value)),true))}else{g.model_data.data=new Data(interpolateDataArray(g.seriesData[Math.floor(G.value)],g.seriesData[Math.floor(G.value)+1],(G.value-Math.floor(G.value))))}}if(g.seriesData[0].fileName.match("mt.*")){$("#age_series").html("Age: "+(G.value*3+5).toFixed(1))}else{if(g.seriesData[0].fileName.match("pval.*")){$("#age_series").html("Age: "+(G.value*1+10))}}$(E).children("#series-value").html(G.value);if(g.model_data.data.values.length<g.model_data.positionArray.length/4){console.log("Number of numbers in datafile lower than number of vertices Vertices"+g.model_data.positionArray.length/3+" data values:"+g.model_data.data.values.length);return -1}d(g.model_data.data.min,g.model_data.data.max);if(g.afterLoadData!=null){g.afterLoadData(g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.model_data.data)}g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum,g.flip,g.clamped);return null}}).appendTo(E)};this.loadBlendDataFromFile=function(J){var I=J.files.length;g.blendData=new Array(I);g.blendData.numberFiles=I;var G=J.files;for(var F=0;F<I;F++){var E=new FileReader();E.file=G[F];var H=E.onloadend=(function(L,K){return function(N){g.blendData[K]=new Data(N.target.result);g.blendData.alpha=1/I;g.blendData[K].fileName=L.name;for(var M=0;M<2;M++){if(g.blendData[M]==undefined){console.log("not done yet");return}}d(g.blendData[0].values.min(),g.blendData[0].values.max(),g.blendData[0]);d(g.blendData[1].values.min(),g.blendData[1].values.max(),g.blendData[1]);if(g.afterLoadData!=null){g.afterLoadData(null,null,g.blendData,true)}g.blend($(".blend_slider").slider("value"))}})(E.file,F);E.readAsText(G[F])}g.setupBlendColors()};this.setupBlendColors=function(){console.log("Blend colors has ran "+g.blendData.numberFiles);$("#blend").remove();$('<div id="blend">Blend ratios: </div>').appendTo("#surface_choice");var E=$("#blend");$('<span id="blend_value'+i+'">0</span>').appendTo(E);$('<div class="blend_slider" id="blend_slider'+i+'" width="100px" + height="10"></div>').slider({value:0,min:0.1,max:0.99,value:0.5,step:0.01,slide:function(F,G){g.blend($(this).slider("value"))}}).appendTo(E)};this.blend=function(F){g.blendData[0].alpha=F;g.blendData[1].alpha=1-F;for(var E=2;E<g.blendData.length;E++){g.blendData[E].alpha=0}g.updateColors(g.blendData,null,null,g.spectrum,g.flip,g.clamped,true)};this.loadDataFromUrl=function(F,E){D(F,true,function(H,G){g.model_data.data=new Data(H);g.model_data.data.fileName=E;d(g.model_data.data.min,g.model_data.data.max);if(g.afterLoadData!=undefined){g.afterLoadData(g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.model_data.data)}g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum)})};this.loadCombinedShaderFromUrl=function(E){var F;D(E,false,function(G){F=G});return F};this.updateColors=function(aa,Q,U,Y,K,P,T,F){g.clamped=P;if(T){var Z=j.blendColorMap(Y,aa,0,1)}else{var Z=aa.createColorArray(Q,U,Y,K,P,g.model_data.colorArray,g.model_data)}if(g.model_data.num_hemispheres==2){var E=Z.slice(0,Z.length/2);var O=Z.slice(Z.length/2,Z.length);var M=[];var W=[];for(var V=0;V+2<Z.length;V+=4){var J=new THREE.Color();J.setRGB(E[V],E[V+1],E[V+2]);M.push(J);J=new THREE.Color();J.setRGB(O[V],O[V+1],O[V+2]);W.push(J)}var R=m.getChildByName("left");var X=R.geometry.faces;for(var V=0;V<X.length;V++){var L=X[V];L.vertexColors[0]=M[L.a];L.vertexColors[1]=M[L.b];L.vertexColors[2]=M[L.c];if(L.d){L.vertexColors[3]=M[L.d]}}R.geometry.colorsNeedUpdate=true;var G=m.getChildByName("right");var H=G.geometry.faces;for(var V=0;V<H.length;V++){var L=H[V];L.vertexColors[0]=W[L.a];L.vertexColors[1]=W[L.b];L.vertexColors[2]=W[L.c];if(L.d){L.vertexColors[3]=W[L.d]}}G.geometry.colorsNeedUpdate=true}else{var N=[];for(var V=0;V+2<Z.length;V+=4){var J=new THREE.Color();J.setRGB(Z[V],Z[V+1],Z[V+2]);N.push(J)}var I=g.brain.children;for(var V=0;V<I.length;V++){for(var S=0;S<I[V].faces.length;S++){var L=I[V].faces[S];L.vertexColors[0]=N[L.a];L.vertexColors[1]=N[L.b];L.vertexColors[2]=N[L.c];if(L.d){L.vertexColors[3]=N[L.d]}}I[V].geometry.colorsNeedUpdate=true}}if(g.afterUpdateColors!=null){g.afterUpdateColors(aa,Q,U,Y)}return 1};this.rangeChange=function(F,E,G){g.model_data.data.rangeMin=F;g.model_data.data.rangeMax=E;g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum,g.flip,G);if(g.afterRangeChange!=null){g.afterRangeChange(F,E)}};this.changeShapeTransparency=function(F,G){var E=m.getChildByName(F);if(E){E.material.opacity=G;if(G==1){E.material.transparent=false}else{E.material.transparent=true}}};this.getImageUrl=function(){var H=document.createElement("canvas");var E=document.getElementById("spectrum_canvas");H.width=e.width();H.height=e.height();var I=H.getContext("2d");var F=new Image();function G(){var J=new Image();J.onload=function(){I.drawImage(J,0,0);window.open(H.toDataURL(),"screenshot")};J.src=E.toDataURL()}F.onload=function(){I.drawImage(F,0,0);if(E){G()}else{window.open(H.toDataURL(),"screenshot")}};F.src=u.domElement.toDataURL()};window.onresize=function(){e=$("#view-window");u.setSize(e.width(),e.height());x.aspect=e.width()/e.height();x.updateProjectionMatrix()};g.start()}var g_spectrum;function MacaccObject(g,l,c){var d=this;this.brainbrowser=g;this.dataSet=new Dataset(l,c);d.debugLineGroup;d.debugLine;d.selectedInfo=null;d.treeInfo;d.pickInfoElem;d.flashTimer=0;d.highlightMaterial;d.highlightShape;d.vertex;d.positionVector;d.primitiveIndex;d.dataArray;d.data_max;d.data_min;d.range_max;d.range_min;d.spectrum;d.coordinates=jQuery("#coordinates");d.selectPoint=null;function f(o,n){var m=o.vertex;if(m!=undefined&&n!=undefined){jQuery("#x-coord").val(o.point.x);jQuery("#y-coord").val(o.point.y);jQuery("#z-coord").val(o.point.z);jQuery("#v-coord").val(m);jQuery("#value-coord").val(n)}}this.pickClick=function(m,n){d.vertex=n.vertex;if(n.object&&n.object.model_num){d.vertex+=n.object.model_num*n.object.geometry.vertices.length}if(d.vertex){a();f(n,0);if(g.secondWindow!=undefined&&true){g.secondWindow.postMessage(d.vertex,"*")}}else{jQuery(d.pickInfoElem).html("--nothing--")}};this.change_model=function(n){var m=jQuery(n.target).val();g.clearScreen();g.loadObjFromUrl("/data/surfaces/surf_reg_model_both_"+m+".obj")};this.flipXCoordinate=function(){if(!d.dataArray){return}if(d.vertex>d.dataArray.length/2){d.vertex-=d.dataArray.length/2}else{d.vertex+=d.dataArray.length/2}f(g.getInfoForVertex(d.vertex),0);a()};this.valueAtPoint=function(n,o){var m=d.dataArray[o.vertex];f(o,m)};function k(){var o=jQuery("[name=modality]:checked").val();var n=jQuery("#data-sk").val();var m=jQuery("[name=statistic]:checked").val();return{modality:o,sk:n,statistic:m}}function b(n,m,p,o){g.updateColors(d.dataSet.current_data,n,m,g.spectrum,p,o)}function j(o){d.dataArray=o.current_data.values;g.current_dataset=o;if(jQuery("#fix_range").attr("checked")==true){if(!(d.data_min=parseFloat(jQuery("#data-range-min").val()))){if(!d.data_min===0){d.data_min=o.current_data.min}}if(!(d.data_max=parseFloat(jQuery("#data-range-max").val()))){if(!d.data_max===0){d.data_max=o.current_data.max}}}else{if(k().statistic=="T"){d.data_min=o.current_data.min;d.data_max=o.current_data.max}}var n=jQuery("#flip_range").attr("checked");var m=jQuery("#clamp_range").attr("checked");if(k().statistic=="T"){d.flipRange=n;b(d.data_min,d.data_max,n,m)}else{d.flipRange=!n;jQuery("#range-slider").slider("option","min","0");jQuery("#range-slider").slider("option","max","1");b(0,1,!n,m)}}d.update_model=j;function a(){d.dataSet.get_data(d.vertex,k(),j);jQuery(d.pickInfoElem).html("Viewing data for vertex: "+d.vertex)}this.show_atlas=function(){g.loadDataFromUrl("/assets/aal_atlas.txt")};function h(n,m){if(!jQuery("#fix_range").attr("checked")){jQuery("#data-range-min").val(n);jQuery("#data-range-max").val(m);jQuery("#range-slider").slider("values",0,n);jQuery("#range-slider").slider("values",1,m)}if(d.afterRangeChange!=undefined){d.afterRangeChange(n,m)}}function e(n,m){}this.range_change=function(){var n=parseFloat(jQuery("#data-range-min").val());var m=parseFloat(jQuery("#data-range-max").val());b(n,m,$("#flip_range").attr("checked"),$("#clamp_range").attr("checked"));if(d.afterRangeChange!=undefined){d.afterRangeChange(n,m)}};this.data_control_change=function(){var m=k();if(m.modality=="AAL"){d.show_atlas()}else{if(d.vertex){a()}}};g.loadSpectrumFromUrl("/assets/spectral_spectrum.txt");g.valueAtPointCallback=this.valueAtPoint;g.clickCallback=this.pickClick}var brainbrowser;var macacc;function initMacacc(a,b){brainbrowser=new BrainBrowser();brainbrowser.getViewParams=function(){return{view:jQuery("[name=hem_view]:checked").val(),left:jQuery("#left_hem_visible").attr("checked"),right:jQuery("#right_hem_visible").attr("checked")}};brainbrowser.afterLoadSpectrum=function(c){var d=c.createSpectrumCanvasWithScale(0,5,null,false);jQuery("#spectrum").html(jQuery(d));brainbrowser.spectrumObj=c};brainbrowser.afterInit=function(c){c.loadObjFromUrl("/models/surf_reg_model_both.obj");macacc=new MacaccObject(c,a,b);brainbrowser.afterCreateBrain=function(){if(c.current_dataset!=undefined){macacc.update_model(c.current_dataset)}};macacc.afterRangeChange=function(f,d){if(macacc.flipRange==true){var e=c.spectrumObj.createSpectrumCanvasWithScale(f,d,null,true)}else{var e=c.spectrumObj.createSpectrumCanvasWithScale(f,d,null,false)}jQuery("#spectrum").html(jQuery(e))};jQuery("#meshmode").change(function(d){if(jQuery(d.target).attr("checked")==true){c.set_fill_mode_wireframe()}else{c.set_fill_mode_solid()}});jQuery("#range-slider").slider({range:true,min:-10,max:15,values:[0,5],slide:function(d,e){jQuery("#data-range-min").val(e.values[0]);jQuery("#data-range-max").val(e.values[1]);if(c.current_dataset){macacc.range_change()}},step:0.1});jQuery(".range-box").keypress(function(d){if(d.keyCode=="13"){macacc.range_change(d)}});jQuery("#data-range-min").change(function(d){jQuery("#range-slider").slider("values",0,jQuery(this).val());macacc.afterRangeChange(parseFloat(jQuery("#data-range-min").val()),parseFloat(jQuery("#data-range-max").val()))});jQuery("#data-range-max").change(function(d){jQuery("#range-slider").slider("values",1,jQuery(this).val());macacc.afterRangeChange(parseFloat(jQuery("#data-range-min").val()),parseFloat(jQuery("#data-range-max").val()))});jQuery(".data_controls").change(macacc.data_control_change);macacc.pickInfoElem=jQuery("#vertex_info");jQuery("#x-coord-flip").click(macacc.flipXCoordinate);jQuery("[name=pointer]").change(function(d){if(jQuery("[name=pointer]:checked").val()=="AAL_atlas"){macacc.show_atlas()}});jQuery("#model").change(macacc.change_model);jQuery("#screenshot").click(function(d){jQuery(this).attr("href",c.client.toDataUR())});$("#view-window").mousedown(function(d){var f=jQuery("[name=pointer]:checked").val();if(d.ctrlKey||f=="check"){if(c.valueAtPointCallback){c.click(d,c.valueAtPointCallback)}}else{if(d.shiftKey||f=="select"){if(c.clickCallback){c.click(d,c.clickCallback)}}}});jQuery("#flip_range").change(function(d){macacc.update_model(brainbrowser.current_dataset)});jQuery("#clamp_range").change(function(d){macacc.update_model(brainbrowser.current_dataset)});jQuery("#flip_correlation").click(function(g){var f=-1*parseFloat(jQuery("#data-range-max").val());var d=-1*parseFloat(jQuery("#data-range-min").val());jQuery("#data-range-min").val(f).change();jQuery("#data-range-max").val(d).change();jQuery("#flip_range").attr("checked",!jQuery("#flip_range").attr("checked")).change()})};jQuery("#resetview").click(brainbrowser.setupView);jQuery(".view_button").change(brainbrowser.setupView);jQuery("[name=hem_view]").change(brainbrowser.setupView);jQuery(".button").button();jQuery(".button_set").buttonset();jQuery("#secondWindow").click(function(c){brainbrowser.secondWindow=window.open("/macacc.html","secondWindow")});window.addEventListener("message",function(f){var d=parseInt(f.data);var c=[brainbrowser.model_data.positionArray[d*3],brainbrowser.model_data.positionArray[d*3+1],brainbrowser.model_data.positionArray[d*3+2]];macacc.pickClick(f,{position_vector:c,vertex:d,stop:true,})},false);if(window.opener!=null){brainbrowser.secondWindow=window.opener}};