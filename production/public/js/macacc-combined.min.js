Array.prototype.min=function(){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.min.apply(Math,this.slice(c,c+b-1)))}}else{return Math.min.apply(Math,this)}return a.min()};Array.prototype.max=function(d){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.max.apply(Math,this.slice(c,c+b-1)))}}else{return Math.max.apply(Math,this)}return a.max()};function cloneArray(b){var c=new Array(b.length);for(var a=0;a<c.length;a++){c[a]=b[a]}return c}function rotateUint16Array90Left(f,d,a){var e=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){e[c*a+b]=f[b*d+(d-c)]}}return e}function rotateUint16Array90Right(f,d,a){var e=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){e[c*a+b]=f[(a-b)*d+c]}}return e}function interpolateDataArray(g,c,b,a){console.log(g.values.length);var e=g.values.length;var f=new Array(e);console.log("Percentage: "+b);for(var d=0;d<e;d++){if(a){f[d]=(g.values[d]*(100-b*100)+c.values[d]*(b*100))/100}else{f[d]=(g.values[d]*(100-b*100)+c.values[d]*(b*100))/100}}console.log(f.length);return f}function WaveformObj(A){var g=this;A=A.split("\n");g.shapes=[];var v;var f=[];var h=[];for(var u=0;u<A.length;u++){var e=A[u].split(" ");if(!(e[0].match("#"))){if(e[0]=="o"|e[0]=="g"){v={name:e[1],indexArray:[],texIndexArray:[]};g.shapes.push(v)}else{if(e[0]=="v"){f.push(parseFloat(e[1]));f.push(parseFloat(e[2]));f.push(parseFloat(e[3]))}else{if(e[0]=="vt"){for(var j=1;j<e.length;j++){h.push(parseFloat(e[j]))}}else{if(e[0]=="f"){for(var r=1;r<4;r++){var x=e[r].split("/");v.indexArray.push(parseInt(x[0])-1);v.texIndexArray.push(parseInt(x[1])-1)}if(e.length>=4){for(r;r<e.length;r++){var x=e[r].split("/");var w=v.indexArray.length;v.indexArray.push(v.indexArray[w-1]);v.indexArray.push(v.indexArray[w-3]);v.indexArray.push(x[0]-1)}}}}}}}}var q=g.shapes.length;for(var p=0;p<q;p++){var b=g.shapes[p];b.positionArray=[];b.texCoordArray=[];b.colorArray=[1,0.2,0,1];var s=b.indexArray.length;for(var o=0;o<s;o++){b.positionArray.push(f[(b.indexArray[o])*3]);b.positionArray.push(f[(b.indexArray[o])*3+1]);b.positionArray.push(f[(b.indexArray[o])*3+2])}b.normalArray=[];for(u=0;u<s;u+=3){var t=[];t[0]=[b.positionArray[u*3],b.positionArray[u*3+1],b.positionArray[u*3+2]];t[1]=[b.positionArray[(u+1)*3],b.positionArray[(u+1)*3+1],b.positionArray[(u+1)*3+2]];t[2]=[b.positionArray[(u+2)*3],b.positionArray[(u+2)*3+1],b.positionArray[(u+2)*3+2]];var c=[t[1][0]-t[0][0],t[1][1]-t[0][1],t[1][2]-t[0][2]];var a=[t[2][0]-t[0][0],t[2][1]-t[0][1],t[2][2]-t[0][2]];var y=vec3.normalize(vec3.cross(c,a,[]));for(var d=0;d<3;d++){b.normalArray.push(y[0]);b.normalArray.push(y[1]);b.normalArray.push(y[2])}}b.numberVertices=b.positionArray.length/3;b.nonindexed=true}g.objectClass="P";g.vertexArray=f;g.texCoordArray=h}function MNIObject(c){var h;var f=this;this.parse=function(l){f.num_hemispheres=1;var k=l.replace(/\s+$/,"");var m=k.replace(/^\s+/,"");h=m.split(/\s+/).reverse();f.objectClass=h.pop();if(f.objectClass=="P"){d();f.numberVertices=parseInt(h.pop());e();j();f.nitems=parseInt(h.pop())}else{if(f.objectClass=="L"){d();f.numberVertices=parseInt(h.pop());e();f.nitems=parseInt(h.pop())}else{throw new Error("That object class is not supported currently")}}g();b();a();if(f.objectClass=="P"){if(f.positionArray.length==81924*3){f.brainSurface=true;f.split_hemispheres()}}};function d(){if(f.objectClass=="P"){f.surfaceProperties={ambient:parseFloat(h.pop()),diffuse:parseFloat(h.pop()),specular_reflectance:parseFloat(h.pop()),specular_scattering:parseFloat(h.pop()),transparency:parseFloat(h.pop())}}else{if(f.objectClass=="L"){f.surfaceProperties={width:h.pop()}}}}function e(){f.positionArray=new Array();for(var k=0;k<f.numberVertices;k++){for(var l=0;l<3;l++){f.positionArray.push(parseFloat(h.pop()))}}}function j(){f.normalArray=new Array();for(var l=0;l<f.numberVertices;l++){for(var k=0;k<3;k++){f.normalArray.push(parseFloat(h.pop()))}}}function g(){f.colorFlag=parseInt(h.pop());f.colorArray=new Array();if(f.colorFlag===0){for(var k=0;k<4;k++){f.colorArray.push(parseFloat(h.pop()))}}else{if(f.colorFlag===1){for(var l=0;l<f.numberPolygons;l++){for(var k=0;k<4;k++){f.colorArray.push(parseFloat(h.pop()))}}}else{if(f.colorFlag===2){for(var l=0;l<f.numberVertices;l++){for(var k=0;k<4;k++){f.colorArray.push(parseFloat(h.pop()))}}}else{throw new Error("colorFlag not valid in that file")}}}}function b(){f.endIndicesArray=new Array();for(var k=0;k<f.nitems;k++){f.endIndicesArray.push(parseInt(h.pop()))}}function a(){f.indexArray=new Array();var l=h.length;for(var k=0;k<l;k++){f.indexArray.push(parseInt(h.pop()))}}this.split_hemispheres=function(){this.left={};this.right={};var o=this.positionArray.length;this.left.positionArray=this.positionArray.slice(0,o/2);this.right.positionArray=this.positionArray.slice(o/2,o);var n=this.indexArray.length;this.left.indexArray=this.indexArray.slice(0,n/2);this.right.indexArray=this.indexArray.slice(n/2,n);for(var k=0;k<this.right.indexArray.length;k++){this.right.indexArray[k]=this.right.indexArray[k]-2-n/3/2/2}var l=this.normalArray.length;this.left.normalArray=this.normalArray.slice(0,l/2);this.right.normalArray=this.normalArray.slice(l/2,l);this.left.colorFlag=this.colorFlag;this.right.colorFlag=this.colorFlag;if(this.colorFlag==0||this.colorFlag==1){this.left.colorArray=this.colorArray;this.right.colorArray=this.colorArray}else{var m=this.colorArray.length;this.left.colorArray=this.colorArray.slice(0,m/2);this.right.colorArray=this.colorArray.slice(m/2+1,-1)}this.left.numberVertices=this.numberVertices/2;this.right.numberVertices=this.numberVertices/2;this.left.numberPolygons=this.numberPolygons/2;this.right.numberPolygons=this.numberPolygons/2;this.num_hemispheres=2};this.getVertexInfo=function(l){var k=[this.positionArray[l*3],this.positionArray[l*3+1],this.positionArray[l*3+2]];return{vertex:l,position_vector:k}};this.get_vertex=function(v,s,l){if(this.num_hemispheres>1){var r=this[l];var o=0;if(l=="right"){o=2+r.indexArray.length/3/2}}else{var r=this;var o=0}var q=new Array();var y=v*3;for(var p=0;p<3;p++){q.push(r.indexArray[y+p])}var w=new Array();for(var p=0;p<3;p++){var u=q[p]*3;w[p]=new Array();for(var n=0;n<3;n++){w[p][n]=r.positionArray[u+n]}}var x=new Array();for(var p=0;p<3;p++){x.push(o3djs.math.distance(s,w[p]))}var m=0;if(x[1]<x[0]){m=1}if(x[2]<x[m]){m=2}var t=q[m]+o;var z=w[m];return{vertex:t,position_vector:z}};if(c){this.parse(c)}}function ColorManager(){function c(l,d,p,h,n,k,m,g,f){var l=l.colors;var o=((n-h)+(n-h)/l.length)/l.length;for(var j=0;j<p.length;j++){if(p[j]<=h){var q=0}else{if(p[j]>n){var q=l.length-1}else{var q=parseInt((p[j]-h)/o)}}if(k){var e=255}else{var e=1}d[j*4+0]=e*l[q][0]*g+m*e;d[j*4+1]=e*l[q][1]*g+m*e;d[j*4+2]=e*l[q][2]*g+m*e;if(f){d[j*4+3]=e*f}else{d[j*4+3]=e}}return d}this.createColorMap=c;function a(k){var d=k[0];for(var g=0;g<k[0].length/4;g++){for(var f=1;f<k.length;f++){var e=d[g*4+3];var h=k[f][g*4+3];d[g*4]=d[g*4]*e+k[f][g*4]*h;d[g*4+1]=d[g*4+1]*e+k[f][g*4+1]*h;d[g*4+2]=d[g*4+2]*e+k[f][g*4+2]*h;d[g*4+3]=e+h}}return d}this.blendColors=a;function b(e,l,j,g){var d=l.length;var k=new Array(d);var h=0;for(var f=0;f<d;f++){k[f]=c(e,new Array(l[f].values.length),l[f].values,l[f].rangeMin,l[f].rangeMax,false,0,1,l[f].alpha)}return a(k)}this.blendColorMap=b}function Spectrum(e){var c=this;var a=new ColorManager();function b(f,p,h,o){var j=document.createElement("canvas");jQuery(j).attr("width",256);jQuery(j).attr("height",h);var l=new Array(256);for(var n=0;n<256;n++){if(o){l[255-n]=n}else{l[n]=n}}f=a.createColorMap(c,[],l,0,255,true,0,1);var g=j.getContext("2d");for(var m=0;m<256;m++){g.fillStyle="rgb("+parseInt(f[m*4])+","+parseInt(f[m*4+1])+","+parseInt(f[m*4+2])+")";g.fillRect(m,0,1,p)}console.log("rgb("+parseInt(f[100*4+0])+","+parseInt(f[100*4+1])+","+parseInt(f[100*4+2]));console.log(g.fillStyle);return j}c.createSpectrumCanvas=function(f){if(f==null){f=c.colors}var g=b(f,20,20,false);return g};c.createSpectrumCanvasWithScale=function(k,f,g,l){if(g==null){g=c.colors}var h=b(g,20,40,l);var j=h.getContext("2d");j.fillStyle="#FFA000";j.fillRect(0.5,20,1,10);j.fillText(k.toPrecision(3),0.5,40);j.fillRect(h.width/4,20,1,10);j.fillText(((k+f)/4).toPrecision(3),h.width/4,40);j.fillRect(h.width/2,20,1,10);j.fillText(((k+f)/2).toPrecision(3),h.width/2,40);j.fillRect(3*(h.width/4),20,1,10);j.fillText((3*((k+f)/4)).toPrecision(3),3*(h.width/4),40);j.fillRect(h.width-0.5,20,1,10);j.fillText(f.toPrecision(3),h.width-20,40);return h};function d(m){m=m.replace(/\s+$/,"");m=m.replace(/^\s+/,"");var j=m.split(/\n/);var f=new Array();for(var h=0;h<j.length;h++){var l=j[h].replace(/\s+$/,"").split(/\s+/);for(var g=0;g<l.length;g++){l[g]=parseFloat(l[g])}if(l.length<4){l.push(1)}f.push(l)}c.colors=f;return f}if(e!=undefined){d(e)}}function Data(b){var a=this;a.parse=function(c){c=c.replace(/\s+$/,"");c=c.replace(/^\s+/,"");a.values=c.split(/\s+/);for(var d=0;d<a.values.length;d++){a.values[d]=parseFloat(a.values[d])}a.min=a.values.min();a.max=a.values.max()};this.createColorArray=function(d,h,g,f,l,c){var g=g.colors;var k=new Array();var j=((h-d)+(h-d)/g.length)/g.length;for(var e=0;e<a.values.length;e++){if(a.values[e]<=d){if(a.values[e]<d&&!l){var m=-1}else{var m=0}}else{if(a.values[e]>h){if(!l){var m=-1}else{var m=g.length-1}}else{var m=parseInt((a.values[e]-d)/j)}}if(f&&m!=-1){k.push.apply(k,g[g.length-1-m])}else{if(m==-1){if(c.length==4){k.push.apply(k,c)}else{k.push.apply(k,[c[e*4],c[e*4+1],c[e*4+2],c[e*4+3]])}}else{k.push.apply(k,g[m])}}}return k};if(b){if(typeof b=="string"){a.parse(b)}else{if(b.values!=undefined){this.values=cloneArray(b.values);this.min=this.values.min();this.max=this.values.max()}else{console.log("copying data length: "+b.length);this.values=b;this.min=b.min();this.max=b.max()}}}}function Dataset(a,b){if(b==null){this.path=function(g,f){var d="ICBM152_"+f.sk;if(f.modality=="CT"){var c="ICBM152_"+f.modality+"_MACACC_mean"}else{var c="ICBM152_"+f.modality+"_MACACC_size"}if(f.statistic=="T"){var e="T_map/T_"}else{if(f.statistic=="P1"){var e="RTF_C_map/RTF_C_"}else{if(f.statistic=="P2"){var e="RTF_V_map/RTF_V_"}}}if(a==null){a="/data/"}return a+c+"/"+d+"/"+e+g+".txt"}}else{this.path=function(d,c){return a}}this.get_data=function(f,c,h){if(f=="aal_atlas"){var g="/assets/aal_atlas.txt"}else{var g=this.path(f,c)}if(b){var e={vertex:f,modality:c.modality,sk:c.sk,statistic:c.statistic}}var d=this;jQuery.ajax({type:"GET",url:g,data:e,dataType:"text",success:function(j){d.current_data=new Data(j);h(d)},error:function(){jQuery(g_pickInfoElem).html("Error loading map")}})}}function bbObject(a){var b=a;b.createBrain=function(d,c){b.model_data=d;if(d.num_hemispheres==2){var e={left:b.createHemisphere(d.left,"left"),right:b.createHemisphere(d.right,"right"),num_hemisphere:2}}else{var e=b.createHemisphere(d,"filename");e.num_hemisphere=1}if(b.brainTransform==null){b.brainTransform=b.pack.createObject("Transform");if(d.num_hemispheres==2){b.brainHemisphereTransforms={};b.brainHemisphereTransforms.left=b.pack.createObject("Transform");b.brainHemisphereTransforms.right=b.pack.createObject("Transform")}}else{b.brainTransform.removeShape(b.brainTransform.shapes[0]);if(b.brainTransform.children[0]!=null){b.brainTransform.children[0].removeShape(b.brainTransform.children[0].shapes[0])}if(b.brainTransform.children[1]!=null){b.brainTransform.children[1].removeShape(b.brainTransform.children[1].shapes[0])}}if(d.num_hemispheres!=2){b.brainTransform.removeParam(b.brainTransform.children[0]);b.brainTransform.removeParam(b.brainTransform.children[1])}if(d.num_hemispheres==2&&b.brainHemisphereTransforms==null){b.brainHemisphereTransforms={};b.brainHemisphereTransforms.left=b.pack.createObject("Transform");b.brainHemisphereTransforms.right=b.pack.createObject("Transform")}b.brainTransform.parent=b.client.root;if(e.num_hemisphere==1){b.brainTransform.addShape(e);e.createDrawElements(b.pack,null)}else{b.brainHemisphereTransforms.left.parent=b.brainTransform;b.brainHemisphereTransforms.right.parent=b.brainTransform;b.brainHemisphereTransforms.left.addShape(e.left);b.brainHemisphereTransforms.right.addShape(e.right);e.left.createDrawElements(b.pack,null);e.right.createDrawElements(b.pack,null)}b.model_data=d;if(b.afterCreateBrain!=undefined){b.afterCreateBrain(b.model_data)}};b.createLineObject=function(f,e){b.model_data=f;var c=b.createMaterial("/shaders/line.txt");var g=c.getParam("transAlpha");g.value=1;var d=b.createLineShape(c,f);d.name=e;if(b.brainTransform==undefined){b.brainTransform=b.pack.createObject("Transform")}b.brainTransform.parent=b.client.root;b.brainTransform.addShape(d);d.createDrawElements(b.pack,null);b.model_data=f;if(b.afterCreate!=undefined){b.afterCreate(b.model_data)}};b.createPolygonObject=function(g,e){b.model_data=g;var c=b.createMaterial("/shaders/blinnphong.txt");c=b.blinnphongParams(c);if(b.brainTransform==undefined){b.brainTransform=b.pack.createObject("Transform")}b.brainTransform.parent=b.client.root;if(g.shapes){for(var f=0;f<g.shapes.length;f++){var d=b.createPolygonShape(c,g.shapes[f]);d.name=g.shapes[f].name;b.brainTransform.addShape(d);d.createDrawElements(b.pack,null)}}else{var d=b.createPolygonShape(c,g);d.name=e;b.brainTransform.addShape(d);d.createDrawElements(b.pack,null)}b.model_data=g;if(b.afterCreate!=undefined){b.afterCreate(b.model_data)}};b.createHemisphere=function(h,e){var j=b.createMaterial("/shaders/blinnphong.txt");j=b.blinnphongParams(j);var r=b.pack.createObject("Shape");var o=b.pack.createObject("Primitive");var t=b.pack.createObject("StreamBank");o.material=j;o.owner=r;o.streamBank=t;r.name=e;o.primitiveType=b.o3d.Primitive.TRIANGLELIST;var d=b.pack.createObject("State");b.enableAlphaBlending(d);o.material.state=d;var l=b.pack.createObject("VertexBuffer");var n=l.createField("FloatField",3);if(!h.positionArray){alert("PositionArray nil");return false}l.set(h.positionArray);b.numberVertices=h.numberVertices;var s=(h.positionArray.length/3);o.numberVertices=b.numberVertices;if(!h.indexArray){alert("Index Array nil");return false}o.numberPrimitives=h.indexArray.length/3;var g=b.pack.createObject("IndexBuffer");g.set(h.indexArray);o.indexBuffer=g;var q=b.pack.createObject("VertexBuffer");var k=q.createField("FloatField",3);q.set(h.normalArray);var m=[];if(h.colorArray.length==4){for(var f=0;f<s;f++){m.push.apply(m,h.colorArray)}}else{m=h.colorArray}if(m.length<h.positionArray.length){alert("Problem with the colors: "+m.length)}var p=b.pack.createObject("VertexBuffer");var c=p.createField("FloatField",4);p.set(m);m=[];if(b.loading){jQuery(b.loading).html("Buffers Loaded")}t.setVertexStream(b.o3d.Stream.POSITION,0,n,0);t.setVertexStream(b.o3d.Stream.NORMAL,0,k,0);t.setVertexStream(b.o3d.Stream.COLOR,0,c,0);return r};b.createLineShape=function(n,f,x){var m=b.pack.createObject("Shape");var w=b.pack.createObject("StreamBank");m.name=x;if(!f.positionArray){alert("PositionArray nil");return false}b.numberVertices=f.numberVertices;var t=b.pack.createObject("Primitive");t.material=n;t.owner=m;t.streamBank=w;t.primitiveType=b.o3d.Primitive.LINELIST;var h=b.pack.createObject("State");b.enableAlphaBlending(h);t.material.state=h;var d=new Array();for(var s=0;s<f.nitems;s++){if(s==0){var g=0}else{var g=f.endIndicesArray[s-1]}d.push(f.indexArray[g]);for(var q=g+1;q<f.endIndicesArray[s]-1;q++){d.push(f.indexArray[q]);d.push(f.indexArray[q])}d.push(f.indexArray[f.endIndicesArray[s]-1])}var e=b.pack.createObject("IndexBuffer");t.numberPrimitives=d.length/2;t.numberVertices=d.length;b.indexArray=d;var c=new Float32Array(d.length*3);for(var r=0;r<d.length;r++){c[r*3]=f.positionArray[d[r]*3];c[r*3+1]=f.positionArray[d[r]*3+1];c[r*3+2]=f.positionArray[d[r]*3+2]}var l=[];if(f.colorArray.length==4){for(var s=0;s<numberVertices;s++){l.push.apply(l,[0.5,0.5,0.7,1])}}else{l=new Float32Array(d.length*4);for(var r=0;r<d.length;r++){l[r*4]=f.colorArray[d[r]*4];l[r*4+1]=f.colorArray[d[r]*4+1];l[r*4+2]=f.colorArray[d[r]*4+2];l[r*4+3]=f.colorArray[d[r]*4+3]}}var u=b.pack.createObject("VertexBuffer");var o=u.createField("FloatField",3);u.set(c);w.setVertexStream(b.o3d.Stream.POSITION,0,o,0);if(l.length<f.positionArray.length){alert("Problem with the colors: "+l.length)}var p=b.pack.createObject("VertexBuffer");var v=p.createField("FloatField",4);p.set(l);l=[];w.setVertexStream(b.o3d.Stream.COLOR,0,v,0);if(b.loading){jQuery(b.loading).html("Buffers Loaded")}b.pack.gl.lineWidth(1);return m};b.createPolygonShape=function(l,f,w){var t=b.pack.createObject("Shape");var v=b.pack.createObject("StreamBank");t.name=w;if(!f.positionArray){alert("PositionArray nil");return false}b.numberVertices=f.numberVertices;var d=b.pack.createObject("Primitive");d.material=l;d.owner=t;d.streamBank=v;d.primitiveType=b.o3d.Primitive.TRIANGLELIST;var g=b.pack.createObject("State");b.enableAlphaBlending(g);d.material.state=g;if(f.nonindexed==undefined){var e=f.indexArray;d.numberPrimitives=e.length/3;d.numberVertices=e.length;b.indexArray=e;var c=new Float32Array(e.length*3);var r=new Float32Array(e.length*3);for(var p=0;p<e.length;p++){c[p*3]=f.positionArray[e[p]*3];c[p*3+1]=f.positionArray[e[p]*3+1];c[p*3+2]=f.positionArray[e[p]*3+2];r[p*3]=f.normalArray[e[p]*3];r[p*3+1]=f.normalArray[e[p]*3+1];r[p*3+2]=f.normalArray[e[p]*3+2]}}else{d.numberPrimitives=f.positionArray.length/3/3;d.numberVertices=f.positionArray.length/3;var c=new Float32Array(f.positionArray);var r=new Float32Array(f.normalArray)}var h=[];if(f.colorArray.length==4){for(var q=0;q<d.numberVertices;q++){h.push.apply(h,f.colorArray)}}else{h=new Float32Array(e.length*4);for(var p=0;p<e.length;p++){h[p*4]=f.colorArray[e[p]*4];h[p*4+1]=f.colorArray[e[p]*4+1];h[p*4+2]=f.colorArray[e[p]*4+2];h[p*4+3]=f.colorArray[e[p]*4+3]}}var k=b.pack.createObject("VertexBuffer");var n=k.createField("FloatField",3);k.set(r);v.setVertexStream(b.o3d.Stream.NORMAL,0,n,0);var s=b.pack.createObject("VertexBuffer");var m=s.createField("FloatField",3);s.set(c);v.setVertexStream(b.o3d.Stream.POSITION,0,m,0);if(h.length<f.positionArray.length){alert("Problem with the colors: "+h.length)}var o=b.pack.createObject("VertexBuffer");var u=o.createField("FloatField",4);o.set(h);h=[];v.setVertexStream(b.o3d.Stream.COLOR,0,u,0);if(b.loading){jQuery(b.loading).html("Buffers Loaded")}return t}}o3djs.base.o3d=o3d;o3djs.require("o3djs.webgl");o3djs.require("o3djs.math");o3djs.require("o3djs.rendergraph");o3djs.require("o3djs.pack");o3djs.require("o3djs.picking");o3djs.require("o3djs.arcball");o3djs.require("o3djs.quaternions");o3djs.require("o3djs.scene");function BrainBrowser(){var g=this;bbObject(this);var e=new ColorManager();this.init=function(){o3djs.webgl.makeClients(g.initStep2)};this.initStep2=function(m){var n=m[0];g.o3dElement=n;g.client=n.client;g.o3d=n.o3d;g.math=o3djs.math;g.dragging=false;g.o3dWidth=-1;g.o3dHeight=-1;g.quaternions=o3djs.quaternions;g.lastRot=g.math.matrix4.identity();g.thatRot=g.math.matrix4.identity();g.zoomFactor=1.1;g.keyPressDelta=0.1;g.clock=0;g.timeMult=1;g.camera={farPlane:5000,nearPlane:0.1};g.object_origin=[0,0,0];g.loading=jQuery("#o3d_loading");o3djs.base.init(n);g.pack=g.client.createPack();var l=o3djs.rendergraph.createBasicView(g.pack,g.client.root,g.client.renderGraphRoot,[0.5,0.5,0.5,1]);g.viewInfo=l;l.drawContext.projection=g.math.matrix4.perspective(g.math.degToRad(30),g.client.width/g.client.height,1,5000);g.eyeView=[0,0,500];l.drawContext.view=g.math.matrix4.lookAt(g.eyeView,[0,0,0],[0,1,0]);g.aball=o3djs.arcball.create(100,100);g.client.setRenderCallback(g.renderCallback);jQuery("body").keydown(g.keyPressedCallback);o3djs.event.addEventListener(n,"wheel",g.scrollMe);g.loadSpectrumFromUrl("/assets/spectral_spectrum.txt");if(g.afterInit){g.afterInit(g)}g.updateInfo();jQuery("#screenshot").click(function(o){jQuery(this).attr("href",bb.client.toDataURL())})};this.uninit=function(){if(this.client){this.client.cleanup()}};this.renderCallback=function(l){g.setClientSize();if(g.autoRotate==true){g.clock=0;g.clock+=l.elapsedTime*g.timeMult;g.brainTransform.rotateY(0.1*g.clock);g.brainTransform.rotateZ(0.1*g.clock)}};this.createMaterial=function(l){var n=g.pack.createObject("Effect");var o=g.loadCombinedShaderFromUrl(l);n.loadFromFXString(o);var m=g.pack.createObject("Material");m.drawList=g.viewInfo.performanceDrawList;m.effect=n;n.createUniformParameters(m);return m};function d(l){l.getStateParam("AlphaBlendEnable").value=true;l.getStateParam("SourceBlendFunction").value=o3djs.base.o3d.State.BLENDFUNC_SOURCE_ALPHA;l.getStateParam("DestinationBlendFunction").value=o3djs.base.o3d.State.BLENDFUNC_INVERSE_SOURCE_ALPHA;l.getStateParam("AlphaTestEnable").value=true;l.getStateParam("AlphaComparisonFunction").value=o3djs.base.o3d.State.CMP_GREATER}g.enableAlphaBlending=d;this.clearScreen=function(){if(brainbrowser.brainTransform!=undefined){if(brainbrowser.brainTransform.shapes!=undefined){var l=brainbrowser.brainTransform.shapes.length;for(var m=0;m<l;m++){brainbrowser.brainTransform.removeShape(brainbrowser.brainTransform.shapes[0])}}if(brainbrowser.brainTransform.children.length){var n=brainbrowser.brainTransform.children.length;for(var m=0;m<n;m++){var l=brainbrowser.brainTransform.children[m].length;brainbrowser.brainTransform.children[m].removeShape(brainbrowser.brainTransform.children[m].shapes[0])}}if(g.afterClearScreen!=undefined){g.afterClearScreen()}}};this.displayObjectFile=function(m,l){if(m.objectClass=="P"&&m.numberVertices<=81924){g.createBrain(m,l)}else{if(m.objectClass=="P"){g.createPolygonObject(m,l)}else{if(m.objectClass=="L"){g.createLineObject(m,l)}else{alert("Object file not supported")}}}if(g.afterDisplayObject!=undefined){g.afterDisplayObject(g.brainTransform)}};function c(n,l,m){if(m==null){m=g.model_data.data}if(m.fixRange==false||m.fixRange==null){m.rangeMin=n;m.rangeMax=l}}this.updateClearColor=function(l){g.viewInfo.clearBuffer.clearColor=l};this.updateClearColorFromName=function(l){if(l=="white"){g.updateClearColor([1,1,1,1])}else{if(l=="black"){g.updateClearColor([0,0,0,1])}else{if(l=="pink"){g.updateClearColor([1,0,1,1])}else{g.updateClearColor([0.5,0.5,0.5,1])}}}};this.blinnphongParams=function(q){var r=q.getParam("transAlpha");r.value=1;var v=q.getParam("lightWorldPos");v.value=g.eyeView;var l=q.getParam("ambient");var p=q.getParam("ambientIntensity");var o=q.getParam("lightIntensity");var t=q.getParam("specular");var s=q.getParam("emissive");var m=q.getParam("colorMult");var u=q.getParam("wires");u.value=false;l.value=[0.04,0.04,0.04,1];p.value=[1,1,1,1];o.value=[0.8,0.8,0.8,1];t.value=[0.5,0.5,0.5,1];s.value=[0,0,0,1];m.value=[1,1,1,1];var n=q.getParam("shininess");n.value=10000;return q};this.resetView=function(){g.brainTransform.children[0].visible=true;g.brainTransform.children[1].visible=true;g.brainTransform.identity();g.brainTransform.children[0].identity();g.brainTransform.children[1].identity()};this.setupView=function(l){g.resetView();if(g.model_data&&g.model_data.num_hemispheres==2){var m=g.getViewParams();switch(m.view){case"superior":g.superiorView();break;case"medial":g.medialView();break;case"anterior":g.anteriorView();break;case"inferior":g.inferiorView();break;case"lateral":g.lateralView();break;case"posterior":g.posteriorView();break;default:g.superiorView();break}}if(m.left==true){g.leftHemisphereVisible(true)}else{g.leftHemisphereVisible(false)}if(m.right==true){g.rightHemisphereVisible(true)}else{g.rightHemisphereVisible(false)}g.thatRot=g.math.matrix4.mul(g.brainTransform.localMatrix,g.math.matrix4.identity())};this.leftHemisphereVisible=function(l){g.brainTransform.children[0].visible=l};this.rightHemisphereVisible=function(l){g.brainTransform.children[1].visible=l};this.medialView=function(l){if(g.model_data.num_hemispheres==2){g.brainTransform.children[0].translate([-100,0,0]);g.brainTransform.children[1].translate([100,0,0]);g.brainTransform.children[0].rotateZ(g.math.degToRad(-90));g.brainTransform.children[1].rotateZ(g.math.degToRad(90));g.brainTransform.rotateX(g.math.degToRad(-90))}};this.lateralView=function(l){if(g.model_data.num_hemispheres==2){g.brainTransform.children[0].translate([-100,0,0]);g.brainTransform.children[1].translate([100,0,0]);g.brainTransform.children[0].rotateZ(g.math.degToRad(-90));g.brainTransform.children[1].rotateZ(g.math.degToRad(90));g.brainTransform.rotateX(g.math.degToRad(90));g.brainTransform.rotateY(g.math.degToRad(180))}};this.superiorView=function(){};this.inferiorView=function(){g.brainTransform.rotateY(g.math.degToRad(180))};this.anteriorView=function(l){g.resetView();g.brainTransform.rotateX(g.math.degToRad(-90));g.brainTransform.rotateZ(g.math.degToRad(180))};this.posteriorView=function(l){g.resetView();g.brainTransform.rotateX(g.math.degToRad(-90))};this.separateHemispheres=function(l){if(g.model_data.num_hemispheres==2){this.brainTransform.children[0].translate([-1,0,0]);this.brainTransform.children[1].translate([1,0,0])}};window.onresize=function(l){g.client.height=$(window).height()};this.setClientSize=function(){var m=parseInt(g.client.width);var l=parseInt(g.client.height);if(m!=g.o3dWidth||l!=g.o3dHeight){g.o3dWidth=m;g.o3dHeight=l;g.updateProjection();g.aball.setAreaSize(g.o3dWidth,g.o3dHeight)}};this.ZoomInOut=function(m){for(var l=0;l<g.eyeView.length;l+=1){g.eyeView[l]=g.eyeView[l]/m}g.viewInfo.drawContext.view=g.math.matrix4.lookAt(g.eyeView,[0,0,0],[0,1,0])};g.scrollMe=function(m){var l=(m.deltaY<0)?1/g.zoomFactor:g.zoomFactor;g.ZoomInOut(l);g.client.render()};function h(l){k();if(l){g.selectedInfo=l}}this.updateInfo=function(){if(!g.treeInfo){g.treeInfo=o3djs.picking.createPickManager(g.client.root)}g.treeInfo.update()};function k(){if(g.selectedInfo){g.highlightShape=null;g.selectedInfo=null}}this.click=function(r,o){var n=o3djs.picking.clientPositionToWorldRay(r.x,r.y,g.viewInfo.drawContext,g.client.width,g.client.height);k();g.treeInfo.update();var p=g.treeInfo.pick(n);if(p){h(p);var t=p.rayIntersectionInfo.primitiveIndex;var q=p.rayIntersectionInfo.position;var l=p.element.owner.name;var s=g.model_data.get_vertex(t,q,l);var m={ray_position:q,position_vector:s.position_vector,element:p.element,hemisphere:l,vertex:s.vertex};return o(r,m)}else{jQuery(g.pickInfoElem).html("--nothing--")}return false};this.getInfoForVertex=function(l){return g.model_data.getVertexInfo(l)};function j(m){var l;var n;if(m.pageX!=undefined&&m.pageY!=undefined){l=m.pageX;n=m.pageY}else{l=m.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;n=m.clientY+document.body.scrollTop+document.documentElement.scrollTop}l-=g.o3dElement.offsetLeft;n-=g.o3dElement.offsetTop;return{x:l,y:n}}this.startDragging=function(m){if(m.button==g.o3d.Event.BUTTON_RIGHT){var l=j(m);g.startPosition=o3djs.picking.clientPositionToWorldRay(l.x,l.y,g.viewInfo.drawContext,g.client.height,g.client.width).far;g.dragging=true}else{if(m.shiftKey&&m.ctrlKey&&g.model_data.num_hemispheres==2){g.drag_hemisphere=click(m,function(n,o){if(o.hemisphere=="left"){return 0}else{if(o.hemisphere=="right"){return 1}else{return false}}})}g.lastRot=g.thatRot;g.aball.click([m.x,m.y]);g.dragging=true}};this.drag=function(s){if(g.dragging&&s.button==g.o3d.Event.BUTTON_LEFT){var o=g.aball.drag([s.x,s.y]);var n=g.quaternions.quaternionToRotation(o);g.thatRot=g.math.matrix4.mul(g.lastRot,n);if(g.drag_hemisphere===0||g.drag_hemisphere===1){var l=g.brainTransform.children[g.drag_hemisphere].localMatrix;g.math.matrix4.setUpper3x3(l,g.thatRot);g.brainTransform.children[g.drag_hemisphere].localMatrix=l}else{var l=g.brainTransform.localMatrix;g.math.matrix4.setUpper3x3(l,g.thatRot);g.brainTransform.localMatrix=l}}else{if(g.dragging&&s.button==g.o3d.Event.BUTTON_RIGHT){var r=j(s);var q=o3djs.picking.clientPositionToWorldRay(r.x,r.y,g.viewInfo.drawContext,g.client.height,g.client.width).far;t=[0,0,0];var p=g.eyeView[0];var t=[(q[0]-g.startPosition[0])/5000*g.eyeView[2],(q[1]-g.startPosition[1])/5000*g.eyeView[2],0];g.startPosition=q;g.brainTransform.translate(t)}else{if(g.dragging){g.stopDragging(s)}}}};this.stopDragging=function(l){g.drag_hemisphere=false;g.dragging=false};this.updateCamera=function(){var l=[0,1,0];g.viewInfo.drawContext.view=g.math.matrix4.lookAt(g.camera.eye,g.camera.target,l);g.lightPosParam.value=g.camera.eye};this.updateProjection=function(){g.viewInfo.drawContext.projection=g.math.matrix4.perspective(g.math.degToRad(45),g.o3dWidth/g.o3dHeight,g.camera.nearPlane,g.camera.farPlane)};this.keyPressedAction=function(l,n){var m=false;switch(l){case"&":g.ZoomInOut(g.zoomFactor);m="zoom_in";break;case"(":g.ZoomInOut(1/g.zoomFactor);m="zoom_out";break;case" ":g.separateHemispheres();m="separate";break}return m};this.keyPressedCallback=function(m){var l=false;switch(m.which){case 38:g.ZoomInOut(g.zoomFactor);l="ZoomIn";break;case 40:g.ZoomInOut(1/g.zoomFactor);l="ZoomOut";break;case 32:g.separateHemispheres();l="Seperate";break}if(l){return false}else{return true}};this.set_fill_mode_wireframe=function(){if(g.model_data.num_hemispheres==2){var l=g.brainTransform.children[0].shapes[0].elements[0].material;g.state=g.pack.createObject("State");l.state=g.state;var m=l.getParam("wires");m.value=true;g.state.getStateParam("FillMode").value=g.o3d.State.WIREFRAME;l=g.brainTransform.children[1].shapes[0].elements[0].material;l.state=g.state;m=l.getParam("wires");m.value=true}else{var l=g.brainTransform.shapes[0].elements[0].material;g.state=g.pack.createObject("State");l.state=g.state;g.state.getStateParam("FillMode").value=g.o3d.State.WIREFRAME;var m=l.getParam("wires");m.value=true}g.client.render()};this.set_fill_mode_solid=function(){if(g.model_data.num_hemispheres==2){var l=g.brainTransform.children[0].shapes[0].elements[0].material;g.state1=g.pack.createObject("State");l.state=g.state1;var m=l.getParam("wires");m.value=false;g.state.getStateParam("FillMode").value=g.o3d.State.SOLID;l=g.brainTransform.children[1].shapes[0].elements[0].material;l.state=g.state;var m=l.getParam("wires");m.value=false}else{var l=g.brainTransform.shapes[0].elements[0].material;g.state=g.pack.createObject("State");l.state=g.state;g.state.getStateParam("FillMode").value=g.o3d.State.SOLID;var m=l.getParam("wires");m.value=false}};function b(l,m,n){jQuery.ajax({type:"GET",url:l,dataType:"text",success:function(o){n(o)},error:function(o,q,p){alert("Failure: "+q)},data:{},async:m,timeout:100000})}function a(o,n){var l=new FileReader();var m=o.files;l.file=m[0];l.onloadend=function(p){n(p.target.result)};l.readAsText(m[0])}this.loadObjFromUrl=function(l){b(l,false,function(n){var o=l.split("/");var m=o[o.length-1];g.displayObjectFile(new MNIObject(n),m)})};this.loadWaveformObjFromUrl=function(l){b(l,false,function(n){var o=l.split("/");var m=o[o.length-1];g.displayObjectFile(new WaveformObj(n),m)})};this.loadObjFromFile=function(l){a(l,function(m){var o=l.value.split("\\");var n=o[o.length-1];g.displayObjectFile(new MNIObject(m),n)})};this.loadSpectrumFromUrl=function(l){b(l,true,function(n){var m=new Spectrum(n);g.spectrum=m;if(g.afterLoadSpectrum!=null){g.afterLoadSpectrum(m)}if(g.model_data.data){g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum,g.flip,g.clamped)}})};this.loadSpectrumFromFile=function(l){a(l,function(n){var m=new Spectrum(n);g.spectrum=m;if(g.afterLoadSpectrum!=null){g.afterLoadSpectrum(m)}if(g.model_data.data){g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum,g.flip,g.clamped)}})};function f(l){}this.loadDataFromFile=function(r){var l=r.files[0].name;var p=function(t){var s=new Data(t);s.fileName=l;if(s.values.length<g.model_data.positionArray.length/4){alert("Number of numbers in datafile lower than number of vertices Vertices"+g.model_data.positionArray.length/3+" data values:"+s.values.length);return -1}else{g.model_data.data=s}c(g.model_data.data.min,g.model_data.data.max);if(g.afterLoadData!=null){g.afterLoadData(g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.model_data.data)}g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum,g.flip,g.clamped);return null};if(l.match(/.*.mnc|.*.nii/)){var q=new XMLHttpRequest();if(l.match(/.*.mnc/)){q.open("POST","/minc/volume_object_evaluate",false)}else{q.open("POST","/nii/volume_object_evaluate",false)}var n=document.getElementById("datafile-form");var o=new FormData(n);q.send(o);var m=q.response;p(m)}else{a(r,p)}};this.loadSeriesDataFromFile=function(q){console.log(q.files.length);var p=q.files.length;g.seriesData=new Array(p);g.seriesData.numberFiles=p;var n=q.files;for(var m=0;m<p;m++){var l=new FileReader();l.file=n[m];var o=l.onloadend=(function(s,r){return function(t){console.log(t.target.result.length);console.log(r);g.seriesData[r]=new Data(t.target.result);g.seriesData[r].fileName=s.name}})(l.file,m);l.readAsText(n[m])}g.setupSeries()};this.setupSeries=function(){$('<div id="series">Series: </div>').appendTo("#surface_choice");var l=$("#series");$('<span id="series-value">0</span>').appendTo(l);$('<div id="series-slider" width="100px" + height="10"></div>').slider({value:0,min:0,max:g.seriesData.numberFiles-1,step:0.1,slide:function(m,n){if(n.value-Math.floor(n.value)<0.01){g.model_data.data=g.seriesData[n.value]}else{if(g.seriesData[0].fileName.match("pval.*")){g.model_data.data=new Data(interpolateDataArray(g.seriesData[Math.floor(n.value)],g.seriesData[Math.floor(n.value)+1],(n.value-Math.floor(n.value)),true))}else{g.model_data.data=new Data(interpolateDataArray(g.seriesData[Math.floor(n.value)],g.seriesData[Math.floor(n.value)+1],(n.value-Math.floor(n.value))))}}if(g.seriesData[0].fileName.match("mt.*")){$("#age_series").html("Age: "+(n.value*3+5).toFixed(1))}else{if(g.seriesData[0].fileName.match("pval.*")){$("#age_series").html("Age: "+(n.value*1+10))}}$(l).children("#series-value").html(n.value);if(g.model_data.data.values.length<g.model_data.positionArray.length/4){console.log("Number of numbers in datafile lower than number of vertices Vertices"+g.model_data.positionArray.length/3+" data values:"+g.model_data.data.values.length);return -1}c(g.model_data.data.min,g.model_data.data.max);if(g.afterLoadData!=null){g.afterLoadData(g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.model_data.data)}g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum,g.flip,g.clamped);return null}}).appendTo(l)};this.loadBlendDataFromFile=function(q){var p=q.files.length;g.blendData=new Array(p);g.blendData.numberFiles=p;var n=q.files;for(var m=0;m<p;m++){var l=new FileReader();l.file=n[m];var o=l.onloadend=(function(s,r){return function(u){g.blendData[r]=new Data(u.target.result);g.blendData.alpha=1/p;g.blendData[r].fileName=s.name;for(var t=0;t<2;t++){if(g.blendData[t]==undefined){console.log("not done yet");return}}c(g.blendData[0].values.min(),g.blendData[0].values.max(),g.blendData[0]);c(g.blendData[1].values.min(),g.blendData[1].values.max(),g.blendData[1]);if(g.afterLoadData!=null){g.afterLoadData(null,null,g.blendData,true)}g.blend($(".blend_slider").slider("value"))}})(l.file,m);l.readAsText(n[m])}g.setupBlendColors()};this.setupBlendColors=function(){console.log("Blend colors has ran "+g.blendData.numberFiles);$("#blend").remove();$('<div id="blend">Blend ratios: </div>').appendTo("#surface_choice");var l=$("#blend");$('<span id="blend_value'+i+'">0</span>').appendTo(l);$('<div class="blend_slider" id="blend_slider'+i+'" width="100px" + height="10"></div>').slider({value:0,min:0.1,max:0.99,value:0.5,step:0.01,slide:function(m,n){g.blend($(this).slider("value"))}}).appendTo(l)};this.blend=function(m){g.blendData[0].alpha=m;g.blendData[1].alpha=1-m;for(var l=2;l<g.blendData.length;l++){g.blendData[l].alpha=0}g.updateColors(g.blendData,null,null,g.spectrum,g.flip,g.clamped,true)};this.loadDataFromUrl=function(l){b(l,true,function(n,m){g.model_data.data=new Data(n);c(g.model_data.data.min,g.model_data.data.max);if(g.afterLoadData!=undefined){g.afterLoadData(g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.model_data.data)}g.updateColors(g.model_data.data,g.rangeMin,g.rangeMax,g.spectrum)})};this.loadCombinedShaderFromUrl=function(l){var m;b(l,false,function(n){m=n});return m};this.updateColors=function(H,y,C,F,p,x,A,n){g.clamped=x;if(A){var G=e.blendColorMap(F,H,0,1)}else{var G=H.createColorArray(y,C,F,p,x,g.model_data.colorArray)}if(g.model_data.num_hemispheres==1){var u=g.pack.createObject("VertexBuffer");var z=u.createField("FloatField",4);u.set(G);var o=g.brainTransform.shapes[0];var s=o.elements[0].streamBank;s.setVertexStream(g.o3d.Stream.COLOR,0,z,0)}else{var m=G.slice(0,G.length/2);var w=G.slice(G.length/2,G.length);var t=g.pack.createObject("VertexBuffer");var D=t.createField("FloatField",4);t.set(m);var r=g.brainTransform.children[0].shapes[0];var v=r.elements[0].streamBank;v.setVertexStream(g.o3d.Stream.COLOR,0,D,0);var B=g.pack.createObject("VertexBuffer");var q=B.createField("FloatField",4);B.set(w);var E=g.brainTransform.children[1].shapes[0];var l=E.elements[0].streamBank;l.setVertexStream(g.o3d.Stream.COLOR,0,q,0);g.client.render()}if(g.afterUpdateColors!=null){g.afterUpdateColors(H,y,C,F)}return 1};this.rangeChange=function(m,l,n){g.model_data.data.rangeMin=m;g.model_data.data.rangeMax=l;g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum,g.flip,n);if(g.afterRangeChange!=null){g.afterRangeChange(m,l)}};this.changeShapeTransparency=function(o,p){var m=null;if(g.brainTransform.shapes!=undefined){for(var n=0;n<g.brainTransform.shapes.length;n++){if(g.brainTransform.shapes[n].name==o){m=g.brainTransform.shapes[n]}}}for(var l=0;l<g.brainTransform.children.length;l++){for(var n=0;n<g.brainTransform.children[l].shapes.length;n++){if(g.brainTransform.children[l].shapes[n].name==o){m=g.brainTransform.children[l].shapes[n]}}}if(m){m.elements[0].material.getParam("transAlpha").value=p}};this.getImageUrl=function(){var o=document.createElement("canvas");var l=document.getElementById("spectrum_canvas");o.width=g.o3dElement.width;o.height=g.o3dElement.height;var p=o.getContext("2d");var m=new Image();function n(){var q=new Image();q.onload=function(){p.drawImage(q,0,0);window.open(o.toDataURL(),"screenshot")};q.src=l.toDataURL()}m.onload=function(){p.drawImage(m,0,0);n()};m.src=g.o3dElement.toDataURL()};g.init()}var g_spectrum;function MacaccObject(h,m,d){var e=this;this.brainbrowser=h;this.dataSet=new Dataset(m,d);e.debugLineGroup;e.debugLine;e.selectedInfo=null;e.treeInfo;e.pickInfoElem;e.flashTimer=0;e.highlightMaterial;e.highlightShape;e.vertex;e.positionVector;e.primitiveIndex;e.dataArray;e.data_max;e.data_min;e.range_max;e.range_min;e.spectrum;e.coordinates=jQuery("#coordinates");e.selectPoint=null;function g(o,n){jQuery("#x-coord").val(o.position_vector[0]);jQuery("#y-coord").val(o.position_vector[1]);jQuery("#z-coord").val(o.position_vector[2]);jQuery("#v-coord").val(o.vertex);jQuery("#value-coord").val(n)}this.pickClick=function(o,n){e.vertex=n.vertex;if(e.vertex){a();g(n,0);if(h.secondWindow!=undefined&&n.stop!=true){h.secondWindow.postMessage(e.vertex,"*")}}else{jQuery(e.pickInfoElem).html("--nothing--")}};this.change_model=function(o){var n=jQuery(o.target).val();h.loadObjFromUrl("/data/surfaces/surf_reg_model_both_"+n+".obj")};this.flipXCoordinate=function(){if(e.vertex>e.dataArray.length/2){e.vertex-=e.dataArray.length/2}else{e.vertex+=e.dataArray.length/2}g(h.getInfoForVertex(e.vertex),0);a()};this.valueAtPoint=function(p,o){var n=e.dataArray[o.vertex];if(o.vertex&&n){jQuery("#x-coord").val(o.position_vector[0]);jQuery("#y-coord").val(o.position_vector[1]);jQuery("#z-coord").val(o.position_vector[2]);jQuery("#v-coord").val(o.vertex);jQuery("#value-coord").val(n)}};function c(o){if(h.model_data.num_hemispheres==1){var r=h.pack.createObject("VertexBuffer");var q=r.createField("FloatField",4);r.set(o);var z=h.brainTransform.shapes[0];var p=z.elements[0].streamBank;p.setVertexStream(h.o3d.Stream.COLOR,0,q,0)}else{var v=o.slice(0,o.length/2);var t=o.slice(o.length/2,o.length);var y=h.pack.createObject("VertexBuffer");var A=y.createField("FloatField",4);y.set(v);var n=h.brainTransform.children[0].shapes[0];var x=n.elements[0].streamBank;x.setVertexStream(h.o3d.Stream.COLOR,0,A,0);var s=h.pack.createObject("VertexBuffer");var w=s.createField("FloatField",4);s.set(t);var B=h.brainTransform.children[1].shapes[0];var u=B.elements[0].streamBank;u.setVertexStream(h.o3d.Stream.COLOR,0,w,0);h.client.render()}}function l(){var p=jQuery("[name=modality]:checked").val();var o=jQuery("#data-sk").val();var n=jQuery("[name=statistic]:checked").val();return{modality:p,sk:o,statistic:n}}function b(o,n,q,p){h.updateColors(e.dataSet.current_data,o,n,h.spectrum,q,p)}function k(p){e.dataArray=p.current_data.values;h.current_dataset=p;if(jQuery("#fix_range").attr("checked")==true){if(!(e.data_min=parseFloat(jQuery("#data-range-min").val()))){if(!e.data_min===0){e.data_min=p.current_data.min}}if(!(e.data_max=parseFloat(jQuery("#data-range-max").val()))){if(!e.data_max===0){e.data_max=p.current_data.max}}}else{if(l().statistic=="T"){e.data_min=p.current_data.min;e.data_max=p.current_data.max}}var o=jQuery("#flip_range").attr("checked");var n=jQuery("#clamp_range").attr("checked");if(l().statistic=="T"){e.flipRange=o;b(e.data_min,e.data_max,o,n)}else{e.flipRange=!o;jQuery("#range-slider").slider("option","min","0");jQuery("#range-slider").slider("option","max","1");b(0,1,!o,n)}}e.update_model=k;function a(){e.dataSet.get_data(e.vertex,l(),k);jQuery(e.pickInfoElem).html("Viewing data for vertex: "+e.vertex)}this.show_atlas=function(){h.loadDataFromUrl("/assets/aal_atlas.txt")};function j(o,n){if(!jQuery("#fix_range").attr("checked")){jQuery("#data-range-min").val(o);jQuery("#data-range-max").val(n);jQuery("#range-slider").slider("values",0,o);jQuery("#range-slider").slider("values",1,n)}if(e.afterRangeChange!=undefined){e.afterRangeChange(o,n)}}function f(o,n){}this.range_change=function(){var o=parseFloat(jQuery("#data-range-min").val());var n=parseFloat(jQuery("#data-range-max").val());b(o,n,$("#flip_range").attr("checked"),$("#clamp_range").attr("checked"));if(e.afterRangeChange!=undefined){e.afterRangeChange(o,n)}};this.data_control_change=function(){var n=l();if(n.modality=="AAL"){e.show_atlas()}else{if(e.vertex){a()}}};h.loadSpectrumFromUrl("/assets/spectral_spectrum.txt");h.updateInfo();h.valueAtPointCallback=this.valueAtPoint;h.clickCallback=this.pickClick}var brainbrowser;var macacc;function initMacacc(a,b){brainbrowser=new BrainBrowser();brainbrowser.getViewParams=function(){return{view:jQuery("[name=hem_view]:checked").val(),left:jQuery("#left_hem_visible").attr("checked"),right:jQuery("#right_hem_visible").attr("checked")}};brainbrowser.afterLoadSpectrum=function(c){var d=c.createSpectrumCanvasWithScale(0,5,null,false);jQuery("#spectrum").html(jQuery(d));brainbrowser.spectrumObj=c};brainbrowser.afterInit=function(c){c.loadObjFromUrl("/models/surf_reg_model_both.obj");macacc=new MacaccObject(c,a,b);brainbrowser.afterCreateBrain=function(){if(c.current_dataset!=undefined){macacc.update_model(c.current_dataset)}};macacc.afterRangeChange=function(f,d){if(macacc.flipRange==true){var e=c.spectrumObj.createSpectrumCanvasWithScale(f,d,null,true)}else{var e=c.spectrumObj.createSpectrumCanvasWithScale(f,d,null,false)}jQuery("#spectrum").html(jQuery(e))};jQuery("#meshmode").change(function(d){if(jQuery(d.target).attr("checked")==true){c.set_fill_mode_wireframe()}else{c.set_fill_mode_solid()}});jQuery("#range-slider").slider({range:true,min:-10,max:15,values:[0,5],slide:function(d,e){jQuery("#data-range-min").val(e.values[0]);jQuery("#data-range-max").val(e.values[1]);if(c.current_dataset){macacc.range_change()}},step:0.1});jQuery(".range-box").keypress(function(d){if(d.keyCode=="13"){macacc.range_change(d)}});jQuery("#data-range-min").change(function(d){jQuery("#range-slider").slider("values",0,jQuery(this).val());macacc.afterRangeChange(parseFloat(jQuery("#data-range-min").val()),parseFloat(jQuery("#data-range-max").val()))});jQuery("#data-range-max").change(function(d){jQuery("#range-slider").slider("values",1,jQuery(this).val());macacc.afterRangeChange(parseFloat(jQuery("#data-range-min").val()),parseFloat(jQuery("#data-range-max").val()))});jQuery(".data_controls").change(macacc.data_control_change);macacc.pickInfoElem=jQuery("#vertex_info");jQuery("#x-coord-flip").click(macacc.flipXCoordinate);jQuery("[name=pointer]").change(function(d){if(jQuery("[name=pointer]:checked").val()=="AAL_atlas"){macacc.show_atlas()}});jQuery("#model").change(macacc.change_model);jQuery("#screenshot").click(function(d){jQuery(this).attr("href",c.client.toDataUR())});o3djs.event.addEventListener(c.o3dElement,"mousedown",function(d){var f=jQuery("[name=pointer]:checked").val();if(f=="rotate"&&!d.shiftKey&&!d.ctrlKey){c.startDragging(d)}if(d.ctrlKey||f=="check"){if(c.valueAtPointCallback){c.click(d,c.valueAtPointCallback)}}if(d.shiftKey||f=="select"){if(c.clickCallback){c.click(d,c.clickCallback)}}});o3djs.event.addEventListener(c.o3dElement,"mousemove",function(d){var f=jQuery("[name=pointer]:checked").val();if(f=="check"&&d.shiftKey){if(c.valueAtPointCallback){c.click(d,c.valueAtPointCallback)}}else{if(f=="select"&&d.shiftKey){if(c.clickCallback){c.click(d,c.clickCallback)}}else{c.drag(d)}}});o3djs.event.addEventListener(c.o3dElement,"mouseup",function(d){if(!d.shiftKey||d.button==c.o3d.Event.BUTTON_RIGHT){c.stopDragging(d)}});jQuery("#flip_range").change(function(d){macacc.update_model(brainbrowser.current_dataset)});jQuery("#clamp_range").change(function(d){macacc.update_model(brainbrowser.current_dataset)});jQuery("#flip_correlation").click(function(g){var f=-1*parseFloat(jQuery("#data-range-max").val());var d=-1*parseFloat(jQuery("#data-range-min").val());jQuery("#data-range-min").val(f).change();jQuery("#data-range-max").val(d).change();jQuery("#flip_range").attr("checked",!jQuery("#flip_range").attr("checked")).change()})};jQuery("#resetview").click(brainbrowser.setupView);jQuery(".view_button").change(brainbrowser.setupView);jQuery("[name=hem_view]").change(brainbrowser.setupView);jQuery(".button").button();jQuery(".button_set").buttonset();jQuery("#secondWindow").click(function(c){brainbrowser.secondWindow=window.open("/macacc.html","secondWindow")});window.addEventListener("message",function(f){var d=parseInt(f.data);var c=[brainbrowser.model_data.positionArray[d*3],brainbrowser.model_data.positionArray[d*3+1],brainbrowser.model_data.positionArray[d*3+2]];macacc.pickClick(f,{position_vector:c,vertex:d,stop:true,})},false);if(window.opener!=null){brainbrowser.secondWindow=window.opener}};