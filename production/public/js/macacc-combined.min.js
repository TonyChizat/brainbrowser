Array.prototype.min=function(){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.min.apply(Math,this.slice(c,c+b-1)))}}else{return Math.min.apply(Math,this)}return a.min()};Array.prototype.max=function(d){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.max.apply(Math,this.slice(c,c+b-1)))}}else{return Math.max.apply(Math,this)}return a.max()};function cloneArray(b){var c=new Array(b.length);for(var a=0;a<c.length;a++){c[a]=b[a]}return c}function rotateUint16Array90Left(f,d,a){var e=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){e[c*a+b]=f[b*d+(d-c)]}}return e}function rotateUint16Array90Right(f,d,a){var e=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){e[c*a+b]=f[(a-b)*d+c]}}return e}function interpolateDataArray(g,c,b,a){console.log(g.values.length);var e=g.values.length;var f=new Array(e);console.log("Percentage: "+b);for(var d=0;d<e;d++){if(a){f[d]=(g.values[d]*(100-b*100)+c.values[d]*(b*100))/100}else{f[d]=(g.values[d]*(100-b*100)+c.values[d]*(b*100))/100}}console.log(f.length);return f}function WavefrontObj(m){var j=this;m=m.split("\n");j.shapes=[];var b;var c=[];var t=[];var r=[];b={name:m.name|"undefined",faces:[],positionArray:[],colorArray:[],indexArray:[],texIndexArray:[],normalIndexArray:[]};j.shapes.push(b);for(var o=0;o<m.length;o++){var u=m[o].split(/\s+/);if(!(u[0].match("#"))||u==""){if(u[0]=="o"|u[0]=="g"){console.log(u[1]);b={name:u[1],faces:[],positionArray:[],colorArray:[],indexArray:[],texIndexArray:[],normalIndexArray:[]};j.shapes.push(b)}else{if(u[0]=="v"){c.push(parseFloat(u[1]));c.push(parseFloat(u[2]));c.push(parseFloat(u[3]))}else{if(u[0]=="vt"){for(var e=1;e<u.length;e++){t.push(parseFloat(u[e]))}}else{if(u[0]=="vn"){r.push(parseFloat(u[1]));r.push(parseFloat(u[2]));r.push(parseFloat(u[3]))}else{if(u[0]=="f"){var s=[];for(var h=1;h<4;h++){var f=u[h].split("/");s.push(parseInt(f[0])-1);b.indexArray.push(parseInt(f[0])-1);b.texIndexArray.push(parseInt(f[1])-1);if(f[2]){b.normalIndexArray.push(parseInt(f[2])-1)}}if(u.length>=4){for(h;h<u.length;h++){var f=u[h].split("/");s.push(parseInt(f[0])-1);var p=b.indexArray.length;b.indexArray.push(b.indexArray[p-1]);b.indexArray.push(b.indexArray[p-3]);b.indexArray.push(f[0]-1)}}b.faces.push(s)}}}}}}}var a=Array(c.length/3);var d=j.shapes.length;for(var g=0;g<d;g++){var q=j.shapes[g];q.positionArray=c;if(q.colorArray.length==0){q.colorArray=[0.8,0.8,0.8,1]}}j.objectClass="P";j.vertexArray=c;j.texCoordArray=t}function MNIObject(d){var j;var g=this;function b(m){g.num_hemispheres=1;var l=m.replace(/\s+$/,"");var n=l.replace(/^\s+/,"");j=n.split(/\s+/).reverse();g.objectClass=j.pop();if(g.objectClass=="P"){e();g.numberVertices=parseInt(j.pop());f();k();g.nitems=parseInt(j.pop())}else{if(g.objectClass=="L"){e();g.numberVertices=parseInt(j.pop());f();g.nitems=parseInt(j.pop())}else{g.objectClass="__FAIL__";return}}h();c();a();if(g.objectClass=="P"){if(g.positionArray.length==81924*3){g.brainSurface=true;g.split_hemispheres()}}}function e(){if(g.objectClass=="P"){g.surfaceProperties={ambient:parseFloat(j.pop()),diffuse:parseFloat(j.pop()),specular_reflectance:parseFloat(j.pop()),specular_scattering:parseFloat(j.pop()),transparency:parseFloat(j.pop())}}else{if(g.objectClass=="L"){g.surfaceProperties={width:j.pop()}}}}function f(){g.positionArray=new Array();for(var l=0;l<g.numberVertices;l++){for(var m=0;m<3;m++){g.positionArray.push(parseFloat(j.pop()))}}}function k(){g.normalArray=new Array();for(var m=0;m<g.numberVertices;m++){for(var l=0;l<3;l++){g.normalArray.push(parseFloat(j.pop()))}}}function h(){g.colorFlag=parseInt(j.pop());g.colorArray=new Array();if(g.colorFlag===0){for(var l=0;l<4;l++){g.colorArray.push(parseFloat(j.pop()))}}else{if(g.colorFlag===1){for(var m=0;m<g.numberPolygons;m++){for(var l=0;l<4;l++){g.colorArray.push(parseFloat(j.pop()))}}}else{if(g.colorFlag===2){for(var m=0;m<g.numberVertices;m++){for(var l=0;l<4;l++){g.colorArray.push(parseFloat(j.pop()))}}}else{throw new Error("colorFlag not valid in that file")}}}}function c(){g.endIndicesArray=new Array();for(var l=0;l<g.nitems;l++){g.endIndicesArray.push(parseInt(j.pop()))}}function a(){g.indexArray=new Array();var m=j.length;for(var l=0;l<m;l++){g.indexArray.push(parseInt(j.pop()))}}g.split_hemispheres=function(){g.left={};g.right={};var p=g.positionArray.length;g.left.positionArray=g.positionArray.slice(0,p/2);g.right.positionArray=g.positionArray.slice(p/2,p);var o=g.indexArray.length;g.left.indexArray=g.indexArray.slice(0,o/2);g.right.indexArray=g.indexArray.slice(o/2,o);for(var l=0;l<g.right.indexArray.length;l++){g.right.indexArray[l]=g.right.indexArray[l]-2-o/3/2/2}var m=g.normalArray.length;g.left.normalArray=g.normalArray.slice(0,m/2);g.right.normalArray=g.normalArray.slice(m/2,m);g.left.colorFlag=g.colorFlag;g.right.colorFlag=g.colorFlag;if(g.colorFlag==0||g.colorFlag==1){g.left.colorArray=g.colorArray;g.right.colorArray=g.colorArray}else{var n=g.colorArray.length;g.left.colorArray=g.colorArray.slice(0,n/2);g.right.colorArray=g.colorArray.slice(n/2+1,-1)}g.left.numberVertices=g.numberVertices/2;g.right.numberVertices=g.numberVertices/2;g.left.numberPolygons=g.numberPolygons/2;g.right.numberPolygons=g.numberPolygons/2;g.num_hemispheres=2};g.getVertexInfo=function(m){var l=[g.positionArray[m*3],g.positionArray[m*3+1],g.positionArray[m*3+2]];return{vertex:m,position_vector:l}};g.get_vertex=function(v,s,l){if(g.num_hemispheres>1){var r=g[l];var o=0;if(l=="right"){o=2+r.indexArray.length/3/2}}else{var r=g;var o=0}var q=new Array();var y=v*3;for(var p=0;p<3;p++){q.push(r.indexArray[y+p])}var w=new Array();for(var p=0;p<3;p++){var u=q[p]*3;w[p]=new Array();for(var n=0;n<3;n++){w[p][n]=r.positionArray[u+n]}}var x=new Array();for(var p=0;p<3;p++){x.push(o3djs.math.distance(s,w[p]))}var m=0;if(x[1]<x[0]){m=1}if(x[2]<x[m]){m=2}var t=q[m]+o;var z=w[m];return{vertex:t,position_vector:z}};if(d){b(d)}}function ColorManager(){function c(l,d,p,h,n,k,m,g,f){var l=l.colors;var o=((n-h)+(n-h)/l.length)/l.length;for(var j=0;j<p.length;j++){if(p[j]<=h){var q=0}else{if(p[j]>n){var q=l.length-1}else{var q=parseInt((p[j]-h)/o)}}if(k){var e=255}else{var e=1}d[j*4+0]=e*l[q][0]*g+m*e;d[j*4+1]=e*l[q][1]*g+m*e;d[j*4+2]=e*l[q][2]*g+m*e;if(f){d[j*4+3]=e*f}else{d[j*4+3]=e}}return d}this.createColorMap=c;function a(k){var d=k[0];for(var g=0;g<k[0].length/4;g++){for(var f=1;f<k.length;f++){var e=d[g*4+3];var h=k[f][g*4+3];d[g*4]=d[g*4]*e+k[f][g*4]*h;d[g*4+1]=d[g*4+1]*e+k[f][g*4+1]*h;d[g*4+2]=d[g*4+2]*e+k[f][g*4+2]*h;d[g*4+3]=e+h}}return d}this.blendColors=a;function b(e,l,j,g){var d=l.length;var k=new Array(d);var h=0;for(var f=0;f<d;f++){k[f]=c(e,new Array(l[f].values.length),l[f].values,l[f].rangeMin,l[f].rangeMax,false,0,1,l[f].alpha)}return a(k)}this.blendColorMap=b}function Spectrum(e){var c=this;var a=new ColorManager();function b(f,p,h,o){var j=document.createElement("canvas");jQuery(j).attr("width",256);jQuery(j).attr("height",h);var l=new Array(256);for(var n=0;n<256;n++){if(o){l[255-n]=n}else{l[n]=n}}f=a.createColorMap(c,[],l,0,255,true,0,1);var g=j.getContext("2d");for(var m=0;m<256;m++){g.fillStyle="rgb("+parseInt(f[m*4])+","+parseInt(f[m*4+1])+","+parseInt(f[m*4+2])+")";g.fillRect(m,0,1,p)}return j}c.createSpectrumCanvas=function(f){if(f==null){f=c.colors}var g=b(f,20,20,false);return g};c.createSpectrumCanvasWithScale=function(k,f,g,l){if(g==null){g=c.colors}var h=b(g,20,40,l);var j=h.getContext("2d");j.fillStyle="#FFA000";j.fillRect(0.5,20,1,10);j.fillText(k.toPrecision(3),0.5,40);j.fillRect(h.width/4,20,1,10);j.fillText(((k+f)/4).toPrecision(3),h.width/4,40);j.fillRect(h.width/2,20,1,10);j.fillText(((k+f)/2).toPrecision(3),h.width/2,40);j.fillRect(3*(h.width/4),20,1,10);j.fillText((3*((k+f)/4)).toPrecision(3),3*(h.width/4),40);j.fillRect(h.width-0.5,20,1,10);j.fillText(f.toPrecision(3),h.width-20,40);return h};function d(m){m=m.replace(/\s+$/,"");m=m.replace(/^\s+/,"");var j=m.split(/\n/);var f=new Array();for(var h=0;h<j.length;h++){var l=j[h].replace(/\s+$/,"").split(/\s+/);for(var g=0;g<l.length;g++){l[g]=parseFloat(l[g])}if(l.length<4){l.push(1)}f.push(l)}c.colors=f;return f}if(e!=undefined){d(e)}}function Data(b){var a=this;a.parse=function(c){c=c.replace(/\s+$/,"");c=c.replace(/^\s+/,"");a.values=c.split(/\s+/);for(var d=0;d<a.values.length;d++){a.values[d]=parseFloat(a.values[d])}a.min=a.values.min();a.max=a.values.max()};this.createColorArray=function(f,n,m,h,q,d,k){var m=m.colors;var p=new Array();var o=((n-f)+(n-f)/m.length)/m.length;for(var g=0;g<a.values.length;g++){if(a.values[g]<=f){if(a.values[g]<f&&!q){var r=-1}else{var r=0}}else{if(a.values[g]>n){if(!q){var r=-1}else{var r=m.length-1}}else{var r=parseInt((a.values[g]-f)/o)}}if(h&&r!=-1){p.push.apply(p,m[m.length-1-r])}else{if(r==-1){if(d.length==4){p.push.apply(p,d)}else{p.push.apply(p,[d[g*4],d[g*4+1],d[g*4+2],d[g*4+3]])}}else{p.push.apply(p,m[r])}}}if(k.num_hemisphere!=2){var l=[];var c=k.indexArray.length;for(var e=0;e<c;e++){l[e*4]=p[k.indexArray[e]*4];l[e*4+1]=p[k.indexArray[e]*4+1];l[e*4+2]=p[k.indexArray[e]*4+2];l[e*4+3]=p[k.indexArray[e]*4+3]}p.nonIndexedColorArray=l}return p};if(b){if(typeof b=="string"){a.parse(b)}else{if(b.values!=undefined){this.values=cloneArray(b.values);this.min=this.values.min();this.max=this.values.max()}else{console.log("copying data length: "+b.length);this.values=b;this.min=b.min();this.max=b.max()}}}}function Dataset(a,b){if(b==null){this.path=function(g,f){var d="ICBM152_"+f.sk;if(f.modality=="CT"){var c="ICBM152_"+f.modality+"_MACACC_mean"}else{var c="ICBM152_"+f.modality+"_MACACC_size"}if(f.statistic=="T"){var e="T_map/T_"}else{if(f.statistic=="P1"){var e="RTF_C_map/RTF_C_"}else{if(f.statistic=="P2"){var e="RTF_V_map/RTF_V_"}}}if(a==null){a="/data/"}return a+c+"/"+d+"/"+e+g+".txt"}}else{this.path=function(d,c){return a}}this.get_data=function(f,c,h){if(f=="aal_atlas"){var g="/assets/aal_atlas.txt"}else{var g=this.path(f,c)}if(b){var e={vertex:f,modality:c.modality,sk:c.sk,statistic:c.statistic}}var d=this;jQuery.ajax({type:"GET",url:g,data:e,dataType:"text",success:function(j){d.current_data=new Data(j);h(d)},error:function(){jQuery(g_pickInfoElem).html("Error loading map")}})}}function BrainBrowser(){var g=this;var j=new ColorManager();var e;var v;var y;var x;var A;var m=new THREE.Object3D();var h;var w;var c;var B;var q;var z;this.start=function(){window.onload=function(){setTimeout(function(){g.init()},0)}};this.init=function(){A=new THREE.Scene();e=$("#view-window");y=new THREE.PerspectiveCamera(30,e.width()/e.height(),0.1,5000);if(f()){v=new THREE.WebGLRenderer({clearColor:8947848,clearAlpha:1,preserveDrawingBuffer:true})}else{e.html(n());return}v.setSize(e.width(),e.height());q=v;z=new THREE.AnaglyphEffect(v);z.setSize(e.width(),e.height());e.append(v.domElement);y.position.z=500;x=new THREE.PointLight(16777215);x.position.x=0;x.position.y=0;x.position.z=500;A.add(x);h=new THREE.TrackballControls(y,e[0]);w=new THREE.TrackballControls(x,e[0]);h.zoomSpeed=2;w.zoomSpeed=2;function F(G){requestAnimationFrame(F);B=c||G;c=G;h.update();w.update();g.renderCallback(G)}if(g.afterInit){g.afterInit(g)}window.onresize();F()};
/*! 
   * WebGL test taken from Detector.js by
   * alteredq / http://alteredqualia.com/
   * mr.doob / http://mrdoob.com/
  */
function f(){try{return !!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(F){return false}}function n(){var G='BrainBrowser requires <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>.<br/>';G+=window.WebGLRenderingContext?"Your browser seems to support it, but it is <br/> disabled or unavailable.<br/>":"Your browser does not seem to support it.<br/>";G+='Test your browser\'s WebGL support <a href="http://get.webgl.org/">here</a>.';var F=$('<div id="webgl-error">'+G+"</div>");return F}this.anaglyphEffect=function(){q=z};this.noEffect=function(){q=v};this.setCamera=function(F,H,G){y.position.set(F,H,G)};this.getModel=function(){return m};function k(H,I){g.model_data=H;var G=r(H.left);G.name="left";G.model_num=0;var F=r(H.right);F.name="right";F.model_num=1;m.add(G);m.add(F);A.add(m)}function r(I){var O=I.positionArray;var H=I.indexArray;var N={};var G={};var L;for(var J=0;J+2<O.length;J+=3){s(N,O[J],O[J+1],O[J+2])}G.x=N.minX+0.5*(N.maxX-N.minX);G.y=N.minY+0.5*(N.maxY-N.minY);G.z=N.minY+0.5*(N.maxZ-N.minZ);var M=new THREE.Geometry();for(var J=0;J+2<O.length;J+=3){M.vertices.push(new THREE.Vector3(O[J]-G.x,O[J+1]-G.y,O[J+2]-G.z))}for(var J=0;J+2<H.length;J+=3){L=new THREE.Face3(H[J],H[J+1],H[J+2]);L.vertexColors[0]=new THREE.Color();L.vertexColors[1]=new THREE.Color();L.vertexColors[2]=new THREE.Color();M.faces.push(L)}M.computeFaceNormals();M.computeVertexNormals();var K=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:526344,vertexColors:THREE.VertexColors});var F=new THREE.Mesh(M,K);F.centroid=G;F.position.set(G.x,G.y,G.z);return F}function u(H,F,J,I){var G=p(H,J);G.name=F;if(I){G.renderDepth=I}m.add(G);A.add(m)}function p(M,V){g.model_data=M;var U=[];var S=[];var F=[];var Q={};var H={};for(var N=0;N<g.model_data.nitems;N++){if(N==0){var G=0}else{var G=g.model_data.endIndicesArray[N-1]}U.push(g.model_data.indexArray[G]);for(var K=G+1;K<g.model_data.endIndicesArray[N]-1;K++){U.push(g.model_data.indexArray[K]);U.push(g.model_data.indexArray[K])}U.push(g.model_data.indexArray[g.model_data.endIndicesArray[N]-1])}var R=g.model_data.positionArray;for(var L=0;L<U.length;L++){s(Q,R[U[L]*3],R[U[L]*3+1],R[U[L]*3+2])}H.x=Q.minX+0.5*(Q.maxX-Q.minX);H.y=Q.minY+0.5*(Q.maxY-Q.minY);H.z=Q.minY+0.5*(Q.maxZ-Q.minZ);if(!V){for(var L=0;L<U.length;L++){S.push(new THREE.Vector3(R[U[L]*3]-H.x,R[U[L]*3+1]-H.y,R[U[L]*3+2]-H.z))}var T=[];if(g.model_data.colorArray.length==4){for(var N=0;N<numberVertices;N++){T.push.apply(T,[0.5,0.5,0.7,1])}}else{var T=g.model_data.colorArray;for(var L=0;L<U.length;L++){var I=new THREE.Color();I.setRGB(T[U[L]*4],T[U[L]*4+1],T[U[L]*4+2]);F.push(I)}}}else{S=g.model_data.meshPositionArray;F=g.model_data.meshColorArray}var P=new THREE.Geometry();P.vertices=S;P.colors=F;P.colorsNeedUpdate=true;var O=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});var J=new THREE.Line(P,O,THREE.LinePieces);J.position.set(H.x,H.y,H.z);J.centroid=H;return J}function D(I,G,J){g.model_data=I;if(g.model_data.shapes){for(var H=0;H<g.model_data.shapes.length;H++){var F=l(g.model_data.shapes[H]);F.name=g.model_data.shapes[H].name;m.add(F)}}else{var F=l(g.model_data);F.name=G;m.add(F)}if(g.afterCreate!=undefined){g.afterCreate(g.model_data)}A.add(m)}function l(Q){var L=Q.positionArray;var R=Q.indexArray;var S=[];if(Q.colorArray.length==4){for(var K=0;K<L.length/3;K++){S.push(Q.colorArray[0]);S.push(Q.colorArray[1]);S.push(Q.colorArray[2])}}else{S=[];var I=R.length;for(var J=0;J+2<Q.colorArray.length;J+=4){S.push(Q.colorArray[J]);S.push(Q.colorArray[J+1]);S.push(Q.colorArray[J+2])}}var F=[];var H;var O=new THREE.Geometry();for(var K=0;K+2<L.length;K+=3){O.vertices.push(new THREE.Vector3(L[K],L[K+1],L[K+2]));H=new THREE.Color();H.setRGB(S[K],S[K+1],S[K+2]);F.push(H)}if(Q.faces&&Q.faces.length>0){var G=Q.faces;for(var K=0;K<G.length;K++){if(G[K].length<3){continue}if(G[K].length<=4){if(G[K].length<=3){var N=new THREE.Face3(G[K][0],G[K][1],G[K][2])}else{if(G[K].length==4){var N=new THREE.Face4(G[K][0],G[K][1],G[K][2],G[K][3])}}N.vertexColors[0]=F[N.a];N.vertexColors[1]=F[N.b];N.vertexColors[2]=F[N.c];if(G[K].length>3){N.vertexColors[3]=F[N.d]}O.faces.push(N)}else{for(var J=1;J+1<G[K].length;J++){var N=new THREE.Face3(G[K][0],G[K][J],G[K][J+1]);N.vertexColors[0]=F[N.a];N.vertexColors[1]=F[N.b];N.vertexColors[2]=F[N.c];O.faces.push(N)}}}}else{for(var K=0;K+2<R.length;K+=3){var N=new THREE.Face3(R[K],R[K+1],R[K+2]);N.vertexColors[0]=F[N.a];N.vertexColors[1]=F[N.b];N.vertexColors[2]=F[N.c];O.faces.push(N)}}O.computeFaceNormals();O.computeVertexNormals();O.colorsNeedUpdate=true;var M=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:526344,vertexColors:THREE.VertexColors});var P=new THREE.Mesh(O,M);if(g.loading){jQuery(g.loading).html("Buffers Loaded")}return P}this.uninit=function(){if(this.client){this.client.cleanup()}};this.renderCallback=function(){var G=c-B;var F=G*0.00015;if(g.autoRotate){if(g.autoRotate.x){m.rotation.x+=F}if(g.autoRotate.y){m.rotation.y+=F}if(g.autoRotate.z){m.rotation.z+=F}}q.render(A,y)};this.clearScreen=function(){if(m){A.remove(m)}g.resetView();m=new THREE.Object3D();if(g.afterClearScreen!=undefined){g.afterClearScreen()}};this.displayObjectFile=function(J,G,I){var H=I||{};var K=H.renderDepth;if(J.objectClass=="P"&&J.numberVertices==81924){k(J,K)}else{if(J.objectClass=="P"){D(J,G,K)}else{if(J.objectClass=="L"){u(J,G,false,K)}else{alert("Object file not supported")}}}if(g.afterDisplayObject!=undefined){g.afterDisplayObject(m)}var H=I||{};var F=H.afterDisplay;if(F){F()}};function d(H,F,G){if(G==null){G=g.model_data.data}if(G.fixRange==false||G.fixRange==null){G.rangeMin=H;G.rangeMax=F}}this.updateClearColor=function(F){v.setClearColor(new THREE.Color(F))};this.updateClearColorFromName=function(F){if(F=="white"){g.updateClearColor(16777215)}else{if(F=="black"){g.updateClearColor(0)}else{if(F=="pink"){g.updateClearColor(16711935)}else{g.updateClearColor(8947848)}}}};this.resetView=function(){h.reset();w.reset();m.position.set(0,0,0);m.rotation.set(0,0,0);for(var F=0;F<m.children.length;F++){var G=m.children[F];G.visible=true;if(G.centroid){G.position.set(G.centroid.x,G.centroid.y,G.centroid.z)}else{G.position.set(0,0,0)}G.rotation.set(0,0,0)}};this.setupView=function(F){g.resetView();if(g.model_data&&g.model_data.num_hemispheres==2){var G=g.getViewParams();switch(G.view){case"superior":g.superiorView();break;case"medial":g.medialView();break;case"anterior":g.anteriorView();break;case"inferior":g.inferiorView();break;case"lateral":g.lateralView();break;case"posterior":g.posteriorView();break;default:g.superiorView();break}}if(m.getChildByName("left")){if(G.left==true){g.leftHemisphereVisible(true)}else{g.leftHemisphereVisible(false)}}if(m.getChildByName("right")){if(G.right==true){g.rightHemisphereVisible(true)}else{g.rightHemisphereVisible(false)}}};function a(F){return F*Math.PI/180}this.leftHemisphereVisible=function(F){m.getChildByName("left").visible=F};this.rightHemisphereVisible=function(F){m.getChildByName("right").visible=F};this.medialView=function(F){if(g.model_data.num_hemispheres==2){m.getChildByName("left").position.x-=100;m.getChildByName("left").rotation.z-=a(90);m.getChildByName("right").position.x+=100;m.getChildByName("right").rotation.z+=a(90);m.rotation.x+=a(-90)}};this.lateralView=function(F){if(g.model_data.num_hemispheres==2){m.getChildByName("left").position.x-=100;m.getChildByName("left").rotation.z+=a(-90);m.getChildByName("right").position.x+=100;m.getChildByName("right").rotation.z+=a(90);m.rotation.x+=a(90);m.rotation.y+=a(180)}};this.superiorView=function(){};this.inferiorView=function(){m.rotation.y+=a(180)};this.anteriorView=function(F){g.resetView();m.rotation.x+=a(-90);m.rotation.z+=a(180)};this.posteriorView=function(F){g.resetView();m.rotation.x+=a(-90)};this.separateHemispheres=function(F){if(g.model_data.num_hemispheres==2){m.children[0].position.x-=1;m.children[1].position.x+=1}};this.ZoomInOut=function(F){y.fov*=F;y.updateProjectionMatrix()};g.scrollMe=function(G){var F=(G.deltaY<0)?1/g.zoomFactor:g.zoomFactor;g.ZoomInOut(F);g.client.render()};function t(F){C();if(F){g.selectedInfo=F}}function C(){if(g.selectedInfo){g.highlightShape=null;g.selectedInfo=null}}this.click=function(K,H){var I=e.offset();mouseX=((K.clientX-I.left+$(window).scrollLeft())/e.width())*2-1;mouseY=-((K.clientY-I.top+$(window).scrollTop())/e.height())*2+1;var M=new THREE.Projector();var L=new THREE.Raycaster();C();var G=new THREE.Vector3(mouseX,mouseY,1);M.unprojectVector(G,y);L.set(y.position,G.sub(y.position).normalize());var J=L.intersectObject(m,true);if(J.length>0){var F=J[0];var N={vertex:F.face.a,point:new THREE.Vector3(F.point.x,F.point.y,F.point.z),object:F.object};return H(K,N)}else{jQuery(g.pickInfoElem).html("--nothing--");return false}};this.getInfoForVertex=function(G){var F=g.model_data.getVertexInfo(G);var H={vertex:F.vertex,point:new THREE.Vector3(F.position_vector[0],F.position_vector[1],F.position_vector[2])};return H};this.keyPressedCallback=function(G){var F=false;switch(G.which){case 38:g.ZoomInOut(1.1);F="ZoomIn";break;case 40:g.ZoomInOut(1/1.1);F="ZoomOut";break;case 32:g.separateHemispheres();F="Seperate";break}if(F){return false}else{return true}};function s(H,F,I,G){if(!H.minX||H.minX>F){H.minX=F}if(!H.maxX||H.maxX<F){H.maxX=F}if(!H.minY||H.minY>I){H.minY=I}if(!H.maxY||H.maxY<I){H.maxY=I}if(!H.minZ||H.minZ>G){H.minZ=G}if(!H.maxZ||H.maxZ<G){H.maxZ=G}}function o(F,K,J){var I=new THREE.SphereGeometry(2);var H=new THREE.MeshBasicMaterial({color:16711680});var G=new THREE.Mesh(I,H);G.position.set(F,K,J);A.add(G)}this.set_fill_mode_wireframe=function(){var G=m.children;for(var F=0;F<G.length;F++){var H=G[F].material;H.wireframe=true;if(H.emissive){H.emissive.setHex(125269879)}}};this.set_fill_mode_solid=function(){var G=m.children;for(var F=0;F<G.length;F++){var H=G[F].material;H.wireframe=false;if(H.emissive){H.emissive.setHex(0)}}};function E(G,I,J){var F=I||{};var H=F.beforeLoad;if(H){H()}jQuery.ajax({type:"GET",url:G,dataType:"text",success:function(K){J(K)},error:function(K,M,L){alert("Failure in loadFromURL: "+M)},data:{},timeout:100000})}function b(L,J,K){var I=L.files;if(I.length===0){return}var G=J||{};var H=G.beforeLoad;var F=new FileReader();F.file=I[0];if(H){H()}F.onloadend=function(M){K(M.target.result)};F.readAsText(I[0])}this.loadObjFromUrl=function(F,G){E(F,G,function(I){var J=F.split("/");var H=J[J.length-1];g.displayObjectFile(new MNIObject(I),H,G)})};this.loadWavefrontObjFromUrl=function(F,G){E(F,G,function(I){var J=F.split("/");var H=J[J.length-1];g.displayObjectFile(new WavefrontObj(I),H,G)})};this.loadObjFromFile=function(H,G){var F=G||{};b(H,F,function(I){var L=H.value.split("\\");var J=L[L.length-1];var K;if(F.format==="wavefront"){K=new WavefrontObj(I)}else{K=new MNIObject(I)}if(K.objectClass!=="__FAIL__"){g.displayObjectFile(K,J,F)}else{if(F.onError!=undefined){F.onError()}}})};this.loadSpectrumFromUrl=function(F,H){options=H||{};var G=options.afterLoadSpectrum;E(F,options,function(J){var I=new Spectrum(J);g.spectrum=I;if(G){G()}if(g.afterLoadSpectrum!=null){g.afterLoadSpectrum(I)}if(g.model_data.data){g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum,g.flip,g.clamped)}})};this.loadSpectrumFromFile=function(F){b(F,null,function(H){var G=new Spectrum(H);g.spectrum=G;if(g.afterLoadSpectrum!=null){g.afterLoadSpectrum(G)}if(g.model_data.data){g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum,g.flip,g.clamped)}})};this.loadDataFromFile=function(L){var F=L.files[0].name;var J=function(N){var M=new Data(N);M.fileName=F;if(M.values.length<g.model_data.positionArray.length/4){alert("Number of numbers in datafile lower than number of vertices Vertices"+g.model_data.positionArray.length/3+" data values:"+M.values.length);return -1}else{g.model_data.data=M}d(g.model_data.data.min,g.model_data.data.max);if(g.afterLoadData!=null){g.afterLoadData(g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.model_data.data)}g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum,g.flip,g.clamped);return null};if(F.match(/.*.mnc|.*.nii/)){var K=new XMLHttpRequest();if(F.match(/.*.mnc/)){K.open("POST","/minc/volume_object_evaluate",false)}else{K.open("POST","/nii/volume_object_evaluate",false)}var H=document.getElementById("datafile-form");var I=new FormData(H);K.send(I);var G=K.response;J(G)}else{b(L,null,J)}};this.loadSeriesDataFromFile=function(K){console.log(K.files.length);var J=K.files.length;g.seriesData=new Array(J);g.seriesData.numberFiles=J;var H=K.files;for(var G=0;G<J;G++){var F=new FileReader();F.file=H[G];var I=F.onloadend=(function(M,L){return function(N){console.log(N.target.result.length);console.log(L);g.seriesData[L]=new Data(N.target.result);g.seriesData[L].fileName=M.name}})(F.file,G);F.readAsText(H[G])}g.setupSeries()};this.setupSeries=function(){$('<div id="series">Series: </div>').appendTo("#surface_choice");var F=$("#series");$('<span id="series-value">0</span>').appendTo(F);$('<div id="series-slider" width="100px" + height="10"></div>').slider({value:0,min:0,max:g.seriesData.numberFiles-1,step:0.1,slide:function(G,H){if(H.value-Math.floor(H.value)<0.01){g.model_data.data=g.seriesData[H.value]}else{if(g.seriesData[0].fileName.match("pval.*")){g.model_data.data=new Data(interpolateDataArray(g.seriesData[Math.floor(H.value)],g.seriesData[Math.floor(H.value)+1],(H.value-Math.floor(H.value)),true))}else{g.model_data.data=new Data(interpolateDataArray(g.seriesData[Math.floor(H.value)],g.seriesData[Math.floor(H.value)+1],(H.value-Math.floor(H.value))))}}if(g.seriesData[0].fileName.match("mt.*")){$("#age_series").html("Age: "+(H.value*3+5).toFixed(1))}else{if(g.seriesData[0].fileName.match("pval.*")){$("#age_series").html("Age: "+(H.value*1+10))}}$(F).children("#series-value").html(H.value);if(g.model_data.data.values.length<g.model_data.positionArray.length/4){console.log("Number of numbers in datafile lower than number of vertices Vertices"+g.model_data.positionArray.length/3+" data values:"+g.model_data.data.values.length);return -1}d(g.model_data.data.min,g.model_data.data.max);if(g.afterLoadData!=null){g.afterLoadData(g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.model_data.data)}g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum,g.flip,g.clamped);return null}}).appendTo(F)};this.loadBlendDataFromFile=function(K){var J=K.files.length;g.blendData=new Array(J);g.blendData.numberFiles=J;var H=K.files;for(var G=0;G<J;G++){var F=new FileReader();F.file=H[G];var I=F.onloadend=(function(M,L){return function(O){g.blendData[L]=new Data(O.target.result);g.blendData.alpha=1/J;g.blendData[L].fileName=M.name;for(var N=0;N<2;N++){if(g.blendData[N]==undefined){console.log("not done yet");return}}d(g.blendData[0].values.min(),g.blendData[0].values.max(),g.blendData[0]);d(g.blendData[1].values.min(),g.blendData[1].values.max(),g.blendData[1]);if(g.afterLoadData!=null){g.afterLoadData(null,null,g.blendData,true)}g.blend($(".blend_slider").slider("value"))}})(F.file,G);F.readAsText(H[G])}g.setupBlendColors()};this.setupBlendColors=function(){console.log("Blend colors has ran "+g.blendData.numberFiles);$("#blend").remove();$('<div id="blend">Blend ratios: </div>').appendTo("#surface_choice");var F=$("#blend");$('<span id="blend_value'+i+'">0</span>').appendTo(F);$('<div class="blend_slider" id="blend_slider'+i+'" width="100px" + height="10"></div>').slider({value:0,min:0.1,max:0.99,value:0.5,step:0.01,slide:function(G,H){g.blend($(this).slider("value"))}}).appendTo(F)};this.blend=function(G){g.blendData[0].alpha=G;g.blendData[1].alpha=1-G;for(var F=2;F<g.blendData.length;F++){g.blendData[F].alpha=0}g.updateColors(g.blendData,null,null,g.spectrum,g.flip,g.clamped,true)};this.loadDataFromUrl=function(G,F){E(G,null,function(I,H){g.model_data.data=new Data(I);g.model_data.data.fileName=F;d(g.model_data.data.min,g.model_data.data.max);if(g.afterLoadData!=undefined){g.afterLoadData(g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.model_data.data)}g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum)})};this.updateColors=function(aj,X,ac,ah,P,V,aa,H,T){var M=T||{};var I=M.afterUpdate;g.clamped=V;if(aa){var ai=j.blendColorMap(ah,aj,0,1)}else{var ai=aj.createColorArray(X,ac,ah,P,V,g.model_data.colorArray,g.model_data)}if(g.model_data.num_hemispheres==2){var F=ai.slice(0,ai.length/2);var U=ai.slice(ai.length/2,ai.length);var R=[];var ad=[];var Y=m.getChildByName("left");var af=Y.geometry.faces;var J=m.getChildByName("right");var K=J.geometry.faces;var Q;var ae=K.length;var W=af.length;var L;var ag;L=Math.max(W,ae);for(var ab=0;ab<L;ab++){if(ab<W){Q=af[ab];ag=Q.a*4;Q.vertexColors[0].setRGB(F[ag],F[ag+1],F[ag+2]);ag=Q.b*4;Q.vertexColors[1].setRGB(F[ag],F[ag+1],F[ag+2]);ag=Q.c*4;Q.vertexColors[2].setRGB(F[ag],F[ag+1],F[ag+2]);if(Q.d){ag=Q.d*4;Q.vertexColors[3].setRGB(F[ag],F[ag+1],F[ag+2])}}if(ab<ae){Q=K[ab];ag=Q.a*4;Q.vertexColors[0].setRGB(U[ag],U[ag+1],U[ag+2]);ag=Q.b*4;Q.vertexColors[1].setRGB(U[ag],U[ag+1],U[ag+2]);ag=Q.c*4;Q.vertexColors[2].setRGB(U[ag],U[ag+1],U[ag+2]);if(Q.d){ag=Q.d*4;Q.vertexColors[3].setRGB(U[ag],U[ag+1],U[ag+2])}}}Y.geometry.colorsNeedUpdate=true;J.geometry.colorsNeedUpdate=true}else{var S=[];for(var ab=0;ab+2<ai.length;ab+=4){var O=new THREE.Color();O.setRGB(ai[ab],ai[ab+1],ai[ab+2]);S.push(O)}var N=m.children;for(var ab=0;ab<N.length;ab++){var G=N[ab].geometry.faces;for(var Z=0;Z<G.length;Z++){var Q=G[Z];Q.vertexColors[0]=S[Q.a];Q.vertexColors[1]=S[Q.b];Q.vertexColors[2]=S[Q.c];if(Q.d){Q.vertexColors[3]=S[Q.d]}}N[ab].geometry.colorsNeedUpdate=true}}if(I){I()}if(g.afterUpdateColors!=null){g.afterUpdateColors(aj,X,ac,ah)}return 1};this.rangeChange=function(I,F,J,K){var H=K||{};var G=H.afterChange;g.model_data.data.rangeMin=I;g.model_data.data.rangeMax=F;g.updateColors(g.model_data.data,g.model_data.data.rangeMin,g.model_data.data.rangeMax,g.spectrum,g.flip,J);if(G){G()}if(g.afterRangeChange!=null){g.afterRangeChange(I,F)}};this.changeShapeTransparency=function(G,H){var F=m.getChildByName(G);if(F){F.material.opacity=H;if(H==1){F.material.transparent=false}else{F.material.transparent=true}}};this.getImageUrl=function(){var I=document.createElement("canvas");var F=document.getElementById("spectrum_canvas");I.width=e.width();I.height=e.height();var J=I.getContext("2d");var G=new Image();function H(){var K=new Image();K.onload=function(){J.drawImage(K,0,0);window.open(I.toDataURL(),"screenshot")};K.src=F.toDataURL()}G.onload=function(){J.drawImage(G,0,0);if(F){H()}else{window.open(I.toDataURL(),"screenshot")}};G.src=v.domElement.toDataURL()};window.onresize=function(){e=$("#view-window");q.setSize(e.width(),e.height());y.aspect=e.width()/e.height();y.updateProjectionMatrix()};g.start()}var g_spectrum;function MacaccObject(b,g,h){var d=this;this.brainbrowser=b;this.dataSet=new Dataset(g,h);d.debugLineGroup;d.debugLine;d.selectedInfo=null;d.treeInfo;d.pickInfoElem;d.flashTimer=0;d.highlightMaterial;d.highlightShape;d.vertex;d.positionVector;d.primitiveIndex;d.dataArray;d.data_max;d.data_min;d.range_max;d.range_min;d.spectrum;d.coordinates=jQuery("#coordinates");d.selectPoint=null;function c(l,k){var j=l.vertex;if(j!=undefined&&k!=undefined){jQuery("#x-coord").val(l.point.x);jQuery("#y-coord").val(l.point.y);jQuery("#z-coord").val(l.point.z);jQuery("#v-coord").val(j);jQuery("#value-coord").val(k)}}this.pickClick=function(j,k){d.vertex=k.vertex;if(k.object&&k.object.model_num){d.vertex+=k.object.model_num*k.object.geometry.vertices.length}if(d.vertex){f();c(k,0);if(b.secondWindow!=undefined&&true){b.secondWindow.postMessage(d.vertex,"*")}}else{jQuery(d.pickInfoElem).html("--nothing--")}};this.change_model=function(l,j){var k=jQuery(l.target).val();b.clearScreen();b.loadObjFromUrl("/data/surfaces/surf_reg_model_both_"+k+".obj",j)};this.flipXCoordinate=function(){if(!d.dataArray){return}if(d.vertex>d.dataArray.length/2){d.vertex-=d.dataArray.length/2}else{d.vertex+=d.dataArray.length/2}c(b.getInfoForVertex(d.vertex),0);f()};this.valueAtPoint=function(k,l){var j=d.dataArray[l.vertex];c(l,j)};function a(){var l=jQuery("[name=modality]:checked").val();var k=jQuery("#data-sk").val();var j=jQuery("[name=statistic]:checked").val();return{modality:l,sk:k,statistic:j}}this.update_model=function(l){d.dataArray=l.current_data.values;b.current_dataset=l;if(jQuery("#fix_range").is(":checked")){if(!(d.data_min=parseFloat(jQuery("#data-range-min").val()))){if(!d.data_min===0){d.data_min=l.current_data.min}}if(!(d.data_max=parseFloat(jQuery("#data-range-max").val()))){if(!d.data_max===0){d.data_max=l.current_data.max}}}else{if(a().statistic=="T"){d.data_min=l.current_data.min;d.data_max=l.current_data.max}}var k=jQuery("#flip_range").is(":checked");var j=jQuery("#clamp_range").is(":checked");if(a().statistic=="T"){d.flipRange=k;b.updateColors(d.dataSet.current_data,d.data_min,d.data_max,b.spectrum,k,j)}else{d.flipRange=!k;jQuery("#range-slider").slider("option","min","0");jQuery("#range-slider").slider("option","max","1");b.updateColors(d.dataSet.current_data,0,1,b.spectrum,!k,j)}};function f(){d.dataSet.get_data(d.vertex,a(),d.update_model);jQuery(d.pickInfoElem).html("Viewing data for vertex: "+d.vertex)}this.show_atlas=function(){b.loadDataFromUrl("/assets/aal_atlas.txt")};function e(k,j){if(!jQuery("#fix_range").attr("checked")){jQuery("#data-range-min").val(k);jQuery("#data-range-max").val(j);jQuery("#range-slider").slider("values",0,k);jQuery("#range-slider").slider("values",1,j)}if(d.afterRangeChange!=undefined){d.afterRangeChange(k,j)}}this.range_change=function(){var k=parseFloat($("#data-range-min").val());var j=parseFloat($("#data-range-max").val());b.updateColors(d.dataSet.current_data,k,j,b.spectrum,$("#flip_range").is(":checked"),$("#clamp_range").is(":checked"));if(d.afterRangeChange!=undefined){d.afterRangeChange(k,j)}};this.data_control_change=function(){var j=a();if(j.modality=="AAL"){d.show_atlas()}else{if(d.vertex){f()}}};b.loadSpectrumFromUrl("/assets/spectral_spectrum.txt");b.valueAtPointCallback=this.valueAtPoint;b.clickCallback=this.pickClick}var brainbrowser;var macacc;function initMacacc(a,b){brainbrowser=new BrainBrowser();brainbrowser.getViewParams=function(){return{view:jQuery("[name=hem_view]:checked").val(),left:jQuery("#left_hem_visible").is(":checked"),right:jQuery("#right_hem_visible").is(":checked")}};brainbrowser.afterLoadSpectrum=function(c){var d=c.createSpectrumCanvasWithScale(0,5,null,false);jQuery("#spectrum").html(jQuery(d));brainbrowser.spectrumObj=c};brainbrowser.afterInit=function(c){c.loadObjFromUrl("/models/surf_reg_model_both.obj",{afterDisplay:function(){$("#loading").hide();macacc=new MacaccObject(c,a,b);brainbrowser.afterCreateBrain=function(){if(c.current_dataset!=undefined){macacc.update_model(c.current_dataset)}};macacc.afterRangeChange=function(f,d){if(macacc.flipRange==true){var e=c.spectrumObj.createSpectrumCanvasWithScale(f,d,null,true)}else{var e=c.spectrumObj.createSpectrumCanvasWithScale(f,d,null,false)}jQuery("#spectrum").html(jQuery(e))};jQuery(".data_controls").change(macacc.data_control_change);macacc.pickInfoElem=jQuery("#vertex_info");jQuery("#x-coord-flip").click(macacc.flipXCoordinate);jQuery("#model").change(function(d){$("#loading").show();macacc.change_model(d,{afterDisplay:function(){$("#loading").hide()}})})}});$("#meshmode").change(function(d){if(jQuery(d.target).is(":checked")){c.set_fill_mode_wireframe()}else{c.set_fill_mode_solid()}});$("#threedee").change(function(d){if($(d.target).is(":checked")){c.anaglyphEffect()}else{c.noEffect()}});$("#clear_color").change(function(f){var d=$(f.target).val();c.updateClearColorFromName(d)});$("#range-slider").slider({range:true,min:-10,max:15,values:[0,5],slide:function(d,e){jQuery("#data-range-min").val(e.values[0]);jQuery("#data-range-max").val(e.values[1]);if(c.current_dataset){macacc.range_change()}},step:0.1});$(".range-box").keypress(function(d){if(d.keyCode=="13"){macacc.range_change(d)}});$("#data-range-min").change(function(d){$("#range-slider").slider("values",0,$(this).val());macacc.afterRangeChange(parseFloat($("#data-range-min").val()),parseFloat($("#data-range-max").val()))});$("#data-range-max").change(function(d){jQuery("#range-slider").slider("values",1,jQuery(this).val());macacc.afterRangeChange(parseFloat(jQuery("#data-range-min").val()),parseFloat(jQuery("#data-range-max").val()))});$("[name=pointer]").change(function(d){if($("[name=pointer]:checked").val()=="AAL_atlas"){macacc.show_atlas()}});jQuery("#screenshot").click(function(d){jQuery(this).attr("href",c.client.toDataUR())});$("#view-window").mousedown(function(d){var f=jQuery("[name=pointer]:checked").val();if(d.ctrlKey||f=="check"){if(c.valueAtPointCallback){c.click(d,c.valueAtPointCallback)}}else{if(d.shiftKey||f=="select"){if(c.clickCallback){c.click(d,c.clickCallback)}}}});jQuery("#flip_range").change(function(d){macacc.update_model(brainbrowser.current_dataset)});jQuery("#clamp_range").change(function(d){macacc.update_model(brainbrowser.current_dataset)});jQuery("#flip_correlation").click(function(g){var f=-1*parseFloat(jQuery("#data-range-max").val());var d=-1*parseFloat(jQuery("#data-range-min").val());jQuery("#data-range-min").val(f).change();jQuery("#data-range-max").val(d).change();jQuery("#flip_range").attr("checked",!jQuery("#flip_range").attr("checked")).change()})};jQuery("#resetview").click(brainbrowser.setupView);jQuery(".view_button").change(brainbrowser.setupView);jQuery("[name=hem_view]").change(brainbrowser.setupView);jQuery(".button").button();jQuery(".button_set").buttonset();jQuery("#secondWindow").click(function(c){brainbrowser.secondWindow=window.open("/macacc.html","secondWindow")});window.addEventListener("message",function(f){var d=parseInt(f.data);var c=[brainbrowser.model_data.positionArray[d*3],brainbrowser.model_data.positionArray[d*3+1],brainbrowser.model_data.positionArray[d*3+2]];macacc.pickClick(f,{position_vector:c,vertex:d,stop:true,})},false);if(window.opener!=null){brainbrowser.secondWindow=window.opener}};