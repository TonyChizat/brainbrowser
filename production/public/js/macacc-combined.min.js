Array.prototype.min=function(){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.min.apply(Math,this.slice(c,c+b-1)))}}else{return Math.min.apply(Math,this)}return a.min()};Array.prototype.max=function(d){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.max.apply(Math,this.slice(c,c+b-1)))}}else{return Math.max.apply(Math,this)}return a.max()};function cloneArray(b){var c=new Array(b.length);for(var a=0;a<c.length;a++){c[a]=b[a]}return c}function rotateUint16Array90Left(f,d,a){var e=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){e[c*a+b]=f[b*d+(d-c)]}}return e}function rotateUint16Array90Right(f,d,a){var e=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){e[c*a+b]=f[(a-b)*d+c]}}return e}function interpolateDataArray(g,c,b,a){console.log(g.values.length);var e=g.values.length;var f=new Array(e);console.log("Percentage: "+b);for(var d=0;d<e;d++){if(a){f[d]=(g.values[d]*(100-b*100)+c.values[d]*(b*100))/100}else{f[d]=(g.values[d]*(100-b*100)+c.values[d]*(b*100))/100}}console.log(f.length);return f}function WavefrontObj(m){var j=this;m=m.split("\n");j.shapes=[];var b;var c=[];var t=[];var r=[];b={name:m.name|"undefined",faces:[],positionArray:[],colorArray:[],indexArray:[],texIndexArray:[],normalIndexArray:[]};j.shapes.push(b);for(var o=0;o<m.length;o++){var u=m[o].split(/\s+/);if(!(u[0].match("#"))||u==""){if(u[0]=="o"|u[0]=="g"){console.log(u[1]);b={name:u[1],faces:[],positionArray:[],colorArray:[],indexArray:[],texIndexArray:[],normalIndexArray:[]};j.shapes.push(b)}else{if(u[0]=="v"){c.push(parseFloat(u[1]));c.push(parseFloat(u[2]));c.push(parseFloat(u[3]))}else{if(u[0]=="vt"){for(var e=1;e<u.length;e++){t.push(parseFloat(u[e]))}}else{if(u[0]=="vn"){r.push(parseFloat(u[1]));r.push(parseFloat(u[2]));r.push(parseFloat(u[3]))}else{if(u[0]=="f"){var s=[];for(var h=1;h<4;h++){var f=u[h].split("/");s.push(parseInt(f[0])-1);b.indexArray.push(parseInt(f[0])-1);b.texIndexArray.push(parseInt(f[1])-1);if(f[2]){b.normalIndexArray.push(parseInt(f[2])-1)}}if(u.length>=4){for(h;h<u.length;h++){var f=u[h].split("/");s.push(parseInt(f[0])-1);var p=b.indexArray.length;b.indexArray.push(b.indexArray[p-1]);b.indexArray.push(b.indexArray[p-3]);b.indexArray.push(f[0]-1)}}b.faces.push(s)}}}}}}}var a=Array(c.length/3);var d=j.shapes.length;for(var g=0;g<d;g++){var q=j.shapes[g];q.positionArray=c;if(q.colorArray.length==0){q.colorArray=[0.8,0.8,0.8,1]}}j.objectClass="P";j.vertexArray=c;j.texCoordArray=t}function MNIObject(d){var j;var g=this;function b(m){g.num_hemispheres=1;var l=m.replace(/\s+$/,"");var n=l.replace(/^\s+/,"");j=n.split(/\s+/).reverse();g.objectClass=j.pop();if(g.objectClass=="P"){e();g.numberVertices=parseInt(j.pop());f();k();g.nitems=parseInt(j.pop())}else{if(g.objectClass=="L"){e();g.numberVertices=parseInt(j.pop());f();g.nitems=parseInt(j.pop())}else{throw new Error("That object class is not supported currently")}}h();c();a();if(g.objectClass=="P"){if(g.positionArray.length==81924*3){g.brainSurface=true;g.split_hemispheres()}}}function e(){if(g.objectClass=="P"){g.surfaceProperties={ambient:parseFloat(j.pop()),diffuse:parseFloat(j.pop()),specular_reflectance:parseFloat(j.pop()),specular_scattering:parseFloat(j.pop()),transparency:parseFloat(j.pop())}}else{if(g.objectClass=="L"){g.surfaceProperties={width:j.pop()}}}}function f(){g.positionArray=new Array();for(var l=0;l<g.numberVertices;l++){for(var m=0;m<3;m++){g.positionArray.push(parseFloat(j.pop()))}}}function k(){g.normalArray=new Array();for(var m=0;m<g.numberVertices;m++){for(var l=0;l<3;l++){g.normalArray.push(parseFloat(j.pop()))}}}function h(){g.colorFlag=parseInt(j.pop());g.colorArray=new Array();if(g.colorFlag===0){for(var l=0;l<4;l++){g.colorArray.push(parseFloat(j.pop()))}}else{if(g.colorFlag===1){for(var m=0;m<g.numberPolygons;m++){for(var l=0;l<4;l++){g.colorArray.push(parseFloat(j.pop()))}}}else{if(g.colorFlag===2){for(var m=0;m<g.numberVertices;m++){for(var l=0;l<4;l++){g.colorArray.push(parseFloat(j.pop()))}}}else{throw new Error("colorFlag not valid in that file")}}}}function c(){g.endIndicesArray=new Array();for(var l=0;l<g.nitems;l++){g.endIndicesArray.push(parseInt(j.pop()))}}function a(){g.indexArray=new Array();var m=j.length;for(var l=0;l<m;l++){g.indexArray.push(parseInt(j.pop()))}}g.split_hemispheres=function(){g.left={};g.right={};var p=g.positionArray.length;g.left.positionArray=g.positionArray.slice(0,p/2);g.right.positionArray=g.positionArray.slice(p/2,p);var o=g.indexArray.length;g.left.indexArray=g.indexArray.slice(0,o/2);g.right.indexArray=g.indexArray.slice(o/2,o);for(var l=0;l<g.right.indexArray.length;l++){g.right.indexArray[l]=g.right.indexArray[l]-2-o/3/2/2}var m=g.normalArray.length;g.left.normalArray=g.normalArray.slice(0,m/2);g.right.normalArray=g.normalArray.slice(m/2,m);g.left.colorFlag=g.colorFlag;g.right.colorFlag=g.colorFlag;if(g.colorFlag==0||g.colorFlag==1){g.left.colorArray=g.colorArray;g.right.colorArray=g.colorArray}else{var n=g.colorArray.length;g.left.colorArray=g.colorArray.slice(0,n/2);g.right.colorArray=g.colorArray.slice(n/2+1,-1)}g.left.numberVertices=g.numberVertices/2;g.right.numberVertices=g.numberVertices/2;g.left.numberPolygons=g.numberPolygons/2;g.right.numberPolygons=g.numberPolygons/2;g.num_hemispheres=2};g.getVertexInfo=function(m){var l=[g.positionArray[m*3],g.positionArray[m*3+1],g.positionArray[m*3+2]];return{vertex:m,position_vector:l}};g.get_vertex=function(v,s,l){if(g.num_hemispheres>1){var r=g[l];var o=0;if(l=="right"){o=2+r.indexArray.length/3/2}}else{var r=g;var o=0}var q=new Array();var y=v*3;for(var p=0;p<3;p++){q.push(r.indexArray[y+p])}var w=new Array();for(var p=0;p<3;p++){var u=q[p]*3;w[p]=new Array();for(var n=0;n<3;n++){w[p][n]=r.positionArray[u+n]}}var x=new Array();for(var p=0;p<3;p++){x.push(o3djs.math.distance(s,w[p]))}var m=0;if(x[1]<x[0]){m=1}if(x[2]<x[m]){m=2}var t=q[m]+o;var z=w[m];return{vertex:t,position_vector:z}};if(d){b(d)}}function ColorManager(){function c(l,d,p,h,n,k,m,g,f){var l=l.colors;var o=((n-h)+(n-h)/l.length)/l.length;for(var j=0;j<p.length;j++){if(p[j]<=h){var q=0}else{if(p[j]>n){var q=l.length-1}else{var q=parseInt((p[j]-h)/o)}}if(k){var e=255}else{var e=1}d[j*4+0]=e*l[q][0]*g+m*e;d[j*4+1]=e*l[q][1]*g+m*e;d[j*4+2]=e*l[q][2]*g+m*e;if(f){d[j*4+3]=e*f}else{d[j*4+3]=e}}return d}this.createColorMap=c;function a(k){var d=k[0];for(var g=0;g<k[0].length/4;g++){for(var f=1;f<k.length;f++){var e=d[g*4+3];var h=k[f][g*4+3];d[g*4]=d[g*4]*e+k[f][g*4]*h;d[g*4+1]=d[g*4+1]*e+k[f][g*4+1]*h;d[g*4+2]=d[g*4+2]*e+k[f][g*4+2]*h;d[g*4+3]=e+h}}return d}this.blendColors=a;function b(e,l,j,g){var d=l.length;var k=new Array(d);var h=0;for(var f=0;f<d;f++){k[f]=c(e,new Array(l[f].values.length),l[f].values,l[f].rangeMin,l[f].rangeMax,false,0,1,l[f].alpha)}return a(k)}this.blendColorMap=b}function Spectrum(e){var c=this;var a=new ColorManager();function b(f,p,h,o){var j=document.createElement("canvas");jQuery(j).attr("width",256);jQuery(j).attr("height",h);var l=new Array(256);for(var n=0;n<256;n++){if(o){l[255-n]=n}else{l[n]=n}}f=a.createColorMap(c,[],l,0,255,true,0,1);var g=j.getContext("2d");for(var m=0;m<256;m++){g.fillStyle="rgb("+parseInt(f[m*4])+","+parseInt(f[m*4+1])+","+parseInt(f[m*4+2])+")";g.fillRect(m,0,1,p)}console.log("rgb("+parseInt(f[100*4+0])+","+parseInt(f[100*4+1])+","+parseInt(f[100*4+2]));console.log(g.fillStyle);return j}c.createSpectrumCanvas=function(f){if(f==null){f=c.colors}var g=b(f,20,20,false);return g};c.createSpectrumCanvasWithScale=function(k,f,g,l){if(g==null){g=c.colors}var h=b(g,20,40,l);var j=h.getContext("2d");j.fillStyle="#FFA000";j.fillRect(0.5,20,1,10);j.fillText(k.toPrecision(3),0.5,40);j.fillRect(h.width/4,20,1,10);j.fillText(((k+f)/4).toPrecision(3),h.width/4,40);j.fillRect(h.width/2,20,1,10);j.fillText(((k+f)/2).toPrecision(3),h.width/2,40);j.fillRect(3*(h.width/4),20,1,10);j.fillText((3*((k+f)/4)).toPrecision(3),3*(h.width/4),40);j.fillRect(h.width-0.5,20,1,10);j.fillText(f.toPrecision(3),h.width-20,40);return h};function d(m){m=m.replace(/\s+$/,"");m=m.replace(/^\s+/,"");var j=m.split(/\n/);var f=new Array();for(var h=0;h<j.length;h++){var l=j[h].replace(/\s+$/,"").split(/\s+/);for(var g=0;g<l.length;g++){l[g]=parseFloat(l[g])}if(l.length<4){l.push(1)}f.push(l)}c.colors=f;return f}if(e!=undefined){d(e)}}function Data(b){var a=this;a.parse=function(c){c=c.replace(/\s+$/,"");c=c.replace(/^\s+/,"");a.values=c.split(/\s+/);for(var d=0;d<a.values.length;d++){a.values[d]=parseFloat(a.values[d])}a.min=a.values.min();a.max=a.values.max()};this.createColorArray=function(f,n,m,h,q,d,k){var m=m.colors;var p=new Array();var o=((n-f)+(n-f)/m.length)/m.length;for(var g=0;g<a.values.length;g++){if(a.values[g]<=f){if(a.values[g]<f&&!q){var r=-1}else{var r=0}}else{if(a.values[g]>n){if(!q){var r=-1}else{var r=m.length-1}}else{var r=parseInt((a.values[g]-f)/o)}}if(h&&r!=-1){p.push.apply(p,m[m.length-1-r])}else{if(r==-1){if(d.length==4){p.push.apply(p,d)}else{p.push.apply(p,[d[g*4],d[g*4+1],d[g*4+2],d[g*4+3]])}}else{p.push.apply(p,m[r])}}}if(k.num_hemisphere!=2){var l=[];var c=k.indexArray.length;for(var e=0;e<c;e++){l[e*4]=p[k.indexArray[e]*4];l[e*4+1]=p[k.indexArray[e]*4+1];l[e*4+2]=p[k.indexArray[e]*4+2];l[e*4+3]=p[k.indexArray[e]*4+3]}p.nonIndexedColorArray=l}return p};if(b){if(typeof b=="string"){a.parse(b)}else{if(b.values!=undefined){this.values=cloneArray(b.values);this.min=this.values.min();this.max=this.values.max()}else{console.log("copying data length: "+b.length);this.values=b;this.min=b.min();this.max=b.max()}}}}function Dataset(a,b){if(b==null){this.path=function(g,f){var d="ICBM152_"+f.sk;if(f.modality=="CT"){var c="ICBM152_"+f.modality+"_MACACC_mean"}else{var c="ICBM152_"+f.modality+"_MACACC_size"}if(f.statistic=="T"){var e="T_map/T_"}else{if(f.statistic=="P1"){var e="RTF_C_map/RTF_C_"}else{if(f.statistic=="P2"){var e="RTF_V_map/RTF_V_"}}}if(a==null){a="/data/"}return a+c+"/"+d+"/"+e+g+".txt"}}else{this.path=function(d,c){return a}}this.get_data=function(f,c,h){if(f=="aal_atlas"){var g="/assets/aal_atlas.txt"}else{var g=this.path(f,c)}if(b){var e={vertex:f,modality:c.modality,sk:c.sk,statistic:c.statistic}}var d=this;jQuery.ajax({type:"GET",url:g,data:e,dataType:"text",success:function(j){d.current_data=new Data(j);h(d)},error:function(){jQuery(g_pickInfoElem).html("Error loading map")}})}}function bbObject(a){var b=a;b.createBrain=function(d,c){b.model_data=d;if(d.num_hemispheres==2){var e={left:b.createHemisphere(d.left,"left"),right:b.createHemisphere(d.right,"right"),num_hemisphere:2}}else{var e=b.createHemisphere(d,"filename");e.num_hemisphere=1}if(b.brainTransform==null){b.brainTransform=b.pack.createObject("Transform");if(d.num_hemispheres==2){b.brainHemisphereTransforms={};b.brainHemisphereTransforms.left=b.pack.createObject("Transform");b.brainHemisphereTransforms.right=b.pack.createObject("Transform")}}else{b.brainTransform.removeShape(b.brainTransform.shapes[0]);if(b.brainTransform.children[0]!=null){b.brainTransform.children[0].removeShape(b.brainTransform.children[0].shapes[0])}if(b.brainTransform.children[1]!=null){b.brainTransform.children[1].removeShape(b.brainTransform.children[1].shapes[0])}}if(d.num_hemispheres!=2){b.brainTransform.removeParam(b.brainTransform.children[0]);b.brainTransform.removeParam(b.brainTransform.children[1])}if(d.num_hemispheres==2&&b.brainHemisphereTransforms==null){b.brainHemisphereTransforms={};b.brainHemisphereTransforms.left=b.pack.createObject("Transform");b.brainHemisphereTransforms.right=b.pack.createObject("Transform")}b.brainTransform.parent=b.client.root;if(e.num_hemisphere==1){b.brainTransform.addShape(e);e.createDrawElements(b.pack,null)}else{b.brainHemisphereTransforms.left.parent=b.brainTransform;b.brainHemisphereTransforms.right.parent=b.brainTransform;b.brainHemisphereTransforms.left.addShape(e.left);b.brainHemisphereTransforms.right.addShape(e.right);e.left.createDrawElements(b.pack,null);e.right.createDrawElements(b.pack,null)}b.model_data=d;if(b.afterCreateBrain!=undefined){b.afterCreateBrain(b.model_data)}};b.createLineObject=function(f,e,h){b.model_data=f;var c=b.createMaterial("/shaders/line.txt");var g=c.getParam("transAlpha");g.value=1;if(h){console.log("mesh")}var d=b.createLineShape(c,f,e,h);d.name=e;if(b.brainTransform==undefined){b.brainTransform=b.pack.createObject("Transform")}b.brainTransform.parent=b.client.root;b.brainTransform.addShape(d);d.createDrawElements(b.pack,null);b.model_data=f;if(b.afterCreate!=undefined){b.afterCreate(b.model_data)}};b.createPolygonObject=function(f,e){b.model_data=f;var c=b.createMaterial("/shaders/blinnphong.txt");c=b.blinnphongParams(c);if(b.brainTransform==undefined){b.brainTransform=b.pack.createObject("Transform")}b.brainTransform.parent=b.client.root;if(f.shapes){console.log("multi_shape");console.log(f);for(var g=0;g<f.shapes.length;g++){console.log(f.shapes[g]);var d=b.createPolygonShape(c,f.shapes[g]);d.name=f.shapes[g].name;b.brainTransform.addShape(d);d.createDrawElements(b.pack,null)}}else{var d=b.createPolygonShape(c,f);d.name=e;b.brainTransform.addShape(d);d.createDrawElements(b.pack,null)}b.model_data=f;if(b.afterCreate!=undefined){b.afterCreate(b.model_data)}};b.createHemisphere=function(h,e){var j=b.createMaterial("/shaders/blinnphong.txt");j=b.blinnphongParams(j);var r=b.pack.createObject("Shape");var o=b.pack.createObject("Primitive");var t=b.pack.createObject("StreamBank");o.material=j;o.owner=r;o.streamBank=t;r.name=e;o.primitiveType=b.o3d.Primitive.TRIANGLELIST;var d=b.pack.createObject("State");b.enableAlphaBlending(d);o.material.state=d;var l=b.pack.createObject("VertexBuffer");var n=l.createField("FloatField",3);if(!h.positionArray){alert("PositionArray nil");return false}l.set(h.positionArray);b.numberVertices=h.numberVertices;var s=(h.positionArray.length/3);o.numberVertices=b.numberVertices;if(!h.indexArray){alert("Index Array nil");return false}o.numberPrimitives=h.indexArray.length/3;var g=b.pack.createObject("IndexBuffer");g.set(h.indexArray);o.indexBuffer=g;var q=b.pack.createObject("VertexBuffer");var k=q.createField("FloatField",3);q.set(h.normalArray);var m=[];if(h.colorArray.length==4){for(var f=0;f<s;f++){m.push.apply(m,h.colorArray)}}else{m=h.colorArray}if(m.length<h.positionArray.length){alert("Problem with the colors: "+m.length)}var p=b.pack.createObject("VertexBuffer");var c=p.createField("FloatField",4);p.set(m);m=[];if(b.loading){jQuery(b.loading).html("Buffers Loaded")}t.setVertexStream(b.o3d.Stream.POSITION,0,n,0);t.setVertexStream(b.o3d.Stream.NORMAL,0,k,0);t.setVertexStream(b.o3d.Stream.COLOR,0,c,0);return r};b.createLineShape=function(o,g,y,c){var n=b.pack.createObject("Shape");var x=b.pack.createObject("StreamBank");n.name=y;if(!g.positionArray){alert("PositionArray nil");return false}b.numberVertices=g.numberVertices;var u=b.pack.createObject("Primitive");u.material=o;u.owner=n;u.streamBank=x;u.primitiveType=b.o3d.Primitive.LINELIST;var l=b.pack.createObject("State");b.enableAlphaBlending(l);u.material.state=l;var e=new Array();for(var t=0;t<g.nitems;t++){if(t==0){var h=0}else{var h=g.endIndicesArray[t-1]}e.push(g.indexArray[h]);for(var r=h+1;r<g.endIndicesArray[t]-1;r++){e.push(g.indexArray[r]);e.push(g.indexArray[r])}e.push(g.indexArray[g.endIndicesArray[t]-1])}if(!c){var f=b.pack.createObject("IndexBuffer");u.numberPrimitives=e.length/2;u.numberVertices=e.length;b.indexArray=e;var d=new Float32Array(e.length*3);for(var s=0;s<e.length;s++){d[s*3]=g.positionArray[e[s]*3];d[s*3+1]=g.positionArray[e[s]*3+1];d[s*3+2]=g.positionArray[e[s]*3+2]}var m=[];if(g.colorArray.length==4){for(var t=0;t<numberVertices;t++){m.push.apply(m,[0.5,0.5,0.7,1])}}else{m=new Float32Array(e.length*4);for(var s=0;s<e.length;s++){m[s*4]=g.colorArray[e[s]*4];m[s*4+1]=g.colorArray[e[s]*4+1];m[s*4+2]=g.colorArray[e[s]*4+2];m[s*4+3]=g.colorArray[e[s]*4+3]}}}else{console.log("mesh shape");u.numberVertices=g.meshPostionArray.length/3;u.numberPrimitives=u.numberVertices/2;var d=g.meshPositionArray;var m=g.meshColorArray}var v=b.pack.createObject("VertexBuffer");var p=v.createField("FloatField",3);v.set(d);x.setVertexStream(b.o3d.Stream.POSITION,0,p,0);if(m.length/4<d.length/3){alert("Problem with the colors: "+m.length)}var q=b.pack.createObject("VertexBuffer");var w=q.createField("FloatField",4);q.set(m);x.setVertexStream(b.o3d.Stream.COLOR,0,w,0);if(b.loading){jQuery(b.loading).html("Buffers Loaded")}b.pack.gl.lineWidth(1);return n};b.createPolygonShape=function(o,f,F){var C=b.pack.createObject("Shape");var E=b.pack.createObject("StreamBank");C.name=F;if(!f.positionArray){alert("PositionArray nil");return false}b.numberVertices=f.numberVertices;var d=b.pack.createObject("Primitive");d.material=o;d.owner=C;d.streamBank=E;d.primitiveType=b.o3d.Primitive.TRIANGLELIST;var g=b.pack.createObject("State");b.enableAlphaBlending(g);d.material.state=g;if(f.nonindexed==undefined){var e=f.indexArray;d.numberPrimitives=e.length/3;d.numberVertices=e.length;b.indexArray=e;var c=new Float32Array(e.length*3);var A=new Array(e.length*3);var p=new Array(e.length*4);var z=new Float32Array(e.length*3);var m=e.length;for(var w=0;w<m;w++){c[w*3]=f.positionArray[e[w]*3];c[w*3+1]=f.positionArray[e[w]*3+1];c[w*3+2]=f.positionArray[e[w]*3+2];z[w*3]=f.normalArray[e[w]*3];z[w*3+1]=f.normalArray[e[w]*3+1];z[w*3+2]=f.normalArray[e[w]*3+2]}for(var v=0;v<m;v+=3){var y=[];y[0]=[f.positionArray[e[v]*3],f.positionArray[e[v]*3+1],f.positionArray[e[v]*3+2]];y[1]=[f.positionArray[e[v+1]*3],f.positionArray[e[v+1]*3+1],f.positionArray[e[v+1]*3+2]];y[2]=[f.positionArray[e[v+2]*3],f.positionArray[e[v+2]*3+1],f.positionArray[e[v+2]*3+2]];A.push.apply(A,y[0]);A.push.apply(A,y[1]);A.push.apply(A,y[1]);A.push.apply(A,y[2]);A.push.apply(A,y[2]);A.push.apply(A,y[0])}C.meshPositionArray=A}else{d.numberPrimitives=f.positionArray.length/3/3;d.numberVertices=f.positionArray.length/3;var c=new Float32Array(f.positionArray);var z=new Float32Array(f.normalArray);console.log(f)}var h=[];if(f.colorArray.length==4){for(var x=0;x<d.numberVertices;x++){h.push.apply(h,f.colorArray)}}else{h=new Float32Array(e.length*4);var m=e.length;for(var w=0;w<m;w++){h[w*4]=h[w*4+1]=f.colorArray[e[w]*4+1];h[w*4+2]=f.colorArray[e[w]*4+2];h[w*4+3]=f.colorArray[e[w]*4+3]}for(var t=0;t<indexArrayLenght;t+=3){var u=[];u[0]=[f.colorArray[e[w]*4],f.colorArray[e[w]*4+1],f.colorArray[e[w]*4+2],f.colorArray[e[w]*4+3]];u[1]=[f.colorArray[e[w+1]*4],f.colorArray[e[w+1]*4+1],f.colorArray[e[w+1]*4+2],f.colorArray[e[w+1]*4+3]];u[2]=[f.colorArray[e[w+2]*4],f.colorArray[e[w+2]*4+1],f.colorArray[e[w+2]*4+2],f.colorArray[e[w+2]*4+3]];p.push.apply(p,u[0]);p.push.apply(p,u[1]);p.push.apply(p,u[1]);p.push.apply(p,u[2]);p.push.apply(p,u[2]);p.push.apply(p,u[0])}}f.meshPositionArray=A;f.meshColorArray=p;var n=b.pack.createObject("VertexBuffer");var r=n.createField("FloatField",3);n.set(z);E.setVertexStream(b.o3d.Stream.NORMAL,0,r,0);var B=b.pack.createObject("VertexBuffer");var q=B.createField("FloatField",3);B.set(c);E.setVertexStream(b.o3d.Stream.POSITION,0,q,0);if(h.length<f.positionArray.length){alert("Problem with the colors: "+h.length)}var s=b.pack.createObject("VertexBuffer");var D=s.createField("FloatField",4);s.set(h);h=[];E.setVertexStream(b.o3d.Stream.COLOR,0,D,0);if(b.loading){jQuery(b.loading).html("Buffers Loaded")}return C}}function BrainBrowser(){var f=this;bbObject(this);var h=new ColorManager();var d;var t;var w;var v;var x;var l=new THREE.Object3D();var g;var u;this.start=function(){window.onload=function(){setTimeout(function(){f.init()},1)}};this.init=function(){x=new THREE.Scene();d=$("#view-window");w=new THREE.PerspectiveCamera(30,d.width()/d.height(),0.1,5000);if(e()){t=new THREE.WebGLRenderer({clearColor:8947848,clearAlpha:1,preserveDrawingBuffer:true})}else{d.html(m());return}t.setSize(d.width(),d.height());d.append(t.domElement);w.position.z=500;v=new THREE.PointLight(16777215);v.position.x=0;v.position.y=0;v.position.z=500;x.add(v);g=new THREE.TrackballControls(w,d[0]);u=new THREE.TrackballControls(v,d[0]);g.zoomSpeed=2;u.zoomSpeed=2;function C(D){requestAnimationFrame(C);g.update();u.update();f.renderCallback()}if(this.afterInit){this.afterInit(f)}window.onresize();f.loadSpectrumFromUrl("/assets/spectral_spectrum.txt");C()};
/*! 
   * WebGL test taken from Detector.js by
   * alteredq / http://alteredqualia.com/
   * mr.doob / http://mrdoob.com/
  */
function e(){try{return !!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(C){return false}}function m(){var D='BrainBrowser requires <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>.<br/>';D+=window.WebGLRenderingContext?"Your browser seems to support it, but it is <br/> disabled or unavailable.<br/>":"Your browser does not seem to support it.<br/>";D+='Test your browser\'s WebGL support <a href="http://get.webgl.org/">here</a>.';var C=$('<div id="webgl-error">'+D+"</div>");return C}this.setCamera=function(C,E,D){w.position.set(C,E,D)};this.getModel=function(){return l};function j(E,F){f.model_data=E;var D=p(E.left);D.name="left";D.model_num=0;var C=p(E.right);C.name="right";C.model_num=1;l.add(D);l.add(C);x.add(l)}function p(F){var K=F.positionArray;var E=F.indexArray;var J={};var D={};for(var G=0;G+2<K.length;G+=3){q(J,K[G],K[G+1],K[G+2])}D.x=J.minX+0.5*(J.maxX-J.minX);D.y=J.minY+0.5*(J.maxY-J.minY);D.z=J.minY+0.5*(J.maxZ-J.minZ);var I=new THREE.Geometry();for(var G=0;G+2<K.length;G+=3){I.vertices.push(new THREE.Vector3(K[G]-D.x,K[G+1]-D.y,K[G+2]-D.z))}for(var G=0;G+2<E.length;G+=3){I.faces.push(new THREE.Face3(E[G],E[G+1],E[G+2]))}I.computeFaceNormals();I.computeVertexNormals();var H=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:526344,vertexColors:THREE.VertexColors});var C=new THREE.Mesh(I,H);C.centroid=D;C.position.set(D.x,D.y,D.z);return C}function s(E,C,G,F){var D=o(E,G);D.name=C;if(F){D.renderDepth=F}l.add(D);x.add(l)}function o(J,S){f.model_data=J;var R=[];var P=[];var C=[];var N={};var E={};for(var K=0;K<f.model_data.nitems;K++){if(K==0){var D=0}else{var D=f.model_data.endIndicesArray[K-1]}R.push(f.model_data.indexArray[D]);for(var H=D+1;H<f.model_data.endIndicesArray[K]-1;H++){R.push(f.model_data.indexArray[H]);R.push(f.model_data.indexArray[H])}R.push(f.model_data.indexArray[f.model_data.endIndicesArray[K]-1])}var O=f.model_data.positionArray;for(var I=0;I<R.length;I++){q(N,O[R[I]*3],O[R[I]*3+1],O[R[I]*3+2])}E.x=N.minX+0.5*(N.maxX-N.minX);E.y=N.minY+0.5*(N.maxY-N.minY);E.z=N.minY+0.5*(N.maxZ-N.minZ);if(!S){for(var I=0;I<R.length;I++){P.push(new THREE.Vector3(O[R[I]*3]-E.x,O[R[I]*3+1]-E.y,O[R[I]*3+2]-E.z))}var Q=[];if(f.model_data.colorArray.length==4){for(var K=0;K<numberVertices;K++){Q.push.apply(Q,[0.5,0.5,0.7,1])}}else{var Q=f.model_data.colorArray;for(var I=0;I<R.length;I++){var F=new THREE.Color();F.setRGB(Q[R[I]*4],Q[R[I]*4+1],Q[R[I]*4+2]);C.push(F)}}}else{console.log("mesh shape");P=f.model_data.meshPositionArray;C=f.model_data.meshColorArray}var M=new THREE.Geometry();M.vertices=P;M.colors=C;M.colorsNeedUpdate=true;var L=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});var G=new THREE.Line(M,L,THREE.LinePieces);G.position.set(E.x,E.y,E.z);G.centroid=E;return G}function z(F,D,G){f.model_data=F;if(f.model_data.shapes){for(var E=0;E<f.model_data.shapes.length;E++){var C=k(f.model_data.shapes[E]);C.name=f.model_data.shapes[E].name;l.add(C)}}else{var C=k(f.model_data);C.name=D;l.add(C)}if(f.afterCreate!=undefined){f.afterCreate(f.model_data)}x.add(l)}function k(N){var I=N.positionArray;var O=N.indexArray;var P=[];if(N.colorArray.length==4){for(var H=0;H<I.length/3;H++){P.push(N.colorArray[0]);P.push(N.colorArray[1]);P.push(N.colorArray[2])}}else{P=[];var F=O.length;for(var G=0;G+2<N.colorArray.length;G+=4){P.push(N.colorArray[G]);P.push(N.colorArray[G+1]);P.push(N.colorArray[G+2])}}var C=[];var E;var L=new THREE.Geometry();for(var H=0;H+2<I.length;H+=3){L.vertices.push(new THREE.Vector3(I[H],I[H+1],I[H+2]));E=new THREE.Color();E.setRGB(P[H],P[H+1],P[H+2]);C.push(E)}if(N.faces&&N.faces.length>0){var D=N.faces;for(var H=0;H<D.length;H++){if(D[H].length<3){continue}if(D[H].length<=4){if(D[H].length<=3){var K=new THREE.Face3(D[H][0],D[H][1],D[H][2])}else{if(D[H].length==4){var K=new THREE.Face4(D[H][0],D[H][1],D[H][2],D[H][3])}}K.vertexColors[0]=C[K.a];K.vertexColors[1]=C[K.b];K.vertexColors[2]=C[K.c];if(D[H].length>3){K.vertexColors[3]=C[K.d]}L.faces.push(K)}else{for(var G=1;G+1<D[H].length;G++){var K=new THREE.Face3(D[H][0],D[H][G],D[H][G+1]);K.vertexColors[0]=C[K.a];K.vertexColors[1]=C[K.b];K.vertexColors[2]=C[K.c];L.faces.push(K)}}}}else{for(var H=0;H+2<O.length;H+=3){var K=new THREE.Face3(O[H],O[H+1],O[H+2]);K.vertexColors[0]=C[K.a];K.vertexColors[1]=C[K.b];K.vertexColors[2]=C[K.c];L.faces.push(K)}}L.computeFaceNormals();L.computeVertexNormals();L.colorsNeedUpdate=true;var J=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:526344,vertexColors:THREE.VertexColors});var M=new THREE.Mesh(L,J);if(f.loading){jQuery(f.loading).html("Buffers Loaded")}return M}this.uninit=function(){if(this.client){this.client.cleanup()}};this.renderCallback=function(C){if(f.autoRotate){if(f.autoRotate.x){l.rotation.x+=0.01}if(f.autoRotate.y){l.rotation.y+=0.01}if(f.autoRotate.z){l.rotation.z+=0.01}}t.render(x,w)};this.clearScreen=function(){if(l){x.remove(l)}f.resetView();l=new THREE.Object3D();if(f.afterClearScreen!=undefined){f.afterClearScreen()}};this.displayObjectFile=function(F,C,E){var D=E||{};var G=D.renderDepth;if(F.objectClass=="P"&&F.numberVertices==81924){j(F,G)}else{if(F.objectClass=="P"){z(F,C,G)}else{if(F.objectClass=="L"){s(F,C,false,G)}else{alert("Object file not supported")}}}if(f.afterDisplayObject!=undefined){f.afterDisplayObject(l)}};function c(E,C,D){if(D==null){D=f.model_data.data}if(D.fixRange==false||D.fixRange==null){D.rangeMin=E;D.rangeMax=C}}this.updateClearColor=function(C){t.setClearColor(new THREE.Color(C))};this.updateClearColorFromName=function(C){if(C=="white"){f.updateClearColor(16777215)}else{if(C=="black"){f.updateClearColor(0)}else{if(C=="pink"){f.updateClearColor(16711935)}else{f.updateClearColor(8947848)}}}};this.resetView=function(){g.reset();u.reset();l.position.set(0,0,0);l.rotation.set(0,0,0);for(var C=0;C<l.children.length;C++){var D=l.children[C];D.visible=true;if(D.centroid){D.position.set(D.centroid.x,D.centroid.y,D.centroid.z)}else{D.position.set(0,0,0)}D.rotation.set(0,0,0)}};this.setupView=function(C){f.resetView();if(f.model_data&&f.model_data.num_hemispheres==2){var D=f.getViewParams();switch(D.view){case"superior":f.superiorView();break;case"medial":f.medialView();break;case"anterior":f.anteriorView();break;case"inferior":f.inferiorView();break;case"lateral":f.lateralView();break;case"posterior":f.posteriorView();break;default:f.superiorView();break}}if(l.getChildByName("left")){if(D.left==true){f.leftHemisphereVisible(true)}else{f.leftHemisphereVisible(false)}}if(l.getChildByName("right")){if(D.right==true){f.rightHemisphereVisible(true)}else{f.rightHemisphereVisible(false)}}};function a(C){return C*Math.PI/180}this.leftHemisphereVisible=function(C){l.getChildByName("left").visible=C};this.rightHemisphereVisible=function(C){l.getChildByName("right").visible=C};this.medialView=function(C){if(f.model_data.num_hemispheres==2){l.getChildByName("left").position.x-=100;l.getChildByName("left").rotation.z-=a(90);l.getChildByName("right").position.x+=100;l.getChildByName("right").rotation.z+=a(90);l.rotation.x+=a(-90)}};this.lateralView=function(C){if(f.model_data.num_hemispheres==2){l.getChildByName("left").position.x-=100;l.getChildByName("left").rotation.z+=a(-90);l.getChildByName("right").position.x+=100;l.getChildByName("right").rotation.z+=a(90);l.rotation.x+=a(90);l.rotation.y+=a(180)}};this.superiorView=function(){};this.inferiorView=function(){l.rotation.y+=a(180)};this.anteriorView=function(C){f.resetView();l.rotation.x+=a(-90);l.rotation.z+=a(180)};this.posteriorView=function(C){f.resetView();l.rotation.x+=a(-90)};this.separateHemispheres=function(C){if(f.model_data.num_hemispheres==2){l.children[0].position.x-=1;l.children[1].position.x+=1}};this.ZoomInOut=function(C){w.fov*=C;w.updateProjectionMatrix()};f.scrollMe=function(D){var C=(D.deltaY<0)?1/f.zoomFactor:f.zoomFactor;f.ZoomInOut(C);f.client.render()};function r(C){y();if(C){f.selectedInfo=C}}function y(){if(f.selectedInfo){f.highlightShape=null;f.selectedInfo=null}}this.click=function(H,E){var F=d.offset();mouseX=((H.clientX-F.left)/d.width())*2-1;mouseY=-((H.clientY-F.top)/d.height())*2+1;var J=new THREE.Projector();var I=new THREE.Raycaster();y();var D=new THREE.Vector3(mouseX,mouseY,1);J.unprojectVector(D,w);I.set(w.position,D.sub(w.position).normalize());var G=I.intersectObject(l,true);if(G.length>0){var C=G[0];var K={vertex:C.face.a,point:new THREE.Vector3(C.point.x,C.point.y,C.point.z),object:C.object};return E(H,K)}else{jQuery(f.pickInfoElem).html("--nothing--");return false}};this.getInfoForVertex=function(D){var C=f.model_data.getVertexInfo(D);var E={vertex:C.vertex,point:new THREE.Vector3(C.position_vector[0],C.position_vector[1],C.position_vector[2])};return E};this.keyPressedCallback=function(D){var C=false;switch(D.which){case 38:f.ZoomInOut(1.1);C="ZoomIn";break;case 40:f.ZoomInOut(1/1.1);C="ZoomOut";break;case 32:f.separateHemispheres();C="Seperate";break}if(C){return false}else{return true}};function q(E,C,F,D){if(!E.minX||E.minX>C){E.minX=C}if(!E.maxX||E.maxX<C){E.maxX=C}if(!E.minY||E.minY>F){E.minY=F}if(!E.maxY||E.maxY<F){E.maxY=F}if(!E.minZ||E.minZ>D){E.minZ=D}if(!E.maxZ||E.maxZ<D){E.maxZ=D}}function n(C,H,G){var F=new THREE.SphereGeometry(2);var E=new THREE.MeshBasicMaterial({color:16711680});var D=new THREE.Mesh(F,E);D.position.set(C,H,G);x.add(D)}this.set_fill_mode_wireframe=function(){var D=l.children;for(var C=0;C<D.length;C++){D[C].material.wireframe=true}};this.set_fill_mode_solid=function(){var D=l.children;for(var C=0;C<D.length;C++){D[C].material.wireframe=false}};function B(C,D,E){jQuery.ajax({type:"GET",url:C,dataType:"text",success:function(F){E(F)},error:function(F,H,G){alert("Failure in loadFromURL: "+H)},data:{},async:D,timeout:100000})}function b(F,E){var C=new FileReader();var D=F.files;C.file=D[0];C.onloadend=function(G){E(G.target.result)};C.readAsText(D[0])}this.loadObjFromUrl=function(C,D){B(C,false,function(F){var G=C.split("/");var E=G[G.length-1];f.displayObjectFile(new MNIObject(F),E,D)})};this.loadWavefrontObjFromUrl=function(C,D){B(C,false,function(F){var G=C.split("/");var E=G[G.length-1];f.displayObjectFile(new WavefrontObj(F),E,D)})};this.loadObjFromFile=function(E,D){var C=D||{};b(E,function(F){var I=E.value.split("\\");var G=I[I.length-1];var H;if(C.format=="wavefront"){H=new WavefrontObj(F)}else{H=new MNIObject(F)}f.displayObjectFile(H,G,C)})};this.loadSpectrumFromUrl=function(C){B(C,true,function(E){var D=new Spectrum(E);f.spectrum=D;if(f.afterLoadSpectrum!=null){f.afterLoadSpectrum(D)}if(f.model_data.data){f.updateColors(f.model_data.data,f.model_data.data.rangeMin,f.model_data.data.rangeMax,f.spectrum,f.flip,f.clamped)}})};this.loadSpectrumFromFile=function(C){b(C,function(E){var D=new Spectrum(E);f.spectrum=D;if(f.afterLoadSpectrum!=null){f.afterLoadSpectrum(D)}if(f.model_data.data){f.updateColors(f.model_data.data,f.model_data.data.rangeMin,f.model_data.data.rangeMax,f.spectrum,f.flip,f.clamped)}})};function A(C){}this.loadDataFromFile=function(I){var C=I.files[0].name;var G=function(K){var J=new Data(K);J.fileName=C;if(J.values.length<f.model_data.positionArray.length/4){alert("Number of numbers in datafile lower than number of vertices Vertices"+f.model_data.positionArray.length/3+" data values:"+J.values.length);return -1}else{f.model_data.data=J}c(f.model_data.data.min,f.model_data.data.max);if(f.afterLoadData!=null){f.afterLoadData(f.model_data.data.rangeMin,f.model_data.data.rangeMax,f.model_data.data)}f.updateColors(f.model_data.data,f.model_data.data.rangeMin,f.model_data.data.rangeMax,f.spectrum,f.flip,f.clamped);return null};if(C.match(/.*.mnc|.*.nii/)){var H=new XMLHttpRequest();if(C.match(/.*.mnc/)){H.open("POST","/minc/volume_object_evaluate",false)}else{H.open("POST","/nii/volume_object_evaluate",false)}var E=document.getElementById("datafile-form");var F=new FormData(E);H.send(F);var D=H.response;G(D)}else{b(I,G)}};this.loadSeriesDataFromFile=function(H){console.log(H.files.length);var G=H.files.length;f.seriesData=new Array(G);f.seriesData.numberFiles=G;var E=H.files;for(var D=0;D<G;D++){var C=new FileReader();C.file=E[D];var F=C.onloadend=(function(J,I){return function(K){console.log(K.target.result.length);console.log(I);f.seriesData[I]=new Data(K.target.result);f.seriesData[I].fileName=J.name}})(C.file,D);C.readAsText(E[D])}f.setupSeries()};this.setupSeries=function(){$('<div id="series">Series: </div>').appendTo("#surface_choice");var C=$("#series");$('<span id="series-value">0</span>').appendTo(C);$('<div id="series-slider" width="100px" + height="10"></div>').slider({value:0,min:0,max:f.seriesData.numberFiles-1,step:0.1,slide:function(D,E){if(E.value-Math.floor(E.value)<0.01){f.model_data.data=f.seriesData[E.value]}else{if(f.seriesData[0].fileName.match("pval.*")){f.model_data.data=new Data(interpolateDataArray(f.seriesData[Math.floor(E.value)],f.seriesData[Math.floor(E.value)+1],(E.value-Math.floor(E.value)),true))}else{f.model_data.data=new Data(interpolateDataArray(f.seriesData[Math.floor(E.value)],f.seriesData[Math.floor(E.value)+1],(E.value-Math.floor(E.value))))}}if(f.seriesData[0].fileName.match("mt.*")){$("#age_series").html("Age: "+(E.value*3+5).toFixed(1))}else{if(f.seriesData[0].fileName.match("pval.*")){$("#age_series").html("Age: "+(E.value*1+10))}}$(C).children("#series-value").html(E.value);if(f.model_data.data.values.length<f.model_data.positionArray.length/4){console.log("Number of numbers in datafile lower than number of vertices Vertices"+f.model_data.positionArray.length/3+" data values:"+f.model_data.data.values.length);return -1}c(f.model_data.data.min,f.model_data.data.max);if(f.afterLoadData!=null){f.afterLoadData(f.model_data.data.rangeMin,f.model_data.data.rangeMax,f.model_data.data)}f.updateColors(f.model_data.data,f.model_data.data.rangeMin,f.model_data.data.rangeMax,f.spectrum,f.flip,f.clamped);return null}}).appendTo(C)};this.loadBlendDataFromFile=function(H){var G=H.files.length;f.blendData=new Array(G);f.blendData.numberFiles=G;var E=H.files;for(var D=0;D<G;D++){var C=new FileReader();C.file=E[D];var F=C.onloadend=(function(J,I){return function(L){f.blendData[I]=new Data(L.target.result);f.blendData.alpha=1/G;f.blendData[I].fileName=J.name;for(var K=0;K<2;K++){if(f.blendData[K]==undefined){console.log("not done yet");return}}c(f.blendData[0].values.min(),f.blendData[0].values.max(),f.blendData[0]);c(f.blendData[1].values.min(),f.blendData[1].values.max(),f.blendData[1]);if(f.afterLoadData!=null){f.afterLoadData(null,null,f.blendData,true)}f.blend($(".blend_slider").slider("value"))}})(C.file,D);C.readAsText(E[D])}f.setupBlendColors()};this.setupBlendColors=function(){console.log("Blend colors has ran "+f.blendData.numberFiles);$("#blend").remove();$('<div id="blend">Blend ratios: </div>').appendTo("#surface_choice");var C=$("#blend");$('<span id="blend_value'+i+'">0</span>').appendTo(C);$('<div class="blend_slider" id="blend_slider'+i+'" width="100px" + height="10"></div>').slider({value:0,min:0.1,max:0.99,value:0.5,step:0.01,slide:function(D,E){f.blend($(this).slider("value"))}}).appendTo(C)};this.blend=function(D){f.blendData[0].alpha=D;f.blendData[1].alpha=1-D;for(var C=2;C<f.blendData.length;C++){f.blendData[C].alpha=0}f.updateColors(f.blendData,null,null,f.spectrum,f.flip,f.clamped,true)};this.loadDataFromUrl=function(D,C){B(D,true,function(F,E){f.model_data.data=new Data(F);f.model_data.data.fileName=C;c(f.model_data.data.min,f.model_data.data.max);if(f.afterLoadData!=undefined){f.afterLoadData(f.model_data.data.rangeMin,f.model_data.data.rangeMax,f.model_data.data)}f.updateColors(f.model_data.data,f.model_data.data.rangeMin,f.model_data.data.rangeMax,f.spectrum)})};this.loadCombinedShaderFromUrl=function(C){var D;B(C,false,function(E){D=E});return D};this.updateColors=function(Y,O,S,W,I,N,R,D){f.clamped=N;if(R){var X=h.blendColorMap(W,Y,0,1)}else{var X=Y.createColorArray(O,S,W,I,N,f.model_data.colorArray,f.model_data)}if(f.model_data.num_hemispheres==2){var C=X.slice(0,X.length/2);var M=X.slice(X.length/2,X.length);var K=[];var U=[];for(var T=0;T+2<X.length;T+=4){var H=new THREE.Color();H.setRGB(C[T],C[T+1],C[T+2]);K.push(H);H=new THREE.Color();H.setRGB(M[T],M[T+1],M[T+2]);U.push(H)}var P=l.getChildByName("left");var V=P.geometry.faces;for(var T=0;T<V.length;T++){var J=V[T];J.vertexColors[0]=K[J.a];J.vertexColors[1]=K[J.b];J.vertexColors[2]=K[J.c];if(J.d){J.vertexColors[3]=K[J.d]}}P.geometry.colorsNeedUpdate=true;var E=l.getChildByName("right");var F=E.geometry.faces;for(var T=0;T<F.length;T++){var J=F[T];J.vertexColors[0]=U[J.a];J.vertexColors[1]=U[J.b];J.vertexColors[2]=U[J.c];if(J.d){J.vertexColors[3]=U[J.d]}}E.geometry.colorsNeedUpdate=true}else{var L=[];for(var T=0;T+2<X.length;T+=4){var H=new THREE.Color();H.setRGB(X[T],X[T+1],X[T+2]);L.push(H)}var G=f.brain.children;for(var T=0;T<G.length;T++){for(var Q=0;Q<G[T].faces.length;Q++){var J=G[T].faces[Q];J.vertexColors[0]=L[J.a];J.vertexColors[1]=L[J.b];J.vertexColors[2]=L[J.c];if(J.d){J.vertexColors[3]=L[J.d]}}G[T].geometry.colorsNeedUpdate=true}}if(f.afterUpdateColors!=null){f.afterUpdateColors(Y,O,S,W)}return 1};this.rangeChange=function(D,C,E){f.model_data.data.rangeMin=D;f.model_data.data.rangeMax=C;f.updateColors(f.model_data.data,f.model_data.data.rangeMin,f.model_data.data.rangeMax,f.spectrum,f.flip,E);if(f.afterRangeChange!=null){f.afterRangeChange(D,C)}};this.changeShapeTransparency=function(D,E){var C=l.getChildByName(D);if(C){C.material.opacity=E;if(E==1){C.material.transparent=false}else{C.material.transparent=true}}};this.getImageUrl=function(){var F=document.createElement("canvas");var C=document.getElementById("spectrum_canvas");F.width=d.width();F.height=d.height();var G=F.getContext("2d");var D=new Image();function E(){var H=new Image();H.onload=function(){G.drawImage(H,0,0);window.open(F.toDataURL(),"screenshot")};H.src=C.toDataURL()}D.onload=function(){G.drawImage(D,0,0);if(C){E()}else{window.open(F.toDataURL(),"screenshot")}};D.src=t.domElement.toDataURL()};window.onresize=function(){d=$("#view-window");t.setSize(d.width(),d.height());w.aspect=d.width()/d.height();w.updateProjectionMatrix()};f.start()}var g_spectrum;function MacaccObject(g,l,c){var d=this;this.brainbrowser=g;this.dataSet=new Dataset(l,c);d.debugLineGroup;d.debugLine;d.selectedInfo=null;d.treeInfo;d.pickInfoElem;d.flashTimer=0;d.highlightMaterial;d.highlightShape;d.vertex;d.positionVector;d.primitiveIndex;d.dataArray;d.data_max;d.data_min;d.range_max;d.range_min;d.spectrum;d.coordinates=jQuery("#coordinates");d.selectPoint=null;function f(o,n){var m=o.vertex;if(m!=undefined&&n!=undefined){jQuery("#x-coord").val(o.point.x);jQuery("#y-coord").val(o.point.y);jQuery("#z-coord").val(o.point.z);jQuery("#v-coord").val(m);jQuery("#value-coord").val(n)}}this.pickClick=function(m,n){d.vertex=n.vertex;if(n.object&&n.object.model_num){d.vertex+=n.object.model_num*n.object.geometry.vertices.length}if(d.vertex){a();f(n,0);if(g.secondWindow!=undefined&&true){g.secondWindow.postMessage(d.vertex,"*")}}else{jQuery(d.pickInfoElem).html("--nothing--")}};this.change_model=function(n){var m=jQuery(n.target).val();g.loadObjFromUrl("/data/surfaces/surf_reg_model_both_"+m+".obj")};this.flipXCoordinate=function(){if(!d.dataArray){return}if(d.vertex>d.dataArray.length/2){d.vertex-=d.dataArray.length/2}else{d.vertex+=d.dataArray.length/2}f(g.getInfoForVertex(d.vertex),0);a()};this.valueAtPoint=function(n,o){var m=d.dataArray[o.vertex];f(o,m)};function k(){var o=jQuery("[name=modality]:checked").val();var n=jQuery("#data-sk").val();var m=jQuery("[name=statistic]:checked").val();return{modality:o,sk:n,statistic:m}}function b(n,m,p,o){g.updateColors(d.dataSet.current_data,n,m,g.spectrum,p,o)}function j(o){d.dataArray=o.current_data.values;g.current_dataset=o;if(jQuery("#fix_range").attr("checked")==true){if(!(d.data_min=parseFloat(jQuery("#data-range-min").val()))){if(!d.data_min===0){d.data_min=o.current_data.min}}if(!(d.data_max=parseFloat(jQuery("#data-range-max").val()))){if(!d.data_max===0){d.data_max=o.current_data.max}}}else{if(k().statistic=="T"){d.data_min=o.current_data.min;d.data_max=o.current_data.max}}var n=jQuery("#flip_range").attr("checked");var m=jQuery("#clamp_range").attr("checked");if(k().statistic=="T"){d.flipRange=n;b(d.data_min,d.data_max,n,m)}else{d.flipRange=!n;jQuery("#range-slider").slider("option","min","0");jQuery("#range-slider").slider("option","max","1");b(0,1,!n,m)}}d.update_model=j;function a(){d.dataSet.get_data(d.vertex,k(),j);jQuery(d.pickInfoElem).html("Viewing data for vertex: "+d.vertex)}this.show_atlas=function(){g.loadDataFromUrl("/assets/aal_atlas.txt")};function h(n,m){if(!jQuery("#fix_range").attr("checked")){jQuery("#data-range-min").val(n);jQuery("#data-range-max").val(m);jQuery("#range-slider").slider("values",0,n);jQuery("#range-slider").slider("values",1,m)}if(d.afterRangeChange!=undefined){d.afterRangeChange(n,m)}}function e(n,m){}this.range_change=function(){var n=parseFloat(jQuery("#data-range-min").val());var m=parseFloat(jQuery("#data-range-max").val());b(n,m,$("#flip_range").attr("checked"),$("#clamp_range").attr("checked"));if(d.afterRangeChange!=undefined){d.afterRangeChange(n,m)}};this.data_control_change=function(){var m=k();if(m.modality=="AAL"){d.show_atlas()}else{if(d.vertex){a()}}};g.loadSpectrumFromUrl("/assets/spectral_spectrum.txt");g.valueAtPointCallback=this.valueAtPoint;g.clickCallback=this.pickClick}var brainbrowser;var macacc;function initMacacc(a,b){brainbrowser=new BrainBrowser();brainbrowser.getViewParams=function(){return{view:jQuery("[name=hem_view]:checked").val(),left:jQuery("#left_hem_visible").attr("checked"),right:jQuery("#right_hem_visible").attr("checked")}};brainbrowser.afterLoadSpectrum=function(c){var d=c.createSpectrumCanvasWithScale(0,5,null,false);jQuery("#spectrum").html(jQuery(d));brainbrowser.spectrumObj=c};brainbrowser.afterInit=function(c){c.loadObjFromUrl("/models/surf_reg_model_both.obj");macacc=new MacaccObject(c,a,b);brainbrowser.afterCreateBrain=function(){if(c.current_dataset!=undefined){macacc.update_model(c.current_dataset)}};macacc.afterRangeChange=function(f,d){if(macacc.flipRange==true){var e=c.spectrumObj.createSpectrumCanvasWithScale(f,d,null,true)}else{var e=c.spectrumObj.createSpectrumCanvasWithScale(f,d,null,false)}jQuery("#spectrum").html(jQuery(e))};jQuery("#meshmode").change(function(d){if(jQuery(d.target).attr("checked")==true){c.set_fill_mode_wireframe()}else{c.set_fill_mode_solid()}});jQuery("#range-slider").slider({range:true,min:-10,max:15,values:[0,5],slide:function(d,e){jQuery("#data-range-min").val(e.values[0]);jQuery("#data-range-max").val(e.values[1]);if(c.current_dataset){macacc.range_change()}},step:0.1});jQuery(".range-box").keypress(function(d){if(d.keyCode=="13"){macacc.range_change(d)}});jQuery("#data-range-min").change(function(d){jQuery("#range-slider").slider("values",0,jQuery(this).val());macacc.afterRangeChange(parseFloat(jQuery("#data-range-min").val()),parseFloat(jQuery("#data-range-max").val()))});jQuery("#data-range-max").change(function(d){jQuery("#range-slider").slider("values",1,jQuery(this).val());macacc.afterRangeChange(parseFloat(jQuery("#data-range-min").val()),parseFloat(jQuery("#data-range-max").val()))});jQuery(".data_controls").change(macacc.data_control_change);macacc.pickInfoElem=jQuery("#vertex_info");jQuery("#x-coord-flip").click(macacc.flipXCoordinate);jQuery("[name=pointer]").change(function(d){if(jQuery("[name=pointer]:checked").val()=="AAL_atlas"){macacc.show_atlas()}});jQuery("#model").change(macacc.change_model);jQuery("#screenshot").click(function(d){jQuery(this).attr("href",c.client.toDataUR())});$("#view-window").mousedown(function(d){var f=jQuery("[name=pointer]:checked").val();if(d.ctrlKey||f=="check"){if(c.valueAtPointCallback){c.click(d,c.valueAtPointCallback)}}else{if(d.shiftKey||f=="select"){if(c.clickCallback){c.click(d,c.clickCallback)}}}});jQuery("#flip_range").change(function(d){macacc.update_model(brainbrowser.current_dataset)});jQuery("#clamp_range").change(function(d){macacc.update_model(brainbrowser.current_dataset)});jQuery("#flip_correlation").click(function(g){var f=-1*parseFloat(jQuery("#data-range-max").val());var d=-1*parseFloat(jQuery("#data-range-min").val());jQuery("#data-range-min").val(f).change();jQuery("#data-range-max").val(d).change();jQuery("#flip_range").attr("checked",!jQuery("#flip_range").attr("checked")).change()})};jQuery("#resetview").click(brainbrowser.setupView);jQuery(".view_button").change(brainbrowser.setupView);jQuery("[name=hem_view]").change(brainbrowser.setupView);jQuery(".button").button();jQuery(".button_set").buttonset();jQuery("#secondWindow").click(function(c){brainbrowser.secondWindow=window.open("/macacc.html","secondWindow")});window.addEventListener("message",function(f){var d=parseInt(f.data);var c=[brainbrowser.model_data.positionArray[d*3],brainbrowser.model_data.positionArray[d*3+1],brainbrowser.model_data.positionArray[d*3+2]];macacc.pickClick(f,{position_vector:c,vertex:d,stop:true,})},false);if(window.opener!=null){brainbrowser.secondWindow=window.opener}};