/*! 
 * Copyright (C) 2011 McGill University
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 *   the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
(function(){var a=window.BrainCanvas={};a.utilities={};a.volumeType={};a.colorScales=[];a.event_listeners={};a.addEventListener=function(c,b){if(!a.event_listeners[c]){a.event_listeners[c]=[]}a.event_listeners[c].push(b)};a.triggerEvent=function(b){if(a.event_listeners[b]){a.event_listeners[b].forEach(function(c){c()})}};a.viewer=function(f,j){var b={};var r=[];var i;var c;var s;var p=false;var d;var e;var m;var g=[];var l={xspace:0,yspace:1,zspace:2};b.volumes=r;b.displays=[];b.synced=[];b.default_zoom_level=1;function q(t,w){i=document.getElementById(t);c=document.createElement("div");c.id="braincanvas";if(!w){w={}}if(w.horizontal){s=true}if(w.multi){var u=0;var x=w.volumes;var v=w.volumes.length;p=true;a.loader.loadColorScaleFromUrl("/color_scales/spectral.txt","Spectral",function(z){b.defaultScale=z;a.colorScales[0]=z;(function y(){if(u<v){b.openVolume(x[u],y);u++}else{b.openVolume({volumes:b.volumes,type:"multiVolume"},n)}})()});a.loader.loadColorScaleFromUrl("/color_scales/thermal.txt","Thermal",function(y){y.cross_hair_color="#05BDFA";a.colorScales[1]=y});a.loader.loadColorScaleFromUrl("/color_scales/gray_scale.txt","Gray",function(y){a.colorScales[2]=y});a.loader.loadColorScaleFromUrl("/color_scales/blue.txt","Blue",function(y){a.colorScales[3]=y});a.loader.loadColorScaleFromUrl("/color_scales/green.txt","Green",function(y){a.colorScales[4]=y})}else{if(w.volume){b.openVolume(w.volume,n)}}}var n=function(){var v;var y;var w;var x;var u;var t;b.vols=[];m=r.length;e=300;d=300;a.setupUI(b);for(v=0;v<m;v++){y=document.createElement("div");w=r[v];x=[];y.classList.add("volume-container");c.appendChild(y);b.displays.push(a.addCanvasUI(y,b,r[v],v));g[v]=[];w.position.xspace=w.header.xspace.space_length/2;w.position.yspace=w.header.yspace.space_length/2;w.position.zspace=w.header.zspace.space_length/2;x.push(w.getScaledSlice("xspace",parseInt(w.header.xspace.space_length/2,10),b.default_zoom_level));x.push(w.getScaledSlice("yspace",parseInt(w.header.yspace.space_length/2,10),b.default_zoom_level));x.push(w.getScaledSlice("zspace",parseInt(w.header.zspace.space_length/2,10),b.default_zoom_level));for(u=0;u<3;u++){x[u].volID=v;x[u].sliceNum=u;x[u].startx=0;x[u].starty=0;x[u].min=w.min;x[u].max=w.max}b.vols.push(x);b.updateVolume(v,x)}i.appendChild(c);a.triggerEvent("ready");b.draw()};b.openVolume=function(u,v){var t=a.volumeType[u.type];if(t){u=t(u,v);u.position={};r.push(u)}else{throw Error("Unsuported Volume Type")}};b.updateSlices=function(z,u,A){var w=r[z];var y;var A;var t=l[u];var x=b.displays[z][t];var v=x.zoom;if(A==undefined){A=w.position[u]}y=w.getScaledSlice(u,A,v);y.volID=z;y.sliceNum=t;w.position[u]=A;y.startx=0;y.starty=0;y.min=w.min;y.max=w.max;b.updateSlice(z,y.sliceNum,null,null,y);b.draw()};b.updateSlice=function(t,C,x,w,F){var H=0;var z=F.length;var A=[];var N=F.x;var L=F.y;var E;var J,D;var u;var v=document.createElement("canvas").getContext("2d");var B=g[t][C]||{x:x,y:w,widthSpace:N,heightSpace:L,};var G;for(H=0;H<z;H++){E=F[H];var K=E.colorScale;var I=v.createImageData(E.width,E.height);K.colorizeArray(E.data,E.min,E.max,true,0,1,E.alpha,I.data);var y=Math.abs(E.x.step);var M=Math.abs(E.y.step);I=o(I,Math.floor(E.width*(y)),Math.floor(E.height*(M)));A.push(I)}J=Math.max.apply(null,A.map(function(O){return O.width}));D=Math.max.apply(null,A.map(function(O){return O.height}));u=v.createImageData(J,D);u=k(A,u);B.image=u;g[t][C]=B;G=b.displays[t][C];G.slice=g[t][C];G.updateCursor(r[t])};function o(H,x,u){var C=H.data;var v=H.width;var J=H.height;var w=document.createElement("canvas").getContext("2d");if(v===x&&J===u){return H}var I=4;var y=w.createImageData(x,u);var t=y.data;var F=v/x;var D=J/u;for(var B=0;B<u;B++){for(var A=0;A<x;A++){var G=Math.floor(A*F);var E=Math.floor(B*D);for(var z=0;z<I;z++){t[Math.floor(B*x+A)*I+z]=C[Math.floor(E*v+G)*I+z]}}}return y}b.updateVolume=function(t,w){var u,v;for(u=0;u<3;u++){v=w[u];b.updateSlice(t,u,v.startx,v.starty,v)}};b.redrawVolume=function(t){b.updateSlices(t,"xspace",r[t].position.xspace);b.updateSlices(t,"yspace",r[t].position.yspace);b.updateSlices(t,"zspace",r[t].position.zspace)};b.redrawVolumes=function(){for(var t=0;t<r.length;t++){b.redrawVolume(t)}};function k(G,H){var E=G.length;if(E>1){var D=H.data;var u=D.length;var B=H.width;var v=H.height;var z=[];for(var C=0;C<v;C+=1){for(var y=0;y<B;y+=1){for(var A=0;A<E;A+=1){z[A]=z[A]||0;var w=G[A];if(C<w.height&&y<w.width){var t=(C*B+y)*4;var x=(D[t+3]||0)/255;var F=z[A];D[t]=(D[t+0]||0)*x+w.data[F+0]*(w.data[F+3]/255);D[t+1]=(D[t+1]||0)*x+w.data[F+1]*(w.data[F+3]/255);D[t+2]=(D[t+2]||0)*x+w.data[F+2]*(w.data[F+3]/255);D[t+3]=(D[t+3]||0)+w.data[F+3];z[A]+=4}}}}for(C=3;C<D.length;C+=4){D[C]=255}return H}else{return G[0]}}b.draw=function h(){var A=0;var w=0;var v=0;var G=0;var F=0;var H;var C;var t;var u;var I;var B;var D=4;var z=D/2;var E;for(A=0;A<m;A++){b.displays[A].forEach(function(y,x){u=y.canvas;t=y.context;I=y.zoom;B=r[A];t.globalAlpha=255;t.clearRect(0,0,u.width,u.height);H=g[A][x];if(H){E=B.colorScale||b.defaultScale;y.drawSlice(t,H);y.drawCrosshair(t,E.cross_hair_color)}if(u===b.active_canvas){t.save();t.strokeStyle="#EC2121";t.lineWidth=D;t.strokeRect(z,z,u.width-D,u.height-D);t.restore()}})}};b.getSlices=function(B,C,w){var A=g[C][w];var u=b.displays[C][w];var t=u.getImageOrigin();var D=u.zoom;var z;var v;u.cursor.x=B.x;u.cursor.y=B.y;if(B){z=Math.floor((B.x-t.x)/D);v=Math.floor(A.heightSpace.space_length-(B.y-t.y)/D)}else{z=null;v=null}b.updateSlices(C,A.widthSpace.name,z);b.updateSlices(C,A.heightSpace.name,v)};q(f,j)}})();(function(){BrainCanvas.ColorScale=function(c){if(!(this instanceof BrainCanvas.ColorScale)){return new BrainCanvas.ColorScale(c)}var b=this;function d(l){l=l.replace(/\s+$/,"");l=l.replace(/^\s+/,"");var h=l.split(/\n/);var e=new Array();for(var g=0;g<h.length;g++){var j=h[g].replace(/\s+$/,"").split(/\s+/);for(var f=0;f<j.length;f++){j[f]=parseFloat(j[f])}if(j.length<4){j.push(1)}e.push(j)}b.colors=e;return e}if(c!=undefined){d(c)}};function a(m,n,d,l){var e=document.createElement("canvas");jQuery(e).attr("width",256);jQuery(e).attr("height",d);var f=new Array(256);for(var j=0;j<256;j++){if(l){f[255-j]=j}else{f[j]=j}}var h=[];for(j=0;j<256;j++){h.push(j)}var b=m.colorizeArray(h,0,255,true,0,1,false,[]);var c=e.getContext("2d");for(var g=0;g<256;g++){c.fillStyle="rgb("+parseInt(b[g*4])+","+parseInt(b[g*4+1])+","+parseInt(b[g*4+2])+")";c.fillRect(g,0,1,n)}console.log("rgb("+parseInt(b[100*4+0])+","+parseInt(b[100*4+1])+","+parseInt(b[100*4+2]));return e}BrainCanvas.ColorScale.prototype.createColorScaleCanvas=function(){var b=a(this,20,20,false);return b};BrainCanvas.ColorScale.prototype.createColorScaleCanvasWithScale=function(f,b,g){var c=this.colors;var d=a(this,20,40,g);var e=d.getContext("2d");e.fillStyle="#FFA000";e.fillRect(0.5,20,1,10);e.fillText(f.toPrecision(3),0.5,40);e.fillRect(d.width/4,20,1,10);e.fillText(((f+b)/4).toPrecision(3),d.width/4,40);e.fillRect(d.width/2,20,1,10);e.fillText(((f+b)/2).toPrecision(3),d.width/2,40);e.fillRect(3*(d.width/4),20,1,10);e.fillText((3*((f+b)/4)).toPrecision(3),3*(d.width/4),40);e.fillRect(d.width-0.5,20,1,10);e.fillText(b.toPrecision(3),d.width-20,40);return d};BrainCanvas.ColorScale.prototype.colorizeArray=function(h,f,m,k,l,e,d,p){if(!p){p=[]}var b=this.colors;var q=b.length*1;var o=(m-f)/q;for(var g=0;g<h.length;g++){if(h[g]<=f){var j=0}else{if(h[g]>=m){var j=b.length-1}else{var n=h[g];var j=parseInt((n-f)/o)}}if(k){var c=255}else{var c=1}p[g*4+0]=c*b[j][0]*e+l*c;p[g*4+1]=c*b[j][1]*e+l*c;p[g*4+2]=c*b[j][2]*e+l*c;if(d!==undefined){p[g*4+3]=d*c}else{p[g*4+3]=c}}return p}}());(function(){BrainCanvas.display=oFactory({updateCursor:function(b){var c=this.slice;var a=this.getImageOrigin();if(b&&c){this.cursor.x=(b.position[c.widthSpace.name]*this.zoom)+a.x;this.cursor.y=(c.heightSpace.space_length-b.position[c.heightSpace.name])*this.zoom+a.y}},getVolumePosition:function(){return{x:this.cursor.x/this.zoom,y:this.cursor.y/this.zoom}},getImageOrigin:function(){return{x:this.image_center.x-this.slice.image.width/2,y:this.image_center.y-this.slice.image.height/2}},drawSlice:function(c){var b=this.slice.image;var a=this.getImageOrigin();c.putImageData(b,a.x,a.y)},drawCrosshair:function(d,c){var b=this.slice.image;var a=this.cursor.x;var e=this.cursor.y;c=c||"#FF0000";d.save();d.strokeStyle="rgba(255, 255, 255, 0.5)";d.lineWidth=6;d.beginPath();d.moveTo(a,e-4);d.lineTo(a,e+4);d.moveTo(a-4,e);d.lineTo(a+4,e);d.stroke();d.strokeStyle=c;d.lineWidth=2;d.beginPath();d.moveTo(a,e-4);d.lineTo(a,e+4);d.moveTo(a-4,e);d.lineTo(a+4,e);d.stroke();d.restore()}}).mixin({canvas:null,context:null,slice:null,cursor:{x:0,y:0},last_cursor:{x:0,y:0},image_center:{x:0,y:0},mouse:null,zoom:1,})})();(function(){BrainCanvas.loader={loadArrayBuffer:function(a,c){var b=new XMLHttpRequest();b.open("GET",a,true);b.responseType="arraybuffer";b.onreadystatechange=function(){if(b.readyState===4){if(b.status===200){if(b.mozResponseArrayBuffer!=undefined){c(b.mozResponseArrayBuffer)}else{c(b.response)}}}};b.send()},loadFromTextFile:function(d,c){var a=new FileReader();var b=d.files;a.file=b[0];a.onloadend=function(f){c(f.target.result)};a.readAsText(b[0])},loadFromUrl:function(b,c,a){$.ajax({url:b,type:"GET",success:c,error:a})},loadColorScaleFromFile:function(b,a,c){BrainCanvas.loader.loadFromTextFile(b,function(d){var e=new BrainCanvas.ColorScale(d);e.name=a;c(e)})},loadColorScaleFromUrl:function(b,a,c){BrainCanvas.loader.loadFromUrl(b,function(d){var e=new BrainCanvas.ColorScale(d);e.name=a;c(e)})}}})();(function(){BrainCanvas.setupUI=function(a){$(document).keydown(function(g){if(!a.active_canvas){return}var b=a.active_canvas;var f=g.which;if(f<37||f>40){return}var i=a.active_cursor;var h=b.getAttribute("data-volume-id");var d=b.getAttribute("data-slice-num");var c=b.getAttribute("data-zoom");({37:function(){i.x--},38:function(){i.y--},39:function(){i.x++},40:function(){i.y++}})[f]();a.getSlices(i,h,d);a.synced.forEach(function(j,e){if(j&&e!==h){a.getSlices(i,e,d)}});return false})};BrainCanvas.addCanvasUI=function(g,f,c,e){var b=[];var g=$(g);function d(j){var k=$(j);var i={x:0,y:0};var h=k.offset();k.mousemove(function(l){i.x=l.offsetX;i.y=l.offsetY});return i}[0,1,2].forEach(function(j){var h=document.createElement("canvas");var i=h.getContext("2d");h.width=256;h.height=256;h.setAttribute("data-volume-id",e);h.setAttribute("data-slice-num",j);h.classList.add("slice-display");g.append(h);i.clearRect(0,0,h.width,h.height);b.push(BrainCanvas.display({canvas:h,context:i,cursor:{x:h.width/2,y:h.height/2},image_center:{x:h.width/2,y:h.height/2},mouse:d(h),zoom:f.default_zoom_level,}))});if(BrainCanvas.volumeUIControls){var a=$('<div class="braincanvas-controls"></div>');if(BrainCanvas.volumeUIControls.defer_until_page_load){BrainCanvas.addEventListener("ready",function(){g.append(a);BrainCanvas.volumeUIControls(a,f,c,e)})}else{BrainCanvas.volumeUIControls(a,f,c,e);g.append(a)}}(function(){var h=null;b.forEach(function(o,n){var l=$(o.canvas);var k=o.mouse;function m(p){var r={x:k.x,y:k.y};function q(u){var t,s;t=r.x-u.last_cursor.x;s=r.y-u.last_cursor.y;u.image_center.x+=t;u.image_center.y+=s;u.cursor.x+=t;u.cursor.y+=s;u.last_cursor.x=r.x;u.last_cursor.y=r.y}if(p.target===h){if(p.shiftKey){q(o);f.synced.forEach(function(t,s){if(t&&s!==e){q(f.displays[s][n])}})}else{f.getSlices(r,e,n);f.synced.forEach(function(t,s){if(t&&s!==e){f.getSlices(r,s,n)}});o.cursor=f.active_cursor=r}f.draw()}}function j(p){$(document).unbind("mousemove",m).unbind("mouseup",j);h=null}l.mousedown(function i(p){h=p.target;var q={x:k.x,y:k.y};if(p.shiftKey){o.last_cursor.x=q.x;o.last_cursor.y=q.y;f.synced.forEach(function(t,s){if(t&&s!==e){var r=f.displays[s][n];r.last_cursor.x=q.x;r.last_cursor.y=q.y}})}else{f.getSlices(q,e,n);f.synced.forEach(function(s,r){if(s&&r!==e){f.getSlices(q,r,n)}});o.cursor=f.active_cursor=q}f.active_canvas=p.target;$(document).mousemove(m).mouseup(j);f.draw();return false});l.mousewheel(function(p,q){o.zoom=Math.max(o.zoom+q*0.05,0.05);f.updateSlices(e,["xspace","yspace","zspace"][n]);f.synced.forEach(function(t,s){if(t&&s!==e){var r=f.displays[s][n];r.zoom=Math.max(r.zoom+q*0.05,0.05);f.updateSlices(s,["xspace","yspace","zspace"][n])}});return false})})})();return b};BrainCanvas.volumeUIControls=function(l,b,n,k){var q=$('<input name="sync" type="checkbox" />');q.change(function(i){b.synced[k]=i.target.checked});var h=$('<span class="control-heading">Sync</span>');h.append(q);l.append(h);if(n.type==="multivolume"){var p=$('<div id="blend-slider" class="slider braincanvas-blend"></div>');var m=$('<div class="control-heading">Blend (-50 to 50): </div>');var g=$('<input class="control-inputs" value="0" id ="blend-val"/>');m.append(g);m.append(p);l.append(m);p.slider({min:-50,max:50,step:1,slide:function(t,u){var i=parseInt(u.value,10);n.updateBlendRatio(i);b.redrawVolume(k);g.val(i)},stop:function(){$(this).find("a").blur()}});g.change(function(){var i=this.value;p.slider("value",i);n.updateBlendRatio(i);b.redrawVolume(k)})}else{var r="";for(var o=0;o<BrainCanvas.colorScales.length;o++){var s=BrainCanvas.colorScales[o].name;if(b.defaultScale===BrainCanvas.colorScale){r+="<option value="+o+'" SELECTED>'+s+"</option>"}else{r+="<option value="+o+'">'+s+"</option>"}}var j=$("<select></select>");r=$(r);j.append(r);j.change(function(t){var i=parseInt($(t.target).val());n.colorScale=BrainCanvas.colorScales[i];b.redrawVolumes()});l.append($('<div class="control-heading">Color Scale: </div>').append(j));if(n.type!=="multivolume"){var c=String(Math.floor(Math.random()*1000000));var d=$('<div class="slider braincanvas-threshold"></div>');var a=$('<div class="control-heading">Threshold: </div>');var f=$('<input class="control-inputs min" "input-min" value="0"/>');var e=$('<input class="control-inputs max" "input-max" value="255"/>');a.append($('<div class="threshold-input">Min </div>').append(f));a.append($('<div class="threshold-input">Max </div>').append(e));l.append(a);a.append(d);d.slider({range:true,min:0,max:255,values:[0,255],step:1,slide:function(t,u){var i=u.values;n.min=i[0];n.max=i[1];b.redrawVolumes();f.val(i[0]);e.val(i[1])},stop:function(){$(this).find("a").blur()}});f.change(function(){var i=this.value;d.slider("values",0,i);n.min=i;b.redrawVolumes()});e.change(function(){var i=this.value;d.slider("values",1,i);n.max=i;b.redrawVolumes()})}}}})();(function(){var b=function(d,e,g){var f=e.split("=");var c={};c[f[0]]=f[1];$.ajax({url:d,dataType:"json",data:c,async:false,success:function(h){if(g){g(h)}},error:function(h,i){throw {request:h,textStatus:i}}})};var a=function(c,e,f){var d=new XMLHttpRequest();if(c.match(/\?/)){c=c+"&"+e}else{c=c+"?"+e}BrainCanvas.loader.loadArrayBuffer(c,function(g){f(g)})};BrainCanvas.volumeType.minc=function(c,i){var d={};var h=c.getRawDataParam||"raw_data=true";var g=c.getHeaderParam||"minc_headers=true";d.getScaledSlice=function(j,l,k,m){var o=d.data.getScaledSlice(j,l,k,m);o.colorScale=d.colorScale||BrainCanvas.colorScales[0];o.min=d.min;o.max=d.max;var n=[o];n.axis=j;n.x=o.x;n.y=o.y;return n};var f,e;b(c.filename,g,function(j){f=j;a(c.filename,h,function(k){e=new Uint8Array(k);d.data=new MincJS(c.filename,f,e);d.header=d.data.header;d.min=0;d.max=255;if(i){i(d)}})});return d}}());function MincJS(c,f,e){if(!(this instanceof MincJS)){return new MincJS(c,header,e)}function b(o,m,h){var n=new Uint16Array(m*h);for(var l=0;l<m;l++){for(var k=0;k<h;k++){n[l*h+k]=o[k*m+(m-l)]}}return n}function g(o,m,h){var n=new Uint16Array(m*h);for(var l=0;l<m;l++){for(var k=0;k<h;k++){n[l*h+k]=o[(h-k)*m+l]}}return n}var d=this;this.parseHeader=function(h){d.header=h;d.order=h.order;if(d.order.length==4){d.order=d.order.slice(1,d.order.length);d.time=h.time}d.xspace=h.xspace;d.yspace=h.yspace;d.zspace=h.zspace;d.xspace.name="xspace";d.yspace.name="yspace";d.zspace.name="zspace";d.xspace.space_length=parseFloat(d.xspace.space_length);d.yspace.space_length=parseFloat(d.yspace.space_length);d.zspace.space_length=parseFloat(d.zspace.space_length);d.xspace.start=parseFloat(d.xspace.start);d.yspace.start=parseFloat(d.yspace.start);d.zspace.start=parseFloat(d.zspace.start);d.xspace.step=parseFloat(d.xspace.step);d.yspace.step=parseFloat(d.yspace.step);d.zspace.step=parseFloat(d.zspace.step);if(d.order.length==4){d.time.space_length=parseFloat(d.time.space_length);d.time.start=parseFloat(d.time.start);d.time.step=parseFloat(d.time.step)}d[d.order[0]].height=parseFloat(d[d.order[1]].space_length);d[d.order[0]].height_space=d[d.order[1]];d[d.order[0]].length=parseFloat(d[d.order[2]].space_length);d[d.order[0]].length_space=d[d.order[2]];d[d.order[0]].width=parseFloat(d[d.order[2]].space_length);d[d.order[0]].width_space=d[d.order[2]];d[d.order[1]].height=parseFloat(d[d.order[2]].space_length);d[d.order[1]].height_space=d[d.order[2]];d[d.order[1]].length=parseFloat(d[d.order[0]].space_length);d[d.order[1]].length_space=d[d.order[0]];d[d.order[1]].width=parseFloat(d[d.order[0]].space_length);d[d.order[1]].width_space=d[d.order[0]];d[d.order[2]].height=parseFloat(d[d.order[1]].space_length);d[d.order[2]].height_space=d[d.order[1]];d[d.order[2]].length=parseFloat(d[d.order[0]].space_length);d[d.order[2]].length_space=d[d.order[0]];d[d.order[2]].width=parseFloat(d[d.order[0]].space_length);d[d.order[2]].width_space=d[d.order[0]];d[d.order[0]].offset=parseFloat(d[d.order[1]].space_length)*parseFloat(d[d.order[2]].space_length);d[d.order[1]].offset=parseFloat(d[d.order[0]].space_length);d[d.order[2]].offset=parseFloat(d[d.order[0]].space_length);d[d.order[0]].slice_length=d[d.order[0]].height*d[d.order[0]].length};var a={};this.slice=function(l,h,n){a[l]=a[l]||[];a[l][n]=a[l][n]||[];if(this[l].step<0){h=this[l].space_length-h}if(a[l][n][h]!=undefined){var x=a[l][n][h];x.alpha=1;x.number=h;return x}if(d.order==undefined){return false}if(d.time){if(!n){n=0}var w=n*d[d.order[0]].height*d[d.order[0]].length*parseFloat(d[d.order[0]].space_length)}else{var w=0}var p=d[l].space_length;var m=d[l].step;var s=d[l].length_space.step;var z=d[l].height_space.step;var x={};var C;if(d.order[0]===l){var r=d[l].height*d[l].length;var t=d[l].height;var q=d[l].length;var o=1;var u=q;var v=r;C=new Uint16Array(r);if(s>0){if(z>0){for(var B=0;B<r;B++){C[B]=this.data[w+v*h+B]}}else{for(var B=t;B>0;B--){for(var A=0;A<q;A++){C[(t-B)*q+A]=this.data[w+v*h+B*q+A]}}}}else{if(z<0){for(var B=0;B<t;B++){for(var A=0;A<q;A++){C[B*q+A]=this.data[w+v*h+B*q+q-A]}}}else{for(var B=t;B>0;B--){for(var A=0;A<q;A++){C[(t-B)*q+A]=this.data[w+v*h+B*q+q-A]}}}}}else{if(d.order[1]==l){var t=d[l].height;var r=d[l].height*d[l].length;var q=d[l].length;var o=1;var u=d[d.order[0]].slice_length;var v=d[d.order[0]].length;C=new Uint8Array(r);if(z<0){for(var A=0;A<t;A++){for(var y=0;y<q;y++){C[A*(q)+y]=d.data[w+h*v+u*y+A]}}}else{for(var A=t;A>=0;A--){for(var y=0;y<q;y++){C[(t-A)*(q)+y]=d.data[w+h*v+u*y+A]}}}}else{var t=d[l].height;var r=d[l].height*d[l].length;var q=d[l].length;var o=d[d.order[0]].slice_length;var u=d[d.order[0]].length;var v=1;C=new Uint16Array(r);for(var A=0;A<t;A++){for(var y=0;y<q;y++){C[A*(q)+y]=d.data[w+h+d[d.order[0]].length*A+y*d[d.order[0]].slice_length]}}}}x.x=d[l].length_space;x.y=d[l].height_space;x.width=q;x.height=t;if(l=="xspace"&&d.xspace.height_space.name=="yspace"){if(d.zspace.step<0){C=g(C,x.width,x.height)}else{C=b(C,x.width,x.height)}x.x=d[l].height_space;x.y=d[l].length_space;x.width=t;x.height=q}if(l=="yspace"&&d.yspace.height_space.name=="xspace"){if(d.zspace.step<0){C=g(C,x.width,x.height)}else{C=b(C,x.width,x.height)}x.x=d[l].height_space;x.y=d[l].length_space;x.width=t;x.height=q}if(l=="zspace"&&d.zspace.height_space.name=="xspace"){C=b(C,x.width,x.height);x.x=d[l].length_space;x.y=d[l].height_space;x.width=t;x.height=q}x.data=C;x.x=x.x||d[l].length_space;x.y=x.y||d[l].height_space;x.width=x.width||q;x.height=x.height||t;a[l][n][h]=x;return x};this.nearestNeighboor=function(u,k,w,l,h){var o=u.data;var v={};var q=new Uint16Array(l*h);var s=k/l;var p=w/h;for(var n=0;n<h;n++){for(var m=0;m<l;m++){var t=Math.floor(m*s);var r=Math.floor(n*p);q[Math.floor(n*l+m)]=o[Math.floor(r*k+t)]}}v.data=q;v.x=u.x||d[axis].length_space;v.y=u.y||d[axis].height_space;v.width=l;v.height=h;return v};this.getScaledSlice=function(l,n,q,k){q=q||1;var m=d.slice(l,n,k);if(q===1){return m}var i=d[l].length;var p=d[l].height;var j=Math.ceil(Math.abs(d[l].length_space.step)*i*q);var h=Math.ceil(Math.abs(d[l].height_space.step)*p*q);var o=this.nearestNeighboor(m,i,p,j,h);if(l==="xspace"&&d.xspace.height_space.name==="yspace"){if(d.zspace.step<0){o.data=g(o.data,j,h)}else{o.data=b(o.data,j,h)}}if(l==="yspace"&&d.yspace.height_space.name==="xspace"){if(d.zspace.step<0){o.data=g(o.data,j,h)}else{o.data=b(o.data,j,h)}}if(l==="zspace"&&d.zspace.height_space.name==="xspace"){o.data=b(o.data,j,h)}return o};this.getValueAtLocation=function(h,k,j,i){};this.parseHeader(f);this.data=e}(function(){function a(f){var e=this;var c;e.volumes=[];var d=f.length;for(c=0;c<d;c++){if(f[c]!=this){e.volumes.push(f[c])}}e.blendRatios=[];d=e.volumes.length;var b=1/d;for(c=0;c<d;c++){e.blendRatios[c]=b}}a.prototype.updateBlendRatio=function(b){b+=50;this.blendRatios[0]=(100-b)/100;this.blendRatios[1]=parseFloat(b)/100};a.prototype.slice=function(c,d,b){var h=this.volumes.length,f,e,j,l=[];for(f=0;f<h;f++){var g=this.volumes[f];if(g!=this){j=this.volumes[f].slice(c,d,b)[0];j.alpha=this.blendRatios[f];l.push(j)}}l.x=l[0].x;l.y=l[0].y;return l};a.prototype.getScaledSlice=function(c,d,b,m){var h=this.volumes.length,f,e,j,l=[];for(f=0;f<h;f++){var g=this.volumes[f];if(g!=this){j=this.volumes[f].getScaledSlice(c,d,b,m)[0];j.alpha=this.blendRatios[f];l.push(j)}}l.x=l[0].x;l.y=l[0].y;return l};BrainCanvas.volumeType.multiVolume=function(b,d){var c=new a(b.volumes);c.type="multivolume";c.min=0;c.max=255;c.header=b.volumes[0].header;setTimeout(d,1);return c}}());