Array.prototype.min=function(){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.min.apply(Math,this.slice(c,c+b-1)))}}else{return Math.min.apply(Math,this)}return a.min()};Array.prototype.max=function(d){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.max.apply(Math,this.slice(c,c+b-1)))}}else{return Math.max.apply(Math,this)}return a.max()};function cloneArray(b){var c=new Array(b.length);for(var a=0;a<c.length;a++){c[a]=b[a]}return c}function rotateUint16Array90Left(f,d,a){var e=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){e[c*a+b]=f[b*d+(d-c)]}}return e}function rotateUint16Array90Right(f,d,a){var e=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){e[c*a+b]=f[(a-b)*d+c]}}return e}function interpolateDataArray(g,c,b,a){console.log(g.values.length);var e=g.values.length;var f=new Array(e);console.log("Percentage: "+b);for(var d=0;d<e;d++){if(a){f[d]=(g.values[d]*(100-b*100)+c.values[d]*(b*100))/100}else{f[d]=(g.values[d]*(100-b*100)+c.values[d]*(b*100))/100}}console.log(f.length);return f}function Minc(b,a,d){var c=this;this.load_headers=function(e){$.ajax({url:e,dataType:"json",data:{minc_headers:true},async:false,success:function(f){c.header=f;c.order=f.order;if(c.order.length==4){c.order=c.order.slice(1,c.order.length);c.time=f.time}c.xspace=f.xspace;c.yspace=f.yspace;c.zspace=f.zspace;c.xspace.name="xspace";c.yspace.name="yspace";c.zspace.name="zspace";c.xspace.space_length=parseFloat(c.xspace.space_length);c.yspace.space_length=parseFloat(c.yspace.space_length);c.zspace.space_length=parseFloat(c.zspace.space_length);c.xspace.start=parseFloat(c.xspace.start);c.yspace.start=parseFloat(c.yspace.start);c.zspace.start=parseFloat(c.zspace.start);c.xspace.step=parseFloat(c.xspace.step);c.yspace.step=parseFloat(c.yspace.step);c.zspace.step=parseFloat(c.zspace.step);if(c.order.length==4){c.time.space_length=parseFloat(c.time.space_length);c.time.start=parseFloat(c.time.start);c.time.step=parseFloat(c.time.step)}c[c.order[0]].height=parseFloat(c[c.order[1]].space_length);c[c.order[0]].height_space=c[c.order[1]];c[c.order[0]].length=parseFloat(c[c.order[2]].space_length);c[c.order[0]].length_space=c[c.order[2]];c[c.order[0]].width=parseFloat(c[c.order[2]].space_length);c[c.order[0]].width_space=c[c.order[2]];c[c.order[1]].height=parseFloat(c[c.order[2]].space_length);c[c.order[1]].height_space=c[c.order[2]];c[c.order[1]].length=parseFloat(c[c.order[0]].space_length);c[c.order[1]].length_space=c[c.order[0]];c[c.order[1]].width=parseFloat(c[c.order[0]].space_length);c[c.order[1]].width_space=c[c.order[0]];c[c.order[2]].height=parseFloat(c[c.order[1]].space_length);c[c.order[2]].height_space=c[c.order[1]];c[c.order[2]].length=parseFloat(c[c.order[0]].space_length);c[c.order[2]].length_space=c[c.order[0]];c[c.order[2]].width=parseFloat(c[c.order[0]].space_length);c[c.order[2]].width_space=c[c.order[0]];c[c.order[0]].offset=parseFloat(c[c.order[1]].space_length)*parseFloat(c[c.order[2]].space_length);c[c.order[1]].offset=parseFloat(c[c.order[0]].space_length);c[c.order[2]].offset=parseFloat(c[c.order[0]].space_length);c[c.order[0]].slice_length=c[c.order[0]].height*c[c.order[0]].length},error:function(f,g){throw {request:f,textStatus:g}}})};this.load_data=function(f,h,e){var g=new XMLHttpRequest();if(f.match(/\?/)){f=f+"&raw_data=true"}else{f=f+"?raw_data=true"}g.open("GET",f+"?raw_data=true",true);g.responseType="arraybuffer";g.onreadystatechange=function(){if(g.readyState==4){if(g.status==200){if(g.mozResponseArrayBuffer!=undefined){c.data=new Uint8Array(g.mozResponseArrayBuffer)}else{c.data=new Uint8Array(g.response)}c.min=0;c.max=255;h(c,e)}}};g.send(null)};this.parseData=function(h,k,e){h=h.replace(/\s+$/,"");h=h.replace(/^\s+/,"");var g=h.split(/\s+/);h="";var j=g.length;for(var f=0;f<j;f++){g[f]=parseInt(g[f])}c.min=g.min();c.max=g.max();g=new Uint16Array(g);c.data=g;k(this,e)};this.sliceFromCoordinates=function(f,e,h,g){};this.slice=function(f,e,h){if(c.order==undefined){return false}if(c.time){if(!h){h=0}var t=h*c[c.order[0]].height*c[c.order[0]].length*parseFloat(c[c.order[0]].space_length)}else{var t=0}var m=c[f].space_length;var g=c[f].step;var p=c[f].length_space.step;var w=c[f].height_space.step;if(c.order[0]==f){var o=c[f].height*c[f].length;var q=c[f].height;var n=c[f].length;var l=1;var r=n;var s=o;var u=new Uint16Array(o);if(p>0){if(w>0){for(var y=0;y<o;y++){u[y]=this.data[t+s*e+y]}}else{for(var y=q;y>0;y--){for(var x=0;x<n;x++){u[(q-y)*n+x]=this.data[t+s*e+y*n+x]}}}}else{if(w<0){for(var y=0;y<q;y++){for(var x=0;x<n;x++){u[y*n+x]=this.data[t+s*e+y*n+n-x]}}}else{for(var y=q;y>0;y--){for(var x=0;x<n;x++){u[(q-y)*n+x]=this.data[t+s*e+y*n+n-x]}}}}}else{if(c.order[1]==f){var q=c[f].height;var o=c[f].height*c[f].length;var n=c[f].length;var l=1;var r=c[c.order[0]].slice_length;var s=c[c.order[0]].length;var u=new Uint16Array(o);if(w<0){for(var x=0;x<q;x++){for(var v=0;v<n;v++){u[x*(n)+v]=c.data[t+e*s+r*v+x]}}}else{for(var x=q;x>=0;x--){for(var v=0;v<n;v++){u[(q-x)*(n)+v]=c.data[t+e*s+r*v+x]}}}}else{var q=c[f].height;var o=c[f].height*c[f].length;var n=c[f].length;var l=c[c.order[0]].slice_length;var r=c[c.order[0]].length;var s=1;var u=new Uint16Array(o);for(var x=0;x<q;x++){for(var v=0;v<n;v++){u[x*(n)+v]=c.data[t+e+c[c.order[0]].length*x+v*c[c.order[0]].slice_length]}}}}return u};this.nearestNeighboor=function(l,f,r,g,e){var n=new Uint16Array(g*e);var p=f/g;var m=r/e;for(var k=0;k<e;k++){for(var h=0;h<g;h++){var q=Math.floor(h*p);var o=Math.floor(k*m);n[Math.floor(k*g+h)]=l[Math.floor(o*f+q)]}}return n};this.getScaledSlice=function(i,k,h,n){var j=c.slice(i,k,h);var f=c[i].length;var m=c[i].height;var g=Math.ceil(Math.abs(c[i].length_space.step)*f*n);var e=Math.ceil(Math.abs(c[i].height_space.step)*m*n);var l=this.nearestNeighboor(j,f,m,g,e);if(i=="xspace"&&c.xspace.height_space.name=="yspace"){if(c.zspace.step<0){l=rotateUint16Array90Right(l,g,e)}else{l=rotateUint16Array90Left(l,g,e)}}if(i=="yspace"&&c.yspace.height_space.name=="xspace"){if(c.zspace.step<0){l=rotateUint16Array90Right(l,g,e)}else{l=rotateUint16Array90Left(l,g,e)}}if(i=="zspace"&&c.zspace.height_space.name=="xspace"){l=rotateUint16Array90Left(l,g,e)}return l};this.getValueAtLocation=function(e,h,g,f){};if(b!=null&&d!=null){this.load_headers(b);this.load_data(b,d,a)}}function ColorManager(){function c(l,d,p,h,n,k,m,g,f){var l=l.colors;var o=((n-h)+(n-h)/l.length)/l.length;for(var j=0;j<p.length;j++){if(p[j]<=h){var q=0}else{if(p[j]>n){var q=l.length-1}else{var q=parseInt((p[j]-h)/o)}}if(k){var e=255}else{var e=1}d[j*4+0]=e*l[q][0]*g+m*e;d[j*4+1]=e*l[q][1]*g+m*e;d[j*4+2]=e*l[q][2]*g+m*e;if(f){d[j*4+3]=e*f}else{d[j*4+3]=e}}return d}this.createColorMap=c;function a(k){var d=k[0];for(var g=0;g<k[0].length/4;g++){for(var f=1;f<k.length;f++){var e=d[g*4+3];var h=k[f][g*4+3];d[g*4]=d[g*4]*e+k[f][g*4]*h;d[g*4+1]=d[g*4+1]*e+k[f][g*4+1]*h;d[g*4+2]=d[g*4+2]*e+k[f][g*4+2]*h;d[g*4+3]=e+h}}return d}this.blendColors=a;function b(e,l,j,g){var d=l.length;var k=new Array(d);var h=0;for(var f=0;f<d;f++){k[f]=c(e,new Array(l[f].values.length),l[f].values,l[f].rangeMin,l[f].rangeMax,false,0,1,l[f].alpha)}return a(k)}this.blendColorMap=b}function Spectrum(e){var c=this;var a=new ColorManager();function b(f,p,h,o){var j=document.createElement("canvas");jQuery(j).attr("width",256);jQuery(j).attr("height",h);var l=new Array(256);for(var n=0;n<256;n++){if(o){l[255-n]=n}else{l[n]=n}}f=a.createColorMap(c,[],l,0,255,true,0,1);var g=j.getContext("2d");for(var m=0;m<256;m++){g.fillStyle="rgb("+parseInt(f[m*4])+","+parseInt(f[m*4+1])+","+parseInt(f[m*4+2])+")";g.fillRect(m,0,1,p)}console.log("rgb("+parseInt(f[100*4+0])+","+parseInt(f[100*4+1])+","+parseInt(f[100*4+2]));console.log(g.fillStyle);return j}c.createSpectrumCanvas=function(f){if(f==null){f=c.colors}var g=b(f,20,20,false);return g};c.createSpectrumCanvasWithScale=function(j,f,g,k){if(g==null){g=c.colors}var h=b(g,20,40,k);var i=h.getContext("2d");i.fillStyle="#FFA000";i.fillRect(0.5,20,1,10);i.fillText(j.toPrecision(3),0.5,40);i.fillRect(h.width/4,20,1,10);i.fillText(((j+f)/4).toPrecision(3),h.width/4,40);i.fillRect(h.width/2,20,1,10);i.fillText(((j+f)/2).toPrecision(3),h.width/2,40);i.fillRect(3*(h.width/4),20,1,10);i.fillText((3*((j+f)/4)).toPrecision(3),3*(h.width/4),40);i.fillRect(h.width-0.5,20,1,10);i.fillText(f.toPrecision(3),h.width-20,40);return h};function d(m){m=m.replace(/\s+$/,"");m=m.replace(/^\s+/,"");var j=m.split(/\n/);var f=new Array();for(var h=0;h<j.length;h++){var l=j[h].replace(/\s+$/,"").split(/\s+/);for(var g=0;g<l.length;g++){l[g]=parseFloat(l[g])}if(l.length<4){l.push(1)}f.push(l)}c.colors=f;return f}if(e!=undefined){d(e)}}function Loader(){var c=this;function a(d,e,f){jQuery.ajax({type:"GET",url:d,dataType:"text",success:function(g){f(g)},error:function(g,i,h){},data:{},async:e,timeout:100000})}function b(g,f){var d=new FileReader();var e=g.files;d.file=e[0];d.onloadend=function(h){f(h.target.result)};d.readAsText(e[0])}c.loadObjFromUrl=function(d){a(d,false,function(e){c.createBrain(new MNIObject(e))})};c.loadObjFromFile=function(d){b(d,function(e){c.createBrain(new MNIObject(e))})};c.loadSpectrumFromUrl=function(e){var d=[];a(e,false,function(f){d=new Spectrum(f);if(c.afterLoadSpectrum!=null){c.afterLoadSpectrum(d)}});return d};c.loadSpectrumFromFile=function(d){b(d,function(f){var e=new Spectrum(f);c.spectrum=e;if(c.afterLoadSpectrum!=null){c.afterLoadSpectrum(e)}if(c.data){c.updateColors(c.data,c.rangeMin,c.rangeMax,c.spectrum)}})}}function BrainCanvas(b,m,d){var i=this;var g=new ColorManager();var f=b.getContext("2d");var e=m.getContext("2d");var c=d.getContext("2d");b.zoom=1;m.zoom=1;d.zoom=1;b.translate_origin={x:0,y:0};m.translate_origin={x:0,y:0};d.translate_origin={x:0,y:0};b.translate_vector={x:0,y:0};m.translate_vector={x:0,y:0};d.translate_vector={x:0,y:0};var l=new Loader();i.slices={};i.brightness=0;i.contrast=1;var h={spectral:l.loadSpectrumFromUrl("/spectrum/spectral-brainview.txt"),grayscale:l.loadSpectrumFromUrl("/spectrum/gray_scale256.txt")};var j=h.spectral;i.spectrums=h;this.initCanvas=function(o,q,n){o.width=q;o.height=n;var p=o.getContext("2d");p.fillStyle="#000000";p.fillRect(0,0,q,n)};this.update_space=function(r,p,o,s,v,q){i.slices[r]=s;i.slices[r].space_height=Math.ceil(Math.abs(v[r].height_space.step)*v[r].height_space.space_length*p.zoom);var n=Math.ceil(Math.abs(v[r].length_space.step)*v[r].length_space.space_length*p.zoom);var w=Math.ceil(Math.abs(v[r].height_space.step)*v[r].height_space.space_length*p.zoom);p.current_image={width:n,height:w};if(r=="xspace"&&v.xspace.height_space.name=="yspace"){p.current_image.width=w;p.current_image.height=n}if(r=="yspace"&&v.yspace.height_space.name=="xspace"){p.current_image.width=w;p.current_image.height=n}if(r=="zspace"&&v.zspace.height_space.name=="xspace"){p.current_image.width=w;p.current_image.height=widht}var t=o.createImageData(p.current_image.width,p.current_image.height);var u=v.getScaledSlice(r,s,q,p.zoom);t.data=g.createColorMap(j,t.data,u,v.min,v.max,true,i.brightness,i.contrast);o.putImageData(t,p.translate_vector.x,p.translate_vector.y)};function a(o,n,p){o.fillStyle="#FF0000";o.fillRect(n-2,p-2,4,4)}this.updateXSpace=function(o,n,p){i.update_space("xspace",b,f,o,n,p)};this.updateYSpace=function(o,n,p){i.update_space("yspace",m,e,o,n,p)};this.updateZSpace=function(o,n,p){i.update_space("zspace",d,c,o,n,p)};this.showCrosshairs=function(){if(i.current_minc.xspace.step<0){var s=(i.current_minc.xspace.space_length-i.slices.xspace)*Math.abs(i.current_minc.yspace.step);var r=s}else{var s=i.slices.xspace*Math.abs(i.current_minc.yspace.step);var r=s}if(i.current_minc.yspace.step>0){var n=(i.current_minc.yspace.space_length-i.slices.yspace)*Math.abs(i.current_minc.yspace.step);var q=i.slices.yspace*Math.abs(i.current_minc.yspace.step)}else{var n=i.slices.yspace*Math.abs(i.current_minc.yspace.step);var q=(i.current_minc.yspace.space_length-i.slices.yspace)*Math.abs(i.current_minc.yspace.step)}if(i.current_minc.zspace.step>0){var o=(i.current_minc.zspace.space_length-i.slices.zspace)*Math.abs(i.current_minc.zspace.step);var p=o}else{var o=i.slices.zspace*Math.abs(i.current_minc.zspace.step);var p=o}a(f,q*b.zoom+b.translate_vector.x,o*b.zoom+b.translate_vector.y);a(e,r*m.zoom+m.translate_vector.x,o*m.zoom+m.translate_vector.y);a(c,r*d.zoom+d.translate_vector.x,n*d.zoom+d.translate_vector.y)};i.showCoordinates=function(){$('<div id="coordinates">x:<span id="x"></span> y:<span id="y"></span> z:<span id="z"></span></div>').appendTo($(b).parent())};i.updateCoordinates=function(n){$(b).siblings("#coordinates").children("#x").html(n.x);$(b).siblings("#coordinates").children("#y").html(n.y);$(b).siblings("#coordinates").children("#z").html(n.z)};this.updateSlices=function(o,p){i.current_time=p;if(o){var n=i.getSliceNumbersFromPosition(k(o))}else{var n={x:i.slices.xspace,y:i.slices.yspace,z:i.slices.zspace}}i.initCanvas(b,b.width,b.height);i.initCanvas(m,m.width,m.height);i.initCanvas(d,d.width,d.height);i.updateXSpace(n.x,i.current_minc,p);i.updateYSpace(n.y,i.current_minc,p);i.updateZSpace(n.z,i.current_minc,p);i.showCrosshairs();i.updateCoordinates(i.sliceToWorldCoordinates(n))};this.zoomIn=function(o,n,p){if(n.zoom==undefined){n.zoom=1*1.01}else{n.zoom=n.zoom*1.1}i.updateSlices(null,i.current_time)};this.zoomOut=function(o,n,p){if(n.zoom==undefined){n.zoom=0.9}else{n.zoom=n.zoom*0.9}i.updateSlices(null,i.current_time)};this.translate=function(o,n){var p=k(o);if(n.translate_origin){n.translate_vector={x:(n.translate_origin.x-p.x2),y:(n.translate_origin.y-p.y)};i.updateSlices(null,i.current_time)}};this.showMinc=function(n){$(b).siblings("#mincinfo").append("Minc Information: <br>order: "+n.order+"<br>xspace.height: "+n.xspace.height+" yspace.height: "+n.yspace.height+" zspace.height: "+n.zspace.height+"<br> xspace.length: "+n.xspace.length+" yspace.length: "+n.yspace.length+" zspace.length: "+n.zspace.length+"xspace step: "+n.xspace.step+"yspace step: "+n.yspace.step+"zspace step: "+n.zspace.step);i.slices.xspace=parseInt(n.xspace.length/2);i.slices.yspace=parseInt(n.yspace.length/2);i.slices.zspace=parseInt(n.zspace.length/2);i.updateXSpace(i.slices.xspace,n);i.updateYSpace(i.slices.yspace,n);i.updateZSpace(i.slices.zspace,n);i.showCrosshairs();i.updateCoordinates(n.xspace.length/2,n.yspace.length/2,n.zspace.length/2)};function k(o){var n;var p;if(o.pageX!=undefined&&o.pageY!=undefined){n=o.pageX;p=o.pageY}else{n=o.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;p=o.clientY+document.body.scrollTop+document.documentElement.scrollTop}n-=o.target.offsetLeft;p-=o.target.offsetTop;p=o.target.height-p;return{target:o.target,x:n,y:p,x2:o.target.width-n}}this.sliceToWorldCoordinates=function(t){var r=i.current_minc.xspace.start;var o=i.current_minc.xspace.step;var q=i.current_minc.yspace.start;var s=i.current_minc.yspace.step;var n=i.current_minc.zspace.start;var p=i.current_minc.zspace.step;return{x:r+t.x*o,y:q+t.y*s,z:n+t.z*p}};this.getSliceNumbersFromPosition=function(n){i.position=n;if(n.target.id==b.id){var o={x:i.slices.xspace,y:parseInt((n.x-b.translate_vector.x)/Math.abs(i.current_minc.xspace.height_space.step)/b.zoom),z:parseInt((n.y+b.translate_vector.y-(b.height-b.current_image.height))/Math.abs(i.current_minc.xspace.length_space.step)/b.zoom)};if(i.current_minc.yspace.step<0){o.y=i.current_minc.yspace.space_length-o.y}if(i.current_minc.zspace.step<0){o.z=i.current_minc.zspace.space_length-o.z}}else{if(n.target.id==m.id){var o={y:i.slices.yspace,x:parseInt((n.x-m.translate_vector.x)/(Math.abs(i.current_minc.xspace.step)*m.zoom)),z:parseInt((n.y+m.translate_vector.y-(m.height-m.current_image.height))/(Math.abs(i.current_minc.zspace.step)*m.zoom))};if(i.current_minc.xspace.step<0){o.x=i.current_minc.xspace.space_length-o.x}if(i.current_minc.zspace.step<0){o.z=i.current_minc.zspace.space_length-o.z}}else{var o={z:i.slices.zspace,x:parseInt((n.x-d.translate_vector.x)/(Math.abs(i.current_minc.zspace.length_space.step)*d.zoom)),y:parseInt((n.y+d.translate_vector.y-(d.height-d.current_image.height))/(Math.abs(i.current_minc.yspace.step)*d.zoom))};if(i.current_minc.xspace.step<0){o.x=i.current_minc.xspace.space_length-o.x}if(i.current_minc.yspace.step<0){o.y=i.current_minc.yspace.space_length-o.y}}}return o};this.addListeners=function(n){n.onmousedown=function(p){i.drag=true;if(p.shiftKey){var o=k(p);n.translate_origin={x:n.translate_vector.x+o.x2,y:n.translate_vector.y+o.y}}return false};n.onmouseup=function(o){i.drag=false};n.onmousemove=function(o){if(i.drag){if(o.shiftKey){i.translate(o,n)}else{i.updateSlices(o)}}};jQuery(n).mousewheel(function(o,p){if(p>0){i.zoomIn(o,n,p)}else{i.zoomOut(o,n,p)}})};this.showTime=function(){$('<div id="time">Time Index: </div>').appendTo($(b).parent());var n=$($(b).parent().children("#time"));$('<span id="time-value">1</span>').appendTo(n);$('<div id="time-slider" width="'+b.width+'" + height="10"></div>').slider({value:0,min:0,max:i.current_minc.time.space_length,step:1,slide:function(o,p){i.updateSlices(null,p.value);$(n).children("#time-value").html(p.value)}}).appendTo(n)};this.showBrightness=function(){$('<div id="brightness">Brightness: </div>').appendTo($(b).parent());var n=$($(b).parent().children("#brightness"));$('<span id="brightness-value">0%</span>').appendTo(n);$('<div id="brightness-slider" width="100px" + height="10"></div>').slider({value:0,min:-1,max:1,step:0.1,slide:function(o,p){i.brightness=p.value;i.updateSlices(null,i.current_time);$(n).children("#brightness-value").html(p.value*100+"%")}}).appendTo(n)};this.showContrast=function(){$('<div id="contrast">Contrast: </div>').appendTo($(b).parent());var n=$($(b).parent().children("#contrast"));$('<span id="contrast-value">1</span>').appendTo(n);$('<div id="contrast-slider" width="100px" + height="10"></div>').slider({value:1,min:1,max:5,step:0.1,slide:function(o,p){i.contrast=p.value;i.updateSlices(null,i.current_time);$(n).children("#contrast-value").html(p.value)}}).appendTo(n)};this.changeSpectrum=function(n){j=h[n];i.updateSlices(null,i.time)};this.showSpectrum=function(){$('<div id="spectrum">Color Scale</div>').appendTo($(b).parent());var n=$($(b).parent().children("#spectrum"));$('<select id="spectrum-select"><option value="spectral">Spectral</option><option value="grayscale">Gray Scale</option></select>').appendTo(n);$(n).children("#spectrum-select").change(function(o){i.changeSpectrum($(o.target).val())})};this.openFile=function(n){this.current_minc=new Minc(n,null,function(o,p){i.initCanvas(b,512,512);i.initCanvas(m,512,512);i.initCanvas(d,512,512);i.showCoordinates();i.showMinc(o);if(o.time){i.showTime()}i.showBrightness();i.showContrast();i.showSpectrum();i.addListeners(b);i.addListeners(m);i.addListeners(d)})}};