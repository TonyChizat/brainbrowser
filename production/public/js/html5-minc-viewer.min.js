Array.prototype.min=function(){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.min.apply(Math,this.slice(c,c+b-1)))}}else{return Math.min.apply(Math,this)}return a.min()};Array.prototype.max=function(d){var b=50000;if(this.length>b){var a=[];for(var c=0;c<this.length;c+=b){a.push(Math.max.apply(Math,this.slice(c,c+b-1)))}}else{return Math.max.apply(Math,this)}return a.max()};function cloneArray(b){var c=new Array(b.length);for(var a=0;a<c.length;a++){c[a]=b[a]}return c}function rotateUint16Array90Left(f,d,a){var e=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){e[c*a+b]=f[b*d+(d-c)]}}return e}function rotateUint16Array90Right(f,d,a){var e=new Uint16Array(d*a);for(var c=0;c<d;c++){for(var b=0;b<a;b++){e[c*a+b]=f[(a-b)*d+c]}}return e}function interpolateDataArray(g,c,b,a){console.log(g.values.length);var e=g.values.length;var f=new Array(e);console.log("Percentage: "+b);for(var d=0;d<e;d++){if(a){f[d]=(g.values[d]*(100-b*100)+c.values[d]*(b*100))/100}else{f[d]=(g.values[d]*(100-b*100)+c.values[d]*(b*100))/100}}console.log(f.length);return f}function Minc(b,a,d){var c=this;this.load_headers=function(e){$.ajax({url:e,dataType:"json",data:{minc_headers:true},async:false,success:function(f){c.header=f;c.order=f.order;if(c.order.length==4){c.order=c.order.slice(1,c.order.length);c.time=f.time}c.xspace=f.xspace;c.yspace=f.yspace;c.zspace=f.zspace;c.xspace.name="xspace";c.yspace.name="yspace";c.zspace.name="zspace";c.xspace.space_length=parseFloat(c.xspace.space_length);c.yspace.space_length=parseFloat(c.yspace.space_length);c.zspace.space_length=parseFloat(c.zspace.space_length);c.xspace.start=parseFloat(c.xspace.start);c.yspace.start=parseFloat(c.yspace.start);c.zspace.start=parseFloat(c.zspace.start);c.xspace.step=parseFloat(c.xspace.step);c.yspace.step=parseFloat(c.yspace.step);c.zspace.step=parseFloat(c.zspace.step);if(c.order.length==4){c.time.space_length=parseFloat(c.time.space_length);c.time.start=parseFloat(c.time.start);c.time.step=parseFloat(c.time.step)}c[c.order[0]].height=parseFloat(c[c.order[1]].space_length);c[c.order[0]].height_space=c[c.order[1]];c[c.order[0]].length=parseFloat(c[c.order[2]].space_length);c[c.order[0]].length_space=c[c.order[2]];c[c.order[0]].width=parseFloat(c[c.order[2]].space_length);c[c.order[0]].width_space=c[c.order[2]];c[c.order[1]].height=parseFloat(c[c.order[2]].space_length);c[c.order[1]].height_space=c[c.order[2]];c[c.order[1]].length=parseFloat(c[c.order[0]].space_length);c[c.order[1]].length_space=c[c.order[0]];c[c.order[1]].width=parseFloat(c[c.order[0]].space_length);c[c.order[1]].width_space=c[c.order[0]];c[c.order[2]].height=parseFloat(c[c.order[1]].space_length);c[c.order[2]].height_space=c[c.order[1]];c[c.order[2]].length=parseFloat(c[c.order[0]].space_length);c[c.order[2]].length_space=c[c.order[0]];c[c.order[2]].width=parseFloat(c[c.order[0]].space_length);c[c.order[2]].width_space=c[c.order[0]];c[c.order[0]].offset=parseFloat(c[c.order[1]].space_length)*parseFloat(c[c.order[2]].space_length);c[c.order[1]].offset=parseFloat(c[c.order[0]].space_length);c[c.order[2]].offset=parseFloat(c[c.order[0]].space_length);c[c.order[0]].slice_length=c[c.order[0]].height*c[c.order[0]].length},error:function(f,g){throw {request:f,textStatus:g}}})};this.load_data=function(f,h,e){var g=new XMLHttpRequest();if(f.match(/\?/)){f=f+"&raw_data=true"}else{f=f+"?raw_data=true"}g.open("GET",f+"?raw_data=true",true);g.responseType="arraybuffer";g.onreadystatechange=function(){if(g.readyState==4){if(g.status==200){if(g.mozResponseArrayBuffer!=undefined){c.data=new Uint8Array(g.mozResponseArrayBuffer)}else{c.data=new Uint8Array(g.response)}c.min=0;c.max=255;h(c,e)}}};g.send(null)};this.parseData=function(h,k,e){h=h.replace(/\s+$/,"");h=h.replace(/^\s+/,"");var g=h.split(/\s+/);h="";var j=g.length;for(var f=0;f<j;f++){g[f]=parseInt(g[f])}c.min=g.min();c.max=g.max();g=new Uint16Array(g);c.data=g;k(this,e)};this.sliceFromCoordinates=function(f,e,h,g){};this.slice=function(f,e,h){if(c.order==undefined){return false}if(c.time){if(!h){h=0}var t=h*c[c.order[0]].height*c[c.order[0]].length*parseFloat(c[c.order[0]].space_length)}else{var t=0}var m=c[f].space_length;var g=c[f].step;var p=c[f].length_space.step;var w=c[f].height_space.step;if(c.order[0]==f){var o=c[f].height*c[f].length;var q=c[f].height;var n=c[f].length;var l=1;var r=n;var s=o;var u=new Uint16Array(o);if(p>0){if(w>0){for(var y=0;y<o;y++){u[y]=this.data[t+s*e+y]}}else{for(var y=q;y>0;y--){for(var x=0;x<n;x++){u[(q-y)*n+x]=this.data[t+s*e+y*n+x]}}}}else{if(w<0){for(var y=0;y<q;y++){for(var x=0;x<n;x++){u[y*n+x]=this.data[t+s*e+y*n+n-x]}}}else{for(var y=q;y>0;y--){for(var x=0;x<n;x++){u[(q-y)*n+x]=this.data[t+s*e+y*n+n-x]}}}}}else{if(c.order[1]==f){var q=c[f].height;var o=c[f].height*c[f].length;var n=c[f].length;var l=1;var r=c[c.order[0]].slice_length;var s=c[c.order[0]].length;var u=new Uint16Array(o);if(w<0){for(var x=0;x<q;x++){for(var v=0;v<n;v++){u[x*(n)+v]=c.data[t+e*s+r*v+x]}}}else{for(var x=q;x>=0;x--){for(var v=0;v<n;v++){u[(q-x)*(n)+v]=c.data[t+e*s+r*v+x]}}}}else{var q=c[f].height;var o=c[f].height*c[f].length;var n=c[f].length;var l=c[c.order[0]].slice_length;var r=c[c.order[0]].length;var s=1;var u=new Uint16Array(o);for(var x=0;x<q;x++){for(var v=0;v<n;v++){u[x*(n)+v]=c.data[t+e+c[c.order[0]].length*x+v*c[c.order[0]].slice_length]}}}}return u};this.nearestNeighboor=function(l,f,r,g,e){var n=new Uint16Array(g*e);var p=f/g;var m=r/e;for(var k=0;k<e;k++){for(var h=0;h<g;h++){var q=Math.floor(h*p);var o=Math.floor(k*m);n[Math.floor(k*g+h)]=l[Math.floor(o*f+q)]}}return n};this.getScaledSlice=function(i,k,h,n){var j=c.slice(i,k,h);var f=c[i].length;var m=c[i].height;var g=Math.ceil(Math.abs(c[i].length_space.step)*f*n);var e=Math.ceil(Math.abs(c[i].height_space.step)*m*n);var l=this.nearestNeighboor(j,f,m,g,e);if(i=="xspace"&&c.xspace.height_space.name=="yspace"){if(c.zspace.step<0){l=rotateUint16Array90Right(l,g,e)}else{l=rotateUint16Array90Left(l,g,e)}}if(i=="yspace"&&c.yspace.height_space.name=="xspace"){if(c.zspace.step<0){l=rotateUint16Array90Right(l,g,e)}else{l=rotateUint16Array90Left(l,g,e)}}if(i=="zspace"&&c.zspace.height_space.name=="xspace"){l=rotateUint16Array90Left(l,g,e)}return l};this.getValueAtLocation=function(e,h,g,f){};if(b!=null&&d!=null){this.load_headers(b);this.load_data(b,d,a)}}function ColorManager(){function c(l,d,p,h,n,k,m,g,f){var l=l.colors;var o=((n-h)+(n-h)/l.length)/l.length;for(var j=0;j<p.length;j++){if(p[j]<=h){var q=0}else{if(p[j]>n){var q=l.length-1}else{var q=parseInt((p[j]-h)/o)}}if(k){var e=255}else{var e=1}d[j*4+0]=e*l[q][0]*g+m*e;d[j*4+1]=e*l[q][1]*g+m*e;d[j*4+2]=e*l[q][2]*g+m*e;if(f){d[j*4+3]=e*f}else{d[j*4+3]=e}}return d}this.createColorMap=c;function a(k){var d=k[0];for(var g=0;g<k[0].length/4;g++){for(var f=1;f<k.length;f++){var e=d[g*4+3];var h=k[f][g*4+3];d[g*4]=d[g*4]*e+k[f][g*4]*h;d[g*4+1]=d[g*4+1]*e+k[f][g*4+1]*h;d[g*4+2]=d[g*4+2]*e+k[f][g*4+2]*h;d[g*4+3]=e+h}}return d}this.blendColors=a;function b(e,l,j,g){var d=l.length;var k=new Array(d);var h=0;for(var f=0;f<d;f++){k[f]=c(e,new Array(l[f].values.length),l[f].values,l[f].rangeMin,l[f].rangeMax,false,0,1,l[f].alpha)}return a(k)}this.blendColorMap=b}function Spectrum(e){var c=this;var a=new ColorManager();function b(f,p,h,o){var j=document.createElement("canvas");jQuery(j).attr("width",256);jQuery(j).attr("height",h);var l=new Array(256);for(var n=0;n<256;n++){if(o){l[255-n]=n}else{l[n]=n}}f=a.createColorMap(c,[],l,0,255,true,0,1);var g=j.getContext("2d");for(var m=0;m<256;m++){g.fillStyle="rgb("+parseInt(f[m*4])+","+parseInt(f[m*4+1])+","+parseInt(f[m*4+2])+")";g.fillRect(m,0,1,p)}console.log("rgb("+parseInt(f[100*4+0])+","+parseInt(f[100*4+1])+","+parseInt(f[100*4+2]));console.log(g.fillStyle);return j}c.createSpectrumCanvas=function(f){if(f==null){f=c.colors}var g=b(f,20,20,false);return g};c.createSpectrumCanvasWithScale=function(j,f,g,k){if(g==null){g=c.colors}var h=b(g,20,40,k);var i=h.getContext("2d");i.fillStyle="#FFA000";i.fillRect(0.5,20,1,10);i.fillText(j.toPrecision(3),0.5,40);i.fillRect(h.width/4,20,1,10);i.fillText(((j+f)/4).toPrecision(3),h.width/4,40);i.fillRect(h.width/2,20,1,10);i.fillText(((j+f)/2).toPrecision(3),h.width/2,40);i.fillRect(3*(h.width/4),20,1,10);i.fillText((3*((j+f)/4)).toPrecision(3),3*(h.width/4),40);i.fillRect(h.width-0.5,20,1,10);i.fillText(f.toPrecision(3),h.width-20,40);return h};function d(m){m=m.replace(/\s+$/,"");m=m.replace(/^\s+/,"");var j=m.split(/\n/);var f=new Array();for(var h=0;h<j.length;h++){var l=j[h].replace(/\s+$/,"").split(/\s+/);for(var g=0;g<l.length;g++){l[g]=parseFloat(l[g])}if(l.length<4){l.push(1)}f.push(l)}c.colors=f;return f}if(e!=undefined){d(e)}}function Loader(){var c=this;function a(d,e,f){jQuery.ajax({type:"GET",url:d,dataType:"text",success:function(g){f(g)},error:function(g,i,h){},data:{},async:e,timeout:100000})}function b(g,f){var d=new FileReader();var e=g.files;d.file=e[0];d.onloadend=function(h){f(h.target.result)};d.readAsText(e[0])}c.loadObjFromUrl=function(d){a(d,false,function(e){c.createBrain(new MNIObject(e))})};c.loadObjFromFile=function(d){b(d,function(e){c.createBrain(new MNIObject(e))})};c.loadSpectrumFromUrl=function(e){var d=[];a(e,false,function(f){d=new Spectrum(f);if(c.afterLoadSpectrum!=null){c.afterLoadSpectrum(d)}});return d};c.loadSpectrumFromFile=function(d){b(d,function(f){var e=new Spectrum(f);c.spectrum=e;if(c.afterLoadSpectrum!=null){c.afterLoadSpectrum(e)}if(c.data){c.updateColors(c.data,c.rangeMin,c.rangeMax,c.spectrum)}})}}function BrainCanvas(b){if(!b){b={}}var j=this;var h=new ColorManager(),c=b.xcanvas||document.createElement("canvas"),n=b.ycanvas||document.createElement("canvas"),e=b.zcanvas||document.createElement("canvas"),g=c.getContext("2d"),f=n.getContext("2d"),d=e.getContext("2d");c.zoom=1;n.zoom=1;e.zoom=1;c.translate_origin={x:0,y:0};n.translate_origin={x:0,y:0};e.translate_origin={x:0,y:0};c.translate_vector={x:0,y:0};n.translate_vector={x:0,y:0};e.translate_vector={x:0,y:0};var m=new Loader();j.slices={};j.brightness=0;j.contrast=1;var i={spectral:m.loadSpectrumFromUrl("/spectrum/spectral-brainview.txt"),grayscale:m.loadSpectrumFromUrl("/spectrum/gray_scale256.txt")};var k=i.spectral;j.spectrums=i;this.initCanvas=function(p,r,o){p.width=r;p.height=o;var q=p.getContext("2d");q.fillStyle="#000000";q.fillRect(0,0,r,o)};this.update_space=function(s,q,p,t,w,r){j.slices[s]=t;j.slices[s].space_height=Math.ceil(Math.abs(w[s].height_space.step)*w[s].height_space.space_length*q.zoom);var o=Math.ceil(Math.abs(w[s].length_space.step)*w[s].length_space.space_length*q.zoom);var x=Math.ceil(Math.abs(w[s].height_space.step)*w[s].height_space.space_length*q.zoom);q.current_image={width:o,height:x};if(s=="xspace"&&w.xspace.height_space.name=="yspace"){q.current_image.width=x;q.current_image.height=o}if(s=="yspace"&&w.yspace.height_space.name=="xspace"){q.current_image.width=x;q.current_image.height=o}if(s=="zspace"&&w.zspace.height_space.name=="xspace"){q.current_image.width=x;q.current_image.height=widht}var u=p.createImageData(q.current_image.width,q.current_image.height);var v=w.getScaledSlice(s,t,r,q.zoom);u.data=h.createColorMap(k,u.data,v,w.min,w.max,true,j.brightness,j.contrast);p.putImageData(u,q.translate_vector.x,q.translate_vector.y)};function a(p,o,q){p.fillStyle="#FF0000";p.fillRect(o-2,q-2,4,4)}this.updateXSpace=function(p,o,q){j.update_space("xspace",c,g,p,o,q)};this.updateYSpace=function(p,o,q){j.update_space("yspace",n,f,p,o,q)};this.updateZSpace=function(p,o,q){j.update_space("zspace",e,d,p,o,q)};this.showCrosshairs=function(){if(j.current_minc.xspace.step<0){var t=(j.current_minc.xspace.space_length-j.slices.xspace)*Math.abs(j.current_minc.yspace.step);var s=t}else{var t=j.slices.xspace*Math.abs(j.current_minc.yspace.step);var s=t}if(j.current_minc.yspace.step>0){var o=(j.current_minc.yspace.space_length-j.slices.yspace)*Math.abs(j.current_minc.yspace.step);var r=j.slices.yspace*Math.abs(j.current_minc.yspace.step)}else{var o=j.slices.yspace*Math.abs(j.current_minc.yspace.step);var r=(j.current_minc.yspace.space_length-j.slices.yspace)*Math.abs(j.current_minc.yspace.step)}if(j.current_minc.zspace.step>0){var p=(j.current_minc.zspace.space_length-j.slices.zspace)*Math.abs(j.current_minc.zspace.step);var q=p}else{var p=j.slices.zspace*Math.abs(j.current_minc.zspace.step);var q=p}a(g,r*c.zoom+c.translate_vector.x,p*c.zoom+c.translate_vector.y);a(f,s*n.zoom+n.translate_vector.x,p*n.zoom+n.translate_vector.y);a(d,s*e.zoom+e.translate_vector.x,o*e.zoom+e.translate_vector.y)};j.showCoordinates=function(){$('<div id="coordinates">x:<span id="x"></span> y:<span id="y"></span> z:<span id="z"></span></div>').appendTo($(c).parent())};j.updateCoordinates=function(o){$(c).siblings("#coordinates").children("#x").html(o.x);$(c).siblings("#coordinates").children("#y").html(o.y);$(c).siblings("#coordinates").children("#z").html(o.z)};this.updateSlices=function(p,q){j.current_time=q;if(p){var o=j.getSliceNumbersFromPosition(l(p))}else{var o={x:j.slices.xspace,y:j.slices.yspace,z:j.slices.zspace}}j.initCanvas(c,c.width,c.height);j.initCanvas(n,n.width,n.height);j.initCanvas(e,e.width,e.height);j.updateXSpace(o.x,j.current_minc,q);j.updateYSpace(o.y,j.current_minc,q);j.updateZSpace(o.z,j.current_minc,q);j.showCrosshairs();j.updateCoordinates(j.sliceToWorldCoordinates(o))};this.zoomIn=function(p,o,q){if(o.zoom==undefined){o.zoom=1*1.01}else{o.zoom=o.zoom*1.1}j.updateSlices(null,j.current_time)};this.zoomOut=function(p,o,q){if(o.zoom==undefined){o.zoom=0.9}else{o.zoom=o.zoom*0.9}j.updateSlices(null,j.current_time)};this.translate=function(p,o){var q=l(p);if(o.translate_origin){o.translate_vector={x:(o.translate_origin.x-q.x2),y:(o.translate_origin.y-q.y)};j.updateSlices(null,j.current_time)}};this.showMinc=function(o){$(c).siblings("#mincinfo").append("Minc Information: <br>order: "+o.order+"<br>xspace.height: "+o.xspace.height+" yspace.height: "+o.yspace.height+" zspace.height: "+o.zspace.height+"<br> xspace.length: "+o.xspace.length+" yspace.length: "+o.yspace.length+" zspace.length: "+o.zspace.length+"xspace step: "+o.xspace.step+"yspace step: "+o.yspace.step+"zspace step: "+o.zspace.step);j.slices.xspace=parseInt(o.xspace.length/2);j.slices.yspace=parseInt(o.yspace.length/2);j.slices.zspace=parseInt(o.zspace.length/2);j.updateXSpace(j.slices.xspace,o);j.updateYSpace(j.slices.yspace,o);j.updateZSpace(j.slices.zspace,o);j.showCrosshairs();j.updateCoordinates(o.xspace.length/2,o.yspace.length/2,o.zspace.length/2)};function l(p){var o;var q;if(p.pageX!=undefined&&p.pageY!=undefined){o=p.pageX;q=p.pageY}else{o=p.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;q=p.clientY+document.body.scrollTop+document.documentElement.scrollTop}o-=p.target.offsetLeft;q-=p.target.offsetTop;q=p.target.height-q;return{target:p.target,x:o,y:q,x2:p.target.width-o}}this.sliceToWorldCoordinates=function(u){var s=j.current_minc.xspace.start;var p=j.current_minc.xspace.step;var r=j.current_minc.yspace.start;var t=j.current_minc.yspace.step;var o=j.current_minc.zspace.start;var q=j.current_minc.zspace.step;return{x:s+u.x*p,y:r+u.y*t,z:o+u.z*q}};this.getSliceNumbersFromPosition=function(o){j.position=o;if(o.target.id==c.id){var p={x:j.slices.xspace,y:parseInt((o.x-c.translate_vector.x)/Math.abs(j.current_minc.xspace.height_space.step)/c.zoom),z:parseInt((o.y+c.translate_vector.y-(c.height-c.current_image.height))/Math.abs(j.current_minc.xspace.length_space.step)/c.zoom)};if(j.current_minc.yspace.step<0){p.y=j.current_minc.yspace.space_length-p.y}if(j.current_minc.zspace.step<0){p.z=j.current_minc.zspace.space_length-p.z}}else{if(o.target.id==n.id){var p={y:j.slices.yspace,x:parseInt((o.x-n.translate_vector.x)/(Math.abs(j.current_minc.xspace.step)*n.zoom)),z:parseInt((o.y+n.translate_vector.y-(n.height-n.current_image.height))/(Math.abs(j.current_minc.zspace.step)*n.zoom))};if(j.current_minc.xspace.step<0){p.x=j.current_minc.xspace.space_length-p.x}if(j.current_minc.zspace.step<0){p.z=j.current_minc.zspace.space_length-p.z}}else{var p={z:j.slices.zspace,x:parseInt((o.x-e.translate_vector.x)/(Math.abs(j.current_minc.zspace.length_space.step)*e.zoom)),y:parseInt((o.y+e.translate_vector.y-(e.height-e.current_image.height))/(Math.abs(j.current_minc.yspace.step)*e.zoom))};if(j.current_minc.xspace.step<0){p.x=j.current_minc.xspace.space_length-p.x}if(j.current_minc.yspace.step<0){p.y=j.current_minc.yspace.space_length-p.y}}}return p};this.addListeners=function(o){o.onmousedown=function(q){j.drag=true;if(q.shiftKey){var p=l(q);o.translate_origin={x:o.translate_vector.x+p.x2,y:o.translate_vector.y+p.y}}return false};o.onmouseup=function(p){j.drag=false};o.onmousemove=function(p){if(j.drag){if(p.shiftKey){j.translate(p,o)}else{j.updateSlices(p)}}};jQuery(o).mousewheel(function(p,q){if(q>0){j.zoomIn(p,o,q)}else{j.zoomOut(p,o,q)}})};this.showTime=function(){$('<div id="time">Time Index: </div>').appendTo($(c).parent());var o=$($(c).parent().children("#time"));$('<span id="time-value">1</span>').appendTo(o);$('<div id="time-slider" width="'+c.width+'" + height="10"></div>').slider({value:0,min:0,max:j.current_minc.time.space_length,step:1,slide:function(p,q){j.updateSlices(null,q.value);$(o).children("#time-value").html(q.value)}}).appendTo(o)};this.showBrightness=function(){$('<div id="brightness">Brightness: </div>').appendTo($(c).parent());var o=$($(c).parent().children("#brightness"));$('<span id="brightness-value">0%</span>').appendTo(o);$('<div id="brightness-slider" width="100px" + height="10"></div>').slider({value:0,min:-1,max:1,step:0.1,slide:function(p,q){j.brightness=q.value;j.updateSlices(null,j.current_time);$(o).children("#brightness-value").html(q.value*100+"%")}}).appendTo(o)};this.showContrast=function(){$('<div id="contrast">Contrast: </div>').appendTo($(c).parent());var o=$($(c).parent().children("#contrast"));$('<span id="contrast-value">1</span>').appendTo(o);$('<div id="contrast-slider" width="100px" + height="10"></div>').slider({value:1,min:1,max:5,step:0.1,slide:function(p,q){j.contrast=q.value;j.updateSlices(null,j.current_time);$(o).children("#contrast-value").html(q.value)}}).appendTo(o)};this.changeSpectrum=function(o){k=i[o];j.updateSlices(null,j.time)};this.showSpectrum=function(){$('<div id="spectrum">Color Scale</div>').appendTo($(c).parent());var o=$($(c).parent().children("#spectrum"));$('<select id="spectrum-select"><option value="spectral">Spectral</option><option value="grayscale">Gray Scale</option></select>').appendTo(o);$(o).children("#spectrum-select").change(function(p){j.changeSpectrum($(p.target).val())})};this.openFile=function(o){this.current_minc=new Minc(o,null,function(q,r){var p=b.canvasHeight||256,s=b.canvasWidth||256;j.initCanvas(c,s,p);j.initCanvas(n,s,p);j.initCanvas(e,s,p);j.showCoordinates();j.showMinc(q);if(q.time){j.showTime()}j.showBrightness();j.showContrast();j.showSpectrum();j.addListeners(c);j.addListeners(n);j.addListeners(e)})}};