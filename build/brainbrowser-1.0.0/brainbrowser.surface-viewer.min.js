/*
 * Copyright (C) 2011 McGill University
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 *   the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

/* brainbrowser v1.0.0 */
!function(){"use strict";var a=window.BrainBrowser=window.BrainBrowser||{},b="1.0.0";a.version=b.indexOf("BRAINBROWSER_VERSION")>0?"D.E.V":b,a.utils={canvasEnabled:function(){return document.createElement("canvas")},webglEnabled:function(){try{return!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(a){return!1}},webWorkersEnabled:function(){return!!window.Worker},webGLErrorMessage:function(){var a,b='BrainBrowser requires <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>.<br/>';return b+=window.WebGLRenderingContext?"Your browser seems to support it, but it is <br/> disabled or unavailable.<br/>":"Your browser does not seem to support it.<br/>",b+='Test your browser\'s WebGL support <a href="http://get.webgl.org/">here</a>.',a=document.createElement("div"),a.id="webgl-error",a.innerHTML=b,a},isFunction:function(a){return a instanceof Function||"function"==typeof a},drawDot:function(a,b,c,d){var e=new THREE.SphereGeometry(2),f=new THREE.MeshBasicMaterial({color:16711680}),g=new THREE.Mesh(e,f);g.position.set(b,c,d),a.add(g)},eventModel:function(a){a.event_listeners=[],a.addEventListener=function(b,c){a.event_listeners[b]||(a.event_listeners[b]=[]),a.event_listeners[b].push(c)},a.triggerEvent=function(b){var c=Array.prototype.slice.call(arguments,1);a.event_listeners[b]&&a.event_listeners[b].forEach(function(b){b.apply(a,c)})}},min:function(){var a=Array.prototype.slice.call(arguments);a=1===a.length&&Array.isArray(a[0])?a[0]:a;var b,c,d=a[0];for(b=1,c=a.length;c>b;b++)a[b]<d&&(d=a[b]);return d},max:function(){var a=Array.prototype.slice.call(arguments);a=1===a.length&&Array.isArray(a[0])?a[0]:a;var b,c,d=a[0];for(b=1,c=a.length;c>b;b++)a[b]>d&&(d=a[b]);return d},getOffset:function(a){for(var b=0,c=0;a.offsetParent;)b+=a.offsetTop,c+=a.offsetLeft,a=a.offsetParent;return{top:b,left:c}}}}(),function(){"use strict";var a=window.BrainBrowser=window.BrainBrowser||{},b=a.SurfaceViewer={start:function(c,d){if(console.log("BrainBrowser Surface Viewer v"+a.version),!a.utils.webWorkersEnabled())return alert("Can't find web workers. Exiting."),void 0;if(!a.utils.webglEnabled())return alert("Can't get WebGL context. Exiting."),void 0;var e,f={};f.view_window=document.getElementById(c),f.model=null,a.utils.eventModel(f);for(e in b.core)b.core.hasOwnProperty(e)&&b.core[e](f);for(e in b.core)b.core.hasOwnProperty(e)&&b.core[e](f);for(e in b.modules)b.modules.hasOwnProperty(e)&&b.modules[e](f);for(e in b.plugins)b.plugins.hasOwnProperty(e)&&b.plugins[e](f);f.render(),d(f)}};b.core={},b.modules={},b.plugins={},b.filetypes={}}(),BrainBrowser.SurfaceViewer.colorManager=function(){"use strict";var a={};return a.createColorMap=function(a,b,c,d,e,f,g,h,i){a=a.colors;var j,k,l,m,n,o=a.length,p=(e-d+(e-d)/o)/o,q=[];for(j=0,k=c.length;k>j;j++)m=c[j],l=d>=m?0:c[j]>e?o-1:parseInt((m-d)/p,10),n=f?255:1,q=a[l]||[0,0,0],b[4*j+0]=n*q[0]*h+g*n,b[4*j+1]=n*q[1]*h+g*n,b[4*j+2]=n*q[2]*h+g*n,b[4*j+3]=i?n*i:n;return b},a.blendColors=function(a){var b,c,d,e,f,g,h=a[0];for(b=0,d=a[0].length/4;d>b;b++)for(c=1,e=a.length;e>c;c++)f=h[4*b+3],g=a[c][4*b+3],h[4*b]=h[4*b]*f+a[c][4*b]*g,h[4*b+1]=h[4*b+1]*f+a[c][4*b+1]*g,h[4*b+2]=h[4*b+2]*f+a[c][4*b+2]*g,h[4*b+3]=f+g;return h},a.blendColorMap=function(b,c){var d,e,f=c.length,g=new Array(f);for(d=0;f>d;d++)e=c[d],g[d]=a.createColorMap(b,new Array(e.values.length),e.values,e.rangeMin,e.rangeMax,!1,0,1,e.alpha);return a.blendColors(g)},a},BrainBrowser.SurfaceViewer.data=function(a,b){"use strict";function c(){var c=new Worker(e+"/data.worker.js");c.addEventListener("message",function(a){var e,f=a.data;for(e in f)f.hasOwnProperty(e)&&(d[e]=f[e]);b&&b(d),c.terminate()}),c.postMessage({cmd:"parse",data:a})}var d={},e=BrainBrowser.config.surface_viewer.worker_dir;d.createColorArray=function(a,b,c,e,f,g,h,i){c=c.colors;var j,k,l,m,n=d.values,o=[],p=(b-a+(b-a)/c.length)/c.length;for(j=0,k=n.length;k>j;j++)m=n[j],l=a>=m?a>m&&!f?-1:0:m>b?f?c.length-1:-1:parseInt((m-a)/p,10),e&&-1!==l?o.push.apply(o,c[c.length-1-l]):-1===l?4===g.length?o.push.apply(o,g):o.push(g[4*j],g[4*j+1],g[4*j+2],g[4*j+3]):o.push.apply(o,c[l]);i&&i(o)},a&&("string"==typeof a?c(a):a.values?(d.values=a.values.concat(),d.min=BrainBrowser.utils.min(d.values),d.max=BrainBrowser.utils.max(d.values)):(d.values=a,d.min=BrainBrowser.utils.min(a),d.max=BrainBrowser.utils.max(a)))},BrainBrowser.SurfaceViewer.spectrum=function(a){"use strict";function b(a,b,c,f){var g,h,i,j=document.createElement("canvas"),k=new Array(256);for($(j).attr("width",256),$(j).attr("height",c),g=0;256>g;g++)f?k[255-g]=g:k[g]=g;for(a=e.createColorMap(d,[],k,0,255,!0,0,1),i=j.getContext("2d"),h=0;256>h;h++)i.fillStyle="rgb("+parseInt(a[4*h],10)+", "+parseInt(a[4*h+1],10)+", "+parseInt(a[4*h+2],10)+")",i.fillRect(h,0,1,b);return j}function c(a){a=a.replace(/^\s+/,"").replace(/\s+$/,"");var b,c,e,f,g,h=a.split(/\n/),i=[];for(b=0,e=h.length;e>b;b++){for(g=h[b].replace(/\s+$/,"").split(/\s+/),f=g.length,c=0;f>c;c++)g[c]=parseFloat(g[c]);4>f&&g.push(1),i.push(g)}return d.colors=i,i}var d={},e=BrainBrowser.SurfaceViewer.colorManager();return d.createSpectrumCanvas=function(a){var c;return a||(a=d.colors),c=b(a,20,20,!1)},d.createSpectrumCanvasWithScale=function(a,c,e,f){var g,h;return null===e&&(e=d.colors),g=b(e,20,40,f),h=g.getContext("2d"),h.fillStyle="#FFA000",h.fillRect(.5,20,1,10),h.fillText(a.toPrecision(3),.5,40),h.fillRect(g.width/4,20,1,10),h.fillText(((a+c)/4).toPrecision(3),g.width/4,40),h.fillRect(g.width/2,20,1,10),h.fillText(((a+c)/2).toPrecision(3),g.width/2,40),h.fillRect(3*(g.width/4),20,1,10),h.fillText((3*((a+c)/4)).toPrecision(3),3*(g.width/4),40),h.fillRect(g.width-.5,20,1,10),h.fillText(c.toPrecision(3),g.width-20,40),g},a&&c(a),d},BrainBrowser.SurfaceViewer.filetypes.parse=function(a,b,c){"use strict";var d=BrainBrowser.config.surface_viewer,e=d.filetypes[a],f=d.worker_dir;e.worker&&BrainBrowser.SurfaceViewer.filetypes.parseWorker(b,e.worker,function(a){var b=new Worker(f+"/deindex.worker.js");b.addEventListener("message",function(a){c(a.data)}),b.postMessage(a)})},BrainBrowser.SurfaceViewer.filetypes.parseWorker=function(a,b,c){"use strict";var d=BrainBrowser.config.surface_viewer.worker_dir,e=new Worker(d+"/"+b);e.addEventListener("message",function(a){c&&c(a.data),e.terminate()}),e.postMessage(a)},BrainBrowser.SurfaceViewer.core.color=function(a){"use strict";function b(b){var c,d,e,f,g,h,i=a.model,j=i.getObjectByName("left"),k=i.getObjectByName("right"),l=j.geometry.original_data.indices,m=k.geometry.original_data.indices,n=j.geometry.attributes.color,o=n.array,p=k.geometry.attributes.color,q=p.array,r=j.getObjectByName("__wireframe__"),s=k.getObjectByName("__wireframe__"),t=!!r;for(t&&(g=r.geometry.attributes.color.array,h=s.geometry.attributes.color.array),c=0,d=l.length;d>c;c+=3)e=4*c,f=2*e,o[e]=b[4*l[c]],o[e+1]=b[4*l[c]+1],o[e+2]=b[4*l[c]+2],o[e+4]=b[4*l[c+1]],o[e+5]=b[4*l[c+1]+1],o[e+6]=b[4*l[c+1]+2],o[e+8]=b[4*l[c+2]],o[e+9]=b[4*l[c+2]+1],o[e+10]=b[4*l[c+2]+2],q[e]=b[4*m[c]],q[e+1]=b[4*m[c]+1],q[e+2]=b[4*m[c]+2],q[e+4]=b[4*m[c+1]],q[e+5]=b[4*m[c+1]+1],q[e+6]=b[4*m[c+1]+2],q[e+8]=b[4*m[c+2]],q[e+9]=b[4*m[c+2]+1],q[e+10]=b[4*m[c+2]+2],t&&(g[f]=o[e],g[f+1]=o[e+1],g[f+2]=o[e+2],g[f+3]=o[e+3],g[f+4]=o[e+4],g[f+5]=o[e+5],g[f+6]=o[e+6],g[f+7]=o[e+7],g[f+8]=o[e+4],g[f+9]=o[e+5],g[f+10]=o[e+6],g[f+11]=o[e+7],g[f+12]=o[e+8],g[f+13]=o[e+9],g[f+14]=o[e+10],g[f+15]=o[e+11],g[f+16]=o[e+8],g[f+17]=o[e+9],g[f+18]=o[e+10],g[f+19]=o[e+11],g[f+20]=o[e],g[f+21]=o[e+1],g[f+22]=o[e+2],g[f+23]=o[e+3],h[f]=q[e],h[f+1]=q[e+1],h[f+2]=q[e+2],h[f+3]=q[e+3],h[f+4]=q[e+4],h[f+5]=q[e+5],h[f+6]=q[e+6],h[f+7]=q[e+7],h[f+8]=q[e+4],h[f+9]=q[e+5],h[f+10]=q[e+6],h[f+11]=q[e+7],h[f+12]=q[e+8],h[f+13]=q[e+9],h[f+14]=q[e+10],h[f+15]=q[e+11],h[f+16]=q[e+8],h[f+17]=q[e+9],h[f+18]=q[e+10],h[f+19]=q[e+11],h[f+20]=q[e],h[f+21]=q[e+1],h[f+22]=q[e+2],h[f+23]=q[e+3]);n.needsUpdate=!0,p.needsUpdate=!0,t&&(r.geometry.attributes.color.needsUpdate=!0,s.geometry.attributes.color.needsUpdate=!0)}function c(a,b){var c,d,e,f,g,h,i,j,k,l,m,n;for(h=0,i=b.length;i>h;h++){for(d=b[h],j=d.getObjectByName("__wireframe__"),n=!!j,n&&(k=j.geometry.attributes.color.array),c=d.geometry,e=d.geometry.original_data.indices,f=c.attributes.color,g=f.array,h=0,i=e.length;i>h;h+=3)l=4*h,m=2*l,g[l]=a[4*e[h]],g[l+1]=a[4*e[h]+1],g[l+2]=a[4*e[h]+2],g[l+4]=a[4*e[h+1]],g[l+5]=a[4*e[h+1]+1],g[l+6]=a[4*e[h+1]+2],g[l+8]=a[4*e[h+2]],g[l+9]=a[4*e[h+2]+1],g[l+10]=a[4*e[h+2]+2],n&&(k[m]=g[l],k[m+1]=g[l+1],k[m+2]=g[l+2],k[m+3]=g[l+3],k[m+4]=g[l+4],k[m+5]=g[l+5],k[m+6]=g[l+6],k[m+7]=g[l+7],k[m+8]=g[l+4],k[m+9]=g[l+5],k[m+10]=g[l+6],k[m+11]=g[l+7],k[m+12]=g[l+8],k[m+13]=g[l+9],k[m+14]=g[l+10],k[m+15]=g[l+11],k[m+16]=g[l+8],k[m+17]=g[l+9],k[m+18]=g[l+10],k[m+19]=g[l+11],k[m+20]=g[l],k[m+21]=g[l+1],k[m+22]=g[l+2],k[m+23]=g[l+3]);f.needsUpdate=!0,n&&(j.geometry.attributes.color.needsUpdate=!0)}}var d=BrainBrowser.SurfaceViewer,e=d.colorManager();a.updateColors=function(d,f){function g(e){var f;2===a.model_data.num_hemispheres?b(e):(f=d.apply_to_shape?[a.model.getObjectByName(d.apply_to_shape,!0)]:a.model.children,c(e,f)),a.triggerEvent("updatecolors",d,h,i,j),n&&n()}f=f||{};var h=f.min,i=f.max,j=f.spectrum,k=f.flip,l=f.clamped,m=f.blend,n=f.complete;a.clamped=l,m?g(e.blendColorMap(j,d,0,1)):d.createColorArray(h,i,j,k,l,a.model_data.colorArray,a.model_data,g)},a.rangeChange=function(b,c,d,e){e=e||{};var f=a.model_data.data;f.rangeMin=b,f.rangeMax=c,a.updateColors(f,{min:f.rangeMin,max:f.rangeMax,spectrum:a.spectrum,flip:a.flip,clamped:d,complete:e.complete}),a.triggerEvent("rangechange",f)}},BrainBrowser.SurfaceViewer.modules.loader=function(a){"use strict";function b(a,b,c){b=b||{};var d=b.before;d&&(d(),delete b.before),jQuery.ajax({type:"GET",url:a,dataType:"text",success:function(a){f(b)||c(a)},error:function(a,b){alert("Failure in loadFromURL: "+b)},timeout:1e5})}function c(a,b,c){var d=a.files;if(0!==d.length){b=b||{};var e=b.before,f=new FileReader;f.file=d[0],e&&(e(),delete b.before),f.onloadend=function(a){c(a.target.result)},f.readAsText(d[0])}}function d(a,b){var c,d,e;c=new XMLHttpRequest,a.match(/.*.mnc/)?c.open("POST","/minc/volume_object_evaluate",!1):c.open("POST","/nii/volume_object_evaluate",!1),d=new FormData(document.getElementById("datafile-form")),c.send(d),e=c.response,b(e)}function e(b,c,d){d||(d=a.model_data.data),d.fixRange||(d.rangeMin=b,d.rangeMax=c)}function f(a){a=a||{};var b=a.cancel||{};BrainBrowser.utils.isFunction(b)&&(b={test:b});var c=b.test,d=b.cleanup,e=!1;return c&&c()&&(e=!0,d&&d()),e}var g=BrainBrowser.SurfaceViewer;a.loadModelFromUrl=function(c,d){d=d||{};var e,h,i=d.format||"MNIObject";b(c,d,function(b){e=c.split("/"),h=e[e.length-1],g.filetypes.parse(i,b,function(b){"__FAIL__"!==b.objectClass?f(d)||a.displayObjectFile(b,h,d):d.error&&d.error()})})},a.loadModelFromFile=function(b,d){d=d||{};var e,f,h=d.format||"MNIObject";c(b,d,function(c){e=b.value.split("\\"),f=e[e.length-1],g.filetypes.parse(h,c,function(b){"__FAIL__"!==b.objectClass?a.displayObjectFile(b,f,d):d.error&&d.error()})})},a.loadDataFromUrl=function(c,d,h){h=h||{},b(c,h,function(b){g.data(b,function(b){if(!f(h)){var c=void 0===h.max?b.max:h.max,g=void 0===h.min?b.min:h.min;a.model_data.data=b,b.fileName=d,b.apply_to_shape=h.shape,e(g,c),a.triggerEvent("loaddata",b),a.updateColors(b,{min:b.rangeMin,max:b.rangeMax,spectrum:a.spectrum,flip:a.flip,clamped:a.clamped,complete:h.complete})}})})},a.loadDataFromFile=function(b,f){f=f||{};var h=b.files[0].name,i=a.model_data,j=i.positionArray,k=j.length,l=f.blend_index||0,m=1-l;a.blendData=a.blendData||[];var n=function(b){g.data(b,function(b){var c=void 0===f.max?b.max:f.max,d=void 0===f.min?b.min:f.min;return b.fileName=h,b.apply_to_shape=f.shape,b.applied=!1,b.values.length<k/4?(alert("Not enough color points to cover vertices - "+b.values.length+" color points for "+k/3+" vertices."),-1):(i.data=b,a.blendData[l]=b,e(d,c,b),a.blendData[m]&&a.blendData[m].applied?(e(BrainBrowser.utils.min(a.blendData[m].values),BrainBrowser.utils.max(a.blendData[m].values),a.blendData[m]),a.triggerEvent("loaddata",a.blendData),a.blend(.5),a.triggerEvent("blenddata",b.rangeMin,b.rangeMax,b)):(a.triggerEvent("loaddata",b),a.updateColors(b,{min:b.rangeMin,max:b.rangeMax,spectrum:a.spectrum,flip:a.flip,clamped:a.clamped,complete:f.complete})),b.applied=!0,void 0)})};h.match(/.*.mnc|.*.nii/)?d(h,n):c(b,null,n)},a.blend=function(b){var c,d=a.blendData,e=d.length;for(d[0].alpha=b,d[1].alpha=1-b,c=2;e>c;c++)d[c].alpha=0;a.updateColors(d,{spectrum:a.spectrum,flip:a.flip,clamped:a.clamped,blend:!0})},a.loadSpectrumFromUrl=function(c,d){d=d||{};var e;b(c,d,function(b){e=g.spectrum(b),a.spectrum=e,a.triggerEvent("loadspectrum",e),a.model_data&&a.model_data.data&&a.updateColors(a.model_data.data,{min:a.model_data.data.rangeMin,max:a.model_data.data.rangeMax,spectrum:a.spectrum,flip:a.flip,clamped:a.clamped})})},a.loadSpectrumFromFile=function(b){var d,e=a.model_data;c(b,null,function(b){d=g.spectrum(b),a.spectrum=d,a.triggerEvent("loadspectrum",d),e.data&&a.updateColors(e.data,{min:e.data.rangeMin,max:e.data.rangeMax,spectrum:a.spectrum,flip:a.flip,clamped:a.clamped})})},a.loadSeriesDataFromFile=function(b){var c,d,e=b.files.length,f=b.files;a.seriesData=new Array(e),a.seriesData.numberFiles=e,f.forEach(function(b,e){c=new FileReader,c.file=b,c.onloadend=function(c){g.data(c.target.result,function(c){a.seriesData[e]=c,a.seriesData[e].fileName=b.name})},c.readAsText(f[d])}),a.setupSeries()}},BrainBrowser.SurfaceViewer.core.models=function(a){"use strict";function b(b,d,e){var f,g,h,i,j=a.model,k=b.shapes,l="L"===b.objectClass;if(a.model_data=b,k){for(h=0,i=k.length;i>h;h++)g=b.shapes[h],f=c(g,l),f.name=g.name||d,f.geometry.original_data={vertices:b.positionArray,indices:g.indexArray,normals:b.normalArray,colors:b.colorArray},e&&(f.renderDepth=e),j.add(f);2===b.num_hemispheres&&(j.children[0].name="left",j.children[0].model_num=0,j.children[1].name="right",j.children[1].model_num=1)}}function c(a,b){var c,e,f=a.unindexed,g=a.wireframe,h=a.centroid,i=f.position,j=f.normal||[],k=f.color||[],l=new THREE.BufferGeometry;return l.dynamic=!0,l.attributes.position={itemSize:3,array:new Float32Array(i),numItems:i.length},j.length>0?l.attributes.normal={itemSize:3,array:new Float32Array(j)}:l.computeVertexNormals(),k.length>0&&(l.attributes.color={itemSize:4,array:new Float32Array(k)}),b?(c=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors}),e=new THREE.Line(l,c,THREE.LinePieces)):(c=new THREE.MeshPhongMaterial({color:16777215,ambient:657930,specular:16777215,shininess:100,vertexColors:THREE.VertexColors}),e=new THREE.Mesh(l,c),e.add(d(e,g))),e.centroid=h,e.position.set(h.x,h.y,h.z),e}function d(a,b){var c,d,e=new THREE.BufferGeometry;return e.attributes.position={itemSize:3,array:b.position,numItems:b.position.length},e.attributes.color={itemSize:4,array:b.color},e.attributes.color.needsUpdate=!0,c=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors}),d=new THREE.Line(e,c,THREE.LinePieces),d.name="__wireframe__",d.visible=!1,a.wireframe_active=!1,d}a.displayObjectFile=function(c,d,e){e=e||{};var f=e.renderDepth,g=e.complete;b(c,d,f),a.triggerEvent("displayobject",a.model),g&&g()}},BrainBrowser.SurfaceViewer.core.rendering=function(a){"use strict";function b(c){var d,j,m=a.model;window.requestAnimationFrame(b),h=g||c,g=c,e.update(),f.update(),d=g-h,j=15e-5*d,a.autoRotate.x&&(m.rotation.x+=j),a.autoRotate.y&&(m.rotation.y+=j),a.autoRotate.z&&(m.rotation.z+=j),i.render(k,l)}var c,d,e,f,g,h,i,j,k=new THREE.Scene,l=new THREE.PerspectiveCamera(30,a.view_window.offsetWidth/a.view_window.offsetHeight,.1,5e3);a.model=new THREE.Object3D,k.add(a.model),a.render=function(){var g=a.view_window;c=new THREE.WebGLRenderer({preserveDrawingBuffer:!0}),c.setClearColor(8947848),c.setSize(g.offsetWidth,g.offsetHeight),i=c,j=new THREE.AnaglyphEffect(c),j.setSize(g.offsetWidth,g.offsetHeight),g.appendChild(c.domElement),l.position.z=500,d=new THREE.PointLight(16777215),d.position.set(0,0,500),k.add(d),e=new THREE.TrackballControls(l,g),f=new THREE.TrackballControls(d,g),e.zoomSpeed=2,f.zoomSpeed=2,a.autoRotate={},window.onresize=function(){i.setSize(g.offsetWidth,g.offsetHeight),l.aspect=g.offsetWidth/g.offsetHeight,l.updateProjectionMatrix()},window.onresize(),b()},a.canvasDataURL=function(){return c.domElement.toDataURL()},a.anaglyphEffect=function(){i=j},a.noEffect=function(){i=c},a.setCamera=function(a,b,c){l.position.set(a,b,c)},a.resetView=function(){var b,c,d,g,h=a.model,i=new THREE.Matrix4;for(i.getInverse(h.matrix),e.reset(),f.reset(),h.applyMatrix(i),d=0,g=a.model.children.length;g>d;d++)b=h.children[d],b.centroid?b.position.set(b.centroid.x,b.centroid.y,b.centroid.z):b.position.set(0,0,0),b.rotation.set(0,0,0),c=b.getObjectByName("__wireframe__")},a.zoom=function(a){l.fov*=a,l.updateProjectionMatrix()},a.clearScreen=function(){for(var b=a.model.children;b.length>0;)a.model.remove(b[0]);a.resetView(),a.triggerEvent("clearscreen")},a.updateClearColor=function(a){c.setClearColor(a,1)},a.click=function(b,c){var d,e,f,g,h,i,j,k,m,n,o,p=a.view_window,q=BrainBrowser.utils.getOffset(p),r=new THREE.Projector,s=new THREE.Raycaster,t=2*((b.clientX-q.left+window.scrollX)/p.offsetWidth)-1,u=2*-((b.clientY-q.top+window.scrollY)/p.offsetHeight)+1,v=new THREE.Vector3(t,u,1);if(r.unprojectVector(v,l),s.set(l.position,v.sub(l.position).normalize()),d=s.intersectObject(a.model,!0),d.length>0){for(e=d[0],g=e.object,h=e.point,k=g.geometry.original_data.vertices,j=h.distanceTo(new THREE.Vector3(k[0],k[1],k[2])),n=1,o=k.length;o>n;n++)m=h.distanceTo(new THREE.Vector3(k[3*n],k[3*n+1],k[3*n+2])),j>m&&(i=n,j=m);return f={vertex:i,point:new THREE.Vector3(e.point.x,e.point.y,e.point.z),object:e.object},c(b,f)}return!1}},BrainBrowser.SurfaceViewer.modules.views=function(a){"use strict";function b(a){return a*Math.PI/180}a.setTransparency=function(b,c){var d,e,f=a.model.getObjectByName(b);f&&(d=f.material,d.opacity=c,d.transparent=1===c?!1:!0,e=f.getObjectByName("__wireframe__"),e&&(e.material.opacity=d.opacity,e.material.transparent=d.transparent))},a.activateWireframe=function(a){var b=a.getObjectByName("__wireframe__");b&&(a.visible=!1,b.visible=!0,a.wireframe_active=!0)},a.deactivateWireframe=function(a){var b=a.getObjectByName("__wireframe__");b&&(a.visible=!0,b.visible=!1,a.wireframe_active=!1)},a.fillModeWireframe=function(){for(var b,c,d=a.model.children,e=0;e<d.length;e++)b=d[e],c=b.getObjectByName("__wireframe__"),c&&(b.visible=!1,c.visible=!0,b.wireframe_active=!0)},a.fillModeSolid=function(){for(var b,c,d=a.model.children,e=0;e<d.length;e++)b=d[e],c=b.getObjectByName("__wireframe__"),c&&(b.visible=!0,c.visible=!1,b.wireframe_active=!1)},a.setupView=function(){var b=a.getViewParams(),c=b.view+"View";a.resetView(),a.model_data&&2===a.model_data.num_hemispheres&&("function"==typeof a[c]?a[c]():a.superiorView())},a.getInfoForVertex=function(b){var c=a.model_data.positionArray,d=3*b;return{vertex:b,point:new THREE.Vector3(c[d],c[d+1],c[d+2])}},a.medialView=function(){var c=a.model;2===a.model_data.num_hemispheres&&(c.getObjectByName("left").position.x-=100,c.getObjectByName("left").rotation.z-=b(90),c.getObjectByName("right").position.x+=100,c.getObjectByName("right").rotation.z+=b(90),c.rotation.x+=b(-90))},a.lateralView=function(){var c,d,e=a.model;2===a.model_data.num_hemispheres&&(c=e.getObjectByName("left"),d=e.getObjectByName("right"),c.position.x-=100,c.rotation.z+=b(-90),d.position.x+=100,d.rotation.z+=b(90),e.rotation.x+=b(90),e.rotation.y+=b(180))},a.superiorView=function(){},a.inferiorView=function(){a.model.rotation.y+=b(180)},a.anteriorView=function(){a.resetView(),a.model.rotation.x+=b(-90),a.model.rotation.z+=b(180)},a.posteriorView=function(){a.resetView(),a.model.rotation.x+=b(-90)},a.separateHemispheres=function(){2===a.model_data.num_hemispheres&&(a.model.children[0].position.x-=1,a.model.children[1].position.x+=1)}};