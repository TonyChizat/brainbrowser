/*
 * Copyright (C) 2011 McGill University
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 *   the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

/* brainbrowser v0.8.1 */
!function(){"use strict";var a=window.BrainBrowser=window.BrainBrowser||{},b=a.VolumeViewer={};b.volumeType={},b.colorScales=[],b.start=function(a,c){function d(a,c){var d=b.volumeType[a.type];if(!d)throw new Error("Unsuported Volume Type");d(a,c)}function e(){var a,c,d,e,n;for(j=l.length,i=300,h=300,b.globalUIControls&&(b.volumeUIControls.defer_until_page_load?k.addEventListener("ready",function(){b.globalUIControls(g,k)}):b.globalUIControls(g,k)),b.setupUI(k),a=0;j>a;a++){for(c=document.createElement("div"),d=l[a],e=[],c.classList.add("volume-container"),g.appendChild(c),k.displays.push(b.addCanvasUI(c,k,l[a],a)),m[a]=[],d.position.xspace=parseInt(d.header.xspace.space_length/2,10),d.position.yspace=parseInt(d.header.yspace.space_length/2,10),d.position.zspace=parseInt(d.header.zspace.space_length/2,10),e.push(d.slice("xspace",d.position.xspace)),e.push(d.slice("yspace",d.position.yspace)),e.push(d.slice("zspace",d.position.zspace)),n=0;3>n;n++)e[n].volID=a,e[n].axis_number=n,e[n].min=d.min,e[n].max=d.max;k.updateVolume(a,e)}f.appendChild(g),k.triggerEvent("ready"),k.triggerEvent("sliceupdate"),k.draw()}var f,g,h,i,j,k={},l=[],m=[],n={xspace:0,yspace:1,zspace:2};k.volumes=l,k.displays=[],k.synced=!1,k.default_zoom_level=1,k.event_listeners={},k.addEventListener=function(a,b){k.event_listeners[a]||(k.event_listeners[a]=[]),k.event_listeners[a].push(b)},k.triggerEvent=function(a){k.event_listeners[a]&&k.event_listeners[a].forEach(function(a){a()})},k.loadVolumes=function(c){c=c||{},f=document.getElementById(a),g=document.createElement("div"),g.id="volume-viewer";var h=c.volumes,i=c.volumes.length;b.loader.loadColorScaleFromUrl("/color_scales/spectral.txt","Spectral",function(a){function f(a){d(h[a],function(b){b.position={},l[a]=b,++j<i||(c.overlay?d({volumes:k.volumes,type:"multivolume"},function(a){a.position={},l.push(a),e()}):e())})}var g,j=0;for(a.cross_hair_color="#FFFFFF",k.defaultScale=a,b.colorScales[0]=a,g=0;i>g;g++)f(g)}),b.loader.loadColorScaleFromUrl("/color_scales/thermal.txt","Thermal",function(a){a.cross_hair_color="#FFFFFF",b.colorScales[1]=a}),b.loader.loadColorScaleFromUrl("/color_scales/gray_scale.txt","Gray",function(a){b.colorScales[2]=a}),b.loader.loadColorScaleFromUrl("/color_scales/blue.txt","Blue",function(a){a.cross_hair_color="#FFFFFF",b.colorScales[3]=a}),b.loader.loadColorScaleFromUrl("/color_scales/green.txt","Green",function(a){b.colorScales[4]=a})},k.updateVolume=function(a,b){var c,d;for(c=0;3>c;c++)d=b[c],k.updateSlice(a,c,d)},k.redrawVolume=function(a){k.renderSlice(a,"xspace",l[a].position.xspace),k.renderSlice(a,"yspace",l[a].position.yspace),k.renderSlice(a,"zspace",l[a].position.zspace)},k.redrawVolumes=function(){for(var a=0;a<l.length;a++)k.redrawVolume(a)},k.renderSlice=function(a,b,c){var d,e=l[a],f=n[b];void 0===c&&(c=e.position[b]),d=e.slice(b,c,e.current_time),d.volID=a,d.axis_number=f,e.position[b]=c,d.min=e.min,d.max=e.max,k.updateSlice(a,d.axis_number,d),k.triggerEvent("sliceupdate"),k.draw()},k.updateSlice=function(a,b,c){var d=c.x,e=c.y,f=m[a][b]||{widthSpace:d,heightSpace:e},g=k.displays[a][b];f.image=c.getImage(g.zoom),m[a][b]=f,g.slice=f,g.updateCursor(l[a])},k.draw=function(){var a,b,c,d,e,f=4,g=f/2;l.forEach(function(h,i){k.displays[i].forEach(function(j,n){c=j.canvas,b=j.context,d=j.zoom,h=l[i],b.globalAlpha=255,b.clearRect(0,0,c.width,c.height),a=m[i][n],a&&(e=h.colorScale||k.defaultScale,j.drawSlice(b,a),j.drawCrosshair(b,e.cross_hair_color,d)),c===k.active_canvas&&(b.save(),b.strokeStyle="#EC2121",b.lineWidth=f,b.strokeRect(g,g,c.width-f,c.height-f),b.restore())})})},k.setCursor=function(a,b,c){var d,e,f=m[b][c],g=k.displays[b][c],h=g.getImageOrigin(),i=g.zoom;g.cursor.x=a.x,g.cursor.y=a.y,a?(d=Math.floor((a.x-h.x)/i/Math.abs(f.widthSpace.step)),e=Math.floor(f.heightSpace.space_length-(a.y-h.y)/i/Math.abs(f.heightSpace.step))):(d=null,e=null),k.renderSlice(b,f.widthSpace.name,d),k.renderSlice(b,f.heightSpace.name,e)},c(k)}}(),function(){"use strict";function a(a,b,c,d){var e=document.createElement("canvas");jQuery(e).attr("width",256),jQuery(e).attr("height",c);for(var f=new Array(256),g=0;256>g;g++)d?f[255-g]=g:f[g]=g;var h=[];for(g=0;256>g;g++)h.push(g);for(var i=a.colorizeArray(h,0,255,!0,0,1,!1,[]),j=e.getContext("2d"),k=0;256>k;k++)j.fillStyle="rgb("+parseInt(i[4*k],10)+","+parseInt(i[4*k+1],10)+","+parseInt(i[4*k+2],10)+")",j.fillRect(k,0,1,b);return e}var b=BrainBrowser.VolumeViewer.ColorScale=function(a){function c(a){a=a.replace(/\s+$/,""),a=a.replace(/^\s+/,"");for(var b=a.split(/\n/),c=[],e=0;e<b.length;e++){for(var f=b[e].replace(/\s+$/,"").split(/\s+/),g=0;g<f.length;g++)f[g]=parseFloat(f[g]);f.length<4&&f.push(1),c.push(f)}return d.colors=c,c}if(!(this instanceof b))return new b(a);var d=this;void 0!==a&&c(a)};b.prototype.createColorScaleCanvas=function(){var b=a(this,20,20,!1);return b},b.prototype.createColorScaleCanvasWithScale=function(b,c,d){var e=a(this,20,40,d),f=e.getContext("2d");return f.fillStyle="#FFA000",f.fillRect(.5,20,1,10),f.fillText(b.toPrecision(3),.5,40),f.fillRect(e.width/4,20,1,10),f.fillText(((b+c)/4).toPrecision(3),e.width/4,40),f.fillRect(e.width/2,20,1,10),f.fillText(((b+c)/2).toPrecision(3),e.width/2,40),f.fillRect(3*(e.width/4),20,1,10),f.fillText((3*((b+c)/4)).toPrecision(3),3*(e.width/4),40),f.fillRect(e.width-.5,20,1,10),f.fillText(c.toPrecision(3),e.width-20,40),e},b.prototype.colorizeArray=function(a,b,c,d,e,f,g,h){h||(h=[]);for(var i,j=this.colors,k=1,l=1*j.length,m=(c-b)/l,n=0;n<a.length;n++)i=a[n]<=b?0:a[n]>=c?j.length-1:parseInt((a[n]-b)/m,10),d&&(k=255),h[4*n+0]=k*j[i][0]*f+e*k,h[4*n+1]=k*j[i][1]*f+e*k,h[4*n+2]=k*j[i][2]*f+e*k,h[4*n+3]=void 0!==g?g*k:k;return h}}(),function(){"use strict";BrainBrowser.VolumeViewer.display=function(a){a=a||{};var b={cursor:{x:0,y:0},last_cursor:{x:0,y:0},image_center:{x:0,y:0},zoom:1},c=Object.create({updateCursor:function(a){var b=this.slice,c=this.getImageOrigin();a&&b&&(this.cursor.x=a.position[b.widthSpace.name]*Math.abs(b.widthSpace.step)*this.zoom+c.x,this.cursor.y=(b.heightSpace.space_length-a.position[b.heightSpace.name])*Math.abs(b.heightSpace.step)*this.zoom+c.y)},getVolumePosition:function(){return{x:this.cursor.x/this.zoom,y:this.cursor.y/this.zoom}},getImageOrigin:function(){return{x:this.image_center.x-this.slice.image.width/2,y:this.image_center.y-this.slice.image.height/2}},drawSlice:function(a){var b=this.slice.image,c=this.getImageOrigin();a.putImageData(b,c.x,c.y)},drawCrosshair:function(a,b,c){var d=8;b=b||"#FF0000",a.save(),a.strokeStyle=b,a.translate(this.cursor.x,this.cursor.y),a.scale(c,c),a.lineWidth=2,a.beginPath(),a.moveTo(0,-d),a.lineTo(0,-2),a.moveTo(0,2),a.lineTo(0,d),a.moveTo(-d,0),a.lineTo(-2,0),a.moveTo(2,0),a.lineTo(d,0),a.stroke(),a.restore()}});return Object.keys(b).forEach(function(a){c[a]=b[a]}),Object.keys(a).forEach(function(b){c[b]=a[b]}),c}}(),function(){"use strict";var a=BrainBrowser.VolumeViewer;a.loader={loadArrayBuffer:function(a,b){var c=new XMLHttpRequest;c.open("GET",a,!0),c.responseType="arraybuffer",c.onreadystatechange=function(){4===c.readyState&&200===c.status&&(void 0!==c.mozResponseArrayBuffer?b(c.mozResponseArrayBuffer):b(c.response))},c.send()},loadFromTextFile:function(a,b){var c=new FileReader,d=a.files;c.file=d[0],c.onloadend=function(a){b(a.target.result)},c.readAsText(d[0])},loadFromUrl:function(a,b,c){$.ajax({url:a,type:"GET",success:b,error:c})},loadColorScaleFromFile:function(b,c,d){a.loader.loadFromTextFile(b,function(b){var e=new a.ColorScale(b);e.name=c,d(e)})},loadColorScaleFromUrl:function(b,c,d){a.loader.loadFromUrl(b,function(b){var e=new a.ColorScale(b);e.name=c,d(e)})}}}(),function(){"use strict";var a=BrainBrowser.VolumeViewer;a.setupUI=function(a){$(document).keydown(function(b){if(a.active_canvas){var c=a.active_canvas,d=b.which;if(!(37>d||d>40)){var e=a.active_cursor,f=c.getAttribute("data-volume-id"),g=c.getAttribute("data-slice-num");return{37:function(){e.x--},38:function(){e.y--},39:function(){e.x++},40:function(){e.y++}}[d](),a.setCursor(e,f,g),a.synced&&a.displays.forEach(function(b,c){c!==f&&a.setCursor(e,c,g)}),!1}}})},a.addCanvasUI=function(b,c,d,e){function f(a){var b=$(a),c={x:0,y:0};return b.mousemove(function(a){var d=b.offset();c.x=a.pageX-d.left,c.y=a.pageY-d.top}),c}var g=[];if(b=$(b),[0,1,2].forEach(function(d){var h=document.createElement("canvas"),i=h.getContext("2d");h.width=256,h.height=256,h.setAttribute("data-volume-id",e),h.setAttribute("data-slice-num",d),h.classList.add("slice-display"),b.append(h),i.clearRect(0,0,h.width,h.height),g.push(a.display({canvas:h,context:i,cursor:{x:h.width/2,y:h.height/2},image_center:{x:h.width/2,y:h.height/2},mouse:f(h),zoom:c.default_zoom_level}))}),a.volumeUIControls){var h=$('<div class="volume-viewer-controls volume-controls"></div>');a.volumeUIControls.defer_until_page_load?c.addEventListener("ready",function(){b.append(h),a.volumeUIControls(h,c,d,e)}):(a.volumeUIControls(h,c,d,e),b.append(h))}return function(){var a=null;g.forEach(function(b,d){function f(f){function g(a){var b,c;b=h.x-a.last_cursor.x,c=h.y-a.last_cursor.y,a.image_center.x+=b,a.image_center.y+=c,a.cursor.x+=b,a.cursor.y+=c,a.last_cursor.x=h.x,a.last_cursor.y=h.y}var h={x:i.x,y:i.y};f.target===a&&(f.shiftKey?(g(b),c.synced&&c.displays.forEach(function(a,b){b!==e&&g(a[d])})):(c.setCursor(h,e,d),c.synced&&c.displays.forEach(function(a,b){b!==e&&c.setCursor(h,b,d)}),b.cursor=c.active_cursor=h),c.draw())}function g(){$(document).unbind("mousemove",f).unbind("mouseup",g),a=null}var h=$(b.canvas),i=b.mouse;h.mousedown(function(h){a=h.target;var j={x:i.x,y:i.y};return h.shiftKey?(b.last_cursor.x=j.x,b.last_cursor.y=j.y,c.synced&&c.displays.forEach(function(a,b){if(b!==e){var c=a[d];c.last_cursor.x=j.x,c.last_cursor.y=j.y}})):(c.setCursor(j,e,d),c.synced&&c.displays.forEach(function(a,b){b!==e&&c.setCursor(j,b,d)}),b.cursor=c.active_cursor=j),c.active_canvas=h.target,$(document).mousemove(f).mouseup(g),c.draw(),!1}),h.mousewheel(function(a,f){return b.zoom=Math.max(b.zoom+.05*f,.05),c.renderSlice(e,["xspace","yspace","zspace"][d]),c.synced&&c.displays.forEach(function(a,b){if(b!==e){var g=a[d];g.zoom=Math.max(g.zoom+.05*f,.05),c.renderSlice(b,["xspace","yspace","zspace"][d])}}),!1})})}(),g},a.globalUIControls=function(a,b){var c=$('<div id="global-controls" class="volume-viewer-controls"></div>'),d=$('<input type="checkbox" class="button" id="sync"><label for="sync">Sync Volumes</label>');d.change(function(){b.synced=d.is(":checked")}),c.append(d);var e=$('<span id="capture" class="button">Capture Slices</span>');e.click(function(){var a=b.displays[0][0].canvas.width,c=b.displays[0][0].canvas.height,d=b.active_canvas,e=document.createElement("canvas"),f=e.getContext("2d"),g=new Image;e.width=a*b.displays.length,e.height=3*c,b.active_canvas=null,b.draw(),b.displays.forEach(function(b,d){b.forEach(function(b,e){f.drawImage(b.canvas,d*a,e*c)})}),b.active_canvas=d,b.draw(),g.onload=function(){$("<div></div>").append(g).dialog({title:"Slices",height:g.height,width:g.width})},g.src=e.toDataURL()}),c.append(e),$(a).append(c)},a.volumeUIControls=function(b,c,d,e){a.coordinateUI(b,c,d,e),"multivolume"===d.type?a.blendUI(b,c,d,e):(a.colorScaleUI(b,c,d,e),a.thresholdUI(b,c,d,e),d.data.time&&a.timeUI(b,c,d,e),a.sliceSeriesUI(b,c,d,e))},a.coordinateUI=function(a,b,c){var d,e,f;c.getWorldCoords&&(d=$('<div class="coords"></div>'),e=$('<div class="control-heading">World Coordinates: </div><div class="world-coords">X:<input id="world-x" class="control-inputs"></input>Y:<input id="world-y" class="control-inputs"></input>Z:<input id="world-z" class="control-inputs"></input></div>').change(function(){var a={x:+e.find("#world-x").val(),y:+e.find("#world-y").val(),z:+e.find("#world-z").val()};c.setWorldCoords(a.x,a.y,a.z),b.redrawVolumes()}),f=$('<div class="control-heading">Voxel Coordinates: </div><div class="voxel-coords">X:<input id="voxel-x" class="control-inputs"></input>Y:<input id="voxel-y" class="control-inputs"></input>Z:<input id="voxel-z" class="control-inputs"></input></div>').change(function(){var a={x:+f.find("#voxel-x").val(),y:+f.find("#voxel-y").val(),z:+f.find("#voxel-z").val()};c.setVoxelCoords(a.x,a.y,a.z),b.redrawVolumes()}),b.addEventListener("sliceupdate",function(){var a=c.getWorldCoords(),b=c.getVoxelCoords();e.find("#world-x").val(a.x),e.find("#world-y").val(a.y),e.find("#world-z").val(a.z),f.find("#voxel-x").val(b.x),f.find("#voxel-y").val(b.y),f.find("#voxel-z").val(b.z)})),d.append(e),d.append(f),a.append(d)},a.blendUI=function(a,b,c){var d=$('<div id="blend-slider" class="slider volume-viewer-blend"></div>'),e=$('<div class="control-heading">Blend (-50 to 50): </div>'),f=$('<input class="control-inputs" value="0" id ="blend-val"/>');e.append(f),e.append(d),a.append(e),d.slider({min:-50,max:50,step:1,slide:function(a,d){var e=parseInt(d.value,10);c.updateBlendRatio(e),b.redrawVolumes(),f.val(e)},stop:function(){$(this).find("a").blur()}}),f.change(function(){var a=this.value;d.slider("value",a),c.updateBlendRatio(a),b.redrawVolumes()})},a.colorScaleUI=function(b,c,d){var e=$("<select></select>"),f="";a.colorScales.forEach(function(a,b){f+='<option value="'+b+'"'+(c.defaultScale===a?" SELECTED":"")+">"+a.name+"</option>"}),e.html(f),e.change(function(b){d.colorScale=a.colorScales[+$(b.target).val()],c.redrawVolumes()}),b.append($('<div class="control-heading">Color Scale: </div>').append(e))},a.thresholdUI=function(a,b,c){var d=$('<div class="slider volume-viewer-threshold"></div>'),e=$('<div class="control-heading" class="slider-div">Threshold: </div>'),f=$('<input class="control-inputs thresh-input-left" value="0"/>'),g=$('<input class="control-inputs thresh-input-right" value="255"/>'),h=$('<div class="thresh-inputs"></div>');h.append(f).append(g),e.append(h),a.append(e),e.append(d),d.slider({range:!0,min:0,max:255,values:[0,255],step:1,slide:function(a,d){var e=d.values;c.min=e[0],c.max=e[1],b.redrawVolumes(),f.val(e[0]),g.val(e[1])},stop:function(){$(this).find("a").blur()}}),f.change(function(){var a=this.value;d.slider("values",0,a),c.min=a,b.redrawVolumes()}),g.change(function(){var a=this.value;d.slider("values",1,a),c.max=a,b.redrawVolumes()})},a.timeUI=function(a,b,c,d){var e,f=$('<div class="control-heading" class="slider-div">Time: </div>'),g=$('<div class="slider volume-viewer-threshold"></div>'),h=$('<input class="control-inputs" value="0" id ="time-val"/>'),i=$('<input type="checkbox" class="button" id="play-'+d+'"><label for="play-'+d+'">Play</label>'),j=0,k=c.data.time.space_length-1;g.slider({min:j,max:k,value:0,step:1,slide:function(a,d){var e=+d.value;h.val(e),c.current_time=e,b.redrawVolumes()},stop:function(){$(this).find("a").blur()}}),h.change(function(){var a=Math.max(j,Math.min(k,parseInt(this.value,10)));h.val(a),g.slider("value",a),c.current_time=a,b.redrawVolumes()}),i.change(function(){i.is(":checked")?(clearInterval(e),e=setInterval(function(){var a=c.current_time+1;a=a>k?0:a,c.current_time=a,h.val(a),g.slider("value",a),b.redrawVolumes()},200)):clearInterval(e)}),f.append(h),f.append(g),a.append(f),a.append(i)},a.sliceSeriesUI=function(a,b,c){var d=$('<div class="control-heading">All slices: </div>'),e=$("<div></div>"),f=$('<span class="slice-series button" data-axis="xspace" style="font-size: 11px">Sagittal</span>'),g=$('<span class="slice-series button" data-axis="yspace" style="font-size: 11px">Coronal</span>'),h=$('<span class="slice-series button" data-axis="zspace" style="font-size: 11px">Transverse</span>'),i={xspace:"Sagittal",yspace:"Coronal",zspace:"Transverse"};e.append(f),e.append(g),e.append(h),e.find(".slice-series").click(function(){var a,b,d,e=$(this).data("axis"),f=c.data[e],g=f.space_length,h=c.current_time,j=10,k=.5,l=document.createElement("canvas"),m=l.getContext("2d"),n=c.slice(e,0,h).getImage(k),o=new Image;for(l.width=j*n.width,l.height=(g/j+1)*n.height,a=0;g>a;a++)n=c.slice(e,a,h).getImage(k),b=a%j*n.width,d=parseInt(a/j,10)*n.height,m.putImageData(n,b,d);o.onload=function(){$("<div></div>").append(o).dialog({title:i[e]+" Slices",height:600,width:o.width})},o.src=l.toDataURL()}),d.append(e),a.append(d)}}(),BrainBrowser.VolumeViewer.utils=function(){"use strict";function a(a,b,c,d,e,f){var g,h,i,j,k,l=[];for(f=f||1,g=0;b>g;g++)for(h=0;c>h;h++)for(j=d?b-g-1:g,k=e?c-h-1:h,i=0;f>i;i++)l[(h*b+g)*f+i]=a[(k*b+j)*f+i];return l}function b(b,c,d){var e=b.data,f=b.width,g=b.height,h=document.createElement("canvas").getContext("2d"),i=4;if(f===c&&g===d)return b;0>c&&d>0&&(e=a(e,f,g,!0,!1,i)),c=Math.abs(c),d=Math.abs(d);for(var j=h.createImageData(c,d),k=j.data,l=f/c,m=g/d,n=0;d>n;n++)for(var o=0;c>o;o++)for(var p=Math.floor(o*l),q=Math.floor(n*m),r=0;i>r;r++)k[Math.floor(n*c+o)*i+r]=e[Math.floor(q*f+p)*i+r];return j}return{nearestNeighboor:b}}(),function(){"use strict";function a(a,b,c){var d=b.split("="),e={};e[d[0]]=d[1],$.ajax({url:a,dataType:"json",data:e,success:function(a){c&&c(a)},error:function(a,b){throw{request:a,textStatus:b}}})}function b(a,b,d){a+=a.match(/\?/)?"&":"?",a+=b,c.loader.loadArrayBuffer(a,function(a){d(a)})}var c=BrainBrowser.VolumeViewer,d={slice:function(a,b,d){var e=this.data.slice(a,b,d);return e.colorScale=this.colorScale||c.colorScales[0],e.min=this.min,e.max=this.max,e.axis=a,e.getImage=function(a){a=a||1;var b=document.createElement("canvas").getContext("2d"),d=this.colorScale,e=b.createImageData(this.width,this.height);d.colorizeArray(this.data,this.min,this.max,!0,0,1,this.alpha,e.data);var f=this.x.step,g=this.y.step;return c.utils.nearestNeighboor(e,Math.floor(this.width*f*a),Math.floor(this.height*g*a))},e},getVoxelCoords:function(){return{x:this.position.xspace,y:this.position.yspace,z:this.position.zspace}},setVoxelCoords:function(a,b,c){this.position.xspace=a,this.position.yspace=b,this.position.zspace=c},getWorldCoords:function(){return{x:this.data.xspace.start+this.position.xspace*this.data.xspace.step,y:this.data.yspace.start+this.position.yspace*this.data.yspace.step,z:this.data.zspace.start+this.position.zspace*this.data.zspace.step}},setWorldCoords:function(a,b,c){this.position.xspace=Math.floor((a-this.data.xspace.start)/this.data.xspace.step),this.position.yspace=Math.floor((b-this.data.yspace.start)/this.data.yspace.step),this.position.zspace=Math.floor((c-this.data.zspace.start)/this.data.zspace.step)}};c.volumeType.minc=function(e,f){var g,h=Object.create(d),i=e.getRawDataParam||"raw_data=true",j=e.getHeaderParam||"minc_headers=true";h.current_time=0,a(e.filename,j,function(a){b(e.filename,i,function(b){g=new Uint8Array(b),h.data=c.mincData(e.filename,a,g),h.header=h.data.header,h.min=0,h.max=255,f&&f(h)})})}}(),BrainBrowser.VolumeViewer.mincData=function(){"use strict";function a(a,b,c){for(var d=new Uint16Array(b*c),e=0;b>e;e++)for(var f=0;c>f;f++)d[e*c+f]=a[f*b+(b-e)];return d}function b(a,b,c){for(var d=new Uint16Array(b*c),e=0;b>e;e++)for(var f=0;c>f;f++)d[e*c+f]=a[(c-f)*b+e];return d}var c={parseHeader:function(a){this.header=a,this.order=a.order,4===this.order.length&&(this.order=this.order.slice(1),this.time=a.time),this.xspace=a.xspace,this.yspace=a.yspace,this.zspace=a.zspace,this.xspace.name="xspace",this.yspace.name="yspace",this.zspace.name="zspace",this.xspace.space_length=parseFloat(this.xspace.space_length),this.yspace.space_length=parseFloat(this.yspace.space_length),this.zspace.space_length=parseFloat(this.zspace.space_length),this.xspace.start=parseFloat(this.xspace.start),this.yspace.start=parseFloat(this.yspace.start),this.zspace.start=parseFloat(this.zspace.start),this.xspace.step=parseFloat(this.xspace.step),this.yspace.step=parseFloat(this.yspace.step),this.zspace.step=parseFloat(this.zspace.step),4===this.order.length&&(this.time.space_length=parseFloat(this.time.space_length),this.time.start=parseFloat(this.time.start),this.time.step=parseFloat(this.time.step));var b=this[this.order[0]],c=this[this.order[1]],d=this[this.order[2]];b.height=parseFloat(c.space_length),b.height_space=c,b.width=parseFloat(d.space_length),b.width_space=d,c.height=parseFloat(d.space_length),c.height_space=d,c.width=parseFloat(b.space_length),c.width_space=b,d.height=parseFloat(c.space_length),d.height_space=c,d.width=parseFloat(b.space_length),d.width_space=b,b.offset=parseFloat(c.space_length)*parseFloat(d.space_length),c.offset=parseFloat(b.space_length),d.offset=parseFloat(b.space_length),b.slice_length=b.height*b.width},slice:function(c,d,e){var f,g=this.cachedSlices,h=this[this.order[0]];if(e=e||0,g[c]=g[c]||[],g[c][e]=g[c][e]||[],this[c].step<0&&(d=this[c].space_length-d),void 0!==g[c][e][d])return f=g[c][e][d],f.alpha=1,f.number=d,f;if(void 0===this.order)return!1;var i=0;this.time&&(i=e*h.height*h.width*parseFloat(h.space_length));var j=this[c].width_space.step,k=this[c].height_space.step;f={};var l,m,n,o,p,q,r,s,t,u;if(this.order[0]===c)if(m=this[c].height*this[c].width,n=this[c].height,o=this[c].width,p=1,q=o,r=m,l=new Uint16Array(m),j>0)if(k>0)for(s=0;m>s;s++)l[s]=this.data[i+r*d+s];else for(s=n;s>0;s--)for(t=0;o>t;t++)l[(n-s)*o+t]=this.data[i+r*d+s*o+t];else if(0>k)for(s=0;n>s;s++)for(t=0;o>t;t++)l[s*o+t]=this.data[i+r*d+s*o+o-t];else for(s=n;s>0;s--)for(t=0;o>t;t++)l[(n-s)*o+t]=this.data[i+r*d+s*o+o-t];else if(this.order[1]===c)if(n=this[c].height,m=this[c].height*this[c].width,o=this[c].width,p=1,q=h.slice_length,r=h.width,l=new Uint8Array(m),0>k)for(t=0;n>t;t++)for(u=0;o>u;u++)l[t*o+u]=this.data[i+d*r+q*u+t];else for(t=n;t>=0;t--)for(u=0;o>u;u++)l[(n-t)*o+u]=this.data[i+d*r+q*u+t];else for(n=this[c].height,m=this[c].height*this[c].width,o=this[c].width,p=h.slice_length,q=h.width,r=1,l=new Uint16Array(m),t=0;n>t;t++)for(u=0;o>u;u++)l[t*o+u]=this.data[i+d+h.width*t+u*h.slice_length];return f.x=this[c].width_space,f.y=this[c].height_space,f.width=o,f.height=n,"xspace"===c&&"yspace"===this.xspace.height_space.name&&(l=this.zspace.step<0?b(l,f.width,f.height):a(l,f.width,f.height),f.x=this[c].height_space,f.y=this[c].width_space,f.width=n,f.height=o),"yspace"===c&&"xspace"===this.yspace.height_space.name&&(l=this.zspace.step<0?b(l,f.width,f.height):a(l,f.width,f.height),f.x=this[c].height_space,f.y=this[c].width_space,f.width=n,f.height=o),"zspace"===c&&"xspace"===this.zspace.height_space.name&&(l=a(l,f.width,f.height),f.x=this[c].width_space,f.y=this[c].height_space,f.width=n,f.height=o),f.data=l,f.x=f.x||this[c].width_space,f.y=f.y||this[c].height_space,f.width=f.width||o,f.height=f.height||n,g[c][e][d]=f,f}};return function(a,b,d){var e=Object.create(c);return e.cachedSlices={},e.parseHeader(b),e.data=d,e}}(),function(){"use strict";function a(a,b){var c=a.length;if(c>1){for(var d=b.data,e=b.width,f=b.height,g=[],h=0;f>h;h+=1)for(var i=0;e>i;i+=1)for(var j=0;c>j;j+=1){g[j]=g[j]||0;var k=a[j];if(h<k.height&&i<k.width){var l=4*(h*e+i),m=(d[l+3]||0)/255,n=g[j];d[l]=(d[l+0]||0)*m+k.data[n+0]*(k.data[n+3]/255),d[l+1]=(d[l+1]||0)*m+k.data[n+1]*(k.data[n+3]/255),d[l+2]=(d[l+2]||0)*m+k.data[n+2]*(k.data[n+3]/255),d[l+3]=(d[l+3]||0)+k.data[n+3],g[j]+=4}}for(h=3;h<d.length;h+=4)d[h]=255;return b}return a[0]}function b(a){var b,c=Object.create(d);c.volumes=[];var e=a.length;for(b=0;e>b;b++)a[b]!==c&&c.volumes.push(a[b]);c.blendRatios=[],e=c.volumes.length;var f=1/e;for(b=0;e>b;b++)c.blendRatios[b]=f;return c}var c=BrainBrowser.VolumeViewer,d={updateBlendRatio:function(a){a+=50,this.blendRatios[0]=(100-a)/100,this.blendRatios[1]=parseFloat(a)/100},slice:function(b,d,e){var f,g,h=this.volumes.length,i=[];for(f=0;h>f;f++){var j=this.volumes[f];j!==this&&(g=this.volumes[f].slice(b,d,e),g.alpha=this.blendRatios[f],i.push(g))}return{x:i[0].x,y:i[0].y,getImage:function(b){b=b||1;var d,e,f,g,h,j=document.createElement("canvas").getContext("2d"),k=[];for(g=0;g<i.length;g++){h=i[g];var l=h.colorScale,m=j.createImageData(h.width,h.height);l.colorizeArray(h.data,h.min,h.max,!0,0,1,h.alpha,m.data);var n=h.x.step,o=h.y.step;m=c.utils.nearestNeighboor(m,Math.floor(h.width*n*b),Math.floor(h.height*o*b)),k.push(m)}return d=Math.max.apply(null,k.map(function(a){return a.width})),e=Math.max.apply(null,k.map(function(a){return a.height})),f=j.createImageData(d,e),a(k,f)}}},getVoxelCoords:function(){return{x:this.position.xspace,y:this.position.yspace,z:this.position.zspace}},setVoxelCoords:function(a,b,c){this.position.xspace=a,this.position.yspace=b,this.position.zspace=c},getWorldCoords:function(){var a=this.volumes[0];return{x:a.data.xspace.start+this.position.xspace*a.data.xspace.step,y:a.data.yspace.start+this.position.yspace*a.data.yspace.step,z:a.data.zspace.start+this.position.zspace*a.data.zspace.step}},setWorldCoords:function(a,b,c){var d=this.volumes[0];this.position.xspace=Math.floor((a-d.data.xspace.start)/d.data.xspace.step),this.position.yspace=Math.floor((b-d.data.yspace.start)/d.data.yspace.step),this.position.zspace=Math.floor((c-d.data.zspace.start)/d.data.zspace.step)}};c.volumeType.multivolume=function(a,c){var d=b(a.volumes);d.type="multivolume",d.min=0,d.max=255,d.header=a.volumes[0].header,setTimeout(function(){c(d)},0)}}();